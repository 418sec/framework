// Copyright 2012-2014 (c) Peter Å irka <petersirka@gmail.com>
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

(function(module){var exports=module.exports;global.framework_builders=module.exports;
"use strict";var UNDEFINED="undefined";var FUNCTION="function";var OBJECT="object";var STRING="string";var NUMBER="number";var BOOLEAN="boolean";var REQUIRED='The field "@" is required.';var DEFAULT_SCHEMA="default";var DEFAULT_SCHEMA_PROPERTY="$state";var schemas={};var transforms={pagination:{},error:{}};function SchemaBuilder(name){this.name=name;this.collection={}}SchemaBuilder.prototype.get=function(name){return this.collection[name]};SchemaBuilder.prototype.add=function(name,obj,properties,validator){var self=this;if(typeof obj===UNDEFINED)obj={};self.collection[name]=new SchemaBuilderEntity(self,name,obj,validator,properties);return self.collection[name]};SchemaBuilder.prototype.create=function(){var self=this;return self.add.apply(self,arguments)};SchemaBuilder.prototype.remove=function(name){var self=this;if(name===undefined){delete schemas[name];self.collection=null;return}var schema=self.collection[name];if(schema)schema.remove();schema=null;return self};SchemaBuilder.prototype.destroy=function(name){return this.remove(name)};function SchemaBuilderEntity(parent,name,obj,validator,properties){this.parent=parent;this.name=name;this.schema=obj;this.properties=properties===undefined?Object.keys(obj):properties;this.transforms;this.composes;this.rules;this.onDefault;this.onValidation=validator;this.onSave;this.onGet;this.onRemove;this.onQuery}SchemaBuilderEntity.prototype.define=function(name,type,required){var self=this;if(name instanceof Array){for(var i=0,length=name.length;i<length;i++)self.define(name[i],type,required);return self}self.schema[name]=type;if(!required)return self;if(self.properties===undefined||self.properties===null)self.properties=[];if(self.properties.indexOf(name)!==-1)return self;self.properties.push(name);return self};SchemaBuilderEntity.prototype.getDependencies=function(){var self=this;var arr=Object.keys(self.schema);var dependencies=[];for(var i=0,length=arr.length;i<length;i++){var name=arr[i];var type=self.schema[name];if(typeof type!==STRING)continue;var isArray=type[0]==="]";if(isArray)type=type.substring(1,type.length-1);var m=self.parent.get(type);if(typeof m===undefined)continue;dependencies.push({name:name,isArray:isArray,schema:m})}return dependencies};SchemaBuilderEntity.prototype.setValidation=function(properties,fn){var self=this;if(fn===undefined&&properties instanceof Array){self.properties=properties;return self}if(typeof properties!==FUNCTION){self.properties=properties;self.onValidation=fn}else self.onValidation=properties;return self};SchemaBuilderEntity.prototype.setDefault=function(fn){var self=this;self.onDefault=fn;return self};SchemaBuilderEntity.prototype.setSave=function(fn){var self=this;self.onSave=fn;return self};SchemaBuilderEntity.prototype.setGet=function(fn){var self=this;self.onGet=fn;return self};SchemaBuilderEntity.prototype.setQuery=function(fn){var self=this;self.onQuery=fn;return self};SchemaBuilderEntity.prototype.setRemove=function(fn){var self=this;self.onRemove=fn;return self};SchemaBuilderEntity.prototype.setProperties=function(properties){var self=this;self.properties=properties;return self};SchemaBuilderEntity.prototype.addRule=function(name,value){var self=this;if(value===undefined){fn=name;name="default"}if(!self.rules)self.rules={};self.rules[name]=value;return self};SchemaBuilderEntity.prototype.addTransform=function(name,fn){var self=this;if(typeof name===FUNCTION){fn=name;name="default"}if(!self.transforms)self.transforms={};self.transforms[name]=fn;return self};SchemaBuilderEntity.prototype.addWorkflow=function(name,fn){var self=this;if(typeof name===FUNCTION){fn=name;name="default"}if(!self.workflows)self.workflows={};self.workflows[name]=fn;return self};SchemaBuilderEntity.prototype.addCompose=function(name,fn){var self=this;if(typeof name===FUNCTION){fn=name;name="default"}if(!self.composes)self.composes={};self.composes[name]=fn;return self};SchemaBuilderEntity.prototype.addComposer=function(name,fn){return this.addCompose(name,fn)};SchemaBuilderEntity.prototype.find=function(name){return this.parent.get(name)};SchemaBuilderEntity.prototype.rule=function(name){var self=this;if(self.rules===undefined)return undefined;if(name===undefined)name="default";return self.rules[name]};SchemaBuilderEntity.prototype.destroy=function(){var self=this;delete self.parent.collection[self.name];self.properties=null;self.schema=null;self.onDefault=null;self.onValidation=null;self.onSave=null;self.onRead=null;self.onRemove=null;self.onQuery=null;self.workflows=null;self.transforms=null};SchemaBuilderEntity.prototype.saveMultiple=function(model,helper,callback){if(callback===undefined){callback=helper;helper=undefined}var repository;var output=[];if(model instanceof Array)repository=model;else repository=[model];var self=this;var builder=new ErrorBuilder;for(var i=0,length=repository.length;i<length;i++){var item=repository[i];var noPrepare=self._getStateOfModel(item,0)==="1";var noValidate=self._getStateOfModel(item,1)==="1";var prepared=noPrepare===true?framework_utils.copy(item):self.prepare(item);if(noValidate===true||self.onValidation===undefined){if(!builder.hasError())output.push(prepared);continue}builder.add(self.validate(prepared));if(!builder.hasError())output.push(prepared)}if(builder.hasError()){callback(builder);return self}repository=[];output.wait(function(item,next){self.onSave(builder,output,helper,function(value){repository.push(value);next()})},function(){callback(builder.hasError()?builder:null,repository)});return self};SchemaBuilderEntity.prototype.save=function(model,helper,callback){if(callback===undefined){callback=helper;helper=undefined}var self=this;var noPrepare=self._getStateOfModel(model,0)==="1";var noValidate=self._getStateOfModel(model,1)==="1";var output=noPrepare===true?framework_utils.copy(model):self.prepare(model);var builder=noValidate===true||self.onValidation===undefined?new ErrorBuilder:self.validate(output);if(builder.hasError()){callback(builder);return self}self.onSave(builder,output,helper,function(value){callback(builder.hasError()?builder:null,value===undefined?output:value)});return self};SchemaBuilderEntity.prototype.get=function(helper,callback){if(callback===undefined){callback=helper;helper=undefined}var self=this;var builder=new ErrorBuilder;var output=self.default();self.onGet(builder,output,helper,function(value){callback(builder.hasError()?builder:null,value===undefined?output:value)});return self};SchemaBuilderEntity.prototype.remove=function(helper,callback){if(callback===undefined){callback=helper;helper=undefined}var self=this;var builder=new ErrorBuilder;self.onRemove(builder,helper,function(value){callback(builder.hasError()?builder:null,value===undefined?helper:value)});return self};SchemaBuilderEntity.prototype.query=function(helper,callback){if(callback===undefined){callback=helper;helper=undefined}var self=this;var builder=new ErrorBuilder;self.onQuery(builder,helper,function(value){callback(builder.hasError()?builder:null,value)});return self};SchemaBuilderEntity.prototype.validate=function(model,resourcePrefix,resourceName,builder){var self=this;var fn=self.onValidation;if(builder===undefined)builder=new ErrorBuilder;if(fn===undefined||fn===null){if(typeof framework.onValidation!==FUNCTION){if(framework&&framework.error)framework.error(new Error('Schema "'+name+"\" doesn't defined a validation delegate."),self.parent.name+"."+self.name+".validate()",null);return builder}fn=framework.onValidation}if(resourceName)builder.resourceName=resourceName;if(resourcePrefix)builder.resourcePrefix=resourcePrefix;self._setStateToModel(model,1,1);return framework_utils.validate.call(self,model,self.name,fn,builder,undefined,self.name,self.parent.collection)};SchemaBuilderEntity.prototype._getStateOfModel=function(model,index){return(model[DEFAULT_SCHEMA_PROPERTY]||"")[index]||"0"};SchemaBuilderEntity.prototype._setStateToModel=function(model,index,value){var item=model[DEFAULT_SCHEMA_PROPERTY];if(typeof value!==OBJECT)value=value.toString();if(!item)model[DEFAULT_SCHEMA_PROPERTY]="01";else if(item[1]!==value)model[DEFAULT_SCHEMA_PROPERTY]=item.replaceAt(1,value);return this};SchemaBuilderEntity.prototype.create=function(){return this.default()};SchemaBuilderEntity.prototype.default=function(){var self=this;var obj=self.schema;if(obj===null)return null;var defaults=self.onDefault;var item=framework_utils.extend({},obj,true);var properties=Object.keys(item);for(var i=0,length=properties.length;i<length;i++){var property=properties[i];var value=item[property];var type=typeof value;if(defaults){var def=defaults(property,true,self.name);if(def!==undefined){item[property]=def;continue}}if(type===FUNCTION){if(value===Number){item[property]=0;continue}if(value===Boolean){item[property]=false;continue}if(value===String){item[property]="";continue}if(value===Date){item[property]=new Date;continue}if(value===Object){item[property]={};continue}if(value===Array){item[property]=[];continue}item[property]=value();continue}if(type===NUMBER){item[property]=0;continue}if(type===BOOLEAN){item[property]=false;continue}if(type===OBJECT){item[property]=value instanceof Array?[]:{};continue}if(type!==STRING){item[property]=null;continue}var isArray=value[0]==="[";if(isArray)value=value.substring(1,value.length-1);if(isArray){item[property]=[];continue}var lower=value.toLowerCase();if(lower.contains([STRING,"text","varchar","nvarchar","binary","data","base64"])){item[property]="";continue}if(lower.contains(["int",NUMBER,"decimal","byte","float","double"])){item[property]=0;continue}if(lower.contains("bool")){item[property]=false;continue}if(lower.contains(["date","time"])){item[property]=new Date;continue}if(lower.contains(["object"])){item[property]={};continue}if(lower.contains(["array"])){item[property]=[];continue}if(lower.contains(["binary","data","base64"])){item[property]=null;continue}var child=self.parent.get(value);item[property]=child?child.default():null}return item};SchemaBuilderEntity.prototype.prepare=function(model,dependencies){var self=this;var obj=self.schema;if(obj===null)return null;if(model===null||model===undefined)return self.default();var tmp;var item=framework_utils.extend({},obj,true);var properties=Object.keys(item);var defaults=self.onDefault;for(var i=0,length=properties.length;i<length;i++){var property=properties[i];var val=model[property];if(val===undefined&&defaults)val=defaults(property,false,self.name);if(val===undefined)val="";var value=item[property];var type=typeof value;var typeval=typeof val;if(typeval===FUNCTION)val=val();if(type===FUNCTION){if(value===Number){item[property]=framework_utils.parseFloat(val);continue}if(value===Boolean){tmp=val.toString();item[property]=tmp==="true"||tmp==="1";continue}if(value===String){item[property]=val===undefined||val===null?"":val.toString();continue}if(value===Date){tmp=null;switch(typeval){case OBJECT:if(framework_utils.isDate(val))tmp=val;else tmp=null;break;case NUMBER:tmp=new Date(val);break;case STRING:if(val==="")tmp=null;else tmp=val.parseDate();break}if(tmp!==null&&typeof tmp===OBJECT&&tmp.toString()==="Invalid Date")tmp=null;item[property]=tmp||(defaults?isUndefined(defaults(property,false,self.name),null):null);continue}if(value===Object){item[property]=model[property];continue}item[property]=defaults?isUndefined(defaults(value,false,name),null):null;continue}if(type===OBJECT){item[property]=typeval===OBJECT?val:null;continue}if(type===NUMBER){item[property]=framework_utils.parseFloat(val);continue}if(val===null||typeval===UNDEFINED)tmp="";else tmp=val.toString();if(type===BOOLEAN){item[property]=tmp==="true"||tmp==="1";continue}if(type!==STRING){item[property]=tmp;continue}var isArray=value[0]==="["||value==="array";if(isArray){if(value[0]==="[")value=value.substring(1,value.length-1);else value=null;if(!(val instanceof Array)){item[property]=defaults?isUndefined(defaults(property,false,name),[]):[];continue}item[property]=[];for(var j=0,sublength=val.length;j<sublength;j++){if(value===null){item[property].push(model[property][j]);continue}var tmp=model[property][j];switch(value.toLowerCase()){case"string":case"varchar":case"text":item[property].push((tmp||"").toString());break;case"bool":case"boolean":tmp=(tmp||"").toString().toLowerCase();item[property].push(tmp==="true"||tmp==="1");break;case"int":case"integer":item[property].push(framework_utils.parseInt(tmp));break;case"number":item[property].push(framework_utils.parseFloat(tmp));break;default:var entity=self.parent.get(value);if(entity){item[property][j]=entity.prepare(tmp,dependencies);if(dependencies)dependencies.push({name:value,value:item[property][j]})}else item[property][j]=null;break}}continue}var lower=value.toLowerCase();if(lower.contains([STRING,"text","varchar","nvarchar"])){var beg=lower.indexOf("(");if(beg===-1){item[property]=tmp;continue}var size=lower.substring(beg+1,lower.length-1).parseInt();item[property]=tmp.max(size,"...");continue}if(lower.contains(["int","byte"])){item[property]=framework_utils.parseInt(val);continue}if(lower.contains(["decimal",NUMBER,"float","double"])){item[property]=framework_utils.parseFloat(val);continue}if(lower.contains("bool",BOOLEAN)){item[property]=tmp==="true"||tmp==="1";continue}if(lower.contains(["date","time"])){if(typeval==="date"){item[property]=val;continue}if(typeval===STRING){item[property]=val.parseDate();continue}if(typeval===NUMBER){item[property]=new Date(val);continue}item[property]=isUndefined(defaults(property,false,name));continue}var entity=self.parent.get(value);if(entity){item[property]=entity.prepare(val);if(dependencies)dependencies.push({name:value,value:item[property]})}else item[property]=null}self._setStateToModel(model,0,1);return item};SchemaBuilderEntity.prototype.transform=function(name,model,helper,callback){var self=this;if(typeof name!==STRING){callback=helper;helper=model;model=name;name="default"}if(callback===undefined){callback=helper;helper=undefined}var trans=self.transforms?self.transforms[name]:undefined;if(!trans){callback((new ErrorBuilder).add("","Transform not found."));return}var noPrepare=self._getStateOfModel(model,0)==="1";var noValidate=self._getStateOfModel(model,1)==="1";var output=noPrepare===true?framework_utils.copy(model):self.prepare(model);var builder=self.onValidation===undefined||noValidate===true?new ErrorBuilder:self.validate(output);if(builder.hasError()){callback(builder);return}trans.call(self,output,function(result){callback(builder.hasError()?builder:null,result===undefined?output:result,model)},builder,helper,self.name);return self};SchemaBuilderEntity.prototype.compose=function(name,model,helper,callback){var self=this;if(typeof name!==STRING){callback=helper;helper=model;model=name;name="default"}if(callback===undefined){callback=helper;helper=undefined}var builder=new ErrorBuilder;var compose=self.composes?self.composes[name]:undefined;if(!compose){callback(builder.add("","Composer not found."));return}var output=self.default();compose.call(self,output,model,function(result){callback(builder.hasError()?builder:null,result===undefined?output:result,model)},builder,helper,self.name);return self};SchemaBuilderEntity.prototype.workflow=function(name,model,helper,callback){var self=this;if(typeof name!==STRING){callback=helper;helper=model;model=name;name="default"}if(callback===undefined){callback=helper;helper=undefined}var workflow=self.workflows?self.workflows[name]:undefined;if(!workflow){callback((new ErrorBuilder).add("","Workflow not found."));return}var noPrepare=self._getStateOfModel(model,0)==="1";var noValidate=self._getStateOfModel(model,1)==="1";var output=noPrepare===true?framework_utils.copy(model):self.prepare(model);var builder=noValidate===true||self.onValidation===undefined?new ErrorBuilder:self.validate(output);if(builder.hasError()){callback(builder);return}workflow.call(self,output,function(result){callback(builder.hasError()?builder:null,result===undefined?output:result,model)},builder,helper,self.name);return self};SchemaBuilderEntity.prototype.clean=function(model,isCopied){if(model===null||model===undefined)return model;if(isCopied)model=framework_utils.copy(model);delete model[DEFAULT_SCHEMA_PROPERTY];var keys=Object.keys(model);for(var i=0,length=keys.length;i<length;i++){var key=keys[i];var value=model[key];if(value===null)continue;if(typeof value!==OBJECT)continue;if(value instanceof Array){for(var j=0,sublength=value.length;j<sublength;j++){var item=value[j];if(item===null)continue;if(typeof item!==OBJECT)continue;self.clean(item,true)}continue}self.clean(value,true)}return model};function ErrorBuilder(onResource){this.items=[];this.transformName=transforms["error_default"];this.onResource=onResource;this.resourceName="default";this.resourcePrefix="";this.count=0;this.replacer=[];this.isPrepared=false;if(onResource===undefined)this._resource()}function UrlBuilder(){this.builder={}}function Pagination(items,page,max,format){this.isNext=false;this.isPrev=false;this.isFirst=false;this.isLast=false;this.items=items;this.count=0;this.skip=0;this.take=0;this.page=0;this.max=0;this.visible=false;this.format=format||"?page={0}";this.refresh(items,page,max);this.transformName=transforms["pagination_default"]}exports.schema=function(name,obj,defaults,validator,properties){if(obj===undefined){if(schemas[name]===undefined)schemas[name]=new SchemaBuilder(name);return schemas[name]}if(schemas[DEFAULT_SCHEMA]===undefined)schemas[DEFAULT_SCHEMA]=new SchemaBuilder(DEFAULT_SCHEMA);if(typeof defaults!==FUNCTION)defaults=undefined;if(typeof validator!==FUNCTION)validator=undefined;if(!(properties instanceof Array))properties=undefined;var schema=schemas[DEFAULT_SCHEMA].add(name,obj,properties,validator);if(defaults)schema.setDefault(defaults);return obj};exports.remove=function(name){delete schemas[name]};exports.isJoin=function(collection,value){if(!value)return false;if(value[0]==="[")return true;if(collection===undefined)return false;return collection[value]!==undefined};exports.validation=function(name,properties,fn){if(schemas[DEFAULT_SCHEMA]===undefined)return[];var schema=schemas[DEFAULT_SCHEMA].get(name);if(schema===undefined)return[];if(fn instanceof Array&&typeof properties===FUNCTION){var tmp=fn;fn=properties;properties=fn}if(typeof fn===FUNCTION){schema.onValidation=fn;if(properties===undefined)schema.properties=Object.keys(schema.schema);else schema.properties=properties;return true}if(fn===undefined){var validator=schema.properties;if(validator===undefined)return Object.keys(schema.schema);return validator||[]}schema.onValidation=fn;return fn};exports.validate=function(name,model,resourcePrefix,resourceName){var schema=schemas[DEFAULT_SCHEMA];if(schema===undefined)return null;schema=schema.get(name);if(schema===undefined)return null;var fn=schema.onValidation;return schema.validate(model,resourcePrefix,resourceName)};exports.create=function(name){return exports.defaults(name)};exports.defaults=function(name){if(schemas[DEFAULT_SCHEMA]===undefined)return null;var schema=schemas[DEFAULT_SCHEMA].get(name);if(schema===undefined)return null;return schema.default()};exports.prepare=function(name,model){if(schemas[DEFAULT_SCHEMA]===undefined)return null;var schema=schemas[DEFAULT_SCHEMA].get(name);if(schema===undefined)return null;return schema.prepare(model)};function isUndefined(value,def){if(value===undefined)return def;return value}ErrorBuilder.prototype={get errors(){var self=this;if(!self.isPrepared)self.prepare();return self._transform()},get error(){var self=this;if(!self.isPrepared)self.prepare();return self._transform()}};ErrorBuilder.prototype.resource=function(name,prefix){var self=this;self.resourceName=name||"default";self.resourcePrefix=prefix||"";return self._resource()};ErrorBuilder.prototype._resource=function(){var self=this;self.onResource=function(name){var self=this;if(typeof framework!==UNDEFINED)return framework.resource(self.resourceName,self.resourcePrefix+name);return name};return self};ErrorBuilder.prototype.add=function(name,error,path){var self=this;self.isPrepared=false;if(name instanceof ErrorBuilder){if(name.hasError()){name.errors.forEach(function(o){self.errors.push(o)});self.count=self.items.length}return self}if((name===undefined||name===null)&&(error===undefined||error===null))return self;if(error===undefined)error="@";if(error===undefined||error===null)return self;if(error instanceof Error)error=error.toString();self.items.push({name:name,error:typeof error===STRING?error:(error||"").toString()||"@",path:path});self.count=self.items.length;return self};ErrorBuilder.prototype.remove=function(name){var self=this;self.items=self.items.remove(function(o){return o.name===name});self.count=self.items.length;return self};ErrorBuilder.prototype.hasError=function(name){var self=this;if(name){return self.items.find(function(o){return o.name===name})!==null}return self.items.length>0};ErrorBuilder.prototype.read=function(name){var self=this;if(!self.isPrepared)self.prepare();var error=self.items.find(function(o){return o.name===name});if(error!==null)return error.error;return null};ErrorBuilder.prototype.clear=function(){var self=this;self.items=[];self.count=0;return self};ErrorBuilder.prototype.replace=function(search,newvalue){var self=this;self.isPrepared=false;self.replacer[search]=newvalue;return self};ErrorBuilder.prototype.json=function(beautify,replacer){var obj=this.prepare()._transform();if(beautify)return JSON.stringify(obj,replacer,"	");return JSON.stringify(obj,replacer)};ErrorBuilder.prototype.JSON=function(beautify,replacer){return this.json(beautify,replacer)};ErrorBuilder.prototype.output=function(){return this.prepare()._transform()};ErrorBuilder.prototype._prepare=function(){var self=this;if(self.onResource===null)return self;var errors=self.items;var length=errors.length;for(var i=0;i<length;i++){var o=errors[i];if(o.error[0]!=="@")continue;if(o.error.length===1)o.error=self.onResource(o.name);else o.error=self.onResource(o.error.substring(1));if(o.error===undefined)o.error=REQUIRED.replace("@",o.name)}return self};ErrorBuilder.prototype._transform=function(name){var self=this;var transformName=name||self.transformName;if(!transformName)return self.items;var current=transforms["error"][transformName];if(current===undefined)return self.items;return current.call(self)};ErrorBuilder.prototype.toString=function(){var self=this;if(!self.isPrepared)self.prepare();var errors=self.items;var length=errors.length;var builder=[];for(var i=0;i<length;i++)builder.push(errors[i].error||errors[i].name);return builder.join("\n")};ErrorBuilder.prototype.setTransform=function(name){var self=this;self.transformName=name;return self};ErrorBuilder.prototype.transform=function(name){var self=this;return self.prepare()._transform(name)};ErrorBuilder.prototype._prepareReplace=function(){var self=this;var errors=self.items;var lengthBuilder=errors.length;var keys=Object.keys(self.replacer);var lengthKeys=keys.length;if(lengthBuilder===0||lengthKeys===0)return self;for(var i=0;i<lengthBuilder;i++){var o=errors[i];for(var j=0;j<lengthKeys;j++){var key=keys[j];o.error=o.error.replace(key,self.replacer[key])}}return self};ErrorBuilder.prototype.prepare=function(){var self=this;if(self.isPrepared)return self;self._prepare()._prepareReplace();self.isPrepared=true;return self};ErrorBuilder.addTransform=function(name,fn,isDefault){transforms["error"][name]=fn;if(isDefault)ErrorBuilder.setDefaultTransform(name)};ErrorBuilder.removeTransform=function(name){delete transforms["error"][name]};ErrorBuilder.setDefaultTransform=function(name){if(name===undefined)delete transforms["error_default"];else transforms["error_default"]=name};Pagination.addTransform=function(name,fn,isDefault){transforms["pagination"][name]=fn;if(isDefault)Pagination.setDefaultTransform(name)};Pagination.setDefaultTransform=function(name){if(name===undefined)delete transforms["pagination_default"];else transforms["pagination_default"]=name};Pagination.removeTransform=function(name){delete transforms["pagination"][name]};Pagination.prototype.refresh=function(items,page,max){var self=this;self.count=Math.floor(items/max)+(items%max>0?1:0);self.page=page-1;if(self.page<0)self.page=0;self.items=items;self.skip=self.page*max;self.take=max;self.max=max;self.isPrev=self.page>0;self.isNext=self.page<self.count-1;self.isFirst=self.count>1;self.isLast=self.count>1;self.visible=self.count>1;self.page++;return self};Pagination.prototype.setTransform=function(name){var self=this;self._transform=name;return self};Pagination.prototype.transform=function(name){var self=this;var transformName=name||self.transformName;if(!transformName)throw new Error("A transformation of Pagination not found.");var current=transforms["pagination"][transformName];if(current===undefined)return self.render();var param=[];for(var i=1;i<arguments.length;i++)param.push(arguments[i]);return current.apply(self,param)};Pagination.prototype.prev=function(format){var self=this;var page=0;format=format||self.format;if(self.isPrev)page=self.page-1;else page=self.count;return{url:format.format(page,self.items,self.count),page:page,selected:false,enabled:self.isPrev}};Pagination.prototype.next=function(format){var self=this;var page=0;format=format||self.format;if(self.isNext)page=self.page+1;else page=1;return{url:format.format(page,self.items,self.count),page:page,selected:false,enabled:self.isNext}};Pagination.prototype.last=function(format){var self=this;var page=self.count;format=format||self.format;return{url:format.format(page,self.items,self.count),page:page,selected:false,enabled:self.count>0}};Pagination.prototype.first=function(format){var self=this;var page=1;format=format||self.format;return{url:format.format(page,self.items,self.count),page:page,selected:false,enabled:self.count>0}};Pagination.prototype.render=function(max,format){var self=this;if(self.transformName)return transforms["pagination"][self.transformName].apply(self,arguments);var builder=[];format=format||self.format;if(typeof max===STRING){var tmp=format;format=max;max=format}if(max===undefined||max===null){for(var i=1;i<self.count+1;i++)builder.push({url:format.format(i,self.items,self.count),page:i,selected:i===self.page,enabled:true});return builder}var half=Math.floor(max/2);var pages=self.count;var pageFrom=self.page-half;var pageTo=self.page+half;var plus=0;if(pageFrom<=0){plus=Math.abs(pageFrom);pageFrom=1;pageTo+=plus}if(pageTo>=pages){pageTo=pages;pageFrom=pages-max}if(pageFrom<0)pageFrom=1;for(var i=pageFrom;i<pageTo+1;i++)builder.push({url:format.format(i,self.items,self.count),page:i,selected:i===self.page,enabled:true});return builder};UrlBuilder.prototype.add=function(name,value){var self=this;if(typeof name!==OBJECT){self.builder[name]=value;return self}var arr=Object.keys(name);for(var i=0,length=arr.length;i<length;i++)self.builder[arr[i]]=name[arr[i]];return self};UrlBuilder.prototype.remove=function(name){var self=this;delete self.builder[name];return self};UrlBuilder.prototype.read=function(name){return this.builder[name]||null};UrlBuilder.prototype.clear=function(){var self=this;self.builder={};return self};UrlBuilder.prototype.toString=function(url,skipEmpty){if(typeof url===BOOLEAN){var tmp=skipEmpty;skipEmpty=url;url=tmp}var self=this;var builder=[];Object.keys(self.builder).forEach(function(o){var value=self.builder[o];if(value===undefined||value===null)value="";else value=value.toString();if(skipEmpty&&value==="")return;builder.push(o+"="+encodeURIComponent(value))});if(typeof url===STRING){if(url[url.length-1]!=="?")url+="?"}else url="";return url+builder.join("&")};UrlBuilder.prototype.hasValue=function(keys){if(keys===undefined)return false;var self=this;if(typeof keys==="string")keys=[keys];for(var i=0;i<keys.length;i++){var val=self.builder[keys[i]];if(val===undefined||val===null)return false}return true};UrlBuilder.prototype.toOne=function(keys,delimiter){var self=this;var builder=[];keys.forEach(function(o){builder.push(self.builder[o]||"")});return builder.join(delimiter||"&")};exports.SchemaBuilder=SchemaBuilder;exports.ErrorBuilder=ErrorBuilder;exports.Pagination=Pagination;exports.UrlBuilder=UrlBuilder;return module;})({ exports: {} });(function(module){var exports=module.exports;global.framework_utils=module.exports;
"use strict";var parser=require("url");var qs=require("querystring");var http=require("http");var https=require("https");var util=require("util");var path=require("path");var fs=require("fs");var events=require("events");var crypto=require("crypto");var expressionCache={};var sys=require("sys");var regexpMail=new RegExp("^[a-zA-Z0-9-_.+]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,4}$");var regexpUrl=new RegExp("^(http[s]?:\\/\\/(www\\.)?|ftp:\\/\\/(www\\.)?|www\\.){1}([0-9A-Za-z-\\.@:%_+~#=]+)+((\\.[a-zA-Z]{2,3})+)(/(.)*)?(\\?(.)*)?");var regexpTRIM=/^[\s]+|[\s]+$/g;var ENCODING="utf8";var UNDEFINED="undefined";var STRING="string";var FUNCTION="function";var NUMBER="number";var OBJECT="object";var BOOLEAN="boolean";var NEWLINE="\r\n";var VERSION=typeof framework!==UNDEFINED?" v"+framework.version_header:"";var contentTypes={aac:"audio/aac",ai:"application/postscript",appcache:"text/cache-manifest",avi:"video/avi",bin:"application/octet-stream",bmp:"image/bmp",coffee:"text/coffeescript",css:"text/css",csv:"text/csv",doc:"application/msword",docx:"application/msword",dtd:"application/xml-dtd",eps:"application/postscript",exe:"application/octet-stream",geojson:"application/json",gif:"image/gif",gzip:"application/x-gzip",htm:"text/html",html:"text/html",ico:"image/x-icon",ics:"text/calendar",ifb:"text/calendar",jpe:"image/jpeg",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json",less:"text/css",m4a:"audio/mp4a-latm",m4v:"video/x-m4v",md:"text/markdown",mid:"audio/midi",midi:"audio/midi",mov:"video/quicktime",mp3:"audio/mpeg",mp4:"video/mp4",mpe:"video/mpeg",mpeg:"video/mpeg",mpg:"video/mpeg",mpga:"audio/mpeg",mtl:"text/plain",mv4:"video/mv4",obj:"text/plain",ogg:"application/ogg","package":"text/plain",pdf:"application/pdf",png:"image/png",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.ms-powerpoint",ps:"application/postscript",rar:"application/x-rar-compressed",rtf:"text/rtf",sass:"text/css",scss:"text/css",sh:"application/x-sh",stl:"application/sla",svg:"image/svg+xml",swf:"application/x-shockwave-flash",tar:"application/x-tar",tif:"image/tiff",tiff:"image/tiff",txt:"text/plain",wav:"audio/x-wav",webp:"image/webp",woff:"font/woff",xht:"application/xhtml+xml",xhtml:"application/xhtml+xml",xls:"application/vnd.ms-excel",xlsx:"application/vnd.ms-excel",xml:"application/xml",xpm:"image/x-xpixmap",xsl:"application/xml",xslt:"application/xslt+xml",zip:"application/zip"};if(typeof setImmediate===UNDEFINED){global.setImmediate=function(cb){process.nextTick(cb)}}var hasOwnProperty=Object.prototype.hasOwnProperty;function expression(query,params){var name=params.join(",");var fn=expressionCache[query+"-"+name];if(!fn){fn=eval("(function("+name+"){"+(query.indexOf("return")===-1?"return ":"")+query+"})");expressionCache[query+name]=fn}var values=[];for(var i=2;i<arguments.length;i++)values.push(arguments[i]);return function(){var arr=[];for(var i=0;i<arguments.length;i++)arr.push(arguments[i]);for(var i=0;i<values.length;i++)arr.push(values[i]);return fn.apply(this,arr)}}global.expression=expression;exports.isEmpty=function(obj){if(obj===null)return true;if(obj.length&&obj.length>0)return false;if(obj.length===0)return true;for(var key in obj){if(hasOwnProperty.call(obj,key))return false}return true};exports.isEqual=function(obj1,obj2,properties){var keys=properties?properties:Object.keys(obj1);for(var i=0,length=keys.length;i<length;i++){var key=keys[i];if(obj1[key]===obj2[key])continue;return false}return true};exports.wait=function(fnValid,fnCallback,timeout,interval){if(fnValid()===true)return fnCallback(null);var id_timeout=null;var id_interval=setInterval(function(){if(fnValid()===true){clearInterval(id_interval);clearTimeout(id_timeout);if(fnCallback)fnCallback(null);return}},interval||500);id_timeout=setTimeout(function(){clearInterval(id_interval);if(fnCallback)fnCallback(new Error("Timeout."))},timeout||5e3)};exports.request=function(url,flags,data,callback,cookies,headers,encoding,timeout){if(typeof data===FUNCTION){timeout=encoding;encoding=headers;headers=cookies;cookies=callback;callback=data;data=""}if(typeof cookies===NUMBER){cookies=null;timeout=cookies}if(typeof headers===NUMBER){headers=null;timeout=headers}if(typeof encoding===NUMBER){encoding=null;timeout=encoding}var method="GET";var length=0;var type=0;var e=new events.EventEmitter;headers=exports.extend({},headers||{});if(typeof encoding!==STRING)encoding=ENCODING;if(data===null)data="";if(flags instanceof Array){length=flags.length;for(var i=0;i<length;i++){switch(flags[i].toLowerCase()){case"xhr":headers["X-Requested-With"]="XMLHttpRequest";break;case"json":headers["Content-Type"]="application/json";if(method==="")method="POST";type=1;break;case"xml":headers["Content-Type"]="text/xml";if(method==="")method="POST";type=2;break;case"get":case"delete":case"options":method=flags[i].toUpperCase();break;case"upload":headers["Content-Type"]="multipart/form-data";break;case"post":case"put":method=flags[i].toUpperCase();if(!headers["Content-Type"])headers["Content-Type"]="application/x-www-form-urlencoded";break}}}var isPOST=method==="POST"||method==="PUT";if(typeof data!==STRING)data=type===1?JSON.stringify(data):qs.stringify(data);else if(data[0]==="?")data=data.substring(1);if(!isPOST){if(data.length>0&&url.indexOf("?")===-1)url+="?"+data;data=""}var uri=parser.parse(url);var responseLength=0;uri.method=method;headers["X-Powered-By"]="total.js"+VERSION;if(cookies){var builder=[];var keys=Object.keys(cookies);length=keys.length;for(var i=0;i<length;i++)builder.push(keys[i]+"="+encodeURIComponent(cookies[keys[i]]));if(builder.length>0)headers["Cookie"]=builder.join("; ")}if(data.length>0)headers["Content-Length"]=data.length;uri.agent=false;uri.headers=headers;var onResponse=function(res){res._buffer="";res._bufferlength=0;if(res.statusCode===301){exports.request(res.headers["location"],flags,data,callback,cookies,headers,encoding,timeout);res=null;return}res.on("data",function(chunk){var self=this;self._buffer+=chunk.toString(encoding);self._bufferlength+=chunk.length;e.emit("data",chunk,responseLength>0?self._bufferlength/responseLength*100:0)});res.on("end",function(){var self=this;e.emit("end",self._buffer,self.statusCode,self.headers);if(callback)callback(null,self._buffer,self.statusCode,self.headers)});res.resume()};var connection=uri.protocol==="https:"?https:http;try{var request=isPOST?connection.request(uri,onResponse):connection.get(uri,onResponse);if(callback){request.on("error",function(error){callback(error,null,0,{})});request.setTimeout(timeout||1e4,function(){callback(new Error(exports.httpStatus(408)),null,0,null)})}request.on("response",function(response){responseLength=parseInt(response.headers["content-length"])||0;e.emit("begin",responseLength)});if(isPOST)request.end(data,encoding);else request.end()}catch(ex){if(callback)callback(ex,null,0,null);return e}return e};exports.download=function(url,flags,data,callback,cookies,headers,encoding,timeout){if(typeof data===FUNCTION){timeout=encoding;encoding=headers;headers=cookies;cookies=callback;callback=data;data=""}if(typeof cookies===NUMBER){cookies=null;timeout=cookies}if(typeof headers===NUMBER){headers=null;timeout=headers}if(typeof encoding===NUMBER){encoding=null;timeout=encoding}var method="GET";var length=0;var type=0;var e=new events.EventEmitter;headers=exports.extend({},headers||{});if(typeof encoding!==STRING)encoding=ENCODING;if(data===null)data="";if(flags instanceof Array){length=flags.length;for(var i=0;i<length;i++){switch(flags[i].toLowerCase()){case"xhr":headers["X-Requested-With"]="XMLHttpRequest";break;case"json":headers["Content-Type"]="application/json";type=1;break;case"xml":headers["Content-Type"]="text/xml";type=2;break;case"get":case"delete":case"options":method=flags[i].toUpperCase();break;case"upload":headers["Content-Type"]="multipart/form-data";break;case"post":case"put":method=flags[i].toUpperCase();if(!headers["Content-Type"])headers["Content-Type"]="application/x-www-form-urlencoded";break}}}var isPOST=method==="POST"||method==="PUT";if(typeof data!==STRING)data=type===1?JSON.stringify(data):qs.stringify(data);else if(data[0]==="?")data=data.substring(1);if(!isPOST){if(data.length>0&&url.indexOf("?")===-1)url+="?"+data;data=""}var uri=parser.parse(url);var responseLength=0;uri.method=method;headers["X-Powered-By"]="total.js"+VERSION;if(cookies){var builder=[];var keys=Object.keys(cookies);length=keys.length;for(var i=0;i<length;i++)builder.push(keys[i]+"="+encodeURIComponent(cookies[keys[i]]));if(builder.length>0)headers["Cookie"]=builder.join("; ")}if(data.length>0)headers["Content-Length"]=data.length;uri.agent=false;uri.headers=headers;var onResponse=function(res){res._bufferlength=0;res.on("data",function(chunk){var self=this;self._bufferlength+=chunk.length;e.emit("data",chunk,responseLength>0?self._bufferlength/responseLength*100:0)});res.on("end",function(){var self=this;e.emit("end",self.statusCode,self.headers)});callback(null,res);res.resume()};var connection=uri.protocol==="https:"?https:http;try{var request=isPOST?connection.request(uri,onResponse):connection.request(uri,onResponse);if(callback){request.on("error",function(error){callback(error,null,0,{})});request.setTimeout(timeout||1e4,function(){callback(new Error(exports.httpStatus(408)),null,0,null)})}request.on("response",function(response){responseLength=parseInt(response.headers["content-length"])||0;e.emit("begin",responseLength)});if(isPOST)request.end(data,encoding);else request.end()}catch(ex){if(callback)callback(ex,null,0,{});return e}return e};exports.send=function(name,stream,url,callback,headers,method){var self=this;if(typeof callback===OBJECT){var tmp=headers;callback=headers;headers=tmp}if(typeof stream===STRING)stream=fs.createReadStream(stream,{flags:"r"});var BOUNDARY="----"+Math.random().toString(16).substring(2);var h={};if(headers)util._extend(h,headers);name=path.basename(name);h["Cache-Control"]="max-age=0";h["Content-Type"]="multipart/form-data; boundary="+BOUNDARY;h["X-Powered-By"]="total.js"+VERSION;var uri=parser.parse(url);var options={protocol:uri.protocol,auth:uri.auth,method:method||"POST",hostname:uri.hostname,port:uri.port,path:uri.path,agent:false,headers:h};var response=function(res){if(!callback)return;res.body="";res.on("data",function(chunk){this.body+=chunk.toString(ENCODING)});res.on("end",function(){var self=this;callback(null,self.body,self.statusCode,self.headers)})};var connection=options.protocol==="https:"?https:http;var req=connection.request(options,response);if(callback){req.on("error",function(err){callback(err,null,0,null)})}var header=NEWLINE+NEWLINE+"--"+BOUNDARY+NEWLINE+'Content-Disposition: form-data; name="File"; filename="'+name+'"'+NEWLINE+"Content-Type: "+utils.getContentType(path.extname(name))+NEWLINE+NEWLINE;req.write(header);if(typeof stream.length===NUMBER){req.end(stream.toString("utf8")+NEWLINE+NEWLINE+"--"+BOUNDARY+"--");return self}stream.on("end",function(){req.end(NEWLINE+NEWLINE+"--"+BOUNDARY+"--")});stream.pipe(req,{end:false});return self};exports.trim=function(obj){var type=typeof obj;if(type===STRING)return obj.trim();if(type!==OBJECT)return obj;Object.keys(obj).forEach(function(name){var val=obj[name];if(typeof val===OBJECT){exports.trim(val);return}if(typeof val!==STRING)return;obj[name]=val.trim()});return obj};exports.noop=function(){};global.noop=function(){};exports.httpStatus=function(code,addCode){return(addCode||true?code+": ":"")+http.STATUS_CODES[code]};exports.extend=function(target,source,rewrite){if(target===null||source===null)return target;if(typeof target!==OBJECT||typeof source!==OBJECT)return target;var keys=Object.keys(source);var i=keys.length;while(i--){var key=keys[i];if(rewrite||target[key]===undefined)target[key]=source[key]}return target};exports.copy=function(source,target){if(target===undefined)return exports.extend({},source,true);if(target===null||source===null)return target;if(typeof target!==OBJECT||typeof source!==OBJECT)return target;var keys=Object.keys(source);var i=keys.length;while(i--){var key=keys[i];if(target[key]===undefined)continue;target[key]=source[key]}return target};exports.reduce=function(source,prop){if(source===null||prop===null)return source;var type=typeof prop;if(prop instanceof Array){Object.keys(source).forEach(function(o){if(prop.indexOf(o)===-1)delete source[o]})}if(type===OBJECT){var obj=Object.keys(prop);Object.keys(source).forEach(function(o){if(obj.indexOf(o)===-1)delete source[o]})}return source};exports.assign=function(obj,path,fn){if(obj===null||obj===undefined)return obj;var arr=path.split(".");var model=obj[arr[0]];for(var i=1;i<arr.length-1;i++)model=model[arr[i]];model[arr[arr.length-1]]=typeof fn===FUNCTION?fn(model[arr[arr.length-1]]):fn;return obj};exports.isRelative=function(url){return!(url.substring(0,2)==="//"||url.indexOf("http://")!==-1||url.indexOf("https://")!==-1)};exports.encode=function(str){if(str===undefined)return"";var type=typeof str;if(type!==STRING)str=str.toString();return str.encode()};exports.decode=function(str){if(str===undefined)return"";var type=typeof str;if(type!==STRING)str=str.toString();return str.decode()};exports.isStaticFile=function(url){var pattern=/\.\w{2,8}($|\?)+/g;return pattern.test(url)};exports.isNullOrEmpty=function(str){if(typeof str!==STRING)return true;return str.length===0};exports.parseInt=function(obj,def){if(obj===undefined||obj===null)return def||0;var type=typeof obj;if(type===NUMBER)return obj;var str=type!==STRING?obj.toString():obj;return str.parseInt(def,10)};exports.parseFloat=function(obj,def){if(obj===undefined||obj===null)return def||0;var type=typeof obj;if(type===NUMBER)return obj;var str=type!==STRING?obj.toString():obj;return str.parseFloat(def)};exports.isArray=function(obj){return obj instanceof Array};exports.isRegExp=function(obj){return util.isRegExp(obj)};exports.isDate=function(obj){return util.isDate(obj)};exports.getContentType=function(ext){if(ext[0]===".")ext=ext.substring(1);return contentTypes[ext.toLowerCase()]||"application/octet-stream"};exports.setContentType=function(ext,type){if(ext[0]===".")ext=ext.substring(1);contentTypes[ext.toLowerCase()]=type;return true};exports.etag=function(text,version){var sum=0;var length=text.length;for(var i=0;i<length;i++)sum+=text.charCodeAt(i);return sum.toString()+(version?":"+version:"")};exports.path=function(path,delimiter){if(!path)path="";delimiter=delimiter||"/";if(path[path.length-1]===delimiter)return path;return path+delimiter};exports.random=function(max,min){max=max||1e5;min=min||0;return Math.floor(Math.random()*(max-min+1))+min};exports.GUID=function(max){max=max||40;var rnd=function(){return Math.floor(Math.random()*65536).toString(16)};var str="";for(var i=0;i<max/4+1;i++)str+=rnd();return str.substring(0,max)};exports.validate=function(model,properties,prepare,builder,resource,path,collection){if(typeof builder===FUNCTION&&resource===undefined){resource=builder;builder=null}if(collection===undefined)collection={};var error=builder;var current=path===undefined?"":path+".";var isSchema=false;var schemaName="";var definition=null;if(!(error instanceof builders.ErrorBuilder))error=new builders.ErrorBuilder(resource);if(typeof properties===STRING){var schema=collection===undefined?builders.validation(properties):collection[properties]===undefined?"":collection[properties].properties;if(schema.length!==0){schemaName=properties;properties=schema;isSchema=true;definition=collection===undefined?builders.schema("default").collection:collection;if(!definition)definition={}}else properties=properties.replace(/\s/g,"").split(",")}if(model===undefined||model===null)model={};if(typeof prepare!==FUNCTION)throw new Error("Validate hasn't any method to validate properties.\nDefine delegate: framework.onValidate ...");for(var i=0;i<properties.length;i++){var name=properties[i].toString();var value=model[name];var type=typeof value;if(value===undefined){error.add(name,"@",current+name);continue}else if(type===FUNCTION)value=model[name]();if(type!==OBJECT&&isSchema){collection=builders.schema("default").collection;if(builders.isJoin(collection,name))type=OBJECT}if(type===OBJECT&&!exports.isDate(value)){if(isSchema){var schema=collection[schemaName];if(schema){schema=schema.schema[name]||null;if(schema===Date||schema===String||schema===Number||schema===Boolean){}else if(schema!==null&&typeof schema===STRING){var isArray=schema[0]==="[";if(isArray)schema=schema.substring(1,schema.length-1).trim();if(isArray){if(!(value instanceof Array)){error.add(name,"@",current+name);continue}if(collection[schema]===undefined){var result2=prepare(name,value,current+name,schemaName,model);if(result2===undefined)continue;type=typeof result2;if(type===STRING){error.add(name,result2,current+name);continue}if(type===BOOLEAN){if(!result2)error.add(name,"@",current+name);continue}if(result2.isValid===false)error.add(name,result2.error,current+name);continue}var sublength=value.length;for(var j=0;j<sublength;j++)exports.validate(value[j],schema,prepare,error,resource,current+name,collection);continue}exports.validate(value,schema,prepare,error,resource,current+name,collection);continue}}}}var result=prepare(name,value,current+name,schemaName,model);if(result===undefined)continue;type=typeof result;if(type===STRING){error.add(name,result,current+name);continue}if(type===BOOLEAN){if(!result)error.add(name,"@",current+name);continue}if(result.isValid===false)error.add(name,result.error,current+name)}return error};exports.isValid=function(valid,error){return{isValid:valid,error:error||"@"}};exports.isEmail=function(str){return(str||"").toString().isEmail()};exports.isURL=function(str){return(str||"").toString().isURL()};exports.combine=function(){var self=this;if(arguments[0][0]==="~"){arguments[0]=arguments[0].substring(1);return path.join.apply(self,arguments)}return"."+path.join.apply(self,arguments)};exports.removeDiacritics=function(str){var dictionaryA=["Ã¡","Ã¤","Ä","Ä","Ã©","Ä","Å¥","Å¾","Ãº","Å¯","Ã¼","Ã­","Ã¯","Ã´","Ã³","Ã¶","Å¡","Ä¾","Äº","Ã½","Ã¿","Ä","Å"];var dictionaryB=["a","a","c","d","e","e","t","z","u","u","u","i","i","o","o","o","s","l","l","y","y","c","r"];var buf="";var length=str.length;for(var i=0;i<length;i++){var c=str[i];var isUpper=false;var index=dictionaryA.indexOf(c);if(index===-1){index=dictionaryA.indexOf(c.toLowerCase());isUpper=true}if(index===-1){buf+=c;continue}c=dictionaryB[index];if(isUpper)c=c.toUpperCase();buf+=c}return buf};exports.parseXML=function(xml){var beg=-1;var end=0;var tmp=0;var current=[];var obj={};var from=-1;while(true){beg=xml.indexOf("<",beg+1);if(beg===-1)break;end=xml.indexOf(">",beg+1);if(end===-1)break;var el=xml.substring(beg,end+1);var c=el[1];if(c==="?"||c==="/"){var o=current.pop();if(from===-1||o!==el.substring(2,el.length-1))continue;var path=(current.length>0?current.join(".")+".":"")+o;var value=xml.substring(from,beg);if(obj[path]===undefined)obj[path]=value;else if(obj[path]instanceof Array)obj[path].push(value);else obj[path]=[obj[path],value];from=-1;continue}tmp=el.indexOf(" ");var hasAttributes=true;if(tmp===-1){tmp=el.length-1;hasAttributes=false}from=beg+el.length;var isSingle=el[el.length-2]==="/";var name=el.substring(1,tmp);if(!isSingle)current.push(name);if(!hasAttributes)continue;var match=el.match(/\w+\=\".*?\"/g);if(match===null)continue;var attr={};var length=match.length;for(var i=0;i<length;i++){var index=match[i].indexOf('"');attr[match[i].substring(0,index-1)]=match[i].substring(index+1,match[i].length-1)}obj[current.join(".")+(isSingle?"."+name:"")+"[]"]=attr}return obj};exports.getWebSocketFrame=function(code,message,type){var messageBuffer=getWebSocketFrameMessageBytes(code,message);var messageLength=messageBuffer.length;var lengthBuffer=getWebSocketFrameLengthBytes(messageLength);var frameBuffer=new Buffer(1+lengthBuffer.length+messageLength);frameBuffer[0]=128|type;lengthBuffer.copy(frameBuffer,1,0,lengthBuffer.length);messageBuffer.copy(frameBuffer,lengthBuffer.length+1,0,messageLength);return frameBuffer};function getWebSocketFrameMessageBytes(code,message){var index=code===0?0:2;var binary=message.readUInt8!==undefined;var length=message.length;var messageBuffer=new Buffer(length+index);for(var i=0;i<length;i++){if(binary)messageBuffer[i+index]=message[i];else messageBuffer[i+index]=message.charCodeAt(i)}if(code===0)return messageBuffer;messageBuffer[0]=code>>8;messageBuffer[1]=code;return messageBuffer}function getWebSocketFrameLengthBytes(length){var lengthBuffer=null;if(length<=125){lengthBuffer=new Buffer(1);lengthBuffer[0]=length;return lengthBuffer}if(length<=65535){lengthBuffer=new Buffer(3);lengthBuffer[0]=126;lengthBuffer[1]=length>>8&255;lengthBuffer[2]=length&255;return lengthBuffer}lengthBuffer=new Buffer(9);lengthBuffer[0]=127;lengthBuffer[1]=0;lengthBuffer[2]=0;lengthBuffer[3]=0;lengthBuffer[4]=0;lengthBuffer[5]=length>>24&255;lengthBuffer[6]=length>>16&255;lengthBuffer[7]=length>>8&255;lengthBuffer[8]=length&255;return lengthBuffer}exports.distance=function(lat1,lon1,lat2,lon2){var R=6371;var dLat=(lat2-lat1).toRad();var dLon=(lon2-lon1).toRad();var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1.toRad())*Math.cos(lat2.toRad())*Math.sin(dLon/2)*Math.sin(dLon/2);var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return(R*c).floor(3)};exports.ls=function(path,callback,filter){var filelist=new FileList;filelist.onComplete=callback;filelist.onFilter=filter||null;filelist.walk(path)};Date.prototype.add=function(type,value){var self=this;var dt=new Date(self.getTime());switch(type){case"s":case"ss":case"second":case"seconds":dt.setSeconds(dt.getSeconds()+value);return dt;case"m":case"mm":case"minute":case"minutes":dt.setMinutes(dt.getMinutes()+value);return dt;case"h":case"hh":case"hour":case"hours":dt.setHours(dt.getHours()+value);return dt;case"d":case"dd":case"day":case"days":dt.setDate(dt.getDate()+value);return dt;case"M":case"MM":case"month":case"months":dt.setMonth(dt.getMonth()+value);return dt;case"y":case"yyyy":case"year":case"years":dt.setFullYear(dt.getFullYear()+value);return dt}return dt};Date.prototype.compare=function(date){var self=this;var r=self.getTime()-date.getTime();if(r===0)return 0;if(r<0)return-1;return 1};Date.compare=function(d1,d2){if(typeof d1===STRING)d1=d1.parseDate();if(typeof d2===STRING)d2=d2.parseDate();return d1.compare(d2)};Date.prototype.format=function(format){var self=this;var h=self.getHours();var m=self.getMinutes().toString();var s=self.getSeconds().toString();var M=(self.getMonth()+1).toString();var yyyy=self.getFullYear().toString();var d=self.getDate().toString();var a="AM";var H=h.toString();if(h>=12){h-=12;a="PM"}if(h===0)h=12;h=h.toString();var hh=h.padLeft(2,"0");var HH=H.padLeft(2,"0");var mm=m.padLeft(2,"0");var ss=s.padLeft(2,"0");var MM=M.padLeft(2,"0");var dd=d.padLeft(2,"0");var yy=yyyy.substring(2);if(format===undefined||format===null||format==="")return yyyy+"-"+MM+"-"+dd+"T"+hh+":"+mm+":"+ss+":"+self.getMilliseconds().toString();return format.replace(/yyyy/g,yyyy).replace(/yy/g,yy).replace(/MM/g,MM).replace(/M/g,M).replace(/dd/g,dd).replace(/d/g,d).replace(/HH/g,HH).replace(/H/g,H).replace(/hh/g,hh).replace(/h/g,h).replace(/mm/g,mm).replace(/m/g,m).replace(/ss/g,ss).replace(/s/g,ss).replace(/a/g,a)};if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(regexpTRIM,"")}}if(!String.prototype.replaceAt){String.prototype.replaceAt=function(index,character){var self=this;return self.substr(0,index)+character+self.substr(index+character.length)}}String.prototype.startsWith=function(text,ignoreCase){var self=this;var length=text.length;var tmp=self.substring(0,length);if(ignoreCase)return tmp.length===length&&tmp.toLowerCase()===text.toLowerCase();return tmp.length===length&&tmp===text};String.prototype.endsWith=function(text,ignoreCase){var self=this;var length=text.length;var tmp=self.substring(self.length-length);if(ignoreCase)return tmp.length===length&&tmp.toLowerCase()===text.toLowerCase();return tmp.length===length&&tmp===text};String.prototype.replacer=function(find,text){var self=this;var beg=self.indexOf(find);if(beg===-1)return self;return self.substring(0,beg)+text+self.substring(beg+find.length)};String.prototype.hash=function(type){var str=this;switch((type||"").toLowerCase()){case"md5":return str.md5();case"sha1":return str.sha1();case"sha256":return str.sha256();case"sha512":return str.sha512();default:return str.split("").reduce(function(a,b){a=(a<<5)-a+b.charCodeAt(0);return a&a},0)}};String.prototype.count=function(text){var index=0;var count=0;do{index=this.indexOf(text,index+text.length);if(index>0)count++}while(index>0);return count};String.prototype.parseXML=function(){return exports.parseXML(this)};String.prototype.parseDate=function(){var self=this.trim();var arr=self.indexOf(" ")===-1?self.split("T"):self.split(" ");var index=arr[0].indexOf(":");var length=arr[0].length;if(index!==-1){var tmp=arr[1];arr[1]=arr[0];arr[0]=tmp}if(arr[0]===undefined)arr[0]="";var noTime=arr[1]===undefined?true:arr[1].length===0;for(var i=0;i<length;i++){var c=arr[0].charCodeAt(i);if(c>47&&c<58)continue;if(c===45||c===46)continue;if(noTime)return null}if(arr[1]===undefined)arr[1]="00:00:00";var date=(arr[0]||"").split("-");var time=(arr[1]||"").split(":");var parsed=[];if(date.length<4&&time.length<2)return null;index=time[2].indexOf(".");if(index!==-1){time[3]=time[2].substring(index+1);time[2]=time[2].substring(0,index)}else time[3]="0";parsed.push(parseInt(date[0],10));parsed.push(parseInt(date[1],10));parsed.push(parseInt(date[2],10));parsed.push(parseInt(time[0],10));parsed.push(parseInt(time[1],10));parsed.push(parseInt(time[2],10));parsed.push(parseInt(time[3],10));var def=new Date;for(var i=0,length=parsed.length;i<length;i++){if(isNaN(parsed[i]))parsed[i]=0;var value=parsed[i];if(value!==0)continue;switch(i){case 0:if(value<=0)parsed[i]=def.getFullYear();break;case 1:if(value<=0)parsed[i]=def.getMonth()+1;break;case 2:if(value<=0)parsed[i]=def.getDate();break}}return new Date(parsed[0],parsed[1]-1,parsed[2],parsed[3],parsed[4],parsed[5])};String.prototype.parseDateExpire=function(){var self=this;var arr=self.split(" ");var dt=new Date;var length=arr.length;for(var i=0;i<length;i+=2){var num=arr[i].parseInt();if(num===0)continue;var type=arr[i+1]||"";if(type==="")continue;dt=dt.add(type,num)}return dt};String.prototype.contains=function(value,mustAll){var str=this;if(typeof value===STRING)return str.indexOf(value,typeof mustAll===NUMBER?mustAll:0)!==-1;var length=value.length;for(var i=0;i<length;i++){var exists=str.indexOf(value[i])!==-1;if(mustAll){if(!exists)return false}else if(exists)return true}return mustAll};String.prototype.configuration=function(def){console.log("OBSOLETE: String.configuration() -> use String.parseConfig([default])");return this.parseConfig(def)};String.prototype.parseConfig=function(def){var arr=this.split("\n");var length=arr.length;var obj=exports.extend({},def);for(var i=0;i<length;i++){var str=arr[i];if(str===""||str[0]==="#")continue;if(str.substring(0,2)==="//")continue;var index=str.indexOf(":");if(index===-1)continue;obj[str.substring(0,index).trim()]=str.substring(index+1).trim()}return obj};String.prototype.format=function(){var formatted=this;var length=arguments.length;for(var i=0;i<length;i++){var regexp=new RegExp("\\{"+i+"\\}","gi");formatted=formatted.replace(regexp,arguments[i])}return formatted};String.prototype.encode=function(){return this.replace(/\&/g,"&amp;").replace(/\>/g,"&gt;").replace(/\</g,"&lt;").replace(/\"/g,"&quot;")};String.prototype.decode=function(){return this.replace(/&gt;/g,">").replace(/\&lt;/g,"<").replace(/\&quot;/g,'"').replace(/&amp;/g,"&")};String.prototype.urlEncode=function(){return encodeURIComponent(this)};String.prototype.urlDecode=function(){return decodeURIComponent(this)};String.prototype.params=function(obj){var formatted=this;if(obj===undefined||obj===null)return formatted;var reg=/\{[^}\n]*\}/g;var match=formatted.match(reg);if(match===null)return formatted;var length=match.length;for(var i=0;i<length;i++){var prop=match[i];var isEncode=false;var name=prop.substring(1,prop.length-1).trim();var format="";var index=name.indexOf("|");if(index!==-1){format=name.substring(index+1,name.length).trim();name=name.substring(0,index).trim()}if(prop.substring(0,2)==="{!")name=name.substring(1);else isEncode=true;var val;if(name.indexOf(".")!==-1){var arr=name.split(".");if(arr.length===2)val=obj[arr[0]][arr[1]];else if(arr.length===3)val=obj[arr[0]][arr[1]][arr[3]];else if(arr.length===4)val=obj[arr[0]][arr[1]][arr[3]][arr[4]];else if(arr.length===5)val=obj[arr[0]][arr[1]][arr[3]][arr[4]][arr[5]]}else val=name.length===0?obj:obj[name];if(typeof val===FUNCTION)val=val(index);if(val===undefined)continue;if(format.length>0){var type=typeof val;if(type===STRING){var max=parseInt(format,10);if(!isNaN(max))val=val.max(max+3,"...")}else if(type===NUMBER||util.isDate(val)){if(format.isNumber())format=parseInt(format);val=val.format(format)}}val=val.toString().dollar();formatted=formatted.replace(prop,isEncode?exports.encode(val):val)}return formatted};String.prototype.max=function(length,chars){var str=this;chars=chars||"...";return str.length>length?str.substring(0,length-chars.length)+chars:str};String.prototype.isJSON=function(){var self=this;if(self.length<=1)return false;var a=self[0];var b=self[self.length-1];return a==='"'&&b==='"'||a==="["&&b==="]"||a==="{"&&b==="}"};String.prototype.isURL=function(){var str=this;if(str.length<=7)return false;return regexpUrl.test(str)};String.prototype.isEmail=function(){var str=this;if(str.length<=4)return false;if(str[0]==="."||str[str.length-1]===".")return false;return regexpMail.test(str)};String.prototype.parseInt=function(def){var num=0;var str=this;if(str.substring(0,1)==="0")num=parseInt(str.replace(/\s/g,"").substring(1),10);else num=parseInt(str.replace(/\s/g,""),10);if(isNaN(num))return def||0;return num};String.prototype.parseFloat=function(def){var num=0;var str=this;if(str.substring(0,1)==="0")num=parseFloat(str.replace(/\s/g,"").substring(1).replace(",","."));else num=parseFloat(str.replace(/\s/g,"").replace(",","."));if(isNaN(num))return def||0;return num};String.prototype.toUnicode=function(){var result="";var self=this;var length=self.length;for(var i=0;i<length;++i){if(self.charCodeAt(i)>126||self.charCodeAt(i)<32)result+="\\u"+self.charCodeAt(i).hex(4);else result+=self[i]}return result};String.prototype.fromUnicode=function(){var str=this.replace(/\\u([\d\w]{4})/gi,function(match,v){return String.fromCharCode(parseInt(v,16))});return unescape(str)};String.prototype.sha1=function(salt){var hash=crypto.createHash("sha1");hash.update(this+(salt||""),ENCODING);return hash.digest("hex")};String.prototype.sha256=function(salt){var hash=crypto.createHash("sha256");hash.update(this+(salt||""),ENCODING);return hash.digest("hex")};String.prototype.sha512=function(salt){var hash=crypto.createHash("sha512");hash.update(this+(salt||""),ENCODING);return hash.digest("hex")};String.prototype.md5=function(salt){var hash=crypto.createHash("md5");hash.update(this+(salt||""),ENCODING);return hash.digest("hex")};String.prototype.toSearch=function(){return this.trim().replace(/\s{2,}/g," ").toLowerCase().removeDiacritics().replace(/y/g,"i")};String.prototype.encrypt=function(key,isUnique){var str="0"+this;var data_count=str.length;var key_count=key.length;var change=str[data_count-1];var random=isUnique?exports.random(120)+40:65;var count=data_count+random%key_count;var values=[];var index=0;values[0]=String.fromCharCode(random);var counter=this.length+key.length;for(var i=count-1;i>0;i--){index=str.charCodeAt(i%data_count);values[i]=String.fromCharCode(index^(key.charCodeAt(i%key_count)^random))}var hash=new Buffer(counter+"="+values.join(""),ENCODING).toString("base64").replace(/\//g,"-").replace(/\+/g,"_");index=hash.indexOf("=");if(index>0)return hash.substring(0,index);return hash};String.prototype.decrypt=function(key){var values=this.replace(/\-/g,"/").replace(/\_/g,"+");
var mod=values.length%4;if(mod>0){for(var i=0;i<mod;i++)values+="="}values=new Buffer(values,"base64").toString(ENCODING);var index=values.indexOf("=");if(index===-1)return null;var counter=parseInt(values.substring(0,index),10);if(isNaN(counter))return null;values=values.substring(index+1);var count=values.length;var random=values.charCodeAt(0);var key_count=key.length;var data_count=count-random%key_count;var decrypt_data=[];for(var i=data_count-1;i>0;i--){index=values.charCodeAt(i)^(random^key.charCodeAt(i%key_count));decrypt_data[i]=String.fromCharCode(index)}var val=decrypt_data.join("");if(counter!==val.length+key.length)return null;return val};String.prototype.base64ToFile=function(filename,callback){var self=this;var index=self.indexOf(",");if(index===-1)index=0;else index++;if(callback)fs.writeFile(filename,self.substring(index),"base64",callback);else fs.writeFile(filename,self.substring(index),"base64",exports.noop);return this};String.prototype.base64ContentType=function(){var self=this;var index=self.indexOf(";");if(index===-1)return"";return self.substring(5,index)};String.prototype.removeDiacritics=function(){return exports.removeDiacritics(this)};String.prototype.indent=function(max,c){var self=this;return new Array(max+1).join(c||" ")+self};String.prototype.isNumber=function(isDecimal){var self=this;var length=self.length;if(length===0)return false;isDecimal=isDecimal||false;for(var i=0;i<length;i++){var ascii=self.charCodeAt(i);if(isDecimal){if(ascii===44||ascii===46){isDecimal=false;continue}}if(ascii<48||ascii>57)return false}return true};String.prototype.padLeft=function(max,c){var self=this;return new Array(Math.max(0,max-self.length+1)).join(c||" ")+self};String.prototype.padRight=function(max,c){var self=this;return self+new Array(Math.max(0,max-self.length+1)).join(c||" ")};String.prototype.insert=function(index,value){var str=this;var a=str.substring(0,index);var b=value.toString()+str.substring(index);return a+b};String.prototype.dollar=function(){var str=this;var index=str.indexOf("$",0);while(index!==-1){if(str[index+1]==="$")str=str.insert(index,"$");index=str.indexOf("$",index+2)}return str.toString()};String.prototype.linker=function(max){max=max||60;var self=this.trim().toLowerCase().removeDiacritics();var builder="";var length=self.length;for(var i=0;i<length;i++){var c=self[i];var code=self.charCodeAt(i);if(builder.length>=max)break;if(code>31&&code<48){if(builder[builder.length-1]==="-")continue;builder+="-";continue}if(code>47&&code<58){builder+=c;continue}if(code>94&&code<123){builder+=c;continue}}return builder};String.prototype.slug=function(max){return this.linker(max)};String.prototype.link=function(max){console.log("String.prototype.link: OBSOLETE - Use String.prototype.Linker()");return this.linker(max)};String.prototype.pluralize=function(zero,one,few,other){var str=this;return str.parseInt().pluralize(zero,one,few,other)};String.prototype.isBoolean=function(){var self=this.toLowerCase();return self==="true"||self==="false"?true:false};Number.prototype.floor=function(decimals){return Math.floor(this*Math.pow(10,decimals))/Math.pow(10,decimals)};Number.prototype.padLeft=function(max,c){return this.toString().padLeft(max,c||"0")};Number.prototype.padRight=function(max,c){return this.toString().padRight(max,c||"0")};Number.prototype.format=function(decimals,separator,separatorDecimal){var self=this;if(typeof decimals===STRING)return self.format2(decimals);var num=self.toString();var dec="";var output="";var index=num.indexOf(".");if(typeof decimals===STRING){var tmp=separator;separator=decimals;decimals=tmp}if(separator===undefined)separator=" ";if(index!==-1){dec=num.substring(index+1);num=num.substring(0,index)}var index=-1;for(var i=num.length-1;i>=0;i--){index++;if(index>0&&index%3===0)output=separator+output;output=num[i]+output}if(dec.length>0||decimals>0){if(dec.length>decimals)dec=dec.substring(0,decimals);else dec=dec.padRight(decimals,"0")}if(dec.length>0&&separatorDecimal===undefined)separatorDecimal=separator==="."?",":".";return output+(dec.length>0?separatorDecimal+dec:"")};Number.prototype.format2=function(format){console.log("OBSOLETE: Number.prototype.format('###Â ###Â ###');");var index=0;var num=this.toString();var beg=0;var end=0;var max=0;var output="";var length=0;if(typeof format===STRING){var d=false;length=format.length;for(var i=0;i<length;i++){var c=format[i];if(c==="#"){if(d)end++;else beg++}if(c===".")d=true}var strBeg=num;var strEnd="";index=num.indexOf(".");if(index!==-1){strBeg=num.substring(0,index);strEnd=num.substring(index+1)}if(strBeg.length>beg){max=strBeg.length-beg;var tmp="";for(var i=0;i<max;i++)tmp+="#";format=tmp+format}if(strBeg.length<beg)strBeg=strBeg.padLeft(beg," ");if(strEnd.length<end)strEnd=strEnd.padRight(end,"0");if(strEnd.length>end)strEnd=strEnd.substring(0,end);d=false;index=0;var skip=true;length=format.length;for(var i=0;i<length;i++){var c=format[i];if(c!=="#"){if(skip)continue;if(c==="."){d=true;index=0}output+=c;continue}var value=d?strEnd[index]:strBeg[index];if(skip)skip=[","," "].indexOf(value)!==-1;if(!skip)output+=value;index++}return output}output="### ### ###";beg=num.indexOf(".");max=format||0;if(max===0&&beg!==-1)max=num.length-(beg+1);if(max>0){output+=".";for(var i=0;i<max;i++)output+="#"}return this.format(output)};Number.prototype.pluralize=function(zero,one,few,other){var num=this;var value="";if(num===0)value=zero||"";else if(num===1)value=one||"";else if(num>1&&num<5)value=few||"";else value=other;var beg=value.indexOf("#");var end=value.lastIndexOf("#");if(beg===-1)return value;var format=value.substring(beg,end+1);return num.format(format)+value.replace(format,"")};Number.prototype.hex=function(length){var str=this.toString(16).toUpperCase();while(str.length<length)str="0"+str;return str};Number.prototype.condition=function(ifTrue,ifFalse){return(this%2===0?ifTrue:ifFalse)||""};Number.prototype.VAT=function(percentage,decimals,includedVAT){var num=this;var type=typeof decimals;if(type===BOOLEAN){var tmp=includedVAT;includedVAT=decimals;decimals=tmp;type=typeof decimals}if(type===UNDEFINED)decimals=2;if(includedVAT===undefined)includedVAT=true;if(percentage===0||num===0)return num;return includedVAT?(num/(percentage/100+1)).floor(decimals):(num*(percentage/100+1)).floor(decimals)};Number.prototype.discount=function(percentage,decimals){var num=this;if(decimals===undefined)decimals=2;return(num-num/100*percentage).floor(decimals)};Number.prototype.parseDate=function(plus){return new Date(this+(plus||0))};if(typeof Number.prototype.toRad===UNDEFINED){Number.prototype.toRad=function(){return this*Math.PI/180}}Boolean.prototype.condition=function(ifTrue,ifFalse){return(this?ifTrue:ifFalse)||""};Array.prototype.take=function(count){var arr=[];var self=this;var length=self.length;for(var i=0;i<length;i++){arr.push(self[i]);if(arr.length>=count)return arr}return arr};Array.prototype.orderBy=function(name,asc){if(typeof name===BOOLEAN){var tmp=asc;asc=name;name=tmp}if(asc===undefined)asc=true;var self=this;var type=0;var path=(name||"").split(".");var length=path.length;self.sort(function(a,b){var va=null;var vb=null;switch(length){case 1:if(path[0]===""){va=a;vb=b}else{va=a[path[0]];vb=b[path[0]]}break;case 2:va=a[path[0]][path[1]];vb=b[path[0]][path[1]];break;case 3:va=a[path[0]][path[1]][path[2]];vb=b[path[0]][path[1]][path[2]];break;case 4:va=a[path[0]][path[1]][path[2]][path[3]];vb=b[path[0]][path[1]][path[2]][path[3]];break;case 5:va=a[path[0]][path[1]][path[2]][path[3]][path[4]];vb=b[path[0]][path[1]][path[2]][path[3]][path[4]];break;default:return 0}if(type===0){var t=typeof va;if(t===STRING)type=1;else if(t===NUMBER)type=2;else if(t===BOOLEAN)type=3;else type=4}if(type===1)return asc?va.removeDiacritics().localeCompare(vb.removeDiacritics()):vb.removeDiacritics().localeCompare(va.removeDiacritics());if(type===2){if(va>vb)return asc?1:-1;if(va<vb)return asc?-1:1;return 0}if(type===3){if(va===true&&vb===false)return asc?1:-1;if(va===false&&vb===true)return asc?-1:1;return 0}return 0});return self};Array.prototype.trim=function(){var self=this;var length=self.length;for(var i=0;i<length;i++){if(typeof self[i]===STRING)self[i]=self[i].trim()}return self};Array.prototype.skip=function(count){var arr=[];var self=this;var length=self.length;for(var i=0;i<length;i++){if(i>=count)arr.push(self[i])}return arr};Array.prototype.where=function(cb){var self=this;var selected=[];var length=self.length;for(var i=0;i<length;i++){if(cb.call(self,self[i],i))selected.push(self[i])}return selected};Array.prototype.find=function(cb){var self=this;var length=self.length;for(var i=0;i<length;i++){if(cb.call(self,self[i],i))return self[i]}return null};Array.prototype.remove=function(cb){var self=this;var arr=[];var length=self.length;for(var i=0;i<length;i++){if(!cb.call(self,self[i],i))arr.push(self[i])}return arr};Array.prototype.random=function(){var self=this;return self[exports.random(self.length-1)]};Array.prototype.waiting=function(onItem,callback){console.log("Array.prototype.waiting: OBSOLETE. Use Array.prototype.wait");return this.wait(onItem,callback)};Array.prototype.wait=function(onItem,callback,remove){var self=this;var type=typeof callback;if(type===NUMBER||type===BOOLEAN){var tmp=remove;remove=callback;callback=tmp}if(remove===undefined)remove=0;var item=remove===true?self.shift():self[remove];if(item===undefined){if(callback)callback();return self}onItem.call(self,item,function(){setImmediate(function(){if(typeof remove===NUMBER)remove++;self.wait(onItem,callback,remove)})});return self};Array.prototype.async=function(callback){var self=this;var item=self.shift();if(item===undefined){if(callback)callback();return self}item(function(){setImmediate(function(){self.async(callback)})});return self};Array.prototype._async_middleware=function(res,callback,controller){var self=this;if(res.success||res.headersSent){if(controller)controller.subscribe.success();callback=null;return self}var item=self.shift();if(item===undefined){if(callback)callback();return self}item(function(){setImmediate(function(){self._async_middleware(res,callback)})});return self};Array.prototype.randomize=function(){var self=this;var random=(Math.floor(Math.random()*1e8)*10).toString();var index=0;var old=0;self.sort(function(a,b){var c=random[index++];if(c===undefined){c=random[0];index=0}if(old>c){old=c;return-1}if(old===c){old=c;return 0}old=c;return 1});return self};function AsyncTask(owner,name,fn,cb,waiting){this.handlers={oncomplete:this.complete.bind(this)};this.isRunning=0;this.owner=owner;this.name=name;this.fn=fn;this.cb=cb;this.waiting=waiting;this.interval=null;this.isCanceled=false}AsyncTask.prototype.run=function(){var self=this;try{self.isRunning=1;self.owner.tasksWaiting[self.name]=true;self.owner.emit("begin",self.name);var timeout=self.owner.tasksTimeout[self.name];if(timeout>0)self.interval=setTimeout(self.timeout.bind(self),timeout);self.fn(self.handlers.oncomplete)}catch(ex){self.owner.emit("error",self.name,ex);self.complete()}return self};AsyncTask.prototype.timeout=function(timeout){var self=this;if(timeout>0){clearTimeout(self.interval);setTimeout(self.timeout.bind(self),timeout);return self}if(timeout<=0){clearTimeout(self.interval);setTimeout(self.timeout.bind(self),timeout);return self}self.cancel(true);return self};AsyncTask.prototype.cancel=function(isTimeout){var self=this;self.isCanceled=true;if(isTimeout)self.owner.emit("timeout",self.name);else self.owner.emit("cancel",self.name);self.fn=null;self.cb=null};AsyncTask.prototype.complete=function(){var item=this;var self=item.owner;item.isRunning=2;delete self.tasksPending[item.name];delete self.tasksWaiting[item.name];if(!item.isCanceled){try{self.emit("end",item.name);if(item.cb)item.cb()}catch(ex){self.emit("error",ex,item.name)}}self.reload();self.refresh();return self};function Async(owner){this._max=0;this._count=0;this._isRunning=false;this.owner=owner;this.onComplete=[];this.tasksPending={};this.tasksWaiting={};this.tasksAll=[];this.tasksTimeout={};events.EventEmitter.call(this)}Async.prototype={get count(){return this._count},get percentage(){var self=this;return 100-Math.floor(self._count*100/self._max)}};Async.prototype.__proto__=Object.create(events.EventEmitter.prototype,{constructor:{value:Async,enumberable:false}});Async.prototype.reload=function(){var self=this;self.tasksAll=Object.keys(self.tasksPending);self.emit("percentage",self.percentage);return self};Async.prototype.cancel=function(name){var self=this;if(name===undefined){for(var i=0;i<self._count;i++)self.cancel(tasksAll[i]);return true}var task=self.tasksPending[name];if(!task)return false;delete self.tasksPending[name];delete self.tasksWaiting[name];task.cancel();self.reload();self.refresh();return true};Async.prototype.await=function(name,fn,cb){var self=this;if(typeof name===FUNCTION){cb=fn;fn=name;name=exports.GUID(6)}if(self.tasksPending[name]!==undefined)return false;self.tasksPending[name]=new AsyncTask(self,name,fn,cb,null);self._max++;self.reload();self.refresh();return true};Async.prototype.wait=function(name,waitingFor,fn,cb){var self=this;if(typeof waitingFor===FUNCTION){cb=fn;fn=waitingFor;waitingFor=name;name=exports.GUID(6)}if(self.tasksPending[name]!==undefined)return false;self.tasksPending[name]=new AsyncTask(self,name,fn,cb,waitingFor);self._max++;self.reload();self.refresh();return true};Async.prototype.complete=function(fn){return this.run(fn)};Async.prototype.run=function(fn){var self=this;self._isRunning=true;if(fn)self.onComplete.push(fn);self.refresh();return self};Async.prototype.isRunning=function(name){var self=this;if(!name)return self._isRunning;var task=self.tasksPending[name];if(!task)return false;return task.isRunning===1};Async.prototype.isWaiting=function(name){var self=this;var task=self.tasksPending[name];if(!task)return false;return task.isRunning===0};Async.prototype.isPending=function(name){var self=this;var task=self.tasksPending[name];if(!task)return false;return true};Async.prototype.timeout=function(name,timeout){var self=this;if(timeout<=0||timeout===undefined){delete self.tasksTimeout[name];return self}self.tasksTimeout[name]=timeout;return self};Async.prototype.refresh=function(name){var self=this;if(!self._isRunning)return self;self._count=self.tasksAll.length;for(var i=0;i<self._count;i++){var task=self.tasksPending[self.tasksAll[i]];if(task.isRunning!==0)continue;if(task.waiting!==null&&self.tasksWaiting[task.waiting]!==undefined)continue;task.run()}if(self._count===0){self._isRunning=false;self.emit("complete");self.emit("percentage",100);self._max=0;var complete=self.onComplete;var length=complete.length;self.onComplete=[];for(var i=0;i<length;i++){try{complete[i]()}catch(ex){self.emit("error",ex)}}}return self};function FileList(){this.pending=[];this.pendingDirectory=[];this.directory=[];this.file=[];this.onComplete=null;this.onFilter=null}FileList.prototype.reset=function(){var self=this;self.file=[];self.directory=[];self.pendingDirectory=[]};FileList.prototype.walk=function(directory){var self=this;if(directory instanceof Array){var length=directory.length;for(var i=0;i<length;i++)self.pendingDirectory.push(directory[i]);self.next();return}fs.readdir(directory,function(err,arr){if(err)return self.next();var length=arr.length;for(var i=0;i<length;i++)self.pending.push(path.join(directory,arr[i]));self.next()})};FileList.prototype.stat=function(path){var self=this;fs.stat(path,function(err,stats){if(err)return self.next();if(stats.isDirectory()&&(self.onFilter===null||self.onFilter(path,true))){self.directory.push(path);self.pendingDirectory.push(path);self.next();return}if(self.onFilter===null||self.onFilter(path,false))self.file.push(path);self.next()})};FileList.prototype.next=function(){var self=this;if(self.pending.length>0){var item=self.pending.shift();self.stat(item);return}if(self.pendingDirectory.length>0){var directory=self.pendingDirectory.shift();self.walk(directory);return}self.onComplete(self.file,self.directory)};exports.Async=Async;exports.sync=function(fn,owner){return function(){var args=[].slice.call(arguments);var params;var callback;var executed=false;var self=owner||this;args.push(function(){params=arguments;if(!executed&&callback){executed=true;callback.apply(self,params)}});fn.apply(self,args);return function(cb){callback=cb;if(!executed&&params){executed=true;callback.apply(self,params)}}}};exports.async=function(fn){return function(complete){var self=this;var generator=fn();next(null);function next(err,result){var g;try{switch(err===null){case true:g=generator.next(result);break;case false:g=generator.throw(err);break}}catch(e){if(complete){if(typeof complete===OBJECT&&complete.view500)complete.view500(e);else complete(e)}return}if(g.done){if(complete&&typeof complete!==OBJECT)complete(null,g.value);return}if(typeof g.value!==FUNCTION){next.call(self,null,g.value);return}try{g.value.call(self,function(){next.apply(self,arguments)})}catch(e){setImmediate(function(){next.call(self,e)})}}return generator.value}};exports.getMessageLength=function(data,isLE){var length=data[1]&127;if(length===126){if(data.length<4)return-1;var a=211;var bLength=[data[3],data[2],0,0,0,0,0,0];return converBytesToInt64(bLength,0,isLE)}if(length===127){if(data.Length<10)return-1;var bLength=[data[9],data[8],data[7],data[6],data[5],data[4],data[3],data[2]];return converBytesToInt64(bLength,0,isLE)}return length};function converBytesToInt64(data,startIndex,isLE){if(isLE)return data[startIndex]|data[startIndex+1]<<8|data[startIndex+2]<<16|data[startIndex+3]<<24|data[startIndex+4]<<32|data[startIndex+5]<<40|data[startIndex+6]<<48|data[startIndex+7]<<56;return data[startIndex+7]<<32|data[startIndex+6]<<40|data[startIndex+5]<<48|data[startIndex+4]<<56|data[startIndex+3]|data[startIndex+2]<<8|data[startIndex+1]<<16|data[startIndex]<<24}var queue={};function queue_next(name){var item=queue[name];item.running--;if(item.running<0)item.running=0;if(item.pending.length===0)return;var fn=item.pending.shift();if(fn===undefined)return;(function(name){setImmediate(function(){fn(function(){queue_next(name)})})})(name)}exports.queue=function(name,max,fn){if(queue[name]===undefined)queue[name]={limit:max,running:0,pending:[]};var item=queue[name];item.running++;if(item.running>item.limit){item.pending.push(fn);return}(function(name){setImmediate(function(){fn(function(){queue_next(name)})})})(name)};global.async=exports.async;global.sync=exports.sync;return module;})({ exports: {} });(function(module){var exports=module.exports;global.framework_image=module.exports;
"use strict";var child=require("child_process");var exec=child.exec;var spawn=child.spawn;var path=require("path");var sof={192:true,193:true,194:true,195:true,197:true,198:true,199:true,201:true,202:true,203:true,205:true,206:true,207:true};function u16(buf,o){return buf[o]<<8|buf[o+1]}function u32(buf,o){return buf[o]<<24|buf[o+1]<<16|buf[o+2]<<8|buf[o+3]}exports.measureGIF=function(buffer){return{width:buffer[6],height:buffer[8]}};exports.measureJPG=function(buffer){var len=buffer.length;var o=0;var jpeg=255==buffer[0]&&216==buffer[1];if(!jpeg)return;o+=2;while(o<len){while(255!=buffer[o])o++;while(255==buffer[o])o++;if(!sof[buffer[o]]){o+=u16(buffer,++o);continue}var w=u16(buffer,o+6);var h=u16(buffer,o+4);return{width:w,height:h}}return null};exports.measurePNG=function(buffer){return{width:u32(buffer,16),height:u32(buffer,16+4)}};function Image(filename,useImageMagick){var type=typeof filename;this.builder=[];this.filename=type==="string"?filename:null;this.currentStream=type==="object"?filename:null;this.isIM=useImageMagick||false;this.outputType=type==="string"?path.extname(filename).substring(1):"jpg";if(!filename)throw new Error("Image filename is undefined.")}Image.prototype.clear=function(){var self=this;self.builder=[];return self};Image.prototype.measure=function(callback){var self=this;var index=self.filename.lastIndexOf(".");if(!self.filename){callback(new Error("Measure does not support stream."));return}if(index===-1){callback(new Error("This type of file is not supported."));return}var extension=self.filename.substring(index).toLowerCase();var stream=require("fs").createReadStream(self.filename,{start:0,end:extension===".jpg"?4e4:24});stream.on("data",function(buffer){switch(extension){case".jpg":callback(null,exports.measureJPG(buffer));return;case".gif":callback(null,exports.measureGIF(buffer));return;case".png":callback(null,exports.measurePNG(buffer));return}callback(new Error("This type of file is not supported."))});stream.on("error",callback);return self};Image.prototype.save=function(filename,callback){var self=this;if(typeof filename==="function"){callback=filename;filename=null}filename=filename||self.filename||"";var command=self.cmd(self.filename===null?"-":self.filename,filename);if(self.builder.length===0){if(callback)callback(null,filename);return}var cmd=exec(command,function(error,stdout,stderr){self.clear();if(!callback)return;if(error)callback(error,"");else callback(null,filename)});if(self.currentStream){if(self.currentStream instanceof Buffer)cmd.stdin.end(self.currentStream);else self.currentStream.pipe(cmd.stdin)}return self};Image.prototype.pipe=function(stream,type,options){var self=this;if(typeof type==="object"){options=type;type=null}if(self.builder.length===0)return;if(type===undefined||type===null)type=self.outputType;var cmd=spawn(self.isIM?"convert":"gm",self.arg(self.filename===null?"-":self.filename,(type?type+":":"")+"-"));cmd.stderr.on("data",stream.emit.bind(stream,"error"));cmd.stdout.on("data",stream.emit.bind(stream,"data"));cmd.stdout.on("end",stream.emit.bind(stream,"end"));cmd.on("error",stream.emit.bind(stream,"error"));cmd.stdout.pipe(stream,options);if(self.currentStream){if(self.currentStream instanceof Buffer)cmd.stdin.end(self.currentStream);else self.currentStream.pipe(cmd.stdin)}return self};Image.prototype.stream=function(type){var self=this;if(self.builder.length===0)return;if(type===undefined||type===null)type=self.outputType;var cmd=spawn(self.isIM?"convert":"gm",self.arg(self.filename===null?"-":self.filename,(type?type+":":"")+"-"));if(self.currentStream){if(self.currentStream instanceof Buffer)cmd.stdin.end(self.currentStream);else self.currentStream.pipe(cmd.stdin)}return cmd.stdout};Image.prototype.cmd=function(filenameFrom,filenameTo){var self=this;var cmd="";self.builder.sort(function(a,b){if(a.priority>b.priority)return 1;else return-1});var length=self.builder.length;for(var i=0;i<length;i++)cmd+=(cmd.length>0?" ":"")+self.builder[i].cmd;return(self.isIM?"convert":"gm -convert")+' "'+filenameFrom+'"'+" "+cmd+' "'+filenameTo+'"'};Image.prototype.arg=function(first,last){var self=this;var arr=[];if(!self.isIM)arr.push("-convert");if(first)arr.push(first);self.builder.sort(function(a,b){if(a.priority>b.priority)return 1;else return-1});var length=self.builder.length;for(var i=0;i<length;i++){var o=self.builder[i];var index=o.cmd.indexOf(" ");if(index===-1)arr.push(o.cmd);else{arr.push(o.cmd.substring(0,index));arr.push(o.cmd.substring(index+1).replace(/\"/g,""))}}if(last)arr.push(last);return arr};Image.prototype.identify=function(cb){var self=this;exec((self.isIM?"identify":"gm identify")+' "'+self.fileName+'"',function(error,stdout,stderr){if(error){cb(error,null);return}var arr=stdout.split(" ");var size=arr[2].split("x");var obj={type:arr[1],width:framework_utils.parseInt(size[0]),height:framework_utils.parseInt(size[1])};cb(null,obj)});return self};Image.prototype.push=function(key,value,priority){var self=this;self.builder.push({cmd:key+(value?' "'+value+'"':""),priority:priority});return self};Image.prototype.output=function(type){var self=this;if(type[0]===".")type=type.substring(1);self.outputType=type;return self};Image.prototype.resize=function(w,h,options){options=options||"";var self=this;var size="";if(w&&h)size=w+"x"+h;else if(w&&!h)size=w;else if(!w&&h)size="x"+h;return self.push("-resize",size+options,1)};Image.prototype.resizeCenter=function(w,h){return this.resize(w,h,"^").align("center").crop(w,h)};Image.prototype.scale=function(w,h,options){options=options||"";var self=this;var size="";if(w&&h)size=w+"x"+h;else if(w&&!h)size=w;else if(!w&&h)size="x"+h;return self.push("-scale",size+options,1)};Image.prototype.crop=function(w,h,x,y){return this.push("-crop",w+"x"+h+"+"+(x||0)+"+"+(y||0),4)};Image.prototype.quality=function(percentage){return this.push("-quality",percentage||80,5)};Image.prototype.align=function(type){var output="";switch(type.toLowerCase().replace("-","")){case"left top":case"top left":output="NorthWest";break;case"left bottom":case"bottom left":output="SouthWest";break;case"right top":case"top right":output="NorthEast";break;case"right bottom":case"bottom right":output="SouthEast";break;case"left center":case"center left":case"left":output="West";break;case"right center":case"center right":case"right":output="East";break;case"bottom center":case"center bottom":case"bottom":output="South";break;case"top center":case"center top":case"top":output="North";break;case"center center":case"center":output="Center";break;default:output=type;break}return this.push("-gravity",output,3)};Image.prototype.gravity=function(type){return this.align(type)};Image.prototype.blur=function(radius){return this.push("-blur",radius,10)};Image.prototype.normalize=function(){return this.push("-normalize",null,10)};Image.prototype.rotate=function(deg){return this.push("-rotate",deg||0,8)};Image.prototype.flip=function(){return this.push("-flip",null,10)};Image.prototype.flop=function(){return this.push("-flop",null,10)};Image.prototype.minify=function(){return this.push("+profile","*")};Image.prototype.grayscale=function(){return this.push("-colorspace","Gray",10)};Image.prototype.bitdepth=function(value){return this.push("-depth",value,10)};Image.prototype.colors=function(value){return this.push("-colors",value,10)};Image.prototype.background=function(color){return this.push("-background",color,2)};Image.prototype.sepia=function(percentage){return this.push("-modulate","115,0,100",4).push("-colorize","7,21,50",5)};Image.prototype.command=function(key,value,priority){return this.push(key,value,priority||10)};exports.Image=Image;exports.Picture=Image;exports.init=function(filename,imageMagick){return new Image(filename,imageMagick)};exports.load=function(filename,imageMagick){return new Image(filename,imageMagick)};return module;})({ exports: {} });(function(module){var exports=module.exports;global.framework_nosql=module.exports;
"use strict";var fs=require("fs");var path=require("path");var util=require("util");var events=require("events");var VERSION="v2.0.9";var STATUS_UNKNOWN=0;var STATUS_READING=1;var STATUS_WRITING=2;var STATUS_LOCKING=3;var STATUS_PENDING=4;var EXTENSION=".nosql";var EXTENSION_VIEW=".nosql";var EXTENSION_BINARY=".nosql-binary";var EXTENSION_TMP=".nosql-tmp";var EXTENSION_CHANGES=".changelog";var EXTENSION_STORED=".nosql-stored";var EXTENSION_META=".meta";var MAX_WRITESTREAM=2;var MAX_READSTREAM=4;var MAX_BUFFER_SIZE=1024*40;var BINARY_HEADER_LENGTH=2e3;var NEWLINE="\n";var STRING="string";var FUNCTION="function";var UNDEFINED="undefined";var BOOLEAN="boolean";if(typeof setImmediate===UNDEFINED){global.setImmediate=function(cb){process.nextTick(cb)}}function Database(filename,directory,changes){if(typeof directory===BOOLEAN){changes=directory;directory=null}this.isReady=false;this.status_prev=STATUS_UNKNOWN;this.status=STATUS_UNKNOWN;this.changes=changes===undefined?true:changes===true;this.countRead=0;this.countWrite=0;this.pendingRead=[];this.pendingEach=[];this.pendingLock=[];this.pendingDrop=[];this.pendingWrite=[];this.pendingClear=[];this.isPending=false;if(filename.indexOf(EXTENSION)!==-1)filename=filename.replace(EXTENSION,"");this.filename=filename+EXTENSION;this.filenameTemp=filename+EXTENSION_TMP;this.filenameChanges=filename+EXTENSION_CHANGES;this.filenameStored=filename+EXTENSION_STORED;this.filenameMeta=filename+EXTENSION_META;this.name=path.basename(filename);this.directory=path.dirname(filename);this.views=new Views(this);this.meta={version:VERSION,views:{},stored:{},description:"",created:new Date,custom:null};this.binary=(directory||"").length===0?null:new Binary(this,directory);this.changelog=new Changelog(this,this.filenameChanges);this.file=new FileReader(this);this.stored=new Stored(this,this.filenameStored);this._metaLoad()}function Views(db){this.views={};this.db=db;this.directory=db.directory;this.emit=db.emit}function View(db,name,filename){this.db=db;this.status=STATUS_UNKNOWN;this.countRead=0;this.pendingRead=[];this.pendingOperation=[];this.filename=filename;this.name=name;this.emit=db.emit;this.file=new FileReader(db)}function Stored(db,filename){this.filename=filename;this.db=db;this.stored={};this.cache={};this.isReaded=false}function Binary(db,directory){this.db=db;this.directory=directory;this.exists=false}function Changelog(db,filename){this.filename=filename;this.db=db}function FileReader(db){this.db=db}Database.prototype={get created(){var dt=this.meta.created;if(util.isDate(dt))return dt;if(dt===null||dt===undefined)return null;return new Date(Date.parse(dt.toString()))}};Database.prototype.__proto__=Object.create(events.EventEmitter.prototype,{constructor:{value:Database,enumberable:false}});Database.prototype.insert=function(arr,fnCallback,changes){var self=this;if(typeof fnCallback===STRING){changes=fnCallback;fnCallback=null}if(!(arr instanceof Array))arr=[arr];var length=arr.length;if(self.status===STATUS_LOCKING||self.status===STATUS_PENDING||self.countWrite>=MAX_WRITESTREAM){for(var i=0;i<length;i++)self.pendingWrite.push({json:arr[i],changes:changes});if(fnCallback)fnCallback(-1);return self}var builder=[];var builderChanges=[];for(var i=0;i<length;i++){var doc=arr[i];if(doc.json===undefined){builder.push(doc);if(changes)builderChanges.push(changes);continue}builder.push(doc.json);if(doc.changes)builderChanges.push(doc.changes)}if(builder.length===0){self.next();return}self.emit("insert",true,builder.length);self.status=STATUS_WRITING;self.countWrite++;appendFile(self.filename,builder,function(){self.countWrite--;self.emit("insert",false,builder.length);self.next();self.changelog.insert(builderChanges);if(fnCallback){var length=builder.length;setImmediate(function(){fnCallback(length)})}builder=null;builderChanges=null;arr=null;var keys=Object.keys(self.meta.views);var length=keys.length;for(var i=0;i<length;i++)self.views.refresh(keys[i])},self);return self};Database.prototype.read=function(fnMap,fnCallback,itemSkip,itemTake,isScalar,name){var self=this;var skip=itemSkip||0;var take=itemTake||0;if(self.status===STATUS_LOCKING||self.status===STATUS_PENDING||self.countRead>=MAX_READSTREAM){self.pendingRead.push(function(){self.read(fnMap,fnCallback,itemSkip,itemTake,isScalar)});return self}if(fnCallback===undefined){fnCallback=fnMap;fnMap=function(doc){return doc}}if(typeof fnMap===STRING)fnMap=filterPrepare(fnMap);if(fnMap===null)fnMap=function(doc){return doc};self.emit(name||"read",true,0);self.countRead++;self.status=STATUS_READING;var selected=[];var current="";var count=0;var resume=true;var fnBuffer=function(buffer){current+=buffer;return current};var fnItem=function(err,doc){if(!resume)return;current="";if(err)return;var item=fnMap(doc);if(item===false||item===null||item===undefined)return;count++;if(skip>0&&count<=skip)return;if(!isScalar)selected.push(item===true?doc:item);if(take>0&&selected.length===take)resume=false};var reader=self.file.open(self.filename,MAX_BUFFER_SIZE,function(buffer){onBuffer(buffer,fnItem,fnBuffer);return resume},function(){self.countRead--;self.next();setImmediate(function(){self.emit(name||"read",false,isScalar?count:selected.length);fnCallback(isScalar?count:selected)})});return self};Database.prototype.all=function(fnMap,fnCallback,itemSkip,itemTake){return this.read(fnMap,fnCallback,itemSkip,itemTake,false,"all")};Database.prototype.one=function(fnMap,fnCallback){var cb=function(selected){fnCallback(selected[0]||null)};return this.read(fnMap,cb,0,1,false,"one")};Database.prototype.top=function(max,fnMap,fnCallback){return this.read(fnMap,fnCallback,0,max,false,"top")};Database.prototype.count=function(fnFilter,fnCallback){return this.read(fnFilter,fnCallback,0,0,true,"count")};Database.prototype.each=function(fnDocument,fnCallback){var self=this;if(self.status===STATUS_LOCKING||self.status===STATUS_PENDING||self.countRead>=MAX_READSTREAM){if(fnDocument)self.pendingEach.push({item:fnDocument,callback:fnCallback});return self}var operation=[];if(fnDocument)operation.push({item:fnDocument,callback:fnCallback});var length=self.pendingEach.length;for(var i=0;i<length;i++)operation.push(self.pendingEach[i]);if(operation.length===0){self.next();return self}self.countRead++;self.status=STATUS_READING;var current="";var count=0;self.pendingEach=[];var fnBuffer=function(buffer){current+=buffer;return current};var fnItem=function(err,doc){current="";if(err){self.emit("error",err,"each-buffer");return}var length=operation.length;for(var i=0;i<length;i++){try{operation[i].item(doc,count,"each-buffer")}catch(e){self.emit("error",e)}}count++};self.emit("each",true,0);var reader=self.file.open(self.filename,MAX_BUFFER_SIZE,function(buffer){onBuffer(buffer,fnItem,fnBuffer);return true},function(){self.countRead--;self.next();setImmediate(function(){self.emit("each",false,count);var length=operation.length;for(var i=0;i<length;i++){var fn=operation[i];if(fn.callback)fn.callback()}})});return self};Database.prototype.sort=function(fnMap,fnSort,itemSkip,itemTake,fnCallback){var self=this;var selected=[];var count=0;if(typeof fnMap===STRING)fnMap=filterPrepare(fnMap);itemTake=itemTake||30;itemSkip=itemSkip||0;var onCallback=function(){selected.sort(fnSort);if(itemSkip>0||itemTake>0)selected=selected.slice(itemSkip,itemSkip+itemTake);fnCallback(selected,count)};var onItem=function(doc){var item=fnMap(doc);if(item===false||item===null||item===undefined)return;count++;selected.push(item===true?doc:item)};self.each(onItem,onCallback);return self};Database.prototype.clear=function(fnCallback,changes){var self=this;var type=typeof fnCallback;if(fnCallback===undefined)fnCallback=null;if(type===STRING){changes=fnCallback;fnCallback=null}self.pendingClear.push(function(){if(changes)self.changelog.insert(changes);if(fnCallback)fnCallback()});if(self.status!==STATUS_UNKNOWN)return self;self.status=STATUS_LOCKING;var operation=[];var length=self.pendingClear.length;for(var i=0;i<length;i++){var fn=self.pendingClear[i];if(fn!==null)operation.push(fn)}self.emit("clear",true,false);self.pendingClear=[];fs.exists(self.filename,function(exists){if(!exists){self.next();setImmediate(function(){self.emit("clear",false,true);var length=operation.length;for(var i=0;i<length;i++){var fn=operation[i];if(fn)fn()}});return}fs.unlink(self.filename,function(err){if(err)self.emit("error",err,"clear");self.next();setImmediate(function(){self.emit("clear",false,err===null);var length=operation.length;for(var i=0;i<length;i++){var fn=operation[i];if(fn)fn()}})})});return self};Database.prototype.drop=function(fnCallback){var self=this;if(fnCallback===undefined)fnCallback=null;self.pendingDrop.push(fnCallback);if(self.status!==STATUS_UNKNOWN)return self;self.status=STATUS_LOCKING;var operation=[];self.pendingDrop.forEach(function(o){if(o!==null)operation.push(o)});self.emit("drop",true,false);self.pendingDrop=[];self._drop();fs.exists(self.filename,function(exists){if(!exists){self.next();setImmediate(function(){self.emit("drop",false,true);operation.forEach(function(fn){if(fn)fn()})});return}fn.unlink(self.filenameMeta,noop);fs.unlink(self.filename,function(err){if(err)self.emit("error",err,"drop");self.next();setImmediate(function(){self.emit("drop",false,err===null);operation.forEach(function(fn){if(fn)fn(err===null)})})})});return self};function noop(){}Database.prototype._drop=function(){var self=this;fs.readdirSync(self.directory).forEach(function(filename){var isView=filename.indexOf(self.name+"#")!==-1&&filename.indexOf(EXTENSION_VIEW)!==-1;if(isView){fs.unlink(path.join(self.directory,filename),noop);return}var isChange=self.name+EXTENSION_CHANGES===filename;if(isChange){fs.unlink(path.join(self.directory,filename),noop);return}});if(self.binary===null)return self;fs.readdirSync(self.binary.directory).forEach(function(filename){if(filename.indexOf(self.name+"#")===-1||filename.indexOf(EXTENSION_BINARY)===-1)return;fs.unlink(path.join(self.binary.directory,filename),noop)});return self};Database.prototype.update=function(fnUpdate,fnCallback,changes,type){var self=this;if(typeof fnCallback===STRING){changes=fnCallback;fnCallback=null}if(fnUpdate!==undefined)self.pendingLock.push(updatePrepare(fnUpdate,fnCallback,changes,type||"update"));if(self.status!==STATUS_UNKNOWN){return self}var operation=[];self.pendingLock.forEach(function(fn){operation.push(fn)});if(operation.length===0){self.next();return self}self.status=STATUS_LOCKING;var current="";var operationLength=operation.length;var lines=[];var countRemove=0;var countUpdate=0;var countWrite=0;var completed=false;self.emit("update/remove",true,0,0);self.pendingLock=[];var fnRename=function(){operation.forEach(function(o){if(o.type==="update"){o.count=countUpdate;return}if(o.type==="remove")o.count=countRemove});fs.rename(self.filenameTemp,self.filename,function(err){if(err)self.emit("error",err,"update/rename-file");self.emit("update/remove",false,countUpdate,countRemove);var changes=[];operation.forEach(function(o){if(o.changes!==undefined)changes.push(o.changes);if(o.callback)(function(cb,count){setImmediate(function(){cb(count)})})(o.callback,o.count)});if(changes.length>0)self.changelog.insert(changes);self.next()})};var fnWrite=function(json,valid){if(lines.length>25||valid){if(lines.length===0){if(completed&&countWrite<=0)fnRename();return}countWrite++;fs.appendFile(self.filenameTemp,lines.join(NEWLINE)+NEWLINE,function(){countWrite--;if(completed&&countWrite<=0)fnRename()});lines=[]}if(typeof json===STRING)lines.push(json)};var fnBuffer=function(buffer){current+=buffer;return current};var fnItem=function(err,doc,json){current="";var skip=false;var value=null;for(var i=0;i<operationLength;i++){var fn=operation[i];value=fn.filter(doc)||null;if(value===null)break}if(value===null){self.emit("remove",doc);countRemove++;return}var updated=JSON.stringify(value);if(updated!==json){self.emit("update",value);countUpdate++}fnWrite(updated)};fs.appendFile(self.filenameTemp,"");var reader=self.file.open(self.filename,MAX_BUFFER_SIZE,function(buffer){onBuffer(buffer.toString(),fnItem,fnBuffer);return true},function(success){if(!success){self.next();return}completed=true;fnWrite(null,true)});return self};Database.prototype.prepare=function(fnUpdate,fnCallback,changes){var self=this;if(fnUpdate!==undefined)self.pendingLock.push(updatePrepare(fnUpdate,fnCallback,changes,"update"));return self};Database.prototype.remove=function(fnFilter,fnCallback,changes){var self=this;if(typeof fnFilter===STRING)fnFilter=filterPrepare(fnFilter);var filter=function(item){if(fnFilter(item)===true)return null;return item};self.update(filter,fnCallback,changes,"remove");return self};Database.prototype.pause=function(){var self=this;if(self.isPending===true)return self;self.isPending=true;if(self.status===STATUS_UNKNOWN){self.status=STATUS_PENDING;self.emit("pause/resume",true)}return self};Database.prototype.resume=function(){var self=this;if(!self.isPending)return self;self.isPending=false;self.emit("pause/resume",false);self.next();return self};Database.prototype.next=function(){var self=this;if(self.isPending){if(self.status!==STATUS_PENDING){self.status=STATUS_PENDING;self.emit("pause")}return}self.status_prev=self.status;self.status=STATUS_UNKNOWN;if(self.countRead>0){self.status=STATUS_READING;return}if(self.countWrite>0){self.status=STATUS_WRITING;return}if(self.pendingWrite.length>0){self.insert(self.pendingWrite);self.pendingWrite=[];return}if(self.pendingLock.length>0){self.update();return}if(self.pendingEach.length>0){self.each();return}if(self.pendingRead.length>0){var max=self.pendingRead.length;if(max>MAX_READSTREAM)max=MAX_READSTREAM;for(var i=0;i<max;i++)self.pendingRead.shift()();return}if(self.pendingDrop.length>0){self.drop();return}if(self.pendingClear.length>0){self.clear();return}setImmediate(function(){self.emit("complete",self.status_prev)})};Database.prototype.description=function(value){var self=this;if(value===undefined)return self.meta.description;self.meta.description=(value||"").toString();self._metaSave();return self};Database.prototype.custom=function(value){var self=this;if(value===undefined)return self.meta.custom;self.meta.custom=value;self._metaSave();return self};Database.prototype._metaSave=function(){var self=this;if(self.meta.created===undefined)self.meta.created=new Date;fs.writeFile(self.filenameMeta,JSON.stringify(self.meta),noop);return self};Database.prototype._metaLoad=function(callback){var self=this;fs.readFile(self.filenameMeta,function(err,data){var isReady=self.isReady;self.isReady=true;if(err){if(!isReady){self.emit("ready");self.emit("load")}if(callback)callback(false,self.meta);return}self.meta=JSON.parse(data.toString("utf8"));var keys=Object.keys(self.meta.views);var length=keys.length;for(var i=0;i<length;i++)self.meta.views[keys[i]].isReady=true;if(!isReady){self.emit("ready");self.emit("load")}if(callback)callback(true,self.meta)});return self};Views.prototype.all=function(name,fnCallback,itemSkip,itemTake,fnMap){var self=this;var view=self.views[name];if(view===undefined){view=self.getView(name);self.views[name]=view}var type=typeof itemSkip;if(type===FUNCTION||type===STRING){fnMap=itemSkip;itemSkip=0;itemTake=0}else{type=typeof itemTake;if(type===FUNCTION||type===STRING){fnMap=itemTake;itemTake=0}}if(typeof fnMap===STRING)fnMap=filterPrepare(fnMap);if(typeof fnMap!==FUNCTION)fnMap=function(o){return o};view.read(fnMap,fnCallback,itemSkip,itemTake);return self.db};Views.prototype.top=function(name,top,fnCallback,fnMap){var self=this;var view=self.views[name];if(view===undefined){view=self.getView(name);self.views[name]=view}if(typeof fnMap===STRING)fnMap=filterPrepare(fnMap);if(typeof fnMap!==FUNCTION)fnMap=function(o){return o};view.read(fnMap,fnCallback,0,top,true);return self.db};Views.prototype.one=function(name,fnMap,fnCallback){var self=this;var view=self.views[name];if(view===undefined){view=self.getView(name);self.views[name]=view}if(fnCallback===undefined){fnCallback=fnMap;fnMap=null}if(typeof fnMap===STRING)fnMap=filterPrepare(fnMap);if(typeof fnMap!==FUNCTION)fnMap=function(o){return o};view.read(fnMap,fnCallback,0,1,true);return self.db};Views.prototype.drop=function(name,fnCallback,changes){var self=this;var view=self.views[name];if(typeof fnCallback===STRING){changes=fnCallback;fnCallback=null}if(view===undefined){view=self.getView(name);self.views[name]=view}delete self.db.meta.views[name];self.db._metaSave();self.db.emit("view/drop",true,name);view.operation(function(cb){fs.exists(view.filename,function(exists){self.db.emit("view/drop",false,name);if(changes)self.db.changelog.insert(changes);if(!exists){if(fnCallback)fnCallback(true);if(cb)cb();return}fs.unlink(view.filename,function(err){if(err)self.db.emit("error",err,"view/drop");if(fnCallback)fnCallback(true);if(cb)cb()})})});return self.db};Views.prototype.refresh=function(name,fnCallback){var self=this;var schema=self.db.meta.views[name];schema.isReady=false;var fnSort=schema["sort"]||"";var fnMap=schema["map"];if(fnSort.length===0)fnSort=null;else fnSort=eval("("+fnSort+")");fnMap=eval("("+fnMap+")");var selected=[];var count=0;self.db.emit("view/refresh",true,name,"");var onCallback=function(){if(fnSort)selected.sort(fnSort);var view=self.views[name];if(view===undefined){view=self.getView(name);self.views[name]=view}var filename=self.getFileName(name);view.operation(function(cb){var fnAppend=function(){appendFile(filename,selected,function(){self.db.emit("view/refresh",false,name,count);schema.isReady=true;if(fnCallback)setImmediate(function(){fnCallback(count)});if(cb)cb()},self.db)};fs.exists(filename,function(exists){if(!exists){fnAppend();return}fs.unlink(filename,function(err){if(!err){fnAppend();return}self.db.emit("error",err,"view/refresh");if(cb)cb()})})})};var onItem=function(doc){var item=fnMap(doc)||null;if(item===null)return;count++;selected.push(item)};self.db.each(onItem,onCallback)};Views.prototype.create=function(name,fnMap,fnSort,fnCallback,changes){var self=this;if(typeof fnCallback===STRING){changes=fnCallback;fnCallback=null}if(typeof fnMap===STRING)fnMap=filterPrepare(fnMap);self.db.meta.views[name]={map:fnMap.toString(),sort:(fnSort||"").toString(),isReady:false};self.db._metaSave();self.db.emit("view/create",true,name,0);if(changes)self.db.changelog.insert(changes);self.refresh(name,fnCallback);return self};Views.prototype.getView=function(name){var self=this;return new View(self.db,name,self.getFileName(name))};Views.prototype.getFileName=function(name){var self=this;return path.join(self.directory,self.db.name+"#"+name+EXTENSION_VIEW)};View.prototype.read=function(fnMap,fnCallback,itemSkip,itemTake,skipCount,isScalar){var self=this;var skip=itemSkip||0;var take=itemTake||0;skipCount=skipCount||false;if(self.status===STATUS_LOCKING||self.countRead>=MAX_READSTREAM){self.pendingRead.push(function(){self.read(fnMap,fnCallback,itemSkip,itemTake,isScalar)});return self}self.status=STATUS_READING;if(typeof fnMap===STRING)fnMap=filterPrepare(fnMap);if(fnMap===null)fnMap=function(o){return o};self.db.emit("view",true,self.name,0);self.countRead++;var selected=[];var current="";var count=0;var resume=true;var fnBuffer=function(buffer){current+=buffer;return current};var fnItem=function(err,doc){if(!resume)return;current="";if(err)return;var item=fnMap(doc);if(item===false||item===null||item===undefined)return;count++;if(skip>0&&count<=skip)return;if(!isScalar)selected.push(item===true?doc:item);if(take>0&&selected.length===take)resume=false};var reader=self.file.open(self.filename,MAX_BUFFER_SIZE,function(buffer){if(skipCount&&!resume){count=-1;return false}onBuffer(buffer,fnItem,fnBuffer);return resume},function(){self.countRead--;self.next();setImmediate(function(){self.emit("view",false,self.name,count);fnCallback(selected,count)})});return self};View.prototype.operation=function(fnCallback){var self=this;if(fnCallback!==undefined)self.pendingOperation.push(fnCallback);if(self.status!==STATUS_UNKNOWN)return self;self.status=STATUS_LOCKING;var operation=self.pendingOperation.shift();operation(function(){self.next()});return self};View.prototype.next=function(){var self=this;self.status=STATUS_UNKNOWN;if(self.countRead>0){self.status=STATUS_READING;return}if(self.pendingOperation.length>0){self.operation();return}if(self.pendingRead.length>0){var max=self.pendingRead.length;if(max>MAX_READSTREAM)max=MAX_READSTREAM;for(var i=0;i<max;i++)self.pendingRead.shift()();return}};Stored.prototype.create=function(name,fn,fnCallback,changes){if(typeof fnCallback===STRING){var tmp=changes;changes=fnCallback;fnCallback=changes}var self=this;self.db.meta.stored[name]=fn.toString();self.db._metaSave(fnCallback);delete self.cache[name];if(changes)self.db.changelog.insert(changes);self.db.emit("stored/create",name);return self.db};Stored.prototype.remove=function(name,fnCallback,changes){var self=this;if(typeof fnCallback===STRING){var tmp=changes;changes=fnCallback;fnCallback=changes}if(changes)self.db.changelog.insert(changes);delete self.cache[name];delete self.db.meta.stored[name];self.db._metaSave(fnCallback);return self.db};Stored.prototype.clear=function(fnCallback,changes){var self=this;if(typeof fnCallback===STRING){var tmp=changes;changes=fnCallback;fnCallback=changes}if(changes)self.db.changelog.insert(changes);self.cache={};self.db.meta.stored={};self.db._metaSave(fnCallback);return self.db};Stored.prototype.execute=function(name,params,fnCallback,changes){var self=this;var type=typeof params;if(type===FUNCTION){changes=fnCallback;fnCallback=params;params=null}if(typeof fnCallback===STRING){var tmp=changes;changes=fnCallback;fnCallback=tmp}if(changes)self.db.changelog.insert(changes);var fn=self.db.meta.stored[name];if(fn===undefined){if(fnCallback)fnCallback();return}var cache=self.cache[name];self.db.emit("stored",name);if(fn===undefined){if(fnCallback)fnCallback();return}if(cache===undefined){fn=eval("("+fn+")");self.cache[name]=fn}else fn=cache;if(fnCallback===undefined)fnCallback=function(){};fn.call(self.db,self.db,fnCallback,params||null);return self};Binary.prototype.insert=function(name,type,buffer,fnCallback,changes){if(typeof buffer===STRING)buffer=new Buffer(buffer,"base64");if(typeof fnCallback===STRING){changes=fnCallback;fnCallback=null}var self=this;var size=buffer.length;var dimension={width:0,height:0};self.check();if(name.indexOf(".gif")!==-1)dimension=dimensionGIF(buffer);else if(name.indexOf(".png")!==-1)dimension=dimensionPNG(buffer);else if(name.indexOf(".jpg")!==-1)dimension=dimensionJPG(buffer);var header=new Buffer(BINARY_HEADER_LENGTH);header.fill(" ");header.write(JSON.stringify({name:name,size:size,type:type,width:dimension.width,height:dimension.height}));var id=(new Date).getTime().toString()+Math.random().toString(36).substring(10);var key=self.db.name+"#"+id;var stream=fs.createWriteStream(path.join(self.directory,key+EXTENSION_BINARY));stream.write(header,"binary");stream.end(buffer);stream=null;if(changes)self.db.changelog.insert(changes);if(fnCallback)fnCallback(id,header);return id};Binary.prototype.update=function(id,name,type,buffer,fnCallback,changes){if(typeof buffer===STRING)buffer=new Buffer(buffer,"base64");if(typeof fnCallback===STRING){changes=fnCallback;fnCallback=null}var self=this;var size=buffer.length;var dimension={width:0,height:0};var key=id;self.check();if(key.indexOf("#")===-1)key=self.db.name+"#"+key;if(name.indexOf(".gif")!==-1)dimension=dimensionGIF(buffer);else if(name.indexOf(".png")!==-1)dimension=dimensionPNG(buffer);else if(name.indexOf(".jpg")!==-1)dimension=dimensionJPG(buffer);var header=new Buffer(BINARY_HEADER_LENGTH);header.fill(" ");header.write(JSON.stringify({name:name,size:size,type:type,width:dimension.width,height:dimension.height}));var stream=fs.createWriteStream(path.join(self.directory,key+EXTENSION_BINARY));stream.write(header,"binary");stream.end(buffer);stream=null;if(changes)self.db.changelog.insert(changes);if(fnCallback)fnCallback(id,header);return id};Binary.prototype.read=function(id,callback){var self=this;self.check();if(id.indexOf("#")===-1)id=self.db.name+"#"+id;var filename=path.join(self.directory,id+EXTENSION_BINARY);var stream=fs.createReadStream(filename,{start:0,end:BINARY_HEADER_LENGTH-1,encoding:"binary"});stream.on("error",function(err){callback(err,null,null)});stream.on("data",function(buffer){var json=new Buffer(buffer,"binary").toString("utf8").replace(/^[\s]+|[\s]+$/g,"");stream=fs.createReadStream(filename,{start:BINARY_HEADER_LENGTH});callback(null,stream,JSON.parse(json))});return self.db};Binary.prototype.remove=function(id,fnCallback,changes){var self=this;var key=id;self.check();if(key.indexOf("#")===-1)key=self.db.name+"#"+key;var filename=path.join(self.directory,key+EXTENSION_BINARY);if(typeof fnCallback===STRING){changes=fnCallback;fnCallback=null}fs.exists(filename,function(exists){if(changes)self.db.changelog.insert(changes);if(!exists){if(fnCallback)fnCallback(false);return}fs.unlink(filename,function(){if(fnCallback)fnCallback(true)})});return self.db};Binary.prototype.check=function(){var self=this;if(self.exists)return self;self.exists=true;if(fs.existsSync(self.directory))return self;fs.mkdirSync(self.directory);return self};Changelog.prototype.insert=function(description){var self=this;if(!self.db.changes)return self.db;if(description===undefined)return self.db;if(!(description instanceof Array))description=[description||""];if(description.length===0)return self.db;var lines="";var dd=new Date;var y=dd.getFullYear();var M=(dd.getMonth()+1).toString();var d=dd.getDate().toString();var h=dd.getHours().toString();var m=dd.getMinutes().toString();var s=dd.getSeconds().toString();if(M.length===1)M="0"+M;if(d.length===1)d="0"+d;if(m.length===1)m="0"+m;if(h.length===1)h="0"+h;if(s.length===1)s="0"+s;var dt=y+"-"+M+"-"+d+" "+h+":"+m+":"+s;description.forEach(function(line){lines+=dt+" | "+line+NEWLINE;self.db.emit("change",line)});fs.appendFile(self.filename,lines,function(err){});return self.db};Changelog.prototype.read=function(fnCallback){var self=this;fs.exists(self.filename,function(exist){if(!exist){fnCallback([]);return}fs.readFile(self.filename,function(err,data){if(err){fnCallback([]);return}var lines=data.toString("utf8").split("\n");if(lines[lines.length-1]==="")lines.pop();fnCallback(lines)})});return self.db};Changelog.prototype.clear=function(fnCallback){var self=this;fs.exists(self.filename,function(exist){if(!exist){if(fnCallback)fnCallback(false);return}fs.unlink(self.filename,function(err,data){if(err){if(fnCallback)fnCallback(false);return}if(fnCallback)fnCallback(true)})});return self.db};FileReader.prototype.open=function(filename,size,fnBuffer,fnCallback){var self=this;fs.open(filename,"r",function(err,fd){if(err){fnCallback(false);return}size=size||1024;var next=function next(cancel,position){if(cancel){fs.close(fd);fd=null;fnCallback(true);return}self.read(fd,position+size,size,fnBuffer,next)};self.read(fd,0,size,fnBuffer,next)})};FileReader.prototype.read=function(fd,position,size,fnBuffer,next){var buffer=new Buffer(size);fs.read(fd,buffer,0,size,position,function(err,num){var cancel=num!==size;var data=buffer.toString("utf8",0,num);if(cancel){data=data.replace(/\s+$/g,"");if(data[data.length-1]!==NEWLINE)data+=NEWLINE;fnBuffer(data);next(true);return}try{cancel=!fnBuffer(data)}catch(err){cancel=true}setImmediate(function(){next(cancel,position,size)})})};function appendFile(filename,arr,fnCallback,db){if(arr.length===0){fnCallback();return}var lines="";arr.slice(0,30).forEach(function(o){lines+=JSON.stringify(o)+NEWLINE});fs.appendFile(filename,lines,function(err){if(err)db.emit("error",err);appendFile(filename,arr.slice(30),fnCallback,db)})}function filterPrepare(fnFilter){if(fnFilter.length===0)return function(){return true};return eval("(function(doc){"+(fnFilter.indexOf("return ")===-1?"return ":"")+fnFilter+"})")}function onBuffer(buffer,fnItem,fnBuffer){var index=buffer.indexOf(NEWLINE);if(index===-1){fnBuffer(buffer);return}var json=fnBuffer(buffer.substring(0,index));try{fnItem(null,JSON.parse(json),json)}catch(ex){fnItem(ex,null,json)}onBuffer(buffer.substring(index+1),fnItem,fnBuffer)}function updatePrepare(fnUpdate,fnCallback,changes,type){if(typeof fnUpdate===STRING)fnUpdate=filterPrepare(fnUpdate);return{filter:fnUpdate,callback:fnCallback,count:0,type:type,changes:changes}}var sof={192:true,193:true,194:true,195:true,197:true,198:true,199:true,201:true,202:true,203:true,205:true,206:true,207:true};function u16(buf,o){return buf[o]<<8|buf[o+1]}function u32(buf,o){return buf[o]<<24|buf[o+1]<<16|buf[o+2]<<8|buf[o+3]}function dimensionGIF(buffer){return{width:buffer[6],height:buffer[8]}}function dimensionJPG(buffer){var len=buffer.length;var o=0;var jpeg=255==buffer[0]&&216==buffer[1];if(!jpeg)return;o+=2;while(o<len){while(255!=buffer[o])o++;while(255==buffer[o])o++;if(!sof[buffer[o]]){o+=u16(buffer,++o);continue}var w=u16(buffer,o+6);var h=u16(buffer,o+4);return{width:w,height:h}}}function dimensionPNG(buffer){return{width:u32(buffer,16),height:u32(buffer,16+4)}}exports.database=Database;exports.load=exports.open=exports.nosql=exports.init=function(filename,directory,changes){return new Database(filename,directory,changes)};return module;})({ exports: {} });(function(module){var exports=module.exports;global.framework_mail=module.exports;
"use strict";var net=require("net");var tls=require("tls");var events=require("events");var dns=require("dns");var fs=require("fs");var path=require("path");var CRLF="\r\n";var UNDEFINED="undefined";var errors={notvalid:"E-mail address is not valid",resolve:"Cannot resolve MX of ",connection:"Cannot connect to any SMTP server."};function Mailer(){this.debug=false;this.Message=Message;this.Mail=Message}Mailer.prototype=new events.EventEmitter;Mailer.prototype.create=function(subject,body){return new Message(subject,body)};function resolveMx(domain,callback){dns.resolveMx(domain,function(err,data){if(err){callback(err,data);return}if(!data||data.length===0){callback(new Error(errors.resolve+domain));return}data.sort(function(a,b){return a.priority<b.priority});function tryConnect(index){if(index>=data.length){callback(new Error(errors.connection));return}var sock=net.createConnection(25,data[index].exchange);sock.on("error",function(err){tryConnect(++index)});sock.on("connect",function(){sock.removeAllListeners("error");callback(null,sock)})}tryConnect(0)})}function Message(subject,body){this.subject=subject||"";this.body=body||"";this.files=[];this.addressTo=[];this.addressReply=[];this.addressCC=[];this.addressBCC=[];this.addressFrom={name:"",address:""};this.callback=null}Message.prototype.sender=function(address,name){return this.from(address,name)};Message.prototype.from=function(address,name){if(!address.isEmail())throw new Error(errors.notvalid);var self=this;self.addressFrom.name=name||"";self.addressFrom.address=address;return self};Message.prototype.to=function(address){if(!address.isEmail())throw new Error(errors.notvalid);var self=this;self.addressTo.push(address);return self};Message.prototype.cc=function(address){if(!address.isEmail())throw new Error(errors.notvalid);var self=this;self.addressCC.push(address);return self};Message.prototype.bcc=function(address){if(!address.isEmail())throw new Error(errors.notvalid);var self=this;self.addressBCC.push(address);return self};Message.prototype.reply=function(address){if(!address.isEmail())throw new Error(errors.notvalid);var self=this;self.addressReply.push(address);return self};Message.prototype.attachment=function(filename,name){var self=this;if(name===undefined)name=path.basename(filename);self.files.push({name:name,filename:filename,contentType:framework_utils.getContentType(path.extname(name))});return self};Message.prototype.send=function(smtp,options,fnCallback){var self=this;smtp=smtp||null;if(typeof options==="function"){var tmp=fnCallback;fnCallback=options;options=tmp}self.callback=fnCallback;options=framework_utils.copy(options,{secure:false,port:25,user:"",password:"",timeout:1e4});if(smtp===null||smtp===""){smtp=getHostName(self.addressFrom.address);resolveMx(smtp,function(err,socket){if(err){mailer.emit("error",err,self);if(fnCallback)fnCallback(err);return}socket.on("error",function(err){mailer.emit("error",err,self);if(fnCallback)fnCallback(err)});self._send(socket,options)});return self}var socket;if(options.secure){var internal=framework_utils.copy(options);internal.host=smtp;socket=tls.connect(internal,function(){self._send(this,options)})}else socket=net.createConnection(options.port,smtp);socket.on("error",function(err){mailer.emit("error",err,self)});socket.on("clientError",function(err){mailer.emit("error",err,self)});socket.on("connect",function(){if(!options.secure)self._send(socket,options)});return self};Message.prototype._send=function(socket,options){var self=this;var command="";var buffer=[];var message=[];var host=getHostName(self.addressFrom.address);var date=new Date;var boundary="--totaljs"+date.getTime();var isAuthenticated=false;var isAuthorization=false;var authType="";var auth=[];var err=null;var ending=null;mailer.emit("send",self);socket.setTimeout(options.timeout||5e3,function(){mailer.emit("error",new Error(framework_utils.httpStatus(408)),self);if(socket!==null)socket.destroy();socket=null});socket.setEncoding("utf8");var write=function(line){if(mailer.debug)console.log("SEND",line);socket.write(line+CRLF)};buffer.push("MAIL FROM: <"+self.addressFrom.address+">");message.push("Message-ID: <"+GUID()+"@WIN-"+s4()+">");message.push("MIME-Version: 1.0");message.push("From: "+(self.addressFrom.name.length>0?'"'+self.addressFrom.name+'" '+"<"+self.addressFrom.address+">":self.addressFrom.address));var length=self.addressTo.length;var builder="";if(length>0){for(var i=0;i<length;i++){var mail="<"+self.addressTo[i]+">";buffer.push("RCPT TO: "+mail);builder+=(builder!==""?", ":"")+mail}message.push("To: "+builder);builder=""}length=self.addressCC.length;if(length>0){for(var i=0;i<length;i++){var mail="<"+self.addressCC[i]+">";buffer.push("RCPT TO: "+mail);builder+=(builder!==""?", ":"")+mail}message.push("Cc: "+builder);builder=""}length=self.addressBCC.length;if(length>0){for(var i=0;i<length;i++)buffer.push("RCPT TO: <"+self.addressBCC[i]+">")}buffer.push("DATA");buffer.push("QUIT");buffer.push("");message.push("Date: "+date.toUTCString());message.push("Subject: "+self.subject);length=self.addressReply.length;if(length>0){for(var i=0;i<length;i++)builder+=(builder!==""?", ":"")+"<"+self.addressReply[i]+">";message.push("Reply-To: "+builder);builder=""}message.push("Content-Type: multipart/mixed; boundary="+boundary);message.push("");message.push("--"+boundary);message.push("Content-Type: "+(self.body.indexOf("<")!==-1&&self.body.lastIndexOf(">")!==-1?"text/html":"text/plain")+"; charset=utf-8");message.push("Content-Transfer-Encoding: base64");message.push("");message.push(prepareBASE64(new Buffer(self.body.replace(/\r\n/g,"\n").replace(/\n/g,"\r\n")).toString("base64")));length=self.files.length;if(mailer.debug){socket.on("end",function(){console.log("END")})}socket.on("data",function(data){var response=data.toString().split(CRLF);var length=response.length;for(var i=0;i<length;i++){var line=response[i];if(line==="")continue;if(socket)socket.emit("line",line)}});socket.on("line",function(line){line=line.toUpperCase();if(mailer.debug)console.log("âââ>",line);var code=parseInt(line.match(/\d+/)[0],10);if(code===250&&!isAuthorization){if(line.indexOf("AUTH LOGIN PLAIN")!==-1||line.indexOf("AUTH PLAIN LOGIN")!==-1||options.user&&options.password){authType="plain";isAuthorization=true;if(line.indexOf("XOAUTH")===-1){auth.push("AUTH LOGIN");auth.push(new Buffer(options.user).toString("base64"));auth.push(new Buffer(options.password).toString("base64"))}else auth.push("AUTH PLAIN "+new Buffer("\x00"+options.user+"\x00"+options.password).toString("base64"))}}if(line.substring(3,4)==="-"){return}if(!isAuthenticated&&isAuthorization){isAuthenticated=true;code=334}switch(code){case 220:command=/\besmtp\b/i.test(line)?"EHLO":"HELO";write(command+" "+host);break;case 221:case 250:case 251:case 235:write(buffer.shift());if(buffer.length===0){mailer.emit("success",self);if(self.callback)self.callback(null);ending=setTimeout(function(){if(socket!==null)socket.destroy();socket=null},500)}break;case 334:var value=auth.shift();if(value===undefined){err=new Error("Forbidden.");mailer.emit("error",err,self);if(self.callback)self.callback(err);if(socket!==null)socket.destroy();socket=null;break}write(value);break;case 354:write(message.join(CRLF));if(self.files.length>0){message=null;self._writeAttachment(write,boundary,socket);return}write("--"+boundary+"--");write("");write(".");message=null;break;default:if(code<400)break;err=new Error(line);if(socket!==null)socket.destroy();socket=null;mailer.emit("error",err,self);if(self.callback)self.callback(err);break}})};Message.prototype._writeAttachment=function(write,boundary,socket){var self=this;var attachment=self.files.shift();if(attachment===undefined){write("--"+boundary+"--");write("");write(".");return}var name=attachment.name;var stream=fs.createReadStream(attachment.filename,{encoding:"base64"});var message=[];var ext=path.extname(attachment.filename);message.push("--"+boundary);message.push('Content-Disposition: attachment; filename="'+name+'"');message.push('Content-Type: application/octet-stream; name="'+name+'"');message.push("Content-Transfer-Encoding: base64");message.push(CRLF);write(message.join(CRLF));stream.on("data",function(buf){var length=buf.length;var count=0;var beg=0;while(count<length){count+=68;if(count>length)count=length;write(buf.slice(beg,count).toString("base64"));beg=count}});stream.on("end",function(){write(CRLF);self._writeAttachment(write,boundary,socket)});return self};function prepareBASE64(value){var index=0;var output="";var length=value.length;while(index<length){var max=index+68;if(max>length)max=length;output+=value.substring(index,max)+"\n";index=max}return output}function getHostName(address){return address.substring(address.indexOf("@")+1)}function s4(){return Math.floor((1+Math.random())*65536).toString(16).substring(1).toUpperCase()}function GUID(){return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()}var mailer=new Mailer;module.exports=mailer;return module;})({ exports: {} });(function(module){var exports=module.exports;global.framework_internal=module.exports;
"use strict";var crypto=require("crypto");var fs=require("fs");var ENCODING="utf8";var UNDEFINED="undefined";var FUNCTION="function";var OBJECT="object";var REG_1=/[\n\r\t]+/g;var REG_2=/\s{3,}/g;var HTTPVERBS={GET:true,POST:true,OPTIONS:true,PUT:true,DELETE:true,PATCH:true,upload:true,HEAD:true,TRACE:true,PROPFIND:true};exports.parseMULTIPART=function(req,contentType,maximumSize,tmpDirectory,onXSS,callback){var parser=new MultipartParser;var boundary=contentType.split(";")[1];var isFile=false;var size=0;var stream=null;var tmp={name:"",value:"",contentType:"",fileName:"",fileNameTmp:"",fileSize:0,isFile:false,step:0,width:0,height:0};var ip=req.ip.replace(/\./g,"");var close=0;var isXSS=false;var rm=null;boundary=boundary.substring(boundary.indexOf("=")+1);req.buffer_exceeded=false;req.buffer_has=true;parser.initWithBoundary(boundary);parser.onPartBegin=function(){tmp.value="";tmp.fileSize=0;tmp.step=0;tmp.isFile=false};parser.onHeaderValue=function(buffer,start,end){if(req.buffer_exceeded)return;if(isXSS)return;var arr=buffer.slice(start,end).toString(ENCODING).split(";");if(tmp.step===1){tmp.contentType=arr[0];tmp.step=2;return}if(tmp.step!==0)return;tmp.name=arr[1].substring(arr[1].indexOf("=")+2);tmp.name=tmp.name.substring(0,tmp.name.length-1);tmp.step=1;if(arr.length!==3)return;tmp.fileName=arr[2].substring(arr[2].indexOf("=")+2);tmp.fileName=tmp.fileName.substring(0,tmp.fileName.length-1);tmp.isFile=true;tmp.fileNameTmp=framework_utils.combine(tmpDirectory,ip+"-"+(new Date).getTime()+"-"+framework_utils.random(1e5)+".upload");stream=fs.createWriteStream(tmp.fileNameTmp,{flags:"w"});stream.once("close",function(){close--});stream.once("error",function(){close--});close++};parser.onPartData=function(buffer,start,end){if(req.buffer_exceeded)return;if(isXSS)return;var data=buffer.slice(start,end);var length=data.length;size+=length;if(size>=maximumSize){req.buffer_exceeded=true;if(rm===null)rm=[tmp.fileNameTmp];else rm.push(tmp.fileNameTmp);return}if(!tmp.isFile){tmp.value+=data.toString(ENCODING);return}if(tmp.fileSize===0){var wh=null;switch(tmp.contentType){case"image/jpeg":wh=framework_image.measureJPG(data);break;case"image/gif":wh=framework_image.measureGIF(data);break;case"image/png":wh=framework_image.measurePNG(data);break}if(wh){tmp.width=wh.width;tmp.height=wh.height}}stream.write(data);tmp.fileSize+=length};parser.onPartEnd=function(){if(stream!==null){stream.end();stream=null}if(req.buffer_exceeded)return;if(tmp.isFile){req.files.push(new HttpFile(tmp.name,tmp.fileName,tmp.fileNameTmp,tmp.fileSize,tmp.contentType,tmp.width,tmp.height));return}if(onXSS(tmp.value))isXSS=true;var temporary=req.body[tmp.name];if(temporary===undefined){req.body[tmp.name]=tmp.value;return}if(framework_utils.isArray(temporary)){req.body[tmp.name].push(tmp.value);return}temporary=[temporary];temporary.push(tmp.value);req.body[tmp.name]=temporary};parser.onEnd=function(){var cb=function(){if(close>0){setImmediate(cb);return}if(isXSS){req.flags.push("xss");framework.stats.request.xss++}if(rm!==null)framework.unlink(rm);callback()};cb()};req.on("data",parser.write.bind(parser));req.on("end",parser.end.bind(parser))};exports.parseMULTIPART_MIXED=function(req,contentType,tmpDirectory,onFile,callback){var parser=new MultipartParser;var boundary=contentType.split(";")[1];var stream=null;var tmp={name:"",contentType:"",fileName:"",fileNameTmp:"",fileSize:0,isFile:false,step:0,width:0,height:0};var ip=req.ip.replace(/\./g,"");var close=0;boundary=boundary.substring(boundary.indexOf("=")+1);req.buffer_exceeded=false;req.buffer_has=true;parser.initWithBoundary(boundary);parser.onPartBegin=function(){tmp.fileSize=0;tmp.step=0;tmp.isFile=false};parser.onHeaderValue=function(buffer,start,end){if(req.buffer_exceeded||tmp.step>1)return;var arr=buffer.slice(start,end).toString(ENCODING).split(";");if(tmp.step===1){tmp.contentType=arr[0];tmp.step=2;return}if(tmp.step===0){tmp.name=arr[1].substring(arr[1].indexOf("=")+2);tmp.name=tmp.name.substring(0,tmp.name.length-1);tmp.step=1;if(arr.length!==3)return;tmp.fileName=arr[2].substring(arr[2].indexOf("=")+2);tmp.fileName=tmp.fileName.substring(0,tmp.fileName.length-1);tmp.isFile=true;tmp.fileNameTmp=framework_utils.combine(tmpDirectory,ip+"-"+(new Date).getTime()+"-"+framework_utils.random(1e5)+".upload");stream=fs.createWriteStream(tmp.fileNameTmp,{flags:"w"});stream.on("close",function(){close--});stream.on("error",function(){close--});close++;return}};parser.onPartData=function(buffer,start,end){var data=buffer.slice(start,end);var length=data.length;if(!tmp.isFile)return;if(tmp.fileSize===0){var wh=null;switch(tmp.contentType){case"image/jpeg":wh=framework_image.measureJPG(data);break;case"image/gif":wh=framework_image.measureGIF(data);break;case"image/png":wh=framework_image.measurePNG(data);break}if(wh){tmp.width=wh.width;tmp.height=wh.height}}stream.write(data);tmp.fileSize+=length};parser.onPartEnd=function(){if(stream!==null){stream.end();stream=null}if(!tmp.isFile)return;onFile(new HttpFile(tmp.name,tmp.fileName,tmp.fileNameTmp,tmp.fileSize,tmp.contentType,tmp.width,tmp.height))};parser.onEnd=function(){var cb=function cb(){if(close>0){setImmediate(cb);return}onFile(null);callback()};cb()};req.on("data",parser.write.bind(parser))};exports.routeSplit=function(url,noLower){if(!noLower)url=url.toLowerCase();if(url[0]==="/")url=url.substring(1);if(url[url.length-1]==="/")url=url.substring(0,url.length-1);var arr=url.split("/");if(arr.length===1&&arr[0]==="")arr[0]="/";return arr};exports.routeCompare=function(url,route,isSystem,isAsterix){var length=url.length;if(route.length!==length&&!isAsterix)return false;var skip=length===1&&url[0]==="/";for(var i=0;i<length;i++){var value=route[i];if(!isSystem&&isAsterix&&value===undefined)return true;if(!isSystem&&(!skip&&value[0]==="{"))continue;if(url[i]!==value){if(!isSystem)return isAsterix;return false}}return true};exports.routeCompareSubdomain=function(subdomain,arr){if(arr===null||subdomain===null||arr.length===0)return true;return arr.indexOf(subdomain)>-1};exports.routeCompareFlags=function(arr1,arr2,noLoggedUnlogged){var hasVerb=false;var a1=arr1;var a2=arr2;var l1=arr1.length;var l2=arr2.length;var select=l1>l2?a1:a2;var compare=l1>l2?a2:a1;var length=Math.max(l1,l2);var AUTHORIZE="authorize";var UNAUTHORIZE="unauthorize";for(var i=0;i<length;i++){var value=select[i];var c=value[0];if(c==="!"||c==="#"||c==="$"||c==="@"||c==="+")continue;if(noLoggedUnlogged&&(value===AUTHORIZE||value===UNAUTHORIZE))continue;var index=compare.indexOf(value);var method=value.toUpperCase();if(index===-1&&!HTTPVERBS[method])return value===AUTHORIZE||value===UNAUTHORIZE?-1:0;hasVerb=hasVerb||index!==-1&&HTTPVERBS[method]}return hasVerb?1:0};exports.routeCompareFlags2=function(req,route,noLoggedUnlogged){if(route.isXHR&&!req.xhr)return 0;var method=req.method;if(route.method){if(route.method!==method)return 0}else if(route.flags.indexOf(method.toLowerCase())===-1)return 0;if(route.isREFERER&&req.flags.indexOf("referer")===-1)return 0;for(var i=0,length=req.flags.length;i<length;i++){var flag=req.flags[i];switch(flag){case"proxy":if(!route.isPROXY)return 0;continue;case"debug":if(!route.isDEBUG&&route.isRELEASE)return 0;continue;case"release":if(!route.isRELEASE&&route.isDEBUG)return 0;continue;case"referer":continue;case"upload":if(!route.isUPLOAD)return 0;continue;case"https":if(!route.isHTTPS&&route.isHTTP)return 0;continue;case"http":if(!route.isHTTP&&route.isHTTPS)return 0;continue;case"xhr":case"+xhr":if(!route.isBOTH&&!route.isXHR)return 0;continue}if(noLoggedUnlogged&&route.isMEMBER)continue;var index=route.flags.indexOf(flag);if(index===-1)return!route.isMEMBER?-1:0}return 1};exports.routeParam=function(routeUrl,route){var arr=[];if(!route||!routeUrl)return arr;var length=route.param.length;if(length===0)return arr;for(var i=0;i<length;i++){var value=routeUrl[route.param[i]];arr.push(value==="/"?"":value)}return arr};function HttpFile(name,filename,path,length,contentType,width,height){this.name=name;this.filename=filename;this.length=length;this.contentType=contentType;this.path=path;this.width=width;this.height=height}HttpFile.prototype.copy=function(filename,callback){var self=this;if(!callback){fs.createReadStream(self.path).pipe(fs.createWriteStream(filename));return}var reader=fs.createReadStream(self.path);var writer=fs.createWriteStream(filename);reader.on("close",callback);reader.pipe(writer);return self};HttpFile.prototype.readSync=function(){return fs.readFileSync(this.path)};HttpFile.prototype.read=function(callback){var self=this;fs.readFile(self.path,callback);return self};HttpFile.prototype.md5=function(callback){var self=this;var md5=crypto.createHash("md5");var stream=fs.createReadStream(self.path);stream.on("data",function(buffer){md5.update(buffer)});stream.on("error",function(error){callback(error,null)});stream.on("end",function(){callback(null,md5.digest("hex"))});return self};HttpFile.prototype.stream=function(options){var self=this;return fs.createReadStream(self.path,options)};HttpFile.prototype.pipe=function(stream,options){var self=this;return fs.createReadStream(self.path,options).pipe(stream,options)};HttpFile.prototype.isImage=function(){var self=this;return self.contentType.indexOf("image/")!==-1};HttpFile.prototype.isVideo=function(){var self=this;return self.contentType.indexOf("video/")!==-1};HttpFile.prototype.isAudio=function(){var self=this;return self.contentType.indexOf("audio/")!==-1};HttpFile.prototype.image=function(imageMagick){var im=imageMagick;if(im===undefined)im=framework.config["default-image-converter"]==="im";return framework_image.init(this.path,im)};function compile_autovendor(css){var reg1=/\n|\s{2,}/g;var reg2=/\s?\{\s{1,}/g;var reg3=/\s?\}\s{1,}/g;var reg4=/\s?\:\s{1,}/g;var reg5=/\s?\;\s{1,}/g;var avp="@#auto-vendor-prefix#@";var isAuto=css.startsWith(avp);if(isAuto)css=css.replace(avp,"");else{avp="/*auto*/";isAuto=css.indexOf(avp)!==-1;if(isAuto)css=css.replace(avp,"")}if(isAuto)css=autoprefixer(css);return css.replace(reg1,"").replace(reg2,"{").replace(reg3,"}").replace(reg4,":").replace(reg5,";").replace(/\s\}/g,"}").replace(/\s\{/g,"{").trim()}function autoprefixer(value){var prefix=["appearance","column-count","column-gap","column-rule","display","transform","transform-style","transform-origin","transition","user-select","animation","perspective","animation-name","animation-duration","animation-timing-function","animation-delay","animation-iteration-count","animation-direction","animation-play-state","opacity","background","background-image","font-smoothing","text-size-adjust","backface-visibility","box-sizing"];value=autoprefixer_keyframes(value);var builder=[];var index=0;var property;for(var i=0;i<prefix.length;i++){property=prefix[i];index=0;while(index!==-1){index=value.indexOf(property,index+1);if(index===-1)continue;var a=value.indexOf(";",index);var b=value.indexOf("}",index);var end=Math.min(a,b);if(end===-1)end=Math.max(a,b);if(end===-1)continue;var isPrefix=value.substring(index-1,index)==="-";if(isPrefix)continue;var css=value.substring(index,end);end=css.indexOf(":");if(end===-1)continue;if(css.substring(0,end+1).replace(/\s/g,"")!==property+":")continue;builder.push({name:property,property:css})}}var output=[];var length=builder.length;for(var i=0;i<length;i++){var name=builder[i].name;property=builder[i].property;var plus=property;var delimiter=";";var updated=plus+delimiter;if(name==="opacity"){var opacity=parseFloat(plus.replace("opacity","").replace(":","").replace(/\s/g,""));if(isNaN(opacity))continue;updated+="filter:alpha(opacity="+Math.floor(opacity*100)+");";value=value.replacer(property,"@[["+output.length+"]]");output.push(updated);continue}if(name==="background"||name==="background-image"){if(property.indexOf("linear-gradient")===-1)continue;updated=plus.replacer("linear-","-webkit-linear-")+delimiter;updated+=plus.replacer("linear-","-moz-linear-")+delimiter;updated+=plus.replacer("linear-","-o-linear-")+delimiter;updated+=plus.replacer("linear-","-ms-linear-")+delimiter;updated+=plus+delimiter;value=value.replacer(property,"@[["+output.length+"]]");output.push(updated);continue}if(name==="text-overflow"){updated=plus+delimiter;updated+=plus.replacer("text-overflow","-ms-text-overflow");value=value.replacer(property,"@[["+output.length+"]]");output.push(updated);continue}if(name==="display"){if(property.indexOf("box")===-1)continue;updated=plus+delimiter;updated+=plus.replacer("box","-webkit-box")+delimiter;updated+=plus.replacer("box","-moz-box");value=value.replacer(property,"@[["+output.length+"]]");output.push(updated);continue}updated+="-webkit-"+plus+delimiter;updated+="-moz-"+plus;if(name.indexOf("animation")===-1)updated+=delimiter+"-ms-"+plus;updated+=delimiter+"-o-"+plus;value=value.replacer(property,"@[["+output.length+"]]");output.push(updated)}length=output.length;for(var i=0;i<length;i++)value=value.replacer("@[["+i+"]]",output[i]);output=null;builder=null;prefix=null;return value}function autoprefixer_keyframes(value){var builder=[];var index=0;while(index!==-1){index=value.indexOf("@keyframes",index+1);if(index===-1)continue;var counter=0;var end=-1;for(var indexer=index+10;indexer<value.length;indexer++){if(value[indexer]==="{")counter++;if(value[indexer]!=="}")continue;if(counter>1){counter--;continue}end=indexer;break}if(end===-1)continue;var css=value.substring(index,end+1);builder.push({name:"keyframes",property:css})}var output=[];var length=builder.length;for(var i=0;i<length;i++){var name=builder[i].name;var property=builder[i].property;if(name!=="keyframes")continue;var plus=property.substring(1);var delimiter="\n";var updated="@"+plus+delimiter;updated+="@-webkit-"+plus+delimiter;updated+="@-moz-"+plus+delimiter;updated+="@-o-"+plus+delimiter;value=value.replacer(property,"@[["+output.length+"]]");output.push(updated)}length=output.length;for(var i=0;i<length;i++)value=value.replace("@[["+i+"]]",output[i]);builder=null;output=null;return value}exports.compile_css=function(value,minify){if(framework.onCompileCSS!==null)return framework.onCompileCSS("",value);try{return compile_autovendor(value)}catch(ex){framework.error(new Error("JS CSS exception: "+ex.message));return""}};function JavaScript(source){var EOF=-1;var sb=[];var theA;var theB;var theLookahead=EOF;var index=0;function jsmin(){theA=13;action(3);var indexer=0;while(theA!==EOF){switch(theA){case 32:if(isAlphanum(theB))action(1);else action(2);break;case 13:switch(theB){case 123:case 91:case 40:case 43:case 45:action(1);break;case 32:action(3);break;default:if(isAlphanum(theB))action(1);else action(2);break}break;default:switch(theB){case 32:if(isAlphanum(theA)){action(1);break}action(3);break;case 13:switch(theA){case 125:case 93:case 41:case 43:case 45:case 34:case 92:action(1);break;default:if(isAlphanum(theA))action(1);else action(3);break}break;default:action(1);break}break}}}function action(d){if(d<=1){put(theA)}if(d<=2){theA=theB;if(theA===39||theA===34){for(;;){put(theA);theA=get();if(theA===theB){break}if(theA<=13){c=EOF;return}if(theA===92){put(theA);theA=get()}}}}if(d<=3){theB=next();if(theB===47&&(theA===40||theA===44||theA===61||theA===91||theA===33||theA===58||theA===38||theA===124||theA===63||theA===123||theA===125||theA===59||theA===13)){put(theA);put(theB);for(;;){theA=get();if(theA===47){break}else if(theA===92){put(theA);theA=get()}else if(theA<=13){c=EOF;return}put(theA)}theB=next()}}}function next(){var c=get();if(c!==47)return c;switch(peek()){case 47:for(;;){c=get();if(c<=13)return c}break;case 42:get();for(;;){switch(get()){case 42:if(peek()===47){get();return 32}break;case EOF:c=EOF;return}}break;default:return c}return c}function peek(){theLookahead=get();return theLookahead}function get(){var c=theLookahead;theLookahead=EOF;if(c===EOF){c=source.charCodeAt(index++);if(isNaN(c))c=EOF}if(c>=32||c===13||c===EOF){return c}if(c===10)return 13;return 32}function put(c){if(c===13||c===10)sb.push(" ");else sb.push(String.fromCharCode(c))}function isAlphanum(c){return c>=97&&c<=122||c>=48&&c<=57||c>=65&&c<=90||c===95||c===36||c===92||c>126}jsmin();return sb.join("")}exports.compile_javascript=function(source){var isFramework=typeof framework===OBJECT;try{if(isFramework){if(framework.onCompileJS!==null)return framework.onCompileJS("",source)}return JavaScript(source)}catch(ex){if(isFramework)framework.error(ex,"JavaScript compressor");return source}};exports.compile_html=function(source){return compressHTML(source,true)};var Buffer=require("buffer").Buffer,s=0,S={PARSER_UNINITIALIZED:s++,START:s++,START_BOUNDARY:s++,HEADER_FIELD_START:s++,HEADER_FIELD:s++,HEADER_VALUE_START:s++,HEADER_VALUE:s++,HEADER_VALUE_ALMOST_DONE:s++,HEADERS_ALMOST_DONE:s++,PART_DATA_START:s++,PART_DATA:s++,PART_END:s++,END:s++},f=1,F={PART_BOUNDARY:f,LAST_BOUNDARY:f*=2},LF=10,CR=13,SPACE=32,HYPHEN=45,COLON=58,A=97,Z=122,lower=function(c){return c|32};for(s in S){exports[s]=S[s]}function MultipartParser(){this.boundary=null;this.boundaryChars=null;this.lookbehind=null;this.state=S.PARSER_UNINITIALIZED;this.index=null;this.flags=0}exports.MultipartParser=MultipartParser;MultipartParser.stateToString=function(stateNumber){for(var state in S){var number=S[state];if(number===stateNumber)return state}};MultipartParser.prototype.initWithBoundary=function(str){var self=this;self.boundary=new Buffer(str.length+4);if(framework.versionNode>=1111){self.boundary.write("\r\n--",0,"ascii");self.boundary.write(str,4,"ascii")}else{self.boundary.write("\r\n--","ascii",0);self.boundary.write(str,"ascii",4)}self.lookbehind=new Buffer(self.boundary.length+8);self.state=S.START;self.boundaryChars={};for(var i=0;i<self.boundary.length;i++){self.boundaryChars[self.boundary[i]]=true}};MultipartParser.prototype.write=function(buffer){var self=this,i=0,len=buffer.length,prevIndex=self.index,index=self.index,state=self.state,flags=self.flags,lookbehind=self.lookbehind,boundary=self.boundary,boundaryChars=self.boundaryChars,boundaryLength=self.boundary.length,boundaryEnd=boundaryLength-1,bufferLength=buffer.length,c,cl,mark=function(name){self[name+"Mark"]=i},clear=function(name){delete self[name+"Mark"]},callback=function(name,buffer,start,end){if(start!==undefined&&start===end){return}var callbackSymbol="on"+name.substr(0,1).toUpperCase()+name.substr(1);if(callbackSymbol in self){self[callbackSymbol](buffer,start,end)}},dataCallback=function(name,clear){var markSymbol=name+"Mark";if(!(markSymbol in self)){return}if(!clear){callback(name,buffer,self[markSymbol],buffer.length);self[markSymbol]=0}else{callback(name,buffer,self[markSymbol],i);delete self[markSymbol]}};for(i=0;i<len;i++){c=buffer[i];switch(state){case S.PARSER_UNINITIALIZED:return i;case S.START:index=0;state=S.START_BOUNDARY;case S.START_BOUNDARY:if(index==boundary.length-2){if(c==HYPHEN){flags|=F.LAST_BOUNDARY}else if(c!=CR){return i}index++;break}else if(index-1==boundary.length-2){if(flags&F.LAST_BOUNDARY&&c==HYPHEN){callback("end");state=S.END;flags=0}else if(!(flags&F.LAST_BOUNDARY)&&c==LF){index=0;callback("partBegin");state=S.HEADER_FIELD_START}else{return i}break}if(c!=boundary[index+2]){index=-2}if(c==boundary[index+2]){index++}break;case S.HEADER_FIELD_START:state=S.HEADER_FIELD;mark("headerField");index=0;case S.HEADER_FIELD:if(c==CR){clear("headerField");state=S.HEADERS_ALMOST_DONE;break}index++;if(c==HYPHEN){break}if(c==COLON){if(index==1){return i}dataCallback("headerField",true);state=S.HEADER_VALUE_START;break}cl=lower(c);if(cl<A||cl>Z){return i}break;case S.HEADER_VALUE_START:if(c==SPACE){break}mark("headerValue");state=S.HEADER_VALUE;case S.HEADER_VALUE:if(c==CR){dataCallback("headerValue",true);callback("headerEnd");state=S.HEADER_VALUE_ALMOST_DONE}break;case S.HEADER_VALUE_ALMOST_DONE:if(c!=LF){return i}state=S.HEADER_FIELD_START;break;case S.HEADERS_ALMOST_DONE:if(c!=LF){return i}callback("headersEnd");state=S.PART_DATA_START;break;case S.PART_DATA_START:state=S.PART_DATA;mark("partData");case S.PART_DATA:prevIndex=index;if(index===0){i+=boundaryEnd;while(i<bufferLength&&!(buffer[i]in boundaryChars)){i+=boundaryLength}i-=boundaryEnd;c=buffer[i]}if(index<boundary.length){if(boundary[index]==c){if(index===0){dataCallback("partData",true)}index++}else{index=0}}else if(index==boundary.length){index++;if(c==CR){flags|=F.PART_BOUNDARY}else if(c==HYPHEN){flags|=F.LAST_BOUNDARY}else{index=0}}else if(index-1==boundary.length){if(flags&F.PART_BOUNDARY){index=0;if(c==LF){flags&=~F.PART_BOUNDARY;callback("partEnd");callback("partBegin");state=S.HEADER_FIELD_START;break}}else if(flags&F.LAST_BOUNDARY){if(c==HYPHEN){callback("partEnd");callback("end");state=S.END;flags=0}else{index=0}}else{index=0}}if(index>0){lookbehind[index-1]=c}else if(prevIndex>0){callback("partData",lookbehind,0,prevIndex);prevIndex=0;mark("partData");i--}break;case S.END:break;default:return i}}dataCallback("headerField");dataCallback("headerValue");dataCallback("partData");self.index=index;self.state=state;self.flags=flags;return len};MultipartParser.prototype.end=function(){var self=this;var callback=function(self,name){var callbackSymbol="on"+name.substr(0,1).toUpperCase()+name.substr(1);if(callbackSymbol in self){self[callbackSymbol]()}};if(self.state==S.HEADER_FIELD_START&&self.index===0||self.state==S.PART_DATA&&self.index==self.boundary.length){callback(self,"partEnd");callback(self,"end")}else if(self.state!=S.END){callback(self,"partEnd");callback(self,"end");return new Error("MultipartParser.end(): stream ended unexpectedly: "+self.explain())}};MultipartParser.prototype.explain=function(){return"state = "+MultipartParser.stateToString(this.state)};function View(){}function view_parse(content,minify){content=removeComments(compressCSS(compressJS(content,0),0));var DELIMITER="'";var DELIMITER_UNESCAPE="unescape('";var DELIMITER_UNESCAPE_END="')";var SPACE=" ";var builder="var $EMPTY='';var $length=0;var $source=null;var $tmp=index;var $output=$EMPTY";var command=view_find_command(content,0);var compressed="";function escaper(value){value=compressHTML(value,minify);if(value==="")return"$EMPTY";if(value.match(/\n|\t|\r|\'|\\/)!==null)return DELIMITER_UNESCAPE+escape(value)+DELIMITER_UNESCAPE_END;return DELIMITER+value+DELIMITER}if(command===null)builder+="+"+escaper(content);var old=null;var newCommand="";var tmp="";var index=0;var counter=0;var functions=[];var functionsName=[];var isFN=false;var isSECTION=false;var builderTMP="";var sectionName="";while(command!==null){if(old!==null){var text=content.substring(old.end+1,command.beg);if(text!==""){if(view_parse_plus(builder))builder+="+";builder+=escaper(text)}}else{var text=content.substring(0,command.beg);if(text!==""){if(view_parse_plus(builder))builder+="+";builder+=escaper(text)}}var cmd=content.substring(command.beg+2,command.end);var cmd8=cmd.substring(0,8);if(cmd8==="section "&&cmd.lastIndexOf(")")===-1){builderTMP=builder;builder="+(function(){var $output=$EMPTY";sectionName=cmd.substring(8);isSECTION=true;isFN=true}else if(cmd.substring(0,7)==="helper "){builderTMP=builder;builder="function "+cmd.substring(7).trim()+"{var $output=$EMPTY";isFN=true;functionsName.push(cmd.substring(7,cmd.indexOf("(",7)).trim())}else if(cmd8==="foreach "){counter++;if(cmd.indexOf("foreach var ")!==-1)cmd=cmd.replace(" var ",SPACE);newCommand=(cmd.substring(8,cmd.indexOf(SPACE,8))||"").trim();index=cmd.trim().indexOf(SPACE,newCommand.length+10);builder+="+(function(){var $source="+cmd.substring(index).trim()+";if (!($source instanceof Array) || source.length === 0)return $EMPTY;var $length=$source.length;var $output=$EMPTY;var index=0;for(var i=0;i<$length;i++){index = i;var "+newCommand+"=$source[i];$output+=$EMPTY"}else if(cmd==="end"){if(isFN&&counter<=0){counter=0;if(isSECTION){builder=builderTMP+builder+";repository['$section_"+sectionName+"']=$output;return $EMPTY})()";builderTMP=""}else{builder+=";return $output;}";functions.push(builder);builder=builderTMP;builderTMP=""}isSECTION=false;isFN=false}else{counter--;builder+="}return $output;})()";newCommand=""}}else if(cmd.substring(0,3)==="if "){builder+=";if ("+cmd.substring(3)+"){$output+=$EMPTY"}else if(cmd==="else"){builder+="} else {$output+=$EMPTY"}else if(cmd==="endif"){builder+="}$output+=$EMPTY"}else{tmp=view_prepare(command.command,newCommand,functionsName);if(tmp.length>0){if(view_parse_plus(builder))builder+="+";builder+=tmp}}old=command;command=view_find_command(content,command.end)}if(old!==null){var text=content.substring(old.end+1);if(text.length>0)builder+="+"+escaper(text)}var fn="(function(self,repository,model,session,get,post,url,global,helpers,user,config,functions,index,sitemap,output,date){"+(functions.length>0?functions.join("")+";":"")+"var controller=self;"+builder+";return $output;})";return eval(fn)}function view_parse_plus(builder){var c=builder[builder.length-1];if(c!=="!"&&c!=="?"&&c!=="+"&&c!=="."&&c!==":")return true;return false}function view_prepare(command,dynamicCommand,functions){var a=command.indexOf(".");var b=command.indexOf("(");var c=command.indexOf("[");var max=[];var tmp=0;if(a!==-1)max.push(a);if(b!==-1)max.push(b);if(c!==-1)max.push(c);var index=Math.min.apply(this,max);if(index===-1)index=command.length;var name=command.substring(0,index);if(name===dynamicCommand)return"("+command+").toString().encode()";if(name[0]==="!"&&name.substring(1)===dynamicCommand)return"("+command.substring(1)+").toString()";switch(name){case"foreach":case"end":return"";case"section":tmp=command.indexOf("(");if(tmp===-1)return"";return"(repository['$section_"+command.substring(tmp+1,command.length-1).replace(/\'/g,"")+"'] || '')";case"log":case"LOG":return"("+(name==="log"?"framework.":"")+command+"?$EMPTY:$EMPTY)";case"console":return"("+command+"?$EMPTY:$EMPTY)";case"model":case"repository":case"get":case"post":case"query":case"global":case"session":case"user":case"config":case"controller":if(view_is_assign(command))return"self.$set("+command+")";return"("+command+").toString().encode()";case"body":if(view_is_assign(command))return"self.$set("+command+")";if(command.lastIndexOf(".")===-1)return"output";return"("+command+").toString().encode()";case"CONFIG":case"FUNCTION":case"MODEL":case"SCHEMA":case"MODULE":case"functions":return"("+command+").toString().encode()";case"!controller":case"!repository":case"!get":case"!post":case"!body":case"!query":case"!global":case"!session":case"!user":case"!config":case"!functions":case"!model":case"!CONFIG":case"!SCHEMA":case"!FUNCTION":case"!MODEL":case"!MODULE":return"("+command.substring(1)+")";case"resource":case"RESOURCE":return"(self."+command+").toString().encode()";case"!resource":case"!RESOURCE":return"(self."+command.substring(1)+")";case"host":case"hostname":if(command.indexOf("(")===-1)return"self.host()";return"self."+command;case"url":if(command.indexOf("(")!==-1)return"self.$"+command;return command="url";case"title":case"description":case"keywords":if(command.indexOf("(")!==-1)return"self.$"+command;return"(repository['$"+command+"'] || '').toString().encode()";case"!title":case"!description":case"!keywords":return"(repository['$"+command.substring(1)+"'] || '')";case"head":if(command.indexOf("(")!==-1)return"self.$"+command;return"self."+command+"()";case"sitemap":case"place":if(command.indexOf("(")!==-1)return"self.$"+command;return"(repository['$"+command+"'] || '')";case"meta":if(command.indexOf("(")!==-1)return"self.$"+command;return"self.$meta()";case"js":case"script":case"css":case"favicon":return"self.$"+command+(command.indexOf("(")===-1?"()":"");case"index":return"("+command+")";case"routeJS":case"routeCSS":case"routeImage":case"routeFont":case"routeDownload":case"routeVideo":case"routeStatic":return"self."+command;case"json":case"image":case"layout":case"template":case"templateToggle":case"view":case"viewToggle":case"helper":case"download":case"selected":case"currentContent":case"currentCSS":case"currentDownload":case"currentImage":case"currentJS":case"currentTemplate":case"currentVideo":case"currentView":case"disabled":case"checked":case"etag":case"header":case"modified":case"options":case"readonly":case"canonical":case"dns":case"next":case"prefetch":case"prerender":case"prev":return"self.$"+command;case"radio":case"text":case"checkbox":case"hidden":case"textarea":case"password":return"self.$"+exports.appendModel(command);default:if(framework.helpers[name])return"helpers."+view_insert_call(command);return functions.indexOf(name)===-1?command[0]==="!"?command.substring(1)+".toString()":command+".toString().encode()":command+".toString()"}return command}function view_insert_call(command){var beg=command.indexOf("(");if(beg===-1)return command;var length=command.length;var count=0;for(var i=beg+1;i<length;i++){var c=command[i];if(c!=="("&&c!==")")continue;if(c==="("){count++;continue}if(count>0){count--;continue}var arg=command.substring(beg+1);return command.substring(0,beg)+".call(self"+(arg.length>1?","+arg:")")}return command}function view_is_assign(value){var length=value.length;var skip=0;var plus=0;for(var i=0;i<length;i++){var c=value[i];if(c==="["){skip++;continue}if(c==="]"){skip--;continue}var next=value[i+1]||"";if(c==="+"&&(next==="+"||next==="=")){if(skip===0)return true}if(c==="-"&&(next==="-"||next==="=")){if(skip===0)return true}if(c==="*"&&(next==="*"||next==="=")){if(skip===0)return true}if(c==="="){if(skip===0)return true}}return false}function view_find_command(content,index){var index=content.indexOf("@{",index);if(index===-1)return null;var length=content.length;var count=0;for(var i=index+2;i<length;i++){var c=content[i];if(c==="{"){count++;continue}if(c!=="}")continue;else{if(count>0){count--;continue}}return{beg:index,end:i,command:content.substring(index+2,i).trim()}}return null}function removeCondition(text,beg){if(beg){if(text[0]==="+")return text.substring(1,text.length)}else{if(text[text.length-1]==="+")return text.substring(0,text.length-1)}return text}function removeComments(html){var tagBeg="<!--";var tagEnd="-->";var beg=html.indexOf(tagBeg);var end=0;while(beg!==-1){end=html.indexOf(tagEnd,beg+4);if(end===-1)break;var comment=html.substring(beg,end+3);if(comment.indexOf("[if")!==-1||comment.indexOf("[endif")!==-1){beg=html.indexOf(tagBeg,end+3);continue}html=html.replacer(comment,"");beg=html.indexOf(tagBeg,end+3)}return html}function compressJS(html,index){var strFrom='<script type="text/javascript">';var strTo="</script>";var indexBeg=html.indexOf(strFrom,index||0);if(indexBeg===-1){strFrom="<script>";indexBeg=html.indexOf(strFrom,index||0);if(indexBeg===-1)return html}var indexEnd=html.indexOf(strTo,indexBeg+strFrom.length);if(indexEnd===-1)return html;var js=html.substring(indexBeg,indexEnd+strTo.length).trim();var beg=html.indexOf(js);if(beg===-1)return html;var val=js.substring(strFrom.length,js.length-strTo.length).trim();var compiled=exports.compile_javascript(val);html=html.replacer(js,strFrom+compiled.dollar().trim()+strTo.trim());return compressJS(html,indexBeg+compiled.length+9)}function compressCSS(html,index){var strFrom='<style type="text/css">';var strTo="</style>";var indexBeg=html.indexOf(strFrom,index||0);if(indexBeg===-1){strFrom="<style>";indexBeg=html.indexOf(strFrom,index||0);if(indexBeg===-1)return html}var indexEnd=html.indexOf(strTo,indexBeg+strFrom.length);if(indexEnd===-1)return html;var css=html.substring(indexBeg,indexEnd+strTo.length);var val=css.substring(strFrom.length,css.length-strTo.length).trim();var compiled=exports.compile_css(val,true);html=html.replacer(css,(strFrom+compiled.trim()+strTo).trim());return compressCSS(html,indexBeg+compiled.length+8)}function compressHTML(html,minify){if(html===null||html===""||!minify)return html;html=removeComments(html);var tags=["script","textarea","pre","code"];var id="["+(new Date).getTime()+"]#";var cache={};var indexer=0;var length=tags.length;for(var i=0;i<length;i++){var o=tags[i];var tagBeg="<"+o;var tagEnd="</"+o;var beg=html.indexOf(tagBeg);var end=0;var len=tagEnd.length;while(beg!==-1){end=html.indexOf(tagEnd,beg+3);if(end===-1)break;
var key=id+indexer++;var value=html.substring(beg,end+len);if(i===0){end=value.indexOf(">");len=value.indexOf('type="text/template"');if(len<end&&len!==-1)break;len=value.indexOf('type="text/html"');if(len<end&&len!==-1)break;len=value.indexOf('type="text/ng-template"');if(len<end&&len!==-1)break}cache[key]=value;html=html.replacer(value,key);beg=html.indexOf(tagBeg,beg+tagBeg.length)}}html=html.replace(REG_1,"").replace(REG_2,"");var keys=Object.keys(cache);length=keys.length;for(var i=0;i<length;i++){var key=keys[i];html=html.replacer(key,cache[key])}return html}View.prototype.read=function(path){var self=this;var config=framework.config;var isOut=path[0]===".";var filename=isOut?path.substring(1):framework_utils.combine(config["directory-views"],path);if(fs.existsSync(filename))return view_parse(fs.readFileSync(filename).toString("utf8"),config["allow-compile-html"]);if(isOut)return null;var index=path.lastIndexOf("/");if(index===-1)return null;filename=framework_utils.combine(config["directory-views"],path.substring(index+1));if(fs.existsSync(filename))return view_parse(fs.readFileSync(filename).toString("utf8"),config["allow-compile-html"]);return null};View.prototype.load=function(name,filename){var self=this;if(name.indexOf("@{")!==-1||name.indexOf("<")!==-1)return self.dynamic(name);var precompiled=framework.routes.views[name];if(precompiled)filename="."+precompiled.filename;else filename+=".html";var key="view#"+filename;var generator=framework.temporary.views[key]||null;if(generator!==null)return generator;generator=self.read(filename);if(!framework.isDebug)framework.temporary.views[key]=generator;return generator};View.prototype.dynamic=function(content){var self=this;var key=content.md5();var generator=framework.temporary.views[key]||null;if(generator!==null)return generator;generator=view_parse(content,framework.config["allow-compile-html"]);if(!framework.isDebug)framework.temporary.views[key]=generator;return generator};exports.generateView=function(name,plus){return(new View).load(name,plus)};exports.appendModel=function(str){var index=str.indexOf("(");if(index===-1)return str;var end=str.substring(index+1);return str.substring(0,index)+"(model"+(end[0]===")"?end:","+end)};return module;})({ exports: {} });"use strict";var qs=require("querystring");var os=require("os");var fs=require("fs");var zlib=require("zlib");var path=require("path");var crypto=require("crypto");var parser=require("url");var events=require("events");var sys=require("sys");var http=require("http");var directory=process.cwd();var child=require("child_process");var util=require("util");var ENCODING="utf8";var UNDEFINED="undefined";var STRING="string";var TYPE_FUNCTION="function";var NUMBER="number";var OBJECT="object";var BOOLEAN="boolean";var REQUEST_COMPRESS_EXTENSION=["js","css","txt"];var EXTENSION_JS=".js";var EXTENSION_COFFEE=".coffee";var RESPONSE_HEADER_CACHECONTROL="Cache-Control";var RESPONSE_HEADER_CONTENTTYPE="Content-Type";var RESPONSE_HEADER_CONTENTLENGTH="Content-Length";var CONTENTTYPE_TEXTPLAIN="text/plain";var CONTENTTYPE_TEXTHTML="text/html";var REQUEST_COMPRESS_CONTENTTYPE=[CONTENTTYPE_TEXTPLAIN,"text/javascript","text/css","application/x-javascript",CONTENTTYPE_TEXTHTML];var _controller="";var _test="";if(!global.framework_internal)global.framework_internal=require("./internal");if(!global.framework_builders)global.framework_builders=require("./builders");if(!global.framework_utils)global.framework_utils=require("./utils");if(!global.framework_mail)global.framework_mail=require("./mail");if(!global.framework_image)global.framework_image=require("./image");if(!global.framework_nosql)global.framework_nosql=require("./nosql");global.Builders=global.builders=framework_builders;var utils=global.Utils=global.utils=framework_utils;global.Mail=global.MAIL=framework_mail;global.include=global.INCLUDE=global.source=global.SOURCE=function(name,options){return framework.source(name,options)};global.MODULE=function(name){return framework.module(name)};global.DATABASE=function(){if(typeof framework.database===OBJECT)return framework.database;return framework.database.apply(framework,arguments)};global.CONFIG=function(name){return framework.config[name]};global.INSTALL=function(type,name,declaration,options,callback){return framework.install(type,name,declaration,options,callback)};global.UNINSTALL=function(type,name,options){return framework.uninstall(type,name,options)};global.RESOURCE=function(name,key){return framework.resource(name,key)};global.LOG=function(){return framework.log.apply(framework,arguments)};global.MODEL=function(name){return framework.model(name)};global.SCHEMA=function(name){return Builders.schema(name)};global.FUNCTION=function(name){return framework.functions[name]};if(typeof setImmediate===UNDEFINED){global.setImmediate=function(cb){process.nextTick(cb)}}function Framework(){this.id=null;this.version=1700;this.version_header="1.7.0";this.versionNode=parseInt(process.version.replace("v","").replace(/\./g,""),10);this.config={debug:false,name:"total.js",version:"1.01",author:"",secret:os.hostname()+"-"+os.platform()+"-"+os.arch(),"etag-version":"","directory-controllers":"/controllers/","directory-views":"/views/","directory-definitions":"/definitions/","directory-temp":"/tmp/","directory-models":"/models/","directory-resources":"/resources/","directory-public":"/public/","directory-public-virtual":"/app/","directory-modules":"/modules/","directory-source":"/source/","directory-logs":"/logs/","directory-tests":"/tests/","directory-databases":"/databases/","directory-workers":"/workers/","static-url":"","static-url-js":"/js/","static-url-css":"/css/","static-url-image":"/img/","static-url-video":"/video/","static-url-font":"/font/","static-url-download":"/download/","static-accepts":[".jpg",".png",".gif",".ico",EXTENSION_JS,EXTENSION_COFFEE,".css",".txt",".xml",".woff",".otf",".ttf",".eot",".svg",".zip",".rar",".pdf",".docx",".xlsx",".doc",".xls",".html",".htm",".appcache",".map",".ogg",".mp4",".mp3",".webp",".webm",".swf",".package",".json"],"default-layout":"_layout","default-request-length":5,"default-websocket-request-length":5,"default-websocket-encodedecode":true,"default-request-timeout":3e3,"default-image-converter":"gm","default-image-quality":93,"allow-gzip":true,"allow-websocket":true,"allow-compile-js":true,"allow-compile-css":true,"allow-compile-html":true,"allow-performance":false,"allow-custom-titles":false,"disable-strict-server-certificate-validation":true,"default-interval-clear-resources":20,"default-interval-clear-cache":3,"default-interval-precompile-views":61,"default-interval-websocket-ping":1};this.global={};this.resources={};this.connections={};this.functions={};this.versions=null;this.isDebug=true;this.isTest=false;this.isLoaded=false;this.routes={web:[],files:[],websockets:[],middleware:{},redirects:{},resize:{},request:[],views:{},merge:{}};this.helpers={};this.modules={};this.models={};this.sources={};this.controllers={};this.tests=[];this.errors=[];this.problems=[];this.changes=[];this.server=null;this.port=0;this.ip="";this.workers={};this.databases={};this.directory=directory;this.isLE=os.endianness?os.endianness()==="LE":true;this.isHTTPS=false;this.temporary={path:{},processing:{},range:{},views:{},dependencies:{}};this.stats={request:{pending:0,web:0,xhr:0,file:0,websocket:0,get:0,post:0,put:0,upload:0,xss:0,blocked:0,"delete":0},response:{view:0,json:0,websocket:0,timeout:0,custom:0,binary:0,pipe:0,file:0,destroy:0,stream:0,streaming:0,plain:0,empty:0,redirect:0,forward:0,restriction:0,notModified:0,mmr:0,sse:0,error400:0,error401:0,error403:0,error404:0,error408:0,error431:0,error500:0,error501:0}};this.cache=new FrameworkCache(this);this.fs=new FrameworkFileSystem(this);this.path=new FrameworkPath(this);this.restrictions=new FrameworkRestrictions(this);this._request_check_redirect=false;this._request_check_referer=false;this._request_check_POST=false;this._length_middleware=0;this._length_request_middleware=0;this._length_files=0;this.isVirtualDirectory=false;this.isCoffee=false;this.isWindows=os.platform().substring(0,3).toLowerCase()==="win"}Framework.prototype={get async(){var self=this;if(typeof self._async===UNDEFINED)self._async=new utils.Async(self);return self._async}};Framework.prototype.__proto__=new events.EventEmitter;Framework.prototype.refresh=function(clear){var self=this;self.emit("clear","refresh");self.resources={};self.databases={};self._configure();self._configure_versions();self.temporary.path={};self.temporary.range={};self.temporary.views={};self.emit("reconfigure");if(clear||true)self.clear();return self};Framework.prototype._install=function(type,name,declaration){var self=this;var obj=null;_controller="TMP"+Utils.random(1e4);if(typeof declaration!==TYPE_FUNCTION){var filename=path.join(directory,self.config["directory-"+type+"s"],name)+EXTENSION_JS;obj=require(filename)}else obj=declaration();if(obj===null)return self;if(obj.name)name=obj.name;if(obj.install)obj.install.call(self,self,{},name);var id=(type==="module"?"#":"")+name;var length=0;length=self.routes.web.length;for(var i=0;i<length;i++){if(self.routes.web[i].name===_controller)self.routes.web[i].name=id}length=self.routes.websockets.length;for(var i=0;i<length;i++){if(self.routes.websockets[i].name===_controller)self.routes.websockets[i].name=id}length=self.routes.files.length;for(var i=0;i<length;i++){if(self.routes.files[i].name===_controller)self.routes.files[i].name=id}if(type==="module")self.modules[name]=obj;else self.controllers[name]=obj;_controller="";return self};Framework.prototype.controller=function(name){return this.controllers[name]||null};Framework.prototype._routesSort=function(){var self=this;self.routes.web.sort(function(a,b){if(a.priority>b.priority)return-1;if(a.priority<b.priority)return 1;return 0});self.routes.websockets.sort(function(a,b){if(a.priority>b.priority)return-1;if(a.priority<b.priority)return 1;return 0});return self};Framework.prototype.database=function(name){var self=this;var db=self.databases[name];if(db!==undefined)return db;self._verify_directory("databases");db=framework_nosql.load(path.join(directory,this.config["directory-databases"],name),path.join(directory,this.config["directory-databases"],name+"-binary"),true);self.databases[name]=db;return db};Framework.prototype.stop=function(code){var self=this;if(typeof process.send===TYPE_FUNCTION)process.send("stop");self.cache.stop();self.server.close();process.exit(code||0);return self};Framework.prototype.redirect=function(host,newHost,withPath,permanent){var self=this;if(host[host.length-1]==="/")host=host.substring(0,host.length-1);if(newHost[newHost.length-1]==="/")newHost=newHost.substring(0,newHost.length-1);self.routes.redirects[host]={url:newHost,path:withPath,permanent:permanent};self._request_check_redirect=true;return self};Framework.prototype.resize=function(url,width,height,options,path,extensions){var self=this;var extension=null;var index=url.lastIndexOf(".");if(index!==-1)extension=[url.substring(index)];else extension=extensions||[".jpg",".png",".gif"];var length=extension.length;for(var i=0;i<length;i++)extension[i]=(extension[i][0]!=="."?".":"")+extension[i].toLowerCase();index=url.lastIndexOf("/");if(index!==-1)url=url.substring(0,index);if(url[0]!=="/")url="/"+url;if(url[url.length-1]!=="/")url+="/";path=path||url;if(!options)options={};self.routes.resize[url]={width:width,height:height,extension:extension,path:path||url,grayscale:options.grayscale,blur:options.blur,rotate:options.rotate,flip:options.flip,flop:options.flop,sepia:options.sepia,quality:options.quality};return self};Framework.prototype.route=function(url,funcExecute,flags,maximumSize,middleware,timeout,options){if(url==="")url="/";if(utils.isArray(maximumSize)){var tmp=middleware;middleware=maximumSize;maximumSize=tmp}if(typeof funcExecute===OBJECT||funcExecute instanceof Array){var tmp=funcExecute;funcExecute=flags;flags=tmp}if(!utils.isArray(flags)&&typeof flags==="object"){maximumSize=flags["max"]||flags["length"]||flags["maximum"]||flags["maximumSize"]||flags["size"];middleware=flags["middleware"]||flags["partials"]||flags["partial"];timeout=flags["timeout"];options=flags["options"];flags=flags["flags"]||flags["flag"]}var self=this;var priority=0;var index=url.indexOf("]");var subdomain=null;var isASTERIX=url.indexOf("*")!==-1;priority=url.count("/");if(isASTERIX){url=url.replace("*","").replace("//","/");priority=-10-priority}if(index>0){subdomain=url.substring(1,index).trim().toLowerCase().split(",");url=url.substring(index+1);priority+=2}var isRaw=false;var isNOXHR=false;var method="";if(flags){var tmp=[];var count=0;for(var i=0;i<flags.length;i++){if(flags[i][0]==="#"){if((middleware||null)===null)middleware=[];middleware.push(flags[i].substring(1));continue}count++;var flag=flags[i].toString().toLowerCase();switch(flag){case"noxhr":case"-xhr":isNOXHR=true;continue;case"raw":isRaw=true;break;case"authorize":priority+=2;tmp.push("authorize");break;case"unauthorize":priority+=2;tmp.push("unauthorize");break;case"logged":priority+=2;tmp.push("authorize");console.log('OBSOLETE: flag "logged" - use "authorize".');break;case"unlogged":tmp.push("unauthorize");console.log('OBSOLETE: flag "unlogged" - use "unauthorize".');break;case"referer":case"referrer":tmp.push("referer");break;case"delete":case"get":case"head":case"options":case"patch":case"post":case"propfind":case"put":case"trace":tmp.push(flag);method+=(method.length>0?",":"")+flag;break;default:tmp.push(flag);break}}flags=tmp;priority+=count*2}else{flags=["get"];method="get"}var isMixed=flags.indexOf("mmr")!==-1;if(isMixed&&url.indexOf("{")!==-1)throw new Error("Mixed route cannot contain dynamic path.");if(isMixed&&flags.indexOf("upload")!==-1)throw new Error("Multipart mishmash: mmr vs. upload.");var isMember=false;if(flags.indexOf("logged")===-1&&flags.indexOf("authorize")===-1&&flags.indexOf("unauthorize")===-1&&flags.indexOf("unlogged")===-1)isMember=true;var routeURL=framework_internal.routeSplit(url.trim());var arr=[];if(url.indexOf("{")!==-1){routeURL.forEach(function(o,i){if(o.substring(0,1)==="{")arr.push(i)});priority-=arr.length}if(url.indexOf("#")!==-1)priority-=100;if(flags.indexOf("proxy")!==-1&&flags.indexOf("json")===-1){flags.push("json");priority++}if((flags.indexOf("json")!==-1||flags.indexOf("xml")!==-1||isRaw)&&(flags.indexOf("post")===-1&&flags.indexOf("put")===-1)&&flags.indexOf("patch")===-1){flags.push("post");method+=(method.length>0?",":"")+"post";priority++}if(isMixed){if(flags.indexOf("post")===-1&&flags.indexOf("put")===-1&&flags.indexOf("upload")===-1){flags.push("upload");priority++}}if(flags.indexOf("upload")!==-1){if(flags.indexOf("post")===-1&&flag.indexOf("put")===-1){flags.push("post");method+=(method.length>0?",":"")+"post"}}if(flags.indexOf("get")===-1&&flags.indexOf("options")===-1&&flags.indexOf("post")===-1&&flags.indexOf("delete")===-1&&flags.indexOf("put")===-1&&flags.indexOf("upload")===-1&&flags.indexOf("head")===-1&&flags.indexOf("trace")===-1&&flags.indexOf("patch")===-1&&flags.indexOf("propfind")===-1){flags.push("get");method+=(method.length>0?",":"")+"get"}if(flags.indexOf("referer")!==-1)self._request_check_referer=true;if(!self._request_check_POST&&(flags.indexOf("post")!==-1||flags.indexOf("put")!==-1||flags.indexOf("upload")!==-1||flags.indexOf("mmr")!==-1||flags.indexOf("json")!==-1||flags.indexOf("patch")!==-1||flags.indexOf("options")!==-1))self._request_check_POST=true;if(!(middleware instanceof Array))middleware=null;if(method.indexOf(",")!==-1||method==="")method=undefined;else method=method.toUpperCase();self.routes.web.push({priority:priority,subdomain:subdomain,name:(_controller||"").length===0?"unknown":_controller,url:routeURL,param:arr,flags:flags||[],method:method,onExecute:funcExecute,maximumSize:(maximumSize||self.config["default-request-length"])*1024,middleware:middleware,timeout:timeout===undefined?self.config["default-request-timeout"]:timeout,isJSON:flags.indexOf("json")!==-1,isXML:flags.indexOf("xml")!==-1,isRAW:isRaw,isMEMBER:isMember,isXSS:flags.indexOf("xss")!==-1,isASTERIX:isASTERIX,isREFERER:flags.indexOf("referer")!==-1,isHTTPS:flags.indexOf("https")!==-1,isHTTP:flags.indexOf("http")!==-1,isDEBUG:flags.indexOf("debug")!==-1,isRELEASE:flags.indexOf("release")!==-1,isPROXY:flags.indexOf("proxy")!==-1,isBOTH:isNOXHR?false:true,isXHR:flags.indexOf("xhr")!==-1,isUPLOAD:flags.indexOf("upload")!==-1,options:options});self.emit("route-add","web",self.routes.web[self.routes.web.length-1]);if(_controller.length===0)self._routesSort();return self};Framework.prototype.merge=function(url){var arr=[];var self=this;for(var i=1,length=arguments.length;i<length;i++){var items=arguments[i];if(!(items instanceof Array))items=[items];for(var j=0,lengthsub=items.length;j<lengthsub;j++)arr.push(items[j])}if(url[0]!=="/")url="/"+url;var filename=self.path.temp("merge-"+url.substring(1).replace(/\//g,"-"));self.routes.merge[url]={filename:filename,files:arr};return self};Framework.prototype.middleware=function(name,funcExecute){var self=this;self.install("middleware",name,funcExecute);return self};Framework.prototype.use=function(name){var self=this;if(arguments.length>0){for(var i=0;i<arguments.length;i++)self.routes.request.push(arguments[i])}else if(name instanceof Array){for(var i=0;i<name.length;i++)self.routes.request.push(name[i])}else self.routes.request.push(name);self._length_request_middleware=self.routes.request.length;return self};Framework.prototype.partial=function(name,funcExecute){console.log("OBSOLETE: framework.partial(), use: framework.middleware()");return this.middleware(name,funcExecute)};Framework.prototype.websocket=function(url,funcInitialize,flags,protocols,allow,maximumSize,middleware,options){if(url==="")url="/";if(utils.isArray(maximumSize)){var tmp=middleware;middleware=maximumSize;maximumSize=tmp}if(typeof funcExecute===OBJECT){var tmp=flags;funcExecute=flags;flags=tmp}if(!(flags instanceof Array)&&typeof flags===OBJECT){protocols=flags["protocols"]||flags["protocol"];allow=flags["allow"]||flags["origin"];maximumSize=flags["max"]||flags["length"]||flags["maximum"]||flags["maximumSize"];middleware=flags["middleware"];options=flags["options"];flags=flags["flags"]}if(middleware===undefined)middleware=null;var self=this;var priority=0;var index=url.indexOf("]");var subdomain=null;var isASTERIX=url.indexOf("*")!==-1;priority=url.count("/");if(index>0){subdomain=url.substring(1,index).trim().toLowerCase().split(",");url=url.substring(index+1);priority+=2}if(isASTERIX){url=url.replace("*","").replace("//","/");priority=-10-priority}var arr=[];var routeURL=framework_internal.routeSplit(url.trim());if(url.indexOf("{")!==-1){routeURL.forEach(function(o,i){if(o.substring(0,1)==="{")arr.push(i)});priority-=arr.length}if(typeof allow===STRING)allow=allow[allow];if(typeof protocols===STRING)protocols=protocols[protocols];if(typeof flags===STRING)flags=flags[flags];var isJSON=false;var isBINARY=false;var tmp=[];var count=0;if(flags===undefined)flags=[];for(var i=0;i<flags.length;i++){if(flags[i][0]==="#"){if((middleware||null)===null)middleware=[];middleware.push(flags[i].substring(1));continue}flags[i]=flags[i].toString().toLowerCase();count++;if(flags[i]==="json")isJSON=true;if(flags[i]==="binary")isBINARY=true;if(flags[i]==="raw"){isBINARY=false;isJSON=false}if(flags[i]!=="json"&&flags[i]!=="binary"&&flags[i]!=="raw")tmp.push(flags[i])}flags=tmp;if(flags.indexOf("get")===-1)flags.unshift("get");priority+=count*2;var isMember=false;if(!flags||flags.indexOf("authorize")===-1)isMember=true;self.routes.websockets.push({name:(_controller||"").length===0?"unknown":_controller,url:routeURL,param:arr,subdomain:subdomain,priority:priority,flags:flags||[],onInitialize:funcInitialize,protocols:protocols||[],allow:allow||[],length:(maximumSize||self.config["default-websocket-request-length"])*1024,isMEMBER:isMember,isJSON:isJSON,isBINARY:isBINARY,isASTERIX:isASTERIX,isHTTPS:flags.indexOf("https"),isHTTP:flags.indexOf("http"),isDEBUG:flags.indexOf("debug"),isRELEASE:flags.indexOf("release"),middleware:middleware,options:options});self.emit("route-add","websocket",self.routes.websockets[self.routes.websockets.length-1]);if(_controller.length===0)self._routesSort();return self};Framework.prototype.file=function(name,fnValidation,fnExecute,middleware,options){var self=this;if(utils.isArray(fnValidation)){var a=fnExecute;var b=middleware;middleware=fnValidation;fnValidation=a;fnExecute=b}else if(utils.isArray(fnExecute)){var a=fnExecute;fnExecute=middleware;middleware=a}if(middleware===undefined)middleware=null;self.routes.files.push({controller:(_controller||"").length===0?"unknown":_controller,name:name,onValidation:fnValidation,onExecute:fnExecute||fnValidation,middleware:middleware,options:options});self.emit("route-add","file",self.routes.files[self.routes.files.length-1]);self._length_files++;return self};Framework.prototype.error=function(err,name,uri){if(err===undefined){return function(err){if(err)framework.error(err,name,uri)}}var self=this;if(self.errors!==null){self.errors.push({error:err,name:name,uri:uri,date:new Date});if(self.errors.length>50)self.errors.shift()}self.onError(err,name,uri);return self};Framework.prototype.problem=function(message,name,uri,ip){var self=this;if(self.problems!==null){self.problems.push({message:message,name:name,uri:uri,ip:ip});if(self.problems.length>50)self.problems.shift()}self.emit("problem",message,name,uri,ip);return self};Framework.prototype.change=function(message,name,uri,ip){var self=this;if(self.changes!==null){self.changes.push({message:message,name:name,uri:uri,ip:ip});if(self.changes.length>50)self.changes.shift()}self.emit("change",message,name,uri,ip);return self};Framework.prototype.module=function(name){return this.modules[name]||null};Framework.prototype.load=function(){var self=this;var dir=path.join(directory,self.config["directory-controllers"]);var framework=self;var arr=[];function listing(directory,level,output){if(!fs.existsSync(dir))return;fs.readdirSync(directory).forEach(function(o){var isDirectory=fs.statSync(path.join(directory,o)).isDirectory();if(isDirectory){level++;listing(path.join(directory,o),level,output);return}var ext=path.extname(o).toLowerCase();if(ext!==EXTENSION_JS)return;var name=(level>0?directory.replace(dir,"")+"/":"")+o.substring(0,o.length-ext.length);output.push({name:name[0]==="/"?name.substring(1):name,filename:path.join(dir,name)+EXTENSION_JS})})}arr=[];listing(dir,0,arr);arr.forEach(function(item){self.install("controller",item.name,item.filename,undefined,undefined,undefined,true)});dir=path.join(directory,self.config["directory-modules"]);if(fs.existsSync(dir)){fs.readdirSync(dir).forEach(function(o){var ext=path.extname(o);var extLower=ext.toLowerCase();if(extLower!==EXTENSION_JS)return;var filename=path.join(directory,self.config["directory-modules"],o);self.install("module",o.replace(ext,""),filename,undefined,undefined,undefined,true)})}dir=path.join(directory,self.config["directory-definitions"]);arr=[];listing(dir,0,arr);arr.forEach(function(item){self.install("definition",item.name,item.filename,undefined,undefined,undefined,true)});dir=path.join(directory,self.config["directory-models"]);arr=[];listing(dir,0,arr);arr.forEach(function(item){self.install("model",item.name,item.filename,undefined,undefined,undefined,true)});self._routesSort();return self};Framework.prototype.install=function(type,name,declaration,options,callback,internal,useRequired){var self=this;var obj=null;if(type!=="config"&&type!=="version"&&typeof name==="STRING"){if(name.startsWith("http://")||name.startsWith("https://")){if(typeof declaration===OBJECT){callback=options;options=declaration;declaration=name;name=""}}}var t=typeof declaration;var key="";var tmp=null;if(t===OBJECT||t===FUNCTION){var t=typeof options;if(t===TYPE_FUNCTION)callback=options;options=declaration;declaration=undefined}if(declaration===undefined){declaration=name;name=""}if(typeof declaration===STRING){if(declaration.startsWith("http://")||declaration.startsWith("https://")){utils.request(declaration,["get"],function(err,data,code){if(code!==200&&!err)err=new Error(data);if(err){self.error(err,"framework.install('{0}', '{1}')".format(type,declaration),null);if(callback)callback(err);return}self.install(type,name,data,options,callback,declaration)});return self}}if(type==="middleware"){self.routes.middleware[name]=typeof declaration===TYPE_FUNCTION?declaration:eval(declaration);self._length_middleware=Object.keys(self.routes.middleware).length;if(callback)callback(null);key=type+"."+name;if(self.temporary.dependencies[key]){self.temporary.dependencies[key].updated=new Date}else{self.temporary.dependencies[key]={name:name,type:type,installed:new Date,updated:null,count:0};if(internal)self.temporary.dependencies[key].url=internal}self.temporary.dependencies[key].count++;setTimeout(function(){self.emit("install",type,name)},500);return self}if(type==="config"||type==="configuration"||type==="settings"){self._configure(declaration instanceof Array?declaration:declaration.toString().split("\n"),true);setTimeout(function(){self.emit("install",type,name)},500);if(callback)callback(null);return self}if(type==="version"||type==="versions"){self._configure_versions(declaration.toString(),true);setTimeout(function(){self.emit("install",type,name)},500);if(callback)callback(null);return self}var plus=self.id===null?"":"instance-"+self.id+"-";if(type==="view"){var item=self.routes.views[name];key=type+"."+name;if(item===undefined){item={};item.filename=self.path.temporary("installed-"+plus+"view-"+utils.GUID(10)+".tmp");item.url=internal;item.count=0;self.routes.views[name]=item}item.count++;fs.writeFileSync(item.filename,declaration);setTimeout(function(){self.emit("install",type,name)},500);if(callback)callback(null);return self}if(type==="definition"||type==="eval"){_controller="";try{if(useRequired){delete require.cache[require.resolve(declaration)];obj=require(declaration);(function(name){setTimeout(function(){delete require.cache[name]},1e3)})(require.resolve(declaration))}else obj=typeof declaration===TYPE_FUNCTION?eval("("+declaration.toString()+")()"):eval(declaration)}catch(ex){self.error(ex,"framework.install('"+type+"')",null);if(callback)callback(ex);return self}if(callback)callback(null);setTimeout(function(){self.emit("install",type,name)},500);return self}if(type==="model"||type==="source"){_controller="";try{if(useRequired){obj=require(declaration);(function(name){setTimeout(function(){delete require.cache[name]},1e3)})(require.resolve(declaration))}else{if(typeof declaration!==STRING)declaration=declaration.toString();var filename=directory+self.path.temporary("installed-"+plus+type+"-"+utils.GUID(10)+".js").substring(1);fs.writeFileSync(filename,declaration);obj=require(filename);(function(name,filename){setTimeout(function(){fs.unlinkSync(filename);delete require.cache[name]},1e3)})(require.resolve(filename),filename)}}catch(ex){self.error(ex,"framework.install('"+type+"', '"+name+"')",null);if(callback)callback(ex);return self}if(typeof obj.name===STRING)name=obj.name;key=type+"."+name;tmp=self.temporary.dependencies[key];self.uninstall(type,name);if(tmp){self.temporary.dependencies[key]=tmp;self.temporary.dependencies[key].updated=new Date}else{self.temporary.dependencies[key]={name:name,type:type,installed:new Date,updated:null,count:0};if(internal)self.temporary.dependencies[key].url=internal}self.temporary.dependencies[key].count++;if(obj.reinstall)self.temporary.dependencies[key].reinstall=obj.reinstall.toString().parseDateExpire();else delete self.temporary.dependencies[key];if(type==="model")self.models[name]=obj;else self.sources[name]=obj;if(typeof obj.install===TYPE_FUNCTION)obj.install(self,options,name);setTimeout(function(){self.emit("install",type,name)},500);if(callback)callback(null);return self}if(type==="module"||type==="controller"){_controller="TMP"+Utils.random(1e4);try{if(useRequired){obj=require(declaration);(function(name){setTimeout(function(){delete require.cache[name]},1e3)})(require.resolve(declaration))}else{if(typeof declaration!==STRING)declaration=declaration.toString();var filename=directory+self.path.temporary("installed-"+plus+type+"-"+utils.GUID(10)+".js").substring(1);fs.writeFileSync(filename,declaration);obj=require(filename);(function(name,filename){setTimeout(function(){fs.unlinkSync(filename);delete require.cache[name]},1e3)})(require.resolve(filename),filename)}}catch(ex){self.error(ex,"framework.install('"+type+"', '"+(name.length===0?internal:"")+"')",null);if(callback)callback(ex);return self}if(typeof obj.name===STRING)name=obj.name;key=type+"."+name;tmp=self.temporary.dependencies[key];self.uninstall(type,name);if(tmp){self.temporary.dependencies[key]=tmp;self.temporary.dependencies[key].updated=new Date}else{self.temporary.dependencies[key]={name:name,type:type,installed:new Date,updated:null,count:0};if(internal)self.temporary.dependencies[key].url=internal}self.temporary.dependencies[key].count++;if(obj.reinstall)self.temporary.dependencies[key].reinstall=obj.reinstall.toString().parseDateExpire();else delete self.temporary.dependencies[key].reinstall;if(typeof obj.install===TYPE_FUNCTION)obj.install(self,options,name);var id=(type==="module"?"#":"")+name;var length=self.routes.web.length;for(var i=0;i<length;i++){if(self.routes.web[i].name===_controller)self.routes.web[i].name=id}length=self.routes.websockets.length;for(var i=0;i<length;i++){if(self.routes.websockets[i].name===_controller)self.routes.websockets[i].name=id}length=self.routes.files.length;for(var i=0;i<length;i++){if(self.routes.files[i].name===_controller)self.routes.files[i].name=id}self._routesSort();if(type==="module")self.modules[name]=obj;else self.controllers[name]=obj;_controller="";setTimeout(function(){self.emit("install",type,name)},500);if(callback)callback(null);return self}return self};Framework.prototype.uninstall=function(type,name,options){var self=this;var obj=null;if(type==="schema"){Builders.remove(name);self.emit("uninstall",type,name);return self}if(type==="middleware"){if(!self.routes.middleware[name])return self;delete self.routes.middleware[name];delete self.temporary.dependencies[type+"."+name];self._length_middleware=Object.keys(self.routes.middleware).length;self.emit("uninstall",type,name);return self}if(type==="view"||type==="precompile"){obj=self.routes.views[name];if(!obj)return self;delete self.routes.views[name];delete self.temporary.dependencies[type+"."+name];fs.exists(obj.filename,function(exist){if(exist)fs.unlink(obj.filename)});self.emit("uninstall",type,name);return self}if(type==="model"||type==="source"){obj=type==="model"?self.models[name]:self.sources[name];if(!obj)return self;if(obj.id)delete require.cache[require.resolve(obj.id)];if(typeof obj.uninstall===TYPE_FUNCTION)obj.uninstall(self,options,name);if(type==="model")delete self.models[name];else delete self.sources[name];delete self.temporary.dependencies[type+"."+name];self._routesSort();self.emit("uninstall",type,name);return self}if(type==="module"||type==="controller"){var isModule=type==="module";obj=isModule?self.modules[name]:self.controllers[name];if(!obj)return self;if(obj.id)delete require.cache[require.resolve(obj.id)];var id=(isModule?"#":"")+name;self.routes.web=self.routes.web.remove(function(route){return route.name===id});self.routes.files=self.routes.files.remove(function(route){return route.name===id});self.routes.websockets=self.routes.websockets.remove(function(route){return route.name===id});if(obj){if(obj.uninstall)obj.uninstall(self,options,name);if(isModule)delete self.modules[name];else delete self.controllers[name]}self._routesSort();delete self.temporary.dependencies[type+"."+name];self.emit("uninstall",type,name);return self}return self};Framework.prototype.eval=function(script){return this.install("eval",script)};Framework.prototype.onError=function(err,name,uri){console.log("======= "+(new Date).format("yyyy-MM-dd HH:mm:ss")+": "+(name?name+" ---> ":"")+err.toString()+(uri?" ("+uri.toString()+")":""),err.stack);return this};Framework.prototype.onAuthorization=null;Framework.prototype.onVersion=null;Framework.prototype.onValidation=null;Framework.prototype.onMail=function(address,subject,body,callback){var message=Mail.create(subject,body);if(address instanceof Array){var length=address.length;for(var i=0;i<length;i++)message.to(address[i])}else message.to(address);var self=this;message.from(self.config["mail.address.from"]||"",self.config["name"]);var tmp=self.config["mail.address.reply"];if(tmp&&tmp.length>0&&tmp.isEmail())message.reply(self.config["mail.address.reply"]);tmp=self.config["mail.address.copy"];if(tmp&&tmp.length>0&&tmp.isEmail())message.bcc(tmp);var options={};var opt=self.config["mail.smtp.options"];if(opt&&opt.isJSON())options=JSON.parse(opt);message.send(self.config["mail.smtp"],options,callback);return self};Framework.prototype.onXSS=function(data){if(data===null||data.length===0)return false;data=decodeURIComponent(data);return data.indexOf("<")!==-1&&data.lastIndexOf(">")!==-1};Framework.prototype.onMeta=function(){var self=this;var builder="";var length=arguments.length;for(var i=0;i<length;i++){var arg=utils.encode(arguments[i]);if(arg===null||arg.length===0)continue;switch(i){case 0:builder+="<title>"+(arg+(self.url!=="/"&&!self.config["allow-custom-titles"]?" - "+self.config["name"]:""))+"</title>";break;case 1:builder+='<meta name="description" content="'+arg+'" />';break;case 2:builder+='<meta name="keywords" content="'+arg+'" />';break;case 3:var tmp=arg.substring(0,6);var img=tmp==="http:/"||tmp==="https:"||arg.substring(0,2)==="//"?arg:self.hostname(self.routeImage(arg));builder+='<meta property="og:image" content="'+img+'" /><meta name="twitter:image" content="'+img+'" />';break}}return builder};Framework.prototype.log=function(){var self=this;var now=new Date;var filename=now.getFullYear()+"-"+(now.getMonth()+1).toString().padLeft(2,"0")+"-"+now.getDate().toString().padLeft(2,"0");var time=now.getHours().toString().padLeft(2,"0")+":"+now.getMinutes().toString().padLeft(2,"0")+":"+now.getSeconds().toString().padLeft(2,"0");var str="";
var length=arguments.length;for(var i=0;i<length;i++)str+=(str.length>0?" ":"")+(arguments[i]||"");self._verify_directory("logs");fs.appendFile(utils.combine(self.config["directory-logs"],filename+".log"),time+" | "+str+"\n");return self};Framework.prototype.usage=function(detailed){var self=this;var memory=process.memoryUsage();var cache=Object.keys(self.cache.items);var resources=Object.keys(self.resources);var controllers=Object.keys(self.controllers);var connections=Object.keys(self.connections);var workers=Object.keys(self.workers);var modules=Object.keys(self.modules);var models=Object.keys(self.models);var helpers=Object.keys(self.helpers);var staticFiles=Object.keys(self.temporary.path);var staticRange=Object.keys(self.temporary.range);var redirects=Object.keys(self.routes.redirects);var size=0;var sizeDatabase=0;var dir=utils.combine(self.config["directory-temp"]);var output={};output.framework={pid:process.pid,node:process.version,version:"v"+self.version_header,platform:process.platform,processor:process.arch,uptime:Math.floor(process.uptime()/60),memoryTotal:(memory.heapTotal/1024/1024).floor(2),memoryUsage:(memory.heapUsed/1024/1024).floor(2),mode:self.config.debug?"debug":"release",port:self.port,ip:self.ip,directory:process.cwd()};output.counter={resource:resources.length,controller:controllers.length,module:modules.length,cache:cache.length,worker:workers.length,connection:connections.length,helper:helpers.length,error:self.errors.length,problem:self.problem.length};output.routing={webpage:self.routes.web.length,websocket:self.routes.websockets.length,file:self.routes.files.length,middleware:Object.keys(self.routes.middleware).length,redirect:redirects.length};output.stats={request:self.stats.request,response:self.stats.response};output.redirects=redirects;if(self.restrictions.isRestrictions){output.restrictions={allowed:[],blocked:[],allowedHeaders:self.restrictions.allowedCustomKeys,blockedHeaders:self.restrictions.blockedCustomKeys}}if(!detailed)return output;output.controllers=[];controllers.forEach(function(o){var item=self.controllers[o];output.controllers.push({name:o,usage:item.usage===undefined?null:item.usage()})});output.connections=[];connections.forEach(function(o){output.connections.push({name:o,online:self.connections[o].online})});output.modules=[];modules.forEach(function(o){var item=self.modules[o];output.modules.push({name:o,usage:item.usage===undefined?null:item.usage()})});output.models=[];models.forEach(function(o){var item=self.models[o];output.models.push({name:o,usage:item.usage===undefined?null:item.usage()})});output.helpers=helpers;output.cache=cache;output.resources=resources;output.errors=self.errors;output.problems=self.problems;output.changes=self.changes;return output};Framework.prototype.onCompileCSS=null;Framework.prototype.onCompileJS=null;Framework.prototype.compileContent=function(extension,content,filename){var self=this;switch(extension){case"js":return self.config["allow-compile-js"]?framework_internal.compile_javascript(content):content;case"html":return self.config["allow-compile-html"]?framework_internal.compile_html(content):content;case"css":content=self.config["allow-compile-css"]?framework_internal.compile_css(content):content;var matches=content.match(/url\(.*?\)/g);if(matches===null)return content;matches.forEach(function(o){var url=o.substring(4,o.length-1);content=content.replace(o,"url("+self._version(url)+")")});return content}return content};Framework.prototype.compileFile=function(uri,key,filename,extension,callback){var self=this;fs.readFile(filename,function(err,buffer){if(err){self.error(err,filename,uri);self.temporary.path[key]=null;callback();return}var file=self.path.temp((self.id===null?"":"instance-"+self.id+"-")+uri.pathname.replace(/\//g,"-").substring(1));self._verify_directory("temp");fs.writeFileSync(file,self.compileContent(extension,buffer.toString(ENCODING),filename),ENCODING);self.temporary.path[key]=file+";"+fs.statSync(file).size;callback()});return self};Framework.prototype.compileMerge=function(uri,key,extension,callback){var self=this;var merge=self.routes.merge[uri.pathname];var filename=merge.filename;if(!self.config.debug&&fs.existsSync(filename)){self.temporary.path[key]=filename+";"+fs.statSync(filename).size;callback();return self}var writer=fs.createWriteStream(merge.filename);merge.files.wait(function(filename,next){if(filename.startsWith("http://")||filename.startsWith("https://")){Utils.request(filename,["get"],function(err,data){var output=self.compileContent(extension,data,filename).trim();if(extension==="js"){if(output[output.length-1]!==";")output+=";"}else if(extension==="html"){if(output[output.length-1]!==NEWLINE)output+=NEWLINE}writer.write(output,ENCODING);next()});return}if(filename[0]!=="~"){var tmp=self.path.public(filename);if(self.isVirtualDirectory&&!fs.existsSync(tmp))tmp=utils.combine(self.config["directory-public-virtual"],filename);filename=tmp}else filename=filename.substring(1);fs.readFile(filename,function(err,buffer){if(err){self.error(err,merge.filename,uri);next();return}var output=self.compileContent(extension,buffer.toString(ENCODING),filename).trim();if(extension==="js"){if(output[output.length-1]!==";")output+=";"}else if(extension==="html"){if(output[output.length-1]!==NEWLINE)output+=NEWLINE}writer.write(output,ENCODING);next()})},function(){writer.end();self.temporary.path[key]=filename+";"+fs.statSync(filename).size;callback()});return self};Framework.prototype.compileValidation=function(uri,key,filename,extension,callback){var self=this;if(self.routes.merge[uri.pathname]){self.compileMerge(uri,key,extension,callback);return}if(!fs.existsSync(filename)){if(!self.isVirtualDirectory){self.temporary.path[key]=null;callback();return self}var tmpname=self.isWindows?filename.replace(self.config["directory-public"].replace(/\//g,"\\"),self.config["directory-public-virtual"].replace(/\//g,"\\")):filename.replace(self.config["directory-public"],self.config["directory-public-virtual"]);var notfound=true;if(tmpname!==filename){filename=tmpname;notfound=!fs.existsSync(filename)}if(notfound){self.temporary.path[key]=null;callback();return self}}if(extension==="js"||extension==="css"||extension==="html"){if(filename.lastIndexOf(".min.")===-1&&filename.lastIndexOf("-min.")===-1){self.compileFile(uri,key,filename,extension,callback);return self}}self.temporary.path[key]=filename+";"+fs.statSync(filename).size;callback();return self};Framework.prototype.responseStatic=function(req,res){var self=this;if(res.success)return self;var name=req.url;var index=name.indexOf("?");if(index!==-1)name=name.substring(0,index);index=name.lastIndexOf("/");var resizer=self.routes.resize[name.substring(0,index+1)]||null;var isResize=false;var filename=undefined;if(resizer!==null){name=name.substring(index+1);index=name.lastIndexOf(".");isResize=resizer.extension==="*"||resizer.extension.indexOf(name.substring(index).toLowerCase())!==-1;if(isResize){name=resizer.path+decodeURIComponent(name);filename=name[0]==="~"?name.substring(1):name[0]==="."?name:utils.combine(self.config["directory-public"],name)}else filename=utils.combine(self.config["directory-public"],decodeURIComponent(name))}else filename=utils.combine(self.config["directory-public"],decodeURIComponent(name));if(!isResize){self.responseFile(req,res,filename,"");return self}self.responseImage(req,res,filename,function(image){if(resizer.width||resizer.height){if(resizer.width&&resizer.height)image.resizeCenter(resizer.width,resizer.height);else image.resize(resizer.width,resizer.height)}if(resizer.grayscale)image.grayscale();if(resizer.blur)image.blur(typeof resizer.blur==="number"?resizer.blur:1);if(resizer.rotate&&typeof resizer.rotate==NUMBER)image.rotate(resizer.rotate);if(resizer.flop)image.flop();if(resizer.flip)image.flip();if(resizer.sepia)image.sepia(typeof resizer.sepia==="number"?resizer.sepia:100);if(resizer.quality)image.quality(resizer.quality);else image.quality(self.config["default-image-quality"]);image.minify()});return self};Framework.prototype.isProcessed=function(filename){var self=this;if(filename.url){var name=filename.url;var index=name.indexOf("?");if(index!==-1)name=name.substring(0,index);filename=utils.combine(self.config["directory-public"],decodeURIComponent(name))}if(self.temporary.path[filename]!==undefined)return true;return false};Framework.prototype.isProcessing=function(filename){var self=this;if(filename.url){var name=filename.url;var index=name.indexOf("?");if(index!==-1)name=name.substring(0,index);filename=utils.combine(self.config["directory-public"],decodeURIComponent(name))}var name=self.temporary.processing[filename];if(self.temporary.processing[filename]!==undefined)return true;return false};Framework.prototype.noCache=function(req,res){req.noCache();if(res)res.noCache();return this};Framework.prototype.responseFile=function(req,res,filename,downloadName,headers,key){var self=this;if(res.success)return self;req.clear(true);key=key||filename;var name=self.temporary.path[key];if(name===null){if(self.config.debug)delete self.temporary.path[key];self.response404(req,res);return self}var extension=path.extname(key).substring(1);if(extension.length===0)extension=path.extname(name).substring(1);var index=extension.lastIndexOf(";");if(index!==-1)extension=extension.substring(0,index);if(self.config["static-accepts"].indexOf("."+extension)===-1){self.response404(req,res);return self}var etag=utils.etag(req.url,self.config["etag-version"]);if(!self.config.debug&&req.headers["if-none-match"]===etag){res.success=true;res.writeHead(304);res.end();self.stats.response.notModified++;self._request_stats(false,req.isStaticFile);if(!req.isStaticFile)self.emit("request-end",req,res);return self}if(name===undefined){if(self.isProcessing(key)){if(req.processing>self.config["default-request-timeout"]){self.response408(req,res);return}req.processing+=500;setTimeout(function(){framework.responseFile(req,res,filename,downloadName,headers,key)},500);return self}self.temporary.processing[key]=true;self.compileValidation(req.uri,key,filename,extension,function(){delete self.temporary.processing[key];framework.responseFile(req,res,filename,downloadName,headers,key)});return self}index=name.lastIndexOf(";");var size=null;if(index===-1)index=name.length;else size=name.substring(index+1);name=name.substring(0,index);var accept=req.headers["accept-encoding"]||"";var returnHeaders={};returnHeaders["Accept-Ranges"]="bytes";returnHeaders[RESPONSE_HEADER_CACHECONTROL]="public";returnHeaders["Expires"]=(new Date).add("d",15);returnHeaders["Vary"]="Accept-Encoding";if(headers)utils.extend(returnHeaders,headers,true);if(downloadName&&downloadName.length>0)returnHeaders["Content-Disposition"]='attachment; filename="'+downloadName+'"';if(etag.length>0)returnHeaders["Etag"]=etag;if(!returnHeaders[RESPONSE_HEADER_CONTENTTYPE])returnHeaders[RESPONSE_HEADER_CONTENTTYPE]=utils.getContentType(extension);var compress=self.config["allow-gzip"]&&REQUEST_COMPRESS_CONTENTTYPE.indexOf(returnHeaders[RESPONSE_HEADER_CONTENTTYPE])!==-1;var range=req.headers["range"]||"";var supportsGzip=accept.lastIndexOf("gzip")!==-1;res.success=true;if(range.length>0)return self.responseRange(name,range,returnHeaders,req,res);if(self.config.debug&&self.isProcessed(key))delete self.temporary.path[key];if(size!==null&&size!=="0"&&!compress)returnHeaders[RESPONSE_HEADER_CONTENTLENGTH]=size;var stream;if(compress&&supportsGzip){returnHeaders["Content-Encoding"]="gzip";res.writeHead(200,returnHeaders);stream=fs.createReadStream(name).pipe(zlib.createGzip());stream.pipe(res);self.stats.response.file++;self._request_stats(false,req.isStaticFile);if(!req.isStaticFile)self.emit("request-end",req,res);return self}res.writeHead(200,returnHeaders);stream=fs.createReadStream(name);stream.pipe(res);self.stats.response.file++;self._request_stats(false,req.isStaticFile);if(!req.isStaticFile)self.emit("request-end",req,res);return self};Framework.prototype.responsePipe=function(req,res,url,headers,timeout,callback){var self=this;if(res.success)return self;var uri=parser.parse(url);var h={};h[RESPONSE_HEADER_CACHECONTROL]="private";if(headers)utils.extend(h,headers,true);h["X-Powered-By"]="total.js v"+self.version_header;var options={protocol:uri.protocol,auth:uri.auth,method:"GET",hostname:uri.hostname,port:uri.port,path:uri.path,agent:false,headers:h};var connection=options.protocol==="https:"?https:http;var supportsGZIP=(req.headers["accept-encoding"]||"").lastIndexOf("gzip")!==-1;var client=connection.get(options,function(response){var contentType=response.headers["content-type"];var isGZIP=(response.headers["content-encoding"]||"").lastIndexOf("gzip")!==-1;var compress=!isGZIP&&supportsGZIP&&(contentType.indexOf("text/")!==-1||contentType.lastIndexOf("javascript")!==-1||contentType.lastIndexOf("json")!==-1);var attachment=response.headers["content-disposition"]||"";if(attachment.length>0)res.setHeader("Content-Disposition",attachment);res.setHeader(RESPONSE_HEADER_CONTENTTYPE,contentType);res.setHeader("Vary","Accept-Encoding");if(compress){res.setHeader("Content-Encoding","gzip");response.pipe(zlib.createGzip()).pipe(res);return}if(!supportsGZIP&&isGZIP)response.pipe(zlib.createGunzip()).pipe(res);else response.pipe(res)});if((timeout||0)>0){client.setTimeout(timeout||3e3,function(){self.response408(req,res);if(callback)callback()})}client.on("close",function(){if(res.success)return;req.clear(true);res.success=true;self.stats.response.pipe++;self._request_stats(false,req.isStaticFile);res.success=true;if(!req.isStaticFile)self.emit("request-end",req,res);if(callback)callback()});return self};Framework.prototype.responseCustom=function(req,res){var self=this;if(res.success)return self;req.clear(true);res.success=true;self.stats.response.custom++;self._request_stats(false,req.isStaticFile);if(!req.isStaticFile)self.emit("request-end",req,res);return self};Framework.prototype.responseImage=function(req,res,filename,fnProcess,headers,useImageMagick){var self=this;var stream=null;if(typeof filename===OBJECT)stream=filename;var key="image-"+req.url.substring(1);var name=self.temporary.path[key];if(name===null){self.response404(req,res);return self}if(name!==undefined){self.responseFile(req,res,filename,"",headers,key);return self}var im=useImageMagick;if(im===undefined)im=self.config["default-image-converter"]==="im";if(self.isProcessing(key)){if(req.processing>self.config["default-request-timeout"]){self.response408(req,res);return}req.processing+=500;setTimeout(function(){self.responseImage(req,res,filename,fnProcess,headers,im)},500);return}var Image=framework_image;var plus=self.id===null?"":"instance-"+self.id+"-";name=self.path.temp(plus+key.replace(/\//g,"-"));self.temporary.processing[key]=true;if(stream!==null){fs.exists(name,function(exist){if(exist){delete self.temporary.processing[key];self.temporary.path[key]=name;self.responseFile(req,res,name,"",headers,key);if(self.isDebug)delete self.temporary.path[key];return}self._verify_directory("temp");var image=Image.load(stream,im);fnProcess(image);var extension=path.extname(name);if(extension.substring(1)!==image.outputType)name=name.substring(0,name.lastIndexOf(extension))+"."+image.outputType;image.save(name,function(err){delete self.temporary.processing[key];if(err){self.temporary.path[key]=null;self.response500(req,res,err);if(self.isDebug)delete self.temporary.path[key];return}self.temporary.path[key]=name+";"+fs.statSync(name).size;self.responseFile(req,res,name,"",headers,key)})});return self}fs.exists(filename,function(exist){if(!exist){delete self.temporary.processing[key];self.temporary.path[key]=null;self.response404(req,res);if(self.isDebug)delete self.temporary.path[key];return}self._verify_directory("temp");var image=Image.load(filename,im);fnProcess(image);var extension=path.extname(name);if(extension.substring(1)!==image.outputType)name=name.substring(0,name.lastIndexOf(extension))+"."+image.outputType;image.save(name,function(err){delete self.temporary.processing[key];if(err){self.temporary.path[key]=null;self.response500(req,res,err);if(self.isDebug)delete self.temporary.path[key];return}self.temporary.path[key]=name+";"+fs.statSync(name).size;self.responseFile(req,res,name,"",headers,key)})});return self};Framework.prototype.responseImageWithoutCache=function(req,res,filename,fnProcess,headers,useImageMagick){var self=this;var stream=null;if(typeof filename===OBJECT)stream=filename;var key="image-"+req.url.substring(1);utils.queue(key,10,function(next){var im=useImageMagick;if(im===undefined)im=self.config["default-image-converter"]==="im";var Image=framework_image;if(stream!==null){next();var image=Image.load(stream,im);fnProcess(image);self.responseStream(req,res,utils.getContentType(image.outputType),image.stream(),null,headers);return self}fs.exists(filename,function(exist){next();if(!exist){self.response404(req,res);return}self._verify_directory("temp");var image=Image.load(filename,im);fnProcess(image);self.responseStream(req,res,utils.getContentType(image.outputType),image.stream(),null,headers)})});return self};Framework.prototype.responseStream=function(req,res,contentType,stream,downloadName,headers){var self=this;if(res.success)return self;req.clear(true);if(contentType.lastIndexOf("/")===-1)contentType=utils.getContentType(contentType);var compress=self.config["allow-gzip"]&&REQUEST_COMPRESS_CONTENTTYPE.indexOf(contentType)!==-1;var accept=req.headers["accept-encoding"]||"";var returnHeaders={};returnHeaders[RESPONSE_HEADER_CACHECONTROL]="public";returnHeaders["Expires"]=(new Date).add("d",15);returnHeaders["Vary"]="Accept-Encoding";if(headers)utils.extend(returnHeaders,headers,true);downloadName=downloadName||"";if(downloadName.length>0)returnHeaders["Content-Disposition"]="attachment; filename="+encodeURIComponent(downloadName);returnHeaders[RESPONSE_HEADER_CONTENTTYPE]=contentType;if(compress&&accept.lastIndexOf("gzip")!==-1){returnHeaders["Content-Encoding"]="gzip";res.writeHead(200,returnHeaders);var gzip=zlib.createGzip();stream.pipe(gzip).pipe(res);self.stats.response.stream++;self._request_stats(false,req.isStaticFile);if(!req.isStaticFile)self.emit("request-end",req,res);return self}res.writeHead(200,returnHeaders);stream.pipe(res);self.stats.response.stream++;self._request_stats(false,req.isStaticFile);if(!req.isStaticFile)self.emit("request-end",req,res);return self};Framework.prototype.responseRange=function(name,range,headers,req,res){var self=this;var arr=range.replace(/bytes=/,"").split("-");var beg=parseInt(arr[0]||"0",10);var end=parseInt(arr[1]||"0",10);var total=self.temporary.range[name]||0;if(total===0){total=fs.statSync(name).size;self.temporary.range[name]=total}if(end===0)end=total-1;if(beg>end){beg=0;end=total-1}var length=end-beg+1;headers[RESPONSE_HEADER_CONTENTLENGTH]=length;headers["Content-Range"]="bytes "+beg+"-"+end+"/"+total;res.writeHead(206,headers);var stream=fs.createReadStream(name,{start:beg,end:end});stream.pipe(res);self.stats.response.streaming++;self._request_stats(false,req.isStaticFile);if(!req.isStaticFile)self.emit("request-end",req,res);return self};Framework.prototype.setModified=function(req,res,value){var self=this;var isEtag=typeof value===STRING;if(isEtag){res.setHeader("Etag",value+":"+self.config["etag-version"]);return self}value=value||new Date;res.setHeader("Last-Modified",value.toUTCString());return self};Framework.prototype.notModified=function(req,res,compare,strict){var self=this;var type=typeof compare;if(type===BOOLEAN){var tmp=compare;compare=strict;strict=tmp;type=typeof compare}var isEtag=type===STRING;var val=req.headers[isEtag?"if-none-match":"if-modified-since"];if(isEtag){if(val===undefined)return false;var myetag=compare+":"+self.config["etag-version"];if(val!==myetag)return false}else{if(val===undefined)return false;var date=compare===undefined?(new Date).toUTCString():compare.toUTCString();if(strict){if(new Date(Date.parse(val))===new Date(date))return false}else{if(new Date(Date.parse(val))<new Date(date))return false}}res.success=true;res.writeHead(304);res.end();self.stats.response.notModified++;self._request_stats(false,req.isStaticFile);if(!req.isStaticFile)self.emit("request-end",req,res);return true};Framework.prototype.response400=function(req,res){var self=this;if(res.success)return self;self._request_stats(false,req.isStaticFile);req.clear(true);res.success=true;var headers={};var status=400;headers[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN;res.writeHead(status,headers);res.end(utils.httpStatus(status));if(!req.isStaticFile)self.emit("request-end",req,res);self.stats.response.error400++;return self};Framework.prototype.response401=function(req,res){var self=this;if(res.success)return self;self._request_stats(false,req.isStaticFile);req.clear(true);res.success=true;var headers={};var status=401;headers[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN;res.writeHead(status,headers);res.end(utils.httpStatus(status));if(!req.isStaticFile)self.emit("request-end",req,res);self.stats.response.error401++;return self};Framework.prototype.response403=function(req,res){var self=this;if(res.success)return self;self._request_stats(false,req.isStaticFile);req.clear(true);res.success=true;var headers={};var status=403;headers[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN;res.writeHead(status,headers);res.end(utils.httpStatus(status));if(!req.isStaticFile)self.emit("request-end",req,res);self.stats.response.error403++;return self};Framework.prototype.response404=function(req,res){var self=this;if(res.success)return self;self._request_stats(false,req.isStaticFile);req.clear(true);res.success=true;var headers={};var status=404;headers[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN;res.writeHead(status,headers);res.end(utils.httpStatus(status));if(!req.isStaticFile)self.emit("request-end",req,res);self.stats.response.error404++;return self};Framework.prototype.response408=function(req,res){var self=this;if(res.success)return self;self._request_stats(false,req.isStaticFile);req.clear(true);res.success=true;var headers={};var status=408;headers[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN;res.writeHead(status,headers);res.end(utils.httpStatus(status));if(!req.isStaticFile)self.emit("request-end",req,res);self.stats.response.error408++;return self};Framework.prototype.response431=function(req,res){var self=this;if(res.success)return self;self._request_stats(false,req.isStaticFile);req.clear(true);res.success=true;var headers={};var status=431;headers[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN;res.writeHead(status,headers);res.end(utils.httpStatus(status));if(!req.isStaticFile)self.emit("request-end",req,res);self.stats.response.error431++;return self};Framework.prototype.response500=function(req,res,error){var self=this;if(res.success)return self;self._request_stats(false,req.isStaticFile);req.clear(true);if(error)framework.error(error,null,req.uri);res.success=true;var headers={};var status=500;headers[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN;res.writeHead(status,headers);res.end(utils.httpStatus(status));if(!req.isStaticFile)self.emit("request-end",req,res);self.stats.response.error500++;return self};Framework.prototype.response501=function(req,res){var self=this;if(res.success)return self;self._request_stats(false,req.isStaticFile);req.clear(true);res.success=true;var headers={};var status=501;headers[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN;res.writeHead(status,headers);res.end(utils.httpStatus(status));if(!req.isStaticFile)self.emit("request-end",req,res);self.stats.response.error501++;return self};Framework.prototype.responseContent=function(req,res,code,contentBody,contentType,compress,headers){var self=this;if(res.success)return self;req.clear(true);res.success=true;if(contentBody===null||contentBody===undefined)contentBody="";var accept=req.headers["accept-encoding"]||"";var returnHeaders={};returnHeaders[RESPONSE_HEADER_CACHECONTROL]="private";returnHeaders["Vary"]="Accept-Encoding";if(headers)utils.extend(returnHeaders,headers,true);if(contentType==="application/json")returnHeaders[RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate";if(/text|application/.test(contentType))contentType+="; charset=utf-8";returnHeaders[RESPONSE_HEADER_CONTENTTYPE]=contentType;if(compress&&accept.lastIndexOf("gzip")!==-1){zlib.gzip(new Buffer(contentBody),function(err,data){if(err){res.writeHead(code,returnHeaders);res.end(contentBody,ENCODING);return}returnHeaders["Content-Encoding"]="gzip";res.writeHead(code,returnHeaders);res.end(data,ENCODING)});self._request_stats(false,req.isStaticFile);if(!req.isStaticFile)self.emit("request-end",req,res);return self}res.writeHead(code,returnHeaders);res.end(contentBody,ENCODING);self._request_stats(false,req.isStaticFile);if(!req.isStaticFile)self.emit("request-end",req,res);return self};Framework.prototype.responseRedirect=function(req,res,url,permanent){var self=this;if(res.success)return self;self._request_stats(false,req.isStaticFile);req.clear(true);res.success=true;var headers={Location:url};headers[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTHTML+"; charset=utf-8";res.writeHead(permanent?301:302,headers);res.end();if(!req.isStaticFile)self.emit("request-end",req,res);return self};Framework.prototype.initialize=function(http,debug,options){var self=this;if(self.server!==null)return self;if(!options)options={};var port=options.port;var ip=options.ip;var config=options.config||{};self.isHTTPS=typeof http.STATUS_CODES===UNDEFINED;process.argv.forEach(function(name){if(name.toLowerCase().indexOf("coffee")!==-1)self.isCoffee=true});if(isNaN(port)&&typeof port!==STRING)port=null;self.config.debug=debug;self.isDebug=debug;self._configure();self._configure_versions();if(self.config["disable-strict-server-certificate-validation"]===true)process.env["NODE_TLS_REJECT_UNAUTHORIZED"]="0";if(self.isTest)self._configure("config-test",false);self.clear();self.cache.init();self.isVirtualDirectory=fs.existsSync(utils.combine(self.config["directory-public-virtual"]));self.emit("init");self.load();if(options.https){self.server=http.createServer(options.https,function(req,res){framework._request(req,res)})}else{self.server=http.createServer(function(req,res){framework._request(req,res)})}if(self.config["allow-websocket"]){self.server.on("upgrade",function(req,socket,head){framework._upgrade(req,socket,head)})}if(!port){if(self.config["default-port"]==="auto"){var envPort=parseInt(process.env.PORT||"");if(!isNaN(envPort))port=envPort}else port=self.config["default-port"]}self.port=port||8e3;if(ip!==null){self.ip=ip||self.config["default-ip"]||"127.0.0.1";if(self.ip==="null"||self.ip===UNDEFINED||self.ip==="auto")self.ip=undefined}else self.ip=undefined;self.server.listen(self.port,self.ip);if(self.ip===undefined||self.ip===null)self.ip="auto";self.isLoaded=true;if(!process.connected)self.console();setTimeout(function(){try{self.emit("load",self);self.emit("ready",self)}catch(err){self.error(err,'framework.on("load/ready")')}self.removeAllListeners("load");self.removeAllListeners("ready")},500);if(self.isTest){self.test(true,options.tests||options.test);return self}setTimeout(function(){if(framework.isTest)return;delete framework.tests;delete framework.test;delete framework.testing;delete framework.assert},5e3);return self};Framework.prototype.run=function(http,config,port,ip,options){console.log('OBSOLETE: please use for beginning framework.http("debug", [options([ip: String], [port: Number], [config: Object])]) or framework.http("release", [options([ip: String], [port: Number], [config: Object])]) or framework.http("test", [options([ip: String], [port: Number], [config: Object], tests: [String Array])])');if(typeof http===STRING)return this.mode(http,config,port,ip,options);var debug=false;var type=typeof config;if(type===BOOLEAN)debug=config;else if(type===OBJECT){debug=config.debug;options.config=config}var self=this;self.isHTTPS=typeof http.STATUS_CODES===UNDEFINED;if(isNaN(port)&&typeof port!==STRING)port=null;if(port!==null&&typeof port===OBJECT){var tmp=options;options=port;port=tmp}else if(ip!==null&&typeof ip===OBJECT){var tmp=options;options=ip;ip=tmp}if(options===undefined)options={};options.ip=ip;options.port=port;return this.initialize(http,debug,options)};Framework.prototype.http=function(mode,options){if(options===undefined)options={};if(!options.port)options.port=parseInt(process.argv[2]);return this.mode(require("http"),mode,options)};Framework.prototype.https=function(mode,options){if(options===undefined)options={};return this.mode(require("https"),mode,options)};Framework.prototype.mode=function(http,name,options){var test=false;var debug=false;var self=this;switch(name.toLowerCase().replace(/\.|\s/g,"-")){case"release":case"production":break;case"debug":case"develop":case"development":debug=true;break;case"test":case"testing":case"test-debug":case"testing-debug":test=true;debug=true;self.isTest=true;break;case"test-release":case"testing-release":case"test-production":case"testing-production":test=true;debug=false;break}return self.initialize(http,debug,options)};Framework.prototype.console=function(){console.log("====================================================");console.log("PID          : "+process.pid);console.log("node.js      : "+process.version);console.log("total.js     : v"+framework.version_header);console.log("====================================================");console.log("Name         : "+framework.config.name);console.log("Version      : "+framework.config.version);console.log("Author       : "+framework.config.author);console.log("Date         : "+(new Date).format("yyyy-MM-dd HH:mm:ss"));console.log("Mode         : "+(framework.config.debug?"debug":"release"));console.log("====================================================\n");console.log("{2}://{0}:{1}/".format(framework.ip,framework.port,framework.isHTTPS?"https":"http"));console.log("")};Framework.prototype.reconnect=function(){var self=this;if(self.config["default-port"]!==undefined)self.port=self.config["default-port"];if(self.config["default-ip"]!==undefined)self.ip=self.config["default-ip"];self.server.close(function(){self.server.listen(self.port,self.ip)});return self};Framework.prototype._verify_directory=function(name){var self=this;var prop="$directory-"+name;if(self.temporary.path[prop])return self;var dir=utils.combine(self.config["directory-"+name]);if(!fs.existsSync(dir))fs.mkdirSync(dir);self.temporary.path[prop]=true;return self};Framework.prototype._service=function(count){var self=this;if(self.config.debug)self.resources={};if(count%framework.config["default-interval-clear-resources"]===0){self.emit("clear","resources");self.resources={};if(typeof gc!==UNDEFINED)gc()}if(count%framework.config["default-interval-clear-cache"]===0){self.emit("clear","temporary",self.temporary);self.temporary.path={};self.temporary.range={};self.temporary.views={}}if(count%framework.config["default-interval-precompile-views"]===0){Object.keys(self.routes.views).wait(function(key,next){var item=self.routes.views[key];self.install("view",key,item.url,null,next)},true)}if(count%framework.config["default-interval-websocket-ping"]===0){Object.keys(framework.connections).wait(function(item,next){var conn=framework.connections[item];if(conn&&typeof conn.ping===FUNCTION)conn.ping();next()},true)}self.emit("service",count)};Framework.prototype._request=function(req,res){var self=this;if(self.config["allow-performance"]){req.connection.setNoDelay(true);req.connection.setTimeout(0)}res.req=req;self.emit("request",req,res);var headers=req.headers;var protocol=req.connection.encrypted||headers["x-forwarded-protocol"]==="https"?"https":"http";if(self._request_check_redirect){var redirect=self.routes.redirects[protocol+"://"+req.host];if(redirect){self.stats.response.forward++;self.responseRedirect(req,res,redirect.url+(redirect.path?req.url:""),redirect.permanent);
return self}}if(self.restrictions.isRestrictions){if(self.restrictions.isAllowedIP){if(self.restrictions.allowedIP.indexOf(req.ip)===-1){self.stats.response.restriction++;req.connection.destroy();return self}}if(self.restrictions.isBlockedIP){if(self.restrictions.blockedIP.indexOf(req.ip)!==-1){self.stats.response.restriction++;req.connection.destroy();return self}}if(self.restrictions.isAllowedCustom){if(!self.restrictions._allowedCustom(headers)){self.stats.response.restriction++;req.connection.destroy();return self}}if(self.restrictions.isBlockedCustom){if(self.restrictions._blockedCustom(headers)){self.stats.response.restriction++;req.connection.destroy();return self}}}req.uri=parser.parse(protocol+"://"+req.host+req.url);req.path=framework_internal.routeSplit(req.uri.pathname);req.body={};req.files=[];req.processing=0;req.session=null;req.user=null;req.isAuthorized=true;req.xhr=headers["x-requested-with"]==="XMLHttpRequest";res.success=false;res.setHeader("X-Powered-By","total.js v"+self.version_header);if(self.isDebug)res.setHeader("Mode","debug");req.isStaticFile=utils.isStaticFile(req.uri.pathname);self._request_stats(true,true);if(self._length_request_middleware===0)return self._request_continue(req,res,headers,protocol);var func=[];for(var i=0;i<self._length_request_middleware;i++){var middleware=self.routes.middleware[self.routes.request[i]];if(!middleware){self.error("Middleware not found: "+route.middleware[i],null,req.uri);continue}(function(middleware){func.push(function(next){middleware.call(framework,req,res,next)})})(middleware)}func._async_middleware(res,function(){self._request_continue(req,res,headers,protocol)})};Framework.prototype._request_continue=function(req,res,headers,protocol){var self=this;if(req===null||res===null||res.headersSent)return self;if(req.isStaticFile){self.stats.request.file++;if(self._length_files===0){self.responseStatic(req,res);return self}new Subscribe(self,req,res,3).file();return self}req.isProxy=headers["x-proxy"]==="total.js";req.flags=null;req.buffer_exceeded=false;req.buffer_data="";req.buffer_has=false;var isXSS=false;var accept=headers.accept;self.stats.request.web++;if(req.uri.query&&req.uri.query.length>0){if(self.onXSS!==null)isXSS=self.onXSS(req.uri.query)}var flags=[req.method.toLowerCase()];var multipart=req.headers["content-type"]||"";flags.push(protocol);if(multipart.indexOf("/form-data")===-1){if(multipart.indexOf("/json")!==-1)flags.push("json");if(multipart.indexOf("/xml")!==-1)flags.push("xml");if(multipart.indexOf("mixed")===-1)multipart="";else flags.push("mmr")}if(multipart.length>0)flags.push("upload");if(req.isProxy)flags.push("proxy");if(accept==="text/event-stream")flags.push("sse");if(self.config.debug)flags.push("debug");if(req.xhr){self.stats.request.xhr++;flags.push("xhr")}if(isXSS){flags.push("xss");self.stats.request.xss++}if(self._request_check_referer){var referer=headers["referer"]||"";if(referer!==""&&referer.indexOf(headers["host"])!==-1)flags.push("referer")}req.flags=flags;self.emit("request-begin",req,res);var method=req.method;if(method==="GET"||method==="DELETE"||method==="OPTIONS"){if(method==="DELETE")self.stats.request["delete"]++;else self.stats.request.get++;new Subscribe(self,req,res,0).end();return self}if(self._request_check_POST&&(method==="POST"||method==="PUT")){if(multipart.length>0){self.stats.request.upload++;new Subscribe(self,req,res,2).multipart(multipart)}else{if(method==="PUT")self.stats.request.put++;else self.stats.request.post++;new Subscribe(self,req,res,1).urlencoded()}return self}self.emit("request-end",req,res);self._request_stats(false,false);self.stats.request.blocked++;req.connection.destroy();return self};Framework.prototype._upgrade=function(req,socket,head){if((req.headers.upgrade||"").toLowerCase()!=="websocket")return;var self=this;var headers=req.headers;self.emit("websocket",req,socket,head);self.stats.request.websocket++;if(self.restrictions.isRestrictions){if(self.restrictions.isAllowedIP){if(self.restrictions.allowedIP.indexOf(req.ip)===-1){self.stats.response.restriction++;req.connection.destroy();return self}}if(self.restrictions.isBlockedIP){if(self.restrictions.blockedIP.indexOf(req.ip)!==-1){self.stats.response.restriction++;req.connection.destroy();return self}}if(self.restrictions.isAllowedCustom){if(!self.restrictions._allowedCustom(headers)){self.stats.response.restriction++;req.connection.destroy();return self}}if(self.restrictions.isBlockedCustom){if(self.restrictions._blockedCustom(headers)){self.stats.response.restriction++;req.connection.destroy();return self}}}req.uri=parser.parse((false?"wss":"ws")+"://"+req.headers.host+req.url);req.session=null;req.user=null;req.flags=[req.isSecure?"https":"http","get"];var path=utils.path(req.uri.pathname);var websocket=new WebSocketClient(req,socket,head);req.path=framework_internal.routeSplit(req.uri.pathname);if(self._length_request_middleware===0)return self._upgrade_prepare(req,websocket,path,headers);var func=[];for(var i=0;i<self._length_request_middleware;i++){var middleware=self.routes.middleware[self.routes.request[i]];if(!middleware){self.error("Middleware not found: "+route.middleware[i],null,req.uri);continue}(function(middleware){func.push(function(next){middleware.call(framework,req,null,next)})})(middleware)}func._async_middleware(websocket,function(){self._upgrade_prepare(req,websocket,path,headers)})};Framework.prototype._upgrade_prepare=function(req,websocket,path,headers){var self=this;if(self.onAuthorization===null){var route=self.lookup_websocket(req,websocket.uri.pathname,true);if(route===null){websocket.close();req.connection.destroy();return}self._upgrade_continue(route,req,websocket,path);return}self.onAuthorization.call(self,req,websocket,req.flags,function(isLogged,user){if(user)req.user=user;req.flags.push(isLogged?"authorize":"unauthorize");var route=self.lookup_websocket(req,websocket.uri.pathname,false);if(route===null){websocket.close();req.connection.destroy();return}self._upgrade_continue(route,req,websocket,path)})};Framework.prototype._upgrade_continue=function(route,req,socket,path){var self=this;if(!socket.prepare(route.flags,route.protocols,route.allow,route.length,self.version_header)){socket.close();req.connection.destroy();return self}var id=path+(route.flags.length>0?"#"+route.flags.join("-"):"");if(route.isBINARY)socket.type=1;else if(route.isJSON)socket.type=3;var next=function(){if(self.connections[id]===undefined){var connection=new WebSocket(self,path,route.name,id);self.connections[id]=connection;route.onInitialize.apply(connection,framework_internal.routeParam(route.param.length>0?framework_internal.routeSplit(req.uri.pathname,true):req.path,route))}socket.upgrade(self.connections[id])};if(route.middleware instanceof Array&&route.middleware.length>0){var func=[];for(var i=0,length=route.middleware.length;i<length;i++){var middleware=framework.routes.middleware[file.middleware[i]];if(!middleware)continue;(function(middleware){func.push(function(next){middleware.call(framework,req,res,next,route.options)})})(middleware)}func._async_middleware(res,next);return self}next();return self};Framework.prototype._request_stats=function(beg,isStaticFile){var self=this;if(beg)self.stats.request.pending++;else self.stats.request.pending--;if(self.stats.request.pending<0)self.stats.request.pending=0;return self};Framework.prototype.model=function(name){var self=this;var model=self.models[name];if(model||model===null)return model;if(self.models[name]!==undefined)return self.models[name];var filename=path.join(directory,self.config["directory-models"],name+EXTENSION_JS);if(fs.existsSync(filename))self.install("model",name,filename,undefined,undefined,undefined,true);return self.models[name]||null};Framework.prototype.source=function(name,options,callback){var self=this;var model=self.sources[name];if(model||model===null)return model;if(self.sources[name]!==undefined)return self.sources[name];var filename=path.join(directory,self.config["directory-source"],name+EXTENSION_JS);if(fs.existsSync(filename))self.install("source",name,filename,undefined,undefined,undefined,true);return self.sources[name]||null};Framework.prototype.include=function(name,options,callback){return this.source(name,options,callback)};Framework.prototype._log=function(a,b,c,d){var self=this;if(!self.isDebug)return false;var length=arguments.length;var params=["---->"];for(var i=0;i<length;i++)params.push(arguments[i]);setTimeout(function(){console.log.apply(console,params)},1e3)};Framework.prototype.mail=function(address,subject,view,model,callback){var controller=new Controller("",null,null,null);if(typeof layout===OBJECT){var tmp=repository;repository=layout;layout=tmp}controller.layoutName=layout||"";if(typeof repository===OBJECT&&repository!==null)controller.repository=repository;controller.mail.apply(controller,arguments);return self};Framework.prototype.view=function(name,model,layout,repository){var controller=new Controller("",null,null,null);if(typeof layout===OBJECT){var tmp=repository;repository=layout;layout=tmp}controller.layoutName=layout||"";if(typeof repository===OBJECT&&repository!==null)controller.repository=repository;var output=controller.view(name,model,true);controller=null;return output};Framework.prototype.assert=function(name,url,flags,callback,data,cookies,headers){var self=this;if(typeof url===TYPE_FUNCTION){self.tests.push({name:_test+": "+name,priority:framework.testsPriority,index:self.tests.length,run:url});return self}var method="GET";var length=0;var type=0;headers=utils.extend({},headers||{});if(flags instanceof Array){length=flags.length;for(var i=0;i<length;i++){switch(flags[i].toLowerCase()){case"xhr":headers["X-Requested-With"]="XMLHttpRequest";break;case"json":headers["Content-Type"]="application/json";type=1;break;case"xml":headers["Content-Type"]="text/xml";type=2;break;case"get":case"delete":case"options":method=flags[i].toUpperCase();break;case"upload":headers["Content-Type"]="multipart/form-data";break;case"post":case"put":method=flags[i].toUpperCase();if(!headers["Content-Type"])headers["Content-Type"]="application/x-www-form-urlencoded";break}}}headers["X-Assertion-Testing"]="1";headers["X-Powered-By"]="total.js v"+self.version_header;if(cookies){var builder=[];var keys=Object.keys(cookies);length=keys.length;for(var i=0;i<length;i++)builder.push(keys[i]+"="+encodeURIComponent(cookies[keys[i]]));if(builder.length>0)headers["Cookie"]=builder.join("; ")}var obj={name:_test+": "+name,priority:framework.testsPriority,index:self.tests.length,url:url,callback:callback,method:method,data:data,headers:headers};self.tests.push(obj);return self};Framework.prototype.testing=function(stop,callback){if(stop===undefined)stop=true;var self=this;if(self.tests.length===0){if(callback)callback(framework.isTestError===true);if(stop)self.stop(framework.isTestError?1:0);return self}var logger=function(name,start,err){var time=Math.floor(new Date-start)+" ms";if(err){framework.isTestError=true;console.error("Failed [x] ".padRight(20,".")+" "+name+" <"+(err.name.toLowerCase().indexOf("assert")!==-1?err.toString():err.stack)+"> ["+time+"]");return}console.info("Passed ".padRight(20,".")+" "+name+" ["+time+"]")};var test=self.tests.shift();var key=test.name;var beg=new Date;if(test.run){try{framework.testContinue=function(err){logger(key,beg,err);if(err)framework.testsNO++;else framework.testsOK++;self.testing(stop,callback)};test.run.call(self,function(){self.testContinue()},key)}catch(e){logger(key,beg,e);framework.isTestError=true;framework.testsNO++;self.testing(stop,callback)}return self}var response=function(res){res._buffer="";res.on("data",function(chunk){this._buffer+=chunk.toString(ENCODING)});res.on("end",function(){var cookie=res.headers["cookie"]||"";var cookies={};if(cookie.length!==0){var arr=cookie.split(";");var length=arr.length;for(var i=0;i<length;i++){var c=arr[i].trim().split("=");cookies[c.shift()]=unescape(c.join("="))}}try{test.callback(null,res._buffer,res.statusCode,res.headers,cookies,key);logger(key,beg);framework.testsOK++;self.testing(stop,callback)}catch(e){framework.testsNO++;logger(key,beg,e);self.testing(stop,callback);throw e}});res.resume()};var options=parser.parse((test.url.indexOf("http://")>0||test.url.indexOf("https://")>0?"":"http://"+self.ip+":"+self.port)+test.url);if(typeof test.data===TYPE_FUNCTION)test.data=test.data();if(typeof test.data!==STRING)test.data=(test.headers[RESPONSE_HEADER_CONTENTTYPE]||"").indexOf("json")!==-1?JSON.stringify(test.data):qs.stringify(test.data);if(test.data&&test.data.length>0)test.headers[RESPONSE_HEADER_CONTENTLENGTH]=test.data.length;options.method=test.method;options.headers=test.headers;var con=options.protocol==="https:"?https:http;var req=test.method==="POST"||test.method==="PUT"?con.request(options,response):con.get(options,response);req.on("error",function(e){logger(key,beg,e);self.testsNO++;self.testing(stop,callback)});if(test.data&&test.data.length>0)req.end(test.data,ENCODING);else req.end();return self};Framework.prototype.test=function(stop,names,cb){var self=this;if(stop===undefined)stop=true;if(typeof names===TYPE_FUNCTION){cb=names;names=[]}else names=names||[];var counter=0;self.isTest=true;var dir=self.config["directory-tests"];if(!fs.existsSync(utils.combine(dir))){if(cb)cb();if(stop)setTimeout(function(){framework.stop(0)},500);return self}self._configure("config-test",true);var logger=function(name,start,err){var time=Math.floor(new Date-start)+" ms";if(err){framework.isTestError=true;console.error("Failed [x] ".padRight(20,".")+" "+name+" <"+(err.name.toLowerCase().indexOf("assert")!==-1?err.toString():err.stack)+"> ["+time+"]");return}console.info("Passed ".padRight(20,".")+" "+name+" ["+time+"]")};var results=function(){if(framework.testsResults.length===0)return;console.log("");console.log("====== RESULTS ======");console.log("");framework.testsResults.forEach(function(fn){fn()})};if(!framework.testsResults)framework.testsResults=[];if(!framework.testsOK)framework.testsOK=0;if(!framework.testsNO)framework.testsNO=0;utils.ls(utils.combine(dir),function(files){files.forEach(function(filePath){var name=path.relative(utils.combine(dir),filePath);var filename=path.join(directory,filePath);var ext=path.extname(filename).toLowerCase();if(ext!==EXTENSION_JS&&ext!==EXTENSION_COFFEE)return;if(names.length>0&&names.indexOf(name.substring(0,name.length-3))===-1)return;var test=require(filename);var beg=new Date;try{var isRun=test.run!==undefined;var isInstall=test.isInstall!==undefined;var isInit=test.init!==undefined;var isLoad=test.load!==undefined;_test=name;if(test.disabled===true)return;if(test.order===undefined)framework.testsPriority=test.priority===undefined?self.tests.length:test.priority;else framework.testsPriority=test.priority;if(isRun)test.run(self,name);else if(isInstall)test.install(self,name);else if(isInit)test.init(self,name);else if(isLoad)test.load(self,name);if(test.usage){(function(test){framework.testsResults.push(function(){test.usage(name)})})(test)}counter++}catch(ex){logger("Failed",beg,ex)}});_test="";if(counter===0){results();if(cb)cb();if(!stop)return self;setTimeout(function(){framework.stop(1)},500);return self}self.tests.sort(function(a,b){if(a.priority>b.priority)return 1;if(a.priority<b.priority)return-1;if(a.index>b.index)return 1;if(a.index<b.index)return-1;return 0});setTimeout(function(){console.log("====== TESTING ======");console.log("");self.testing(stop,function(){console.log("");console.log("Passed ...",framework.testsOK);console.log("Failed ...",framework.testsNO);console.log("");results();self.isTest=false;console.log("");if(cb)cb()})},100)});return self};Framework.prototype.clear=function(){var self=this;var dir=utils.combine(self.config["directory-temp"]);if(!fs.existsSync(dir))return self;fs.readdir(dir,function(err,files){if(err)return;var arr=[];var length=files.length;for(var i=0;i<length;i++)arr.push(utils.combine(self.config["directory-temp"],files[i]));self.unlink(arr)});self.temporary.path={};self.temporary.range={};return self};Framework.prototype.unlink=function(arr,callback){var self=this;if(typeof arr===STRING)arr=[arr];if(arr.length===0){if(callback)callback();return}var filename=arr.shift();if(!filename){if(callback)callback();return}fs.unlink(filename,function(){self.unlink(arr,callback)});return self};Framework.prototype.encrypt=function(value,key,isUnique){var self=this;if(value===undefined)return"";var type=typeof value;if(typeof key===BOOLEAN){var tmp=isUnique;isUnique=key;key=tmp}if(type===TYPE_FUNCTION)value=value();if(type===NUMBER)value=value.toString();if(type===OBJECT)value=JSON.stringify(value);return value.encrypt(self.config.secret+"="+key,isUnique)};Framework.prototype.decrypt=function(value,key,jsonConvert){if(typeof key===BOOLEAN){var tmp=jsonConvert;jsonConvert=key;key=tmp}if(typeof jsonConvert!==BOOLEAN)jsonConvert=true;var self=this;var result=(value||"").decrypt(self.config.secret+"="+key);if(result===null)return null;if(jsonConvert){if(result.isJSON()){try{return JSON.parse(result)}catch(ex){}}return null}return result};Framework.prototype.hash=function(type,value,salt){var hash=crypto.createHash(type);var plus="";if(typeof salt===STRING)plus=salt;else if(salt!==false)plus=this.config.secret||"";hash.update(value.toString()+plus,ENCODING);return hash.digest("hex")};Framework.prototype.resource=function(name,key){if(key===undefined||name.length===0){key=name;name="default"}var self=this;var res=self.resources[name];if(res!==undefined)return res[key];var fileName=utils.combine(self.config["directory-resources"],name+".resource");if(!fs.existsSync(fileName))return"";var obj=fs.readFileSync(fileName).toString(ENCODING).parseConfig();self.resources[name]=obj;return obj[key]||""};Framework.prototype._configure_versions=function(content){var self=this;if(content===undefined){var filename=utils.combine("/","versions");if(fs.existsSync(filename))content=fs.readFileSync(filename).toString(ENCODING);else content="";self.versions=null}if((content||"").length===0){self.versions=null;return self}self.versions=content.parseConfig();return self};Framework.prototype._configure=function(arr,rewrite){var self=this;var type=typeof arr;if(type===STRING){var filename=utils.combine("/",arr);if(!fs.existsSync(filename))return self;arr=fs.readFileSync(filename).toString(ENCODING).split("\n")}if(arr===undefined){var filenameA=utils.combine("/","config");var filenameB=utils.combine("/","config-"+(self.config.debug?"debug":"release"));arr=[];if(fs.existsSync(filenameA)&&fs.lstatSync(filenameA).isFile())arr=arr.concat(fs.readFileSync(filenameA).toString(ENCODING).split("\n"));if(fs.existsSync(filenameB)&&fs.lstatSync(filenameB).isFile())arr=arr.concat(fs.readFileSync(filenameB).toString(ENCODING).split("\n"))}if(!arr instanceof Array)return self;if(arr.length===0)return self;if(rewrite===undefined)rewrite=true;var obj={};var accepts=null;var length=arr.length;for(var i=0;i<length;i++){var str=arr[i];if(str===""||str[0]==="#"||(str[0]==="/"||str[1]==="/"))continue;var index=str.indexOf(":");if(index===-1)continue;var name=str.substring(0,index).trim();if(name==="debug"||name==="resources")continue;var value=str.substring(index+1).trim();switch(name){case"default-request-length":case"default-websocket-request-length":case"default-request-timeout":case"default-interval-clear-cache":case"default-interval-clear-resources":case"default-interval-precompile-views":case"default-interval-websocket-ping":obj[name]=utils.parseInt(value);break;case"static-accepts-custom":accepts=value.replace(/\s/g,"").split(",");break;case"static-accepts":obj[name]=value.replace(/\s/g,"").split(",");break;case"allow-gzip":case"allow-websocket":case"allow-compile-js":case"allow-compile-css":case"allow-compile-html":case"allow-performance":case"disable-strict-server-certificate-validation":obj[name]=value.toLowerCase()==="true"||value==="1";break;case"allow-compress-html":obj["allow-compile-html"]=value.toLowerCase()==="true"||value==="1";break;case"version":obj[name]=value;break;default:obj[name]=value.isNumber()?utils.parseInt(value):value.isNumber(true)?utils.parseFloat(value):value.isBoolean()?value.toLowerCase()==="true":value;break}}utils.extend(self.config,obj,rewrite);if(self.config["etag-version"]==="")self.config["etag-version"]=self.config.version.replace(/\.|\s/g,"");process.title="total: "+self.config.name.removeDiacritics().toLowerCase().replace(/\s/g,"-").substring(0,8);if(accepts!==null&&accepts.length>0){accepts.forEach(function(accept){if(self.config["static-accepts"].indexOf(accept)===-1)self.config["static-accepts"].push(accept)})}if(self.config["allow-performance"])http.globalAgent.maxSockets=9999;self.emit("configure",self.config);return self};Framework.prototype.routeJS=function(name){var self=this;if(name.lastIndexOf(EXTENSION_JS)===-1)name+=EXTENSION_JS;return self._routeStatic(name,self.config["static-url-js"])};Framework.prototype.routeCSS=function(name){var self=this;if(name.lastIndexOf(".css")===-1)name+=".css";return self._routeStatic(name,self.config["static-url-css"])};Framework.prototype.routeImage=function(name){var self=this;return self._routeStatic(name,self.config["static-url-image"])};Framework.prototype.routeVideo=function(name){var self=this;return self._routeStatic(name,self.config["static-url-video"])};Framework.prototype.routeFont=function(name){var self=this;return self._routeStatic(name,self.config["static-url-font"])};Framework.prototype.routeDownload=function(name){var self=this;return self._routeStatic(name,self.config["static-url-download"])};Framework.prototype.routeStatic=function(name){var self=this;return self._routeStatic(name,self.config["static-url"])};Framework.prototype._routeStatic=function(name,directory){return directory+this._version(name)};Framework.prototype._version=function(name){var self=this;if(self.versions!==null)name=self.versions[name]||name;if(self.onVersion!==null)name=self.onVersion(name)||name;return name};Framework.prototype.lookup=function(req,url,flags,noLoggedUnlogged){var self=this;var isSystem=url[0]==="#";if(isSystem)req.path=[url];var subdomain=req.subdomain===null?null:req.subdomain.join(".");var length=self.routes.web.length;for(var i=0;i<length;i++){var route=self.routes.web[i];if(!framework_internal.routeCompareSubdomain(subdomain,route.subdomain))continue;if(route.isASTERIX){if(!framework_internal.routeCompare(req.path,route.url,isSystem,true))continue}else{if(!framework_internal.routeCompare(req.path,route.url,isSystem))continue}if(isSystem)return route;if(route.flags!==null&&route.flags.length>0){var result=framework_internal.routeCompareFlags2(req,route,noLoggedUnlogged?true:route.isMEMBER);if(result===-1)req.isAuthorized=false;if(result<1)continue}else{if(flags.indexOf("xss")!==-1)continue}return route}return null};Framework.prototype.lookup_websocket=function(req,url,noLoggedUnlogged){var self=this;var subdomain=req.subdomain===null?null:req.subdomain.join(".");var length=self.routes.websockets.length;for(var i=0;i<length;i++){var route=self.routes.websockets[i];if(!framework_internal.routeCompareSubdomain(subdomain,route.subdomain))continue;if(route.isASTERIX){if(!framework_internal.routeCompare(req.path,route.url,false,true))continue}else{if(!framework_internal.routeCompare(req.path,route.url,false))continue}if(route.flags!==null&&route.flags.length>0){var result=framework_internal.routeCompareFlags2(req,route,noLoggedUnlogged?true:route.isMEMBER);if(result===-1)req.isAuthorized=false;if(result<1)continue}return route}return null};Framework.prototype.accept=function(extension,contentType){var self=this;if(extension[0]!==".")extension="."+extension;if(self.config["static-accepts"].indexOf(extension)===-1)self.config["static-accepts"].push(extension);if(contentType)utils.setContentType(extension,contentType);return self};Framework.prototype.accepts=function(extension,contentType){console.log("OBSOLETE: framework.accepts(), use: framework.accept()");return this.accept(extension,contentType)};Framework.prototype.worker=function(name,id,timeout){var self=this;var fork=null;var type=typeof id;if(type===NUMBER&&timeout===undefined){timeout=id;id=null;type=UNDEFINED}if(type===STRING)fork=self.workers[id]||null;if(fork!==null)return fork;var filename=utils.combine(self.config["directory-workers"],name)+EXTENSION_JS;fork=child.fork(filename,{cwd:directory});id=name+"_"+(new Date).getTime();fork.__id=id;self.workers[id]=fork;fork.on("exit",function(){var self=this;if(self.__timeout)clearTimeout(self.__timeout);delete framework.workers[self.__id]});if(typeof timeout!==NUMBER)return fork;fork.__timeout=setTimeout(function(){fork.kill();fork=null},timeout);return fork};function FrameworkRestrictions(framework){this.isRestrictions=false;this.isAllowedIP=false;this.isBlockedIP=false;this.isAllowedCustom=false;this.isBlockedCustom=false;this.allowedIP=[];this.blockedIP=[];this.allowedCustom={};this.blockedCustom={};this.allowedCustomKeys=[];this.blockedCustomKeys=[]}FrameworkRestrictions.prototype.allow=function(name,value){var self=this;if(value===undefined){self.allowedIP.push(name);self.refresh();return framework}if(self.allowedCustom[name]===undefined)self.allowedCustom[name]=[value];else self.allowedCustom[name].push(value);self.refresh();return framework};FrameworkRestrictions.prototype.disallow=function(name,value){var self=this;if(value===undefined){self.blockedIP.push(name);self.refresh();return framework}if(self.blockedCustom[name]===undefined)self.blockedCustom[name]=[value];else self.blockedCustom[name].push(value);self.refresh();return framework};FrameworkRestrictions.prototype.refresh=function(){var self=this;self.isAllowedIP=self.allowedIP.length>0;self.isBlockedIP=self.blockedIP.length>0;self.isAllowedCustom=!utils.isEmpty(self.allowedCustom);self.isBlockedCustom=!utils.isEmpty(self.blockedCustom);self.allowedCustomKeys=Object.keys(self.allowedCustom);self.blockedCustomKeys=Object.keys(self.blockedCustom);self.isRestrictions=self.isAllowedIP||self.isBlockedIP||self.isAllowedCustom||self.isBlockedCustom;return framework};FrameworkRestrictions.prototype.clearIP=function(){var self=this;self.allowedIP=[];self.blockedIP=[];self.refresh();return framework};FrameworkRestrictions.prototype.clearHeaders=function(){var self=this;self.allowedCustom={};self.blockedCustom={};self.allowedCustomKeys=[];self.blockedCustomKeys=[];self.refresh();return framework};FrameworkRestrictions.prototype._allowedCustom=function(headers){var self=this;var length=self.allowedCustomKeys.length;for(var i=0;i<length;i++){var key=self.allowedCustomKeys[i];var value=headers[key];if(value===undefined)return false;var arr=self.allowedCustom[key];var max=arr.length;for(var j=0;j<max;j++){if(value.search(arr[j])!==-1)return false}}return true};FrameworkRestrictions.prototype._blockedCustom=function(headers){var self=this;var length=self.blockedCustomKeys.length;for(var i=0;i<length;i++){var key=self.blockedCustomKeys[i];var value=headers[key];if(value===undefined)return false;var arr=self.blockedCustom[key];var max=arr.length;for(var j=0;j<max;j++){if(value.search(arr[j])!==-1)return true}}return false};function FrameworkFileSystem(framework){this.create={css:this.createCSS.bind(this),database:this.createDatabase.bind(this),file:this.createFile.bind(this),js:this.createJS.bind(this),resource:this.createResource.bind(this),temporary:this.createTemporary.bind(this),view:this.createView.bind(this),worker:this.createWorker.bind(this)};this.rm={css:this.deleteCSS.bind(this),database:this.deleteDatabase.bind(this),file:this.deleteFile.bind(this),js:this.deleteJS.bind(this),resource:this.deleteResource.bind(this),temporary:this.deleteTemporary.bind(this),view:this.deleteView.bind(this),worker:this.deleteWorker.bind(this)}}FrameworkFileSystem.prototype.deleteCSS=function(name){var self=this;if(name.lastIndexOf(".css")===-1)name+=".css";var filename=utils.combine(framework.config["directory-public"],framework.config["static-url-css"],name);return self.deleteFile(filename)};FrameworkFileSystem.prototype.deleteJS=function(name){var self=this;if(name.lastIndexOf(EXTENSION_JS)===-1)name+=EXTENSION_JS;var filename=utils.combine(framework.config["directory-public"],framework.config["static-url-js"],name);return self.deleteFile(filename)};FrameworkFileSystem.prototype.deleteView=function(name){var self=this;if(name.lastIndexOf(".html")===-1)name+=".html";var filename=utils.combine(framework.config["directory-views"],name);return self.deleteFile(filename)};FrameworkFileSystem.prototype.deleteDatabase=function(name){var self=this;var filename=utils.combine(framework.config["directory-databases"],name);return self.deleteFile(filename)};FrameworkFileSystem.prototype.deleteWorker=function(name){var self=this;if(name.lastIndexOf(EXTENSION_JS)===-1)name+=EXTENSION_JS;var filename=utils.combine(framework.config["directory-workers"],name);return self.deleteFile(filename)};FrameworkFileSystem.prototype.deleteResource=function(name){var self=this;if(name.lastIndexOf(".resource")===-1)name+=".resource";var filename=utils.combine(framework.config["directory-resources"],name);return self.deleteFile(filename)};FrameworkFileSystem.prototype.deleteTemporary=function(name){var self=this;var filename=utils.combine(framework.config["directory-temp"],name);return self.deleteFile(filename)};FrameworkFileSystem.prototype.deleteFile=function(filename){var self=this;fs.exists(filename,function(exist){if(!exist)return;fs.unlink(filename)});return true};FrameworkFileSystem.prototype.createCSS=function(name,content,rewrite,append){var self=this;if((content||"").length===0)return false;if(name.lastIndexOf(".css")===-1)name+=".css";var filename=utils.combine(framework.config["directory-public"],framework.config["static-url-css"],name);return self.createFile(filename,content,append,rewrite)};FrameworkFileSystem.prototype.createJS=function(name,content,rewrite,append){var self=this;if((content||"").length===0)return false;if(name.lastIndexOf(EXTENSION_JS)===-1)name+=EXTENSION_JS;var filename=utils.combine(framework.config["directory-public"],framework.config["static-url-js"],name);return self.createFile(filename,content,append,rewrite)};FrameworkFileSystem.prototype.createDatabase=function(name,content,rewrite,append){var self=this;if((content||"").length===0)return false;var filename=utils.combine(framework.config["directory-databases"],name);return self.createFile(filename,content,append,rewrite)};FrameworkFileSystem.prototype.createView=function(name,content,rewrite,append){var self=this;if((content||"").length===0)return false;if(name.lastIndexOf(".html")===-1)name+=".html";framework._verify_directory("views");var filename=utils.combine(framework.config["directory-views"],name);return self.createFile(filename,content,append,rewrite)};FrameworkFileSystem.prototype.createWorker=function(name,content,rewrite,append){var self=this;if((content||"").length===0)return false;if(name.lastIndexOf(EXTENSION_JS)===-1)name+=EXTENSION_JS;framework._verify_directory("workers");var filename=utils.combine(framework.config["directory-workers"],name);return self.createFile(filename,content,append,rewrite)};FrameworkFileSystem.prototype.createResource=function(name,content,rewrite,append){var self=this;if((content||"").length===0)return false;if(name.lastIndexOf(".resource")===-1)name+=".resource";var builder=content;if(typeof content===OBJECT){builder="";Object.keys(content).forEach(function(o){builder+=o.padRight(20," ")+": "+content[o]+"\n"})}framework._verify_directory("resources");var filename=utils.combine(framework.config["directory-resources"],name);return self.createFile(filename,builder,append,rewrite)};FrameworkFileSystem.prototype.createTemporary=function(name,stream,callback){var self=this;framework._verify_directory("temp");var filename=utils.combine(framework.config["directory-temp"],name);var writer=fs.createWriteStream(filename);if(callback){writer.on("error",function(err){callback(err,filename)
});writer.on("end",function(){callback(null,filename)})}stream.pipe(writer);return self};FrameworkFileSystem.prototype.createFile=function(filename,content,append,rewrite,callback){var self=this;if(content.substring(0,7)==="http://"||content.substring(0,8)==="https://"){utils.request(content,["get"],function(err,data){if(!err)self.createFile(filename,data,append,rewrite);if(typeof callback===TYPE_FUNCTION)callback(err,filename)});return true}if((content||"").length===0)return false;var exists=fs.existsSync(filename);if(exists&&append){var data=fs.readFileSync(filename).toString(ENCODING);if(data.indexOf(content)===-1){fs.appendFileSync(filename,"\n"+content);return true}return false}if(exists&&!rewrite)return false;fs.writeFileSync(filename,content,ENCODING);if(typeof callback===TYPE_FUNCTION)callback(null,filename);return true};function FrameworkPath(framework){}FrameworkPath.prototype.public=function(filename){var self=this;framework._verify_directory("public");return utils.combine(framework.config["directory-public"],filename||"").replace(/\\/g,"/")};FrameworkPath.prototype.logs=function(filename){var self=this;framework._verify_directory("logs");return utils.combine(framework.config["directory-logs"],filename||"").replace(/\\/g,"/")};FrameworkPath.prototype.models=function(filename){var self=this;return utils.combine(framework.config["directory-models"],filename||"").replace(/\\/g,"/")};FrameworkPath.prototype.temp=function(filename){var self=this;framework._verify_directory("temp");return utils.combine(framework.config["directory-temp"],filename||"").replace(/\\/g,"/")};FrameworkPath.prototype.temporary=function(filename){return this.temp(filename)};FrameworkPath.prototype.views=function(filename){var self=this;framework._verify_directory("views");return utils.combine(framework.config["directory-views"],filename||"").replace(/\\/g,"/")};FrameworkPath.prototype.workers=function(filename){var self=this;framework._verify_directory("workers");return utils.combine(framework.config["directory-workers"],filename||"").replace(/\\/g,"/")};FrameworkPath.prototype.databases=function(filename){var self=this;framework._verify_directory("databases");return utils.combine(framework.config["directory-databases"],filename||"").replace(/\\/g,"/")};FrameworkPath.prototype.contents=function(filename){var self=this;framework._verify_directory("contents");return utils.combine(framework.config["directory-contents"],filename||"").replace(/\\/g,"/")};FrameworkPath.prototype.modules=function(filename){var self=this;framework._verify_directory("modules");return utils.combine(framework.config["directory-modules"],filename||"").replace(/\\/g,"/")};FrameworkPath.prototype.controllers=function(filename){var self=this;framework._verify_directory("controllers");return utils.combine(framework.config["directory-controllers"],filename||"").replace(/\\/g,"/")};FrameworkPath.prototype.definitions=function(filename){var self=this;framework._verify_directory("definitions");return utils.combine(framework.config["directory-definitions"],filename||"").replace(/\\/g,"/")};FrameworkPath.prototype.tests=function(filename){var self=this;framework._verify_directory("tests");return utils.combine(framework.config["directory-tests"],filename||"").replace(/\\/g,"/")};FrameworkPath.prototype.resources=function(filename){var self=this;framework._verify_directory("resources");return utils.combine(framework.config["directory-resources"],filename||"").replace(/\\/g,"/")};FrameworkPath.prototype.root=function(filename){return path.join(directory,filename||"")};function FrameworkCache(framework){this.items={};this.count=1;this.interval=null}FrameworkCache.prototype.init=function(interval){var self=this;self.interval=setInterval(function(){framework.cache.recycle()},interval||1e3*60);return self};FrameworkCache.prototype.stop=function(){var self=this;clearInterval(self.interval);return self};FrameworkCache.prototype.clear=function(){var self=this;self.items={};return self};FrameworkCache.prototype.recycle=function(){var self=this;var items=self.items;var keys=Object.keys(items);var length=keys.length;self.count++;if(length===0){framework._service(self.count);return self}var expire=new Date;for(var i=0;i<length;i++){var o=keys[i];var value=items[o];if(value.expire<expire){framework.emit("cache-expire",o,value.value);delete items[o]}}framework._service(self.count);return self};FrameworkCache.prototype.add=function(name,value,expire){var self=this;var type=typeof expire;switch(type){case STRING:expire=expire.parseDateExpire();break;case UNDEFINED:expire=(new Date).add("m",5);break}self.items[name]={value:value,expire:expire};return value};FrameworkCache.prototype.read=function(name){var self=this;var value=self.items[name]||null;if(value===null)return null;if(value.expire<new Date)return null;return value.value};FrameworkCache.prototype.setExpire=function(name,expire){var self=this;var obj=self.items[name];if(obj===undefined)return self;if(typeof expire===STRING)expire=expire.parseDateExpire();obj.expire=expire;return self};FrameworkCache.prototype.remove=function(name){var self=this;var value=self.items[name]||null;delete self.items[name];return value};FrameworkCache.prototype.removeAll=function(search){var self=this;var count=0;var keys=Object.keys(self.items);var length=keys.length;var isReg=utils.isRegExp(search);for(var i=0;i<length;i++){if(isReg){if(!search.test(keys[i]))continue}else{if(keys[i].indexOf(search)===-1)continue}self.remove(keys[i]);count++}return count};FrameworkCache.prototype.fn=function(name,fnCache,fnCallback){var self=this;var value=self.read(name);if(value!==null){if(fnCallback)fnCallback(value);return self}fnCache(function(value,expire){self.add(name,value,expire);if(fnCallback)fnCallback(value)});return self};var REPOSITORY_HEAD="$head";var REPOSITORY_META="$meta";var REPOSITORY_META_TITLE="$title";var REPOSITORY_META_DESCRIPTION="$description";var REPOSITORY_META_KEYWORDS="$keywords";var REPOSITORY_META_IMAGE="$image";var REPOSITORY_PLACE="$place";var ATTR_END='"';function Subscribe(framework,req,res,type){this.controller=null;this.req=req;this.res=res;this.route=null;this.timeout=null;this.isCanceled=false;this.isMixed=false;this.isTransfer=false;this.header="";this.error=null}Subscribe.prototype.success=function(){var self=this;if(self.timeout)clearTimeout(self.timeout);self.timeout=null;self.isCanceled=true;return self};Subscribe.prototype.file=function(){var self=this;self.req.on("end",function(){self.doEndfile(this)});self.req.resume();return self};Subscribe.prototype.multipart=function(header){var self=this;var req=self.req;self.route=framework.lookup(req,req.uri.pathname,req.flags,true);self.header=header;if(self.route===null){framework._request_stats(false,false);framework.stats.request.blocked++;req.connection.destroy();return self}if(header.indexOf("mixed")===-1){framework._verify_directory("temp");framework_internal.parseMULTIPART(req,header,self.route.maximumSize,framework.config["directory-temp"],function(data){if(framework.onXSS)return framework.onXSS(data);return true},function(){self.doEnd()});return self}self.isMixed=true;self.execute()};Subscribe.prototype.urlencoded=function(){var self=this;self.route=framework.lookup(self.req,self.req.uri.pathname,self.req.flags,true);if(self.route===null){self.req.clear(true);framework.stats.request.blocked++;framework._request_stats(false,false);self.req.connection.destroy();return}self.req.buffer_has=true;self.req.buffer_exceeded=false;self.req.on("data",function(chunk){self.doParsepost(chunk)});self.end()};Subscribe.prototype.end=function(){var self=this;self.req.on("end",function(){self.doEnd()});self.req.resume()};Subscribe.prototype.execute=function(status){var self=this;var route=self.route;var req=self.req;var res=self.res;if(status>399&&(route===null||route.name[0]==="#")){switch(status){case 400:framework.stats.response.error400++;break;case 401:framework.stats.response.error401++;break;case 403:framework.stats.response.error403++;break;case 404:framework.stats.response.error404++;break;case 408:framework.stats.response.error408++;break;case 431:framework.stats.response.error431++;break;case 500:framework.stats.response.error500++;break;case 501:framework.stats.response.error501++;break}}if(route===null){framework.responseContent(req,res,status||404,utils.httpStatus(status||404),CONTENTTYPE_TEXTPLAIN,framework.config["allow-gzip"]);return self}var name=route.name;var controller=new Controller(name,req,res,self);controller.isTransfer=self.isTransfer;controller.exception=self.exception;self.controller=controller;if(!self.isCanceled&&!self.isMixed&&route.timeout>0){self.timeout=setTimeout(function(){self.doCancel()},route.timeout)}if(framework._length_middleware===0||route.middleware===null)return self.doExecute();var func=[];var length=route.middleware.length;for(var i=0;i<length;i++){var middleware=framework.routes.middleware[route.middleware[i]];if(!middleware){self.error("Middleware not found: "+route.middleware[i],controller.name,req.uri);continue}(function(middleware){func.push(function(next){middleware.call(controller,req,res,next,route.options,controller)})})(middleware)}if(func.length===0)return self.doExecute();func._async_middleware(res,function(){self.doExecute()});return self};Subscribe.prototype.prepare=function(flags,url){var self=this;var req=self.req;var res=self.res;if(framework.onAuthorization!==null){framework.onAuthorization(req,res,flags,function(isAuthorized,user){self.doAuthorization(isAuthorized,user)});return}if(self.route===null)self.route=framework.lookup(req,req.buffer_exceeded?"#431":url||req.uri.pathname,flags);if(self.route===null)self.route=framework.lookup(req,req.flags.indexOf("xss")===-1?"#404":"#400",[]);self.execute(req.buffer_exceeded?431:404)};Subscribe.prototype.doExecute=function(){var self=this;var name=self.route.name;var controller=self.controller;var req=self.req;try{if(controller.isCanceled)return self;framework.emit("controller",controller,name,self.route.options);if(controller.isCanceled)return self;if(!self.isMixed){self.route.onExecute.apply(controller,framework_internal.routeParam(self.route.param.length>0?framework_internal.routeSplit(req.uri.pathname,true):req.path,self.route));return self}framework._verify_directory("temp");framework_internal.parseMULTIPART_MIXED(req,self.header,framework.config["directory-temp"],function(file){self.route.onExecute.call(controller,file)},function(){self.doEnd()})}catch(err){controller=null;framework.error(err,name,req.uri);self.route=framework.lookup(req,"#500",[]);self.execute(500)}return self};Subscribe.prototype.doAuthorization=function(isLogged,user){var self=this;var req=self.req;req.flags.push(isLogged?"authorize":"unauthorize");if(user)req.user=user;var route=framework.lookup(req,req.buffer_exceeded?"#431":req.uri.pathname,req.flags);if(route===null)route=framework.lookup(req,req.isAuthorized?"#404":"#401",[]);self.route=route;self.execute(req.buffer_exceeded?431:404);return self};Subscribe.prototype.doEnd=function(){var self=this;var req=self.req;var res=self.res;var route=self.route;if(self.isMixed){req.clear(true);var headers={};headers[RESPONSE_HEADER_CONTENTTYPE]="text/plain; charset=utf-8";headers[RESPONSE_HEADER_CACHECONTROL]="private, max-age=0";res.writeHead(200,headers);res.end("END");framework._request_stats(false,false);framework.emit("request-end",req,res);return self}if(req.buffer_exceeded){route=framework.lookup(req,"#431",[]);if(route===null){framework.response431(req,res);return self}self.execute(431);return self}if(req.buffer_data.length===0){if(route!==null&&!route.isXSS&&req.flags.indexOf("xss")!==-1){self.route400(new Error("Cross-site scripting."));return self}self.prepare(req.flags,req.uri.pathname);return self}if(route.isJSON){try{if((req.headers["content-type"]||"").indexOf("application/json")===-1){self.route400(new Error("Request validation."));return self}if(!req.buffer_data.isJSON()){self.route400(new Error("Request validation."));return self}req.body=JSON.parse(req.buffer_data);req.buffer_data=null;self.prepare(req.flags,req.uri.pathname)}catch(err){self.route400(err)}return self}if(route.isXML){if((req.headers["content-type"]||"").indexOf("text/xml")===-1){self.route400(new Error("Request validation."));return self}try{req.body=utils.parseXML(req.buffer_data);req.buffer_data=null;self.prepare(req.flags,req.uri.pathname)}catch(err){self.route400(err)}return self}if(!self.route.isXSS&&framework.onXSS!==null){if(framework.onXSS(req.buffer_data)){req.flags.push("xss");framework.stats.request.xss++;self.route400(new Error("Cross-site scripting."));return self}}if(!self.route.isRAW){if((req.headers["content-type"]||"").indexOf("x-www-form-urlencoded")===-1){self.route400("Request validation.");return self}req.body=qs.parse(req.buffer_data)}else req.body=req.buffer_data;self.prepare(req.flags,req.uri.pathname);return self};Subscribe.prototype.route400=function(problem){var self=this;self.route=framework.lookup(self.req,"#400",[]);self.exception=problem;self.execute(400);return self};Subscribe.prototype.doEndfile=function(){var self=this;var req=self.req;var res=self.res;for(var i=0;i<framework._length_files;i++){var file=framework.routes.files[i];try{if(file.onValidation.call(framework,req,res,true)){if(file.middleware===null)file.onExecute.call(framework,req,res,false);else self.doEndfile_middleware(file);return self}}catch(err){framework.error(err,file.controller+" :: "+file.name,req.uri);framework.responseContent(req,res,500,"500 - internal server error",CONTENTTYPE_TEXTPLAIN,framework.config["allow-gzip"]);return self}}framework.responseStatic(self.req,self.res);return self};Subscribe.prototype.doEndfile_middleware=function(file){var func=[];var length=file.middleware.length;var self=this;var req=self.req;var res=self.res;for(var i=0;i<length;i++){var middleware=framework.routes.middleware[file.middleware[i]];if(!middleware)continue;(function(middleware){func.push(function(next){middleware.call(framework,req,res,next,file.options)})})(middleware)}func._async_middleware(res,function(){try{file.onExecute.call(framework,req,res,false)}catch(err){framework.error(err,file.controller+" :: "+file.name,req.uri);framework.responseContent(req,res,500,"500 - internal server error",CONTENTTYPE_TEXTPLAIN,framework.config["allow-gzip"]);return self}});return self};Subscribe.prototype.doParsepost=function(chunk){var self=this;var req=self.req;if(req.buffer_exceeded)return self;if(!req.buffer_exceeded)req.buffer_data+=chunk.toString();if(req.buffer_data.length<self.route.maximumSize)return self;req.buffer_exceeded=true;req.buffer_data="";return self};Subscribe.prototype.doCancel=function(){var self=this;framework.stats.response.timeout++;clearTimeout(self.timeout);self.timeout=null;if(self.controller===null)return;self.controller.isTimeout=true;self.controller.isCanceled=true;self.route=framework.lookup(self.req,"#408",[]);self.execute(408)};function Controller(name,req,res,subscribe){this.subscribe=subscribe;this.name=name;this.req=req;this.res=res;this.exception=null;this.boundary=null;this.type=0;this.layoutName=framework.config["default-layout"];this.status=200;this.isLayout=false;this.isCanceled=false;this.isConnected=true;this.isTimeout=false;this.isController=true;this.isTransfer=false;this.repository={};this.output=null;this.outputPartial=null;this.$model=null;this._currentImage="";this._currentDownload="";this._currentVideo="";this._currentJS="";this._currentCSS="";this._currentView=name[0]!=="#"&&name!=="default"&&name!==""?"/"+name+"/":"";if(!this.req){var empty={};this.req={uri:empty}}if(!this.res)this.res={};if(this.res)this.res.controller=this}Controller.prototype={get sseID(){return this.req.headers["last-event-id"]||null},get flags(){return this.subscribe.route.flags},get path(){return framework.path},get fs(){return framework.fs},get get(){return this.req.query},get query(){return this.req.query},get post(){return this.req.body},get body(){return this.req.body},get files(){return this.req.files},get language(){return this.req.language},get subdomain(){return this.req.subdomain},get ip(){return this.req.ip},get xhr(){return this.req.xhr},get url(){return utils.path(this.req.uri.pathname)},get uri(){return this.req.uri},get cache(){return framework.cache},get config(){return framework.config},get controllers(){return framework.controllers},get isProxy(){return this.req.isProxy},get isDebug(){return framework.config.debug},get isTest(){return this.req.headers["x-assertion-testing"]==="1"},get isSecure(){return this.req.isSecure},get session(){return this.req.session},set session(value){this.req.session=value},get user(){return this.req.user},set user(value){this.req.user=value},get global(){return framework.global},set global(value){framework.global=value},get async(){var self=this;if(typeof self._async===UNDEFINED)self._async=new utils.Async(self);return self._async}};Controller.prototype.validation=function(model,properties,prefix,name){return this.validate(model,properties,prefix,name)};Controller.prototype.clear=function(){var self=this;self.req.clear();return self};Controller.prototype.middleware=function(names,options,callback){if(typeof names===STRING)names=[names];if(typeof options===TYPE_FUNCTION){var tmp=callback;callback=options;options=callback}if(options===undefined||options===null)options={};var self=this;var func=[];var length=names.length;for(var i=0;i<length;i++){var middleware=framework.routes.middleware[names[i]];if(!middleware)continue;(function(middleware,options){func.push(function(next){middleware.call(framework,self.req,self.res,next,options)})})(middleware,options[names[i]]===undefined?options:options[names[i]])}func._async_middleware(self.res,callback,controller);return self};Controller.prototype.pipe=function(url,headers,callback){var self=this;if(typeof headers===TYPE_FUNCTION){var tmp=callback;callback=headers;headers=tmp}if(self.res.success||!self.isConnected)return self;framework.responsePipe(self.req,self.res,url,headers,null,function(){self.subscribe.success();if(callback)callback()});return self};Controller.prototype.encrypt=function(){return framework.encrypt.apply(framework,arguments)};Controller.prototype.decrypt=function(){return framework.decrypt.apply(framework,arguments)};Controller.prototype.hash=function(){return framework.hash.apply(framework,arguments)};Controller.prototype.date=function(type,d1,d2){if(d2===undefined){d2=d1;d1=new Date}var beg=typeof d1===STRING?d1.parseDate():d1;var end=typeof d2===STRING?d2.parseDate():d2;var r=beg.compare(end);switch(type){case">":return r===1;case">=":case"=>":return r===1||r===0;case"<":return r===-1;case"<=":case"=<":return r===-1||r===0;case"=":return r===0}return true};Controller.prototype.validate=function(model,properties,prefix,name){var self=this;var resource=function(key){return self.resource(name||"default",(prefix||"")+key)};if(typeof properties===STRING)return builders.validate(properties,model,prefix);var error=new builders.ErrorBuilder(resource);return utils.validate.call(self,model,properties,framework.onValidation,error)};Controller.prototype.header=function(name,value){var self=this;self.res.setHeader(name,value);return self};Controller.prototype.host=function(path){var self=this;return self.req.hostname(path)};Controller.prototype.hostname=function(path){var self=this;return self.req.hostname(path)};Controller.prototype.cors=function(allow,method,header,credentials){var self=this;var origin=self.req.headers["origin"];var isOPTIONS=self.req.method.toUpperCase()==="OPTIONS";if(origin===undefined)return true;if(allow===undefined)allow="*";if(typeof method===BOOLEAN){credentials=method;method=null}if(typeof header===BOOLEAN){credentials=header;header=null}if(!utils.isArray(allow))allow=[allow];var isAllowed=false;var isAll=false;var value;var headers=self.req.headers;if(header){if(!utils.isArray(header))header=[header];for(var i=0;i<header.length;i++){if(headers[header[i].toLowerCase()]){isAllowed=true;break}}if(!isAllowed)return false;isAllowed=false}if(method){if(!utils.isArray(method))method=[method];var current=headers["access-control-request-method"]||self.req.method;for(var i=0;i<method.length;i++){value=method[i].toUpperCase();method[i]=value;if(current.indexOf(value)!==-1)isAllowed=true}if(!isAllowed)return false;isAllowed=false}for(var i=0;i<allow.length;i++){value=allow[i];if(value==="*"||origin.indexOf(value)!==-1){isAll=value==="*";isAllowed=true;break}}if(!isAllowed)return false;var tmp;var name;self.res.setHeader("Access-Control-Allow-Origin",isAll?"*":origin);if(credentials)self.res.setHeader("Access-Control-Allow-Credentials","true");name="Access-Control-Allow-Methods";if(method){self.res.setHeader(name,method.join(", "))}else if(isOPTIONS){tmp=headers["access-control-request-method"];if(tmp)self.res.setHeader(name,tmp)}name="Access-Control-Allow-Headers";if(header){self.res.setHeader(name,header.join(", "))}else if(isOPTIONS){tmp=headers["access-control-request-headers"];if(tmp)self.res.setHeader(name,tmp)}return true};Controller.prototype.error=function(err){var self=this;var result=framework.error(typeof err===STRING?new Error(err):err,self.name,self.uri);if(err===undefined)return result;self.subscribe.exception=err;self.exception=err;return self};Controller.prototype.problem=function(message){var self=this;framework.problem(message,self.name,self.uri,self.ip);return self};Controller.prototype.change=function(message){var self=this;framework.change(message,self.name,self.uri,self.ip);return self};Controller.prototype.wait=function(name,waitingFor,fn){var self=this;self.async.wait(name,waitingFor,fn);return self};Controller.prototype.await=function(name,fn){var self=this;self.async.await(name,fn);return self};Controller.prototype.complete=function(callback){var self=this;return self.async.complete(callback)};Controller.prototype.run=function(callback){var self=this;return self.async.complete(callback)};Controller.prototype.transfer=function(url,flags){var self=this;var length=framework.routes.web.length;var path=framework_internal.routeSplit(url.trim());var isSystem=url[0]==="#";var noFlag=flags===null||flags===undefined||flags.length===0;var selected=null;for(var i=0;i<length;i++){var route=framework.routes.web[i];if(route.isASTERIX){if(!framework_internal.routeCompare(path,route.url,isSystem,true))continue}else{if(!framework_internal.routeCompare(path,route.url,isSystem))continue}if(noFlag){selected=route;break}if(route.flags!==null&&route.flags.length>0){var result=framework_internal.routeCompareFlags(route.flags,flags,true);if(result===-1)req.isAuthorized=false;if(result<1)continue}else{if(flags.indexOf("xss")!==-1)continue}selected=route;break}if(!selected)return false;self.cancel();self.req.path=[];self.subscribe.isTransfer=true;self.subscribe.success();self.subscribe.route=selected;self.subscribe.execute(404,route.name!==self.name);return true};Controller.prototype.cancel=function(){var self=this;if(typeof self._async!==UNDEFINED)self._async.cancel();self.isCanceled=true;return self};Controller.prototype.log=function(){var self=this;framework.log.apply(framework,arguments);return self};Controller.prototype.meta=function(){var self=this;self.repository[REPOSITORY_META_TITLE]=arguments[0]||"";self.repository[REPOSITORY_META_DESCRIPTION]=arguments[1]||"";self.repository[REPOSITORY_META_KEYWORDS]=arguments[2]||"";self.repository[REPOSITORY_META_IMAGE]=arguments[3]||"";return self};Controller.prototype.$dns=function(value){var builder="";var self=this;var length=arguments.length;for(var i=0;i<length;i++)builder+='<link rel="dns-prefetch" href="'+self._prepareHost(arguments[i]||"")+'" />';self.head(builder);return""};Controller.prototype.$prefetch=function(){var builder="";var self=this;var length=arguments.length;for(var i=0;i<length;i++)builder+='<link rel="prefetch" href="'+self._prepareHost(arguments[i]||"")+'" />';self.head(builder);return""};Controller.prototype.$prerender=function(value){var builder="";var self=this;var length=arguments.length;for(var i=0;i<length;i++)builder+='<link rel="prerender" href="'+self._prepareHost(arguments[i]||"")+'" />';self.head(builder);return""};Controller.prototype.$next=function(value){var self=this;self.head('<link rel="next" href="'+self._prepareHost(value||"")+'" />');return""};Controller.prototype.$prev=function(value){var self=this;self.head('<link rel="prev" href="'+self._prepareHost(value||"")+'" />');return""};Controller.prototype.$canonical=function(value){var self=this;self.head('<link rel="canonical" href="'+self._prepareHost(value||"")+'" />');return""};Controller.prototype.$meta=function(){var self=this;if(arguments.length!==0){self.meta.apply(self,arguments);return""}framework.emit("controller-render-meta",self);var repository=self.repository;return framework.onMeta.call(self,repository[REPOSITORY_META_TITLE],repository[REPOSITORY_META_DESCRIPTION],repository[REPOSITORY_META_KEYWORDS],repository[REPOSITORY_META_IMAGE])};Controller.prototype.title=function(value){var self=this;self.$title(value);return self};Controller.prototype.description=function(value){var self=this;self.$description(value);return self};Controller.prototype.keywords=function(value){var self=this;self.$keywords(value);return self};Controller.prototype.$title=function(value){var self=this;if(!value)return self.repository[REPOSITORY_META_TITLE]||"";self.repository[REPOSITORY_META_TITLE]=value;return""};Controller.prototype.$description=function(value){var self=this;if(!value)return self.repository[REPOSITORY_META_DESCRIPTION]||"";self.repository[REPOSITORY_META_DESCRIPTION]=value;return""};Controller.prototype.$keywords=function(value){var self=this;if(!value)return self.repository[REPOSITORY_META_KEYWORDS]||"";self.repository[REPOSITORY_META_KEYWORDS]=value;return""};Controller.prototype.sitemap=function(name,url,index){var self=this;if(name===undefined)return self.repository.sitemap||[];if(url===undefined)url=self.req.url;if(self.repository.sitemap===undefined)self.repository.sitemap=[];self.repository.sitemap.push({name:name,url:url,index:index||self.repository.sitemap.length});if(index!==undefined&&self.sitemap.length>1){self.repository.sitemap.sort(function(a,b){if(a.index<b.index)return-1;if(a.index>b.index)return 1;return 0})}return self};Controller.prototype.$sitemap=function(name,url,index){var self=this;self.sitemap.apply(self,arguments);return""};Controller.prototype.module=function(name){return framework.module(name)};Controller.prototype.layout=function(name){var self=this;self.layoutName=name;return self};Controller.prototype.$layout=function(name){var self=this;self.layoutName=name;return""};Controller.prototype.model=function(name){var self=this;return framework.model(name)};Controller.prototype.models=function(name){var self=this;return(self.controllers[name||self.name]||{}).models};Controller.prototype.mail=function(address,subject,view,model,callback){if(typeof model===TYPE_FUNCTION){callback=model;model=null}var self=this;var body=self.view(view,model,true);framework.onMail(address,subject,body,callback);return self};Controller.prototype.functions=function(name){var self=this;return(self.controllers[name||self.name]||{}).functions};Controller.prototype.notModified=function(compare,strict){var self=this;return framework.notModified(self.req,self.res,compare,strict)};Controller.prototype.setModified=function(value){var self=this;framework.setModified(self.req,self.res,value);return self};Controller.prototype.setExpires=function(date){var self=this;if(date===undefined)return self;self.res.setHeader("Expires",date.toUTCString());return self};Controller.prototype.$template=function(name,model,expire){return this.$viewToggle(true,name,model,expire)};Controller.prototype.$templateToggle=function(visible,name,model,expire){return this.$viewToggle(visible,name,model,expire)};Controller.prototype.$view=function(name,model,expire){return this.$viewToggle(true,name,model,expire)};Controller.prototype.$viewToggle=function(visible,name,model,expire){if(!visible)return"";var self=this;if(expire){var output=self.cache.read("$view."+name);if(output!==null)return output}var layout=self.layoutName;self.layoutName="";var value=self.view(name,model,null,true,expire);self.layoutName=layout;if(expire)self.cache.add("$view."+name,value,expire);return value};Controller.prototype.place=function(name){var self=this;var key=REPOSITORY_PLACE+"_"+name;var length=arguments.length;if(length===1)return self.repository[key]||"";var output="";for(var i=1;i<length;i++){var val=arguments[i];if(val.indexOf("<")!==-1){output+=val;continue}if(val.lastIndexOf(EXTENSION_JS)===-1){output+=val;continue}var tmp=val.substring(0,7);var isRoute=tmp[0]!=="/"&&tmp[1]!=="/"&&tmp!=="http://"&&tmp!=="https:/";output+='<script type="text/javascript" src="'+(isRoute?self.routeJS(val):val)+'"></script>'}self.repository[key]=(self.repository[key]||"")+output;return self};Controller.prototype.$place=function(){var self=this;if(arguments.length===1)return self.place.apply(self,arguments);self.place.apply(self,arguments);return""};Controller.prototype.$url=function(host){var self=this;return host?self.req.hostname(self.url):self.url};Controller.prototype.$helper=function(name){var self=this;return self.helper.apply(self,arguments)};Controller.prototype.$checked=function(bool,charBeg,charEnd){var self=this;return self.$isValue(bool,charBeg,charEnd,'checked="checked"')};Controller.prototype.$disabled=function(bool,charBeg,charEnd){var self=this;return self.$isValue(bool,charBeg,charEnd,'disabled="disabled"')};Controller.prototype.$selected=function(bool,charBeg,charEnd){var self=this;return self.$isValue(bool,charBeg,charEnd,'selected="selected"')};Controller.prototype.$set=function(value){return""};Controller.prototype.$readonly=function(bool,charBeg,charEnd){var self=this;return self.$isValue(bool,charBeg,charEnd,'readonly="readonly"')};Controller.prototype.$header=function(name,value){this.header(name,value);return""};Controller.prototype.$text=function(model,name,attr){return this.$input(model,"text",name,attr)};Controller.prototype.$password=function(model,name,attr){return this.$input(model,"password",name,attr)};Controller.prototype.$hidden=function(model,name,attr){return this.$input(model,"hidden",name,attr)};Controller.prototype.$radio=function(model,name,value,attr){if(typeof attr===STRING)attr={label:attr};attr.value=value;return this.$input(model,"radio",name,attr)};Controller.prototype.$checkbox=function(model,name,attr){if(typeof attr===STRING)attr={label:attr};return this.$input(model,"checkbox",name,attr)};Controller.prototype.$textarea=function(model,name,attr){var builder="<textarea";if(typeof attr!==OBJECT)attr={};builder+=' name="'+name+'" id="'+(attr.id||name)+ATTR_END;var keys=Object.keys(attr);var length=keys.length;for(var i=0;i<length;i++){switch(keys[i]){case"name":case"id":break;case"required":case"disabled":case"readonly":case"value":builder+=" "+keys[i]+'="'+keys[i]+ATTR_END;break;default:builder+=" "+keys[i]+'="'+attr[keys[i]].toString().encode()+ATTR_END;break}}if(model===undefined)return builder+"></textarea>";var value=model[name]||attr.value||"";return builder+">"+value.toString().encode()+"</textarea>"};Controller.prototype.$input=function(model,type,name,attr){var builder=["<input"];if(typeof attr!==OBJECT)attr={};var val=attr.value||"";builder+=' type="'+type+ATTR_END;if(type==="radio")builder+=' name="'+name+ATTR_END;else builder+=' name="'+name+'" id="'+(attr.id||name)+ATTR_END;if(attr.autocomplete){if(attr.autocomplete===true||attr.autocomplete==="on")builder+=' autocomplete="on"';else builder+=' autocomplete="off"'}var keys=Object.keys(attr);var length=keys.length;for(var i=0;i<length;i++){switch(keys[i]){case"name":case"id":case"type":case"autocomplete":case"checked":case"value":case"label":break;case"required":case"disabled":case"readonly":case"autofocus":builder+=" "+keys[i]+'="'+keys[i]+ATTR_END;
break;default:builder+=" "+keys[i]+'="'+attr[keys[i]].toString().encode()+ATTR_END;break}}var value="";if(model!==undefined){value=model[name];if(type==="checkbox"){if(value==="1"||value==="true"||value===true)builder+=' checked="checked"';value=val||"1"}if(type==="radio"){val=(val||"").toString();if(value.toString()===val)builder+=' checked="checked"';value=val||""}}if(value!==undefined)builder+=' value="'+(value||"").toString().encode()+ATTR_END;else builder+=' value="'+(attr.value||"").toString().encode()+ATTR_END;builder+=" />";if(attr.label)return"<label>"+builder+" <span>"+attr.label+"</span></label>";return builder};Controller.prototype._prepareHost=function(value){var tmp=value.substring(0,5);if(tmp!=="http:"&&tmp!=="https://"){if(tmp[0]!=="/"||tmp[1]!=="/")value=this.host(value)}return value};Controller.prototype.head=function(){var self=this;var length=arguments.length;if(length===0){framework.emit("controller-render-head",self);return(self.config.author&&self.config.author.length>0?'<meta name="author" content="'+self.config.author+'" />':"")+(self.repository[REPOSITORY_HEAD]||"")}var header=self.repository[REPOSITORY_HEAD]||"";var output="";for(var i=0;i<length;i++){var val=arguments[i];if(header.length>0&&header.indexOf(val)!==-1)continue;if(val.indexOf("<")!==-1){output+=val;continue}var tmp=val.substring(0,7);var isRoute=tmp[0]!=="/"&&tmp[1]!=="/"&&tmp!=="http://"&&tmp!=="https:/";if(val.endsWith(".css",true))output+='<link type="text/css" rel="stylesheet" href="'+(isRoute?self.routeCSS(val):val)+'" />';else if(val.endsWith(EXTENSION_JS,true)!==-1)output+='<script type="text/javascript" src="'+(isRoute?self.routeJS(val):val)+'"></script>'}header+=output;self.repository[REPOSITORY_HEAD]=header;return self};Controller.prototype.$head=function(){var self=this;self.head.apply(self,arguments);return""};Controller.prototype.$isValue=function(bool,charBeg,charEnd,value){if(!bool)return"";charBeg=charBeg||" ";charEnd=charEnd||"";return charBeg+value+charEnd};Controller.prototype.$modified=function(value){var self=this;var type=typeof value;var date;if(type===NUMBER){date=new Date(value)}else if(type===STRING){var d=value.split(" ");date=d[0].split("-");var time=(d[1]||"").split(":");var year=utils.parseInt(date[0]||"");var month=utils.parseInt(date[1]||"")-1;var day=utils.parseInt(date[2]||"")-1;if(month<0)month=0;if(day<0)day=0;var hour=utils.parseInt(time[0]||"");var minute=utils.parseInt(time[1]||"");var second=utils.parseInt(time[2]||"");date=new Date(year,month,day,hour,minute,second,0)}else if(utils.isDate(value))date=value;if(date===undefined)return"";self.setModified(date);return""};Controller.prototype.$etag=function(value){this.setModified(value);return""};Controller.prototype.$options=function(arr,selected,name,value){var self=this;var type=typeof arr;if(arr===null||arr===undefined)return"";var isObject=false;var tmp=null;if(!(arr instanceof Array)&&type===OBJECT){isObject=true;tmp=arr;arr=Object.keys(arr)}if(!utils.isArray(arr))arr=[arr];selected=selected||"";var options="";if(!isObject){if(value===undefined)value=value||name||"value";if(name===undefined)name=name||"name"}var isSelected=false;var length=0;length=arr.length;for(var i=0;i<length;i++){var o=arr[i];var type=typeof o;var text="";var val="";var sel=false;if(isObject){if(name===true){val=tmp[o];text=o;if(value===null)value=""}else{val=o;text=tmp[o];if(text===null)text=""}}else if(type===OBJECT){text=o[name]||"";val=o[value]||"";if(typeof text===TYPE_FUNCTION)text=text(i);if(typeof val===TYPE_FUNCTION)val=val(i,text)}else{text=o;val=o}if(!isSelected){sel=val==selected;isSelected=sel}options+='<option value="'+val.toString().encode()+'"'+(sel?' selected="selected"':"")+">"+text.toString().encode()+"</option>"}return options};Controller.prototype.$script=function(){var self=this;return self.$js.apply(self,arguments)};Controller.prototype.$js=function(){var self=this;var builder="";for(var i=0;i<arguments.length;i++)builder+=self.routeJS(arguments[i],true);return builder};Controller.prototype.$css=function(){var self=this;var builder="";for(var i=0;i<arguments.length;i++)builder+=self.routeCSS(arguments[i],true);return builder};Controller.prototype.$image=function(name,width,height,alt,className){var style="";if(typeof width===OBJECT){height=width.height;alt=width.alt;className=width.class;style=width.style;width=width.width}var builder='<img src="'+this.routeImage(name)+ATTR_END;if(width>0)builder+=' width="'+width+ATTR_END;if(height>0)builder+=' height="'+height+ATTR_END;if(alt)builder+=' alt="'+alt.encode()+ATTR_END;if(className)builder+=' class="'+className+ATTR_END;if(style)builder+=' style="'+style+ATTR_END;return builder+' border="0" />'};Controller.prototype.$download=function(filename,innerHTML,downloadName,className){var builder='<a href="'+framework.routeDownload(filename)+ATTR_END;if(downloadName)builder+=' download="'+downloadName+ATTR_END;if(className)builder+=' class="'+className+ATTR_END;return builder+">"+(innerHTML||filename)+"</a>"};Controller.prototype.$json=function(obj,id,beautify){if(typeof id===BOOLEAN){var tmp=id;id=beautify;beautify=id}var value=beautify?JSON.stringify(obj,null,4):JSON.stringify(obj);if(!id)return value;return'<script type="application/json" id="'+id+'">'+value+"</script>"};Controller.prototype.$favicon=function(name){var self=this;var contentType="image/x-icon";if(name===undefined)name="favicon.ico";if(name.lastIndexOf(".png")!==-1)contentType="image/png";else if(name.lastIndexOf(".gif")!==-1)contentType="image/gif";name=framework.routeStatic("/"+name);return'<link rel="shortcut icon" href="'+name+'" type="'+contentType+'" /><link rel="icon" href="'+name+'" type="'+contentType+'" />'};Controller.prototype._routeHelper=function(current,name,fn){var self=this;if(current.length===0)return fn.call(framework,name);if(current.substring(0,2)==="//"||current.substring(0,6)==="http:/"||current.substring(0,7)==="https:/")return fn.call(framework,current+name);if(current[0]==="~")return fn.call(framework,utils.path(current.substring(1))+name);return fn.call(framework,utils.path(current)+name)};Controller.prototype.routeJS=function(name,tag){var self=this;if(name===undefined)name="default.js";var url=self._routeHelper(self._currentJS,name,framework.routeJS);return tag?'<script type="text/javascript" src="'+url+'"></script>':url};Controller.prototype.routeCSS=function(name,tag){var self=this;if(name===undefined)name="default.css";var url=self._routeHelper(self._currentCSS,name,framework.routeCSS);return tag?'<link type="text/css" rel="stylesheet" href="'+url+'" />':url};Controller.prototype.routeImage=function(name){var self=this;return self._routeHelper(self._currentImage,name,framework.routeImage)};Controller.prototype.routeVideo=function(name){var self=this;return self._routeHelper(self._currentVideo,name,framework.routeVideo)};Controller.prototype.routeFont=function(name){var self=this;return framework.routeFont(name)};Controller.prototype.routeDownload=function(name){var self=this;return self._routeHelper(self._currentDownload,name,framework.routeDownload)};Controller.prototype.routeStatic=function(name){var self=this;return framework.routeStatic(name)};Controller.prototype.$currentJS=function(path){this._currentJS=path&&path.length>0?path:"";return""};Controller.prototype.$currentView=function(path){var self=this;if(path===undefined){self._currentView=self.name[0]!=="#"&&self.name!=="default"?"/"+self.name+"/":"";return self}self._currentView=path&&path.length>0?utils.path(path):"";return""};Controller.prototype.currentView=function(path){var self=this;self.$currentView(path);self._defaultView=self._currentView;return self};Controller.prototype.$currentCSS=function(path){this._currentCSS=path&&path.length>0?path:"";return""};Controller.prototype.$currentImage=function(path){this._currentImage=path&&path.length>0?path:"";return""};Controller.prototype.$currentVideo=function(path){this._currentVideo=path&&path.length>0?path:"";return""};Controller.prototype.$currentDownload=function(path){this._currentDownload=path&&path.length>0?path:"";return""};Controller.prototype.currentImage=function(path){var self=this;self.$currentImage(path);self._defaultImage=self._currentImage;return self};Controller.prototype.currentDownload=function(path){var self=this;self.$currentDownload(path);self._defaultDownload=self._currentDownload;return self};Controller.prototype.currentCSS=function(path){var self=this;self.$currentCSS(path);self._defaultCSS=self._currentCSS;return self};Controller.prototype.currentJS=function(path){var self=this;self.$currentJS(path);self._defaultJS=self._currentJS;return self};Controller.prototype.currentVideo=function(path){var self=this;self.$currentVideo(path);self._defaultVideo=self._currentVideo;return self};Controller.prototype.resource=function(name,key){var self=this;return framework.resource(name,key)};Controller.prototype.template=function(name,model){return this.view(name,model,true)};Controller.prototype.helper=function(name){var self=this;var helper=framework.helpers[name]||null;if(helper===null)return"";var length=arguments.length;var params=[];for(var i=1;i<length;i++)params.push(arguments[i]);return helper.apply(self,params)};Controller.prototype.json=function(obj,headers,beautify,replacer){var self=this;if(self.res.success||!self.isConnected)return self;if(typeof headers===BOOLEAN){replacer=beautify;beautify=headers}if(obj instanceof builders.ErrorBuilder)obj=obj.json(beautify);else{if(beautify)obj=JSON.stringify(obj||{},replacer,4);else obj=JSON.stringify(obj||{},replacer)}self.subscribe.success();framework.responseContent(self.req,self.res,self.status,obj,"application/json",self.config["allow-gzip"],headers);framework.stats.response.json++;if(self.precache)self.precache(obj,"application/json",headers);return self};Controller.prototype.callback=function(viewName){var self=this;return function(err,data){if(data===undefined&&!util.isError(err)&&!(err instanceof Builders.ErrorBuilder)){data=err;err=null}if(err)return self.throw500(err);if(typeof viewName===STRING)return self.view(viewName,data);self.json(data)}};Controller.prototype.custom=function(){var self=this;self.subscribe.success();if(self.res.success||!self.isConnected)return false;framework.responseCustom(self.req,self.res);return true};Controller.prototype.noClear=function(enable){var self=this;self.req._manual=enable===undefined?true:enable;return self};Controller.prototype.jsonAsync=function(obj,headers,beautify){var self=this;var fn=function(){self.json(obj,headers,beautify)};self.async.complete(fn);return self};Controller.prototype.content=function(contentBody,contentType,headers){var self=this;var type=typeof contentType;if(self.res.success||!self.isConnected)return self;self.subscribe.success();framework.responseContent(self.req,self.res,self.status,contentBody,contentType||CONTENTTYPE_TEXTPLAIN,self.config["allow-gzip"],headers);return self};Controller.prototype.plain=function(contentBody,headers){var self=this;if(self.res.success||!self.isConnected)return self;var type=typeof contentBody;if(contentBody===undefined)contentBody="";else if(type===OBJECT)contentBody=contentBody===null?"":JSON.stringify(contentBody,null,4);else contentBody=contentBody===null?"":contentBody.toString();self.subscribe.success();framework.responseContent(self.req,self.res,self.status,contentBody,CONTENTTYPE_TEXTPLAIN,self.config["allow-gzip"],headers);framework.stats.response.plain++;if(self.precache)self.precache(contentBody,CONTENTTYPE_TEXTPLAIN,headers);return self};Controller.prototype.empty=function(headers){var self=this;if(self.res.success||!self.isConnected)return self;var code=204;if(typeof headers===NUMBER){code=headers;headers=null}self.subscribe.success();framework.responseContent(self.req,self.res,code,"",CONTENTTYPE_TEXTPLAIN,false,headers);framework.stats.response.empty++;return self};Controller.prototype.destroy=function(){var self=this;if(self.res.success||!self.isConnected)return self;self.subscribe.success();self.req.connection.destroy();framework.stats.response.destroy++;return self};Controller.prototype.file=function(filename,downloadName,headers){var self=this;if(self.res.success||!self.isConnected)return self;if(filename[0]==="~")filename="."+filename.substring(1);else filename=utils.combine(framework.config["directory-public"],filename);self.subscribe.success();framework.responseFile(self.req,self.res,filename,downloadName,headers);return self};Controller.prototype.image=function(filename,fnProcess,headers,useImageMagick){var self=this;if(self.res.success||!self.isConnected)return self;if(typeof filename===STRING){if(filename[0]==="~")filename="."+filename.substring(1);else filename=utils.combine(framework.config["directory-public"],filename)}self.subscribe.success();framework.responseImage(self.req,self.res,filename,fnProcess,headers,useImageMagick);return self};Controller.prototype.fileAsync=function(filename,downloadName,headers){var self=this;var fn=function(){self.file(filename,downloadName,headers)};self.async.complete(fn);return self};Controller.prototype.stream=function(contentType,stream,downloadName,headers){var self=this;if(self.res.success||!self.isConnected)return self;self.subscribe.success();framework.responseStream(self.req,self.res,contentType,stream,downloadName,headers);return self};Controller.prototype.throw400=function(problem){return this.view400(problem)};Controller.prototype.view400=function(problem){var self=this;if(problem&&problem.length>0)self.problem(problem);if(self.res.success||!self.isConnected)return self;self.req.path=[];self.subscribe.success();self.subscribe.route=framework.lookup(self.req,"#400",[]);self.subscribe.exception=problem;self.subscribe.execute(400);return self};Controller.prototype.throw401=function(problem){return this.view401(problem)};Controller.prototype.view401=function(problem){var self=this;if(problem&&problem.length>0)self.problem(problem);if(self.res.success||!self.isConnected)return self;self.req.path=[];self.subscribe.success();self.subscribe.route=framework.lookup(self.req,"#401",[]);self.subscribe.exception=problem;self.subscribe.execute(401);return self};Controller.prototype.throw403=function(problem){return this.view403(problem)};Controller.prototype.view403=function(problem){var self=this;if(problem&&problem.length>0)self.problem(problem);if(self.res.success||!self.isConnected)return self;self.req.path=[];self.subscribe.success();self.subscribe.route=framework.lookup(self.req,"#403",[]);self.subscribe.exception=problem;self.subscribe.execute(403);return self};Controller.prototype.throw404=function(problem){return this.view404(problem)};Controller.prototype.view404=function(problem){var self=this;if(problem&&problem.length>0)self.problem(problem);if(self.res.success||!self.isConnected)return self;self.req.path=[];self.subscribe.success();self.subscribe.route=framework.lookup(self.req,"#404",[]);self.subscribe.exception=problem;self.subscribe.execute(404);return self};Controller.prototype.view500=function(error){var self=this;framework.error(typeof error===STRING?new Error(error):error,self.name,self.req.uri);if(self.res.success||!self.isConnected)return self;self.req.path=[];self.subscribe.exception=error;self.subscribe.success();self.subscribe.route=framework.lookup(self.req,"#500",[]);self.subscribe.exception=error;self.subscribe.execute(500);return self};Controller.prototype.throw500=function(error){return this.view500(error)};Controller.prototype.view501=function(problem){var self=this;if(problem&&problem.length>0)self.problem(problem);if(self.res.success||!self.isConnected)return self;self.req.path=[];self.subscribe.success();self.subscribe.route=framework.lookup(self.req,"#501",[]);self.subscribe.exception=problem;self.subscribe.execute(501);return self};Controller.prototype.throw501=function(problem){return this.view501(problem)};Controller.prototype.redirect=function(url,permanent){var self=this;if(self.res.success||!self.isConnected)return self;self.subscribe.success();self.req.clear(true);self.res.success=true;self.res.writeHead(permanent?301:302,{Location:url});self.res.end();framework._request_stats(false,false);framework.emit("request-end",self.req,self.res);framework.stats.response.redirect++;return self};Controller.prototype.redirectAsync=function(url,permanent){var self=this;var fn=function(){self.redirect(url,permanent)};self.async.complete(fn);return self};Controller.prototype.binary=function(buffer){var self=this;var res=self.res;if(res.success||!self.isConnected)return self;var req=self.req;self.subscribe.success();req.clear(true);res.success=true;res.write(buffer.toString("binary"),"binary");res.end();framework._request_stats(false,false);framework.emit("request-end",req,res);framework.stats.response.binary++;return self};Controller.prototype.baa=function(name){var self=this;var authorization=self.req.headers["authorization"]||"";if(authorization===""){self.res.setHeader("WWW-Authenticate",'Basic realm="'+(name||"Administration")+'"');self.view401();return null}return self.req.authorization()};Controller.prototype.sse=function(data,eventname,id,retry){var self=this;var res=self.res;if(!self.isConnected)return self;if(self.type===0&&res.success)throw new Error("Response was sent.");if(self.type>0&&self.type!==1)throw new Error("Response was used.");if(self.type===0){self.type=1;if(retry===undefined)retry=self.subscribe.route.timeout;self.subscribe.success();self.req.on("close",self.close.bind(self));res.success=true;var headers={Pragma:"no-cache"};headers[RESPONSE_HEADER_CACHECONTROL]="no-cache, no-store, max-age=0, must-revalidate";headers[RESPONSE_HEADER_CONTENTTYPE]="text/event-stream";res.writeHead(self.status,headers)}if(typeof data===OBJECT)data=JSON.stringify(data);else data=data.replace(/\n/g,"\\n").replace(/\r/g,"\\r");var newline="\n";var builder="";if(eventname&&eventname.length>0)builder="event: "+eventname+newline;builder+="data: "+data+newline;if(id&&id.toString().length>0)builder+="id: "+id+newline;if(retry&&retry>0)builder+="retry: "+retry+newline;builder+=newline;res.write(builder);framework.stats.response.sse++;return self};Controller.prototype.mmr=function(filename,stream,cb){var self=this;var res=self.res;if(!self.isConnected)return self;if(self.type===0&&res.success)throw new Error("Response was sent.");if(self.type>0&&self.type!==2)throw new Error("Response was used.");if(self.type===0){self.type=2;self.boundary="----totaljs"+utils.GUID(10);self.subscribe.success();res.success=true;self.req.on("close",self.close.bind(self));var headers={Pragma:"no-cache"};headers[RESPONSE_HEADER_CONTENTTYPE]="multipart/x-mixed-replace; boundary="+self.boundary;headers[RESPONSE_HEADER_CACHECONTROL]="no-cache, no-store, max-age=0, must-revalidate";res.writeHead(self.status,headers)}var type=typeof stream;if(type===TYPE_FUNCTION){cb=stream;stream=null}res.write("--"+self.boundary+"\r\n"+RESPONSE_HEADER_CONTENTTYPE+": "+utils.getContentType(path.extname(filename))+"\r\n\r\n");if(stream!==undefined&&stream!==null){stream.on("end",function(){self=null;if(cb)cb()});stream.pipe(res,{end:false});framework.stats.response.mmr++;return self}stream=fs.createReadStream(filename);stream.on("end",function(){self=null;if(cb)cb()});stream.pipe(res,{end:false});framework.stats.response.mmr++;return self};Controller.prototype.close=function(end){var self=this;if(end===undefined)end=true;if(!self.isConnected)return self;if(self.type===0){self.isConnected=false;if(!self.res.success){self.res.success=true;if(end)self.res.end();framework._request_stats(false,false);framework.emit("request-end",self.req,self.res)}return self}if(self.type===2)self.res.write("\r\n\r\n--"+self.boundary+"--");self.isConnected=false;self.res.success=true;if(end)self.res.end();framework._request_stats(false,false);framework.emit("request-end",self.req,self.res);self.type=0;return self};Controller.prototype.proxy=function(url,obj,fnCallback,timeout){var self=this;var headers={"X-Proxy":"total.js"};var tmp;if(typeof fnCallback===NUMBER){tmp=timeout;timeout=fnCallback;fnCallback=tmp}if(typeof obj===TYPE_FUNCTION){tmp=fnCallback;fnCallback=obj;obj=tmp}return utils.request(url,["post","json"],obj,function(error,data,code,headers){if(!fnCallback)return;if((headers["content-type"]||"").indexOf("application/json")!==-1)data=JSON.parse(data);fnCallback.call(self,error,data,code,headers)},null,headers,ENCODING,timeout||1e4)};Controller.prototype.database=function(){if(typeof framework.database===OBJECT)return framework.database;return framework.database.apply(framework,arguments)};Controller.prototype.view=function(name,model,headers,isPartial){var self=this;if(isPartial===undefined&&typeof headers===BOOLEAN){isPartial=headers;headers=null}if(!isPartial&&self.res&&self.res.success)return self;var skip=name[0]==="/"?1:name[0]==="~"?2:0;var filename=name;var isLayout=self.isLayout;self.isLayout=false;if(!self.isLayout&&skip===0)filename=self._currentView+name;if(skip===2)filename=name.substring(1);var generator=framework_internal.generateView(name,filename);if(generator===null){var err=new Error('View "'+filename+'" not found.');if(isPartial){framework.error(err,self.name,self.uri);return self.outputPartial}if(isLayout){self.subscribe.success();framework.response500(self.req,self.res,err);return}self.view500(err);return}var value="";self.$model=model;var sitemap=function(){return self.sitemap.apply(self,arguments)};if(isLayout){self._currentCSS=self._defaultCSS||"";self._currentJS=self._defaultJS||"";self._currentDownload=self._defaultDownload||"";self._currentVideo=self._defaultVideo||"";self._currentImage=self._defaultImage||"";self._currentView=self._defaultView||""}var helpers=framework.helpers;try{value=generator.call(self,self,self.repository,model,self.session,self.get,self.post,self.url,framework.global,helpers,self.user,self.config,framework.functions,0,sitemap,isPartial?self.outputPartial:self.output,self.date)}catch(ex){var err=new Error("View: "+name+" - "+ex.toString());if(!isPartial){self.view500(err);return}self.error(err);if(self.isPartial){value=self.outputPartial;self.outputPartial=""}else{value=self.output;self.output=""}isLayout=false;return value}if(!isLayout&&self.precache&&self.status===200)self.precache(value,CONTENTTYPE_TEXTHTML,headers,true);if(isLayout||utils.isNullOrEmpty(self.layoutName)){self.outputPartial="";self.output="";isLayout=false;if(isPartial)return value;self.subscribe.success();if(!self.isConnected)return;framework.responseContent(self.req,self.res,self.status,value,CONTENTTYPE_TEXTHTML,self.config["allow-gzip"],headers);framework.stats.response.view++;return self}if(isPartial)self.outputPartial=value;else self.output=value;self.isLayout=true;value=self.view(self.layoutName,self.$model,headers,isPartial);if(isPartial){self.outputPartial="";self.isLayout=false;return value}return self};Controller.prototype.memorize=function(key,expires,disabled,fnTo,fnFrom){var self=this;var output=self.cache.read(key);if(output===null){if(disabled===true){fnTo();return self}self.precache=function(value,contentType,headers,isView){var options={content:value,type:contentType};if(headers)options.headers=headers;if(isView){var keys=Object.keys(self.repository);var length=keys.length;options.repository=[];for(var i=0;i<length;i++){var name=keys[i];if(name[0]==="$"||name==="sitemap"){var value=self.repository[name];if(value)options.repository.push({key:name,value:value})}}}self.cache.add(key,options,expires);self.precache=null};if(typeof disabled===TYPE_FUNCTION)fnTo=disabled;fnTo();return self}if(typeof disabled===TYPE_FUNCTION){var tmp=fnTo;fnTo=disabled;fnFrom=tmp}if(fnFrom)fnFrom();if(output.type!==CONTENTTYPE_TEXTHTML)framework.responseContent(self.req,self.res,self.status,output.content,output.type,self.config["allow-gzip"],output.headers);switch(output.type){case CONTENTTYPE_TEXTPLAIN:framework.stats.response.plain++;return self;case"application/json":framework.stats.response.json++;return self;case CONTENTTYPE_TEXTHTML:framework.stats.response.view++;break}var length=output.repository.length;for(var i=0;i<length;i++)self.repository[output.repository[i].key]=output.repository[i].value;if(utils.isNullOrEmpty(self.layoutName)){self.subscribe.success();if(!self.isConnected)return self;framework.responseContent(self.req,self.res,self.status,output.content,output.type,self.config["allow-gzip"],output.headers);return self}self.output=output.content;self.isLayout=true;self.view(self.layoutName,null);return self};Controller.prototype.viewAsync=function(name,model,headers){var self=this;var fn=function(){self.view(name,model,headers)};self.async.complete(fn);return self};var NEWLINE="\r\n";var SOCKET_RESPONSE="HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nX-Powered-By: {0}\r\nSec-WebSocket-Accept: {1}\r\n\r\n";var SOCKET_RESPONSE_ERROR="HTTP/1.1 403 Forbidden\r\nConnection: close\r\nX-WebSocket-Reject-Reason: 403 Forbidden\r\n\r\n";var SOCKET_HASH="258EAFA5-E914-47DA-95CA-C5AB0DC85B11";var SOCKET_ALLOW_VERSION=[13];function WebSocket(framework,path,name,id){this._keys=[];this.id=id;this.online=0;this.connections={};this.repository={};this.name=name;this.isController=true;this.url=utils.path(path);events.EventEmitter.call(this)}WebSocket.prototype={get global(){return framework.global},get config(){return framework.config},get cache(){return framework.cache},get isDebug(){return framework.config.debug},get path(){return framework.path},get fs(){return framework.fs},get isSecure(){return this.req.isSecure},get async(){var self=this;if(typeof self._async===UNDEFINED)self._async=new utils.Async(self);return self._async}};WebSocket.prototype.__proto__=Object.create(events.EventEmitter.prototype,{constructor:{value:WebSocket,enumberable:false}});WebSocket.prototype.date=function(type,d1,d2){if(d2===undefined){d2=d1;d1=new Date}var beg=typeof d1===STRING?d1.parseDate():d1;var end=typeof d2===STRING?d2.parseDate():d2;var r=beg.compare(end);switch(type){case">":return r===1;case">=":case"=>":return r===1||r===0;case"<":return r===-1;case"<=":case"=<":return r===-1||r===0;case"=":return r===0}return true};WebSocket.prototype.send=function(message,id,blacklist){var self=this;var keys=self._keys;var length=keys.length;if(length===0)return self;var fn=typeof blacklist===TYPE_FUNCTION?blacklist:null;var is=blacklist instanceof Array;if(id===undefined||id===null||id.length===0){for(var i=0;i<length;i++){var _id=keys[i];if(is&&blacklist.indexOf(_id)!==-1)continue;var conn=self.connections[_id];if(fn!==null&&!fn.call(self,_id,conn))continue;conn.send(message);framework.stats.response.websocket++}self.emit("send",message,null,[]);return self}fn=typeof id===TYPE_FUNCTION?id:null;is=id instanceof Array;for(var i=0;i<length;i++){var _id=keys[i];if(is&&id.indexOf(_id)===-1)continue;var conn=self.connections[_id];if(fn!==null&&!fn.call(self,_id,conn)===-1)continue;conn.send(message);framework.stats.response.websocket++}self.emit("send",message,id,blacklist);return self};WebSocket.prototype.ping=function(){var self=this;var keys=self._keys;var length=keys.length;if(length===0)return self;for(var i=0;i<length;i++)self.connections[keys[i]].ping();return self};WebSocket.prototype.close=function(id,message,code){var self=this;var keys=self._keys;if(typeof id===STRING){code=message;message=id;id=null}if(keys===null)return self;var length=keys.length;if(length===0)return self;if(id===undefined||id===null||id.length===0){for(var i=0;i<length;i++){var _id=keys[i];self.connections[_id].close(message,code);self._remove(_id)}self._refresh();return self}var is=id instanceof Array;var fn=typeof id===TYPE_FUNCTION?id:null;for(var i=0;i<length;i++){var _id=keys[i];if(is&&id.indexOf(_id)===-1)continue;var conn=self.connections[_id];if(fn!==null&&!fn.call(self,_id,conn))continue;conn.close(message,code);self._remove(_id)}self._refresh();return self};WebSocket.prototype.error=function(err){var self=this;var result=framework.error(typeof err===STRING?new Error(err):err,self.name,self.path);if(err===undefined)return result;return self};WebSocket.prototype.problem=function(message){var self=this;framework.problem(message,self.name,self.uri);return self};WebSocket.prototype.change=function(message){var self=this;framework.change(message,self.name,self.uri,self.ip);return self};WebSocket.prototype.all=function(fn){var self=this;var length=self._keys.length;for(var i=0;i<length;i++){var id=self._keys[i];if(fn(self.connections[id],i))break}return self};WebSocket.prototype.find=function(id){var self=this;var length=self._keys.length;var isFn=typeof id===TYPE_FUNCTION;for(var i=0;i<length;i++){var connection=self.connections[self._keys[i]];if(!isFn){if(connection.id===id)return connection;continue}if(id(connection,connection.id))return connection}return null};WebSocket.prototype.destroy=function(){var self=this;if(self.connections===null&&self._keys===null)return self;self.close();self.connections=null;self._keys=null;delete framework.connections[self.id];self.emit("destroy");return self};WebSocket.prototype.proxy=function(url,obj,fnCallback){var self=this;var headers={"X-Proxy":"total.js"};if(typeof obj===TYPE_FUNCTION){var tmp=fnCallback;fnCallback=obj;obj=tmp}return utils.request(url,["post","json"],obj,function(error,data,code,headers){if(!fnCallback)return;if((headers["content-type"]||"").indexOf("application/json")!==-1)data=JSON.parse(data);fnCallback.call(self,error,data,code,headers)},headers)};WebSocket.prototype._refresh=function(){var self=this;self._keys=Object.keys(self.connections);self.online=self._keys.length;return self};WebSocket.prototype._remove=function(id){var self=this;delete self.connections[id];return self};WebSocket.prototype._add=function(client){var self=this;self.connections[client._id]=client;return self};WebSocket.prototype.module=function(name){return framework.module(name)};WebSocket.prototype.model=function(name){return framework.model(name)};WebSocket.prototype.helper=function(name){var self=this;var helper=framework.helpers[name]||null;if(helper===null)return"";var length=arguments.length;var params=[];for(var i=1;i<length;i++)params.push(arguments[i]);return helper.apply(self,params)};WebSocket.prototype.functions=function(name){return(framework.controllers[name]||{}).functions};WebSocket.prototype.database=function(){if(typeof framework.database===OBJECT)return framework.database;return framework.database.apply(framework,arguments)};WebSocket.prototype.resource=function(name,key){return framework.resource(name,key)};WebSocket.prototype.log=function(){var self=this;framework.log.apply(framework,arguments);return self};WebSocket.prototype.validation=function(model,properties,prefix,name){return this.validate(model,properties,prefix,name)};WebSocket.prototype.validate=function(model,properties,prefix,name){var self=this;var resource=function(key){return self.resource(name||"default",(prefix||"")+key)};var error=new builders.ErrorBuilder(resource);return utils.validate.call(self,model,properties,framework.onValidation,error)};WebSocket.prototype.wait=function(name,waitingFor,fn){var self=this;self.async.wait(name,waitingFor,fn);return self};WebSocket.prototype.complete=function(callback){var self=this;return self.complete(callback)};WebSocket.prototype.await=function(name,fn){var self=this;self.async.await(name,fn);return self};function WebSocketClient(req,socket,head){this.handlers={ondata:this._ondata.bind(this),onerror:this._onerror.bind(this),onclose:this._onclose.bind(this)};this.container=null;this._id=null;this.id="";this.socket=socket;this.req=req;this.isClosed=false;this.isWebSocket=true;this.errors=0;this.buffer=new Buffer(0);this.length=0;this.cookie=req.cookie.bind(req);this.type=2;this._isClosed=false}WebSocketClient.prototype={get protocol(){return(this.req.headers["sec-websocket-protocol"]||"").replace(/\s/g,"").split(",")},get ip(){return this.req.ip},get get(){return this.req.query},get query(){return this.req.query
},get uri(){return this.req.uri},get config(){return this.container.config},get global(){return this.container.global},get session(){return this.req.session},set session(value){this.req.session=value},get user(){return this.req.user},set user(value){this.req.user=value}};WebSocketClient.prototype.__proto__=Object.create(events.EventEmitter.prototype,{constructor:{value:WebSocketClient,enumberable:false}});WebSocketClient.prototype.prepare=function(flags,protocols,allow,length,version){var self=this;flags=flags||[];protocols=protocols||[];allow=allow||[];self.length=length;var origin=self.req.headers["origin"]||"";if(allow.length>0){if(allow.indexOf("*")===-1){for(var i=0;i<allow.length;i++){if(origin.indexOf(allow[i])===-1)return false}}}else{if(origin.indexOf(self.req.headers.host)===-1)return false}if(protocols.length>0){for(var i=0;i<protocols.length;i++){if(self.protocol.indexOf(protocols[i])===-1)return false}}if(SOCKET_ALLOW_VERSION.indexOf(utils.parseInt(self.req.headers["sec-websocket-version"]))===-1)return false;self.socket.write(new Buffer(SOCKET_RESPONSE.format("total.js v"+version,self._request_accept_key(self.req)),"binary"));self._id=(self.ip||"").replace(/\./g,"")+utils.GUID(20);self.id=self._id;return true};WebSocketClient.prototype.upgrade=function(container){var self=this;self.container=container;self.socket.setKeepAlive(true,0);self.socket.on("data",self.handlers.ondata);self.socket.on("error",self.handlers.onerror);self.socket.on("close",self.handlers.onclose);self.socket.on("end",self.handlers.onclose);self.container._add(self);self.container._refresh();framework.emit("websocket-begin",self.container,self);self.container.emit("open",self);return self};WebSocketClient.prototype._ondata=function(data){var self=this;if(data!=null)self.buffer=Buffer.concat([self.buffer,data]);if(self.buffer.length>self.length){self.errors++;self.container.emit("error",new Error("Maximum request length exceeded."),self);return}switch(self.buffer[0]&15){case 1:if(self.type!==1)self.parse();break;case 2:if(self.type===1)self.parse();break;case 8:self.close();break;case 9:self.socket.write(utils.getWebSocketFrame(0,"",10));self.buffer=new Buffer(0);break;case 10:self.buffer=new Buffer(0);break}};WebSocketClient.prototype.parse=function(){var self=this;var bLength=self.buffer[1];if((bLength&128)>>7!==1)return self;var length=utils.getMessageLength(self.buffer,framework.isLE);var index=self.buffer[1]&127;index=index==126?4:index==127?10:2;if(index+length+4>self.buffer.length)return self;var mask=new Buffer(4);self.buffer.copy(mask,0,index,index+4);if(self.type!==1){var output="";for(var i=0;i<length;i++)output+=String.fromCharCode(self.buffer[index+4+i]^mask[i%4]);if(self.type===3){try{self.container.emit("message",self,JSON.parse(self.container.config["default-websocket-encodedecode"]===true?decodeURIComponent(output):output))}catch(ex){self.errors++;self.container.emit("error",new Error("JSON parser: "+ex.toString()),self)}}else self.container.emit("message",self,self.container.config["default-websocket-encodedecode"]===true?decodeURIComponent(output):output)}else{var binary=new Buffer(length);for(var i=0;i<length;i++)binary.write(self.buffer[index+4+i]^mask[i%4]);self.container.emit("message",self,binary)}self.buffer=self.buffer.slice(index+length+4,self.buffer.length);if(self.buffer.length>=2)self.parse();return self};WebSocketClient.prototype._onerror=function(error){var self=this;if(error.stack.indexOf("ECONNRESET")!==-1||error.stack.indexOf("socket is closed")!==-1||error.stack.indexOf("EPIPE")!==-1)return;self.container.emit("error",error,self)};WebSocketClient.prototype._onclose=function(){var self=this;if(self._isClosed)return;self._isClosed=true;self.container._remove(self._id);self.container._refresh();self.container.emit("close",self);framework.emit("websocket-end",self.container,self)};WebSocketClient.prototype.send=function(message){var self=this;if(self.isClosed)return self;if(self.type!==1){var data=self.type===3?JSON.stringify(message):(message||"").toString();if(self.container.config["default-websocket-encodedecode"]===true&&data.length>0)data=encodeURIComponent(data);self.socket.write(utils.getWebSocketFrame(0,data,1))}else{if(message!==null)self.socket.write(utils.getWebSocketFrame(0,message,2))}return self};WebSocketClient.prototype.ping=function(){var self=this;if(self.isClosed)return self;self.socket.write(utils.getWebSocketFrame(0,"",9));return self};WebSocketClient.prototype.close=function(message,code){var self=this;if(self.isClosed)return self;self.isClosed=true;self.socket.end(utils.getWebSocketFrame(code||1e3,message||"",8));return self};WebSocketClient.prototype._request_accept_key=function(req){var sha1=crypto.createHash("sha1");sha1.update((req.headers["sec-websocket-key"]||"")+SOCKET_HASH);return sha1.digest("base64")};http.ServerResponse.prototype.cookie=function(name,value,expires,options){var builder=[name+"="+encodeURIComponent(value)];var type=typeof expires;if(expires&&!utils.isDate(expires)&&type===OBJECT){options=expires;expires=options.expires||options.expire||null}if(type===STRING)expires=expires.parseDateExpire();if(!options)options={};options.path=options.path||"/";if(expires)builder.push("Expires="+expires.toUTCString());if(options.domain)builder.push("Domain="+options.domain);if(options.path)builder.push("Path="+options.path);if(options.secure)builder.push("Secure");if(options.httpOnly||options.httponly||options.HttpOnly)builder.push("HttpOnly");var self=this;var arr=self.getHeader("set-cookie")||[];arr.push(builder.join("; "));self.setHeader("Set-Cookie",arr);return self};http.ServerResponse.prototype.noCache=function(){var self=this;self.removeHeader("Etag");self.removeHeader("Last-Modified");return self};http.ServerResponse.prototype.send=function(code,body,type){var self=this;if(self.headersSent)return self;var res=self;var req=self.req;var contentType=type;if(body===undefined){body=code;code=200}switch(typeof body){case STRING:if(!contentType)contentType="text/html";break;case NUMBER:if(!contentType)contentType="text/plain";body=utils.httpStatus(body);break;case BOOLEAN:case OBJECT:if(!contentType)contentType="application/json";if(body instanceof builders.ErrorBuilder)body=obj.output();body=JSON.stringify(body);break}var accept=req.headers["accept-encoding"]||"";var headers={};headers[RESPONSE_HEADER_CACHECONTROL]="private";headers["Vary"]="Accept-Encoding";if(contentType==="application/json")headers[RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate";if(/text|application/.test(contentType))contentType+="; charset=utf-8";headers[RESPONSE_HEADER_CONTENTTYPE]=contentType;framework.responseCustom(req,res);if(accept.lastIndexOf("gzip")!==-1){var buffer=new Buffer(body);zlib.gzip(buffer,function(err,data){if(err){res.writeHead(code,headers);res.end(body,ENCODING);return}headers["Content-Encoding"]="gzip";headers[RESPONSE_HEADER_CONTENTLENGTH]=data.length;res.writeHead(code,headers);res.end(data,ENCODING)});return self}headers[RESPONSE_HEADER_CONTENTLENGTH]=body.length;res.writeHead(code,headers);res.end(body,ENCODING);return self};http.ServerResponse.prototype.continue=function(){var self=this;if(self.headersSent)return;framework.responseStatic(self.req,self);return self};http.ServerResponse.prototype.file=function(filename,downloadName,headers){var self=this;if(self.headersSent)return;framework.responseFile(self.req,self,filename,downloadName,headers);return self};http.ServerResponse.prototype.stream=function(contentType,stream,downloadName,headers){var self=this;if(self.headersSent)return;framework.responseStream(self.req,self,contentType,stream,downloadName,headers);return self};http.ServerResponse.prototype.image=function(filename,fnProcess,headers){var self=this;if(self.headersSent)return;framework.responseImage(self.req,self,filename,fnProcess,headers);return self};http.ServerResponse.prototype.json=function(obj){var self=this;return self.send(200,obj,"application/json")};var _tmp=http.IncomingMessage.prototype;http.IncomingMessage.prototype={get ip(){var self=this;var proxy=self.headers["x-forwarded-for"];if(proxy!==undefined)return proxy.split(",",1)[0]||self.connection.removiewddress;return self.connection.remoteAddress},get query(){var self=this;if(self._dataGET)return self._dataGET;self._dataGET=qs.parse(self.uri.query);return self._dataGET},get subdomain(){var self=this;if(self._subdomain)return self._subdomain;var subdomain=self.uri.host.toLowerCase().replace(/^www\./i,"").split(".");if(subdomain.length>2)self._subdomain=subdomain.slice(0,subdomain.length-2);else self._subdomain=null;return self._subdomain},get host(){return this.headers["host"]},get isSecure(){return this.uri.protocol==="https"||this.uri.protocol==="wss"},get language(){return((this.headers["accept-language"].split(";")[0]||"").split(",")[0]||"").toLowerCase()}};http.IncomingMessage.prototype.__proto__=_tmp;http.IncomingMessage.prototype.signature=function(key){var self=this;return framework.encrypt((self.headers["user-agent"]||"")+"#"+self.ip+"#"+self.url+"#"+(key||""),"request-signature",false)};http.IncomingMessage.prototype.noCache=function(){var self=this;delete self.headers["if-none-match"];delete self.headers["if-modified-since"];return self};http.IncomingMessage.prototype.cookie=function(name){var self=this;if(self.cookies!==undefined)return decodeURIComponent(self.cookies[name]||"");self.cookies={};var cookie=self.headers["cookie"]||"";if(cookie.length===0)return"";var arr=cookie.split(";");var length=arr.length;for(var i=0;i<length;i++){var c=arr[i].trim().split("=");self.cookies[c.shift()]=c.join("=")}return decodeURIComponent(self.cookies[name]||"")};http.IncomingMessage.prototype.authorization=function(){var self=this;var authorization=self.headers["authorization"]||"";var result={name:"",password:""};if(authorization==="")return result;var arr=new Buffer(authorization.replace("Basic ","").trim(),"base64").toString(ENCODING).split(":");result.name=arr[0]||"";result.password=arr[1]||"";return result};http.IncomingMessage.prototype.clear=function(isAuto){var self=this;var files=self.files;if(!files)return self;if(isAuto&&self._manual)return self;var length=files.length;if(length===0)return self;var arr=[];for(var i=0;i<length;i++)arr.push(files[i].path);framework.unlink(arr);self.files=null;return self};http.IncomingMessage.prototype.hostname=function(path){var self=this;var uri=self.uri;if(path!==undefined){if(path[0]!=="/")path="/"+path}return uri.protocol+"//"+uri.hostname+(uri.port!==null&&uri.port!==undefined&&uri.port!==80?":"+uri.port:"")+(path||"")};global.framework=module.exports=new Framework;process.on("uncaughtException",function(e){if(e.toString().indexOf("listen EADDRINUSE")!==-1){if(typeof process.send===TYPE_FUNCTION)process.send("eaddrinuse");console.log("\nIP address and PORT is already in use.\nYou must change the PORT's number or IP address.\n");process.exit(1);return}if(framework.isTest){if(framework.testContinue)framework.testContinue(e);return}framework.error(e,"",null)});process.on("SIGTERM",function(){framework.stop()});process.on("SIGINT",function(){framework.stop()});process.on("exit",function(){if(framework.onExit)framework.onExit(framework);framework.emit("exit")});process.on("message",function(msg,h){if(typeof msg!==STRING){framework.emit("message",msg,h);return}if(msg==="debugging"){framework.console();framework.console=utils.noop;return}if(msg==="reconnect"){framework.reconnect();return}if(msg==="reconfigure"){framework._configure();framework._configure_versions();framework.emit(msg);return}if(msg==="reset"){framework.clear();framework.cache.clear();return}if(msg==="stop"||msg==="exit"){framework.stop();return}framework.emit("message",msg,h)});