// Copyright 2012-2017 (c) Peter Å irka <petersirka@gmail.com>
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

'use strict';function Framework(){this.id=null,this.version=2500,this.version_header='2.5.0',this.version_node=process.version.toString().replace('v','').replace(/\./g,'').parseFloat(),this.config={debug:!1,trace:!0,'trace-console':!0,name:'Total.js',version:'1.0.0',author:'',secret:Os.hostname()+'-'+Os.platform()+'-'+Os.arch(),'default-xpoweredby':'Total.js','etag-version':'','directory-controllers':'/controllers/','directory-components':'/components/','directory-views':'/views/','directory-definitions':'/definitions/','directory-temp':'/tmp/','directory-models':'/models/','directory-resources':'/resources/','directory-public':'/public/','directory-public-virtual':'/app/','directory-modules':'/modules/','directory-source':'/source/','directory-logs':'/logs/','directory-tests':'/tests/','directory-databases':'/databases/','directory-workers':'/workers/','directory-packages':'/packages/','directory-private':'/private/','directory-isomorphic':'/isomorphic/','directory-configs':'/configs/','directory-services':'/services/','directory-themes':'/themes/','static-url':'','static-url-script':'/js/','static-url-style':'/css/','static-url-image':'/img/','static-url-video':'/video/','static-url-font':'/fonts/','static-url-download':'/download/','static-url-components':'/components.','static-accepts':{flac:!0,jpg:!0,png:!0,gif:!0,ico:!0,js:!0,css:!0,txt:!0,xml:!0,woff:!0,woff2:!0,otf:!0,ttf:!0,eot:!0,svg:!0,zip:!0,rar:!0,pdf:!0,docx:!0,xlsx:!0,doc:!0,xls:!0,html:!0,htm:!0,appcache:!0,manifest:!0,map:!0,ogv:!0,ogg:!0,mp4:!0,mp3:!0,webp:!0,webm:!0,swf:!0,package:!0,json:!0,md:!0,m4v:!0,jsx:!0},'default-layout':'layout','default-theme':'','default-request-length':10,'default-websocket-request-length':2,'default-websocket-encodedecode':!0,'default-maximum-file-descriptors':0,'default-timezone':'','default-root':'','default-response-maxage':'11111111','default-cors-maxage':120,'default-request-timeout':5e3,'default-image-converter':'gm','default-image-quality':93,'default-image-consumption':30,'allow-handle-static-files':!0,'allow-gzip':!0,'allow-websocket':!0,'allow-compile-script':!0,'allow-compile-style':!0,'allow-compile-html':!0,'allow-performance':!1,'allow-custom-titles':!1,'allow-cache-snapshot':!1,'allow-defer':!1,'allow-debug':!1,'allow-head':!1,'disable-strict-server-certificate-validation':!0,'disable-clear-temporary-directory':!1,'default-interval-clear-resources':20,'default-interval-clear-cache':10,'default-interval-precompile-views':61,'default-interval-websocket-ping':3,'default-interval-clear-dnscache':120,'default-interval-uptodate':5},this.global={},this.resources={},this.connections={},this.functions={},this.themes={},this.versions=null,this.workflows={},this.uptodates=null,this.schedules=[],this.isDebug=!0,this.isTest=!1,this.isLoaded=!1,this.isWorker=!0,this.isCluster=!process.env.PASSENGER_APP_ENV&&require('cluster').isWorker,this.routes={sitemap:null,web:[],files:[],cors:[],websockets:[],middleware:{},redirects:{},resize:{},request:[],views:{},merge:{},mapping:{},packages:{},blocks:{},resources:{},mmr:{}},this.owners=[],this.modificators=null,this.helpers={},this.modules={},this.models={},this.sources={},this.controllers={},this.dependencies={},this.isomorphic={},this.components={has:!1,css:!1,js:!1,views:{},instances:{},version:null,links:''},this.convertors=[],this.tests=[],this.errors=[],this.problems=[],this.changes=[],this.server=null,this.port=0,this.ip='',this.validators={email:new RegExp('^[a-zA-Z0-9-_.+]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$'),url:/^(https?:\/\/(?:www\.|(?!www))[^\s\.#!:\?\+=&@!$'~*,;\/\(\)\[\]]+\.[^\s#!\?\+=&@!$'~*,;\(\)\[\]\\]{2,}\/?|www\.[^\s#!:\.\?\+=&@!$'~*,;\/\(\)\[\]]+\.[^\s#!\?\+=&@!$'~*,;\(\)\[\]\\]{2,}\/?)/i,phone:/^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$/im,zip:/^\d{5}(?:[-\s]\d{4})?$/,uid:/^\d{14,}[a-z]{3}[01]{1}$/},this.workers={},this.databases={},this.directory=HEADERS.workers.cwd=directory,this.isLE=!Os.endianness||'LE'===Os.endianness(),this.isHTTPS=!1,this.datetime=new Date,this.temporary={path:{},notfound:{},processing:{},range:{},views:{},versions:{},dependencies:{},other:{},internal:{},owners:{},ready:{},defer:{}},this.stats={other:{websocketPing:0,websocketCleaner:0,obsolete:0,restart:0,mail:0},request:{request:0,pending:0,web:0,xhr:0,file:0,websocket:0,get:0,options:0,head:0,post:0,put:0,path:0,upload:0,schema:0,mmr:0,blocked:0,delete:0,mobile:0,desktop:0},response:{view:0,json:0,websocket:0,timeout:0,custom:0,binary:0,pipe:0,file:0,image:0,destroy:0,stream:0,streaming:0,plain:0,empty:0,redirect:0,forward:0,notModified:0,sse:0,mmr:0,errorBuilder:0,error400:0,error401:0,error403:0,error404:0,error408:0,error431:0,error500:0,error501:0}},this.cache=new FrameworkCache,this.path=new FrameworkPath,this._request_check_redirect=!1,this._request_check_referer=!1,this._request_check_POST=!1,this._request_check_robot=!1,this._length_middleware=0,this._length_request_middleware=0,this._length_files=0,this._length_wait=0,this._length_themes=0,this._length_cors=0,this._length_subdomain_web=0,this._length_subdomain_websocket=0,this._length_convertors=0,this.isVirtualDirectory=!1,this.isTheme=!1,this.isWindows='win'===Os.platform().substring(0,3).toLowerCase(),this.$events={}}function scriptNow(){return new Date}function flags_to_object(e){var t={};return e.forEach(function(e){t[e]=!0}),t}function merge_middleware(e,t,r){'string'==typeof t&&(t=[t]);for(var n=0,o=t.length;n<o;n++){var i=e.indexOf(t[n]);i===-1&&(r?e.unshift(t[n]):e.push(t[n]))}return e}function onSchema_callback(e,t,r){e?r(e):r(null,t)}function merge_debug_writer(e,t,r,n,o){var i='===========================================================================================',s='js'===r?'/*\n':'css'===r?'/*!\n':'<!--\n',a='js'===r||'css'===r?'\n */':'\n-->',c='html'!==r?' * ':' ';e.write((n>0?'\n\n':'')+s+c+i+'\n'+c+'MERGED: '+t+'\n'+(o?c+'BLOCKS: '+o+'\n':'')+c+i+a+'\n\n',ENCODING)}function component_debug(e,t,r){var n='===========================================================================================',o='js'===r?'/*\n':'css'===r?'/*!\n':'<!--\n',i='js'===r||'css'===r?'\n */':'\n-->',s='html'!==r?' * ':' ';return o+s+n+'\n'+s+'COMPONENT: '+e+'\n'+s+n+i+'\n\n'+t}function connection_tunning(e){e.setNoDelay(!0),e.setKeepAlive(!0,10)}function requestcontinue_middleware(e,t){F.$requestcontinue(e,t,e.headers)}function cors_callback0(e,t){new Subscribe(F,e,t,0).end()}function cors_callback1(e,t){new Subscribe(framework,e,t,1).urlencoded()}function cors_callback_multipart(e,t,r){4===e.$type?F.$requestcontinue_mmr(e,t,r):new Subscribe(F,e,t,2).multipart(r)}function websocketcontinue_middleware(e){F.$websocketcontinue(e,e.$wspath,e.headers)}function next_upgrade_continue(e,t){e.upgrade(t)}function FrameworkRoute(){this.route={}}function FrameworkPath(){}function FrameworkCache(){this.items={},this.count=1,this.interval}function Subscribe(e,t,r){this.req=t,this.res=r,t.$subscribe=this}function subscribe_file(){this.$subscribe.doEndfile(this)}function subscribe_parse(e){this.$subscribe.doParsepost(e)}function subscribe_end(){this.$subscribe.doEnd()}function subscribe_timeout(e){e.controller&&e.controller.precache&&e.controller.precache(null,null,null),e.doCancel()}function subscribe_timeout_middleware(e,t,r){r.doExecute()}function subscribe_validate_callback(e,t){e.execute(t)}function Controller(e,t,r,n,o){this.subscribe=n,this.name=e,t?(this.language=t.$language,this.req=t):this.req=EMPTYREQUEST,this.type=0,this.status=200,this.isConnected=!0,this.isController=!0,this.repository={},this._currentView=o,r?(this.res=r,this.req.controller=this.res.controller=this):this.res=EMPTYOBJECT}function next_controller_invalid(e,t){e.content(t)}function querystring_encode(e,t){return null!=e?e instanceof Date?encodeURIComponent(e.format()):'string'==typeof e?encodeURIComponent(e):e.toString():t||''}function WebSocket(e,t,r){this._keys=[],this.id=r,this.online=0,this.connections={},this.repository={},this.name=t,this.isController=!0,this.url=U.path(e),this.route=null,this.$events={}}function websocket_valid_array(e,t){return t.indexOf(e)!==-1}function websocket_valid_fn(e,t,r){return!(!r||!r(e,t))}function WebSocketClient(e,t){this.$ping=!0,this.container,this._id,this.id='',this.socket=t,this.req=e,this.errors=0,this.buffer=U.createBufferSize(),this.length=0,this.type=2}function websocket_inflate(e){this.$websocket.inflatechunks.push(e),this.$websocket.inflatechunkslength+=e.length}function websocket_deflate(e){this.$websocket.deflatechunks.push(e),this.$websocket.deflatechunkslength+=e.length}function websocket_ondata(e){this.$websocket._ondata(e)}function websocket_onerror(e){this.$websocket._onerror(e)}function websocket_close(){this.$websocket._onclose()}function buffer_concat(e,t){for(var r=U.createBufferSize(t),n=0,o=0,i=e.length;o<i;o++)e[o].copy(r,n),n+=e[o].length;return r}function Backup(){this.file=[],this.directory=[],this.path='',this.read={key:U.createBufferSize(),value:U.createBufferSize(),status:0},this.pending=0,this.cache={},this.complete=NOOP,this.filter=function(){return!0},this.bufKey=U.createBuffer(':'),this.bufNew=U.createBuffer('\n')}function $continue_timeout(e){e.continue()}function $file_processing(e){e.$file()}function $file_notmodified(e,t){var r=e.req,n=HEADERS.file_lastmodified;e.getHeader('Last-Modified')?delete n['Last-Modified']:n['Last-Modified']=t[2],e.getHeader('Expires')?delete n.Expires:n.Expires=DATE_EXPIRES,e.getHeader('ETag')?delete n.Etag:n.Etag=ETAG+F.config['etag-version'],n[HEADER_TYPE]=U.getContentType(r.extension),e.writeHead(304,n),e.end(),F.stats.response.notModified++,response_end(e)}function $file_compress(e,t,r){framework_internal.onFinished(r,function(){framework_internal.destroyStream(e),t()}),e.pipe(Zlib.createGzip()).pipe(r),response_end(r)}function $file_nocompress(e,t,r){e.pipe(r),framework_internal.onFinished(r,function(){framework_internal.destroyStream(e),t()}),response_end(r)}function $file_range(e,t,r,n){var o=t.replace(REG_RANGE,'').split('-'),i=+o[0]||0,s=+o[1]||0,a=F.temporary.range[e];a||(a=Fs.statSync(e).size,RELEASE&&(F.temporary.range[e]=a)),0===s&&(s=a-1),i>s&&(i=0,s=a-1);var c=s-i+1;r[HEADER_LENGTH]=c,r['Content-Range']='bytes '+i+'-'+s+'/'+a;var u=n;return F.stats.response.streaming++,'HEAD'===u.method?(n.writeHead(206,r),n.end(),response_end(n),F):(n.writeHead(206,r),RANGE.start=i,RANGE.end=s,fsStreamRead(e,RANGE,$file_range_callback,n),F)}function $file_range_callback(e,t,r){framework_internal.onFinished(r,function(){framework_internal.destroyStream(e),t()}),e.pipe(r),response_end(r)}function $image_nocache(e){var t=e.options;if(t.stream){var r=framework_image.load(t.stream,IMAGEMAGICK);return t.make.call(r,r,e),t.type=U.getContentType(r.outputType),t.stream=r,F.stats.response.image++,e.$stream(),F}fsFileExists(t.filename,function(r){if(r){F.path.verify('temp');var n=framework_image.load(t.filename,IMAGEMAGICK);t.make.call(n,n,e),F.stats.response.image++,t.type=U.getContentType(n.outputType),t.stream=n,e.$stream()}else t.headers=null,e.throw404()})}function $image_processing(e){e.$image()}function $image_stream(e,t,r,n,o){var i=o.req,s=o.options;if(e)return delete F.temporary.processing[i.$key],F.temporary.path[i.$key]=[s.name,n.size,n.mtime.toUTCString()],o.options.filename=s.name,o.options.stream=null,o.$file(),void(DEBUG&&(F.temporary.path[i.$key]=void 0));F.path.verify('temp');var a=framework_image.load(s.stream,IMAGEMAGICK);if(s.make.call(a,a,o),i.extension=U.getExtension(s.name),i.extension!==a.outputType){var c=s.name.lastIndexOf('.'+i.extension);c!==-1?s.name=s.name.substring(0,c)+'.'+a.outputType:s.name+='.'+a.outputType}F.stats.response.image++,a.save(s.name,function(e){if(delete F.temporary.processing[i.$key],e)F.temporary.notfound[i.$key]=!0,o.throw500(e),DEBUG&&(F.temporary.notfound[i.$key]=void 0);else{var t=Fs.statSync(s.name);F.temporary.path[i.$key]=[s.name,t.size,t.mtime.toUTCString()],s.filename=s.name,o.$file()}})}function $image_filename(e,t,r,n,o){var i=o.req,s=o.options;if(!e)return delete F.temporary.processing[i.$key],F.temporary.notfound[i.$key]=!0,o.throw404(),void(DEBUG&&(F.temporary.notfound[i.$key]=void 0));F.path.verify('temp');var a=framework_image.load(s.filename,IMAGEMAGICK);if(s.make.call(a,a,o),i.extension=U.getExtension(s.name),i.extension!==a.outputType){var c=s.name.lastIndexOf('.'+i.extension);c===-1?s.name+='.'+a.outputType:s.name=s.name.substring(0,c)+'.'+a.outputType}F.stats.response.image++,a.save(s.name,function(e){if(delete F.temporary.processing[i.$key],e)F.temporary.notfound[i.$key]=!0,o.throw500(e),DEBUG&&(F.temporary.notfound[i.$key]=void 0);else{var t=Fs.statSync(s.name);F.temporary.path[i.$key]=[s.name,t.size,t.mtime.toUTCString()],o.options.filename=s.name,o.$file()}})}function response_end(e){F.reqstats(!1,e.req.isStaticFile),e.success=!0,!e.req.isStaticFile&&F.$events['request-end']&&F.emit('request-end',e.req,e),e.req.clear(!0),e.controller&&e.controller.subscribe.success(),e.options.callback&&e.options.callback(),e.controller=null}function $decodeURIComponent(e){try{return decodeURIComponent(e)}catch(t){return e}}function fsFileRead(e,t,r,n,o){U.queue('F.files',F.config['default-maximum-file-descriptors'],function(i){Fs.readFile(e,function(e,s){i(),t(e,s,r,n,o)})})}function fsFileExists(e,t,r,n,o){U.queue('F.files',F.config['default-maximum-file-descriptors'],function(i){Fs.lstat(e,function(e,s){i(),t(!e&&s.isFile(),s?s.size:0,!!s&&s.isFile(),s,r,n,o)})})}function fsStreamRead(e,t,r,n,o){r||(r=t,t=void 0);var i;t?(i=HEADERS.fsStreamReadRange,i.start=t.start,i.end=t.end):i=HEADERS.fsStreamRead,U.queue('F.files',F.config['default-maximum-file-descriptors'],function(t){var s=Fs.createReadStream(e,i);s.on('error',NOOP),r(s,t,n,o)})}function createTemporaryKey(e){return(e.uri?e.uri.pathname:e).replace(REG_TEMPORARY,'-').substring(1)}function prepare_error(e){return RELEASE||!e?'':' :: '+(e instanceof ErrorBuilder?e.plain():e.stack?e.stack.toString():e.toString())}function prepare_filename(e){return'@'===e[0]?F.isWindows?U.combine(F.config['directory-temp'],e.substring(1)):F.path.package(e.substring(1)):U.combine('/',e)}function prepare_staticurl(e,t){if(!e)return e;if('~'===e[0]){if(t)return U.path(e.substring(1))}else if('//'===e.substring(0,2)||'http:/'===e.substring(0,6)||'https:/'===e.substring(0,7))return e;return e}function prepare_isomorphic(e,t){return'if(window["isomorphic"]===undefined)window.isomorphic=window.I={};isomorphic["'+e.replace(/\.js$/i,'')+'"]=(function(framework,F,U,utils,Utils,is_client,is_server){var module={},exports=module.exports={};'+t+';return exports;})(null,null,null,null,null,true,false)'}function isGZIP(e){var t=e.headers['user-agent'];return t&&t.lastIndexOf('Firefox')!==-1}function prepare_viewname(e){return e.substring(e.indexOf('/',2)+1)}function existsSync(e,t){try{var r=Fs.statSync(e);return!!r&&(!t||r.isFile())}catch(e){return!1}}function async_middleware(e,t,r,n,o,i,s,a){if(r.success||r.headersSent)return s&&s.subscribe.success(),void(o=null);var c=n[e++];if(!c)return o&&o(t,r,a);var u=F.routes.middleware[c];if(!u)return F.error('Middleware not found: '+c,null,t.uri),async_middleware(e,t,r,n,o,i,s,a);var l=u.call(framework,t,r,function(c){return c===!1?(s&&s.subscribe.success(),void(o=null)):c instanceof Error||c instanceof ErrorBuilder?(r.throw500(c),void(o=null)):void async_middleware(e,t,r,n,o,i,s,a)},i,s);l===!1&&(s&&s.subscribe.success(),o=null)}function parseComponent(e,t){var r={};r.css='',r.js='',r.install='';for(var n=0,o=0;;){if(n=e.indexOf('<script type="text/totaljs">'),n===-1)break;if(o=e.indexOf('</script>',n),o===-1)break;r.install+=(r.install?'\n':'')+e.substring(n,o).replace(/<(\/)?script.*?>/g,''),e=e.substring(0,n).trim()+e.substring(o+9).trim()}for(;;){if(n=e.indexOf('<style'),n===-1)break;if(o=e.indexOf('</style>',n),o===-1)break;r.css+=(r.css?'\n':'')+e.substring(n,o).replace(/<(\/)?style.*?>/g,''),e=e.substring(0,n).trim()+e.substring(o+8).trim()}for(;;){if(n=e.indexOf('<script>'),n===-1&&(n=e.indexOf('<script type="text/javascript">'),n===-1))break;if(o=e.indexOf('</script>',n),o===-1)break;r.js+=(r.js?'\n':'')+e.substring(n,o).replace(/<(\/)?script.*?>/g,''),e=e.substring(0,n).trim()+e.substring(o+9).trim()}return r.js&&(r.js=framework_internal.compile_javascript(r.js,t)),r.css&&(r.css=framework_internal.compile_css(r.css,t)),r.body=e,r}function controller_json_workflow(e){var t=this;t.id=e,t.$exec(t.route.workflow,t,t.callback())}function parseSchema(e){var t=F.temporary.internal['$$$'+e];return t?t:(t=e.split('/'),t[1]||(t[1]=t[0],t[0]='default'),F.temporary.internal['$$$'+e]=t,t)}function parseDefer(e){if(!F.config['allow-defer'])return e;var t=e.indexOf('function DEFER(');if(t===-1)return e;for(var r=e.indexOf('{',t),n=-1,o=0,i=r+1;;){var s=e[i++];if(!s)break;if('{'!==s){if('}'===s){if(o){o--;continue}n=i;break}}else o++}if(n===-1)return e;var a=e.substring(t,n),c='D'+a.hash().toString().replace('-','_');return e=e.replace(a,'F.temporary.defer.'+c),a=U.minifyScript(a.trim().replace(' DEFER(','(')),F.temporary.defer[c]=new Function('return '+parseDefer(a))(),parseDefer(e)}function parseDeferFile(e,t){if(!F.config['allow-defer'])return t;var r=Fs.readFileSync(t).toString(ENCODING);if(r.indexOf(' DEFER(')===-1)return t;var n=F.path.temp('defer-'+e+'$'+U.getName(t));return Fs.writeFileSync(n,parseDefer(r)),F.config['allow-debug']&&F.consoledebug('defer',t+' <--> '+n),n}var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&'function'==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?'symbol':typeof e};!function(e){function t(e){this.name=e,this.collection={}}function r(e,t,r,n,o){this.error=e,this.value=this.model=t,this.options=r,this.callback=this.next=n,this.controller=o}function n(e,t){this.parent=e,this.name=t,this.primary,this.trim=!0,this.schema={},this.meta={},this.properties=[],this.resourcePrefix,this.resourceName,this.transforms,this.workflows,this.hooks,this.operations,this.constants,this.onPrepare,this.onDefault,this.onValidate=F.onValidate,this.onSave,this.onGet,this.onRemove,this.onQuery,this.onError,this.gcache={},this.dependencies,this.fields,this.fields_allow,this.CurrentSchemaInstance=function(){},this.CurrentSchemaInstance.prototype=new u,this.CurrentSchemaInstance.prototype.$$schema=this}function o(e,t){t.raw='string';var r=e.indexOf('(');return r===-1?t:(t.length=e.substring(r+1,e.length-1).parseInt(),t.raw=e.substring(0,r),t)}function i(e,t,r){return e.gcache[t]?e.gcache[t]:e.gcache[t]='function*'===r.toString().substring(0,9)}function s(e,t){return e.trim?t.trim():t}function a(e){return F.isSuccess(e)?{success:e.success,value:e.value}:e}function c(e){if(!e)return e;var t='undefined'==typeof e?'undefined':_typeof(e);if('object'!==t||e instanceof Date)return e;var r,n;if(e instanceof Array){r=e.length,n=new Array(r);for(var o=0;o<r;o++)t=_typeof(e[o]),'object'!==t||e[o]instanceof Date?'function'!==t&&(n[o]=e[o]):n[o]=c(e[o]);return n}n={};for(var i in e)if(!O[i]){var s=e[i];if(s instanceof u)n[i]=c(s);else{var t='undefined'==typeof s?'undefined':_typeof(s);'object'!==t||s instanceof Date?'function'!==t&&(n[i]=s):n[i]=c(e[i])}}return n}function u(){}function l(e){e.$$can=!1,v(e.$$async,function(){e.$$callback(null,void 0!==e.$$index?e.$$result[e.$$index]:e.$$result),e.$$callback=null})}function p(e){this.items=[],this.transformName=P.error_default,this.onResource=e,this.resourceName=F.config['default-errorbuilder-resource-name'],this.resourcePrefix=F.config['default-errorbuilder-resource-prefix']||'',this.isResourceCustom=!1,this.count=0,this.replacer=[],this.isPrepared=!1,this.contentType='application/json',!e&&this._resource()}function f(){this.builder={}}function d(e,t){return void 0===e?t:e}function h(e,t,r,n){this.isNext=!1,this.isPrev=!1,this.isFirst=!1,this.isLast=!1,this.nextPage=0,this.prevPage=0,this.lastPage=0,this.firstPage=0,this.items=Math.max(0,+e),this.count=0,this.skip=0,this.take=0,this.page=0,this.max=0,this.visible=!1,this.format=n||'?page={0}',this.refresh(e,t,r),this.transformName=P.pagination_default}function m(e,t,r,n){this.url=e,this.page=t,this.selected=r,this.enabled=n}function g(){}function v(e,t){var r=e.shift();r?r(function(){return v(e,t)}):t()}function y(e,t,r,n){var o=e[n];o?t(o,function(){return y(e,t,r,n+1)},n):r()}function b(e){this.$url=e,this.$headers={'User-Agent':'Total.js/v'+F.version_header,Accept:'application/json, text/plain, text/plain, text/xml'},this.$method='get',this.$timeout=1e4,this.$type=0,this.$schema,this.$length=0,this.$transform=P.restbuilder_default}function E(e){e.removeAllListeners()}function w(){}function _(e){try{return decodeURIComponent(e)}catch(t){return e}}var k=e.exports;global.framework_builders=e.exports;var $='The field "@" is invalid.',S='default',O={$$schema:!0,$$result:!0,$$callback:!0,$$async:!0,$$index:!0,$$repository:!0,$$can:!0,$$controller:!0},x=/\s/g,T=/\s|\.|\-|\(|\)/g,R=/^function(\s)?\([a-zA-Z0-9\$]+\)/g,A=Object.prototype.hasOwnProperty,C=require('querystring'),N={},D={},P={pagination:{},error:{},transformbuilder:{},restbuilder:{}};return r.prototype.throw=function(e,t,r,n){return this.error.push(e,t,r,n),this},r.prototype.repository=function(e,t){return this.model&&this.model.$repository?this.model.$repository(e,t):t},t.prototype.get=function(e){return this.collection[e]},t.prototype.create=function(e){return this.collection[e]=new n(this,e),this.collection[e]},t.prototype.remove=function(e){if(e){var t=this.collection[e];t&&t.destroy(),t=null,delete this.collection[e]}else delete N[this.name],this.collection=null},t.prototype.destroy=function(e){return this.remove(e)},n.prototype.allow=function(){var e=this;e.fields_allow||(e.fields_allow=[]);for(var t=0,r=arguments.length;t<r;t++)arguments[t]instanceof Array?arguments[t].forEach(function(t){return e.fields_allow.push(t)}):e.fields_allow.push(arguments[t]);return e},n.prototype.define=function(e,t,r,o){if(e instanceof Array){for(var i=0,s=e.length;i<s;i++)this.define(e[i],t,r,o);return this}switch(void 0!==r&&'boolean'!=typeof r&&(o=r,r=!1),t instanceof n&&(t=t.name),this.schema[e]=this.$parse(e,t,r,o),this.schema[e].type){case 7:this.dependencies||(this.dependencies=[]),this.dependencies.push(e)}return this.fields=Object.keys(this.schema),r?(null==this.properties&&(this.properties=[]),this.properties.indexOf(e)===-1&&this.properties.push(e),this):this},n.prototype.setPrimary=function(e){return this.primary=e,this},n.prototype.filter=function(e,t,r){if('boolean'==typeof t){var n=r;r=t,t=n}var o=void 0===t?[]:{},i='undefined'==typeof e?'undefined':_typeof(e),s='string'===i&&('*'===e[0]||'%'===e[0]),a=!1;s?e=e.substring(1):'object'===i&&(a=framework_utils.isRegExp(e));for(var c in this.schema){var u=this.schema[c];if(u){var l=_typeof(u.custom);if(s){if('string'!==l)continue;if(u.custom.indexOf(e)===-1){if(!r)continue}else if(r)continue}else if(a){if('string'!==l)continue;if(e.test(u.current)){if(r)continue}else if(!r)continue}else if(u.custom!==e){if(!r)continue}else if(r)continue;void 0===t?o.push(c):o[c]=t[c]}}return o},n.prototype.$parse=function(e,t,r,n){var i='undefined'==typeof t?'undefined':_typeof(t),s={};if(s.raw=t,s.type=0,s.length=0,s.required=!!r,s.isArray=!1,s.custom=n||'',null===t)return s;if('[]'===t)return s.isArray=!0,s;if('function'===i)return t===Number?(s.type=2,s):t===String?(s.type=3,s):t===Boolean?(s.type=4,s):t===Date?(s.type=5,s):t===Array?(s.isArray=!0,s):t===Object?(s.type=6,s):s;if('object'===i)return t instanceof Array?(s.type=8,s.subtype=_typeof(t[0])):s.type=9,s;'['===t[0]&&(t=t.substring(1,t.length-1),s.isArray=!0,s.raw=t);var a=t.toLowerCase();return'object'===a?(s.type=6,s):'array'===a?(s.isArray=!0,s):a.contains(['string','text','varchar','nvarchar'])?(s.type=3,o(a,s)):a.indexOf('capitalize')!==-1||a.indexOf('camel')!==-1?(s.type=3,s.subtype='capitalize',o(a,s)):a.indexOf('lower')!==-1?(s.subtype='lowercase',s.type=3,o(a,s)):a.indexOf('upper')!==-1?(s.subtype='uppercase',s.type=3,o(a,s)):'uid'===a?(s.type=3,s.length=20,s.raw='string',s.subtype='uid',s):'email'===a?(s.type=3,s.length=120,s.raw='string',s.subtype='email',s):'json'===a?(s.type=3,s.raw='string',s.subtype='json',s):'url'===a?(s.type=3,s.length=500,s.raw='string',s.subtype='url',s):'zip'===a?(s.type=3,s.length=10,s.raw='string',s.subtype='zip',s):'phone'===a?(s.type=3,s.length=20,s.raw='string',s.subtype='phone',s):a.contains(['int','byte'])?(s.type=1,s):a.contains(['decimal','number','float','double'])?(s.type=2,s):a.indexOf('bool')!==-1?(s.type=4,s):a.contains(['date','time'])?(s.type=5,s):(s.type=7,s)},n.prototype.getDependencies=function(){var e=[];for(var t in this.schema){var r=this.schema[t];if('string'==typeof r){var n=']'===r[0];n&&(r=r.substring(1,r.length-1));var o=this.parent.get(r);o&&e.push({name:t,isArray:n,schema:o})}}return e},n.prototype.setValidate=function(e,t){return void 0===t&&e instanceof Array?(this.properties=e,this):('function'!=typeof e?(this.properties=e,this.onValidate=t):this.onValidate=e,this)},n.prototype.setPrefix=function(e){return this.resourcePrefix=e,this},n.prototype.setResource=function(e){return this.resourceName=e,this},n.prototype.setDefault=function(e){return this.onDefault=e,this},n.prototype.setPrepare=function(e){return this.onPrepare=e,this},n.prototype.setSave=function(e,t){return e.$newversion=R.test(e.toString()),this.onSave=e,this.meta.save=t,this},n.prototype.setError=function(e){return this.onError=e,this},n.prototype.setGet=n.prototype.setRead=function(e,t){return e.$newversion=R.test(e.toString()),this.onGet=e,this.meta.get=t,this},n.prototype.setQuery=function(e,t){return e.$newversion=R.test(e.toString()),this.onQuery=e,this.meta.query=t,this},n.prototype.setRemove=function(e,t){return e.$newversion=R.test(e.toString()),this.onRemove=e,this.meta.remove=t,this},n.prototype.constant=function(e,t,r){return void 0===t?this.constants?this.constants[e]:void 0:(!this.constants&&(this.constants={}),this.constants[e]=t,this.meta['constant#'+e]=r,this)},n.prototype.addTransform=function(e,t,r){return'function'==typeof e&&(t=e,e='default'),t.$newversion=R.test(t.toString()),!this.transforms&&(this.transforms={}),this.transforms[e]=t,this.meta['transform#'+e]=r,this},n.prototype.addOperation=function(e,t,r){return'function'==typeof e&&(t=e,e='default'),t.$newversion=R.test(t.toString()),!this.operations&&(this.operations={}),this.operations[e]=t,this.meta['operation#'+e]=r,this},n.prototype.addWorkflow=function(e,t,r){return'function'==typeof e&&(t=e,e='default'),t.$newversion=R.test(t.toString()),!this.workflows&&(this.workflows={}),this.workflows[e]=t,this.meta['workflow#'+e]=r,this},n.prototype.addHook=function(e,t,r){return this.hooks||(this.hooks={}),t.$newversion=R.test(t.toString()),!this.hooks[e]&&(this.hooks[e]=[]),this.hooks[e].push({owner:F.$owner(),fn:t}),this.meta['hook#'+e]=r,this},n.prototype.find=function(e){return this.parent.get(e)},n.prototype.destroy=function(){delete this.parent.collection[this.name],this.properties=void 0,this.schema=void 0,this.onDefault=void 0,this.onValidate=void 0,this.onSave=void 0,this.onRead=void 0,this.onGet=void 0,this.onRemove=void 0,this.onQuery=void 0,this.workflows=void 0,this.operations=void 0,this.transforms=void 0,this.meta=void 0,this.newversion=void 0,this.properties=void 0,this.hooks=void 0,this.constants=void 0,this.onPrepare=void 0,this.onError=void 0,this.gcache=void 0,this.dependencies=void 0,this.fields=void 0,this.fields_allow=void 0},n.prototype.save=function(e,t,n,o,s){if('boolean'==typeof n?(s=n,n=t,t=void 0):'function'==typeof t&&(n=t,t=void 0),'boolean'==typeof o){var a=s;s=o,o=a}'function'!=typeof n&&(n=function(){});var c=this,u='save';return c.$prepare(e,function(e,a){if(e)return void n(e,a);var l=new p;if(c.resourceName&&l.setResource(c.resourceName),c.resourcePrefix&&l.setPrefix(c.resourcePrefix),!i(c,u,c.onSave))return c.onSave.$newversion?c.onSave(new r(l,a,t,function(e){c.$process(arguments,a,u,void 0,l,e,n)},o)):c.onSave(l,a,t,function(e){c.$process(arguments,a,u,void 0,l,e,n)},o,s!==!0),c;n.success=!1;var f=function(e){e&&!n.success&&(n.success=!0,l.push(e),c.onError&&c.onError(l,a,u),n(l))},d=function(e){if(!n.success){(2===arguments.length||e instanceof Error||e instanceof p)&&((e instanceof Error||e instanceof p)&&l!==e&&l.push(e),e=arguments[1]);var t=l.hasError();t&&c.onError&&c.onError(l,a,u),n.success=!0,n(t?l:null,void 0===e?a:e)}};c.onSave.$newversion?async.call(c,c.onSave)(f,new r(l,a,t,d,o)):async.call(c,c.onSave)(f,l,a,t,d,o,s!==!0)}),c},n.prototype.get=n.prototype.read=function(e,t,n){'function'==typeof e&&(t=e,e=void 0),'function'!=typeof t&&(t=function(){});var o=this,s=new p;o.resourceName&&s.setResource(o.resourceName),o.resourcePrefix&&s.setPrefix(o.resourcePrefix);var a=o.default(),c='get';if(!i(o,c,o.onGet))return o.onGet.$newversion?o.onGet(new r(s,a,e,function(e){o.$process(arguments,a,c,void 0,s,e,t)},n)):o.onGet(s,a,e,function(e){o.$process(arguments,a,c,void 0,s,e,t)},n),o;t.success=!1;var u=function(e){e&&!t.success&&(t.success=!0,s.push(e),o.onError&&o.onError(s,a,c),t(s))},l=function(e){if(!t.success){(2===arguments.length||e instanceof Error||e instanceof p)&&((e instanceof Error||e instanceof p)&&s!==e&&s.push(e),e=arguments[1]),t.success=!0;var r=s.hasError();r&&o.onError&&o.onError(s,a,c),t(r?s:null,void 0===e?a:e)}};return o.onGet.$newversion?async.call(o,o.onGet)(u,new r(s,a,e,l,n)):async.call(o,o.onGet)(u,s,a,e,l,n),o},n.prototype.remove=function(e,t,n){'function'==typeof e&&(t=e,e=void 0);var o=this,s=new p,a='remove';if(o.resourceName&&s.setResource(o.resourceName),o.resourcePrefix&&s.setPrefix(o.resourcePrefix),!i(o,a,o.onRemove))return o.onRemove.$newversion?o.onRemove(new r(s,void 0,e,function(e){o.$process(arguments,void 0,a,void 0,s,e,t)},n)):o.onRemove(s,e,function(e){o.$process(arguments,void 0,a,void 0,s,e,t)},n),o;t.success=!1;var c=function(e){e&&!t.success&&(t.success=!0,s.push(e),o.onError&&o.onError(s,EMPTYOBJECT,a),t(s))},u=function(r){if(!t.success){(2===arguments.length||r instanceof Error||r instanceof p)&&((r instanceof Error||r instanceof p)&&s!==r&&s.push(r),r=arguments[1]);var n=s.hasError();n&&o.onError&&o.onError(s,EMPTYOBJECT,a),t.success=!0,t(n?s:null,void 0===r?e:r)}};return o.onRemove.$newversion?async.call(o,o.onRemove)(c,new r(s,void 0,e,u,n)):async.call(o,o.onRemove)(c,s,e,u,n),o},n.prototype.query=function(e,t,n){'function'==typeof e&&(t=e,e=void 0);var o=this,s=new p,a='query';if(o.resourceName&&s.setResource(o.resourceName),o.resourcePrefix&&s.setPrefix(o.resourcePrefix),!i(o,a,o.onQuery))return o.onQuery.$newversion?o.onQuery(new r(s,void 0,e,function(e){o.$process(arguments,void 0,a,void 0,s,e,t)},n)):o.onQuery(s,e,function(e){o.$process(arguments,void 0,a,void 0,s,e,t)},n),o;t.success=!1;var c=function(e){e&&!t.success&&(t.success=!0,s.push(e),o.onError&&o.onError(s,EMPTYOBJECT,a),t(s))},u=function(e){if(!t.success){(2===arguments.length||e instanceof Error||e instanceof p)&&((e instanceof Error||e instanceof p)&&s!==e&&s.push(e),e=arguments[1]);var r=s.hasError();r&&o.onError&&o.onError(s,EMPTYOBJECT,a),t.success=!0,t(s.hasError()?s:null,e)}};return o.onQuery.$newversion?async.call(o,o.onQuery)(c,new r(s,void 0,e,u,n)):async.call(o,o.onQuery)(c,s,e,u,n),o},n.prototype.validate=function(e,t,r,n,o,i,s){var a=this;if(void 0===n&&(n=new p,a.resourceName&&n.setResource(a.resourceName),a.resourcePrefix&&n.setPrefix(a.resourcePrefix)),a.resourcePrefix&&(n.resourcePrefix=a.resourcePrefix),a.resourceName&&(n.resourceName=a.resourceName),r&&(n.resourceName=r),t&&(n.resourcePrefix=t),o&&(o=a.filter(o)),i?i+='.':i='',framework_utils.validate_builder.call(a,e,n,a.name,a.parent.collection,a.name,s,o,i),!a.dependencies)return n;for(var c=0,u=a.dependencies.length;c<u;c++){var l=a.dependencies[c],f=a.schema[l],d=a.parent.collection[f.raw];if(d)if(f.isArray)for(var h=e[l],m=0,g=h.length;m<g;m++)(null!=e[l][m]||f.required)&&d.validate(e[l][m],t,r,n,o,i+l+'['+m+']',m);else(null!=e[l]||f.required)&&d.validate(e[l],t,r,n,o,i+l,m);else F.error(new Error('Schema "'+f.raw+'" not found (validation).'));
}return n},n.prototype.create=function(){return this.default()},n.prototype.Create=function(){return this.default()},n.prototype.$make=function(e){return e},n.prototype.$prepare=function(e,t){return e&&'function'==typeof e.$save?t(null,e):this.make(e,function(e,r){return t(e,r)}),this},n.prototype.default=function(){var e=this.schema;if(null===e)return null;var t=this.onDefault,r=new this.CurrentSchemaInstance;for(var n in e){var o=e[n];if(t){var i=t(n,!0,this.name);if(void 0!==i){r[n]=i;continue}}switch(o.type){case 0:case 6:r[n]=o.isArray?[]:null;break;case 1:case 2:r[n]=o.isArray?[]:0;break;case 3:r[n]=o.isArray?[]:'';break;case 4:r[n]=!!o.isArray&&[];break;case 5:r[n]=o.isArray?[]:F.datetime;break;case 7:if(o.isArray)r[n]=[];else{var s=this.find(o.raw);s?r[n]=s.default():(F.error(new Error('Schema: "'+n+'.'+o.raw+'" not found in "'+this.parent.name+'".')),r[n]=null)}break;case 8:case 9:r[n]=void 0}}return r},n.prototype.make=function(e,t,r,n,o){if('function'==typeof e)return e.call(this,this),this;if('function'==typeof t){var i=r;r=t,t=i}var s=this.prepare(e);if(o)return r&&r(null,s,n),s;var a=this.validate(s,void 0,void 0,void 0,t);return a.hasError()?(this.onError&&this.onError(a,e,'make'),r&&r(a,null,n),s):(r&&r(null,s,n),s)},n.prototype.load=n.prototype.make,n.prototype.$onprepare=function(e,t,r,n){if(this.onPrepare){var o=this.onPrepare(e,t,r,n);return void 0===o?t:o}return t},n.prototype.prepare=function(e,t){var r=this,n=r.schema;if(null===n)return null;if(null==e)return r.default();var o,i,a=new r.CurrentSchemaInstance,c=r.onDefault;for(var u in n){var l=e[u];A.call(e,u)||(l=void 0),void 0===l&&c&&(l=c(u,!1,r.name)),void 0===l&&(l='');var p=n[u],f='undefined'==typeof l?'undefined':_typeof(l);if('function'===f&&(l=l()),p.isArray)if(l instanceof Array){a[u]=[];for(var h=0,m=l.length;h<m;h++){switch(o=l[h],f='undefined'==typeof o?'undefined':_typeof(o),p.type){case 0:o=r.$onprepare(u,o,h,e);break;case 1:o=r.$onprepare(u,framework_utils.parseInt(o),h,e);break;case 2:o=r.$onprepare(u,framework_utils.parseFloat(o),h,e);break;case 3:switch(o=null==o?'':s(r,o.toString()),p.length&&o.length<o.length&&(o=o.substring(0,p.length)),p.subtype){case'uid':if(o&&!p.required&&!o.isUID())continue;break;case'url':if(o&&!p.required&&!o.isURL())continue;break;case'email':if(o=o.toLowerCase().replace(x,''),o&&!p.required&&!o.isEmail())continue;break;case'phone':if(o=o.replace(T,''),o&&!p.required&&!o.isPhone())continue;break;case'capitalize':o=o.capitalize();break;case'lowercase':o=o.toLowerCase();break;case'uppercase':o=o.toUpperCase();break;case'json':if(o&&!p.required&&!o.isJSON())continue}o=r.$onprepare(u,o,h,e);break;case 4:o&&(o=o.toString().toLowerCase()),o=r.$onprepare(u,'true'===o||'1'===o||'on'===o,h,e);break;case 5:'string'===f?o&&(o=o.trim().parseDate()):'number'===f&&(o=new Date(o)),o=framework_utils.isDate(o)?r.$onprepare(u,o,h,e):void 0;break;case 6:o=r.$onprepare(u,o,h,e);break;case 7:i=r.parent.get(p.raw),i?(o=i.prepare(o,t),t&&t.push({name:p.raw,value:r.$onprepare(u,o,h,e)})):o=null,o=r.$onprepare(u,o,h,e)}void 0!==o&&a[u].push(o)}}else a[u]=c?d(c(u,!1,r.name),[]):[];else switch(p.type){case 0:break;case 1:a[u]=r.$onprepare(u,framework_utils.parseInt(l),void 0,e);break;case 2:a[u]=r.$onprepare(u,framework_utils.parseFloat(l),void 0,e);break;case 3:switch(o=null==l?'':s(r,l.toString()),p.length&&p.length<o.length&&(o=o.substring(0,p.length)),p.subtype){case'uid':!o||p.required||o.isUID()||(o='');break;case'email':o=o.toLowerCase().replace(x,''),!o||p.required||o.isEmail()||(o='');break;case'url':!o||p.required||o.isURL()||(o='');break;case'zip':!o||p.required||o.isZIP()||(o='');break;case'phone':o=o.replace(T,''),!o||p.required||o.isPhone()||(o='');break;case'capitalize':o=o.capitalize();break;case'lowercase':o=o.toLowerCase();break;case'uppercase':o=o.toUpperCase();break;case'json':!o||p.required||o.isJSON()||(o='')}a[u]=r.$onprepare(u,o,void 0,e);break;case 4:o=l?l.toString().toLowerCase():null,a[u]=r.$onprepare(u,'true'===o||'1'===o||'on'===o,void 0,e);break;case 5:o=null,'string'===f?l&&(o=l.trim().parseDate()):o='number'===f?new Date(l):l,o=framework_utils.isDate(o)?r.$onprepare(u,o,void 0,e):c?d(c(u,!1,r.name),null):null,a[u]=o;break;case 6:a[u]=r.$onprepare(u,e[u],void 0,e);break;case 8:o=r.$onprepare(u,e[u],void 0,e),'number'===p.subtype&&'string'==typeof o&&(o=o.parseFloat(null)),a[u]=null!=o&&p.raw.indexOf(o)!==-1?o:void 0;break;case 9:o=r.$onprepare(u,e[u],void 0,e),a[u]=null!=o?p.raw[o]:void 0;break;case 7:if(!l&&(l=c?d(c(u,!1,r.name),null):null,null===l)){a[u]=null;break}if(l&&'function'==typeof l.$schema&&(o=l.$schema(),o&&o.name&&o.name===p.raw)){a[u]=l;break}i=r.parent.get(p.raw),i?(a[u]=i.prepare(l,void 0),t&&t.push({name:p.raw,value:r.$onprepare(u,a[u],void 0,e)})):a[u]=null}}if(r.fields_allow)for(var g=0,v=r.fields_allow.length;g<v;g++){var y=r.fields_allow[g],l=e[y];void 0!==l&&(a[y]=l)}return a},n.prototype.transform=function(e,t,r,n,o,i){return this.$execute('transform',e,t,r,n,o,i)},n.prototype.transform2=function(e,t,r,n){return'function'==typeof t&&(r=t,t=void 0),!r&&(r=function(){}),this.transform(e,this.create(),t,r,!0,n)},n.prototype.$process=function(e,t,r,n,o,i,s){var a=this;(e.length>1||i instanceof Error||i instanceof p)&&((i instanceof Error||i instanceof p||'string'==typeof i)&&o!==i&&o.push(i),i=e[1]);var c=o.hasError();return c&&a.onError&&a.onError(o,t,r,n),s(c?o:null,void 0===i?t:i,t),a},n.prototype.$process_hook=function(e,t,r,n,o,i){var s=this,a=n.hasError();return a&&s.onError&&s.onError(n,e,t,r),i(a?n:null,e),s},n.prototype.workflow=function(e,t,r,n,o,i){return this.$execute('workflow',e,t,r,n,o,i)},n.prototype.workflow2=function(e,t,r,n){return'function'==typeof t&&(r=t,t=void 0),!r&&(r=function(){}),this.workflow(e,this.create(),t,r,!0,n)},n.prototype.hook=function(e,t,n,o,s,a){var c=this;'string'!=typeof e&&(o=n,n=t,t=e,e='default'),'boolean'==typeof o?(s=o,o=n,n=void 0):'function'==typeof n&&(o=n,n=void 0),'function'!=typeof o&&(o=function(){});var u=c.hooks?c.hooks[e]:void 0;if(!u||!u.length)return o(null,t),c;var l='hook';if(s===!0){var f=new p;c.resourceName&&f.setResource(c.resourceName),c.resourcePrefix&&f.setPrefix(c.resourcePrefix);var d=[];return y(u,function(e,o){e.fn.$newversion?e.fn.call(c,new r(f,t,n,function(e){d.push(void 0==e?t:e),o()},a)):e.fn.call(c,f,t,n,function(e){d.push(void 0==e?t:e),o()},a,s!==!0)},function(){c.$process_hook(t,l,e,f,d,o)},0),c}return c.$prepare(t,function(t,f){if(t)return void o(t,f);var d=new p,h=[];c.resourceName&&d.setResource(c.resourceName),c.resourcePrefix&&d.setPrefix(c.resourcePrefix),y(u,function(t,u,l){return i(c,'hook.'+e+'.'+l,t.fn)?(o.success=!1,void(t.fn.$newversion?async.call(c,t.fn)(function(e){e&&(d.push(e),u())},new r(d,f,n,function(e){h.push(void 0==e?f:e),u()},a)):async.call(c,t.fn)(function(e){e&&(d.push(e),u())},d,f,n,function(e){h.push(void 0==e?f:e),u()},a,s!==!0))):void(t.fn.$newversion?t.fn.call(c,new r(d,f,n,function(e){h.push(void 0===e?f:e),u()},a)):t.fn.call(c,d,f,n,function(e){h.push(void 0===e?f:e),u()},a,s!==!0))},function(){return c.$process_hook(f,l,e,d,h,o)},0)}),c},n.prototype.hook2=function(e,t,r,n){return'function'==typeof t&&(r=t,t=void 0),r||(r=function(){}),this.hook(e,this.create(),t,r,!0,n)},n.prototype.$execute=function(e,t,n,o,s,a,c){var u=this;'string'!=typeof t&&(s=o,o=n,n=t,t='default'),'boolean'==typeof s?(a=s,s=o,o=void 0):'function'==typeof o&&(s=o,o=void 0),'function'!=typeof s&&(s=function(){});var l=u[e+'s'],f=l?l[t]:void 0;if(!f)return s((new p).push('',e.capitalize()+' "{0}" not found.'.format(t))),u;if(a===!0){var d=new p;return u.resourceName&&d.setResource(u.resourceName),u.resourcePrefix&&d.setPrefix(u.resourcePrefix),f.$newversion?f.call(u,new r(d,n,o,function(r){u.$process(arguments,n,e,t,d,r,s)},c)):f.call(u,d,n,o,function(r){u.$process(arguments,n,e,t,d,r,s)},c,a!==!0),u}return u.$prepare(n,function(n,a){if(n)return void s(n,a);var l=new p;if(u.resourceName&&l.setResource(u.resourceName),u.resourcePrefix&&l.setPrefix(u.resourcePrefix),!i(u,e+'.'+t,f))return void(f.$newversion?f.call(u,new r(l,a,o,function(r){u.$process(arguments,a,e,t,l,r,s)},c)):f.call(u,l,a,o,function(r){u.$process(arguments,a,e,t,l,r,s)},c));s.success=!1;var d=function(r){r&&!s.success&&(s.success=!0,l.push(r),u.onError&&u.onError(l,a,e,t),s(l))},h=function(r){if(!s.success){(2===arguments.length||r instanceof Error||r instanceof p)&&((r instanceof Error||r instanceof p)&&l!==r&&l.push(r),r=arguments[1]);var n=l.hasError();n&&u.onError&&u.onError(l,a,e,t),s.success=!0,s(n?l:null,void 0===r?a:r)}};f.$newversion?async.call(u,f)(d,new r(l,a,o,h,c)):async.call(u,f)(d,l,a,o,h,c)}),u},n.prototype.operation=function(e,t,n,o,s,a){var c=this,u='undefined'==typeof n?'undefined':_typeof(n),l='undefined'==typeof o?'undefined':_typeof(o);'undefined'===l?'function'===u?(o=n,n=t,t=void 0):'undefined'===u&&(n=t,t=void 0):'undefined'===u?(n=t,t=void 0):'boolean'===l&&(s=o,o=n,n=void 0),'function'==typeof n&&(o=n,n=void 0),'function'!=typeof o&&(o=function(){});var f=c.operations?c.operations[e]:void 0;if(!f)return o((new p).push('','Operation "{0}" not found.'.format(e))),c;var d=new p,h='operation';if(c.resourceName&&d.setResource(c.resourceName),c.resourcePrefix&&d.setPrefix(c.resourcePrefix),!i(c,'operation.'+e,f))return f.$newversion?f.call(c,new r(d,t,n,function(r){c.$process(arguments,t,h,e,d,r,o)},a)):f.call(c,d,t,n,function(r){c.$process(arguments,t,h,e,d,r,o)},a,s!==!0),c;o.success=!1;var m=function(r){r&&!o.success&&(o.success=!0,d.push(r),c.onError&&c.onError(d,t,h,e),o(d))},g=function(r){if(!o.success){(2===arguments.length||r instanceof Error||r instanceof p)&&((r instanceof Error||r instanceof p)&&d!==r&&d.push(r),r=arguments[1]);var n=d.hasError();n&&c.onError&&c.onError(d,t,h,e),o.success=!0,o(n?d:null,r)}};return f.$newversion?async.call(c,f)(m,new r(d,t,n,g,a)):async.call(c,f)(m,d,t,n,g,a,s!==!0),c},n.prototype.operation2=function(e,t,r,n){return'function'==typeof t&&(r=t,t=void 0),!r&&(r=function(){}),this.operation(e,this.create(),t,r,!0,n)},n.prototype.clean=function(e){return c(e)},n.prototype.instancePrototype=function(){return this.CurrentSchemaInstance.prototype},u.prototype.$$schema=null,u.prototype.$async=function(e,t){var r=this;return!e&&(e=function(){}),r.$$async=[],r.$$result=[],r.$$index=t,r.$$callback=e,r.$$can=!0,setImmediate(l,r),r},u.prototype.$repository=function(e,t){if(void 0===this.$$repository){if(void 0===t)return;this.$$repository={}}return void 0!==t?(this.$$repository[e]=t,t):this.$$repository[e]},u.prototype.$index=function(e){return'string'==typeof e&&(this.$$index=(this.$$index||0).add(e)),this.$$index=e,this},u.prototype.$callback=function(e){return this.$$callback=e,this},u.prototype.$output=function(){return this.$$index=this.$$result.length,this},u.prototype.$push=function(e,t,r,n){var o,i=this;return'save'===e||'remove'===e?(r=t,t=void 0,o=function(t){i.$$schema[e](i,r,function(e,r){return i.$$result&&i.$$result.push(e?null:a(r)),e?(t=null,i.$$async=null,i.$$callback(e,i.$$result),void(i.$$callback=null)):t()},i.$$controller)}):'query'===e||'get'===e||'read'===e?(r=t,t=void 0,o=function(t){i.$$schema[e](r,function(e,r){return i.$$result&&i.$$result.push(e?null:a(r)),e?(t=null,i.$$async=null,i.$$callback(e,i.$$result),void(i.$$callback=null)):t()},i.$$controller)}):o=function(n){i.$$schema[e](t,i,r,function(e,t){return i.$$result&&i.$$result.push(e?null:a(t)),e?(n=null,i.$$async=null,i.$$callback(e,i.$$result),void(i.$$callback=null)):n()},i.$$controller)},n?i.$$async.unshift(o):i.$$async.push(o),i},u.prototype.$next=function(e,t,r){return this.$push(e,t,r,!0)},u.prototype.$exec=function(e,t,r){'function'==typeof t&&(r=t,t=void 0);var n=this.$$schema.parent.name,o='default'!==n?n+'/'+this.$$schema.name:this.$$schema.name,i=F.workflows[o+'#'+e]||F.workflows[e];return i?i(this,t||EMPTYOBJECT,r||NOOP):r&&r((new p).push('Workflow "'+e+'" not found in workflows.')),this},u.prototype.$save=function(e,t){return this.$$can&&this.$$async?this.$push('save',e):this.$$schema.save(this,e,t,this.$$controller),this},u.prototype.$query=function(e,t){return this.$$can&&this.$$async?this.$push('query',e):this.$$schema.query(this,e,t,this.$$controller),this},u.prototype.$read=u.prototype.$get=function(e,t){return this.$$can&&this.$$async?this.$push('get',e):this.$$schema.get(this,e,t,this.$$controller),this},u.prototype.$remove=function(e,t){return this.$$can&&this.$$async?this.$push('remove',e):this.$$schema.remove(e,t,this.$$controller),this},u.prototype.$default=function(){return this.$$schema.default()},u.prototype.$destroy=function(){return this.$$schema.destroy()},u.prototype.$transform=function(e,t,r){return this.$$can&&this.$$async?this.$push('transform',e,t):this.$$schema.transform(e,this,t,r,void 0,this.$$controller),this},u.prototype.$workflow=function(e,t,r){return this.$$can&&this.$$async?this.$push('workflow',e,t):this.$$schema.workflow(e,this,t,r,void 0,this.$$controller),this},u.prototype.$hook=function(e,t,r){return this.$$can&&this.$$async?this.$push('hook',e,t):this.$$schema.hook(e,this,t,r,void 0,this.$$controller),this},u.prototype.$operation=function(e,t,r){return this.$$can&&this.$$async?this.$push('operation',e,t):this.$$schema.operation(e,this,t,r,void 0,this.$$controller),this},u.prototype.$clean=u.prototype.$plain=function(){return this.$$schema.clean(this)},u.prototype.$clone=function(){return framework_utils.extend(new this.$$schema.CurrentSchemaInstance,this,!0)},u.prototype.$prepare=function(){return this.$$schema.prepare(this)},u.prototype.$schema=function(){return this.$$schema},u.prototype.$validate=function(e,t,r){return this.$$schema.validate(this,e,t,r)},u.prototype.$constant=function(e){return this.$$schema.constant(e)},k.isSchema=function(e){return e instanceof u},k.eachschema=function(e,t){void 0===t&&(t=e,e=void 0);for(var r=e?[e]:Object.keys(N),n=0,o=r.length;n<o;n++){var i=N[r[n]];if(i)for(var s=Object.keys(i.collection),a=0,c=s.length;a<c;a++)t(i.name,i.collection[s[a]].name,i.collection[s[a]])}},k.getschema=function(e,t,r,n){if(t&&'function'!=typeof t||(r=t,t=e,e=S),r)return framework_utils.wait(function(){return N[e]},function(t){return r(t,N[e])},n||2e4);var o=N[e];return o?o.get(t):void 0},k.newschema=function(e,r){e||(e=S),N[e]||(N[e]=new t(e));var n=N[e].create(r);return n.owner=F.$owner(),n},k.remove=function(e,t){if(t){var r=N[e||S];r&&r.remove(t)}else delete N[e]},k.isJoin=function(e,t){return!!t&&('['===t[0]||void 0!==e&&void 0!==e[t])},k.validation=function(e,t,r){if(void 0===N[S])return EMPTYARRAY;var n=N[S].get(e);if(void 0===n)return EMPTYARRAY;if(r instanceof Array&&'function'==typeof t){var o=r;r=t,t=o}if('function'==typeof r)return n.onValidate=r,t?n.properties=t:n.properties=Object.keys(n.schema),!0;if(!r){var i=n.properties;return void 0===i?Object.keys(n.schema):i||[]}return n.onValidate=r,r},k.validate=function(e,t,r,n){var o=N[S];return void 0===o?null:(o=o.get(e),void 0===o?null:o.validate(t,r,n))},k.create=function(e){return k.defaults(e)},k.defaults=function(e){if(void 0===N[S])return null;var t=N[S].get(e);return void 0===t?null:t.default()},k.prepare=function(e,t){if(void 0===N[S])return null;var r=N[S].get(e);return void 0===r?null:r.prepare(t)},p.prototype={get errors(){var e=this;return!e.isPrepared&&e.prepare(),e._transform()},get error(){var e=this;return!e.isPrepared&&e.prepare(),e._transform()}},p.prototype.resource=function(e,t){var r=this;return r.isResourceCustom=!0,r.resourceName=e,r.resourcePrefix=t||'',r._resource()},p.prototype.setContentType=function(e){return this.contentType=e,this},p.prototype.setResource=function(e){var t=this;return t.isResourceCustom=!0,t.resourceName=e,t._resource()},p.prototype.setPrefix=function(e){var t=this;return t.resourcePrefix=e||'',t._resource()},p.prototype._resource=function(){var e=this;return e.onResource=e._resource_handler,e},p.prototype._resource_handler=function(e){var t=this;return'undefined'!=typeof framework?F.resource(t.resourceName||'default',t.resourcePrefix+e):''},p.prototype.exception=function(e){return this.items.push({name:'',error:e}),this},p.prototype.add=function(e,t,r,n){return this.push(e,t,r,n)},p.prototype.push=function(e,t,r,n){if(this.isPrepared=!1,e instanceof p){if(e.hasError()){for(var o=0,i=e.items.length;o<i;o++)this.items.push(e.items[o]);this.count=this.items.length}return this}if(e instanceof Array){for(var o=0,i=e.length;o<i;o++)this.push(e[o],void 0,r,n);return this}if(t instanceof Array){for(var o=0,i=t.length;o<i;o++)this.push(e,t[o],r,n);return this}return'object'===('undefined'==typeof e?'undefined':_typeof(e))&&(r=t,t=e,e=''),null===t||!e&&!t?this:(t||(t='@'),t instanceof Error&&(this.unexpected=!0,t=t.toString()),this.items.push({name:e,error:'string'==typeof t?t:t.toString(),path:r,index:n}),this.count=this.items.length,this)},p.prototype.remove=function(e){return this.items=this.items.remove('name',e),this.count=this.items.length,this},p.prototype.hasError=function(e){return e?this.items.findIndex('name',e)!==-1:this.items.length>0},p.prototype.read=function(e){!this.isPrepared&&this.prepare();var t=this.items.findItem('name',e);return t?t.error:null},p.prototype.clear=function(){return this.items=[],this.count=0,this},p.prototype.replace=function(e,t){return this.isPrepared=!1,this.replacer[e]=t,this},p.prototype.json=function(e,t){var r=this.prepare().items;return e?JSON.stringify(r,t,'\t'):JSON.stringify(r,t)},p.prototype.plain=function(){for(var e=this.prepare().items,t='',r=0,n=e.length;r<n;r++)t+=(t?', ':'')+e[r].error;return t},p.prototype.JSON=function(e,t){return this.json(e,t)},p.prototype._prepare=function(){if(!this.onResource)return this;for(var e=this.items,t=0,r=e.length;t<r;t++){var n=e[t];'@'===n.error[0]&&(1===n.error.length?n.error=this.onResource(n.name):n.error=this.onResource(n.error.substring(1)),n.error||(n.error=$.replace('@',n.name)))}return this},p.prototype._transform=function(e){var t=e||this.transformName;if(t){var r=P.error[t];return r?r.call(this):this.items}return this.items},p.prototype.output=function(){if(!this.transformName)return this.json();var e=P.error[this.transformName];return e?(this.prepare(),e.call(this)):this.json()},p.prototype.toString=function(){!this.isPrepared&&this.prepare();for(var e=this.items,t=e.length,r=[],n=0;n<t;n++)r.push(e[n].error||e[n].name);return r.join('\n')},p.prototype.setTransform=function(e){return this.transformName=e,this},p.prototype.transform=function(e){return this.prepare()._transform(e)},p.prototype._prepareReplace=function(){var e=this,t=e.items,r=t.length,n=Object.keys(e.replacer),o=n.length;if(!r||!o)return e;for(var i=0;i<r;i++)for(var s=t[i],a=0;a<o;a++){var c=n[a];s.error=s.error.replace(c,e.replacer[c])}return e},p.prototype.prepare=function(){return this.isPrepared?this:(this._prepare()._prepareReplace(),this.isPrepared=!0,this)},p.addTransform=function(e,t,r){P.error[e]=t,r&&p.setDefaultTransform(e)},p.removeTransform=function(e){delete P.error[e]},p.setDefaultTransform=function(e){e?P.error_default=e:delete P.error_default},m.prototype.html=function(e,t){var r=t?t:'';return this.selected&&(r+=(r?' ':'')+'selected'),'<a href="'+this.url+'"'+(r?' class="'+r+'"':'')+'>'+(e||this.page)+'</a>'},h.addTransform=function(e,t,r){P.pagination[e]=t,r&&h.setDefaultTransform(e)},h.setDefaultTransform=function(e){e?P.pagination_default=e:delete P.pagination_default},h.removeTransform=function(e){delete P.pagination[e]},h.prototype.refresh=function(e,t,r){return this.page=Math.max(1,+t)-1,this.page<=0&&(this.page=0),this.items=Math.max(0,+e),this.max=Math.max(1,+r),this.skip=this.page*this.max,this.count=Math.ceil(this.items/this.max),this.take=Math.min(this.max,this.items-this.skip),this.lastPage=this.count,this.firstPage=1,this.prevPage=this.page?this.page:1,this.nextPage=this.page+2<this.count-1?this.page+2:this.count,this.isPrev=this.page>0,this.isNext=this.page<this.count-1,this.isFirst=0===this.page,this.isLast=this.page===this.count-1,this.visible=this.count>1,this.page++,this},h.prototype.setTransform=function(e){return this._transform=e,this},h.prototype.transform=function(e){var t=e||this.transformName;if(!t)throw new Error('A transformation of Pagination not found.');var r=P.pagination[t];if(!r)return this.render();for(var n=[],o=1;o<arguments.length;o++)n.push(arguments[o]);return r.apply(this,n)},h.prototype.prev=function(e){var t=0;return e=e||this.format,t=this.isPrev?this.page-1:this.count,new m(e.format(t,this.items,this.count),t,!1,this.isPrev)},h.prototype.next=function(e){var t=0;return e=e||this.format,t=this.isNext?this.page+1:1,new m(e.format(t,this.items,this.count),t,!1,this.isNext)},h.prototype.last=function(e){var t=this.count;return e=e||this.format,new m(e.format(t,this.items,this.count),t,!1,this.count>0)},h.prototype.first=function(e){var t=1;return e=e||this.format,new m(e.format(t,this.items,this.count),t,!1,this.count>0)},h.prototype.prepare=function(e,t,r){var n=this;if(n.transformName)return P.pagination[n.transformName].apply(n,arguments);var o=[];if(t=t||n.format,'string'==typeof e){var i=t;t=e,e=i}var s='html'===r;if(null==e){for(var a=1;a<n.count+1;a++){var c=new m(t.format(a,n.items,n.count),a,a===n.page,!0);o.push(s?c.html():c)}return o}var u=Math.floor(e/2),l=n.count,p=n.page-u,f=n.page+u,d=0;p<=0&&(d=Math.abs(p),p=1,f+=d),f>=l&&(f=l,p=l-e,p<=0&&(p=1));for(var a=p;a<f+1;a++){var c=new m(t.format(a,n.items,n.count),a,a===n.page,!0);o.push(s?c.html():c)}return o},h.prototype.render=function(e,t){return this.prepare(e,t)},h.prototype.html=function(e,t){return this.prepare(e,t,'html').join('')},h.prototype.json=function(e,t){return JSON.stringify(this.prepare(e,t))},f.make=function(e){var t=new f;return e.call(t,t),t},f.prototype.add=function(e,t){if('object'!==('undefined'==typeof e?'undefined':_typeof(e)))return this.builder[e]=t,this;for(var r=Object.keys(e),n=0,o=r.length;n<o;n++)this.builder[r[n]]=e[r[n]];return this},f.prototype.remove=function(e){return delete this.builder[e],this},f.prototype.read=function(e){return this.builder[e]||null},f.prototype.clear=function(){return this.builder={},this},f.prototype.toString=function(e,t){if('boolean'==typeof e){var r=t;t=e,e=r}var n=this,o=[];return Object.keys(n.builder).forEach(function(e){var r=n.builder[e];r=null==r?'':r.toString(),t&&''===r||o.push(e+'='+encodeURIComponent(r))}),'string'==typeof e?'?'!==e[e.length-1]&&(e+='?'):e='',e+o.join('&')},f.prototype.hasValue=function(e){if(void 0===e)return!1;'string'==typeof e&&(e=[e]);for(var t=0;t<e.length;t++){var r=this.builder[e[t]];if(null==r)return!1}return!0},f.prototype.toOne=function(e,t){var r=this,n=[];return e.forEach(function(e){return n.push(r.builder[e]||'')}),n.join(t||'&')},g.transform=function(e,t){OBSOLETE('TransformBuilder','Builders.TransformBuilder will be removed in next versions.');var r=2;void 0===t&&(t=e,e=P.transformbuilder_default,r=1);var n=P.transformbuilder[e];if(!n)return F.error('Transformation "'+e+'" not found.','TransformBuilder.transform()'),t;var o=arguments.length-r;if(o<=0)return n.call(t,t);var i=new Array(o+1),s=1;i[0]=t;for(var a=r;a<arguments.length;a++)i[s++]=arguments[a];return n.apply(t,i)},g.addTransform=function(e,t,r){P.transformbuilder[e]=t,r&&g.setDefaultTransform(e)},g.setDefaultTransform=function(e){e?P.transformbuilder_default=e:delete P.transformbuilder_default},b.make=function(e){var t=new b;return e(t),t},b.addTransform=function(e,t,r){P.restbuilder[e]=t,r&&b.setDefaultTransform(e)},b.setDefaultTransform=function(e){e?P.restbuilder_default=e:delete P.restbuilder_default},b.prototype.setTransform=function(e){return this.$transform=e,this},b.prototype.url=function(e){return void 0===e?this.$url:(this.$url=e,this)},b.prototype.maketransform=function(e,t){if(this.$transform){var r=P.restbuilder[this.$transform];return r?r(e,t):e}return e},b.prototype.timeout=function(e){return this.$timeout=e,this},b.prototype.maxlength=function(e){return this.$length=e,this.$flags=null,this},b.prototype.auth=function(e,t){return this.$headers.authorization='Basic '+framework_utils.createBuffer(e+':'+t).toString('base64'),this},b.prototype.schema=function(e,t){return this.$schema=k.getschema(e,t),this},b.prototype.noDnsCache=function(){return this.$nodnscache=!0,this.$flags=null,this},b.prototype.noCache=function(){return this.$nocache=!0,this},b.prototype.make=function(e){return e.call(this,this),this},b.prototype.xhr=function(){return this.$headers['X-Requested-With']='XMLHttpRequest',this},b.prototype.method=function(e){return this.$method=e.toLowerCase(),this.$flags=null,this},b.prototype.referer=b.prototype.referrer=function(e){return this.$headers.Referer=e,this},b.prototype.origin=function(e){return this.$headers.Origin=e,this},b.prototype.put=function(e){return'put'!==this.$method&&(this.$flags=null,this.$method='put',this.$type=1),e&&this.raw(e),this},b.prototype.delete=function(e){return'delete'!==this.$method&&(this.$flags=null,this.$method='delete',this.$type=1),e&&this.raw(e),this},b.prototype.get=function(e){return'get'!==this.$method&&(this.$flags=null,this.$method='get'),e&&this.raw(e),this},b.prototype.post=function(e){return'post'!==this.$method&&(this.$flags=null,this.$method='post',this.$type=1),e&&this.raw(e),this},b.prototype.json=function(e){return 1!==this.$type&&(this.$flags=null),e&&this.raw(e),this.$type=1,'get'===this.$method&&(this.$method='post'),this},b.prototype.urlencoded=function(e){return 2!==this.$type&&(this.$flags=null),'get'===this.$method&&(this.$method='post'),this.$type=2,e&&this.raw(e),this},b.prototype.accept=function(e){var t=framework_utils.getContentType(e);return this.$headers.Accept!==t&&(this.$flags=null),this.$headers.Accept=t,this},b.prototype.xml=function(e){return 3!==this.$type&&(this.$flags=null),'get'===this.$method&&(this.$method='post'),this.$type=3,e&&this.raw(e),this},b.prototype.redirect=function(e){return this.$redirect=e,this},b.prototype.raw=function(e){return this.$data=e&&e.$clean?e.$clean():e,this},b.prototype.cookie=function(e,t){return this.$cookies||(this.$cookies={}),this.$cookies[e]=t,this},b.prototype.header=function(e,t){return this.$headers[e]=t,this},b.prototype.cache=function(e){return this.$cache_expire=e,this},b.prototype.set=function(e,t){if(this.$data||(this.$data={}),'object'!==('undefined'==typeof e?'undefined':_typeof(e)))return this.$data[e]=t,this;for(var r=Object.keys(e),n=0,o=r.length;n<o;n++)this.$data[r[n]]=e[r[n]];return this},b.prototype.rem=function(e){return this.$data&&this.$data[e]&&(this.$data[e]=void 0),this},b.prototype.stream=function(e){var t=this,r=t.$flags?t.$flags:[t.$method];if(!t.$flags){switch(!t.$nodnscache&&r.push('dnscache'),t.$type){case 1:r.push('json');break;case 3:r.push('xml')}t.$flags=r}return U.download(t.$url,r,t.$data,e,t.$cookies,t.$headers,void 0,t.$timeout)},b.prototype.exec=function(e){e||(e=NOOP);var t,r=this,n=r.$flags?r.$flags:[r.$method];if(!r.$flags){switch(!r.$nodnscache&&n.push('dnscache'),r.$length&&n.push('<'+r.$length),r.$redirect===!1&&n.push('noredirect'),r.$type){case 1:n.push('json');break;case 3:n.push('xml')}r.$flags=n}if(r.$cache_expire&&!r.$nocache){t='$rest_'+(r.$url+n.join(',')+(r.$data?C.stringify(r.$data):'')).hash();var o=F.cache.read2(t);if(o){var i=new framework_utils.EventEmitter2;return process.nextTick(E,i),e(null,r.maketransform(this.$schema?this.$schema.make(o.json):o.json,o),o),i}}return U.request(r.$url,n,r.$data,function(n,o,i,s,a){var c=n?'':s['content-type']||'',u=new w;return u.value=c.indexOf('/xml')===-1?o.isJSON()?F.onParseJSON(o):F.onParseQuery(o):o.parseXML(),null==u.value&&(u.value=EMPTYOBJECT),u.response=o,u.status=i,u.headers=s,u.hostname=a,u.cache=!1,u.datetime=F.datetime,r.$schema?n?e(n,EMPTYOBJECT,u):void r.$schema.make(r.maketransform(u.value,u),function(n,o){!n&&t&&F.cache.add(t,u,r.$cache_expire),e(n,n?EMPTYOBJECT:o,u),u.cache=!0}):(!n&&t&&F.cache.add(t,u,r.$cache_expire),e(n,r.maketransform(u.value,u),u),void(u.cache=!0))},r.$cookies,r.$headers,void 0,r.$timeout)},w.prototype.cookie=function(e){var t=this;if(t.cookies)return _(t.cookies[e]||'');var r=t.headers.cookie;if(!r)return'';t.cookies={};for(var n=r.split(';'),o=0,i=n.length;o<i;o++){var s=n[o].trim(),a=s.indexOf('=');a!==-1&&(t.cookies[s.substring(0,a)]=s.substring(a+1))}return _(t.cookies[e]||'')},global.NEWOPERATION=function(e,t){return D[e]=t,D[e].$owner=F.$owner(),D[e].$newversion=R.test(t.toString()),this},global.OPERATION=function(e,t,r,n){void 0===r&&(r=t,t=EMPTYOBJECT);var o=D[e],i=new p;if(o)if(o.$newversion){var s={};s.error=i,s.value=s.model=t,s.callback=function(e){e instanceof Error&&(i.push(e),e=EMPTYOBJECT),r(i.hasError()?i:null,e,n)},o(s)}else o(i,t,function(e){e instanceof Error&&(i.push(e),e=EMPTYOBJECT),r(i.hasError()?i:null,e,n)});else i.push('Operation "{0}" not found.'.format(e)),r(i,EMPTYOBJECT,n)},k.SchemaBuilder=t,k.RESTBuilder=b,k.ErrorBuilder=p,k.Pagination=h,k.Page=m,k.UrlBuilder=f,k.TransformBuilder=g,global.RESTBuilder=b,global.ErrorBuilder=p,global.TransformBuilder=g,global.Pagination=h,global.Page=m,global.UrlBuilder=global.URLBuilder=f,global.SchemaBuilder=t,k.uninstall=function(e){e&&(Object.keys(D).forEach(function(t){D[t].$owner===e&&delete D[t]}),k.eachschema(function(t,r,n){n.owner===e&&n.destroy()}))},k.restart=function(){N={},D={},Object.keys(P).forEach(function(e){e.indexOf('_')===-1&&(P[e]={})})},e}({exports:{}}),function(e){function t(e,t){O.resolve4(e.hostname,function(r,n){return r?t(r,e):(Ee[e.host]=n[0],e.host=n[0],void t(null,e))})}function r(e,t){var r='https:'===e.protocol?A:R,o=t.post?r.request(e,function(r){return n(r,e,t)}):r.get(e,function(r){return n(r,e,t)});return t.callback?(o.on('error',function(r){t.callback&&(t.callback(r,'',0,void 0,e.host),t.callback=null,t.evt.removeAllListeners(),t.evt=null)}),o.setTimeout(t.timeout,function(){t.callback&&(t.callback(new Error(S.httpStatus(408)),'',0,void 0,e.host),t.callback=null,t.evt.removeAllListeners(),t.evt=null)}),o.on('response',function(e){return e.req=o}),void o.end(t.data)):void o.on('error',NOOP)}function n(e,t,n){if(e._buffer=null,e._bufferlength=0,301===e.statusCode||302===e.statusCode){if(n.noredirect)return n.callback&&(n.callback(null,'',e.statusCode,e.headers,t.host),n.callback=null),n.evt&&(n.evt.removeAllListeners(),n.evt=null),e.req.removeAllListeners(),e.req=null,e.removeAllListeners(),void(e=null);if(n.redirect>3)return n.callback&&(n.callback(new Error('Too many redirects.'),'',0,void 0,t.host),n.callback=null),n.evt&&(n.evt.removeAllListeners(),n.evt=null),e.req.removeAllListeners(),e.req=null,e.removeAllListeners(),void(e=null);n.redirect++;var o=x.parse(e.headers.location);return o.headers=t.headers,o.agent=!1,o.method=t.method,e.req.removeAllListeners(),e.req=null,n.resolve?void S.resolve(e.headers.location,function(t,i){t||(o.host=i.host),e.removeAllListeners(),e=null,r(o,n)}):(e.removeAllListeners(),e=null,r(o,n))}n.length=+e.headers['content-length']||0,n.evt&&n.evt.$events.begin&&n.evt.emit('begin',n.length),e.on('data',function(e){var t=this;n.max&&t._bufferlength>n.max||(t._buffer?(j[0]=t._buffer,j[1]=e,t._buffer=Buffer.concat(j)):t._buffer=e,t._bufferlength+=e.length,n.evt&&n.evt.$events.data&&n.evt.emit('data',e,n.length?t._bufferlength/n.length*100:0))}),e.on('end',function(){var r=this,o=r._buffer?r._buffer.toString(n.encoding):'';r._buffer=void 0,n.evt&&(n.evt.$events.end&&n.evt.emit('end',o,r.statusCode,r.headers,t.host),n.evt.removeAllListeners(),n.evt=null),n.callback&&(n.callback(null,'HEAD'===t.method?r.headers:o,r.statusCode,r.headers,t.host),n.callback=null),e.req&&e.req.removeAllListeners(),e.removeAllListeners()}),e.resume()}function o(e,t){t.length=0;var r='https:'===e.protocol?A:R,n=t.post?r.request(e,function(r){return i(r,e,t)}):r.get(e,function(r){return i(r,e,t)});return t.callback?(n.on('error',function(e){t.callback&&(t.callback(e),t.callback=null,t.evt.removeAllListeners(),t.evt=null)}),n.setTimeout(t.timeout,function(){t.callback&&(t.callback(new Error(S.httpStatus(408))),
t.callback=null,t.evt.removeAllListeners(),t.evt=null)}),n.on('response',function(e){e.req=n,t.length=+e.headers['content-length']||0,t.evt&&t.evt.$events.begin&&t.evt.emit('begin',t.length)}),void n.end(t.data)):void n.on('error',NOOP)}function i(e,t,r){if(e._bufferlength=0,301===e.statusCode||302===e.statusCode){if(r.redirect>3)return r.callback&&r.callback(new Error('Too many redirects.')),e.req.removeAllListeners(),e.req=null,e.removeAllListeners(),void(e=null);r.redirect++;var n=x.parse(e.headers.location);return n.headers=t.headers,n.agent=!1,n.method=t.method,e.req.removeAllListeners(),e.req=null,r.resolve?void S.resolve(e.headers.location,function(t,i){t||(n.host=i.host),e.removeAllListeners(),e=null,o(n,r)}):(e.removeAllListeners(),e=null,o(n,r))}e.on('data',function(e){var t=this;t._bufferlength+=e.length,r.evt&&r.evt.$events.data&&r.evt.emit('data',e,r.length?t._bufferlength/r.length*100:0)}),e.on('end',function(){var n=this,o=n._buffer?n._buffer.toString(r.encoding):'';n._buffer=void 0,r.evt&&(r.evt.$events.end&&r.evt.emit('end',o,n.statusCode,n.headers,t.host),r.evt.removeAllListeners(),r.evt=null),e.req&&e.req.removeAllListeners(),e.removeAllListeners()}),e.resume(),r.callback&&r.callback(null,e,e.statusCode,e.headers,t.host)}function s(){return Math.floor(65536*Math.random()).toString(36)}function a(e,t,r){var n='undefined'==typeof t?'undefined':_typeof(t);if(r.type>7)return void 0!==t;switch(r.subtype){case'uid':var o=parseInt(t.substring(10,t.length-4),10);return!isNaN(o)&&t[t.length-1]===(o%2?'1':'0');case'zip':return t.isZIP();case'email':return t.isEmail();case'json':return t.isJSON();case'url':return t.isURL();case'phone':return t.isPhone()}return'number'===n?t>0:'string'===n||t instanceof Array?t.length>0:'boolean'===n?t===!0:null!=t&&(!(t instanceof Date)||'I'!==t.toString()[0])}function c(e,t){return'string'==typeof t&&t.isJSONDate()?new Date(t):t}function u(e,t){for(var r=e?2:0,n=t instanceof Int8Array||t instanceof Buffer,o=t.length,i=S.createBufferSize(o+r),s=0;s<o;s++)n?i[s+r]=t[s]:i[s+r]=t.charCodeAt(s);return e&&(i[0]=e>>8,i[1]=e),i}function l(e){var t=null;return e<=125?(t=S.createBufferSize(1),t[0]=e,t):e<=65535?(t=S.createBufferSize(3),t[0]=126,t[1]=e>>8&255,t[2]=255&e,t):(t=S.createBufferSize(9),t[0]=127,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e>>24&255,t[6]=e>>16&255,t[7]=e>>8&255,t[8]=255&e,t)}function p(e){var t,r,n=0;if(0===e.length)return n;var o=e.length;for(t=0;t<o;t++)r=e.charCodeAt(t),n=(n<<5)-n+r,n|=0;return n}function f(e,t,r,n){var o=0;void 0===r&&(r=0),void 0===n&&(n=e.length);for(var i=r,s=r+n;i<s;i++){var a=e[i];if(a){var c=a.match(re);c&&t(c,o++,s,i)}}}function d(e,t){for(;t--;)if(e/=1024,'0.000'===e.toFixed(3))return 0;return e}function h(e,t,r,n){t.$pending--,e.wait(t,r,n)}function m(e,t,r,n,o){this.isRunning=0,this.owner=e,this.name=t,this.fn=r,this.cb=n,this.waiting=o,this.interval=null,this.isCanceled=!1}function g(e){this._max=0,this._count=0,this._isRunning=!1,this._isEnd=!1,this.owner=e,this.onComplete=[],this.tasksPending={},this.tasksWaiting={},this.tasksAll=[],this.tasksTimeout={},this.isCanceled=!1,D.EventEmitter.call(this)}function v(){this.pending=[],this.pendingDirectory=[],this.directory=[],this.file=[],this.onComplete=null,this.onFilter=null,this.advanced=!1}function y(e,t,r){return r?e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24|e[t+4]<<32|e[t+5]<<40|e[t+6]<<48|e[t+7]<<56:e[t+7]<<32|e[t+6]<<40|e[t+5]<<48|e[t+4]<<56|e[t+3]|e[t+2]<<8|e[t+1]<<16|e[t]<<24}function b(e){var t=S.queuecache[e];if(t&&(t.running--,t.running<0&&(t.running=0),t.pending.length)){var r=t.pending.shift();if(!r)return void(t.running=0);t.running++,setImmediate(E,r,e)}}function E(e,t){e(function(){return b(t)})}function w(e,t,r,n){var o,i,s;for(i=r;i<t;i+=r)for(s=i;s>0&&1===n(e[s-r],e[s]);)o=e[s],e[s]=e[s-r],e[s-r]=o,s-=r}function _(e,t){for(var r=e.length,n=Math.floor(r/2);n;)w(e,r,n,t),n=Math.floor(n/2);return e}function k(){this.$events={}}function $(e,t){this.name=e,this.max=t||50,this.index=0,this.filename='chunker_{0}-'.format(e),this.stack=[],this.flushing=0,this.pages=0,this.count=0,this.filename=F.path.temp(this.filename)}var S=e.exports;global.framework_utils=e.exports;var O=require('dns'),x=require('url'),T=require('querystring'),R=require('http'),A=require('https'),C=require('path'),N=require('fs'),D=require('events'),P=require('crypto'),j=[null,null];global.framework_utils||(global.framework_utils=S);var I=/\.\w{2,8}($|\?)+/,M=/^[\s]+|[\s]+$/g,L=/(\d{1,2}\.\d{1,2}\.\d{4})|(\d{4}\-\d{1,2}\-\d{1,2})|(\d{1,2}\:\d{1,2}(\:\d{1,2})?)/g,H=/yyyy|yy|M+|d+|HH|H|hh|h|mm|m|ss|s|a|ww|w/g,q=/\{\d+\}/g,B=/\\/g,G=/<\/?[^>]+(>|$)/g,Y=/[^\u0000-\u007e]/g,z=/\w+\=\".*?\"/g,W=/&#?[a-z0-9]+;/g,J=/\{{2}[^}\n]*\}{2}/g,V=/(^\-|\s-)?[0-9]+/g,X=/(^\-|\s-)?[0-9\.\,]+/g,K=/^[A-Za-z0-9]+$/,Q=/[^a-zA-ZÃ¡-Å¾Ã-Å½\d\s:]/g,Z=/\-|\_/g,ee=/\/|\+/g,te=/\\u([\d\w]{4})/gi,re=/[\w\S]+/g,ne={a:'',e:'',i:'',o:'',u:'',b:1,f:1,p:1,v:1,c:2,g:2,j:2,k:2,q:2,s:2,x:2,z:2,d:3,t:3,l:4,m:5,n:5,r:6},oe='utf8',ie='\r\n',se='win'===require('os').platform().substring(0,3).toLowerCase(),ae=['January','February','March','April','May','June','July','August','September','October','November','December'],ce=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],ue={},le={flags:'r'},pe={end:!1},fe={'&lt':'<','&gt':'>','&quot':'"','&apos':'\'','&amp':'&','&lt;':'<','&gt;':'>','&quot;':'"','&apos;':'\'','&amp;':'&'},de=[],he=[],me=parseFloat(process.version.toString().replace('v','').replace(/\./g,''));Object.freeze(de),Object.freeze(he);for(var ge=[{b:' ',c:'Â '},{b:'0',c:'ß'},{b:'A',c:'â¶ï¼¡ÃÃÃáº¦áº¤áºªáº¨ÃÄÄáº°áº®áº´áº²È¦Ç ÃÇáº¢ÃÇºÇÈÈáº áº¬áº¶á¸ÄÈºâ±¯'},{b:'AA',c:'ê²'},{b:'AE',c:'ÃÇ¼Ç¢'},{b:'AO',c:'ê´'},{b:'AU',c:'ê¶'},{b:'AV',c:'ê¸êº'},{b:'AY',c:'ê¼'},{b:'B',c:'â·ï¼¢á¸á¸á¸ÉÆ'},{b:'C',c:'â¸ï¼£ê¾á¸ÄCÄÄÄÃÆÈ»'},{b:'D',c:'â¹ï¼¤á¸Äá¸á¸á¸á¸ÄÆÆá´ê¹'},{b:'Dh',c:'Ã'},{b:'DZ',c:'Ç±Ç'},{b:'Dz',c:'Ç²Ç'},{b:'E',c:'Éâºï¼¥ÃÃÃá»áº¾á»á»áº¼Äá¸á¸ÄÄÃáººÄÈÈáº¸á»È¨á¸Äá¸á¸ÆÆá´'},{b:'F',c:'ê¼â»ï¼¦á¸Æê»'},{b:'G',c:'â¼ï¼§Ç´Äá¸ ÄÄ Ç¦Ä¢Ç¤Æê ê½ê¾É¢'},{b:'H',c:'â½ï¼¨Ä¤á¸¢á¸¦Èá¸¤á¸¨á¸ªÄ¦â±§â±µê'},{b:'I',c:'â¾ï¼©ÃÃÃÄ¨ÄªÄ¬Ä°Ãá¸®á»ÇÈÈá»Ä®á¸¬Æ'},{b:'J',c:'â¿ï¼ªÄ´ÉÈ·'},{b:'K',c:'âï¼«á¸°Ç¨á¸²Ä¶á¸´Æâ±©êêêê¢'},{b:'L',c:'âï¼¬Ä¿Ä¹Ä½á¸¶á¸¸Ä»á¸¼á¸ºÅÈ½â±¢â± êêê'},{b:'LJ',c:'Ç'},{b:'Lj',c:'Ç'},{b:'M',c:'âï¼­á¸¾á¹á¹â±®ÆÏ»'},{b:'N',c:'ê¤È âï¼®Ç¸ÅÃá¹Åá¹Åá¹á¹Æêá´'},{b:'NJ',c:'Ç'},{b:'Nj',c:'Ç'},{b:'O',c:'âï¼¯ÃÃÃá»á»á»á»Ãá¹È¬á¹Åá¹á¹ÅÈ®È°ÃÈªá»ÅÇÈÈÆ á»á»á» á»á»¢á»á»ÇªÇ¬ÃÇ¾ÆÆêê'},{b:'OE',c:'Å'},{b:'OI',c:'Æ¢'},{b:'OO',c:'ê'},{b:'OU',c:'È¢'},{b:'P',c:'âï¼°á¹á¹Æ¤â±£êêê'},{b:'Q',c:'âï¼±êêÉ'},{b:'R',c:'âï¼²Åá¹ÅÈÈá¹á¹Åá¹Éâ±¤êê¦ê'},{b:'S',c:'âï¼³áºÅá¹¤Åá¹ Å á¹¦á¹¢á¹¨ÈÅâ±¾ê¨ê'},{b:'T',c:'âï¼´á¹ªÅ¤á¹¬ÈÅ¢á¹°á¹®Å¦Æ¬Æ®È¾ê'},{b:'Th',c:'Ã'},{b:'TZ',c:'ê¨'},{b:'U',c:'âï¼µÃÃÃÅ¨á¹¸Åªá¹ºÅ¬ÃÇÇÇÇá»¦Å®Å°ÇÈÈÆ¯á»ªá»¨á»®á»¬á»°á»¤á¹²Å²á¹¶á¹´É'},{b:'V',c:'âï¼¶á¹¼á¹¾Æ²êÉ'},{b:'VY',c:'ê '},{b:'W',c:'âï¼·áºáºÅ´áºáºáºâ±²'},{b:'X',c:'âï¼¸áºáº'},{b:'Y',c:'âï¼¹á»²ÃÅ¶á»¸È²áºÅ¸á»¶á»´Æ³Éá»¾'},{b:'Z',c:'âï¼ºÅ¹áºÅ»Å½áºáºÆµÈ¤â±¿â±«ê¢'},{b:'a',c:'âï½áºÃ Ã¡Ã¢áº§áº¥áº«áº©Ã£ÄÄáº±áº¯áºµáº³È§Ç¡Ã¤Çáº£Ã¥Ç»ÇÈÈáº¡áº­áº·á¸Äâ±¥ÉÉ'},{b:'aa',c:'ê³'},{b:'ae',c:'Ã¦Ç½Ç£'},{b:'ao',c:'êµ'},{b:'au',c:'ê·'},{b:'av',c:'ê¹ê»'},{b:'ay',c:'ê½'},{b:'b',c:'âï½á¸á¸á¸ÆÆÉÆ'},{b:'c',c:'ï½âÄÄÄÄÃ§á¸ÆÈ¼ê¿â'},{b:'d',c:'âï½á¸Äá¸á¸á¸á¸ÄÆÉÉÆá§Ôêª'},{b:'dh',c:'Ã°'},{b:'dz',c:'Ç³Ç'},{b:'e',c:'âï½Ã¨Ã©Ãªá»áº¿á»á»áº½Äá¸á¸ÄÄÃ«áº»ÄÈÈáº¹á»È©á¸Äá¸á¸ÉÇ'},{b:'f',c:'âï½á¸Æ'},{b:'ff',c:'ï¬'},{b:'fi',c:'ï¬'},{b:'fl',c:'ï¬'},{b:'ffi',c:'ï¬'},{b:'ffl',c:'ï¬'},{b:'g',c:'âï½ÇµÄá¸¡ÄÄ¡Ç§Ä£Ç¥É ê¡ê¿áµ¹'},{b:'h',c:'âï½Ä¥á¸£á¸§Èá¸¥á¸©á¸«áºÄ§â±¨â±¶É¥'},{b:'hv',c:'Æ'},{b:'i',c:'âï½Ã¬Ã­Ã®Ä©Ä«Ä­Ã¯á¸¯á»ÇÈÈá»Ä¯á¸­É¨Ä±'},{b:'j',c:'âï½ÄµÇ°É'},{b:'k',c:'âï½á¸±Ç©á¸³Ä·á¸µÆâ±ªêêêê£'},{b:'l',c:'âï½ÅÄºÄ¾á¸·á¸¹Ä¼á¸½á¸»Å¿ÅÆÉ«â±¡êêêÉ­'},{b:'lj',c:'Ç'},{b:'m',c:'âï½á¸¿á¹á¹É±É¯'},{b:'n',c:'âï½Ç¹ÅÃ±á¹Åá¹Åá¹á¹ÆÉ²Åêê¥Ð»Ô'},{b:'nj',c:'Ç'},{b:'o',c:'âï½Ã²Ã³Ã´á»á»á»á»Ãµá¹È­á¹Åá¹á¹ÅÈ¯È±Ã¶È«á»ÅÇÈÈÆ¡á»á»á»¡á»á»£á»á»Ç«Ç­Ã¸Ç¿êêÉµÉá´'},{b:'oe',c:'Å'},{b:'oi',c:'Æ£'},{b:'oo',c:'ê'},{b:'ou',c:'È£'},{b:'p',c:'âï½á¹á¹Æ¥áµ½êêêÏ'},{b:'q',c:'â ï½Éêê'},{b:'r',c:'â¡ï½Åá¹ÅÈÈá¹á¹Åá¹ÉÉ½êê§ê'},{b:'s',c:'â¢ï½Åá¹¥Åá¹¡Å¡á¹§á¹£á¹©ÈÅÈ¿ê©êáºÊ'},{b:'ss',c:'Ã'},{b:'t',c:'â£ï½á¹«áºÅ¥á¹­ÈÅ£á¹±á¹¯Å§Æ­Êâ±¦ê'},{b:'th',c:'Ã¾'},{b:'tz',c:'ê©'},{b:'u',c:'â¤ï½Ã¹ÃºÃ»Å©á¹¹Å«á¹»Å­Ã¼ÇÇÇÇá»§Å¯Å±ÇÈÈÆ°á»«á»©á»¯á»­á»±á»¥á¹³Å³á¹·á¹µÊ'},{b:'v',c:'â¥ï½á¹½á¹¿ÊêÊ'},{b:'vy',c:'ê¡'},{b:'w',c:'â¦ï½áºáºÅµáºáºáºáºâ±³'},{b:'x',c:'â§ï½áºáº'},{b:'y',c:'â¨ï½á»³Ã½Å·á»¹È³áºÃ¿á»·áºá»µÆ´Éá»¿'},{b:'z',c:'â©ï½ÅºáºÅ¼Å¾áºáºÆ¶È¥Éâ±¬ê£'}],ve=0;ve<ge.length;ve+=1)for(var ye=ge[ve].c,be=0;be<ye.length;be+=1)ue[ye[be]]=ge[ve].b;ge=null;var Fe={aac:'audio/aac',ai:'application/postscript',appcache:'text/cache-manifest',avi:'video/avi',bin:'application/octet-stream',bmp:'image/bmp',coffee:'text/coffeescript',css:'text/css',csv:'text/csv',doc:'application/msword',docx:'application/msword',dtd:'application/xml-dtd',eps:'application/postscript',exe:'application/octet-stream',flac:'audio/x-flac',geojson:'application/json',gif:'image/gif',gzip:'application/x-gzip',htm:'text/html',html:'text/html',ico:'image/x-icon',ics:'text/calendar',ifb:'text/calendar',jpe:'image/jpeg',jpeg:'image/jpeg',jpg:'image/jpeg',js:'text/javascript',json:'application/json',jsx:'text/jsx',less:'text/css',m4a:'audio/mp4a-latm',m4v:'video/x-m4v',manifest:'text/cache-manifest',md:'text/x-markdown',mid:'audio/midi',midi:'audio/midi',mov:'video/quicktime',mp3:'audio/mpeg',mp4:'video/mp4',mpe:'video/mpeg',mpeg:'video/mpeg',mpg:'video/mpeg',mpga:'audio/mpeg',mtl:'text/plain',mv4:'video/mv4',obj:'text/plain',ogg:'application/ogg',ogv:'video/ogg',package:'text/plain',pdf:'application/pdf',png:'image/png',ppt:'application/vnd.ms-powerpoint',pptx:'application/vnd.ms-powerpoint',ps:'application/postscript',rar:'application/x-rar-compressed',rtf:'text/rtf',sass:'text/css',scss:'text/css',sh:'application/x-sh',stl:'application/sla',svg:'image/svg+xml',swf:'application/x-shockwave-flash',tar:'application/x-tar',tif:'image/tiff',tiff:'image/tiff',txt:'text/plain',wav:'audio/x-wav',webm:'video/webm',webp:'image/webp',woff:'application/font-woff',woff2:'application/font-woff2',xht:'application/xhtml+xml',xhtml:'application/xhtml+xml',xls:'application/vnd.ms-excel',xlsx:'application/vnd.ms-excel',xml:'application/xml',xpm:'image/x-xpixmap',xsl:'application/xml',xslt:'application/xslt+xml',zip:'application/zip'},Ee={},we=Object.prototype.hasOwnProperty;return S.isEmpty=function(e){if(!e)return!0;if(e.length)return!1;for(var t in e)if(we.call(e,t))return!1;return!0},S.isEqual=function(e,t,r){for(var n=r?r:Object.keys(e),o=0,i=n.length;o<i;o++){var s=n[o],a=e[s],c=t[s],u='undefined'==typeof a?'undefined':_typeof(a),l='undefined'==typeof c?'undefined':_typeof(c);if(u!==l)return!1;if(a!==c){if(a instanceof Date&&c instanceof Date){if(a.getTime()===c.getTime())continue;return!1}if(a instanceof Array&&c instanceof Array){if(JSON.stringify(a)===JSON.stringify(c))continue;return!1}if('object'!==u||'object'!==l||!S.isEqual(a,c))return!1}}return!0},S.wait=function(e,t,r,n){if(e()===!0)return t(null,!0);var o=null,i=setInterval(function(){if(e()===!0)return clearInterval(i),clearTimeout(o),void(t&&t(null,!0))},n||500);o=setTimeout(function(){clearInterval(i),t&&t(new Error('Timeout.'),!1)},r||5e3)},S.$$wait=function(e,t,r){return function(n){S.wait(e,n,t,r)}},S.resolve=function(e,r){var n=x.parse(e);return r?Ee[n.host]?(n.host=Ee[n.host],void r(null,n)):void O.resolve4(n.hostname,function(e,o){e?setImmediate(t,n,r):(Ee[n.host]=o[0],n.host=o[0],r(null,n))}):Ee[n.host]},S.$$resolve=function(e){return function(t){return S.resolve(e,t)}},S.clearDNS=function(){Ee={}},S.keywords=function(e,t,r,n,o,i){void 0===t&&(t=!0),i=i||2,n=n||200,o=o||20;var s=[],a='soundex'===r;if(e instanceof Array){for(var c=0,u=e.length;c<u;c++)if(e[c]){var l=(t?e[c].removeDiacritics().toLowerCase().replace(/y/g,'i'):e[c].toLowerCase()).replace(/\n/g,' ').split(' ');if(l&&l.length)for(var p=0,f=l.length;p<f;p++)s.push(l[p])}}else s=(t?e.removeDiacritics().toLowerCase().replace(/y/g,'i'):e.toLowerCase()).replace(/\n/g,' ').split(' ');s||(s=[]);for(var d={},h=0,c=0,u=s.length;c<u;c++){var m=s[c].trim();if(!(m.length<i)){if(h>=n)break;if(t&&(m=m.replace(/\W|_/g,'')),r)if(a)m=m.soundex();else{var g=m.length/100*80;g>i+1&&(m=m.substring(0,g))}m.length<i||m.length>o||(d[m]?d[m]++:d[m]=1,h++)}}var v=Object.keys(d);return v.sort(function(e,t){var r=d[e],n=d[t];return r>n?-1:r<n?1:0}),v},S.request=function(e,t,n,o,i,s,a){'function'==typeof n?(a=s,s=i,i=o,o=n,n=''):n||(n=''),o===NOOP&&(o=null);var c,u={length:0,timeout:1e4,evt:new k,encoding:'string'!=typeof a?oe:a,callback:o,post:!1,redirect:0},l=0;if(s=s?S.extend({},s):{},t instanceof Array)for(var p=0,f=t.length;p<f;p++)if(t[p]>0)u.timeout=t[p];else if('<'!==t[p][0])switch(t[p].toLowerCase()){case'utf8':case'ascii':case'base64':case'binary':case'hex':u.encoding=t[p];break;case'xhr':s['X-Requested-With']='XMLHttpRequest';break;case'plain':s['Content-Type']='text/plain';break;case'html':s['Content-Type']='text/html';break;case'raw':l=3,s['Content-Type']='application/octet-stream';break;case'json':s['Content-Type']='application/json',!c&&(c='POST'),l=1;break;case'xml':s['Content-Type']='text/xml',!c&&(c='POST'),l=2;break;case'get':case'options':case'head':c=t[p].toUpperCase();break;case'noredirect':u.noredirect=!0;break;case'upload':s['Content-Type']='multipart/form-data';break;case'post':case'put':case'delete':case'patch':c=t[p].toUpperCase(),!s['Content-Type']&&(s['Content-Type']='application/x-www-form-urlencoded');break;case'dnscache':u.resolve=!0}else u.max=1024*t[p].substring(1).trim().parseInt();if(c?u.post='POST'===c||'PUT'===c||'DELETE'===c||'PATCH'===c:c='GET',3!==l&&('string'!=typeof n?n=1===l?JSON.stringify(n):T.stringify(n):'?'===n[0]&&(n=n.substring(1)),u.post||(n.length&&e.indexOf('?')===-1&&(e+='?'+n),n='')),n&&(u.data=n instanceof Buffer?n:S.createBuffer(n,oe),s['Content-Length']=u.data.length),i){var d='';for(var h in i)d+=(d?'; ':'')+h+'='+i[h];d&&(s.Cookie=d)}var m=x.parse(e);return m.method=c,m.agent=!1,m.headers=s,u.resolve?S.resolve(e,function(e,t){!e&&(m.host=t.host),r(m,u)}):r(m,u),u.evt},S.$$request=function(e,t,r,n,o,i,s){return function(a){S.request(e,t,r,a,n,o,i,s)}},S.btoa=function(e){return e instanceof Buffer?e.toString('base64'):S.createBuffer(e.toString(),'binary').toString('base64')},S.atob=function(e){return S.createBuffer(e,'base64').toString('binary')},S.download=function(e,t,r,n,i,s,a,c){'function'==typeof r&&(c=a,a=s,s=i,i=n,n=r,r=''),'number'==typeof i&&(i=null,c=i),'number'==typeof s&&(s=null,c=s),'number'==typeof a&&(a=null,c=a),'string'!=typeof a&&(a=oe);var u='GET',l=0,p={callback:n,resolve:!1,length:0,evt:new k,timeout:c||6e4,post:!1,encoding:a};if(s=s?S.extend({},s):{},null===r&&(r=''),t instanceof Array)for(var f=0,d=t.length;f<d;f++)if(t[f]>0)p.timeout=t[f];else if('<'!==t[f][0])switch(t[f].toLowerCase()){case'utf8':case'ascii':case'base64':case'binary':case'hex':p.encoding=t[f];break;case'xhr':s['X-Requested-With']='XMLHttpRequest';break;case'plain':s['Content-Type']='text/plain';break;case'html':s['Content-Type']='text/html';break;case'json':s['Content-Type']='application/json',l=1;break;case'xml':s['Content-Type']='text/xml',l=2;break;case'get':case'head':case'options':u=t[f].toUpperCase();break;case'upload':s['Content-Type']='multipart/form-data';break;case'post':case'patch':case'delete':case'put':u=t[f].toUpperCase(),s['Content-Type']||(s['Content-Type']='application/x-www-form-urlencoded');break;case'dnscache':p.resolve=!0}if(p.post='POST'===u||'PUT'===u||'DELETE'===u||'PATCH'===u,'string'!=typeof r?r=1===l?JSON.stringify(r):T.stringify(r):'?'===r[0]&&(r=r.substring(1)),p.post||(r.length&&e.indexOf('?')===-1&&(e+='?'+r),r=''),i){var h='';for(var m in i)h+=(h?'; ':'')+m+'='+i[m];h&&(s.Cookie=h)}var g=x.parse(e);return g.method=u,g.agent=!1,g.headers=s,r.length&&(p.data=S.createBuffer(r,oe),s['Content-Length']=p.data.length),p.resolve?S.resolve(e,function(e,t){e||(g.host=t.host),o(g,p)}):o(g,p),p.evt},S.$$download=function(e,t,r,n,o,i,s){return function(a){S.download(e,t,r,a,n,o,i,s)}},S.send=function(e,t,r,n,o,i,s,a){OBSOLETE('U.send()','Use U.upload() instead of U.send().'),'string'==typeof t&&(t=N.createReadStream(t,le));var c='----totaljs'+Math.random().toString(16).substring(2),u={};if(i&&S.extend(u,i),o){var l='';for(var p in o)l+=(l?'; ':'')+p+'='+o[p];l&&(u.Cookie=l)}e=S.getName(e),u['Cache-Control']='max-age=0',u['Content-Type']='multipart/form-data; boundary='+c;var f=new k,d=x.parse(r),h={protocol:d.protocol,auth:d.auth,method:s||'POST',hostname:d.hostname,port:d.port,path:d.path,agent:!1,headers:u},m=0,g=function(e){e.body=S.createBufferSize(),e._bufferlength=0,e.on('data',function(t){j[0]=e.body,j[1]=t,e.body=Buffer.concat(j),e._bufferlength+=t.length,f.$events.data&&f.emit('data',t,m?e._bufferlength/m*100:0)}),e.on('end',function(){var e=this;f.$events.end&&f.emit('end',e.statusCode,e.headers),f.removeAllListeners(),f=null,n&&n(null,e.body.toString('utf8'),e.statusCode,e.headers,d.host),e.body=null})},v='https:'===h.protocol?A:R,y=v.request(h,g);y.on('response',function(e){m=+e.headers['content-length']||0,f.$events.begin&&f.emit('begin',m)}),y.setTimeout(a||6e4,function(){y.removeAllListeners(),y=null,f.removeAllListeners(),f=null,n&&n(new Error(S.httpStatus(408)),'',408,void 0,d.host)}),y.on('error',function(e){y.removeAllListeners(),y=null,f.removeAllListeners(),f=null,n&&n(e,'',0,void 0,d.host)}),y.on('close',function(){y.removeAllListeners(),y=null});var b=ie+ie+'--'+c+ie+'Content-Disposition: form-data; name="File"; filename="'+e+'"'+ie+'Content-Type: '+S.getContentType(S.getExtension(e))+ie+ie;return y.write(b),t.length?(y.write(t),y.end(ie+ie+'--'+c+'--'),f):(t.on('end',function(){return y.end(ie+ie+'--'+c+'--')}),t.pipe(y,pe),f)},S.$$send=function(e,t,r,n,o,i,s){return function(a){S.send(e,t,r,a,n,o,i,s)}},S.upload=function(e,t,r,n,o,i,s){var a='----totaljs'+Math.random().toString(16).substring(2),c={};if(o&&S.extend_headers2(c,o),n){var u='';for(var l in n)u+=(u?'; ':'')+l+'='+n[l];u&&(c.Cookie=u)}c['Cache-Control']='max-age=0',c['Content-Type']='multipart/form-data; boundary='+a;var p=new k,f=x.parse(t),d={protocol:f.protocol,auth:f.auth,method:i||'POST',hostname:f.hostname,port:f.port,path:f.path,agent:!1,headers:c},h=0,m=function(e){e.body=S.createBufferSize(),e._bufferlength=0,e.on('data',function(t){j[0]=e.body,j[1]=t,e.body=Buffer.concat(j),e._bufferlength+=t.length,p.$events.data&&p.emit('data',t,h?e._bufferlength/h*100:0)}),e.on('end',function(){var e=this;p.$events.end&&p.emit('end',e.statusCode,e.headers),p.removeAllListeners(),p=null,r&&r(null,e.body.toString('utf8'),e.statusCode,e.headers,f.host),e.body=null})},g='https:'===d.protocol?A:R,v=g.request(d,m);v.on('response',function(e){h=+e.headers['content-length']||0,p.$events.begin&&p.emit('begin',h)}),v.setTimeout(s||6e4,function(){v.removeAllListeners(),v=null,p.removeAllListeners(),p=null,r&&r(new Error(S.httpStatus(408)),'',408,void 0,f.host)}),v.on('error',function(e){v.removeAllListeners(),v=null,p.removeAllListeners(),p=null,r&&r(e,'',0,void 0,f.host)}),v.on('close',function(){v.removeAllListeners(),v=null});var y=ie+ie+'--'+a+ie+'Content-Disposition: form-data; name="{0}"; filename="{1}"'+ie+'Content-Type: {2}'+ie+ie;return e.waitFor(function(e,t){return v.write(y.format(e.name,U.getName(e.filename),S.getContentType(S.getExtension(e.filename)))),e.buffer?(v.write(e.buffer),t()):(!e.stream&&(e.stream=N.createReadStream(e.filename)),e.stream.pipe(v,pe),e.stream.on('error',t),void e.stream.on('end',t))},function(){return v.end(ie+ie+'--'+a+'--')}),p},S.$$upload=function(e,t,r,n,o,i){return function(s){S.upload(e,t,s,r,n,o,i)}},S.trim=function(e,t){if(!e)return e;var r='undefined'==typeof e?'undefined':_typeof(e);if('string'===r)return e=e.trim(),t&&!e?void 0:e;if(e instanceof Array){for(var n=0,o=e.length;n<o;n++){var i=e[n];r='undefined'==typeof i?'undefined':_typeof(i),'object'!==r?'string'===r&&(e[n]=i.trim(),t&&!e[n]&&(e[n]=void 0)):S.trim(i,t)}return e}if('object'!==r)return e;for(var s=Object.keys(e),n=0,o=s.length;n<o;n++){var a=e[s[n]],r='undefined'==typeof a?'undefined':_typeof(a);'object'!==r?'string'===r&&(e[s[n]]=a.trim(),t&&!e[s[n]]&&(e[s[n]]=void 0)):S.trim(a,t)}return e},S.noop=global.noop=global.NOOP=function(){},S.httpStatus=function(e,t){return void 0===t&&(t=!0),(t?e+': ':'')+R.STATUS_CODES[e]},S.extend=function(e,t,r){if(!e||!t)return e;if('object'!==('undefined'==typeof e?'undefined':_typeof(e))||'object'!==('undefined'==typeof t?'undefined':_typeof(t)))return e;void 0===r&&(r=!0);for(var n=Object.keys(t),o=n.length;o--;){var i=n[o];(r||void 0===e[i])&&(e[i]=S.clone(t[i]))}return e},S.extend_headers=function(e,t){for(var r=Object.keys(e),n={},o=r.length;o--;)n[r[o]]=e[r[o]];for(r=Object.keys(t),o=r.length;o--;)n[r[o]]=t[r[o]];return n},S.extend_headers2=function(e,t){for(var r=Object.keys(t),n=r.length;n--;)e[r[n]]=t[r[n]];return e},S.clone=function(e,t,r){if(!e)return e;var n='undefined'==typeof e?'undefined':_typeof(e);if('object'!==n||e instanceof Date)return e;var o,i;if(e instanceof Array){o=e.length,i=new Array(o);for(var s=0;s<o;s++)if(n=_typeof(e[s]),'object'!==n||e[s]instanceof Date){if(r&&'function'===n)continue;i[s]=e[s]}else i[s]=S.clone(e[s],t,r);return i}i={};for(var a in e)if(!t||!t[a]){var c=e[a];if(c instanceof Buffer){var u=S.createBufferSize(c.length);c.copy(u),i[a]=u}else{var n='undefined'==typeof c?'undefined':_typeof(c);if('object'!==n||c instanceof Date){if(r&&'function'===n)continue;i[a]=c}else i[a]=S.clone(e[a],t,r)}}return i},S.copy=function(e,t){if(void 0===t)return S.extend({},e,!0);if(!t||!e||'object'!==('undefined'==typeof t?'undefined':_typeof(t))||'object'!==('undefined'==typeof e?'undefined':_typeof(e)))return t;for(var r=Object.keys(e),n=r.length;n--;){var o=r[n];void 0!==t[o]&&(t[o]=S.clone(e[o]))}return t},S.reduce=function(e,t,r){if(!(t instanceof Array)&&'object'===('undefined'==typeof t?'undefined':_typeof(t)))return S.reduce(e,Object.keys(t),r);if(e instanceof Array){for(var n=[],o=0,i=e.length;o<i;o++)n.push(S.reduce(e[o],t,r));return n}var s={};return Object.keys(e).forEach(function(n){r?t.indexOf(n)===-1&&(s[n]=e[n]):t.indexOf(n)!==-1&&(s[n]=e[n])}),s},S.assign=function(e,t,r){if(null==e)return e;for(var n=t.split('.'),o=e[n[0]],i=1;i<n.length-1;i++)o=o[n[i]];return o[n[n.length-1]]='function'==typeof r?r(o[n[n.length-1]]):r,e},S.isRelative=function(e){return!('//'===e.substring(0,2)||e.indexOf('http://')!==-1||e.indexOf('https://')!==-1)},S.streamer=function(e,t,r,n){'function'==typeof t&&(n=r,r=t,t=void 0);var o=0,i=S.createBufferSize();if(void 0===n&&(n=0),e=S.createBuffer(e,'utf8'),t&&(t=S.createBuffer(t,'utf8')),!t){var s=e.length;return function(t){if(t){j[0]=i,j[1]=t,i=Buffer.concat(j);var a=i.indexOf(e);if(a!==-1)for(;a!==-1;)if(n?n--:r(i.toString('utf8',0,a+s),o++),i=i.slice(a+s),a=i.indexOf(e),a===-1)return}}}var a=e.length,c=t.length,u=-1,l=-1,p=!1;return function(s){if(s){if(j[0]=i,j[1]=s,i=Buffer.concat(j),!p){if(u=i.indexOf(e),u===-1)return;p=!0}if(!p||(l=i.indexOf(t,u+a),l!==-1))for(;u!==-1;){if(n?n--:r(i.toString('utf8',u,l+c),o++),i=i.slice(l+c),p=!1,u=i.indexOf(e),u===-1)return;if(p=!0,l=i.indexOf(t,u+a),l===-1)return}}}},S.encode=function(e){if(null==e)return'';var t='undefined'==typeof e?'undefined':_typeof(e);return'string'!==t&&(e=e.toString()),e.encode()},S.decode=function(e){if(null==e)return'';var t='undefined'==typeof e?'undefined':_typeof(e);return'string'!==t&&(e=e.toString()),e.decode()},S.isStaticFile=function(e){return I.test(e)},S.parseInt=function(e,t){if(null==e)return t||0;var r='undefined'==typeof e?'undefined':_typeof(e);return'number'===r?e:('string'!==r?e.toString():e).parseInt(t)},S.parseBool=S.parseBoolean=function(e,t){if(null==e)return void 0!==t&&t;var r='undefined'==typeof e?'undefined':_typeof(e);return'boolean'===r?e:'number'===r?e>0:('string'!==r?e.toString():e).parseBool(t)},S.parseFloat=function(e,t){if(null==e)return t||0;var r='undefined'==typeof e?'undefined':_typeof(e);return'number'===r?e:('string'!==r?e.toString():e).parseFloat(t)},S.isArray=function(e){return e instanceof Array},S.isRegExp=function(e){return!(!e||'function'!=typeof e.test)},S.isDate=function(e){return e instanceof Date&&!isNaN(e.getTime())},S.isError=function(e){return!(!e||!e.stack)},S.isObject=function(e){try{return!(!e||Object.getPrototypeOf(e)!==Object.prototype)}catch(e){return!1}},S.getContentType=function(e){return'.'===e[0]&&(e=e.substring(1)),Fe[e]||'application/octet-stream'},S.getExtension=function(e){for(var t=e.length,r=e.length;r>1;r--){var n=e[r];if(' '===n||'?'===n)t=r;else{if('.'===n)return e.substring(r+1,t);if('/'===n)return''}}return''},S.getName=function(e){var t=e.length-1,r=e[t];'/'!==r&&'\\'!==r||(e=e.substring(0,t));var n=e.lastIndexOf('/');return n!==-1?e.substring(n+1):(n=e.lastIndexOf('\\'),n===-1?e:e.substring(n+1))},S.setContentType=function(e,t){if('.'===e[0]&&(e=e.substring(1)),e.length>8){var r=I.toString().replace(/\,\d+\}/,','+e.length+'}').substring(1);I=new RegExp(r.substring(0,r.length-1))}return Fe[e]=t,!0},S.path=function(e,t){return e||(e=''),t=t||'/',e[e.length-1]===t?e:e+t},S.join=function(){for(var e=[''],t=0;t<arguments.length;t++){var r=arguments[t];if(r){'/'===r[0]&&(r=r.substring(1));var n=r.length-1;'/'===r[n]&&(r=r.substring(0,n)),e.push(r)}}return e=e.join('/'),se&&e.indexOf(':')>-1?e.substring(1):e},S.$normalize=function(e){return se?e.replace(B,'/'):e},S.random=function(e,t){return e=e||1e5,t=t||0,Math.floor(Math.random()*(e-t+1))+t},S.GUID=function(e){e=e||40;for(var t='',r=0;r<e/3+1;r++)t+=s();return t.substring(0,e)},S.validate_builder=function(e,t,r,n,o,i,s,c){var u=n[r],l=u.onValidate||F.onValidate||NOOP,p=void 0===o?'':o+'.',f=u.properties;c||(c=''),null==e&&(e={});for(var d=0;d<f.length;d++){var h=f[d].toString();if(!s||s.indexOf(h)!==-1){var m=e[h],g='undefined'==typeof m?'undefined':_typeof(m),v=n[r].schema[h];if(void 0!==m){if('function'===g&&(m=e[h]()),'object'!==g&&Builders.isJoin(n,h)&&(g='object'),'object'===g&&!S.isDate(m)&&(u=n[r]))if(u=u.schema[h]||null,u===Date||u===String||u===Number||u===Boolean);else if(u&&'string'==typeof u){var y='['===u[0];if(!y){S.validate_builder(m,t,r,n,p+h,i,void 0,c);continue}if(u=u.substring(1,u.length-1).trim(),!(m instanceof Array)){t.add(c+h,c?'@'+h:'@',p+h,i);continue}if(void 0===n[u]){var b=l(h,m,p+h,e,r,v);if(void 0===b&&(b=a(h,m,v)))continue;if(g='undefined'==typeof b?'undefined':_typeof(b),'string'===g){t.add(c+h,b,p+h,i);continue}if('boolean'===g&&!b){t.add(c+h,c?'@'+h:'@',p+h,i);continue}b.isValid===!1&&t.add(c+h,b.error,p+h,i);continue}var E=l(h,m,p+h,e,r,v);if(void 0===E&&(E=a(h,m,v)))continue;if(void 0!==E){if(g='undefined'==typeof E?'undefined':_typeof(E),'string'===g){t.add(c+h,E,p+h,i);continue}if('boolean'===g&&!E){t.add(c+h,c?'@'+h:'@',p+h,i);continue}if(E.isValid===!1){t.add(c+h,E.error,p+h,i);continue}}for(var w=m.length,_=0;_<w;_++)S.validate_builder(m[_],t,u,n,p+h,_,void 0,c);continue}var k=l(h,m,p+h,e,r,v);void 0===k&&(k=a(h,m,v))||(g='undefined'==typeof k?'undefined':_typeof(k),'string'!==g?'boolean'!==g?k.isValid===!1&&t.add(c+h,k.error,p+h,i):k||t.add(c+h,c?'@'+h:'@',p+h,i):t.add(c+h,k,p+h,i))}else t.add(c+h,'@',p+h)}}return t},S.combine=function(){for(var e=F.directory,t=0,r=arguments.length;t<r;t++){var n=arguments[t];n&&('/'===n[0]&&(n=n.substring(1)),'~'===n[0]?e=n.substring(1):e+=('/'!==e[e.length-1]?'/':'')+n)}return S.$normalize(e)},S.removeDiacritics=function(e){return e.replace(Y,function(e){return ue[e]||e})},S.parseXML=function(e){for(var t=-1,r=0,n=0,o=[],i={},s=-1;;){if(t=e.indexOf('<![CDATA[',t),t===-1)break;r=e.indexOf(']]>',t+9),e=e.substring(0,t)+e.substring(t+9,r).trim().encode()+e.substring(r+3),t+=9}for(t=-1,r=0;;){if(t=e.indexOf('<',t+1),t===-1)break;if(r=e.indexOf('>',t+1),r===-1)break;var a=e.substring(t,r+1),c=a[1];if('?'!==c&&'/'!==c){n=a.indexOf(' ');var u=!0;n===-1&&(n=a.length-1,u=!1),s=t+a.length;var l='/'===a[a.length-2],p=a.substring(1,n);if(l||o.push(p),u){var f=a.match(z);if(f){for(var d={},h=f.length,m=0;m<h;m++){var g=f[m].indexOf('"');d[f[m].substring(0,g-1)]=f[m].substring(g+1,f[m].length-1).decode()}i[o.join('.')+(l?'.'+p:'')+'[]']=d}}}else{var v=o.pop();if(s===-1||v!==a.substring(2,a.length-1))continue;var y=(o.length?o.join('.')+'.':'')+v,b=e.substring(s,t).decode();void 0===i[y]?i[y]=b:i[y]instanceof Array?i[y].push(b):i[y]=[i[y],b],s=-1}}return i},S.parseJSON=function(e,t){try{return JSON.parse(e,t?c:void 0)}catch(e){return null}},S.parseQuery=function(e){return F.onParseQuery(e)},S.getWebSocketFrame=function(e,t,r,n){var o=u(e,t),i=l(o.length),s=S.createBufferSize(1+i.length+o.length);return s[0]=128|r,n&&(s[0]|=64),i.copy(s,1,0,i.length),o.copy(s,i.length+1,0,o.length),s},S.distance=function(e,t,r,n){var o=6371,i=(r-e).toRad(),s=(n-t).toRad(),a=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e.toRad())*Math.cos(r.toRad())*Math.sin(s/2)*Math.sin(s/2),c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return(o*c).floor(3)},S.ls=function(e,t,r){var n=new v;n.onComplete=t,'string'==typeof r?(r=r.toLowerCase(),r.onFilter=function(e,t){return!!t||e.toLowerCase().indexOf(r)}):S.isRegExp(r)?r.onFilter=function(e,t){return!!t||r.test(e)}:n.onFilter=r||null,n.walk(e)},S.ls2=function(e,t,r){var n=new v;n.advanced=!0,n.onComplete=t,'string'==typeof r?(r=r.toLowerCase(),r.onFilter=function(e,t){return!!t||e.toLowerCase().indexOf(r)}):S.isRegExp(r)?r.onFilter=function(e,t){return!!t||r.test(e)}:n.onFilter=r||null,n.walk(e)},Date.prototype.add=function(e,t){var r=this;if(e.constructor===Number)return new Date(r.getTime()+(e-e%1));if(void 0===t){var n=e.split(' ');e=n[1],t=S.parseInt(n[0])}var o=new Date(r.getTime());switch(e){case's':case'ss':case'sec':case'second':case'seconds':return o.setSeconds(o.getSeconds()+t),o;case'm':case'mm':case'minute':case'min':case'minutes':return o.setMinutes(o.getMinutes()+t),o;case'h':case'hh':case'hour':case'hours':return o.setHours(o.getHours()+t),o;case'd':case'dd':case'day':case'days':return o.setDate(o.getDate()+t),o;case'w':case'ww':case'week':case'weeks':return o.setDate(o.getDate()+7*t),o;case'M':case'MM':case'month':case'months':return o.setMonth(o.getMonth()+t),o;case'y':case'yyyy':case'year':case'years':return o.setFullYear(o.getFullYear()+t),o}return o},Date.prototype.diff=function(e,t){if(1===arguments.length)t=e,e=Date.now();else{var r='undefined'==typeof e?'undefined':_typeof(e);'string'===r?e=Date.parse(e):S.isDate(e)&&(e=e.getTime())}var n=this.getTime()-e;switch(t){case's':case'ss':case'second':case'seconds':return Math.ceil(n/1e3);case'm':case'mm':case'minute':case'minutes':return Math.ceil(n/1e3/60);case'h':case'hh':case'hour':case'hours':return Math.ceil(n/1e3/60/60);case'd':case'dd':case'day':case'days':return Math.ceil(n/1e3/60/60/24);case'M':case'MM':case'month':case'months':return Math.ceil(n/1e3/60/60/672);case'y':case'yyyy':case'year':case'years':return Math.ceil(n/1e3/60/60/8064)}return NaN},Date.prototype.extend=function(e){var t=new Date(this),r=e.match(L);if(!r)return t;for(var n=0,o=r.length;n<o;n++){var i,s,a=r[n];a.indexOf(':')===-1?a.indexOf('-')===-1?a.indexOf('.')===-1||(i=a.split('.'),s=+i[0],t.setDate(s),i[1]&&(s=+i[1],!isNaN(s)&&t.setMonth(s-1)),i[2]&&(s=+i[2],!isNaN(s)&&t.setFullYear(s))):(i=a.split('-'),s=+i[0],t.setFullYear(s),i[1]&&(s=+i[1],!isNaN(s)&&t.setMonth(s-1)),i[2]&&(s=+i[2],!isNaN(s)&&t.setDate(s))):(i=a.split(':'),s=+i[0],!isNaN(s)&&t.setHours(s),i[1]&&(s=+i[1],!isNaN(s)&&t.setMinutes(s)),i[2]&&(s=+i[2],!isNaN(s)&&t.setSeconds(s)))}return t},Date.prototype.compare=function(e){var t=this,r=t.getTime()-e.getTime();return 0===r?0:r<0?-1:1},Date.compare=function(e,t){return'string'==typeof e&&(e=e.parseDate()),'string'==typeof t&&(t=t.parseDate()),e.compare(t)},Date.prototype.format=function(e,t){var r=this,n=!1;if(e&&'!'===e[0]&&(n=!0,e=e.substring(1)),!e)return r.getFullYear()+'-'+(r.getMonth()+1).toString().padLeft(2,'0')+'-'+r.getDate().toString().padLeft(2,'0')+'T'+r.getHours().toString().padLeft(2,'0')+':'+r.getMinutes().toString().padLeft(2,'0')+':'+r.getSeconds().toString().padLeft(2,'0')+'.'+r.getMilliseconds().toString().padLeft(3,'0')+'Z';var o=r.getHours();return n&&o>=12&&(o-=12),e.replace(H,function(e){switch(e){case'yyyy':return r.getFullYear();case'yy':return r.getFullYear().toString().substring(2);case'MMM':var n=ae[r.getMonth()];return(F.resource(t,n)||n).substring(0,3);case'MMMM':var n=ae[r.getMonth()];return F.resource(t,n)||n;case'MM':return(r.getMonth()+1).toString().padLeft(2,'0');case'M':return r.getMonth()+1;case'ddd':var n=ce[r.getDay()];return(F.resource(t,n)||n).substring(0,3);case'dddd':var n=ce[r.getDay()];return F.resource(t,n)||n;case'dd':return r.getDate().toString().padLeft(2,'0');case'd':return r.getDate();case'HH':case'hh':return o.toString().padLeft(2,'0');
case'H':case'h':return r.getHours();case'mm':return r.getMinutes().toString().padLeft(2,'0');case'm':return r.getMinutes();case'ss':return r.getSeconds().toString().padLeft(2,'0');case's':return r.getSeconds();case'w':case'ww':var i=new Date(+r);return i.setHours(0,0,0),i.setDate(i.getDate()+4-(i.getDay()||7)),i=Math.ceil(((i-new Date(i.getFullYear(),0,1))/864e5+1)/7),'ww'===e?i.toString().padLeft(2,'0'):i;case'a':return r.getHours()>=12?'PM':'AM'}})},Date.prototype.toUTC=function(e){var t=this.getTime()+6e4*this.getTimezoneOffset();return e?t:new Date(t)},Date.prototype.parseDate=function(){return this},String.prototype.isJSONDate=function(){var e=this.length-1;return e>22&&e<30&&'Z'===this[e]&&'T'===this[10]&&'-'===this[4]&&':'===this[13]&&':'===this[16]},String.prototype.trim||(String.prototype.trim=function(){return this.replace(M,'')}),String.prototype.replaceAt||(String.prototype.replaceAt=function(e,t){return this.substr(0,e)+t+this.substr(e+t.length)}),String.prototype.startsWith=function(e,t){var r,n=this,o=e.length;return t===!0?(r=n.substring(0,o),r.length===o&&r.toLowerCase()===e.toLowerCase()):(r=t?n.substr(t,o):n.substring(0,o),r.length===o&&r===e)},String.prototype.endsWith=function(e,t){var r,n=this,o=e.length;return t===!0?(r=n.substring(n.length-o),r.length===o&&r.toLowerCase()===e.toLowerCase()):(r=t?n.substr(n.length-t-o,o):n.substring(n.length-o),r.length===o&&r===e)},String.prototype.replacer=function(e,t){var r=this,n=r.indexOf(e);return n===-1?r:r.substring(0,n)+t+r.substring(n+e.length)},String.prototype.hash=function(e,t){var r=this;switch(t&&(r+=t),e){case'md5':return r.md5();case'sha1':return r.sha1();case'sha256':return r.sha256();case'sha512':return r.sha512();default:return p(r)}},String.prototype.count=function(e){var t=0,r=0;do t=this.indexOf(e,t+e.length),t>0&&r++;while(t>0);return r},String.prototype.parseXML=function(){return F.onParseXML(this)},String.prototype.parseJSON=function(e){return S.parseJSON(this,e)},String.prototype.parseQuery=function(){return S.parseQuery(this)},String.prototype.parseTerminal=function(e,t,r,n){var o=this.split('\n');if('function'==typeof e)return n=r,r=t,t=e,f(o,t,r,n),this;void 0===r&&(r=0),void 0===n&&(n=o.length);var i=[],s=0,a=o[0];if(a||(a=o[1],r++),a||(a=o[2],r++),!a)return this;for(var c,u=e.length,l=0,p=u;l<p;l++){var d=e[l],h=-1,m=-1,g='undefined'==typeof d?'undefined':_typeof(d);'object'===g&&d.test?(c=a.match(d),c?(h=c.index,m=h+c.toString().length):(h=-1,m=-1)):'string'===g&&(c=a.indexOf(d),c===-1?(h=-1,m=-1):(h=c,m=a.indexOf(' ',h+d.length))),i.push({beg:h,end:m})}for(var l=r+1,p=r+1+n;l<p;l++){var a=o[l];if(a){for(var h,v=[],y=!1,b=0;b<u;b++){var F=i[b];if(F.beg!==-1){y=!0,h=0;for(var E=F.beg;E>-1;E--)if(' '===a[E]){h=E+1;break}v.push(a.substring(h,F.end===-1?void 0:F.end).trim())}else v.push('')}y&&t(v,s++,p,l)}}return this},String.prototype.parseDate=function(){var e=this.trim(),t=e.charCodeAt(e.length-1);if(41===t)return new Date(e);if(90===t)return new Date(Date.parse(e));var r=e.indexOf(' ')===-1?e.split('T'):e.split(' '),n=r[0].indexOf(':'),o=r[0].length;if(n!==-1){var i=r[1];r[1]=r[0],r[0]=i}void 0===r[0]&&(r[0]='');for(var s=void 0===r[1]||0===r[1].length,a=0;a<o;a++){var c=r[0].charCodeAt(a);if(!(45===c||46===c||c>47&&c<58)&&s)return new Date(e)}void 0===r[1]&&(r[1]='00:00:00');var u=r[0].indexOf('-')===-1,l=(r[0]||'').split(u?'.':'-'),p=(r[1]||'').split(':'),f=[];if(l.length<4&&p.length<2)return new Date(e);n=(p[2]||'').indexOf('.'),n!==-1?(p[3]=p[2].substring(n+1),p[2]=p[2].substring(0,n)):p[3]='0',f.push(+l[u?2:0]),f.push(+l[1]),f.push(+l[u?0:2]),f.push(+p[0]),f.push(+p[1]),f.push(+p[2]),f.push(+p[3]);for(var d=new Date,a=0,o=f.length;a<o;a++){isNaN(f[a])&&(f[a]=0);var h=f[a];if(0===h)switch(a){case 0:h<=0&&(f[a]=d.getFullYear());break;case 1:h<=0&&(f[a]=d.getMonth()+1);break;case 2:h<=0&&(f[a]=d.getDate())}}return new Date(f[0],f[1]-1,f[2],f[3],f[4],f[5])},String.prototype.parseDateExpiration=function(){for(var e=this,t=e.split(' '),r=new Date,n=t.length,o=0;o<n;o+=2){var i=t[o].parseInt();if(0!==i){var s=t[o+1];s&&(r=r.add(s,i))}}return r},String.prototype.contains=function(e,t){var r=this;if('string'==typeof e)return r.indexOf(e,'number'==typeof t?t:0)!==-1;for(var n=0,o=e.length;n<o;n++){var i=r.indexOf(e[n])!==-1;if(t){if(!i)return!1}else if(i)return!0}return t},String.prototype.localeCompare2=function(e){return this.removeDiacritics().localeCompare(e.removeDiacritics())},String.prototype.parseConfig=function(e){for(var t,r,n,o,i=this.split('\n'),s=i.length,a=S.extend({},e),c=0;c<s;c++){var u=i[c];if(u&&'#'!==u[0]&&'//'!==u.substring(0,2)&&(n=u.indexOf(' :'),n!==-1||(n=u.indexOf('\t:'),n!==-1)))switch(r=u.substring(0,n).trim(),o=u.substring(n+2).trim(),n=r.indexOf('('),n!==-1?(t=r.substring(n+1,r.indexOf(')')).trim().toLowerCase(),r=r.substring(0,n).trim()):t='',t){case'string':a[r]=o;break;case'number':case'float':case'double':case'currency':a[r]=o.isNumber(!0)?o.parseFloat():o.parseInt();break;case'boolean':case'bool':a[r]=o.parseBoolean();break;case'eval':case'object':case'array':a[r]=new Function('return '+o)();break;case'json':a[r]=o.parseJSON(!0);break;case'env':case'environment':a[r]=process.env[o];break;case'date':case'time':case'datetime':a[r]=o.parseDate();break;default:a[r]=o}}return a},String.prototype.format=function(){var e=arguments;return this.replace(q,function(t){var r=e[+t.substring(1,t.length-1)];return null==r?'':r})},String.prototype.encode=function(){for(var e='',t=0,r=this.length;t<r;t++){var n=this[t];switch(n){case'<':e+='&lt;';break;case'>':e+='&gt;';break;case'"':e+='&quot;';break;case'\'':e+='&apos;';break;case'&':e+='&amp;';break;default:e+=n}}return e},String.prototype.decode=function(){return this.replace(W,function(e){if('#'!==e.charAt(1))return fe[e]||e;var t='x'===e[2].toLowerCase()?parseInt(e.substr(3),16):parseInt(e.substr(2));return!t||t<-32768||t>65535?'':String.fromCharCode(t)})},String.prototype.urlEncode=function(){return encodeURIComponent(this)},String.prototype.urlDecode=function(){return decodeURIComponent(this)},String.prototype.params=function(e){OBSOLETE('String.params()','The method is deprecated instead of it use F.viewCompile() or String.format().');var t=this;return null==e?t:t.replace(J,function(t){var r=!1,n=t.substring(2,t.length-2).trim(),o='',i=n.indexOf('|');i!==-1&&(o=n.substring(i+1,n.length).trim(),n=n.substring(0,i).trim()),'!'===n[0]?n=n.substring(1):r=!0;var s;if(n.indexOf('.')!==-1){var a=n.split('.');2===a.length?e[a[0]]&&(s=e[a[0]][a[1]]):3===a.length?e[a[0]]&&e[a[0]][a[1]]&&(s=e[a[0]][a[1]][a[2]]):4===a.length?e[a[0]]&&e[a[0]][a[1]]&&e[a[0]][a[1]][a[2]]&&(s=e[a[0]][a[1]][a[2]][a[3]]):5===a.length&&e[a[0]]&&e[a[0]][a[1]]&&e[a[0]][a[1]][a[2]]&&e[a[0]][a[1]][a[2]][a[3]]&&(s=e[a[0]][a[1]][a[2]][a[3]][a[4]])}else s=n.length?e[n]:e;if('function'==typeof s&&(s=s(i)),void 0===s)return t;if(o.length){var c='undefined'==typeof s?'undefined':_typeof(s);if('string'===c){var u=+o;isNaN(u)||(s=s.max(u+3,'...'))}else('number'===c||S.isDate(s))&&(o.isNumber()&&(o=+o),s=s.format(o))}return s=s.toString(),r?S.encode(s):s})},String.prototype.max=function(e,t){var r=this;return'string'!=typeof t&&(t='...'),r.length>e?r.substring(0,e-t.length)+t:r},String.prototype.isJSON=function(){var e=this;if(e.length<=1)return!1;for(var t,r,n=e.length-1,o=0;;)if(t=e[o++],' '!==t&&'\n'!==t&&'\r'!==t&&'\t'!==t)break;for(;;)if(r=e[n--],' '!==r&&'\n'!==r&&'\r'!==r&&'\t'!==r)break;return'"'===t&&'"'===r||'['===t&&']'===r||'{'===t&&'}'===r},String.prototype.isURL=function(){return!(this.length<=7)&&F.validators.url.test(this)},String.prototype.isZIP=function(){return F.validators.zip.test(this)},String.prototype.isEmail=function(){return!(this.length<=4)&&F.validators.email.test(this)},String.prototype.isPhone=function(){return!(this.length<6)&&F.validators.phone.test(this)},String.prototype.isUID=function(){return!(this.length<18)&&F.validators.uid.test(this)},String.prototype.parseInt=function(e){var t=this.trim(),r=+t;return isNaN(r)?e||0:r},String.prototype.parseInt2=function(e){var t=this.match(V);return t?+t[0]:e||0},String.prototype.parseFloat2=function(e){var t=this.match(X);return t?+t[0].toString().replace(/\,/g,'.'):e||0},String.prototype.parseBool=String.prototype.parseBoolean=function(){var e=this.toLowerCase();return'true'===e||'1'===e||'on'===e},String.prototype.parseFloat=function(e){var t=this.trim();t.indexOf(',')!==-1&&(t=t.replace(',','.'));var r=+t;return isNaN(r)?e||0:r},String.prototype.capitalize=function(e){if(e)return this[0].toUpperCase()+this.substring(1);for(var t,r='',n=0,o=this.length;n<o;n++){var t=this[n-1];t=t&&' '!==t&&'\t'!==t&&'\n'!==t?this[n]:this[n].toUpperCase(),r+=t}return r},String.prototype.toUnicode=function(){for(var e='',t=this,r=t.length,n=0;n<r;++n)e+=t.charCodeAt(n)>126||t.charCodeAt(n)<32?'\\u'+t.charCodeAt(n).hex(4):t[n];return e},String.prototype.fromUnicode=function(){return unescape(this.replace(te,function(e,t){return String.fromCharCode(parseInt(t,16))}))},String.prototype.sha1=function(e){var t=P.createHash('sha1');return t.update(this+(e||''),oe),t.digest('hex')},String.prototype.sha256=function(e){var t=P.createHash('sha256');return t.update(this+(e||''),oe),t.digest('hex')},String.prototype.sha512=function(e){var t=P.createHash('sha512');return t.update(this+(e||''),oe),t.digest('hex')},String.prototype.md5=function(e){var t=P.createHash('md5');return t.update(this+(e||''),oe),t.digest('hex')},String.prototype.toSearch=function(){for(var e=this.replace(Q,'').trim().toLowerCase().removeDiacritics(),t=[],r='',n=0,o=e.length;n<o;n++){var i=e[n];'y'===i&&(i='i'),i!==r&&(r=i,t.push(i))}return t.join('')},String.prototype.toKeywords=String.prototype.keywords=function(e,t,r,n,o){return S.keywords(this,e,t,r,n,o)},String.prototype.encrypt=function(e,t){var r='0'+this,n=r.length,o=e.length,i=t?S.random(120)+40:65,s=n+i%o,a=[],c=0;a[0]=String.fromCharCode(i);for(var u=this.length+e.length,l=s-1;l>0;l--)c=r.charCodeAt(l%n),a[l]=String.fromCharCode(c^(e.charCodeAt(l%o)^i));var p=S.createBuffer(u+'='+a.join(''),oe).toString('base64').replace(ee,function(e){return'+'===e?'_':'-'});return c=p.indexOf('='),c>0?p.substring(0,c):p},String.prototype.decrypt=function(e){var t=this.replace(Z,function(e){return'-'===e?'/':'+'}),r=t.length%4;if(r)for(var n=0;n<r;n++)t+='=';t=S.createBuffer(t,'base64').toString(oe);var o=t.indexOf('=');if(o===-1)return null;var i=+t.substring(0,o);if(isNaN(i))return null;t=t.substring(o+1);for(var s=t.length,a=t.charCodeAt(0),c=e.length,u=s-a%c,l=[],n=u-1;n>0;n--)o=t.charCodeAt(n)^(a^e.charCodeAt(n%c)),l[n]=String.fromCharCode(o);var p=l.join('');return i!==p.length+e.length?null:p},String.prototype.base64ToFile=function(e,t){var r=this,n=r.indexOf(',');return n===-1?n=0:n++,N.writeFile(e,r.substring(n),'base64',t||S.noop),this},String.prototype.base64ToBuffer=function(){var e=this,t=e.indexOf(',');return t===-1?t=0:t++,S.createBuffer(e.substring(t),'base64')},String.prototype.base64ContentType=function(){var e=this,t=e.indexOf(';');return t===-1?'':e.substring(5,t)},String.prototype.removeDiacritics=function(){return S.removeDiacritics(this)},String.prototype.indent=function(e,t){var r='';for(void 0===t&&(t=' ');e--;)r+=t;return r+this},String.prototype.isNumber=function(e){var t=this,r=t.length;if(!r)return!1;e=e||!1;for(var n=0;n<r;n++){var o=t.charCodeAt(n);if(!e||44!==o&&46!==o){if(o<48||o>57)return!1}else e=!1}return!0},String.prototype.padLeft||(String.prototype.padLeft=function(e,t){var r=this,n=e-r.length;if(n<0)return r;for(void 0===t&&(t=' ');n--;)r=t+r;return r}),String.prototype.padRight||(String.prototype.padRight=function(e,t){var r=this,n=e-r.length;if(n<0)return r;for(void 0===t&&(t=' ');n--;)r+=t;return r}),String.prototype.insert=function(e,t){var r=this,n=r.substring(0,e),o=t.toString()+r.substring(e);return n+o},String.prototype.slug=String.prototype.toSlug=String.prototype.toLinker=String.prototype.linker=function(e){e=e||60;for(var t=this.trim().toLowerCase().removeDiacritics(),r='',n=t.length,o=0;o<n;o++){var i=t[o],s=t.charCodeAt(o);if(r.length>=e)break;s>31&&s<48?'-'!==r[r.length-1]&&(r+='-'):(s>47&&s<58||s>94&&s<123)&&(r+=i)}var a=r.length-1;return'-'===r[a]?r.substring(0,a):r},String.prototype.pluralize=function(e,t,r,n){return this.parseInt().pluralize(e,t,r,n)},String.prototype.isBoolean=function(){var e=this.toLowerCase();return'true'===e||'false'===e},String.prototype.isAlphaNumeric=function(){return K.test(this)},String.prototype.soundex=function(){for(var e=this.toLowerCase().split(''),t=e.shift(),r=t.toUpperCase(),n=0,o=e.length;n<o;n++){var i=ne[e[n]];void 0!==i&&(n?i!==e[n-1]&&(r+=i):i!==ne[t]&&(r+=i))}return(r+'000').substring(0,4)},String.prototype.removeTags=function(){return this.replace(G,'')},Number.prototype.floor=function(e){return Math.floor(this*Math.pow(10,e))/Math.pow(10,e)},Number.prototype.padLeft=function(e,t){return this.toString().padLeft(e,t||'0')},Number.prototype.padRight=function(e,t){return this.toString().padRight(e,t||'0')},Number.prototype.async=function(e,t){var r=this;return r?e(r--,function(){return setImmediate(function(){return r.async(e,t)})}):t&&t(),r},Number.prototype.format=function(e,t,r){var n=this;if('string'==typeof e)return n.format2(e);var o=n.toString(),i='',s='',a='-'===o[0]?'-':'';a&&(o=o.substring(1));var c=o.indexOf('.');if('string'==typeof e){var u=t;t=e,e=u}void 0===t&&(t=' '),c!==-1&&(i=o.substring(c+1),o=o.substring(0,c)),c=-1;for(var l=o.length-1;l>=0;l--)c++,c>0&&c%3===0&&(s=t+s),s=o[l]+s;return(e||i.length)&&(i=i.length>e?i.substring(0,e||0):i.padRight(e||0,'0')),i.length&&void 0===r&&(r='.'===t?',':'.'),a+s+(i.length?r+i:'')},Number.prototype.add=function(e,t){if(null==e)return this;if('number'==typeof e)return this+e;var r=e.charCodeAt(0),n=!1;(r<48||r>57)&&(n=!0,e=e.substring(1));var o,i=e.length;if('%'===e[i-1]){if(e=e.substring(0,i-1),n){var s=e.parseFloat();switch(r){case 42:o=this*(this/100*s);break;case 43:o=this+this/100*s;break;case 45:o=this-this/100*s;break;case 47:o=this/(this/100*s)}return void 0!==t?o.floor(t):o}return o=this/100*e.parseFloat(),void 0!==t?o.floor(t):o}switch(o=e.parseFloat(),r){case 42:o=this*o;break;case 43:o=this+o;break;case 45:o=this-o;break;case 47:o=this/o;break;default:o=this}return void 0!==t?o.floor(t):o},Number.prototype.format2=function(e){var t=0,r=this.toString(),n=0,o=0,i=0,s='',a=0;if('string'==typeof e){var c=!1;a=e.length;for(var u=0;u<a;u++){var l=e[u];'#'===l&&(c?o++:n++),'.'===l&&(c=!0)}var p=r,f='';if(t=r.indexOf('.'),t!==-1&&(p=r.substring(0,t),f=r.substring(t+1)),p.length>n){i=p.length-n;for(var d='',u=0;u<i;u++)d+='#';e=d+e}p.length<n&&(p=p.padLeft(n,' ')),f.length<o&&(f=f.padRight(o,'0')),f.length>o&&(f=f.substring(0,o)),c=!1,t=0;var h=!0;a=e.length;for(var u=0;u<a;u++){var l=e[u];if('#'===l){var m=c?f[t]:p[t];h&&(h=[',',' '].indexOf(m)!==-1),h||(s+=m),t++}else{if(h)continue;'.'===l&&(c=!0,t=0),s+=l}}return s}if(s='### ### ###',n=r.indexOf('.'),i=e||0,0===i&&n!==-1&&(i=r.length-(n+1)),i>0){s+='.';for(var u=0;u<i;u++)s+='#'}return this.format(s)},Number.prototype.pluralize=function(e,t,r,n){var o=this,i='';i=0==o?e||'':1==o?t||'':o>1&&o<5?r||'':n;var s=i.indexOf('#');if(s===-1)return i;var a=i.lastIndexOf('#'),c=i.substring(s,a+1);return o.format(c)+i.replace(c,'')},Number.prototype.hex=function(e){for(var t=this.toString(16).toUpperCase();t.length<e;)t='0'+t;return t},Number.prototype.VAT=function(e,t,r){var n=this,o='undefined'==typeof t?'undefined':_typeof(t);if('boolean'===o){var i=r;r=t,t=i,o='undefined'==typeof t?'undefined':_typeof(t)}return'undefined'===o&&(t=2),void 0===r&&(r=!0),e&&n?r?(n/(e/100+1)).floor(t):(n*(e/100+1)).floor(t):n},Number.prototype.discount=function(e,t){var r=this;return void 0===t&&(t=2),(r-r/100*e).floor(t)},Number.prototype.parseDate=function(e){return new Date(this+(e||0))},Number.prototype.toRad||(Number.prototype.toRad=function(){return this*Math.PI/180}),Number.prototype.filesize=function(e,t){if('string'==typeof e){var r=t;t=e,e=r}var n;switch(t){case'bytes':n=this;break;case'KB':n=this/1024;break;case'MB':n=d(this,2);break;case'GB':n=d(this,3);break;case'TB':n=d(this,4);break;default:t='bytes',n=this,n>1023&&(n/=1024,t='KB'),n>1023&&(n/=1024,t='MB'),n>1023&&(n/=1024,t='GB'),n>1023&&(n/=1024,t='TB')}return t=' '+t,(void 0===e?n.format(2).replace('.00',''):n.format(e))+t},Array.prototype.take=function(e){for(var t=[],r=this,n=r.length,o=0;o<n;o++)if(t.push(r[o]),t.length>=e)return t;return t},Array.prototype.extend=function(e,t){for(var r='function'==typeof e,n=0,o=this.length;n<o;n++)r?this[n]=e(this[n],n):this[n]=S.extend(this[n],e,t);return this},Array.prototype.first=function(e){var t=this[0];return void 0===t?e:t},Array.prototype.toObject=function(e){for(var t=this,r={},n=0,o=t.length;n<o;n++){var i=t[n];e?r[i[e]]=i:r[i]=!0}return r},Array.prototype.compare=function(e,t,r){for(var n=this,o={},i={},s=n.length,a=t.length,c=Math.max(s,a),u={},l=0;l<c;l++){var p=n[l];p&&(o[p[e]]=l);var f=t[l];f&&(i[f[e]]=l)}for(var d=-1,l=0;l<c;l++){var h,m,p=n[l],f=t[l];if(p){if(h=p[e],u[h])continue;u[h]=!0,d=i[h],void 0===d?r(p,void 0,l,-1):r(p,t[d],l,d)}if(f){if(m=f[e],u[m])continue;u[m]=!0,d=o[m],void 0===d?r(void 0,f,-1,l):r(n[d],f,d,l)}}},Array.prototype.pair=function(e,t,r,n){if(e instanceof Array){var o=e;e=t,t=o}t||(t=new Array(0));for(var i=t.length,s=0;;){var a=this[s++];if(!a)break;for(var c=!1,u=0;u<i;u++)if(a[e]===t[u][e]){r(a,t[u]),c=!0;break}!c&&n&&(s--,this.splice(s,1))}return this},Array.prototype.last=function(e){var t=this[this.length-1];return void 0===t?e:t},Array.prototype.quicksort=Array.prototype.orderBy=function(e,t,r){var n=this.length;if(!n||1===n)return this;'boolean'==typeof e&&(t=e,e=void 0),void 0===r&&(r=3),void 0===t&&(t=!0);var o=this,i=0,s=e?o[0][e]:o[0];switch('undefined'==typeof s?'undefined':_typeof(s)){case'string':i=s.isJSONDate()?4:1;break;case'number':i=2;break;case'boolean':i=3;break;default:if(!S.isDate(s))return o;i=4}return _(o,function(n,o){var s=e?n[e]:n,a=e?o[e]:o;if(1===i)return s&&a?t?s.substring(0,r).removeDiacritics().localeCompare(a.substring(0,r).removeDiacritics()):a.substring(0,r).removeDiacritics().localeCompare(s.substring(0,r).removeDiacritics()):0;if(2===i)return s>a?t?1:-1:s<a?t?-1:1:0;if(3===i)return s===!0&&a===!1?t?1:-1:s===!1&&a===!0?t?-1:1:0;if(4===i){if(!s||!a)return 0;s.getTime||(s=new Date(s)),a.getTime||(a=new Date(a));var c=s.getTime(),u=a.getTime();return c>u?t?1:-1:c<u?t?-1:1:0}return 0}),o},Array.prototype.trim=function(){for(var e=this,t=[],r=0,n=e.length;r<n;r++)'string'==typeof e[r]&&(e[r]=e[r].trim()),e[r]&&t.push(e[r]);return t},Array.prototype.skip=function(e){for(var t=[],r=this,n=r.length,o=0;o<n;o++)o>=e&&t.push(r[o]);return t},Array.prototype.where=function(e,t){for(var r=this,n=[],o='function'==typeof e,i=void 0!==t,s=0,a=r.length;s<a;s++)o?e.call(r,r[s],s)&&n.push(r[s]):i?r[s]&&r[s][e]===t&&n.push(r[s]):r[s]===e&&n.push(r[s]);return n},Array.prototype.findItem=Array.prototype.find=function(e,t){var r=this,n=r.findIndex(e,t);return n===-1?null:r[n]},Array.prototype.findIndex=function(e,t){for(var r=this,n='function'==typeof e,o=void 0!==t,i=0,s=r.length;i<s;i++)if(n){if(e.call(r,r[i],i))return i}else if(o){if(r[i]&&r[i][e]===t)return i}else if(r[i]===e)return i;return-1},Array.prototype.remove=function(e,t){for(var r=this,n=[],o='function'==typeof e,i=void 0!==t,s=0,a=r.length;s<a;s++)o?!e.call(r,r[s],s)&&n.push(r[s]):i?r[s]&&r[s][e]!==t&&n.push(r[s]):r[s]!==e&&n.push(r[s]);return n},Array.prototype.wait=Array.prototype.waitFor=function(e,t,r){var n=this,o=!1;if(!e.$index&&(e.$pending=0,e.$index=0,o=!0,'number'==typeof t)){var i=r;r=t,t=i}void 0===r&&(r=1);var s=r===!0?n.shift():n[e.$index];if(e.$index++,void 0===s)return e.$pending?n:(t&&t(),e.$index=0,n);if(e.$pending++,e.call(n,s,function(){return setImmediate(h,n,e,t,r)}),!o||r===!0)return n;for(var a=1;a<r;a++)n.wait(e,t,0);return n},Array.prototype.async=function(e,t){var r=this;'function'==typeof e?(t=e,e=1):void 0===e&&(e=1),void 0===r.$pending&&(r.$pending=0);var n=r.shift();if(void 0===n)return r.$pending?r:(r.$pending=void 0,t&&t(),r);for(var o=0;o<e;o++)o&&(n=r.shift()),r.$pending++,n(function(){setImmediate(function(){r.$pending--,r.async(1,t)})});return r},Array.prototype.randomize=function(){return OBSOLETE('Array.randomize()','Use Array.random().'),this.random()},Array.prototype.random=function(){var e=this,t=(10*Math.floor(1e8*Math.random())).toString(),r=0,n=0;return e.sort(function(){var e=t[r++];return void 0===e&&(e=t[0],r=0),n>e?(n=e,-1):n===e?(n=e,0):(n=e,1)}),e},Array.prototype.limit=function(e,t,r,n){void 0===n&&(n=0);for(var o=[],i=this,s=n+e,a=n;a<s;a++){var c=i[a];{if(void 0===c)return o.length?(t(o,function(){return r&&r()},n,n+e),i):(r&&r(),i);o.push(c)}}return o.length?(t(o,function(){s<i.length?i.limit(e,t,r,s):r&&r()},n,n+e),i):(r&&r(),i)},Array.prototype.unique=function(e){for(var t=this,r=[],n=0,o=0,i=t.length;o<i;o++){var s=t[o];if(e)if(0!==n){for(var a=!0,c=0;c<n;c++)if(r[c][e]===s[e]){a=!1;break}a&&(r.push(s),n++)}else r.push(s),n++;else r.indexOf(s)===-1&&r.push(s)}return r},m.prototype.run=function(){var e=this;try{if(e.isCanceled)return e.complete(),e;e.isRunning=1,e.owner.tasksWaiting[e.name]=!0,e.owner.emit('begin',e.name);var t=e.owner.tasksTimeout[e.name];t>0&&(e.interval=setTimeout(function(){e.timeout()},t)),e.fn(function(){setImmediate(function(){return e.complete()})})}catch(t){e.owner.emit('error',e.name,t),e.complete()}return e},m.prototype.timeout=function(e){var t=this;return e>0?(clearTimeout(t.interval),setTimeout(function(){t.timeout()},e),t):e<=0?(clearTimeout(t.interval),setTimeout(function(){t.timeout()},e),t):(setImmediate(function(){return t.cancel(!0)}),t)},m.prototype.cancel=function(e){var t=this;return t.isCanceled=!0,e?t.owner.emit('timeout',t.name):t.owner.emit('cancel',t.name),t.fn=null,t.cb=null,t.complete(),t},m.prototype.complete=function(){var e=this,t=e.owner;if(e.isRunning=2,delete t.tasksPending[e.name],delete t.tasksWaiting[e.name],!e.isCanceled)try{t.emit('end',e.name),e.cb&&e.cb()}catch(r){t.emit('error',r,e.name)}return setImmediate(function(){t.reload(),t.refresh()}),t},g.prototype={get count(){return this._count},get percentage(){var e=100-Math.floor(100*this._count/this._max);return e?e:0}},g.prototype.__proto__=Object.create(D.EventEmitter.prototype,{constructor:{value:g,enumberable:!1}}),g.prototype.reload=function(){var e=this;return e.tasksAll=Object.keys(e.tasksPending),e.emit('percentage',e.percentage),e},g.prototype.cancel=function(e){var t=this;if(void 0===e){t.isCanceled=!0;for(var r=0;r<t._count;r++)t.cancel(t.tasksAll[r]);return!0}var n=t.tasksPending[e];return!!n&&(delete t.tasksPending[e],delete t.tasksWaiting[e],n.cancel(),n=null,t.reload(),t.refresh(),!0)},g.prototype.await=function(e,t,r){var n=this;return!n.isCanceled&&('function'==typeof e&&(r=t,t=e,e=S.GUID(6)),!n.tasksPending[e]&&(n.tasksPending[e]=new m(n,e,t,r,null),n._max++,n.reload(),n.refresh(),!0))},g.prototype.wait=function(e,t,r,n){var o=this;return!o.isCanceled&&('function'==typeof t&&(n=r,r=t,t=null),!o.tasksPending[e]&&(o.tasksPending[e]=new m(o,e,r,n,t),o._max++,o.reload(),o.refresh(),!0))},g.prototype.complete=function(e){return this.run(e)},g.prototype.run=function(e){return this._isRunning=!0,e&&this.onComplete.push(e),this.refresh(),this},g.prototype.isRunning=function(e){if(!e)return this._isRunning;var t=this.tasksPending[e];return!!t&&1===t.isRunning},g.prototype.isWaiting=function(e){var t=this.tasksPending[e];return!!t&&0===t.isRunning},g.prototype.isPending=function(e){return!!this.tasksPending[e]},g.prototype.timeout=function(e,t){return t?this.tasksTimeout[e]=t:this.tasksTimeout[e]=void 0,this},g.prototype.refresh=function(e){var t=this;if(!t._isRunning||t._isEnd)return t;t._count=t.tasksAll.length;for(var r=0;;){var e=t.tasksAll[r++];if(!e)break;var n=t.tasksPending[e];if(!n)break;t.isCanceled||n.isCanceled?(delete t.tasksPending[e],delete t.tasksWaiting[e],t.tasksAll.splice(r,1),t._count=t.tasksAll.length,r--):0!==n.isRunning||n.waiting&&t.tasksPending[n.waiting]||n.run()}if(0===t._count){t._isRunning=!1,t._isEnd=!0,t.emit('complete'),t.emit('percentage',100),t._max=0;var o=t.onComplete,i=o.length;t.onComplete=[];for(var s=0;s<i;s++)try{o[s]()}catch(e){t.emit('error',e)}setImmediate(function(){return t._isEnd=!1})}return t},v.prototype.reset=function(){return this.file.length=0,this.directory.length=0,this.pendingDirectory.length=0,this},v.prototype.walk=function(e){var t=this;if(e instanceof Array){for(var r=e.length,n=0;n<r;n++)t.pendingDirectory.push(e[n]);return void t.next()}N.readdir(e,function(r,n){if(r)return t.next();for(var o=n.length,i=0;i<o;i++)t.pending.push(C.join(e,n[i]));t.next()})},v.prototype.stat=function(e){var t=this;N.stat(e,function(r,n){return r?t.next():!n.isDirectory()||t.onFilter&&!t.onFilter(e,!0)?(t.onFilter&&!t.onFilter(e,!1)||t.file.push(t.advanced?{filename:e,stats:n}:e),void t.next()):(t.directory.push(e),t.pendingDirectory.push(e),void t.next())})},v.prototype.next=function(){var e=this;if(e.pending.length){var t=e.pending.shift();return void e.stat(t)}if(e.pendingDirectory.length){var r=e.pendingDirectory.shift();return void e.walk(r)}e.onComplete(e.advanced?e.file.filename:e.file,e.directory)},S.Async=g,S.sync=function(e,t){return function(){var r,n,o=[].slice.call(arguments),i=!1,s=t||this;return o.push(function(){r=arguments,!i&&n&&(i=!0,n.apply(s,r))}),e.apply(s,o),function(e){n=e,!i&&r&&(i=!0,n.apply(s,r))}}},S.sync2=function(e,t){return function(){var r,n,o=!1,i=t||this,s=[].slice.call(arguments);return s.push(function(){r=arguments,!o&&n&&(o=!0,n.apply(i,r))}),e.apply(i,s),function(e){n=e,!o&&r&&(o=!0,n.apply(i,r))}}()},S.async=function(e,t){var r=this;return function(n){function o(e,t){var r,i;try{var a=!e;switch(a){case!0:r=c.next(t);break;case!1:r=c.throw(e)}}catch(e){if(!n)return;return i='undefined'==typeof n?'undefined':_typeof(n),'object'===i&&n.isController?void(e instanceof ErrorBuilder?n.content(e):n.view500(e)):void('function'===i&&setImmediate(function(){return n(e)}))}if(r.done)return void('function'==typeof n&&n(null,r.value));var u=r.value instanceof Promise;if('function'!=typeof r.value&&!u)return void o.call(s,null,r.value);try{if(u)return void r.value.then(function(e){return o.call(s,null,e)});r.value.call(s,function(){o.apply(s,arguments)})}catch(e){setImmediate(function(){return o.call(s,e)})}}var i,s=this;if(arguments.length)if(t)i=arguments[1];else{i=[];for(var a=1;a<arguments.length;a++)i.push(arguments[a])}else i=new Array(0);var c=e.apply(r,i);return o(null),c.value}},S.getMessageLength=function(e,t){var r=127&e[1];return 126===r?e.length<4?-1:y([e[3],e[2],0,0,0,0,0,0],0,t):127===r?e.Length<10?-1:y([e[9],e[8],e[7],e[6],e[5],e[4],e[3],e[2]],0,t):r},S.queuecache={},S.queue=function(e,t,r){if(!r)return!1;if(!t)return r(NOOP),!0;S.queuecache[e]||(S.queuecache[e]={limit:t,running:0,pending:[]});var n=S.queuecache[e];return n.running>=n.limit?(n.pending.push(r),!1):(n.running++,setImmediate(E,r,e),!0)},S.minifyStyle=function(e){return require('./internal').compile_css(e)},S.minifyScript=function(e){return require('./internal').compile_javascript(e)},S.minifyHTML=function(e){return require('./internal').compile_html(e)},S.restart=function(){S.queuecache={},Ee={}},S.parseTheme=function(e){if('='!==e[0])return'';var t=e.indexOf('/',2);return t===-1?'':(e=e.substring(1,t),'?'===e?F.config['default-theme']:e)},S.set=function(e,t,r){var n='S+'+t;if(F.temporary.other[n])return F.temporary.other[n](e,r);for(var o=t.split('.'),i=[],s='',a=0,c=o.length;a<c;a++){s+=(''!==s?'.':'')+o[a];var u=o[a]instanceof Array?'[]':'{}';{if(a===c-1){if('{}'===u)break;s=s.substring(0,s.lastIndexOf('[')),i.push('if(!(w.'+s+' instanceof Array))w.'+s+'='+u);break}i.push('if(typeof(w.'+s+')!=="object"||w.'+s+'===null)w.'+s+'='+u)}}var l=new Function('w','a','b',i.join(';')+';w.'+t.replace(/\'/,'\'')+'=a;return a');F.temporary.other[n]=l,l(e,r,t)},S.get=function(e,t){var r='G='+t;if(F.temporary.other[r])return F.temporary.other[r](e);for(var n=t.split('.'),o=[],i='',s=0,a=n.length-1;s<a;s++){var c=n[s],u=c.lastIndexOf('[');u!==-1&&o.push('if(!w.'+(i?i+'.':'')+c.substring(0,u)+')return'),i+=(''!==i?'.':'')+n[s],o.push('if(!w.'+i+')return')}var l=new Function('w',o.join(';')+';return w.'+t.replace(/\'/,'\''));return F.temporary.other[r]=l,l(e)},global.Async=global.async=S.async,global.sync=global.SYNCHRONIZE=S.sync,global.sync2=S.sync2,k.prototype.emit=function(e,t,r,n,o,i,s,a){var c=this.$events[e];if(c){for(var u=!1,l=0,p=c.length;l<p;l++)c[l].$once&&(u=!0),c[l].call(this,t,r,n,o,i,s,a);u&&(c=c.remove(function(e){return e.$once}),c.length?this.$events[e]=c:this.$events[e]=void 0)}return this},k.prototype.on=function(e,t){return this.$events[e]?this.$events[e].push(t):this.$events[e]=[t],this},k.prototype.once=function(e,t){return t.$once=!0,this.on(e,t)},k.prototype.removeListener=function(e,t){var r=this.$events[e];return r&&(r=r.remove(function(e){return e===t}),r.length?this.$events[e]=r:this.$events[e]=void 0),this},k.prototype.removeAllListeners=function(e){return e===!0?this.$events=he:e?this.$events[e]=void 0:this.$events={},this},S.EventEmitter2=k,$.prototype.append=$.prototype.write=function(e){var t=this;t.stack.push(e);var r=t.stack.length;return r>=t.max&&(t.flushing++,t.pages++,t.count+=r,N.writeFile(t.filename+t.index++ +'.json',JSON.stringify(t.stack),function(){return t.flushing--}),t.stack=[]),t},$.prototype.end=function(){var e=this,t=e.stack.length;return t&&(e.flushing++,e.pages++,e.count+=t,N.writeFile(e.filename+e.index++ +'.json',JSON.stringify(e.stack),function(){return e.flushing--}),e.stack=[]),e},$.prototype.each=function(e,t,r){var n=this;return void 0===r&&(r=0),r>=n.index?t&&t():(n.read(r++,function(o,i){e(i,function(){return n.each(e,t,r)},r-1)}),n)},$.prototype.read=function(e,t){var r=this;return r.flushing?void(r.flushing_timeout=setTimeout(function(){return r.read(e,t)},300)):(N.readFile(r.filename+e+'.json',function(e,r){e?t(null,de):t(null,r.toString('utf8').parseJSON(!0))}),r)},$.prototype.clear=function(){for(var e=[],t=0;t<this.index;t++)e.push(this.filename+t+'.json');return e.wait(function(e,t){return N.unlink(e,t)}),this},$.prototype.destroy=function(){return this.clear(),this.indexer=0,this.flushing=0,clearTimeout(this.flushing_timeout),this.stack=null,this},S.chunker=function(e,t){return new $(e,t)},S.ObjectToArray=function(e){if(null==e)return de;for(var t=Object.keys(e),r=[],n=0,o=t.length;n<o;n++)r.push({key:t[n],value:e[t[n]]});return r},me>699?(S.createBufferSize=function(e){return Buffer.alloc(e||0)},S.createBuffer=function(e,t){return Buffer.from(e||'',t)}):(S.createBufferSize=function(e){return new Buffer(e||0)},S.createBuffer=function(e,t){return new Buffer(e||'',t)}),global.WAIT=S.wait,!global.F&&require('./index'),e}({exports:{}}),function(e){function t(e,t){return e[t]<<8|e[t+1]}function r(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function n(e,t,r,n){var o='undefined'==typeof e?'undefined':_typeof(e);this.width=r,this.height=n,this.builder=[],this.filename='string'===o?e:null,this.currentStream='object'===o?e:null,this.isIM=null==t?'im'===F.config['default-image-converter']:t,this.outputType='string'===o?framework_utils.getExtension(e):'jpg',this.islimit=!1}function o(e,t){return e.priority>t.priority?1:-1}function i(e,t){return(t?' ':'')+e.replace(h,'')}var s=e.exports;global.framework_image=e.exports;var a={192:!0,193:!0,194:!0,195:!0,197:!0,198:!0,199:!0,201:!0,202:!0,203:!0,205:!0,206:!0,207:!0},c=require('child_process'),u=c.exec,l=c.spawn,p=require('fs'),f=/(width=\"\d+\")+|(height=\"\d+\")+/g,d=/\//g,h=/\$\(.*?\)|\'/g,m={},g={};return global.framework_utils||(global.framework_utils=require('./utils')),s.measureGIF=function(e){return{width:e[6],height:e[8]}},s.measureJPG=function(e){var r=e.length,n=0,o=255==e[0]&&216==e[1];if(o){for(n+=2;n<r;){for(;255!=e[n];)n++;for(;255==e[n];)n++;{if(a[e[n]]){var i=t(e,n+6),s=t(e,n+4);
return{width:i,height:s}}n+=t(e,++n)}}return null}},s.measurePNG=function(e){return{width:r(e,16),height:r(e,20)}},s.measureSVG=function(e){var t=e.toString('utf8').match(f);if(t){for(var r=0,n=0,o=0,i=t.length;o<i;o++){var s=t[o];if(r>0&&n>0)break;!r&&s.startsWith('width="')&&(r=s.parseInt2()),!n&&s.startsWith('height="')&&(n=s.parseInt2())}return{width:r,height:n}}},n.prototype.clear=function(){var e=this;return e.builder=[],e},n.prototype.measure=function(e){var t=this,r=t.filename.lastIndexOf('.');if(!t.filename)return void e(new Error('Measure does not support stream.'));if(r===-1)return void e(new Error('This type of file is not supported.'));var n=t.filename.substring(r).toLowerCase(),o=require('fs').createReadStream(t.filename,{start:0,end:'.jpg'===n?4e4:24});return o.on('data',function(t){switch(n){case'.jpg':return void e(null,s.measureJPG(t));case'.gif':return void e(null,s.measureGIF(t));case'.png':return void e(null,s.measurePNG(t))}e(new Error('This type of file is not supported.'))}),o.on('error',e),t},n.prototype.$$measure=function(){var e=this;return function(t){e.measure(t)}},n.prototype.save=function(e,t,r){var n=this;'function'==typeof e&&(t=e,e=null),!n.builder.length&&n.minify(),e=e||n.filename||'';var o=n.cmd(n.filename?n.filename:'-',e);F.isWindows&&(o=o.replace(d,'\\'));var i=u(o,function(r){if(i.kill(),i=null,n.clear(),t){if(r)return void t(r,!1);var o=g[n.outputType];if(!o)return t(null,!0);var s=p.createReadStream(e),a=p.createWriteStream(e+'_');s.pipe(o()).pipe(a),a.on('finish',function(){return p.rename(e+'_',e,function(){return t(null,!0)})})}});return n.currentStream&&(n.currentStream instanceof Buffer?i.stdin.end(n.currentStream):n.currentStream.pipe(i.stdin)),CLEANUP(i.stdin),r&&r(i.stdin),n},n.prototype.$$save=function(e,t){var r=this;return function(n){r.save(e,n,t)}},n.prototype.pipe=function(e,t,r){var n=this;'object'===('undefined'==typeof t?'undefined':_typeof(t))&&(r=t,t=null),!n.builder.length&&n.minify(),!t&&(t=n.outputType);var o=l(n.isIM?'convert':'gm',n.arg(n.filename?i(n.filename):'-',(t?t+':':'')+'-'));o.stderr.on('data',e.emit.bind(e,'error')),o.stdout.on('data',e.emit.bind(e,'data')),o.stdout.on('end',e.emit.bind(e,'end')),o.on('error',e.emit.bind(e,'error'));var s=g[t];return s?o.stdout.pipe(s()).pipe(e,r):o.stdout.pipe(e,r),n.currentStream&&(n.currentStream instanceof Buffer?o.stdin.end(n.currentStream):n.currentStream.pipe(o.stdin)),n},n.prototype.stream=function(e,t){var r=this;!r.builder.length&&r.minify(),e||(e=r.outputType);var n=l(r.isIM?'convert':'gm',r.arg(r.filename?i(r.filename):'-',(e?e+':':'')+'-'));r.currentStream&&(r.currentStream instanceof Buffer?n.stdin.end(r.currentStream):r.currentStream.pipe(n.stdin)),t&&t(n.stdin);var o=g[e];return o?n.stdout.pipe(o()):n.stdout},n.prototype.cmd=function(e,t){var r=this,n='';if(!r.islimit){var s=F.config['default-image-consumption'];r.limit('memory',15*s),r.limit('map',30*s)}r.builder.sort(o);for(var a=r.builder.length,c=0;c<a;c++)n+=(n?' ':'')+r.builder[c].cmd;return(r.isIM?'convert':'gm -convert')+i(e,!0)+' '+n+i(t,!0)},n.prototype.arg=function(e,t){var r=this,n=[];if(!r.isIM&&n.push('-convert'),e&&n.push(e),!r.islimit){var i=F.config['default-image-consumption'];r.limit('memory',15*i),r.limit('map',30*i)}r.builder.sort(o);for(var s=r.builder.length,a=0;a<s;a++){var c=r.builder[a],u=c.cmd.indexOf(' ');u===-1?n.push(c.cmd):(n.push(c.cmd.substring(0,u)),n.push(c.cmd.substring(u+1).replace(/\"/g,'')))}return t&&n.push(t),n},n.prototype.identify=function(e){var t=this;return u((t.isIM?'identify':'gm identify')+i(t.filename,!0),function(t,r){if(t)return void e(t,null);var n=r.split(' '),o=n[2].split('x'),i={type:n[1],width:framework_utils.parseInt(o[0]),height:framework_utils.parseInt(o[1])};e(null,i)}),t},n.prototype.$$identify=function(){var e=this;return function(t){e.identify(t)}},n.prototype.push=function(e,t,r,n){var o=this,i=e;null!=t&&(i+=n&&'string'==typeof t?' "'+t.replace(h,'')+'"':' '+t);var s=m[i];return s?(s.priority=r,o.builder.push(s)):(m[i]={cmd:i,priority:r},o.builder.push(m[i])),o},n.prototype.output=function(e){var t=this;return'.'===e[0]&&(e=e.substring(1)),t.outputType=e,t},n.prototype.resize=function(e,t,r){r=r||'';var n=this,o='';return e&&t?o=e+'x'+t:e&&!t?o=e+'x':!e&&t&&(o='x'+t),n.push('-resize',o+r,1,!0)},n.prototype.thumbnail=function(e,t,r){r=r||'';var n=this,o='';return e&&t?o=e+'x'+t:e&&!t?o=e:!e&&t&&(o='x'+t),n.push('-thumbnail',o+r,1,!0)},n.prototype.geometry=function(e,t,r){r=r||'';var n=this,o='';return e&&t?o=e+'x'+t:e&&!t?o=e:!e&&t&&(o='x'+t),n.push('-geometry',o+r,1,!0)},n.prototype.filter=function(e){return this.push('-filter',e,1,!0)},n.prototype.trim=function(){return this.push('-trim +repage',1)},n.prototype.limit=function(e,t){return this.islimit=!0,this.push('-limit',e+' '+t,1)},n.prototype.extent=function(e,t){var r=this,n='';return e&&t?n=e+'x'+t:e&&!t?n=e:!e&&t&&(n='x'+t),r.push('-extent',n,4,!0)},n.prototype.miniature=function(e,t,r,n){return this.filter(n||'Box').thumbnail(e,t).background(r?r:'white').align('center').extent(e,t)},n.prototype.resizeCenter=function(e,t,r){return this.resize(e,t,'^').background(r?r:'white').align('center').crop(e,t)},n.prototype.resizeAlign=function(e,t,r,n){return this.resize(e,t,'^').background(n?n:'white').align(r||'center').crop(e,t)},n.prototype.scale=function(e,t,r){r=r||'';var n=this,o='';return e&&t?o=e+'x'+t:e&&!t?o=e:!e&&t&&(o='x'+t),n.push('-scale',o+r,1,!0)},n.prototype.crop=function(e,t,r,n){return this.push('-crop',e+'x'+t+'+'+(r||0)+'+'+(n||0),4,!0)},n.prototype.quality=function(e){return this.push('-quality',e||80,5,!0)},n.prototype.align=function(e){var t;switch(e){case'left top':case'top left':t='NorthWest';break;case'left bottom':case'bottom left':t='SouthWest';break;case'right top':case'top right':t='NorthEast';break;case'right bottom':case'bottom right':t='SouthEast';break;case'left center':case'center left':case'left':t='West';break;case'right center':case'center right':case'right':t='East';break;case'bottom center':case'center bottom':case'bottom':t='South';break;case'top center':case'center top':case'top':t='North';break;case'center center':case'center':case'middle':t='Center';break;default:t=e}return t&&this.push('-gravity',t,3,!0),this},n.prototype.gravity=function(e){return this.align(e)},n.prototype.blur=function(e){return this.push('-blur',e,10,!0)},n.prototype.normalize=function(){return this.push('-normalize',null,10)},n.prototype.rotate=function(e){return this.push('-rotate',e||0,8,!0)},n.prototype.flip=function(){return this.push('-flip',null,10)},n.prototype.flop=function(){return this.push('-flop',null,10)},n.prototype.minify=function(){return this.push('+profile','*',null,10,!0)},n.prototype.grayscale=function(){return this.push('-colorspace','Gray',10,!0)},n.prototype.bitdepth=function(e){return this.push('-depth',e,10,!0)},n.prototype.colors=function(e){return this.push('-colors',e,10,!0)},n.prototype.background=function(e){return this.push('-background',e,2,!0).push('-extent 0x0',null,2)},n.prototype.fill=function(e){return this.push('-fill',e,2,!0)},n.prototype.sepia=function(){return this.push('-modulate','115,0,100',4).push('-colorize','7,21,50',5)},n.prototype.watermark=function(e,t,r,n,o){return this.push('-draw','image over {1},{2} {3},{4} \'{0}\''.format(e,t||0,r||0,n||0,o||0),6,!0)},n.prototype.make=function(e){return e.call(this,this),this},n.prototype.command=function(e,t,r,n){return this.push(e,t,r||10,n)},s.Image=n,s.Picture=n,s.init=function(e,t,r,o){return new n(e,t,r,o)},s.load=function(e,t,r,o){return new n(e,t,r,o)},s.middleware=function(e,t){'.'===e[0]&&(e=e.substring(1)),g[e]=t},s.restart=function(){g={}},s.clear=function(){m={}},global.Image=s,e}({exports:{}}),function(e){function t(){this.debug=!1,this.Message=r,this.Mail=r,this.connections={},this.$events={}}function r(e,t){this.subject=e||'',this.body=t||'',this.files,this.addressTo=[],this.addressReply,this.addressCC,this.addressBCC,this.addressFrom={name:'',address:''},this.closed=!1,this.tls=!1,this.$callback}function n(e){for(var t=e.length,r=0,n=0;r<t;)r+=68,r>t&&(r=t),this.$mailer.$writeline(this.$mailerobj,e.slice(n,r).toString('base64')),n=r}function o(e){for(var t=0,r='',n=e.length;t<n;){var o=t+68;o>n&&(o=n),r+=e.substring(t,o)+u,t=o}return r}function i(e){return e?'=?utf-8?B?'+framework_utils.createBuffer(e.toString()).toString('base64')+'?=':''}e.exports;global.framework_mail=e.exports;var s=require('net'),a=require('tls'),c=require('fs'),u='\r\n',l=/\besmtp\b/i,p=/\d+/,f=[],d=/\r\n/g,h=/\n/g,m=0,g=0;global.framework_utils||(global.framework_utils=require('./utils')),t.prototype.emit=function(e,t,r,n,o,i,s,a){var c=this.$events[e];if(c){for(var u=!1,l=0,p=c.length;l<p;l++)c[l].$once&&(u=!0),c[l].call(this,t,r,n,o,i,s,a);u&&(c=c.remove(function(e){return e.$once}),c.length?this.$events[e]=c:this.$events[e]=void 0)}return this},t.prototype.on=function(e,t){return this.$events[e]?this.$events[e].push(t):this.$events[e]=[t],this},t.prototype.once=function(e,t){return t.$once=!0,this.on(e,t)},t.prototype.removeListener=function(e,t){var r=this.$events[e];return r&&(r=r.remove(function(e){return e===t}),r.length?this.$events[e]=r:this.$events[e]=void 0),this},t.prototype.removeAllListeners=function(e){return e?this.$events[e]=void 0:this.$events={},this},t.prototype.create=function(e,t){return new r(e,t)},r.prototype.unsubscribe=function(e){var t=e.substring(0,6);return this.$unsubscribe='http:/'===t||'https:'===t?'<'+e+'>':'<mailto:'+e+'>',this},r.prototype.callback=function(e){return this.$callback=e,this},r.prototype.sender=function(e,t){return this.from(e,t)},r.prototype.from=function(e,t){if('>'===e[e.length-1]){var r=e.indexOf('<');t=e.substring(0,r-1),e=e.substring(r+1,e.length-1)}return this.addressFrom.name=t||'',this.addressFrom.address=e,this},r.prototype.to=function(e,t,r){if('boolean'==typeof t&&(r=t,t=void 0),'>'===e[e.length-1]){var n=e.indexOf('<');t=e.substring(0,n-1),e=e.substring(n+1,e.length-1)}return r&&(this.addressTo=[]),t?this.addressTo.push({email:e,name:t}):this.addressTo.push(e),this},r.prototype.cc=function(e,t,r){if('boolean'==typeof t&&(r=t,t=void 0),'>'===e[e.length-1]){var n=e.indexOf('<');t=e.substring(0,n-1),e=e.substring(n+1,e.length-1)}return!r&&this.addressCC||(this.addressCC=[]),t?this.addressCC.push({email:e,name:t}):this.addressCC.push(e),this},r.prototype.bcc=function(e,t){return!t&&this.addressBCC||(this.addressBCC=[]),this.addressBCC.push(e),this},r.prototype.reply=function(e,t){return!t&&this.addressReply||(this.addressReply=[]),this.addressReply.push(e),this},r.prototype.attachment=function(e,t){t||(t=framework_utils.getName(e));var r=framework_utils.getExtension(t);return this.files||(this.files=[]),this.files.push({name:t,filename:e,contentType:framework_utils.getContentType(r),extension:r}),this},r.prototype.manually=function(){return this.$sending&&clearTimeout(this.$sending),this},r.prototype.attachmentInline=function(e,t,r){t||(t=framework_utils.getName(e)),this.files||(this.files=[]);var n=framework_utils.getExtension(t);return this.files.push({name:t,filename:e,contentType:framework_utils.getContentType(n),disposition:'inline',contentId:r,extension:n}),this},r.prototype.send=function(e,t,r){return v.send(e,t,this,r),this},t.prototype.switchToTLS=function(e,t){var r=this;e.tls=!0,e.socket.removeAllListeners();var n=framework_utils.copy(t.tls,{socket:e.socket,host:e.socket.$host,ciphers:'SSLv3'});e.socket2=a.connect(n,function(){return r.$send(e,t,!0)}),e.socket2.on('error',function(t){v.destroy(e),r.closed=!0,r.callback&&r.callback(t),r.callback=null,e.try||t.stack.indexOf('ECONNRESET')!==-1||v.$events.error&&v.emit('error',t,e)}),e.socket2.on('clientError',function(t){v.destroy(e),r.callback&&r.callback(t),r.callback=null,v.$events.error&&!e.try&&v.emit('error',t,e)}),e.socket2.on('connect',function(){return!t.secure&&r.$send(e,t)})},t.prototype.destroy=function(e){return e.destroyed?this:(e.destroyed=!0,e.closed=!0,e.socket&&(e.socket.removeAllListeners(),e.socket.end(),e.socket.destroy(),e.socket=null),e.socket2&&(e.socket2.removeAllListeners(),e.socket2.end(),e.socket2.destroy(),e.socket2=null),delete this.connections[e.id],this)},t.prototype.$writeattachment=function(e){var t=!!e.files&&e.files.shift();if(!t)return v.$writeline(e,'--'+e.boundary+'--','','.'),this;var r=t.name,o=c.createReadStream(t.filename,{encoding:'base64'}),i=[],s=t.extension,a='ics'===s;return i.push('--'+e.boundary),a||(t.contentId?(i.push('Content-Disposition: inline; filename="'+r+'"'),i.push('Content-ID: <'+t.contentId+'>')):i.push('Content-Disposition: attachment; filename="'+r+'"')),i.push('Content-Type: '+s+';'+(a?' charset="utf-8"; method=REQUEST':'')),i.push('Content-Transfer-Encoding: base64'),i.push(u),v.$writeline(e,i.join(u)),o.$mailer=v,o.$mailerobj=e,o.on('data',n),CLEANUP(o,function(){v.$writeline(e,u),v.$writeattachment(e)}),this},t.prototype.try=function(e,t,r){return this.send(e,t,void 0,r)},t.prototype.send2=function(e,t){var r=F.temporary['mail-settings'];if(!r){var n=F.config['mail-smtp-options'];n&&(r='object'===('undefined'==typeof n?'undefined':_typeof(n))?n:n.toString().parseJSON()),r||(r={}),F.temporary['mail-settings']=r}return this.send(F.config['mail-smtp'],r,e,t)},t.prototype.send=function(e,t,r,n){t instanceof Array?(n=r,r=t,t={}):'function'==typeof t&&(n=t,t={});var o=this,i='abcdefghijkl'+m++;o.connections[i]={};var c=o.connections[i];if(c.id=i,c.try=void 0===r,c.messages=c.try?f:r instanceof Array?r:[r],c.callback=n,c.closed=!1,c.message=null,c.files=null,c.count=0,c.socket,c.tls=!1,c.date=global.F?global.F.datetime:new Date,e=e||null,t&&t.secure&&!t.port&&(t.port=465),t=framework_utils.copy(t,{secure:!1,port:25,user:'',password:'',timeout:1e4,tls:null}),t.secure){var u=framework_utils.copy(t);u.host=e,c.socket=a.connect(u,function(){return v.$send(c,t)})}else c.socket=s.createConnection(t.port,e);return c.socket.$host=e,c.host=e.substring(e.lastIndexOf('.',e.lastIndexOf('.')-1)+1),c.socket.on('error',function(e){v.destroy(c),c.callback&&c.callback(e),c.callback=null,c.try||e.stack.indexOf('ECONNRESET')!==-1||v.$events.error&&v.emit('error',e,c)}),c.socket.on('clientError',function(e){v.destroy(c),c.callback&&c.callback(e),c.callback=null,v.$events.error&&!c.try&&v.emit('error',e,c)}),c.socket.on('connect',function(){return!t.secure&&v.$send(c,t)}),o},t.prototype.$writemessage=function(e,t){var r=this,n=e.messages.shift(),s=[];global.F&&global.F.stats.other.mail++,e.boundary='--totaljs'+e.date.getTime()+e.count,e.files=n.files,e.count++,t.push('MAIL FROM: <'+n.addressFrom.address+'>'),s.push('Message-ID: <total'+g++ +'@WIN-t'+g+'>'),s.push('MIME-Version: 1.0'),s.push('From: '+(n.addressFrom.name?i(n.addressFrom.name)+' <'+n.addressFrom.address+'>':n.addressFrom.address));var a;if(n.headers)for(var c=Object.keys(n.headers),l=0,a=c.length;l<a;l++)s.push(c[l]+': '+n.headers[c[l]]);a=n.addressTo.length;var p,f,m='';if(a){for(var l=0;l<a;l++)f=n.addressTo[l],p=f instanceof Object?'<'+f.email+'>':'<'+f+'>',t.push('RCPT TO: '+p),m+=(m?', ':'')+(f instanceof Object?i(f.name)+' ':'')+p;s.push('To: '+m),m=''}if(n.addressCC){a=n.addressCC.length;for(var l=0;l<a;l++)f=n.addressCC[l],p=f instanceof Object?'<'+f.email+'>':'<'+f+'>',t.push('RCPT TO: '+p),m+=(m?', ':'')+(f instanceof Object?i(f.name)+' ':'')+p;s.push('Cc: '+m),m=''}if(n.addressBCC){a=n.addressBCC.length;for(var l=0;l<a;l++)t.push('RCPT TO: <'+n.addressBCC[l]+'>')}if(t.push('DATA'),t.push(''),s.push('Date: '+e.date.toUTCString()),s.push('Subject: '+i(n.subject)),n.$unsubscribe&&s.push('List-Unsubscribe: '+n.$unsubscribe),n.addressReply){a=n.addressReply.length;for(var l=0;l<a;l++)m+=(''!==m?', ':'')+'<'+n.addressReply[l]+'>';s.push('Reply-To: '+m),m=''}return s.push('Content-Type: multipart/mixed; boundary='+e.boundary),s.push(''),s.push('--'+e.boundary),s.push('Content-Type: '+(n.body.indexOf('<')!==-1&&n.body.lastIndexOf('>')!==-1?'text/html':'text/plain')+'; charset=utf-8'),s.push('Content-Transfer-Encoding: base64'),s.push(''),s.push(o(framework_utils.createBuffer(n.body.replace(d,'\n').replace(h,u)).toString('base64'))),e.message=s.join(u),e.messagecallback=n.$callback,e.instance=n,s=null,r},t.prototype.$writeline=function(e){if(e.closed)return!1;for(var t=e.socket2?e.socket2:e.socket,r=1;r<arguments.length;r++){var n=arguments[r];n&&(v.debug&&console.log('SEND',n),t.write(n+u))}return!0},t.prototype.$send=function(e,t,r){var n=this,o=[],i=!1,s=!1,a='',c=[],f='',d=e.socket2?e.socket2:e.socket,h=e.host,m=!t.tls||e.tls&&t.tls;m&&v.$events.send&&v.emit('send',e),d.setEncoding('utf8'),d.setTimeout(t.timeout||8e3,function(){var t=new Error(framework_utils.httpStatus(408));v.destroy(e),e.callback&&e.callback(t),e.callback=null,v.$events.error&&!e.try&&v.emit('error',t,e)}),d.on('end',function(){v.destroy(e),e.callback&&e.callback(),e.callback=null}),d.on('data',function(t){if(!e.closed){if(t=t.toString('utf8'),!t.endsWith(u))return void(f+=t);var r=(f+t).split(u);f&&(f='');for(var n=0,o=r.length;n<o;n++){var i=r[n];i&&d&&d.emit('line',i)}}}),d.on('line',function(r){r=r.toUpperCase(),v.debug&&console.log('<---',r);var u=+r.match(p)[0];if(250!==u||s||(r.indexOf('AUTH LOGIN PLAIN')!==-1||r.indexOf('AUTH PLAIN LOGIN')!==-1||t.user&&t.password)&&(s=!0,r.indexOf('XOAUTH')===-1?(c.push('AUTH LOGIN'),c.push(framework_utils.createBuffer(t.user).toString('base64')),c.push(framework_utils.createBuffer(t.password).toString('base64'))):c.push('AUTH PLAIN '+framework_utils.createBuffer('\0'+t.user+'\0'+t.password).toString('base64'))),'-'!==r.substring(3,4))switch(!i&&s&&(i=!0,u=334),u){case 220:if(e.isTLS)return void v.switchToTLS(e,t);a=e.isTLS||t.user&&t.password||l.test(r)?'EHLO':'HELO',v.$writeline(e,a+' '+h);break;case 250:case 251:case 235:case 999:if(e.messagecallback&&e.messagecallback(null,e.instance),e.messagecallback=null,v.$writeline(e,o.shift()),o.length)return;return e.messages.length?(v.$writemessage(e,o),void v.$writeline(e,o.shift())):void v.$writeline(e,'QUIT');case 221:return v.destroy(e),e.callback&&e.callback(null,!!e.try||e.count),void(e.callback=null);case 334:if(!n.tls&&!e.isTLS&&t.tls)return e.isTLS=!0,void v.$writeline(e,'STARTTLS');var f=c.shift();if(!f){var m=new Error('Forbidden.');return v.destroy(e),e.callback&&e.callback(m),e.callback=null,void(v.$events.error&&!e.try&&v.emit('error',m,e))}return void v.$writeline(e,f);case 354:return v.$writeline(e,e.message),v.$writeattachment(e),void(e.message=null);default:if(u<400)return;var m=new Error(r);return v.$events.error&&!e.try&&v.emit('error',m,e),e.messagecallback&&e.messagecallback(m,e.instance),e.messagecallback=null,e.message?(o=[],e.count--,void d.emit('line','999 TRY NEXT MESSAGE')):(v.destroy(e),e.callback&&e.callback(m),void(e.callback=null))}}),r&&n.$writeline(e,'EHLO '+h)},t.prototype.restart=function(){var e=this;e.removeAllListeners(),e.debug=!1,m=0,g=0};var v=new t;return e.exports=v,e}({exports:{}}),function(module){function uploadparser(e){this.buffer_parser.write(e)}function uploadparser_done(){!this.buffer_exceeded&&(this.$upload=!0),this.buffer_parser.end()}function parse_multipart_header(e){var t=new Array(2),r=' name="',n=r.length,o=e.indexOf(r),i='';return o!==-1&&(i=e.substring(o+n,e.indexOf('"',o+n))),i?t[0]=i:t[0]='undefined_'+Math.floor(1e5*Math.random()).toString(),r=' filename="',n=r.length,o=e.indexOf(r),i='',o!==-1&&(i=e.substring(o+n,e.indexOf('"',o+n))),i?t[1]=i:t[1]=null,t}function HttpFile(){this.name,this.filename,this.type,this.path,this.length=0,this.width=0,this.height=0,this.rem=!0}function compile_autovendor(e){var t='/*auto*/',r=e.substring(0,100).indexOf(t)!==-1;return r&&(e=autoprefixer(e.replace(t,''))),e.replace(REG_CSS_1,'').replace(REG_CSS_2,'{').replace(REG_CSS_3,'}').replace(REG_CSS_4,':').replace(REG_CSS_5,';').replace(REG_CSS_6,function(e,t,r){for(var n=t;n>0;n--)if(('\''===r[n]||'"'===r[n])&&':'===r[n-1])return e;return','}).replace(REG_CSS_7,'}').replace(REG_CSS_8,'{').replace(REG_CSS_9,'}').trim()}function autoprefixer(e){e=autoprefixer_keyframes(e);for(var t,r=[],n=0,o=0,i=AUTOVENDOR.length;o<i;o++)for(t=AUTOVENDOR[o],n=0;n!==-1;)if(n=e.indexOf(t,n+1),n!==-1){var s=e.indexOf(';',n),a=e.indexOf('}',n),c=Math.min(s,a);if(c===-1&&(c=Math.max(s,a)),c!==-1){var u='-'===e.substring(n-1,n);if(!u){var l=e.substring(n,c);c=l.indexOf(':'),c!==-1&&l.substring(0,c+1).replace(/\s/g,'')===t+':'&&r.push({name:t,property:l})}}}for(var p=[],i=r.length,o=0;o<i;o++){var f=r[o].name;t=r[o].property;var d=t,h=';',m=d+h;if('opacity'!==f)if('background'!==f&&'background-image'!==f)if('text-overflow'!==f)if('display'!==f)m+='-webkit-'+d+h,m+='-moz-'+d,f.indexOf('animation')===-1&&(m+=h+'-ms-'+d),m+=h+'-o-'+d,e=e.replacer(t,'@[['+p.length+']]'),p.push(m);else{if(t.indexOf('box')===-1)continue;m=d+h,m+=d.replacer('box','-webkit-box')+h,m+=d.replacer('box','-moz-box'),e=e.replacer(t,'@[['+p.length+']]'),p.push(m)}else m=d+h,m+=d.replacer('text-overflow','-ms-text-overflow'),e=e.replacer(t,'@[['+p.length+']]'),p.push(m);else{if(t.indexOf('linear-gradient')===-1)continue;m=d.replacer('linear-','-webkit-linear-')+h,m+=d.replacer('linear-','-moz-linear-')+h,m+=d.replacer('linear-','-o-linear-')+h,m+=d.replacer('linear-','-ms-linear-')+h,m+=d,e=e.replacer(t,'@[['+p.length+']]'),p.push(m)}else{var g=+d.replace('opacity','').replace(':','').replace(/\s/g,'');if(isNaN(g))continue;m+='filter:alpha(opacity='+Math.floor(100*g)+')',e=e.replacer(t,'@[['+p.length+']]'),p.push(m)}}i=p.length;for(var o=0;o<i;o++)e=e.replacer('@[['+o+']]',p[o]);return p=null,r=null,e}function autoprefixer_keyframes(e){for(var t=[],r=0;r!==-1;)if(r=e.indexOf('@keyframes',r+1),r!==-1){for(var n=0,o=-1,i=r+10;i<e.length;i++)if('{'===e[i]&&n++,'}'===e[i]){if(!(n>1)){o=i;break}n--}if(o!==-1){var s=e.substring(r,o+1);t.push({name:'keyframes',property:s})}}for(var a=[],c=t.length,u=0;u<c;u++){var l=t[u].name,p=t[u].property;if('keyframes'===l){var f=p.substring(1),d='\n',h='@'+f+d;h+='@-webkit-'+f+d,h+='@-moz-'+f+d,h+='@-o-'+f+d,e=e.replacer(p,'@[['+a.length+']]'),a.push(h)}}c=a.length;for(var u=0;u<c;u++)e=e.replace('@[['+u+']]',a[u]);return e}function minify_javascript(e){for(var t,r,n,o,i=0,s=[],a=!1,c=!1,u=/[0-9a-z\$]/i,l=/\W/,p={$:!0,_:!0},f=!1;;){var d=e[i],r=e[i-1],n=e[i+1];if(i++,void 0===d)break;if(!t){if(!f){if('/'===d&&'*'===n){a=!0;continue}if('*'===d&&'/'===n){a=!1,i++;continue}if(a)continue;if('/'===d&&'/'===n){c=!0;continue}if(c&&('\n'===d||'\r'===d)){c=!1,u.test(o)&&s.push(' '),o='';continue}if(c)continue}if('\t'===d||'\n'===d||'\r'===d){if(!o||!u.test(o))continue;s.push(' '),o='';continue}if(!f&&' '===d&&(l.test(r)||l.test(n))&&!p[r]&&!p[n])continue;f?('\\'!==o&&'/'===d||'\\'===o&&'/'===d&&'\\'===s[s.length-2])&&(f=!1):f=('='===o||'('===o||':'===o||'{'===o||'['===o||'?'===o)&&'/'===d}if(t&&'\\'===d)s.push(d),s.push(n),i++,o=n;else{if(!f&&('"'===d||'\''===d||'`'===d)){if(t&&t!==d){s.push(d);continue}t=d===t?0:d}('}'===d&&';'===o||('}'===d||']'===d)&&' '===s[s.length-1]&&u.test(s[s.length-2]))&&s.pop(),s.push(d),o=d}}return s.join('').trim()}function MultipartParser(){this.boundary=null,this.boundaryChars=null,this.lookbehind=null,this.state=S.PARSER_UNINITIALIZED,this.index=null,this.flags=0}function view_parse_localization(e,t){var r=!1;if(e=e.replace(REG_NOTRANSLATE,function(){return r=!0,''}).trim(),r)return e;var n=view_find_localization(e,0),o='',i=0;if(!n)return e;for(;n;)n&&(o+=e.substring(i?i+1:0,n.beg)+F.translate(t,n.command)),i=n.end,n=view_find_localization(e,n.end);return o+=e.substring(i+1)}function view_parse(content,minify,filename,controller){function escaper(e){var t=REG_TAGREMOVE.test(e);return nocompressHTML?isFirst||(isFirst=!0,e=e.replace(/^\s+/,'')):e=compressHTML(e,minify,!0),e?(!nocompressHTML&&t&&(e+=' '),txtindex=$VIEWCACHE.indexOf(e),txtindex===-1&&(txtindex=$VIEWCACHE.length,$VIEWCACHE.push(e)),'$VIEWCACHE['+txtindex+']'):'$EMPTY'}minify&&(content=removeComments(content));var nocompressHTML=!1,nocompressJS=!1,nocompressCSS=!1;content=content.replace(REG_NOCOMPRESS,function(e){var t=e.lastIndexOf(' ');if(t===-1)return'';switch(e.substring(t,e.length-1).trim()){case'all':nocompressHTML=!0,nocompressJS=!0,nocompressCSS=!0;break;case'html':nocompressHTML=!0;break;case'js':case'script':case'javascript':nocompressJS=!0;break;case'css':case'style':nocompressCSS=!0}return''}).trim(),nocompressJS||(content=compressJS(content,0,filename)),nocompressCSS||(content=compressCSS(content,0,filename)),content=F.$versionprepare(content);var DELIMITER='\'',SPACE=' ',builder='var $EMPTY=\'\';var $length=0;var $source=null;var $tmp=index;var $output=$EMPTY',command=view_find_command(content,0),isFirst=!1,txtindex=-1,index=0;if((controller.$hasComponents||REG_COMPONENTS.test(content))&&REG_HEAD.test(content)){index=content.indexOf('@{import(');for(var add=!0;index!==-1;){var str=content.substring(index,content.indexOf(')',index));if(str.indexOf('components')!==-1){add=!1;break}index=content.indexOf('@{import(',index+str.length)}add&&(content=content.replace(REG_HEAD,function(e){return F.components.links+e}))}command||(builder+='+'+escaper(content)),index=0;for(var old=null,newCommand='',tmp='',counter=0,functions=[],functionsName=[],isFN=!1,isSECTION=!1,isCOMPILATION=!1,builderTMP='',sectionName='',text;command;){old?(text=content.substring(old.end+1,command.beg),text&&(view_parse_plus(builder)&&(builder+='+'),builder+=escaper(text))):(text=content.substring(0,command.beg),text&&(view_parse_plus(builder)&&(builder+='+'),builder+=escaper(text)));var cmd=content.substring(command.beg+2,command.end).trim(),cmd8=cmd.substring(0,8),cmd7=cmd.substring(0,7);if('continue'!==cmd&&'break'!==cmd){if(cmd=cmd.replace(REG_HELPERS,function(e){var t=e.indexOf('(');return t===-1?e:e.substring(0,t)+'.call(self'+(e.endsWith('()')?')':','+e.substring(t+1))}),'\''===cmd[0]||'"'===cmd[0])builder+='+'+DELIMITER+new Function('self','return self.$import('+cmd[0]+'!'+cmd.substring(1)+')')(controller)+DELIMITER;else if('compile'===cmd7&&cmd.lastIndexOf(')')===-1)builderTMP=builder+'+(F.onCompileView.call(self,\''+(' '===cmd8[7]?cmd.substring(8):'')+'\',',builder='',sectionName=cmd.substring(8),isCOMPILATION=!0,isFN=!0;else if('section '===cmd8&&cmd.lastIndexOf(')')===-1)builderTMP=builder,builder='+(function(){var $output=$EMPTY',sectionName=cmd.substring(8),isSECTION=!0,isFN=!0;else if('helper '===cmd7)builderTMP=builder,builder='function '+cmd.substring(7).trim()+'{var $output=$EMPTY',isFN=!0,functionsName.push(cmd.substring(7,cmd.indexOf('(',7)).trim());else if('foreach '===cmd8)counter++,cmd.indexOf('foreach var ')!==-1&&(cmd=cmd.replace(' var ',SPACE)),cmd=view_prepare_keywords(cmd),newCommand=(cmd.substring(8,cmd.indexOf(SPACE,8))||'').trim(),index=cmd.trim().indexOf(SPACE,newCommand.length+10),index===-1&&(index=cmd.indexOf('[',newCommand.length+10)),builder+='+(function(){var $source='+cmd.substring(index).trim()+';if(!($source instanceof Array))$source=framework_utils.ObjectToArray($source);if(!$source.length)return $EMPTY;var $length=$source.length;var $output=$EMPTY;var index=0;for(var $i=0;$i<$length;$i++){index=$i;var '+newCommand+'=$source[$i];$output+=$EMPTY';else if('end'===cmd)isFN&&counter<=0?(counter=0,isCOMPILATION?(builder=builderTMP+'unescape($EMPTY'+builder+'),model) || $EMPTY)',builderTMP=''):isSECTION?(builder=builderTMP+builder+';repository[\'$section_'+sectionName+'\']=repository[\'$section_'+sectionName+'\']?repository[\'$section_'+sectionName+'\']+$output:$output;return $EMPTY})()',builderTMP=''):(builder+=';return $output;}',functions.push(builder),builder=builderTMP,builderTMP=''),isSECTION=!1,isCOMPILATION=!1,isFN=!1):(counter--,builder+='}return $output;})()',newCommand='');else if('if '===cmd.substring(0,3))builder+=';if ('+view_prepare_keywords(cmd).substring(3)+'){$output+=$EMPTY';else if('else if'===cmd7)builder+='} else if ('+view_prepare_keywords(cmd).substring(7)+') {$output+=$EMPTY';else if('else'===cmd)builder+='} else {$output+=$EMPTY';else if('endif'===cmd||'fi'===cmd)builder+='}$output+=$EMPTY';else{tmp=view_prepare(command.command,newCommand,functionsName,controller);var can=!1;if(RELEASE&&tmp.indexOf('+')===-1&&REG_SKIP_1.test(tmp)&&!REG_SKIP_2.test(tmp))for(var a=0,al=RENDERNOW.length;a<al;a++)if(tmp.startsWith(RENDERNOW[a])){if(!a){var isMeta=tmp.indexOf('\'meta\'')!==-1,isHead=tmp.indexOf('\'head\'')!==-1,isComponent=tmp.indexOf('\'components\'')!==-1;if(tmp=tmp.replace(/\'(meta|head|components)\'\,/g,'').replace(/(\,\,|\,\)|\s{1,})/g,''),isMeta||isHead||isComponent){var tmpimp='';isMeta&&(tmpimp+=isMeta?'\'meta\'':''),isHead&&(tmpimp+=(tmpimp?',':'')+(isHead?'\'head\'':'')),isComponent&&(tmpimp+=(tmpimp?',':'')+(isComponent?'\'components\'':'')),builder+='+self.$import('+tmpimp+')'}}can=!0;break}if(can&&!counter)try{var r=new Function('self','config','return '+tmp)(controller,F.config).replace(REG_7,'\\\\').replace(REG_8,'\\\'');r&&(txtindex=$VIEWCACHE.indexOf(r),txtindex===-1&&(txtindex=$VIEWCACHE.length,$VIEWCACHE.push(r)),builder+='+$VIEWCACHE['+txtindex+']')}catch(e){console.log('VIEW EXCEPTION --->',filename,e,tmp),F.errors.push({error:e.stack,name:filename,url:null,date:new Date}),view_parse_plus(builder)&&(builder+='+'),builder+=wrapTryCatch(tmp,command.command,command.line)}else tmp&&(view_parse_plus(builder)&&(builder+='+'),builder+=wrapTryCatch(tmp,command.command,command.line))}old=command,command=view_find_command(content,command.end)}else builder+=';'+cmd+';',old=command,command=view_find_command(content,command.end)}old&&(text=content.substring(old.end+1),text&&(builder+='+'+escaper(text))),RELEASE&&(builder=builder.replace(/(\+\$EMPTY\+)/g,'+').replace(/(\$output\=\$EMPTY\+)/g,'$output=').replace(/(\$output\+\=\$EMPTY\+)/g,'$output+=').replace(/(\}\$output\+\=\$EMPTY)/g,'}').replace(/(\{\$output\+\=\$EMPTY\;)/g,'{').replace(/(\+\$EMPTY\+)/g,'+').replace(/(\>\'\+\'\<)/g,'><').replace(/\'\+\'/g,''));var fn='(function(self,repository,model,session,query,body,url,global,helpers,user,config,functions,index,output,cookie,files,mobile,settings){var get=query;var post=body;var theme=this.themeName;var language=this.language;var cookie=function(name){return controller.req.cookie(name);};'+(functions.length?functions.join('')+';':'')+'var controller=self;'+builder+';return $output;})';try{fn=eval(fn)}catch(e){throw new Error(filename+': '+e.message.toString())}return fn}function view_prepare_keywords(e){return e.replace(REG_SITEMAP,function(e){return' self.'+e.trim()})}function wrapTryCatch(e,t,r){return F.isDebug?'(function(){try{return '+e+'}catch(e){throw new Error(unescape(\''+escape(t)+'\') + \' - Line: '+r+' - \' + e.message.toString());}return $EMPTY})()':e}function view_parse_plus(e){var t=e[e.length-1];return'!'!==t&&'?'!==t&&'+'!==t&&'.'!==t&&':'!==t}function view_prepare(e,t,r,n){var o=e.indexOf('.'),i=e.indexOf('('),s=e.indexOf('['),a=[],c=0;o!==-1&&a.push(o),i!==-1&&a.push(i),s!==-1&&a.push(s);var u=Math.min.apply(this,a);u===-1&&(u=e.length);var l=e.substring(0,u);if(l===t)return'$STRING('+e+').encode()';if('!'===l[0]&&l.substring(1)===t)return'$STRING('+e.substring(1)+')';switch(l){case'foreach':case'end':return'';case'section':return c=e.indexOf('('),c===-1?'':'(repository[\'$section_'+e.substring(c+1,e.length-1).replace(/\'|\"/g,'')+'\'] || \'\')';case'log':case'LOG':return'('+('log'===l?'F.':'')+e+'?$EMPTY:$EMPTY)';case'logger':case'LOGGER':return'('+('logger'===l?'F.':'')+e+'?$EMPTY:$EMPTY)';case'console':return'('+e+'?$EMPTY:$EMPTY)';case'!cookie':return'$STRING('+e+')';case'!isomorphic':return'$STRING('+e+')';case'model':case'repository':case'get':case'post':case'query':case'global':case'session':case'user':case'config':case'controller':return view_is_assign(e)?'self.$set('+e+')':'$STRING('+e+').encode()';case'body':return view_is_assign(e)?'self.$set('+e+')':e.lastIndexOf('.')===-1?'output':'$STRING('+e+').encode()';case'files':case'mobile':case'continue':case'break':case'language':case'TRANSLATE':case'helpers':return e;case'cookie':case'isomorphic':
case'settings':case'CONFIG':case'function':case'MODEL':case'SCHEMA':case'MODULE':case'functions':return'$STRING('+e+').encode()';case'!controller':case'!repository':case'!get':case'!post':case'!body':case'!query':case'!global':case'!session':case'!user':case'!config':case'!functions':case'!model':case'!CONFIG':case'!SCHEMA':case'!function':case'!MODEL':case'!MODULE':return'$STRING('+e.substring(1)+')';case'resource':return'$STRING(self.'+e+').encode()';case'RESOURCE':return'$STRING(self.'+e.toLowerCase()+').encode()';case'!resource':case'!RESOURCE':return'$STRING(self.'+e.substring(1)+')';case'host':case'hostname':return e.indexOf('(')===-1?'self.host()':'self.'+e;case'href':return e.indexOf('(')===-1?'self.href()':'self.'+e;case'url':return e.indexOf('(')===-1?'self.'+e:'self.$'+e;case'title':case'description':case'keywords':case'author':return e.indexOf('(')===-1?'(repository[\'$'+e+'\'] || \'\').toString().encode()':'self.$'+e;case'title2':return'self.$'+e;case'!title':case'!description':case'!keywords':case'!author':return'(repository[\'$'+e.substring(1)+'\'] || \'\')';case'head':return e.indexOf('(')===-1?'self.'+e+'()':'self.$'+e;case'sitemap_url':case'sitemap_name':case'sitemap_navigation':return'self.'+e;case'sitemap':case'place':return e.indexOf('(')===-1?'(repository[\'$'+e+'\'] || \'\')':'self.$'+e;case'meta':return e.indexOf('(')===-1?'self.$meta()':'self.$'+e;case'import':case'favicon':case'js':case'css':case'script':case'absolute':return'self.$'+e+(e.indexOf('(')===-1?'()':'');case'components':return n.$hasComponents=!0,'self.$'+e+(e.indexOf('(')===-1?'()':'');case'index':return'('+e+')';case'component':return n.$hasComponents=!0,'self.'+e;case'routeJS':case'routeCSS':case'routeScript':case'routeStyle':case'routeImage':case'routeFont':case'routeDownload':case'routeVideo':case'routeStatic':return'self.'+e;case'translate':return'self.'+e;case'json':case'sitemap_change':case'sitemap_replace':case'helper':case'view':case'layout':case'image':case'template':case'templateToggle':case'viewCompile':case'viewToggle':case'download':case'selected':case'disabled':case'checked':case'etag':case'header':case'modified':case'options':case'readonly':case'canonical':case'dns':case'next':case'prefetch':case'prerender':case'prev':return'self.$'+e;case'now':return'(new Date()'+e.substring(3)+')';case'radio':case'text':case'checkbox':case'hidden':case'textarea':case'password':return'self.$'+exports.appendModel(e);default:return F.helpers[l]?'helpers.'+view_insert_call(e):'$STRING('+(r.indexOf(l)===-1?'!'===e[0]?e.substring(1)+')':e+').encode()':e+')')}}function view_insert_call(e){var t=e.indexOf('(');if(t===-1)return e;for(var r=e.length,n=0,o=t+1;o<r;o++){var i=e[o];if('('===i||')'===i)if('('!==i){if(!(n>0)){var s=e.substring(t+1);return e.substring(0,t)+'.call(self'+(s.length>1?','+s:')')}n--}else n++}return e}function view_is_assign(e){for(var t=e.length,r=0,n=0;n<t;n++){var o=e[n];if('['!==o)if(']'!==o){var i=e[n+1]||'';if('+'===o&&('+'===i||'='===i)&&!r)return!0;if('-'===o&&('-'===i||'='===i)&&!r)return!0;if('*'===o&&('*'===i||'='===i)&&!r)return!0;if('='===o&&!r)return!0}else r--;else r++}return!1}function view_find_command(e,t){if(t=e.indexOf('@{',t),t===-1)return null;for(var r=e.length,n=0,o=t+2;o<r;o++){var i=e[o];if('{'!==i){if('}'===i){if(!(n>0)){var s=e.substring(t+2,o).trim();return'{'===s[0]?view_find_command(e,t+1):{beg:t,end:o,line:view_line_counter(e.substr(0,t)),command:s}}n--}}else n++}return null}function view_line_counter(e){var t=e.match(/\n/g);return t?t.length:0}function view_find_localization(e,t){if(t=e.indexOf('@(',t),t===-1)return null;for(var r=e.length,n=0,o=t+2;o<r;o++){var i=e[o];if('('!==i){if(')'===i){if(!n)return{beg:t,end:o,command:e.substring(t+2,o).trim()};n--}}else n++}return null}function removeComments(e){for(var t='<!--',r='-->',n=e.indexOf(t),o=0;n!==-1&&(o=e.indexOf(r,n+4),o!==-1);){var i=e.substring(n,o+3);i.indexOf('[if')!==-1||i.indexOf('[endif')!==-1?n=e.indexOf(t,o+3):(e=e.replacer(i,''),n=e.indexOf(t,n))}return e}function compressJS(e,t,r){if(!F.config['allow-compile-script'])return e;var n='<script type="text/javascript">',o='</script>',i=e.indexOf(n,t||0);if(i===-1&&(n='<script>',i=e.indexOf(n,t||0),i===-1))return e;var s=e.indexOf(o,i+n.length);if(s===-1)return e;var a=e.substring(i,s+o.length).trim(),c=e.indexOf(a);if(c===-1)return e;var u=a.substring(n.length,a.length-o.length).trim(),l=exports.compile_javascript(u,r);return e=e.replacer(a,n+l.trim()+o.trim()),compressJS(e,i+l.length+9,r)}function compressCSS(e,t,r){if(!F.config['allow-compile-style'])return e;var n='<style type="text/css">',o='</style>',i=e.indexOf(n,t||0);if(i===-1&&(n='<style>',i=e.indexOf(n,t||0),i===-1))return e;var s=e.indexOf(o,i+n.length);if(s===-1)return e;var a=e.substring(i,s+o.length),c=a.substring(n.length,a.length-o.length).trim(),u=exports.compile_css(c,r);return e=e.replacer(a,(n+u.trim()+o).trim()),compressCSS(e,i+u.length+8,r)}function variablesCSS(e){if(!e)return e;var t={};return e=e.replace(REG_CSS_10,function(e){var r=e.indexOf(':');if(r===-1)return e;var n=e.substring(0,r).trim();return t[n]=e.substring(r+1,e.length-1).trim(),''}),e=e.replace(REG_CSS_11,function(e){var r=t[e];return r?r:e}).trim()}function nested(e,t,r){if(!e)return e;for(var n,o,i,s=0,a='',c=!1,u=0,l=!1,p='',f=!1,d='',h=!1,m='',g=!1;;){var v=e[s++];if(!v)break;if('/'!==v||'*'!==e[s]){if(h)m+=v,'*'===v&&'/'===e[s]&&(h=!1,s++,'auto*'===m&&(a+='/*auto*/'));else if('\n'!==v&&'\r'!==v)if('$'===v&&r&&r(),'@'===v&&'{'===e[s]&&(g=!0),g)p+=v,'}'===v&&(g=!1);else if('\''!==v&&'"'!==v||(v===i&&'\\'!==e[s]?i='':i||(i=v)),i)p+=v;else if('@'===v&&(o=s,f=!0),!f||d||';'!==v&&'{'!==v||(d=v,';'!==v))if(p+=v,'{'!==v){if('}'===v){if(u>0){u--,l=!0;continue}if(!l){a+=p,p='',c=!1,f=!1,d='';continue}if(f){p.indexOf('@keyframes')!==-1?a+=p:(o=p.indexOf('{'),a+=p.substring(0,o+1)+process_nested(p.substring(o),t).trim()+'}'),c=!1,f=!1,d='',p='';continue}for(var y=n-1,b='';;){var F=e[y--];if('{'!==F){if('}'===F||'\n'===F||'\r'===F||void 0===F||d&&d===F)break;b=F+b}}c=!1,f=!1,d='',p='',a+=process_nested(e.substring(n-1,s),(t||'')+b.trim())}}else{if(c){u++;continue}c=!0,u=0,n=s,l=!1}else a+=e.substring(o-1,s),f=!1,p=''}else h=!0,s++,m=''}return a+p}function process_nested(e,t){return e=e.trim(),e=make_nested(e.substring(1,e.length-1),t),nested(e,t)}function make_nested(e,t){for(var r=0,n='',o='',i=0,s=!1,a=!1;;){var c=e[r++];if(!c)break;if('\n'!==c&&'\r'!==c)if(' '===c&&' '===n[n.length-1]||(n+=c),'{'!==c){if('}'===c){if(i>0){i--,a=!0;continue}if(!a){o+=t+' '+n.trim(),n='',s=!1;continue}o+=n}}else{if(s){i++;continue}s=!0,i=0,a=!1}}return o}function compressHTML(e,t,r){if(!e||!t)return e;e=removeComments(e);for(var n=['script','textarea','pre','code'],o='['+(new Date).getTime()+']#',i={},s=0,a=n.length,c=65,u=0;u<a;u++)for(var l=n[u],p='<'+l,f='</'+l,d=e.indexOf(p),h=0,m=f.length;d!==-1;){if(h=e.indexOf(f,d+3),h===-1){if(!r)break;h=e.length}var g=o+s++ +String.fromCharCode(c++);c>90&&(c=65);var v=e.substring(d,h+m);if(!u){if(h=v.indexOf('>'),m=v.indexOf('type="text/template"'),m<h&&m!==-1){d=e.indexOf(p,d+p.length);continue}if(m=v.indexOf('type="text/html"'),m<h&&m!==-1){d=e.indexOf(p,d+p.length);continue}if(m=v.indexOf('type="text/ng-template"'),m<h&&m!==-1){d=e.indexOf(p,d+p.length);continue}}i[g]=v,e=e.replacer(v,g),d=e.indexOf(p,d+p.length)}for(;;){if(!REG_6.test(e))break;e=e.replace(REG_6,function(e){return e.replace(/\s+/g,' ')})}e=e.replace(/>\n\s+/g,'>').replace(/(\w|\W)\n\s+</g,function(e){return e.trim().replace(/\s/g,'')}).replace(REG_5,'><').replace(REG_4,function(e){var t=e[e.length-1];return'<'===t?t:' '+t}).replace(REG_1,'').replace(REG_2,'');for(var g in i)e=e.replacer(g,i[g]);return e}function viewengine_read(e,t){var r,n=F.config,o='.'===e[0],i=o?e.substring(1):F.path.views(e);if(RELEASE){r='404/'+e;var s=F.temporary.other[r];if(void 0!==s)return null}if(existsSync(i))return view_parse(view_parse_localization(modificators(Fs.readFileSync(i).toString('utf8'),i),t.language),n['allow-compile-html'],i,t);var a;return o?t.themeName&&(a=i.lastIndexOf('/'),a!==-1&&(i=i.substring(0,i.lastIndexOf('/',a-1))+i.substring(a),existsSync(i)))?view_parse(view_parse_localization(modificators(Fs.readFileSync(i).toString('utf8'),i),t.language),n['allow-compile-html'],i,t):(RELEASE&&(F.temporary.other[r]=null),null):(a=e.lastIndexOf('/'),a===-1?(RELEASE&&(F.temporary.other[r]=null),null):(i=F.path.views(e.substring(a+1)),existsSync(i)?view_parse(view_parse_localization(modificators(Fs.readFileSync(i).toString('utf8'),i),t.language),n['allow-compile-html'],i,t):(RELEASE&&(F.temporary.other[r]=null),null)))}function modificators(e,t,r){if(!F.modificators)return e;for(var n=0,o=F.modificators.length;n<o;n++){var i=F.modificators[n](r||'view',t,e);i&&(e=i)}return e}function viewengine_load(e,t,r){var n=F.routes.views[e];n?t='.'+n.filename:t+='.html';var o='view#'+t+(r.language||''),i=F.temporary.views[o];return i?i:(i=viewengine_read(t,r),F.isDebug||(F.temporary.views[o]=i),i)}function viewengine_dynamic(e,t,r,n){var o=n?F.temporary.views[n]||null:null;return o?o:(o=view_parse(view_parse_localization(modificators(e,''),t),F.config['allow-compile-html'],null,r),n&&!F.isDebug&&(F.temporary.views[n]=o),o)}function cleanURL(e,t){for(var r,n=e.substring(0,t),o=!1,i=t,s=e.length;i<s;i++){var a=e[i];('/'!==a||'/'!==r||o)&&(r=a,n+=a)}return n}function destroyStream(e){return e instanceof ReadStream?(e.destroy(),'function'!=typeof e.close?e:(e.on('open',function(){'number'==typeof this.fd&&this.close()}),e)):(e instanceof Stream&&'function'==typeof e.destroy&&e.destroy(),e)}function first(e,t){function r(){n(),t.apply(null,arguments)}function n(){for(var e,t=0,r=i.length;t<r;t++)e=i[t],e.ee.removeListener(e.event,e.fn)}function o(e){t=e}for(var i=[],s=0,a=e.length;s<a;s++)for(var c=e[s],u=c[0],l=1,p=c.length;l<p;l++){var f=c[l],d=listener(f,r);u.on(f,d),i.push({ee:u,event:f,fn:d})}return o.cancel=n,o}function listener(e,t){return function(r){for(var n=new Array(arguments.length),o=this,i='error'===e?r:null,s=0;s<n.length;s++)n[s]=arguments[s];t(i,o,e,n)}}function onFinished(e,t){return isFinished(e)!==!1?setImmediate(t,null,e):attachListener(e,t),e}function attachFinishedListener(e,t){function r(e){o.cancel(),i.cancel(),s=!0,t(e)}function n(t){e.removeListener('socket',n),s||o!==i||(i=first([[t,'error','close']],r))}var o,i,s=!1;return o=i=first([[e,'end','finish']],r),e.socket?void n(e.socket):(e.on('socket',n),void(!e.socket&&patchAssignSocket(e,n)))}function attachListener(e,t){var r=e.__onFinished;r&&r.queue||(r=e.__onFinished=createListener(e),attachFinishedListener(e,r)),r.queue.push(t)}function createListener(e){function t(r){if(e.__onFinished===t&&(e.__onFinished=null),t.queue){var n=t.queue;t.queue=null;for(var o=0,i=n.length;o<i;o++)n[o](r,e)}}return t.queue=[],t}function patchAssignSocket(e,t){var r=e.assignSocket;'function'==typeof r&&(e.assignSocket=function(e){r.call(this,e),t(e)})}function isFinished(e){var t=e.socket;return'boolean'==typeof e.finished?Boolean(e.finished||t&&!t.writable):'boolean'==typeof e.complete?Boolean(e.upgrade||!t||!t.readable||e.complete&&!e.readable):void 0}function existsSync(e){try{return!!Fs.statSync(e)}catch(e){return!1}}var exports=module.exports;global.framework_internal=module.exports;var Crypto=require('crypto'),Fs=require('fs'),ReadStream=Fs.ReadStream,Stream=require('stream'),ENCODING='utf8',EMPTYARRAY=[],EMPTYOBJECT={},CONCAT=[null,null];global.framework_utils||(global.framework_utils=require('./utils')),Object.freeze(EMPTYOBJECT),Object.freeze(EMPTYARRAY);var REG_1=/[\n\r\t]+/g,REG_2=/\s{2,}/g,REG_4=/\n\s{2,}./g,REG_5=/>\n\s{1,}</g,REG_6=/[\<\w\"\u0080-\u07ff\u0400-\u04FF]+\s{2,}[\w\u0080-\u07ff\u0400-\u04FF\>]+/,REG_7=/\\/g,REG_8=/\'/g,REG_BLOCK_BEG=/\@\{block.*?\}/gi,REG_BLOCK_END=/\@\{end\}/gi,REG_SKIP_1=/\(\'|\"/,REG_SKIP_2=/\,(\s)?\w+/,REG_HEAD=/\<\/head\>/i,REG_COMPONENTS=/\@{(\s)?(component|components)(\s)?\(/i,HTTPVERBS={get:!0,post:!0,options:!0,put:!0,delete:!0,patch:!0,upload:!0,head:!0,trace:!0,propfind:!0},RENDERNOW=['self.$import(','self.route','self.$js(','self.$css(','self.$favicon(','self.$script(','$STRING(self.resource(','$STRING(self.RESOURCE(','self.translate(','language','self.sitemap_url(','self.sitemap_name(','$STRING(CONFIG(','$STRING(config.','$STRING(config[','$STRING(config('],REG_NOTRANSLATE=/@\{notranslate\}/gi,REG_NOCOMPRESS=/@\{nocompress\s\w+}/gi,REG_TAGREMOVE=/[^\>]\n\s{1,}$/,REG_HELPERS=/helpers\.[a-z0-9A-Z_$]+\(.*?\)+/g,REG_SITEMAP=/\s+(sitemap_navigation\(|sitemap\()+/g,REG_CSS_1=/\n|\s{2,}/g,REG_CSS_2=/\s?\{\s{1,}/g,REG_CSS_3=/\s?\}\s{1,}/g,REG_CSS_4=/\s?\:\s{1,}/g,REG_CSS_5=/\s?\;\s{1,}/g,REG_CSS_6=/\,\s{1,}/g,REG_CSS_7=/\s\}/g,REG_CSS_8=/\s\{/g,REG_CSS_9=/\;\}/g,REG_CSS_10=/\$[a-z0-9-_]+\:.*?;/gi,REG_CSS_11=/\$[a-z0-9-_]+/gi,AUTOVENDOR=['filter','appearance','column-count','column-gap','column-rule','display','transform','transform-style','transform-origin','transition','user-select','animation','perspective','animation-name','animation-duration','animation-timing-function','animation-delay','animation-iteration-count','animation-direction','animation-play-state','opacity','background','background-image','font-smoothing','text-size-adjust','backface-visibility','box-sizing','overflow-scrolling'],WRITESTREAM={flags:'w'},EMPTYBUFFER=framework_utils.createBufferSize(0),INDEXFILE=0,INDEXMIXED=0;global.$STRING=function(e){return null!=e?e.toString():''},global.$VIEWCACHE=[],exports.parseMULTIPART=function(e,t,r,n,o){var i=t.split(';')[1];if(!i)return F.reqstats(!1,!1),F.stats.request.error400++,o.res.writeHead(400),void o.res.end();e.once('close',function(){return!e.$upload&&e.clear()});var s,a,c,u=new MultipartParser,l=0,p=r.length,f=0;e.files=[],e.body={};var d=framework_utils.combine(n,(F.id?'i-'+F.id+'_':'')+'uploadedfile-');i=i.substring(i.indexOf('=',2)+1),e.buffer_exceeded=!1,e.buffer_has=!0,e.buffer_parser=u,u.initWithBoundary(i),u.onPartBegin=function(){a=new HttpFile,a.$data=framework_utils.createBufferSize(),a.$step=0,a.$is=!1,a.length=0},u.onHeaderValue=function(t,r,n){if(!e.buffer_exceeded){var o=t.slice(r,n).toString(ENCODING);if(1===a.$step){var i=o.indexOf(';');return i===-1?a.type=o.trim():a.type=o.substring(0,i).trim(),void(a.$step=2)}if(0===a.$step){if(o=parse_multipart_header(o),a.$step=1,a.$is=null!==o[1],a.name=o[0],!a.$is)return void destroyStream(s);a.filename=o[1],a.path=d+INDEXFILE++ +'.bin',s=Fs.createWriteStream(a.path,WRITESTREAM),s.once('close',function(){return f--}),s.once('error',function(){return f--}),f++}}},u.onPartData=function(t,r,n){if(!e.buffer_exceeded){var o=t.slice(r,n),i=o.length;if(l+=i,l>=p)return e.buffer_exceeded=!0,void(c?c.push(a.path):c=[a.path]);if(!a.$is)return CONCAT[0]=a.$data,CONCAT[1]=o,void(a.$data=Buffer.concat(CONCAT));if(a.length)return s.write(o),void(a.length+=i);var u=null;switch(a.type){case'image/jpeg':u=framework_image.measureJPG(t.slice(r));break;case'image/gif':u=framework_image.measureGIF(o);break;case'image/png':u=framework_image.measurePNG(o);break;case'image/svg+xml':u=framework_image.measureSVG(o)}u?(a.width=u.width,a.height=u.height):(a.width=0,a.height=0),e.files.push(a),F.$events['upload-begin']&&F.emit('upload-begin',e,a),s.write(o),a.length+=i}},u.onPartEnd=function(){if(s&&(s.end(),s=null),!e.buffer_exceeded){if(a.$is)return a.$data=void 0,a.$is=void 0,a.$step=void 0,void(F.$events['upload-end']&&F.emit('upload-end',e,a));a.$data=a.$data.toString(ENCODING);var t=e.body[a.name];void 0===t?e.body[a.name]=a.$data:t instanceof Array?e.body[a.name].push(a.$data):(t=[t],t.push(a.$data),e.body[a.name]=t)}},u.onEnd=function(){f?setImmediate(u.onEnd):(c&&F.unlink(c),o.doEnd())},e.on('data',uploadparser),e.on('end',uploadparser_done)},exports.parseMULTIPART_MIXED=function(e,t,r,n){var o=t.split(';')[1];if(!o)return F.reqstats(!1,!1),F.stats.request.error400++,e.res.writeHead(400),void e.res.end();e.once('close',function(){return!e.$upload&&e.clear()});var i,s,a=new MultipartParser,c=0,u=0,l=framework_utils.combine(r,(F.id?'i-'+F.id+'_':'')+'uploadedmixed-');o=o.substring(o.indexOf('=',2)+1),e.buffer_exceeded=!1,e.buffer_has=!0,e.buffer_parser=a,a.initWithBoundary(o),a.onPartBegin=function(){s=new HttpFile,s.$step=0,s.$is=!1,s.length=0},a.onHeaderValue=function(t,r,n){if(!e.buffer_exceeded){var o=t.slice(r,n).toString(ENCODING);if(1===s.$step){var a=o.indexOf(';');return a===-1?s.type=o.trim():s.type=o.substring(0,a).trim(),void(s.$step=2)}0===s.$step&&(o=parse_multipart_header(o),s.$step=1,s.$is=null!==o[1],s.name=o[0],s.$is?(s.filename=o[1],s.path=l+INDEXMIXED++ +'.bin',i=Fs.createWriteStream(s.path,WRITESTREAM),i.once('close',function(){return c--}),i.once('error',function(){return c--}),c++):destroyStream(i))}},a.onPartData=function(t,r,o){if(!e.buffer_exceeded){var a=t.slice(r,o),c=a.length;if(s.$is){if(s.length)return i.write(a),void(s.length+=c);i.write(a),s.length+=c,n(e,s,u++)}}},a.onPartEnd=function(){i&&(i.end(),i=null),!e.buffer_exceeded&&s.$is&&(s.$is=void 0,s.$step=void 0)},a.onEnd=function(){c?setImmediate(a.onEnd):(n(e,null),F.responseContent(e,e.res,200,EMPTYBUFFER,'text/plain',!1))},e.on('data',uploadparser),e.on('end',uploadparser_done)},exports.routeSplit=function(e,t){var r;if(!t&&(r=F.temporary.other[e]))return r;if(!e||'/'===e)return r=['/'];var n=!1,o='',i=0;r=[];for(var s=0,a=e.length;s<a;s++){var c=e[s];'/'!==c?(o+=t?c:c.toLowerCase(),n='/'===c):o&&!n&&(r.push(o),i++,o='')}return o?r.push(o):i||r.push('/'),r},exports.routeSplitCreate=function(e,t){t||(e=e.toLowerCase()),'/'===e[0]&&(e=e.substring(1)),'/'===e[e.length-1]&&(e=e.substring(0,e.length-1));for(var r=0,n=0,o=[],i=0,s=e.length;i<s;i++)switch(e[i]){case'/':if(0!==r)break;o.push(e.substring(n+(o.length?1:0),i)),n=i;break;case'{':r++;break;case'}':r--}return!r&&o.push(e.substring(n+(o.length?1:0),e.length)),1!==o.length||o[0]||(o[0]='/'),o},exports.routeCompare=function(e,t,r,n){var o=e.length,i=t.length;if(i!==o&&!n)return!1;if(n&&1===i&&'/'===t[0])return!0;for(var s=1===o&&'/'===e[0],a=0;a<o;a++){var c=t[a];if(!r&&n&&void 0===c)return!0;if((r||s||'{'!==c[0])&&e[a]!==c)return!r&&(!!n&&a>=i)}return!0},exports.routeCompareSubdomain=function(e,t){if(!e&&!t||e&&!t)return!0;if(!e&&t)return!1;for(var r=0,n=t.length;r<n;r++){if('*'===t[r])return!0;var o=t[r].lastIndexOf('*');if(o===-1){if(t[r]===e)return!0}else if(e.indexOf(t[r].replace('*',''))!==-1)return!0}return!1},exports.routeCompareFlags=function(e,t,r){for(var n=!1,o=e,i=t,s=e.length,a=t.length,c=s>a?o:i,u=s>a?i:o,l=Math.max(s,a),p='authorize',f='unauthorize',d=0;d<l;d++){var h=c[d],m=h[0];if('!'!==m&&'#'!==m&&'$'!==m&&'@'!==m&&'+'!==m&&(r||h!==p&&h!==f)){var g=u.indexOf(h);if(g===-1&&!HTTPVERBS[h])return h===p||h===f?-1:0;n=n||g!==-1&&HTTPVERBS[h]}}return n?1:0},exports.routeCompareFlags2=function(e,t,r){if(r&&t.MEMBER&&r!==t.MEMBER)return-1;if(!t.isWEBSOCKET){if(t.isXHR&&!e.xhr||t.isMOBILE&&!e.mobile||t.isROBOT&&!e.robot||t.isUPLOAD&&!e.$upload)return 0;var n=e.method;if(t.method){if(t.method!==n)return 0}else if(!t.flags2[n.toLowerCase()])return 0;if(t.isREFERER&&e.flags.indexOf('referer')===-1||!t.isMULTIPLE&&t.isJSON&&e.flags.indexOf('json')===-1)return 0}for(var o=!1,i=!1,s=0,a=e.flags.length;s<a;s++){var c=e.flags[s];switch(c){case'json':continue;case'xml':if(t.isRAW||t.isXML)continue;return 0;case'proxy':if(!t.isPROXY)return 0;continue;case'debug':if(!t.isDEBUG&&t.isRELEASE)return 0;continue;case'release':if(!t.isRELEASE&&t.isDEBUG)return 0;continue;case'referer':continue;case'upload':if(!t.isUPLOAD)return 0;continue;case'https':if(!t.isHTTPS&&t.isHTTP)return 0;continue;case'http':if(!t.isHTTP&&t.isHTTPS)return 0;continue;case'xhr':case'+xhr':if(!t.isBOTH&&!t.isXHR)return 0;continue}var u='@'===c[0];if(1===r||1===t.MEMBER){if(!u||!o||t.isROLE){if(!u&&!t.flags2[c])return 0;u&&(t.flags2[c]&&(o=!0),i=!0)}}else if(!t.isGET&&!u&&!t.flags2[c]||t.isROLE&&u&&!t.flags2[c]||t.isROLE&&!u)return 0}return t.isROLE&&i?o?1:-1:1},exports.routeParam=function(e,t){if(!t||!e||!t.param.length)return EMPTYARRAY;for(var r=[],n=0,o=t.param.length;n<o;n++){var i=e[t.param[n]];r.push('/'===i?'':i)}return r},HttpFile.prototype.rename=function(e,t){var r=this;return Fs.rename(r.path,e,function(n){n||(r.path=e,r.rem=!1),t&&t(n)}),r},HttpFile.prototype.copy=function(e,t){var r=this;if(!t)return void Fs.createReadStream(r.path).pipe(Fs.createWriteStream(e));var n=Fs.createReadStream(r.path),o=Fs.createWriteStream(e);return n.on('close',t),n.pipe(o),r},HttpFile.prototype.$$rename=function(e){var t=this;return function(r){return t.rename(e,r)}},HttpFile.prototype.$$copy=function(e){var t=this;return function(r){return t.copy(e,r)}},HttpFile.prototype.readSync=function(){return Fs.readFileSync(this.path)},HttpFile.prototype.read=function(e){var t=this;return Fs.readFile(t.path,e),t},HttpFile.prototype.$$read=function(){var e=this;return function(t){e.read(t)}},HttpFile.prototype.md5=function(e){var t=this,r=Crypto.createHash('md5'),n=Fs.createReadStream(t.path);return n.on('data',function(e){return r.update(e)}),n.on('error',function(t){e(t,null),e=null}),onFinished(n,function(){destroyStream(n),e&&e(null,r.digest('hex'))}),t},HttpFile.prototype.$$md5=function(){var e=this;return function(t){e.md5(t)}},HttpFile.prototype.stream=function(e){return Fs.createReadStream(this.path,e)},HttpFile.prototype.pipe=function(e,t){return Fs.createReadStream(this.path,t).pipe(e,t)},HttpFile.prototype.isImage=function(){return this.type.indexOf('image/')!==-1},HttpFile.prototype.isVideo=function(){return this.type.indexOf('video/')!==-1},HttpFile.prototype.isAudio=function(){return this.type.indexOf('audio/')!==-1},HttpFile.prototype.image=function(e){return void 0===e&&(e='im'===F.config['default-image-converter']),framework_image.init(this.path,e,this.width,this.height)},exports.compile_css=function(e,t){if(global.F&&(e=modificators(e,t,'style'),F.onCompileStyle))return F.onCompileStyle(t,e);try{var r=!1;return e=nested(e,'',function(){r=!0}),e=compile_autovendor(e),r&&(e=variablesCSS(e)),e}catch(e){return F.error(new Error('CSS compiler exception: '+e.message)),''}},exports.compile_javascript=function(e,t){return global.F&&(e=modificators(e,t,'script'),F.onCompileScript)?F.onCompileScript(t,e).trim():minify_javascript(e)},exports.compile_html=function(e,t){return compressCSS(compressJS(compressHTML(e,!0),0,t),0,t)};var Buffer=require('buffer').Buffer,s=0,S={PARSER_UNINITIALIZED:s++,START:s++,START_BOUNDARY:s++,HEADER_FIELD_START:s++,HEADER_FIELD:s++,HEADER_VALUE_START:s++,HEADER_VALUE:s++,HEADER_VALUE_ALMOST_DONE:s++,HEADERS_ALMOST_DONE:s++,PART_DATA_START:s++,PART_DATA:s++,PART_END:s++,END:s++},f=1,FB={PART_BOUNDARY:f,LAST_BOUNDARY:f*=2},LF=10,CR=13,SPACE=32,HYPHEN=45,COLON=58,A=97,Z=122,lower=function(e){return 32|e};for(s in S)exports[s]=S[s];return exports.MultipartParser=MultipartParser,MultipartParser.stateToString=function(e){for(var t in S){var r=S[t];if(r===e)return t}},MultipartParser.prototype.initWithBoundary=function(e){var t=this;t.boundary=framework_utils.createBufferSize(e.length+4),t.boundary.write('\r\n--',0,'ascii'),t.boundary.write(e,4,'ascii'),t.lookbehind=framework_utils.createBufferSize(t.boundary.length+8),t.state=S.START,t.boundaryChars={};for(var r=0;r<t.boundary.length;r++)t.boundaryChars[t.boundary[r]]=!0},MultipartParser.prototype.write=function(e){var t,r,n=this,o=0,i=e.length,s=n.index,a=n.index,c=n.state,u=n.flags,l=n.lookbehind,p=n.boundary,f=n.boundaryChars,d=n.boundary.length,h=d-1,m=e.length,g=function(e){n[e+'Mark']=o},v=function(e){delete n[e+'Mark']},y=function(e,t,r,o){if(void 0===r||r!==o){var i='on'+e.substr(0,1).toUpperCase()+e.substr(1);i in n&&n[i](t,r,o)}},b=function(t,r){var i=t+'Mark';i in n&&(r?(y(t,e,n[i],o),delete n[i]):(y(t,e,n[i],e.length),n[i]=0))};for(o=0;o<i;o++)switch(t=e[o],c){case S.PARSER_UNINITIALIZED:return o;case S.START:a=0,c=S.START_BOUNDARY;case S.START_BOUNDARY:if(a==p.length-2){if(t===HYPHEN)u|=FB.LAST_BOUNDARY;else if(t!==CR)return o;a++;break}if(a-1===p.length-2){if(u&FB.LAST_BOUNDARY&&t===HYPHEN)y('end'),c=S.END,u=0;else{if(u&FB.LAST_BOUNDARY||t!==LF)return o;a=0,y('partBegin'),c=S.HEADER_FIELD_START}break}t!==p[a+2]&&(a=-2),t===p[a+2]&&a++;break;case S.HEADER_FIELD_START:c=S.HEADER_FIELD,g('headerField'),a=0;case S.HEADER_FIELD:if(t===CR){v('headerField'),c=S.HEADERS_ALMOST_DONE;break}if(a++,t===HYPHEN)break;if(t===COLON){if(1===a)return o;b('headerField',!0),c=S.HEADER_VALUE_START;break}if(r=lower(t),r<A||r>Z)return o;break;case S.HEADER_VALUE_START:if(t===SPACE)break;g('headerValue'),c=S.HEADER_VALUE;case S.HEADER_VALUE:t===CR&&(b('headerValue',!0),y('headerEnd'),c=S.HEADER_VALUE_ALMOST_DONE);break;case S.HEADER_VALUE_ALMOST_DONE:if(t!==LF)return o;c=S.HEADER_FIELD_START;break;case S.HEADERS_ALMOST_DONE:if(t!==LF)return o;y('headersEnd'),c=S.PART_DATA_START;break;case S.PART_DATA_START:c=S.PART_DATA,g('partData');case S.PART_DATA:if(s=a,!a){for(o+=h;o<m&&!(e[o]in f);)o+=d;o-=h,t=e[o]}if(a<p.length)p[a]===t?(a||b('partData',!0),a++):a=0;else if(a===p.length)a++,t===CR?u|=FB.PART_BOUNDARY:t===HYPHEN?u|=FB.LAST_BOUNDARY:a=0;else if(a-1===p.length)if(u&FB.PART_BOUNDARY){if(a=0,t===LF){u&=~FB.PART_BOUNDARY,y('partEnd'),y('partBegin'),c=S.HEADER_FIELD_START;break}}else u&FB.LAST_BOUNDARY&&t===HYPHEN?(y('partEnd'),y('end'),c=S.END,u=0):a=0;a?l[a-1]=t:s&&(y('partData',l,0,s),s=0,g('partData'),o--);break;case S.END:break;default:return o}return b('headerField'),b('headerValue'),b('partData'),n.index=a,n.state=c,n.flags=u,i},MultipartParser.prototype.end=function(){if(this.state===S.HEADER_FIELD_START&&0===this.index||this.state===S.PART_DATA&&this.index==this.boundary.length)this.onPartEnd&&this.onPartEnd(),this.onEnd&&this.onEnd();else if(this.state!=S.END)return this.onPartEnd&&this.onPartEnd(),this.onEnd&&this.onEnd(),new Error('MultipartParser.end(): stream ended unexpectedly: '+this.explain())},MultipartParser.prototype.explain=function(){return'state = '+MultipartParser.stateToString(this.state)},exports.appendModel=function(e){var t=e.indexOf('(');if(t===-1)return e;var r=e.substring(t+1);return e.substring(0,t)+'(model'+(')'===r[0]?r:','+r)},exports.preparePath=function(e,t){var r=F.config['default-root'];if(!r)return e;var n='/'===e[0];return n&&'/'===e[1]||':'===e[4]||':'===e[5]?e:t?e.substring(r.length-1):r+(n?e.substring(1):e)},exports.parseURI=function(e){var t,r,n=F.temporary.other[e.host];n?(t=n.port,r=n.hostname):(t=e.host.lastIndexOf(':'),t===-1?(t=null,r=e.host):(r=e.host.substring(0,t),t=e.host.substring(t+1)),F.temporary.other[e.host]={port:t,hostname:r});var o,i=e.url.indexOf('?',1),s=null;i===-1?(i=null,o=e.url):(o=e.url.substring(0,i),i=e.url.substring(i),s=i.substring(1));var a=o.indexOf('//');return a!==-1&&(o=cleanURL(o,a),e.url=o,i&&(e.url+=i)),{auth:null,hash:null,host:e.host,hostname:r,href:e.$protocol+'://'+e.host+e.url,path:e.url,pathname:o,port:t,protocol:e.$protocol+':',query:s,search:i,slashes:!0}},exports.encodeUnicodeURL=function(e){for(var t=e,r=0,n=e.length;r<n;r++){var o=e.charCodeAt(r);o>127&&(t=t.replace(e[r],encodeURIComponent(e[r])))}return t},exports.parseBlock=function(e,t){if(t.search(REG_BLOCK_BEG)===-1)return t;var r='\n',n=t.split(r),o=!1,i=!1,s='';e=(e||'').replace(/\s/g,'').split(',');for(var a=0,c=n.length;a<c;a++){var u=n[a];if(u)if(u.search(REG_BLOCK_END)===-1)if(o){if(i)continue;s+=u+r}else{var l=u.search(REG_BLOCK_BEG);if(l)if(l!==-1){o=!0,i=!0;for(var p=u.substring(l+8,u.indexOf('}',l)).replace(/\|\|/g,',').replace(/\s/g,'').split(','),f=0,d=p.length;f<d;f++)if(e.indexOf(p[f])!==-1){i=!1;break}}else s+=u+r}else o=!1,i=!1}return s.trim()},exports.restart=function(){INDEXMIXED=0,INDEXFILE=0},exports.viewEngineCompile=viewengine_dynamic,exports.viewEngine=viewengine_load,exports.parseLocalization=view_parse_localization,exports.findLocalization=view_find_localization,exports.destroyStream=destroyStream,exports.onFinished=onFinished,exports.modificators=modificators,module}({exports:{}}),function(e){function t(e,t){this.filename=t+ce,this.filenameTemp=t+le,this.filenameMeta=t+pe,this.directory=ae.dirname(t),this.filenameBackup=framework_utils.join(this.directory,e+'_backup'+ce),this.name=e,this.pending_update=[],this.pending_append=[],this.pending_reader=[],this.pending_reader_view=[],this.pending_remove=[],this.views={},this.step=0,this.pending_drops=!1,this.pending_views=!1,this.binary=new g(this,this.directory+'/'+this.name+'-binary/'),this.counter=new u(this),this.inmemory={},this.inmemorylastusage,this.metadata,this.$meta(),this.$timeoutmeta,this.$events={},this.$free=!0}function r(e,t){e.next(t)}function n(e){e.next(0),setImmediate(function(){return e.refresh()})}function o(){this.$callback=NOOP}function i(){this.$take=0,this.$skip=0,this.$filter=[],this.$sort,this.$first=!1,this.$scope=0,this.$fields,this.$join,this.$joincount,this.$callback=NOOP,this.$scalar,this.$scalarfield}function s(e,t,r,n,o){if('count'===t&&!n)return e.length;for(var i='min'!==t&&'max'!==t?'group'===t?{}:0:null,s=0,a=0,c=e.length;a<c;a++){var u=e[a];if(!n||u[n]===o)switch(t){case'count':i++;break;case'sum':i+=u[r]||0;break;case'avg':i+=u[r]||0,s++;break;case'min':i=null===i?u[r]:Math.min(i,u[r]);break;case'group':i[u[r]]?i[u[r]]++:i[u[r]]=1;break;case'max':i=null===i?u[r]:Math.max(i,u[r])}}return'avg'===t&&(i/=s),i||0}function a(e,t,r){for(var n=0,o=e.length;n<o;n++)if(e[n][t]===r)return e[n]}function c(e,t,r){for(var n=[],o=0,i=e.length;o<i;o++)e[o][t]===r&&n.push(e[o]);return n}function u(e){this.TIMEOUT=3e4,this.db=e,this.cache,this.key='nosql'+e.name.hash(),this.type=0,this.$events={}}function l(e,t,r,n){if(e.length<t)return e.push({id:r,count:n}),void(e.length===t&&e.sort(function(e,t){return e.count>t.count?-1:e.count===t.count?0:1}));for(var o=0,i=e.length;o<i;o++){var s=e[o];if(!(s.count>n)){for(var a=i-1;a>o;a--)e[a].id=e[a-1].id,e[a].count=e[a-1].count;return s.id=r,void(s.count=n)}}}function p(e){for(var t=0,r=0,n=e.length;r<n;r++){var o=e[r],i=+o.substring(o.indexOf('=',5)+1);i>0&&(t+=i)}return t}function f(e){for(var t=e.trim().split(';'),r={},n=[],o=1,i=t.length;o<i;o++){var s=+t[o].substring(7),a=t[o].substring(0,4);r[a]=s}for(var c=Object.keys(r),o=0,i=c.length;o<i;o++)n.push({year:+c[o],value:r[c[o]]});return n}function d(e){for(var t=e.trim().split(';'),r=[],n=1,o=t.length;n<o;n++){var i=+t[n].substring(7),s=t[n].substring(0,6);r.push({id:s,year:+t[n].substring(0,4),month:+t[n].substring(4,6),value:i})}return r}function h(e,t){for(var r=t.trim().split(';'),n=1,o=r.length;n<o;n++){var i=+r[n].substring(7),s=r[n].substring(0,4);e[s]?e[s]+=i:e[s]=i}}function m(e,t){for(var r=t.trim().split(';'),n=1,o=r.length;n<o;n++){var i=+r[n].substring(7),s=r[n].substring(0,6);e[s]?e[s]+=i:e[s]=i}}function g(e,t){this.db=e,this.directory=t,this.exists=!1,this.$events={}}function v(e){this.filename=e,this.items=[],this.is=!1,this.callback}function y(e,t,r){return r.value===e[r.name]}function b(e,t,r){return r.value<e[r.name]}function E(e,t,r){return r.value>e[r.name]}function w(e,t,r){return r.value<=e[r.name]}function _(e,t,r){return r.value>=e[r.name]}function k(e,t,r){return r.value!==e[r.name]}function $(e,t,r){var n=e[r.name];return!!n&&r.value.getTime()===(n instanceof Date?n:new Date(n)).getTime()}function S(e,t,r){var n=e[r.name];return!!n&&r.value<(n instanceof Date?n:new Date(n))}function O(e,t,r){var n=e[r.name];return!!n&&r.value>(n instanceof Date?n:new Date(n))}function x(e,t,r){var n=e[r.name];return!!n&&r.value<=(n instanceof Date?n:new Date(n))}function T(e,t,r){var n=e[r.name];return!!n&&r.value>=(n instanceof Date?n:new Date(n))}function R(e,t,r){var n=e[r.name];return!!n&&r.value!==(n instanceof Date?n:new Date(n))}function A(e,t,r){var n=e[r.name];return!!n&&n.startsWith(r.value)}function C(e,t,r){var n=e[r.name];return!!n&&n.endsWith(r.value)}function N(e,t,r){var n=e[r.name];if(!n||!n.toLowerCase)return!1;if(r.value instanceof Array){for(var o=0,i=r.value.length;o<i;o++)if(n.toLowerCase().indexOf(r.value[o])!==-1)return!0;return!1}return n.toLowerCase().indexOf(r.value)!==-1;
}function D(e,t,r){var n=e[r.name];return n>=r.a&&n<=r.b}function P(e,t,r){var n=e[r.name];if(n instanceof Array){for(var o=0,i=n.length;o<i;o++)if(r.value.indexOf(n[o])!==-1)return!0;return!1}return r.value.indexOf(n)!==-1}function j(e,t,r){var n=e[r.name];if(n instanceof Array){for(var o=0,i=n.length;o<i;o++)if(r.value.indexOf(n[o])!==-1)return!1;return!0}return r.value.indexOf(n)===-1}function I(e,t,r,n){if(!n)return!1;if(!n.getTime&&(n=new Date(n),isNaN(n)))return!1;switch(e){case'month':n=n.getMonth()+1;break;case'day':n=n.getDate();break;case'year':n=n.getFullYear()}return'='===t?r===n:'>'===t?r>n:'<'===t?r<n:'>='===t?r>=n:'<='===t?r<=n:r!==n}function M(e,t,r){return I('month','=',r.value,e[r.name])}function L(e,t,r){return I('month','<',r.value,e[r.name])}function H(e,t,r){return I('month','>',r.value,e[r.name])}function q(e,t,r){return I('month','<=',r.value,e[r.name])}function B(e,t,r){return I('month','>=',r.value,e[r.name])}function G(e,t,r){return I('month','!=',r.value,e[r.name])}function Y(e,t,r){return I('year','=',r.value,e[r.name])}function z(e,t,r){return I('year','<',r.value,e[r.name])}function W(e,t,r){return I('year','>',r.value,e[r.name])}function J(e,t,r){return I('year','<=',r.value,e[r.name])}function V(e,t,r){return I('year','>=',r.value,e[r.name])}function X(e,t,r){return I('year','!=',r.value,e[r.name])}function K(e,t,r){return I('day','=',r.value,e[r.name])}function Q(e,t,r){return I('day','<',r.value,e[r.name])}function Z(e,t,r){return I('day','>',r.value,e[r.name])}function ee(e,t,r){return I('day','<=',r.value,e[r.name])}function te(e,t,r){return I('day','>=',r.value,e[r.name])}function re(e,t,r){return I('day','!=',r.value,e[r.name])}function ne(e,t,r){if(e)return e;var n=r instanceof Array;return(!r||n&&!r.length)&&t.$callback_emptyerror?(new ErrorBuilder).push(t.$callback_emptyerror):null}function oe(e,t){return'string'==typeof t&&t.isJSONDate()?new Date(t):t}var ie=e.exports;global.framework_nosql=e.exports;var se=require('fs'),ae=require('path');global.framework_utils||(global.framework_utils=require('./utils')),global.framework_image||(global.framework_image=require('./image')),global.framework_nosql||(global.framework_nosql=ie),global.framework_builders||(global.framework_builders=require('./builders'));var ce='.nosql',ue='.nosql-binary',le='.nosql-tmp',pe='.meta',fe=2e3,de='\n',he=[],me=/^[\s]+|[\s]+$/g,ge={};return Object.freeze(he),t.prototype.emit=function(e,t,r,n,o,i,s,a){var c=this.$events[e];if(c){for(var u=!1,l=0,p=c.length;l<p;l++)c[l].$once&&(u=!0),c[l].call(this,t,r,n,o,i,s,a);u&&(c=c.remove(function(e){return e.$once}),c.length?this.$events[e]=c:this.$events[e]=void 0)}return this},t.prototype.on=function(e,t){return t.$once||(this.$free=!1),this.$events[e]?this.$events[e].push(t):this.$events[e]=[t],this},t.prototype.once=function(e,t){return t.$once=!0,this.on(e,t)},t.prototype.removeListener=function(e,t){var r=this.$events[e];return r&&(r=r.remove(function(e){return e===t}),r.length?this.$events[e]=r:this.$events[e]=void 0),this},t.prototype.removeAllListeners=function(e){return e===!0?this.$events=EMPTYOBJECT:e?this.$events[e]=void 0:this.$events[e]={},this},ie.load=function(e,r){return new t(e,r)},ie.memory=ie.inmemory=function(e,t){return t&&(e+='#'+t),ge[e]=!0},t.prototype.meta=function(e,t){var r=this;return void 0===t?r.metadata?r.metadata[e]:void 0:(r.metadata||(r.metadata={}),r.metadata[e]=t,clearTimeout(r.timeoutmeta),r.timeoutmeta=setTimeout(function(){return r.$meta(!0)},500),r)},t.prototype.insert=function(e,t){var n,i=this;if(t){n=i.one();var s;return n.callback(function(t,r){r?s&&s(null,0):i.insert(e).callback(s)}),n.callback=function(e){return s=e,n},n}n=new o;var a=framework_builders.isSchema(e)?e.$clean():e;return i.pending_append.push({doc:JSON.stringify(a),builder:n}),setImmediate(r,i,1),i.emit('insert',a),n},t.prototype.upsert=function(e){return this.insert(e,!0)},t.prototype.update=function(e,t){var n=this,o=new i,s=framework_builders.isSchema(e)?e.$clean():e;return n.pending_update.push({builder:o,doc:s,count:0,insert:t===!0?s:t}),setImmediate(r,n,2),o},t.prototype.modify=function(e,t){var n=this,o=new i,s=framework_builders.isSchema(e)?e.$clean():e,a=Object.keys(s);return a.length?(n.pending_update.push({builder:o,doc:s,count:0,keys:a,insert:t===!0?s:t}),setImmediate(r,n,2),o):o},t.prototype.backup=function(e,t){'boolean'==typeof e&&(t=e,e='');var r=this;if(t)return r.remove(e||'');var n=new o,i=se.createReadStream(r.filename);return i.pipe(se.createWriteStream(e||r.filenameBackup)),i.on('error',function(e){n.$callback&&n.$callback(ne(e,n)),n.$callback=null}),i.on('end',function(){n.$callback&&n.$callback(ne(null,n,!0),!0),n.$callback=null}),n},t.prototype.drop=function(){var e=this;return e.pending_drops=!0,setImmediate(r,e,7),e},t.prototype.free=function(e){var t=this;return e||t.$free?(t.counter.removeAllListeners(!0),t.binary.removeAllListeners(!0),t.removeAllListeners(!0),delete framework.databases[t.name],t):t},t.prototype.release=function(){var e=this;return e.inmemory={},e.inmemorylastusage=void 0,e},t.prototype.clear=t.prototype.remove=function(e){var t=this,n=new i,o=void 0===e?void 0:e||t.filenameBackup;return o&&(o=new v(o)),t.pending_remove.push({builder:n,count:0,backup:o}),setImmediate(r,t,3),n},t.prototype.find=function(e){var t=this,n=new i;return e?(t.pending_reader_view.push({builder:n,count:0,counter:0,view:e}),setImmediate(r,t,6)):(t.pending_reader.push({builder:n,count:0,counter:0,view:e}),setImmediate(r,t,4)),n},t.prototype.scalar=function(e,t,r){return this.find(r).scalar(e,t)},t.prototype.count=function(e){var t=this,n=new i;return e?(t.pending_reader_view.push({builder:n,count:0,view:e,type:1}),setImmediate(r,t,6)):(t.pending_reader.push({builder:n,count:0,view:e,type:1}),setImmediate(r,t,4)),n},t.prototype.one=function(e){var t=this,n=new i;return n.first(),e?(t.pending_reader_view.push({builder:n,count:0,view:e}),setImmediate(r,t,6)):(t.pending_reader.push({builder:n,count:0,view:e}),setImmediate(r,t,4)),n},t.prototype.top=function(e,t){var n=this,o=new i;return o.take(e),t?(n.pending_reader_view.push({builder:o,count:0,counter:0,view:t}),setImmediate(r,n,6)):(n.pending_reader.push({builder:o,count:0,counter:0,view:t}),setImmediate(r,n,4)),o},t.prototype.view=function(e){var t=new i;return this.views[e]={},this.views[e]=t,this.views[e].$filename=this.filename.replace(/\.nosql/,'#'+e+'.nosql'),t},t.prototype.next=function(e){var t=this;return e&&t.step?t:6!==t.step&&t.pending_reader_view.length?(t.$readerview(),t):4!==t.step&&t.pending_reader.length?(t.$reader(),t):1!==t.step&&t.pending_append.length?(ge[t.name]?t.$append_inmemory():t.$append(),t):2!==t.step&&t.pending_update.length?(ge[t.name]?t.$update_inmemory():t.$update(),t):3!==t.step&&t.pending_remove.length?(ge[t.name]?t.$remove_inmemory():t.$remove(),t):5!==t.step&&t.pending_views?(ge[t.name]?t.$views_inmemory():t.$views(),t):7!==t.step&&t.pending_drops?(t.$drop(),t):(t.step!==e&&(t.step=0,setImmediate(r,t,0)),t)},t.prototype.refresh=function(){var e=this;return e.views?(e.pending_views=!0,setImmediate(r,e,5),e):e},t.prototype.$save=function(e){var t=this;return setTimeout2('nosql.'+t.name+'.'+e,function(){for(var r=t.inmemory[e]||he,n=[],o=0,i=r.length;o<i;o++)n.push(JSON.stringify(r[o]));var s=t.filename;'#'!==e&&(s=s.replace(/\.nosql/,'#'+e+'.nosql')),se.writeFile(s,n.join(de)+de,NOOP)},50,100),t},t.prototype.$inmemory=function(e,t){var r=this;if(r.inmemorylastusage=global.framework?global.framework.datetime:void 0,r.inmemory[e])return t();var n=r.filename;return'#'!==e&&(n=n.replace(/\.nosql/,'#'+e+'.nosql')),r.inmemory[e]=[],se.readFile(n,function(n,o){if(n)return t();for(var i=o.toString('utf8').split('\n'),s=0,a=i.length;s<a;s++){var c=i[s];if(c)try{c=JSON.parse(c.trim(),oe),c&&r.inmemory[e].push(c)}catch(e){}}t()}),r},t.prototype.$meta=function(e){var t=this;if(e)return se.writeFile(t.filenameMeta,JSON.stringify(t.metadata),NOOP),t;try{t.metadata=JSON.parse(se.readFileSync(t.filenameMeta).toString('utf8'),oe)}catch(e){}return t},t.prototype.$append=function(){var e=this;return e.step=1,e.pending_append.length?(e.pending_append.splice(0).limit(20,function(t,r){for(var n=[],o=0,i=t.length;o<i;o++)n.push(t[o].doc);se.appendFile(e.filename,n.join(de)+de,function(e){for(var n=0,o=t.length;n<o;n++){var i=t[n].builder.$callback;i&&i(e,1)}r()})},function(){return setImmediate(n,e)}),e):(e.next(0),e)},t.prototype.$append_inmemory=function(){var e=this;if(e.step=1,!e.pending_append.length)return e.next(0),e;var t=e.pending_append.splice(0);return e.$inmemory('#',function(){for(var r=0,o=t.length;r<o;r++){e.inmemory['#'].push(JSON.parse(t[r].doc,oe));var i=t[r].builder.$callback;i&&i(null,1)}e.$save('#'),setImmediate(n,e)})},t.prototype.$update=function(){var e=this;if(e.step=2,!e.pending_update.length)return e.next(0),e;var t=se.createReadStream(e.filename),r=se.createWriteStream(e.filenameTemp),n=e.pending_update.splice(0),o=n.length,i=!1;return t.on('data',framework_utils.streamer(de,function(t,s){for(var a=JSON.parse(t.trim()),c=0;c<o;c++){var u=n[c],l=u.builder,p=l.compare(a,s);if(p){if(u.keys)for(var f=0,d=u.keys.length;f<d;f++){var h=u.doc[u.keys[f]];void 0!==h&&('function'==typeof h?a[u.keys[f]]=h(a[u.keys[f]],a):a[u.keys[f]]=h)}else a='function'==typeof u.doc?u.doc(a):u.doc;e.emit(u.keys?'modify':'update',a),u.count++,i=!0}}r.write(JSON.stringify(a)+de)})),CLEANUP(r,function(){se.rename(e.filenameTemp,e.filename,function(t){for(var r=0;r<o;r++){var s=n[r];s.insert&&!s.count?e.insert(s.insert).$callback=s.builder.$callback:s.builder.$callback&&s.builder.$callback(ne(t,s.builder,s.count),s.count)}setImmediate(function(){e.next(0),i&&setImmediate(function(){return e.refresh()})})})}),CLEANUP(t,function(){return r.end()}),e},t.prototype.$update_inmemory=function(){var e=this;if(e.step=2,!e.pending_update.length)return e.next(0),e;var t=e.pending_update.splice(0),r=t.length,n=!1;return e.$inmemory('#',function(){for(var o=e.inmemory['#'],i=0,s=o.length;i<s;i++)for(var a=o[i],c=0;c<r;c++){var u=t[c],l=u.builder,p=l.compare(a,i);if(p){if(u.keys)for(var i=0,s=u.keys.length;i<s;i++){var f=u.doc[u.keys[i]];void 0!==f&&('function'==typeof f?a[u.keys[i]]=f(a[u.keys[i]],a):a[u.keys[i]]=f)}else a='function'==typeof u.doc?u.doc(a):u.doc;e.emit(u.keys?'modify':'update',a),u.count++,n=!0}}e.$save('#');for(var c=0;c<r;c++){var u=t[c];u.insert&&!u.count?e.insert(u.insert).$callback=u.builder.$callback:(u.count&&e.emit(u.keys?'modify':'update',u.doc),u.builder.$callback&&u.builder.$callback(ne(null,u.builder,u.count),u.count))}setImmediate(function(){e.next(0),n&&setImmediate(function(){return e.refresh()})})})},t.prototype.$reader=function(){var e=this;if(e.step=4,!e.pending_reader.length)return e.next(0),e;var t=e.pending_reader.splice(0);return ge[e.name]?e.$reader2_inmemory('#',t,function(){return e.next(0)}):e.$reader2(e.filename,t,function(){return e.next(0)}),e},t.prototype.$readerview=function(){var e=this;if(e.step=6,!e.pending_reader_view.length)return e.next(0),e;for(var t={},r=!0,n=0,o=e.pending_reader_view.length;n<o;n++){var i=e.pending_reader_view[n],s=ge[e.name]||ge[e.name+'#'+i.view]?i.view:e.views[i.view].$filename;r=!1,t[s]?t[s].push(i):t[s]=[i]}return e.pending_reader_view=[],r?(e.next(0),e):(Object.keys(t).wait(function(r,n){ge[e.name]||ge[e.name+'#'+r]?e.$reader2_inmemory(r,t[r],n):e.$reader2(r,t[r],n)},function(){return e.next(0)},5),e)},t.prototype.$reader2=function(e,t,r){var n=this,o=se.createReadStream(e),i=t,s=i.length;return o.on('data',framework_utils.streamer(de,function(e,t){for(var r,n=JSON.parse(e.trim(),oe),o=0;o<s;o++){var a=i[o],c=a.builder,u=c.compare(n,t);if(u&&(a.count++,(c.$sort||!(c.$skip&&c.$skip>=a.count||c.$take&&c.$take<=a.counter))&&(a.counter++,!a.type)))switch(c.$scalar){case'count':a.scalar=a.scalar?a.scalar+1:1;break;case'sum':r=n[c.$scalarfield]||0,a.scalar=a.scalar?a.scalar+r:r;break;case'min':r=n[c.$scalarfield]||0,a.scalar=a.scalar?Math.min(a.scalar,r):r;break;case'max':r=n[c.$scalarfield]||0,a.scalar=a.scalar?Math.max(a.scalar,r):r;break;case'avg':r=n[c.$scalarfield]||0,a.scalar=a.scalar?a.scalar+r:r;break;case'group':r=n[c.$scalarfield],a.scalar||(a.scalar={}),a.scalar[r]?a.scalar[r]++:a.scalar[r]=1;break;default:a.response?a.response.push(u):a.response=[u]}}})),CLEANUP(o,function(){for(var e=0;e<s;e++){var t,n=i[e],o=n.builder;!o.$scalar&&o.$sort?(n.count&&(o.$sort.name?n.response.quicksort(o.$sort.name,o.$sort.asc):o.$sort===EMPTYOBJECT?n.response.random():n.response.sort(o.$sort),o.$skip&&o.$take?n.response=n.response.splice(o.$skip,o.$take):o.$skip?n.response=n.response.splice(o.$skip):o.$take&&(n.response=n.response.splice(0,o.$take))),t=o.$first?n.response?n.response[0]:void 0:n.response||he,o.$callback2(ne(null,o,t),1===n.type?n.count:t,n.count),o.done()):(t=o.$scalar?'avg'===o.$scalar?n.scalar/n.counter:n.scalar:o.$first?n.response?n.response[0]:void 0:n.response||he,o.$callback2(ne(null,o,t),1===n.type?n.count:t,n.count))}r()}),n},t.prototype.$reader2_inmemory=function(e,t,r){var n=this,o=t,i=o.length;return n.$inmemory(e,function(){for(var t,s=n.inmemory[e],a=0,c=s.length;a<c;a++)for(var u=s[a],l=0;l<i;l++){var p=o[l],f=p.builder,d=f.compare(U.clone(u),a);if(d&&(p.count++,(f.$sort||!(f.$skip&&f.$skip>=p.count||f.$take&&f.$take<=p.counter))&&(p.counter++,!p.type)))switch(f.$scalar){case'count':p.scalar=p.scalar?p.scalar+1:1;break;case'sum':t=u[f.$scalarfield]||0,p.scalar=p.scalar?p.scalar+t:t;break;case'min':t=u[f.$scalarfield]||0,p.scalar=p.scalar?Math.min(p.scalar,t):t;break;case'max':t=u[f.$scalarfield]||0,p.scalar=p.scalar?Math.max(p.scalar,t):t;break;case'avg':t=u[f.$scalarfield]||0,p.scalar=p.scalar?p.scalar+t:0;break;case'group':t=u[f.$scalarfield],p.scalar||(p.scalar={}),p.scalar[t]?p.scalar[t]++:p.scalar[t]=1;break;default:p.response?p.response.push(d):p.response=[d]}}for(var l=0;l<i;l++){var d,p=o[l],f=p.builder;!f.$scalar&&f.$sort?(p.count&&(f.$sort.name?p.response.quicksort(f.$sort.name,f.$sort.asc):f.$sort===EMPTYOBJECT?p.response.random():p.response.sort(f.$sort),f.$skip&&f.$take?p.response=p.response.splice(f.$skip,f.$take):f.$skip?p.response=p.response.splice(f.$skip):f.$take&&(p.response=p.response.splice(0,f.$take))),d=f.$first?p.response?p.response[0]:void 0:p.response||he,f.$callback2(ne(null,f,d),1===p.type?p.count:d,p.count),f.done()):(d=f.$scalar?'avg'===f.$scalar?p.scalar/p.counter:p.scalar:f.$first?p.response?p.response[0]:void 0:p.response||he,f.$callback2(ne(null,f,d),1===p.type?p.count:d,p.count))}r()})},t.prototype.$views=function(){var e=this;if(e.step=5,!e.pending_views)return e.next(0),e;e.pending_views=!1;var t=Object.keys(e.views),r=t.length;if(!r)return e.next(0),e;for(var n=[],o=0;o<r;o++)n.push({response:[],name:t[o],builder:e.views[t[o]],count:0,counter:0});var i=se.createReadStream(e.filename);return i.on('data',framework_utils.streamer(de,function(o,i){for(var s=JSON.parse(o.trim()),a=0;a<r;a++){var c=e.views[t[a]],u=c.compare(s,i);u&&(n[a].count++,!c.$sort&&(c.$skip&&c.$skip>=n[a].count||c.$take&&c.$take<n[a].counter)||(n[a].counter++,!c.type&&n[a].response.push(u)))}})),CLEANUP(i,function(){n.wait(function(t,r){var n=t.builder;n.$sort&&(n.$sort.name?t.response.quicksort(n.$sort.name,n.$sort.asc):n.$sort===EMPTYOBJECT?t.response.random():t.response.sort(n.$sort),n.$skip&&n.$take?t.response=t.response.splice(n.$skip,n.$take):n.$skip?t.response=t.response.splice(n.$skip):n.$take&&(t.response=t.response.splice(0,n.$take)));var o=n.$filename;se.unlink(o,function(){t.response.limit(20,function(e,t){for(var r=[],n=0,i=e.length;n<i;n++)r.push(JSON.stringify(e[n]));se.appendFile(o,r.join(de)+de,t)},function(){e.inmemory[t.name]=void 0,r()})})},function(){return e.next(0)},5)}),e},t.prototype.$views_inmemory=function(){var e=this;if(e.step=5,!e.pending_views)return e.next(0),e;e.pending_views=!1;var t=Object.keys(e.views),r=t.length;if(!r)return e.next(0),e;for(var n=[],o=0;o<r;o++)n.push({response:[],name:t[o],builder:e.views[t[o]],count:0,counter:0});return e.$inmemory('#',function(){for(var o=e.inmemory['#'],i=0,s=o.length;i<s;i++)for(var a=o[i],c=0;c<r;c++){var u=e.views[t[c]],l=u.compare(a,i);l&&(n[c].count++,!u.$sort&&(u.$skip&&u.$skip>=n[c].count||u.$take&&u.$take<n[c].counter)||(n[c].counter++,!u.type&&n[c].response.push(l)))}for(var i=0,s=n.length;i<s;i++){var u=n[i],p=u.builder;p.$sort&&(p.$sort.name?u.response.quicksort(p.$sort.name,p.$sort.asc):p.$sort===EMPTYOBJECT?u.response.random():u.response.sort(p.$sort),p.$skip&&p.$take?u.response=u.response.splice(p.$skip,p.$take):p.$skip?u.response=u.response.splice(p.$skip):p.$take&&(u.response=u.response.splice(0,p.$take))),e.inmemory[u.name]=u.response,e.$save(u.name)}e.next(0)})},t.prototype.$remove=function(){var e=this;if(e.step=3,!e.pending_remove.length)return e.next(0),e;var t=se.createReadStream(e.filename),r=se.createWriteStream(e.filenameTemp),n=e.pending_remove.splice(0),o=n.length,i=!1;return t.on('data',framework_utils.streamer(de,function(t,s){for(var a=JSON.parse(t.trim()),c=!1,u=0;u<o;u++){var l=n[u],p=l.builder;if(p.compare(a,s)){c=!0;break}}if(c){for(var u=0;u<o;u++){var l=n[u];l.backup&&l.backup.write(t),l.count++}e.emit('remove',a),i=!0}else r.write(t)})),CLEANUP(r,function(){se.rename(e.filenameTemp,e.filename,function(){for(var t=0;t<o;t++){var r=n[t];r.builder.$callback&&r.builder.$callback(ne(null,r.builder,r.count),r.count)}setImmediate(function(){e.next(0),i&&setImmediate(function(){return e.refresh()})})})}),CLEANUP(t,function(){return r.end()}),e},t.prototype.$remove_inmemory=function(){var e=this;if(e.step=3,!e.pending_remove.length)return e.next(0),e;var t=e.pending_remove.splice(0),r=t.length,n=!1;return e.$inmemory('#',function(){for(var o=e.inmemory['#'],i=[],s=0,a=o.length;s<a;s++){for(var c=o[s],u=!1,l=0;l<r;l++){var p=t[l],f=p.builder;if(f.compare(c,s)){u=!0;break}}if(u){for(var l=0;l<r;l++){var p=t[l];p.backup&&p.backup.write(JSON.stringify(c)),p.count++}n=!0,e.emit('remove',c)}else i.push(c)}n&&(e.inmemory['#']=i,e.$save('#'));for(var l=0;l<r;l++){var p=t[l];p.builder.$callback&&p.builder.$callback(ne(null,p.builder,p.count),p.count)}e.next(0),n&&setImmediate(function(){return e.refresh()})})},t.prototype.$drop=function(){var e=this;if(e.step=7,!e.pending_drops)return e.next(0),e;e.pending_drops=!1;var t=[e.filename,e.filenameTemp];Object.keys(e.views).forEach(function(r){return t.push(e.views[r].$filename)});try{se.readdirSync(e.binary.directory).forEach(function(r){r.startsWith(e.name+'#')&&r.endsWith(ue)&&t.push(framework_utils.join(e.binary.directory,r))})}catch(e){}return t.wait(function(e,t){return se.unlink(e,t)},function(){e.next(0),e.free(!0)},5),Object.keys(e.inmemory).forEach(function(t){e.inmemory[t]=void 0}),e},o.prototype.callback=function(e,t){if('string'==typeof e){var r=t;t=e,e=r}return this.$callback=e,this.$callback_emptyerror=t,this},i.prototype.$callback2=function(e,t,r){var n=this;if(e||!n.$join)return n.$callback(e,t,r);if(n.$joincount)return setImmediate(function(){return n.$callback2(e,t,r)}),n;var o=Object.keys(n.$join),i=o.length;if(t instanceof Array)for(var u=0,l=t.length;u<l;u++)for(var p=t[u],f=0;f<i;f++){var d=n.$join[o[f]];p[d.field]=d.scalar?s(d.items,d.scalar,d.scalarfield,d.a,null!=d.b?p[d.b]:void 0):d.first?a(d.items,d.a,p[d.b],d.scalar,d.scalarfield):c(d.items,d.a,p[d.b])}else if(t)for(var f=0;f<i;f++){var d=n.$join[o[f]];t[d.field]=d.scalar?s(d.items,d.scalar,d.scalarfield,d.a,null!=d.b?t[d.b]:void 0):d.first?a(d.items,d.a,t[d.b],d.scalar,d.scalarfield):c(d.items,d.a,t[d.b])}return n.$callback(e,t,r),n},i.prototype.join=function(e,t,r){var n=this;n.$join||(n.$join={},n.$joincount=0);var o=t+'.'+(r||'');if(n.$join[o])return i;n.$join[o]={},n.$join[o].field=e,n.$join[o].pending=!0,n.$joincount++;var i=NOSQL(t).find(r);return i.where=function(e,t){return n.$join[o].a=e,n.$join[o].b=t,i},i.scalar=function(e,t){return n.$join[o].scalar=e,n.$join[o].scalarfield=t,i},i.first=function(){return n.$join[o].first=!0,i},i.callback(function(e,t){n.$join[o].pending=!1,n.$join[o].items=t,n.$joincount--}),setImmediate(function(){i.$fields&&i.fields(n.$join[o].b),i.$fields&&n.$join[o].scalarfield&&i.fields(n.$join[o].scalarfield)}),i},i.prototype.first=function(){return this.$first=!0,this.take(1)},i.prototype.make=function(e){return e.call(this,this),this},i.prototype.compare=function(e,t){for(var r=!0,n=!1,o=0,i=this.$filter.length;o<i;o++){var s=this.$filter[o];if(!n||!s.scope){var a=s.filter(e,o,s);if(a!==!0){if(!s.scope)return;r=!1}else r=!0,s.scope&&(n=!0)}}if(r){if(this.$prepare)return this.$prepare(e,t);if(!this.$fields)return e;for(var c={},o=0,i=this.$fields.length;o<i;o++){var u=this.$fields[o];c[u]=e[u]}return c}},i.prototype.filter=function(e){return this.$filter.push({scope:this.$scope,filter:e}),this},i.prototype.scalar=function(e,t){return this.$scalar=e,this.$scalarfield=t,this},i.prototype.where=function(e,t,r){var n;void 0===r&&(r=t,t='=');var o=framework_utils.isDate(r);switch(t){case'=':n=o?$:y;break;case'<':n=o?O:E;break;case'<=':n=o?T:_;break;case'>':n=o?S:b;break;case'>=':n=o?x:w;break;case'<>':case'!=':n=o?R:k}return this.$filter.push({scope:this.$scope,filter:n,name:e,value:r}),this},i.prototype.month=function(e,t,r){var n;switch(void 0===r&&(r=t,t='='),t){case'=':n=M;break;case'<':n=H;break;case'<=':n=B;break;case'>':n=L;break;case'>=':n=q;break;case'<>':case'!=':n=G}return this.$filter.push({scope:this.$scope,filter:n,name:e,value:r}),this},i.prototype.day=function(e,t,r){var n;switch(void 0===r&&(r=t,t='='),t){case'=':n=K;break;case'<':n=Z;break;case'<=':n=te;break;case'>':n=Q;break;case'>=':n=ee;break;case'<>':case'!=':n=re}return this.$filter.push({scope:this.$scope,filter:n,name:e,value:r}),this},i.prototype.year=function(e,t,r){var n;switch(void 0===r&&(r=t,t='='),t){case'=':n=Y;break;case'<':n=W;break;case'<=':n=V;break;case'>':n=z;break;case'>=':n=J;break;case'<>':case'!=':n=X}return this.$filter.push({scope:this.$scope,filter:n,name:e,value:r}),this},i.prototype.like=i.prototype.search=function(e,t,r){var n;switch(r||(r='*'),r){case'beg':n=A;break;case'end':n=C;break;case'*':if(n=N,t instanceof Array)for(var o=0,i=t.length;o<i;o++)t[o]=t[o].toLowerCase();else t=t.toLowerCase()}return this.$filter.push({scope:this.$scope,name:e,filter:n,value:t}),this},i.prototype.take=function(e){return this.$take=e,this},i.prototype.limit=function(e){return this.$take=e,this},i.prototype.page=function(e,t){return this.skip(e*t),this.take(t)},i.prototype.skip=function(e){return this.$skip=e,this},i.prototype.callback=function(e,t){if('string'==typeof e){var r=t;t=e,e=r}return this.$callback=e,this.$callback_emptyerror=t,this},i.prototype.random=function(){return this.$sort=EMPTYOBJECT,this},i.prototype.sort=function(e,t){return'function'==typeof e?(this.$sort=e,this):(this.$sort={name:e,asc:!t},this)},i.prototype.in=function(e,t){return t instanceof Array||(t=[t]),this.$filter.push({scope:this.$scope,name:e,filter:P,value:t}),this},i.prototype.notin=function(e,t){return t instanceof Array||(t=[t]),this.$filter.push({scope:this.$scope,name:e,filter:j,value:t}),this},i.prototype.between=function(e,t,r){return this.$filter.push({scope:this.$scope,name:e,filter:D,a:t,b:r}),this},i.prototype.or=function(){return this.$scope=1,this},i.prototype.end=function(){return this.$scope=0,this},i.prototype.and=function(){return this.$scope=0,this},i.prototype.done=function(){return this.$filter=null,this.$sort=null,this},i.prototype.cache=function(){return OBSOLETE('DatabaseBuilder.cache()','NoSQL database supports in-memory mode.'),this},i.prototype.fields=function(){this.$fields||(this.$fields=[]);for(var e=0,t=arguments.length;e<t;e++)this.$fields.push(arguments[e]);return this},i.prototype.prepare=function(e){return this.$prepare=e,this},u.prototype.emit=function(e,t,r,n,o,i,s,a){var c=this.$events[e];if(c){for(var u=!1,l=0,p=c.length;l<p;l++)c[l].$once&&(u=!0),c[l].call(this,t,r,n,o,i,s,a);u&&(c=c.remove(function(e){return e.$once}),c.length?this.$events[e]=c:this.$events[e]=void 0)}return this},u.prototype.on=function(e,t){return t.$once||(this.db.$free=!1),this.$events[e]?this.$events[e].push(t):this.$events[e]=[t],this},u.prototype.once=function(e,t){return t.$once=!0,this.on(e,t)},u.prototype.removeListener=function(e,t){var r=this.$events[e];return r&&(r=r.remove(function(e){return e===t}),r.length?this.$events[e]=r:this.$events[e]=void 0),this},u.prototype.removeAllListeners=function(e){return e===!0?this.$events=EMPTYOBJECT:e?this.$events[e]=void 0:this.$events={},this},u.prototype.inc=u.prototype.hit=function(e,t){var r=this;return e instanceof Array?(e.forEach(function(e){return r.hit(e,t)}),r):(!r.cache&&(r.cache={}),r.cache[e]?r.cache[e]+=t||1:r.cache[e]=t||1,setTimeout2(r.key,function(){return r.save()},r.TIMEOUT,5),r.emit('hit',e,t||1),r)},u.prototype.remove=function(e){var t=this;return!t.cache&&(t.cache={}),e instanceof Array?e.forEach(function(e){return t.cache[e]=null}):t.cache[e]=null,setTimeout2(t.key,function(){return t.save()},t.TIMEOUT,5),t.emit('remove',e),t},u.prototype.count=function(e,t){return'function'==typeof e&&(t=e,e=null),this.read(e,0,t)},u.prototype.yearly=function(e,t){return'function'==typeof e&&(t=e,e=null),this.read(e,1,t)},u.prototype.monthly=function(e,t){return'function'==typeof e&&(t=e,e=null),this.read(e,2,t)},u.prototype.read=function(e,t,r){var n=this;if(n.type)return setTimeout(function(){return n.read(e,t,r)},200),n;var o=n.db.filename+'-counter',i=se.createReadStream(o),s={},a=!1,c=!e,u=c&&!t?0:{};return'string'==typeof e&&(e=[e],a=!0),e instanceof Array&&e.forEach(function(e){return s[e]=!0}),n.type=2,i.on('error',function(){n.type=0,r(null,a?t?u:0:c?he:u)}),i.on('data',framework_utils.streamer(de,function(r,n){var n=r.indexOf('='),o=r.substring(0,n);if(c||e===!0||s[o])switch(t){case 0:c?u+=+r.substring(n+1,r.indexOf(';')):u[o]=+r.substring(n+1,r.indexOf(';'));break;case 1:c?h(u,r):u[o]=f(r);break;case 2:c?m(u,r):u[o]=d(r)}})),i.on('end',function(){if(n.type=0,c&&t){var o=[];2===t?Object.keys(u).forEach(function(e){return o.push({id:e,year:+e.substring(0,4),month:+e.substring(4,6),value:u[e]})}):Object.keys(u).forEach(function(e){return o.push({year:+e,value:u[e]})}),u=o}r(null,a?t?u[e[0]]||EMPTYOBJECT:u[e[0]]||0:u)}),n},u.prototype.stats=function(e,t,r,n){var o=this;if(o.type)return setTimeout(function(){return o.stats(e,t,r,n)},200),o;'function'==typeof r?(n=r,r=null):'function'==typeof t&&(n=t,t=r=null);var i,s=o.db.filename+'-counter',a=se.createReadStream(s),c=[];return o.type=3,null!=t&&(i=t.toString(),null!=r?(i+=r.padLeft(2,'0'),i=new RegExp(';'+i+'=\\d+','g')):i=new RegExp(';'+i+'\\d+=\\d+','g')),a.on('error',function(){o.type=0,n&&n(null,c)}),a.on('data',framework_utils.streamer(de,function(t,r){var n,r=t.indexOf('=');if(i){var o=t.match(i);if(!o)return;n=p(o)}else n=+t.substring(r+1,t.indexOf(';',r));l(c,e,t.substring(0,r),n)})),a.on('end',function(){o.type=0,n&&n(null,c)}),o},u.prototype.save=function(){var e=this;if(e.type)return setTimeout(function(){return e.save()},200),e;var t=e.db.filename+'-counter',r=se.createReadStream(t),n=se.createWriteStream(t+'-tmp'),o=F.datetime.format('yyyyMM')+'=',i=e.cache;e.cache=null,e.type=1;var s=function(){for(var e=Object.keys(i),t=0,r=e.length;t<r;t++){var s=i[e[t]];s&&n.write(e[t]+'='+s+';'+o+s+de)}n.end()};return r.on('data',framework_utils.streamer(de,function(e,t){var r=e.substring(0,e.indexOf('='));if(!i[r])return void(null!==i[r]&&n.write(e));var s=i[r],a=e.trim().split(';'),c=!1,t=a[0].indexOf('=');a[0]=a[0].substring(0,t+1)+(+a[0].substring(t+1)+s);for(var u=1,l=a.length;u<l;u++){var p=a[u],f=p.substring(0,7);if(f===o){c=!0,a[u]=f+(+p.substring(7)+s);break}}i[r]=void 0,!c&&a.push(o+s),n.write(a.join(';')+de)})),r.on('error',s),r.on('end',s),CLEANUP(n,function(){se.rename(t+'-tmp',t,function(){clearTimeout(e.timeout),e.timeout=0,e.type=0})}),e},u.prototype.clear=function(e){var t=this;return t.type?(setTimeout(function(){return t.clear(e)},200),t):(t.type=3,se.unlink(t.db.filename+'-counter',function(){t.type=0,t.emit('clear'),e&&e()}),t)},g.prototype.emit=function(e,t,r,n,o,i,s,a){var c=this.$events[e];if(c){for(var u=!1,l=0,p=c.length;l<p;l++)c[l].$once&&(u=!0),c[l].call(this,t,r,n,o,i,s,a);u&&(c=c.remove(function(e){return e.$once}),c.length?this.$events[e]=c:this.$events[e]=void 0)}return this},g.prototype.on=function(e,t){return t.$once||(this.db.$free=!1),this.$events[e]?this.$events[e].push(t):this.$events[e]=[t],this},g.prototype.once=function(e,t){return t.$once=!0,this.on(e,t)},g.prototype.removeListener=function(e,t){var r=this.$events[e];return r&&(r=r.remove(function(e){return e===t}),r.length?this.$events[e]=r:this.$events[e]=void 0),this},g.prototype.removeAllListeners=function(e){return e===!0?this.$events=EMPTYOBJECT:e?this.$events[e]=void 0:this.$events={},this},g.prototype.insert=function(e,t,r){var n=this,o=framework_utils.getContentType(framework_utils.getExtension(e)),i='function'==typeof t;if(i||!t){i&&(r=t,t=void 0);var s=se.createReadStream(e);return CLEANUP(s),n.insert_stream(null,framework_utils.getName(e),o,s,r)}if('string'==typeof t)t=framework_utils.createBuffer(t,'base64');else if(t.resume)return n.insert_stream(null,e,o,t,r);var a,c=t.length,u=framework_utils.getExtension(e);switch(n.check(),u){case'gif':a=framework_image.measureGIF(t);break;case'png':a=framework_image.measurePNG(t);break;case'jpg':case'jpeg':a=framework_image.measureJPG(t);break;case'svg':a=framework_image.measureSVG(t)}a||(a={width:0,height:0});var l={name:e,size:c,type:o,width:a.width,height:a.height,created:F.created},p=framework_utils.createBufferSize(fe);p.fill(' '),p.write(JSON.stringify(l));var f=framework.datetime.format('yyMMddHHmm')+'T'+framework_utils.GUID(5),d=n.db.name+'#'+f,h=se.createWriteStream(ae.join(n.directory,d+ue));return h.write(p,'binary'),h.end(t),CLEANUP(h),r&&r(null,f,l),n.$events.insert&&n.emit('insert',f,l),f},g.prototype.insert_stream=function(e,t,r,n,o){var i=this;i.check();var s={name:t,size:0,type:r,width:0,height:0},a=framework_utils.createBufferSize(fe);a.fill(' '),a.write(JSON.stringify(s)),e||(e=framework.datetime.format('yyMMddHHmm')+'T'+framework_utils.GUID(5));var c=i.db.name+'#'+e,u=se.createWriteStream(framework_utils.join(i.directory,c+ue));return u.write(a,'binary'),n.pipe(u),CLEANUP(u),o&&o(null,e,s),i.$events.insert&&i.emit('insert',e,s),e},g.prototype.update=function(e,t,r,n){var o=framework_utils.getContentType(framework_utils.getExtension(t)),i='function'==typeof r;if(i||!r){i&&(n=r,r=void 0);var s=se.createReadStream(t);return CLEANUP(s),c.insert_stream(e,framework_utils.getName(t),o,s,n)}if('string'==typeof r&&(r=framework_utils.createBuffer(r,'base64')),r.resume)return this.insert_stream(e,t,o,r,n);var a,c=this,u=r.length,l=framework_utils.getExtension(t);switch(c.check(),l){case'gif':a=framework_image.measureGIF(r);break;case'png':a=framework_image.measurePNG(r);break;case'jpg':case'jpeg':a=framework_image.measureJPG(r);break;case'svg':a=framework_image.measureSVG(r)}a||(a={width:0,height:0});var p={name:t,size:u,type:o,width:a.width,height:a.height,created:F.datetime},f=framework_utils.createBufferSize(fe),d=c.db.name+'#'+e;f.fill(' '),f.write(JSON.stringify(p));var h=se.createWriteStream(framework_utils.join(c.directory,d+ue));return h.write(f,'binary'),h.end(r),CLEANUP(h),n&&n(null,e,p),c.$events.insert&&c.emit('insert',e,p),e},g.prototype.read=function(e,t){var r=this;r.check(),e.indexOf('#')===-1&&(e=r.db.name+'#'+e);var n=framework_utils.join(r.directory,e+ue),o=se.createReadStream(n,{start:0,end:fe-1,encoding:'binary'});return o.on('error',function(e){return t(e)}),o.on('data',function(e){var r=framework_utils.createBuffer(e,'binary').toString('utf8').replace(me,'');o=se.createReadStream(n,{start:fe}),t(null,o,JSON.parse(r,oe))}),r},g.prototype.remove=function(e,t){var r=this,n=e;r.check(),n.indexOf('#')===-1&&(n=r.db.name+'#'+n);var o=framework_utils.join(r.directory,n+ue);return se.unlink(o,function(e){return t&&t(null,!e)}),r.$events.remove&&r.emit('remove',e),
r},g.prototype.check=function(){var e=this;if(e.exists)return e;e.exists=!0;try{se.mkdirSync(e.directory)}catch(e){}return e},g.prototype.clear=function(e){var t=this;return se.readdir(t.directory,function(r,n){if(r)return e(r);for(var o=[],i=t.db.name+'#',s=i.length,a=framework_utils.join(t.directory),c=0,u=n.length;c<u;c++)n[c].substring(0,s)===i&&o.push(a+'/'+n[c]);t.$events.clear&&t.emit('clear',o.length),framework.unlink(o,e)}),t},g.prototype.all=function(e){var t=this;return t.check(),se.readdir(t.directory,function(r,n){if(r)return e(r,he);for(var o=[],i=t.db.name+'#',s=i.length,a=0,c=n.length;a<c;a++)n[a].substring(0,s)===i&&o.push(n[a]);var u=framework_utils.join(t.directory),l=[],p=ue.length;o.wait(function(e,t){var r=se.createReadStream(u+'/'+e,{start:0,end:fe-1,encoding:'binary'});r.on('data',function(t){var r=framework_utils.createBuffer(t,'binary').toString('utf8').replace(me,'').parseJSON(!0);r&&(r.id=e.substring(s,e.length-p),l.push(r))}),CLEANUP(r,t)},function(){return e(null,l)},2)}),t},v.prototype.write=function(e){return this.items.push(e),this.flush(),this},v.prototype.flush=function(){var e=this;if(e.is)return e;if(!e.items.length)return e;var t=e.items.join('');return e.is=!0,se.appendFile(e.filename,t,function(){e.is=!1,e.flush()}),e.items=[],e},e}({exports:{}});var Qs=require('querystring'),Os=require('os'),Fs=require('fs'),Zlib=require('zlib'),Path=require('path'),Crypto=require('crypto'),Parser=require('url'),Child=require('child_process'),Util=require('util'),http=require('http'),ENCODING='utf8',HEADER_CACHE='Cache-Control',HEADER_TYPE='Content-Type',HEADER_LENGTH='Content-Length',CT_TEXT='text/plain',CT_HTML='text/html',CT_JSON='application/json',COMPRESSION={'text/plain':!0,'text/javascript':!0,'text/css':!0,'text/jsx':!0,'application/x-javascript':!0,'application/json':!0,'text/xml':!0,'image/svg+xml':!0,'text/x-markdown':!0,'text/html':!0},REG_TEMPORARY=/\//g,REG_MOBILE=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|Tablet/i,REG_ROBOT=/search|agent|bot|crawler|spider/i,REG_VERSIONS=/(href|src)="[a-zA-Z0-9\/\:\-\.]+\.(jpg|js|css|png|gif|svg|html|ico|json|less|sass|scss|swf|txt|webp|woff|woff2|xls|xlsx|xml|xsl|xslt|zip|rar|csv|doc|docx|eps|gzip|jpe|jpeg|manifest|mov|mp3|flac|mp4|ogg|package|pdf)"/gi,REG_COMPILECSS=/url\(.*?\)/g,REG_ROUTESTATIC=/^(\/\/|https\:|http\:)+/,REG_RANGE=/bytes=/,REG_EMPTY=/\s/g,REG_ACCEPTCLEANER=/\s|\./g,REG_SANITIZE_BACKSLASH=/\/\//g,REG_WEBSOCKET_ERROR=/ECONNRESET|EHOSTUNREACH|EPIPE|is closed/i,REG_WINDOWSPATH=/\\/g,REG_SCRIPTCONTENT=/\<|\>|;/,REG_HTTPHTTPS=/^(\/)?(http|https)\:\/\//i,REG_NOCOMPRESS=/[\.|-]+min\.(css|js)$/i,REG_TEXTAPPLICATION=/text|application/,REG_ENCODINGCLEANER=/[\;\s]charset=utf\-8/g,FLAGS_PROXY=['post','json'],FLAGS_INSTALL=['get'],FLAGS_DOWNLOAD=['get','dnscache'],QUERYPARSEROPTIONS={maxKeys:69},EMPTYARRAY=[],EMPTYOBJECT={},EMPTYREQUEST={uri:{}},SINGLETONS={},REPOSITORY_HEAD='$head',REPOSITORY_META_TITLE='$title',REPOSITORY_META_DESCRIPTION='$description',REPOSITORY_META_KEYWORDS='$keywords',REPOSITORY_META_AUTHOR='$author',REPOSITORY_META_IMAGE='$image',REPOSITORY_PLACE='$place',REPOSITORY_SITEMAP='$sitemap',ATTR_END='"',ETAG='858',CONCAT=[null,null];Object.freeze(EMPTYOBJECT),Object.freeze(EMPTYARRAY),Object.freeze(EMPTYREQUEST),global.EMPTYOBJECT=EMPTYOBJECT,global.EMPTYARRAY=EMPTYARRAY;var RANGE={start:0,end:0},HEADERS={},SUCCESSHELPER={success:!0};HEADERS.responseCode={},HEADERS.responseCode[HEADER_TYPE]=CT_TEXT,HEADERS.responseCode['X-Powered-By']='Total.js',HEADERS.redirect={},HEADERS.redirect[HEADER_TYPE]=CT_HTML+'; charset=utf-8',HEADERS.redirect[HEADER_LENGTH]='0',HEADERS.sse={},HEADERS.sse[HEADER_CACHE]='no-cache, no-store, must-revalidate',HEADERS.sse.Pragma='no-cache',HEADERS.sse.Expires='0',HEADERS.sse[HEADER_TYPE]='text/event-stream',HEADERS.sse['X-Powered-By']='Total.js',HEADERS.mmr={},HEADERS.mmr[HEADER_CACHE]='no-cache, no-store, must-revalidate',HEADERS.mmr.Pragma='no-cache',HEADERS.mmr.Expires='0',HEADERS.mmr['X-Powered-By']='Total.js',HEADERS.proxy={},HEADERS.proxy['X-Proxy']='total.js',HEADERS.file_lastmodified={},HEADERS.file_lastmodified['Access-Control-Allow-Origin']='*',HEADERS.file_lastmodified[HEADER_CACHE]='public, max-age=11111111',HEADERS.file_lastmodified['X-Powered-By']='Total.js',HEADERS.file_release_compress={},HEADERS.file_release_compress[HEADER_CACHE]='public, max-age=11111111',HEADERS.file_release_compress.Vary='Accept-Encoding',HEADERS.file_release_compress['Access-Control-Allow-Origin']='*',HEADERS.file_release_compress['Last-Modified']='Mon, 01 Jan 2001 08:00:00 GMT',HEADERS.file_release_compress['Content-Encoding']='gzip',HEADERS.file_release_compress['X-Powered-By']='Total.js',HEADERS.file_release_compress_range={},HEADERS.file_release_compress_range['Accept-Ranges']='bytes',HEADERS.file_release_compress_range[HEADER_CACHE]='public, max-age=11111111',HEADERS.file_release_compress_range.Vary='Accept-Encoding',HEADERS.file_release_compress_range['Access-Control-Allow-Origin']='*',HEADERS.file_release_compress_range['Last-Modified']='Mon, 01 Jan 2001 08:00:00 GMT',HEADERS.file_release_compress_range['Content-Encoding']='gzip',HEADERS.file_release_compress_range[HEADER_LENGTH]='0',HEADERS.file_release_compress_range['Content-Range']='',HEADERS.file_release_compress_range['X-Powered-By']='Total.js',HEADERS.file_release={},HEADERS.file_release[HEADER_CACHE]='public, max-age=11111111',HEADERS.file_release.Vary='Accept-Encoding',HEADERS.file_release['Access-Control-Allow-Origin']='*',HEADERS.file_release['Last-Modified']='Mon, 01 Jan 2001 08:00:00 GMT',HEADERS.file_release['X-Powered-By']='Total.js',HEADERS.file_release_range={},HEADERS.file_release_range['Accept-Ranges']='bytes',HEADERS.file_release_range[HEADER_CACHE]='public, max-age=11111111',HEADERS.file_release_range.Vary='Accept-Encoding',HEADERS.file_release_range['Access-Control-Allow-Origin']='*',HEADERS.file_release_range['Last-Modified']='Mon, 01 Jan 2001 08:00:00 GMT',HEADERS.file_release_range[HEADER_LENGTH]='0',HEADERS.file_release_range['Content-Range']='',HEADERS.file_release_range['X-Powered-By']='Total.js',HEADERS.file_debug_compress={},HEADERS.file_debug_compress[HEADER_CACHE]='private, no-cache, no-store, must-revalidate',HEADERS.file_debug_compress.Vary='Accept-Encoding',HEADERS.file_debug_compress['Access-Control-Allow-Origin']='*',HEADERS.file_debug_compress.Pragma='no-cache',HEADERS.file_debug_compress.Expires='0',HEADERS.file_debug_compress['Content-Encoding']='gzip',HEADERS.file_debug_compress['X-Powered-By']='Total.js',HEADERS.file_debug_compress_range={},HEADERS.file_debug_compress_range['Accept-Ranges']='bytes',HEADERS.file_debug_compress_range[HEADER_CACHE]='private, no-cache, no-store, must-revalidate',HEADERS.file_debug_compress_range.Vary='Accept-Encoding',HEADERS.file_debug_compress_range['Access-Control-Allow-Origin']='*',HEADERS.file_debug_compress_range['Content-Encoding']='gzip',HEADERS.file_debug_compress_range.Pragma='no-cache',HEADERS.file_debug_compress_range.Expires='0',HEADERS.file_debug_compress_range[HEADER_LENGTH]='0',HEADERS.file_debug_compress_range['Content-Range']='',HEADERS.file_debug_compress_range['X-Powered-By']='Total.js',HEADERS.file_debug={},HEADERS.file_debug[HEADER_CACHE]='private, no-cache, no-store, must-revalidate',HEADERS.file_debug.Vary='Accept-Encoding',HEADERS.file_debug.Pragma='no-cache',HEADERS.file_debug.Expires='0',HEADERS.file_debug['Access-Control-Allow-Origin']='*',HEADERS.file_debug['X-Powered-By']='Total.js',HEADERS.file_debug_range={},HEADERS.file_debug_range['Accept-Ranges']='bytes',HEADERS.file_debug_range[HEADER_CACHE]='private, no-cache, no-store, must-revalidate',HEADERS.file_debug_range.Vary='Accept-Encoding',HEADERS.file_debug_range['Access-Control-Allow-Origin']='*',HEADERS.file_debug_range.Pragma='no-cache',HEADERS.file_debug_range.Expires='0',HEADERS.file_debug_range[HEADER_LENGTH]='0',HEADERS.file_debug_range['Content-Range']='',HEADERS.file_debug_range['X-Powered-By']='Total.js',HEADERS.content_mobile_release={},HEADERS.content_mobile_release.Vary='Accept-Encoding, User-Agent',HEADERS.content_mobile_release['Content-Encoding']='gzip',HEADERS.content_mobile={},HEADERS.content_mobile.Vary='Accept-Encoding, User-Agent',HEADERS.content_mobile['X-Powered-By']='Total.js',HEADERS.content_compress={},HEADERS.content_compress[HEADER_CACHE]='private',HEADERS.content_compress.Vary='Accept-Encoding',HEADERS.content_compress['Content-Encoding']='gzip',HEADERS.content_compress['X-Powered-By']='Total.js',HEADERS.content={},HEADERS.content.Vary='Accept-Encoding',HEADERS.content['X-Powered-By']='Total.js',HEADERS.stream_release_compress={},HEADERS.stream_release_compress[HEADER_CACHE]='public, max-age=11111111',HEADERS.stream_release_compress['Access-Control-Allow-Origin']='*',HEADERS.stream_release_compress['Content-Encoding']='gzip',HEADERS.stream_release_compress['X-Powered-By']='Total.js',HEADERS.stream_release={},HEADERS.stream_release[HEADER_CACHE]='public, max-age=11111111',HEADERS.stream_release['Access-Control-Allow-Origin']='*',HEADERS.stream_release['X-Powered-By']='Total.js',HEADERS.stream_debug_compress={},HEADERS.stream_debug_compress[HEADER_CACHE]='private, no-cache, no-store, must-revalidate',HEADERS.stream_debug_compress.Pragma='no-cache',HEADERS.stream_debug_compress.Expires='0',HEADERS.stream_debug_compress['Access-Control-Allow-Origin']='*',HEADERS.stream_debug_compress['Content-Encoding']='gzip',HEADERS.stream_debug_compress['X-Powered-By']='Total.js',HEADERS.stream_debug={},HEADERS.stream_debug[HEADER_CACHE]='private, no-cache, no-store, must-revalidate',HEADERS.stream_debug.Pragma='no-cache',HEADERS.stream_debug.Expires='0',HEADERS.stream_debug['Access-Control-Allow-Origin']='*',HEADERS.stream_debug['X-Powered-By']='Total.js',HEADERS.binary_compress={},HEADERS.binary_compress[HEADER_CACHE]='public',HEADERS.binary_compress['Content-Encoding']='gzip',HEADERS.binary_compress['X-Powered-By']='Total.js',HEADERS.binary={},HEADERS.binary[HEADER_CACHE]='public',HEADERS.binary['X-Powered-By']='Total.js',HEADERS.authorization={user:'',password:'',empty:!0},HEADERS.fsStreamRead={flags:'r',mode:'0666',autoClose:!0},HEADERS.fsStreamReadRange={flags:'r',mode:'0666',autoClose:!0,start:0,end:0},HEADERS.workers={cwd:''},HEADERS.mmrpipe={end:!1},HEADERS.responseLocalize={},HEADERS.responseNotModified={},HEADERS.responseNotModified[HEADER_CACHE]='public, max-age=11111111',HEADERS.responseNotModified['X-Powered-By']='Total.js',HEADERS.response503={},HEADERS.response503[HEADER_CACHE]='private, no-cache, no-store, must-revalidate',HEADERS.response503[HEADER_TYPE]=CT_HTML,HEADERS.response503['X-Powered-By']='Total.js',HEADERS.notModifiedEtag={},HEADERS.notModifiedEtag['X-Powered-By']='Total.js',HEADERS.notModifiedLastModifiedDate={},HEADERS.notModifiedLastModifiedDate['X-Powered-By']='Total.js',Object.freeze(HEADERS.authorization);var IMAGEMAGICK=!1,_controller='',_owner='',_test,_flags;!global.framework_internal&&(global.framework_internal=require('./internal')),!global.framework_builders&&(global.framework_builders=require('./builders')),!global.framework_utils&&(global.framework_utils=require('./utils')),!global.framework_mail&&(global.framework_mail=require('./mail')),!global.framework_image&&(global.framework_image=require('./image')),!global.framework_nosql&&(global.framework_nosql=require('./nosql')),global.Builders=framework_builders;var U=global.Utils=global.utils=global.U=global.framework_utils;global.Mail=framework_mail,global.WTF=function(e,t,r){return F.problem(e,t,r)},global.INCLUDE=global.SOURCE=function(e,t){return F.source(e,t)},global.MODULE=function(e){return F.module(e)},global.NOSQL=function(e){return F.nosql(e)},global.NOBIN=function(e){return F.nosql(e).binary},global.NOCOUNTER=function(e){return F.nosql(e).counter},global.NOMEM=global.NOSQLMEMORY=function(e,t){return global.framework_nosql.inmemory(e,t)},global.CONFIG=function(e){return F.config[e]},global.UPTODATE=function(e,t,r,n,o){return F.uptodate(e,t,r,n,o)},global.INSTALL=function(e,t,r,n,o){return F.install(e,t,r,n,o)},global.UNINSTALL=function(e,t,r){return F.uninstall(e,t,r)},global.RESOURCE=function(e,t){return F.resource(e,t)},global.TRANSLATE=function(e,t){return F.translate(e,t)},global.TRANSLATOR=function(e,t){return F.translator(e,t)},global.TRACE=function(e,t,r,n){return F.trace(e,t,r,n)},global.MODEL=function(e){return F.model(e)},global.$$$=global.GETSCHEMA=function(e,t,r,n){return framework_builders.getschema(e,t,r,n)},global.CREATE=function(e,t){return framework_builders.getschema(e,t).default()},global.SCRIPT=function(e,t,r,n){return F.script(e,t,r,n)},global.SINGLETON=function(e,t){return SINGLETONS[e]||(SINGLETONS[e]=new Function('return '+(t||'{}'))())},global.EACHSCHEMA=function(e,t){return framework_builders.eachschema(e,t)},global.FUNCTION=function(e){return F.functions[e]},global.ROUTING=function(e){return F.routing(e)},global.SCHEDULE=function(e,t,r,n){return F.schedule(e,t,r,n)},global.FINISHED=function(e,t){return framework_internal.onFinished(e,t)},global.DESTROY=function(e){return framework_internal.destroyStream(e)},global.UID=function(){return UIDGENERATOR.date+(++UIDGENERATOR.index).padLeft(4,'0')+UIDGENERATOR.instance+(UIDGENERATOR.index%2?1:0)},global.$CREATE=function(e){e=parseSchema(e);var t=framework_builders.getschema(e[0],e[1]);return t?t.default():null},global.$MAKE=function(e,t,r,n,o,i){e=parseSchema(e);var s=framework_builders.getschema(e[0],e[1]);return s?s.make(t,r,n,i,o):void 0},global.$QUERY=function(e,t,r,n){e=parseSchema(e);var o=framework_builders.getschema(e[0],e[1]);return o&&o.query(t,r,n),!!o},global.$GET=function(e,t,r,n){e=parseSchema(e);var o=framework_builders.getschema(e[0],e[1]);return o&&o.get(t,r,n),!!o},global.$WORKFLOW=function(e,t,r,n,o){e=parseSchema(e);var i=framework_builders.getschema(e[0],e[1]);return i&&i.workflow2(t,r,n,o),!!i},global.$TRANSFORM=function(e,t,r,n,o){e=parseSchema(e);var i=framework_builders.getschema(e[0],e[1]);return i&&i.transform2(t,r,n,o),!!i},global.$OPERATION=function(e,t,r,n,o){e=parseSchema(e);var i=framework_builders.getschema(e[0],e[1]);return i&&i.operation2(t,r,n,o),!!i},global.DB=global.DATABASE=function(){return'object'===_typeof(F.database)?F.database:F.database.apply(framework,arguments)},global.ON=function(){return F.on.apply(F,arguments)},global.OFF=function(){return arguments.length>1?F.removeListener.apply(F,arguments):F.removeAllListeners.apply(F,arguments)},global.EMIT=function(){return F.emit.apply(F,arguments)},global.LOG=function(){return F.log.apply(F,arguments)},global.LOGGER=function(){return F.logger.apply(F,arguments)},global.MAKE=global.TRANSFORM=function(e,t){if('function'==typeof e){var r=t;t=e,e=r}var n;return'function'==typeof t?(n={},t.call(n,n)):n=t,e?TransformBuilder.transform.apply(n,arguments):n},global.NEWTRANSFORM=function(){return TransformBuilder.addTransform.apply(this,arguments)},global.NEWSCHEMA=function(e,t){return t||(t=e,e='default'),framework_builders.newschema(e,t)},global.CLEANUP=function(e,t){var r=function(){FINISHED(e,function(){DESTROY(e),t&&(t(),t=null)})};e.on('error',r),e.readable?e.on('end',r):e.on('finish',r)},global.SUCCESS=function(e,t){if('function'==typeof e)return function(t,r){e(t,SUCCESS(t,r))};var r;return e instanceof Error?(r=e,e=!1):e instanceof framework_builders.ErrorBuilder?e.hasError()?(r=e.output(),e=!1):e=!0:null==e&&(e=!0),SUCCESSHELPER.success=!!e,SUCCESSHELPER.value=null==t?void 0:t,SUCCESSHELPER.error=r?r:void 0,SUCCESSHELPER},global.TRY=function(e,t){try{return e(),!0}catch(e){return t&&t(e),!1}},global.OBSOLETE=function(e,t){console.log(F.datetime.format('yyyy-MM-dd HH:mm:ss')+' :: OBSOLETE / IMPORTANT ---> "'+e+'"',t),global.F&&F.stats.other.obsolete++},global.DEBUG=!1,global.TEST=!1,global.RELEASE=!1,global.is_client=!1,global.is_server=!0;var directory=U.$normalize(require.main?Path.dirname(require.main.filename):process.cwd()),DATE_EXPIRES=(new Date).add('y',1).toUTCString(),WEBSOCKET_COMPRESS=U.createBuffer([0,0,255,255]),UIDGENERATOR={date:(new Date).format('yyMMddHHmm'),instance:'abcdefghijklmnoprstuwxy'.split('').random().join('').substring(0,3),index:1},EMPTYBUFFER=U.createBufferSize(0);global.EMPTYBUFFER=EMPTYBUFFER;var controller_error_status=function(e,t,r){return 500!==t&&r&&e.problem(r),e.res.success||e.res.headersSent||!e.isConnected?e:(e.precache&&e.precache(null,null,null),e.req.path=EMPTYARRAY,e.subscribe.success(),e.subscribe.route=F.lookup(e.req,'#'+t,EMPTYARRAY,0),e.subscribe.exception=r,e.subscribe.execute(t,!0),e)};Framework.prototype={get onLocate(){return this.onLocale},set onLocate(e){OBSOLETE('F.onLocate','Rename "F.onLocate" method for "F.onLocale".'),this.onLocale=e}};var framework=new Framework;global.framework=global.F=module.exports=framework,F.on=function(e,t){if('init'===e||'ready'===e||'load'===e){if(this.isLoaded)return void t.call(this)}else if(e.indexOf('#')!==-1){var r=e.split('#');switch(r[0]){case'middleware':F.temporary.ready[e]&&t.call(this);break;case'component':F.temporary.ready[e]&&t.call(this);break;case'model':F.temporary.ready[e]&&t.call(this,F.models[r[1]]);break;case'source':F.temporary.ready[e]&&t.call(this,F.sources[r[1]]);break;case'package':case'module':F.temporary.ready[e]&&t.call(this,F.modules[r[1]]);break;case'controller':F.temporary.ready[e]&&t.call(this,F.controllers[r[1]])}}return F.$events[e]?F.$events[e].push(t):F.$events[e]=[t],this},F.emit=function(e,t,r,n,o,i,s,a){var c=F.$events[e];if(c){for(var u=!1,l=0,p=c.length;l<p;l++)c[l].$once&&(u=!0),c[l].call(F,t,r,n,o,i,s,a);u&&(c=c.remove(function(e){return e.$once}),c.length?F.$events[e]=c:F.$events[e]=void 0)}return F},F.once=function(e,t){return t.$once=!0,F.on(e,t)},F.removeListener=function(e,t){var r=F.$events[e];return r&&(r=r.remove(function(e){return e===t}),r.length?F.$events[e]=r:F.$events[e]=void 0),F},F.removeAllListeners=function(e){return e?F.$events[e]=void 0:F.$events={},F},F.$owner=function(){return _owner},F.isSuccess=function(e){return e===SUCCESSHELPER},F.convert=function(e,t){if(t){if(F.convertors.findIndex('name',e)!==-1)return!1;if(t===Number)t=U.parseFloat;else if(t===Boolean)t=U.parseBoolean;else if('string'==typeof t)switch(t.toLowerCase()){case'json':t=U.parseJSON;break;case'float':case'number':case'double':t=U.parseFloat;break;case'int':case'integer':t=U.parseInt2;break;default:return console.log('F.convert unknown convertor type:',t)}return F.convertors.push({name:e,convertor:t}),F._length_convertors=F.convertors.length,!0}for(var r=0,n=F.convertors.length;r<n;r++)e[F.convertors[r].name]&&(e[F.convertors[r].name]=F.convertors[r].convertor(e[F.convertors[r].name]));return e},F.controller=function(e){return F.controllers[e]||null},F.useConfig=function(e){return F.$configure_configs(e,!0)},F.useSMTP=function(e,t,r){return'function'==typeof t&&(r=t,t=void 0),Mail.try(e,t,function(n){n||(delete F.temporary['mail-settings'],F.config['mail-smtp']=e,F.config['mail-smtp-options']=t),r?r(n):n&&F.error(n,'F.useSMTP()',null)}),F},F.$routesSort=function(e){F.routes.web.sort(function(e,t){return e.priority>t.priority?-1:e.priority<t.priority?1:0}),F.routes.websockets.sort(function(e,t){return e.priority>t.priority?-1:e.priority<t.priority?1:0});for(var t,r={},n=F.routes.web.length,o=0;o<n;o++){var i=F.routes.web[o],s=F.temporary.internal[i.controller];s&&(i.controller=s),!i.isMOBILE||i.isUPLOAD||i.isXHR||i.isJSON||i.isSYSTEM||i.isXML||i.flags.indexOf('get')===-1||(t=i.url.join('/'),r[t]=!0)}for(var o=0;o<n;o++){var i=F.routes.web[o];i.isMOBILE||i.isUPLOAD||i.isXHR||i.isJSON||i.isSYSTEM||i.isXML||i.flags.indexOf('get')===-1||(t=i.url.join('/'),i.isMOBILE_VARY=r[t]===!0)}return(!e||1===e)&&F.routes.web.forEach(function(e){var t=F.routes.web.findItem(function(t){return t.hash===e.hash&&t!==e});e.isUNIQUE=null==t}),Object.keys(F.temporary.other).forEach(function(e){'#'===e[0]&&(F.temporary.other[e]=void 0)}),F},F.parseComponent=parseComponent,F.script=function(e,t,r,n){var o,i,s=void 0===t&&void 0===r;try{o=new Function('next','value','now','var model=value;var global,require,process,GLOBAL,root,clearImmediate,clearInterval,clearTimeout,setImmediate,setInterval,setTimeout,console,$STRING,$VIEWCACHE,framework_internal,TransformBuilder,Pagination,Page,URLBuilder,UrlBuilder,SchemaBuilder,framework_builders,framework_utils,framework_mail,Image,framework_image,framework_nosql,Builders,U,utils,Utils,Mail,WTF,SOURCE,INCLUDE,MODULE,NOSQL,NOBIN,NOCOUNTER,NOSQLMEMORY,NOMEM,DATABASE,DB,CONFIG,INSTALL,UNINSTALL,RESOURCE,TRANSLATOR,LOG,LOGGER,MODEL,GETSCHEMA,CREATE,UID,TRANSFORM,MAKE,SINGLETON,NEWTRANSFORM,NEWSCHEMA,EACHSCHEMA,FUNCTION,ROUTING,SCHEDULE,OBSOLETE,DEBUG,TEST,RELEASE,is_client,is_server,F,framework,Controller,setTimeout2,clearTimeout2,String,Number,Boolean,Object,Function,Date,isomorphic,I,eval;UPTODATE,NEWOPERATION,OPERATION,$$$,EMIT,ON,$QUERY,$GET,$WORKFLOW,$TRANSFORM,$OPERATION,$MAKE,$CREATE;try{'+e+'}catch(e){next(e)}')}catch(e){i=e}return i?(r&&r(i),s?null:F):s?function(){return function(e,t,r){return o.call(EMPTYOBJECT,function(e){e instanceof Error?t(e,void 0,r):t(null,e,r)},e,scriptNow)}}():(o.call(EMPTYOBJECT,function(e){r&&(e instanceof Error?r(e):r(null,e))},t,scriptNow,n),F)},F.database=function(e){return F.nosql(e)},F.nosql=function(e){var t=F.databases[e];return t?t:(F.path.verify('databases'),t=framework_nosql.load(e,F.path.databases(e)),F.databases[e]=t,t)},F.stop=F.kill=function(e){for(var t in F.workers){var r=F.workers[t];TRY(function(){return r&&r.kill&&r.kill(e||'SIGTERM')})}return F.emit('exit',e),F.isWorker||'function'!=typeof process.send||TRY(function(){return process.send('stop')}),F.cache.stop(),F.server&&F.server.close(),setTimeout(function(){return process.exit(e||'SIGTERM')},TEST?2e3:100),F},F.redirect=function(e,t,r,n){var o=e.startsWith('http://')||e.startsWith('https');if(o)return'/'===e[e.length-1]&&(e=e.substring(0,e.length-1)),'/'===t[t.length-1]&&(t=t.substring(0,t.length-1)),F.routes.redirects[e]={url:t,path:r,permanent:n},F._request_check_redirect=!0,F.owners.push({type:'redirects',owner:_owner,id:e}),F;'/'!==e[0]&&(e='/'+e);var i;return r instanceof Array?(i=r,r=n===!0):n instanceof Array?(i=n,r=r===!0):r=r===!0,n=r,U.isStaticFile(e)?(F.file(e,function(e,r){t.startsWith('http://')||t.startsWith('https://')?r.redirect(t,n):r.redirect('/'!==t[0]?'/'+t:t,n)}),F):(F.route(e,function(){return t.startsWith('http://')||t.startsWith('https://')?void this.redirect(t+this.href(),n):('/'!==t[0]&&(t='/'+t),void this.redirect(t+this.href(),n))},i),F)},F.schedule=function(e,t,r){void 0===r&&(r=t,t=!1);var n='undefined'==typeof e?'undefined':_typeof(e);'string'===n?(e=e.parseDate(),t&&e<F.datetime&&(e=F.datetime.add(t))):'number'===n&&(e=new Date(e));var o=e.getTime();t&&(t=t.replace('each','1'));var i=U.GUID(5);return F.schedules.push({expire:o,fn:r,repeat:t,owner:_owner,id:i}),i},F.clearSchedule=function(e){return F.schedules.remove('id',e),F},F.resize=function(e,t,r){var n={},o=!0;if('function'==typeof r){var i=r;r=t,t=i}var s=e.match(/\*.\*$|\*?\.(jpg|png|gif|jpeg)$/gi);if(s)switch(e=e.replace(s,''),s.toString().toLowerCase()){case'*.*':n['*']=!0;break;case'*.jpg':case'*.gif':case'*.png':case'*.jpeg':n[s.toString().toLowerCase().replace(/\*/g,'').substring(1)]=!0}var a=e;if(r&&r.length)for(var c=0,u=r.length;c<u;c++){var l=r[c];'.'===l[0]?n[l.substring(1)]=!0:'~'===l[0]||'/'===l[0]||l.match(/^http\:|https\:/gi)?a=l:'nocache'===l&&(o=!1)}return n.length||(n.jpg=!0,n.jpeg=!0,n.png=!0,n.gif=!0),n.jpg&&!n.jpeg?n.jpeg=!0:n.jpeg&&!n.jpg&&(n.jpg=!0),F.routes.resize[e]={fn:t,path:U.path(a||e),ishttp:!!a.match(/http\:|https\:/gi),extension:n,cache:o},F.owners.push({type:'resize',owner:_owner,id:e}),F},F.restful=function(e,t,r,n,o,i){var s;r&&(s=[],t&&s.push.apply(s,t),F.route(e,s,r));var a=U.path(e)+'{id}';return n&&(s=[],t&&s.push.apply(s,t),F.route(a,s,n)),o&&(s=['post'],t&&s.push.apply(s,t),F.route(e,s,o),s=['put'],t&&s.push.apply(s,t),F.route(a,s,o)),i&&(s=['delete'],t&&s.push.apply(s,t),F.route(a,s,i)),F},F.restful2=function(e,t,r,n,o,i){var s;return r&&(s=[],t&&s.push.apply(s,t),F.route(e,s,r)),n&&(s=[],t&&s.push.apply(s,t),F.route(U.path(e)+'{id}',s,n)),o&&(s=['post'],t&&s.push.apply(s,t),F.route(e,s,o)),i&&(s=['delete'],t&&s.push.apply(s,t),F.route(e,s,i)),F},F.cors=function(e,t,r){var n,o={},i=[],s=[],a=[];if(t instanceof Array)for(var c=0,u=t.length;c<u;c++){var l=t[c],p='undefined'==typeof l?'undefined':_typeof(l);if('string'===p)l=l.toLowerCase();else if('number'===p){n=l;continue}if('boolean'===p||l.startsWith('credential'))r=!0;else if(l.startsWith('http://')||l.startsWith('https://'))i.push(l);else switch(l){case'post':case'put':case'delete':case'options':case'patch':case'head':case'get':s.push(l.toUpperCase());break;default:a.push(t[c])}}return o.isASTERIX=e.lastIndexOf('*')!==-1,o.isASTERIX&&(e=e.replace('*','')),e=framework_internal.preparePath(framework_internal.encodeUnicodeURL(e.trim())),o.hash=e.hash(),o.owner=_owner,o.url=framework_internal.routeSplitCreate(e),o.origins=i.length?i:null,o.methods=s.length?s:null,o.headers=a.length?a:null,o.credentials=r,o.age=n||F.config['default-cors-maxage'],F.routes.cors.push(o),F._length_cors=F.routes.cors.length,F.routes.cors.sort(function(e,t){var r=e.url.length,n=t.url.length;return r>n?-1:r<n?1:e.isASTERIX&&t.isASTERIX?1:0}),F},F.group=function(e,t){return _flags=e,t.call(this),_flags=void 0,this},F.web=F.route=function(e,t,r,n,o){var i,s,a,c;if(e instanceof Array)return e.forEach(function(e){return F.route(e,t,r,n)}),F;var u='function'==typeof e?e:null;if(u&&(e='/'),'#'===e[0])if(e=e.substring(1),'400'!==e&&'401'!==e&&'403'!==e&&'404'!==e&&'408'!==e&&'431'!==e&&'500'!==e&&'501'!==e){var l=t instanceof Array?t:r;if(l instanceof Array||(l=EMPTYARRAY),c=F.sitemap(e,!0,o),!c)throw new Error('Sitemap item "'+e+'" not found.');if(i=e,e=c.url,c.wildcard&&(e+='*'),c.localizeUrl&&void 0===o){var p={};F.temporary.internal.resources.forEach(function(t){var r=F.sitemap(c.id,!0,t);r.url&&r.url!==e&&(p[r.url]={name:c.id,language:t})}),Object.keys(p).forEach(function(e){return F.route('#'+c.id,t,r,n,p[e].language)})}}else e='#'+e;e||(e='/'),'['!==e[0]&&'/'!==e[0]&&(e='/'+e),e.endsWith('/')&&(e=e.substring(0,e.length-1)),e=framework_internal.encodeUnicodeURL(e);var f='undefined'==typeof t?'undefined':_typeof(t),d=0,h=e;i||(i=e),('object'===f||t instanceof Array)&&(s=t,t=r,r=s);var m=0,g=null;m=e.count('/'),'['===e[0]&&(d=e.indexOf(']'),d>0&&(g=e.substring(1,d).trim().toLowerCase().split(','),e=e.substring(d+1),m+=g.indexOf('*')!==-1?50:100));var v=e.indexOf('*')!==-1;v&&(e=e.replace('*','').replace('//','/'),m-=100);var y,b,E,w,_,k=!1,$=!1,S='',O=!1,x=!1,T=!1,R=!1,A=!1,C=!1,N=!1,D=!1,P=null,j=[],I=0,M=!1,L=null;if(_flags&&(r||(r=[]),_flags.forEach(function(e){r.indexOf(e)===-1&&r.push(e)})),r){s=[];for(var H=0,q=0;q<r.length;q++){var B=_typeof(r[q]);if('number'!==B)if('object'!==B){var G=r[q][0];if('&'!==G)if('id:'!==r[q].substring(0,3))if('#'!==G)if('*'!==G)if('// '!==r[q].substring(0,3)){var Y=r[q].toString().toLowerCase();if(Y.startsWith('http://')||Y.startsWith('https://'))j.push(Y);else switch(H++,Y){case'json':x=!0;continue;case'delay':H--,T=!0;continue;case'binary':A=!0;continue;case'cors':C=!0,H--;continue;case'credential':case'credentials':j.push(Y),H--;continue;case'sync':case'yield':case'synchronize':M=!0,H--;continue;case'novalidate':D=!0;break;case'noxhr':case'-xhr':$=!0;continue;case'raw':k=!0,s.push(Y);break;case'mobile':O=!0;break;case'robot':R=!0,F._request_check_robot=!0;break;case'authorize':case'authorized':case'logged':I=1,m+=2,s.push('authorize');break;case'unauthorize':case'unauthorized':case'unlogged':I=2,m+=2,s.push('unauthorize');break;case'referer':case'referrer':s.push('referer');break;case'delete':case'get':case'head':case'options':case'patch':case'post':case'propfind':case'put':case'trace':s.push(Y),S+=(S?',':'')+Y,j.push(Y);break;default:'@'===Y[0]&&(N=!0),s.push(Y)}}else _=r[q].substring(3).trim();else b=r[q].trim().substring(1),d=b.indexOf('-->'),d!==-1?(y=b.substring(0,d).trim(),b=b.substring(d+3).trim()):(y=b,b=null),y=y.replace(/\\/g,'/').split('/'),1===y.length&&(y[1]=y[0],y[0]='default'),d=y[1].indexOf('#'),d!==-1&&(y[2]=y[1].substring(d+1).trim(),y[1]=y[1].substring(0,d).trim());else!P&&(P=[]),P.push(r[q].substring(1));else L=r[q].substring(3).trim()}else w=r[q];else E=r[q]}r=s,m+=2*H}else r=['get'],S='get';'string'===f?(a=t,t=function(e,t,r){r&&!this.language&&(this.language=r);var n=U.parseTheme(e);return n&&(e=prepare_viewname(e)),function(){if(t&&this.sitemap(t.id,r),'~'===e[0]?this.themeName='':n&&(this.themeName=n),!this.route.workflow)return this.view(e);var o=this;this.$exec(this.route.workflow,this,function(t,r){t?o.content(t):o.view(e,r)})}}(a,c,o)):'function'!=typeof t&&(a=(c&&'/'!==c.url?c.id:b?'':e)||'',b&&(a||b)?b&&(t=controller_json_workflow):(a.endsWith('/')&&(a=a.substring(0,a.length-1)),d=a.lastIndexOf('/'),d!==-1&&(a=a.substring(d+1)),a&&'/'!==a||(a='index'),t=function(e,t,r){return function(){if(r&&!this.language&&(this.language=r),t&&this.sitemap(t.id,r),'~'===e[0]&&this.theme(''),!this.route.workflow)return this.view(e);var n=this;this.$exec(this.route.workflow,this,function(t,r){t?n.content(t):n.view(e,r)})}}(a,c,o))),M||(M='GeneratorFunction'===t.constructor.name||0===t.toString().indexOf('function*'));var z=framework_internal.preparePath(e.trim()),W=U.path(z)+(v?'*':''),J=z.hash(),V=framework_internal.routeSplitCreate(z),X=[],K=null,Q=null;e.indexOf('{')!==-1&&(V.forEach(function(e,t){if('{'===e.substring(0,1)){X.push(t);var r=e.substring(1,e.length-1);if('/'===r[0]){var n=r.lastIndexOf('/');n!==-1&&(K||(K={},Q=[]),K[t]=new RegExp(r.substring(1,n),r.substring(n+1)),Q.push(t))}}}),m-=X.length),e.indexOf('#')!==-1&&(m-=100),r.indexOf('proxy')!==-1&&(x=!0,m++),(x||r.indexOf('xml')!==-1||k)&&r.indexOf('delete')===-1&&r.indexOf('post')===-1&&r.indexOf('put')===-1&&r.indexOf('patch')===-1&&(r.push('post'),S+=(S?',':'')+'post',m++),r.indexOf('upload')!==-1&&r.indexOf('post')===-1&&r.indexOf('put')===-1&&(r.push('post'),S+=(S?',':'')+'post'),r.indexOf('get')===-1&&r.indexOf('options')===-1&&r.indexOf('post')===-1&&r.indexOf('delete')===-1&&r.indexOf('put')===-1&&r.indexOf('upload')===-1&&r.indexOf('head')===-1&&r.indexOf('trace')===-1&&r.indexOf('patch')===-1&&r.indexOf('propfind')===-1&&(r.push('get'),S+=(S?',':'')+'get'),F.config['allow-head']&&r.indexOf('get')!==-1&&(r.append('head'),S+=(S?',':'')+'head'),r.indexOf('referer')!==-1&&(F._request_check_referer=!0),F._request_check_POST||r.indexOf('delete')===-1&&r.indexOf('post')===-1&&r.indexOf('put')===-1&&r.indexOf('upload')===-1&&r.indexOf('json')===-1&&r.indexOf('patch')===-1&&r.indexOf('options')===-1||(F._request_check_POST=!0);var Z=!1;S.indexOf(',')!==-1&&(Z=!0),S=S.indexOf(',')!==-1||''===S?void 0:S.toUpperCase(),'#'===i[1]&&(i=i.substring(1)),A&&!k&&(A=!1,console.warn('F.route() skips "binary" flag because the "raw" flag is not defined.')),g&&F._length_subdomain_web++;var ee=new FrameworkRoute,te=ee.route;return te.hash=J,te.id=L,te.name=i,te.priority=m,te.sitemap=c?c.id:'',te.schema=y,te.novalidate=D,te.workflow=b,te.subdomain=g,te.description=_,te.controller=_controller?_controller:'unknown',te.owner=_owner,te.urlraw=W,te.url=V,te.param=X,te.flags=r||EMPTYARRAY,te.flags2=flags_to_object(r),te.method=S,te.execute=t,te.length=1024*(n||F.config['default-request-length']),te.middleware=P,te.timeout=void 0===E?T?0:F.config['default-request-timeout']:E,te.isGET=r.indexOf('get')!==-1,te.isMULTIPLE=Z,te.isJSON=x,te.isXML=r.indexOf('xml')!==-1,te.isRAW=k,te.isBINARY=A,te.isMOBILE=O,te.isROBOT=R,te.isMOBILE_VARY=O,te.isGENERATOR=M,te.MEMBER=I,te.isASTERIX=v,te.isROLE=N,te.isREFERER=r.indexOf('referer')!==-1,te.isHTTPS=r.indexOf('https')!==-1,te.isHTTP=r.indexOf('http')!==-1,te.isDEBUG=r.indexOf('debug')!==-1,te.isRELEASE=r.indexOf('release')!==-1,te.isPROXY=r.indexOf('proxy')!==-1,te.isBOTH=!$,te.isXHR=r.indexOf('xhr')!==-1,te.isUPLOAD=r.indexOf('upload')!==-1,te.isSYSTEM=e.startsWith('/#'),
te.isCACHE=!(e.startsWith('/#')||u||X.length||v),te.isPARAM=X.length>0,te.isDELAY=T,te.CUSTOM=u,te.options=w,te.regexp=K,te.regexpIndexer=Q,te.type='web',F.routes.web.push(te),F.emit('route','web',ee),C&&F.cors(h,j),!_controller&&F.$routesSort(1),ee},F.mmr=function(e,t){return e=framework_internal.preparePath(U.path(e)),F.routes.mmr[e]={exec:t},F._request_check_POST=!0,F},F.routing=function(e){for(var t=0,r=F.routes.web.length;t<r;t++){var n=F.routes.web[t];if(n.name===e){var o=U.path(n.url.join('/'));return'/'!==o[0]&&(o='/'+o),{controller:n.controller,url:o,id:n.id,flags:n.flags,middleware:n.middleware,execute:n.execute,timeout:n.timeout,options:n.options,length:n.length}}}},F.merge=function(e){for(var t=[],r=1,n=arguments.length;r<n;r++){var o=arguments[r];o instanceof Array||(o=[o]);for(var i=0,s=o.length;i<s;i++){var a=o[i],c=a[0];'@'===c?a='~'+F.path.package(a.substring(1)):'='===c?a='~'+F.path.themes(a.substring(1)):'#'===c&&(a='~'+F.path.temp('isomorphic_'+a.substring(1)+'.min.js')),t.push(a)}}e=framework_internal.preparePath(F.$version(e)),'/'!==e[0]&&(e='/'+e);var u=F.path.temp((F.id?'i-'+F.id+'_':'')+'merged_'+createTemporaryKey(e));return F.routes.merge[e]={filename:u.replace(/\.(js|css)/g,function(e){return'.min'+e}),files:t},Fs.unlink(F.routes.merge[e].filename,NOOP),F.owners.push({type:'merge',owner:_owner,id:e}),F},F.mapping=function(e,t){return F.map.apply(F,arguments)},F.send=function(e,t){return process.send(e,t),F},F.map=function(e,t,r){'/'!==e[0]&&(e='/'+e);var n=!1;if(t=U.$normalize(t),e=framework_internal.preparePath(F.$version(e)),'#'===t[0])return F.owners.push({type:'mapping',owner:_owner,id:e}),F.routes.mapping[e]=F.path.temp('isomorphic_'+t.substring(1)+'.min.js'),F;var o,i=t.indexOf('#');if(i!==-1){var s=t.split('#');t=s[0],o=s[1]}var a=t[0];'@'===a?(t=F.path.package(t.substring(1)),n=!0):'='===a&&(t=F.isWindows?U.combine(F.config['directory-themes'],t.substring(1)):F.path.themes(t.substring(1)),n=!0);var c=U.getExtension(t).length>0;if(!n&&!t.startsWith(directory)){var s='~'===t[0]?F.path.root(t.substring(1)):F.path.public(t);existsSync(s)&&(t=s)}if(c)return F.routes.mapping[e]=t,F.owners.push({type:'mapping',owner:_owner,id:e}),o&&(F.owners.push({type:'blocks',owner:_owner,id:e}),F.routes.blocks[e]=o),F;e=U.path(e),t=U.path(t);var u=t,l='',p=!1;if('/'===u[0]&&(p=!0),'~'===u[0]&&(l+='~',u=u.substring(1)),'.'===u[0]&&(l+='.',u=u.substring(1)),p||'/'!==u[0]||(l+='/',u=u.substring(1)),r instanceof Array)for(var f=0,d=r.length;f<d;f++)'.'===r[f][0]&&(r[f]=r[f].substring(1)),r[f]=r[f].toLowerCase();return setTimeout(function(){U.ls(F.isWindows?t.replace(/\//g,'\\'):t,function(n){for(var i=0,s=n.length;i<s;i++){F.isWindows&&(n[i]=n[i].replace(t,'').replace(/\\/g,'/'));var a=n[i].replace(u,'');if(r)if('function'==typeof r){if(!r(a))continue}else if(r.indexOf(U.getExtension(a).toLowerCase())===-1)continue;'/'===a[0]&&(a=a.substring(1));var c=e+a;F.routes.mapping[c]=l+n[i],F.owners.push({type:'mapping',owner:_owner,id:c}),o&&(F.owners.push({type:'blocks',owner:_owner,id:c}),F.routes.blocks[c]=o)}})},n?500:1),this},F.middleware=function(e,t){return F.install('middleware',e,t),_owner&&F.owners.push({type:'middleware',owner:_owner,id:e}),F},F.use=function(e,t,r,n){if(!t&&!r){if(e instanceof Array)for(var o=0;o<e.length;o++)F.routes.request.push(e[o]);else F.routes.request.push(e);return F._length_request_middleware=F.routes.request.length,F}t instanceof Array&&(r=t,t=null),'*'===t&&(t=null);var i;if(t&&(t=framework_internal.routeSplitCreate(framework_internal.preparePath(t.trim())).join('/')),!r||r.indexOf('web')!==-1)for(var o=0,s=F.routes.web.length;o<s;o++)i=F.routes.web[o],t&&!i.url.join('/').startsWith(t)||(!i.middleware&&(i.middleware=[]),merge_middleware(i.middleware,e,n));if(!r||r.indexOf('file')!==-1||r.indexOf('files')!==-1)for(var o=0,s=F.routes.files.length;o<s;o++)i=F.routes.files[o],t&&!i.url.join('/').startsWith(t)||(!i.middleware&&(i.middleware=[]),merge_middleware(i.middleware,e,n));if(!r||r.indexOf('websocket')!==-1||r.indexOf('websockets')!==-1)for(var o=0,s=F.routes.websockets.length;o<s;o++)i=F.routes.websockets[o],t&&!i.url.join('/').startsWith(t)||(!i.middleware&&(i.middleware=[]),merge_middleware(i.middleware,e,n));return F},F.websocket=function(e,t,r,n){var o,i='function'==typeof e?e:null;if(i&&(e='/'),'#'===e[0]){e=e.substring(1);var s=F.sitemap(e,!0);if(!s)throw new Error('Sitemap item "'+e+'" not found.');e=s.url,s.wildcard&&(e+='*')}''===e&&(e='/'),e=framework_internal.encodeUnicodeURL(e);var a,c,u,l,p,f=0,d=e.indexOf(']'),h=null;f=e.count('/'),d>0&&(h=e.substring(1,d).trim().toLowerCase().split(','),e=e.substring(d+1),f+=h.indexOf('*')!==-1?50:100);var m=e.indexOf('*')!==-1;m&&(e=e.replace('*','').replace('//','/'),f=-10-f);var g=framework_internal.preparePath(e.trim()),v=framework_internal.routeSplitCreate(g),y=[],b=null,E=null,w=g.hash(),_=U.path(g)+(m?'*':'');e.indexOf('{')!==-1&&(v.forEach(function(e,t){if('{'===e.substring(0,1)){y.push(t);var r=e.substring(1,e.length-1);if('/'===r[0]){var n=r.lastIndexOf('/');n!==-1&&(b||(b={},E=[]),b[t]=new RegExp(r.substring(1,n),r.substring(n+1)),E.push(t))}}}),f-=y.length),'string'==typeof c&&(c=c[c]),'string'==typeof l&&(l=l[l]),o=[];var k=!1,$=!1,S=!1,O=0,x=0;r||(r=[]),_flags&&_flags.forEach(function(e){r.indexOf(e)===-1&&r.push(e)});for(var T=0;T<r.length;T++){var R=r[T],A='undefined'==typeof R?'undefined':_typeof(R);if('object'!==A)if('number'!==A)if('id:'!==R.substring(0,3))if('#'!==R[0])if(R=R.toString().toLowerCase(),R.startsWith('http://')||R.startsWith('https://'))c||(c=[]),c.push(R);else if(O++,'json'===R&&(k=!0),'binary'===R&&($=!0),'raw'===R&&($=!1,k=!1),'@'!==R[0]){if('json'!==R&&'binary'!==R&&'raw'!==R)switch(R){case'authorize':case'authorized':case'logged':x=1,f++,o.push('authorize');break;case'unauthorize':case'unauthorized':case'unlogged':x=2,f++,o.push('unauthorize');break;case'get':case'http':case'https':case'debug':case'release':o.push(R);break;default:l||(l=[]),l.push(R)}}else S=!0,o.push(R);else a||(a=[]),a.push(r[T].substring(1));else p=R.substring(3).trim();else n=R;else u=r[T]}r=o,r.indexOf('get')===-1&&r.unshift('get'),f+=2*O,h&&F._length_subdomain_websocket++;var C=new FrameworkRoute,N=C.route;return N.id=p,N.urlraw=_,N.hash=w,N.controller=_controller?_controller:'unknown',N.owner=_owner,N.url=v,N.param=y,N.subdomain=h,N.priority=f,N.flags=r||EMPTYARRAY,N.flags2=flags_to_object(r),N.onInitialize=t,N.protocols=l||EMPTYARRAY,N.allow=c||[],N.length=1024*(n||F.config['default-websocket-request-length']),N.isWEBSOCKET=!0,N.MEMBER=x,N.isJSON=k,N.isBINARY=$,N.isROLE=S,N.isASTERIX=m,N.isHTTPS=r.indexOf('https'),N.isHTTP=r.indexOf('http'),N.isDEBUG=r.indexOf('debug'),N.isRELEASE=r.indexOf('release'),N.CUSTOM=i,N.middleware=a?a:null,N.options=u,N.isPARAM=y.length>0,N.regexp=b,N.regexpIndexer=E,N.type='websocket',F.routes.websockets.push(N),F.emit('route','websocket',N),!_controller&&F.$routesSort(2),C},F.file=function(e,t,r){var n;if(e instanceof Array){n=t;var o=r;r=e,e=n,t=o}else t instanceof Array&&(n=t,t=r,r=n);!t&&e&&(t=e,e=void 0);var i,s,a,c,u=!1,l=!1,p=null,f=e;if(_flags&&(!r&&(r=[]),_flags.forEach(function(e){r.indexOf(e)===-1&&r.push(e)})),r)for(var d=0,h=r.length;d<h;d++){var m=r[d];'object'!==('undefined'==typeof m?'undefined':_typeof(m))?'id:'!==m.substring(0,3)?('#'===m[0]&&(!s&&(s=[]),s.push(m.substring(1))),'.'===m[0]&&(m=m.substring(1).toLowerCase(),!i&&(i={}),i[m]=!0)):p=m.substring(3).trim():a=m}if('string'==typeof e){if('/'===e&&(e=''),c=e?framework_internal.routeSplitCreate(e):EMPTYARRAY,e=void 0,n=c.last(),'*.*'===n)u=!0,c.splice(c.length-1,1);else if(n){var g=n.indexOf('*.');g!==-1?(i={},i[n.substring(g+2).trim()]=!0,u=!1,c.splice(c.length-1,1)):'*'===n?(u=!0,c.splice(c.length-1,1)):U.getExtension(n)&&(l=!0,u=!1)}}else i||e||(e=t);var v=new FrameworkRoute,y=v.route;return y.id=p,y.urlraw=f,y.controller=_controller?_controller:'unknown',y.owner=_owner,y.url=c,y.fixedfile=l,y.wildcard=u,y.extensions=i,y.onValidate=e,y.execute=t,y.middleware=s,y.options=a,y.type='file',F.routes.files.push(y),F.routes.files.sort(function(e,t){return e.url?t.url&&e.url.length>t.url.length?-1:1:-1}),F.emit('route','file',y),F._length_files++,F},F.localize=function(e,t,r){e=e.replace('*',''),t===!0?(t=[],r=!0):t||(t=[]);var n;r||(n=t.indexOf('minify'),n===-1&&(n=t.indexOf('compress')),r=n!==-1,n!==-1&&t.splice(n,1));var n=e.lastIndexOf('.');return n===-1?t.push('.html','.htm','.md','.txt'):(t.push(e.substring(n).toLowerCase()),e=e.substring(0,n)),e=framework_internal.preparePath(e),F.file(e,function(e,t){F.onLocale&&(e.$language=F.onLocale(e,t,e.isStaticFile));var n='locate_'+(e.$language?e.$language:'default')+'_'+e.url,o=F.temporary.other[n];if(o)return void(F.$notModified(e,t,o.$mtime)||(HEADERS.responseLocalize['Last-Modified']=o.$mtime,t.options.body=o,t.options.type=U.getContentType(e.extension),t.$text()));var i=e.uri.pathname,s=F.onMapping(i,i,!0,!0);Fs.readFile(s,function(o,i){return o?t.throw404():(i=F.translator(e.$language,framework_internal.modificators(i.toString(ENCODING),s,'static')),void Fs.lstat(s,function(o,a){var c=a.mtime.toUTCString();!r||'html'!==e.extension&&'htm'!==e.extension||(i=framework_internal.compile_html(i,s)),RELEASE&&(F.temporary.other[n]=U.createBuffer(i),F.temporary.other[n].$mtime=c,F.$notModified(e,t,c))||(HEADERS.responseLocalize['Last-Modified']=c,t.options.body=i,t.options.type=U.getContentType(e.extension),t.options.headers=HEADERS.responseLocalize,t.$text())}))})},t),F},F.$notModified=function(e,t,r){if(r===e.headers['if-modified-since'])return HEADERS.responseNotModified['Last-Modified']=r,t.success=!0,t.writeHead(304,HEADERS.responseNotModified),t.end(),F.stats.response.notModified++,F.reqstats(!1,e.isStaticFile),!0},F.error=function(e,t,r){if(!arguments.length)return function(e){e&&F.error(e,t,r)};if(!e)return F;if(F.errors&&(F.datetime=new Date,F.errors.push({error:e.stack,name:t,url:r?'string'==typeof r?r:Parser.format(r):void 0,date:F.datetime}),F.errors.length>50&&F.errors.shift()),!t&&!r&&e.stack){var n=e.stack.match(/\/\w+\/defer\-.*?\.js/);n&&(e.stack=e.stack.replace(n,n.toString()).replace(/\/\w+\/defer\-/,'/').split('$').join('/'))}return F.onError(e,t,r),F},F.problem=F.wtf=function(e,t,r,n){F.$events.problem&&F.emit('problem',e,t,r,n),e instanceof framework_builders.ErrorBuilder?e=e.plain():'object'===('undefined'==typeof e?'undefined':_typeof(e))&&(e=JSON.stringify(e));var o={message:e,name:t,url:r?'string'==typeof r?r:Parser.format(r):void 0,ip:n};return F.logger('problems',o.message,'url: '+o.url,'source: '+o.name,'ip: '+o.ip),F.problems&&(F.problems.push(o),F.problems.length>50&&F.problems.shift()),F},F.change=function(e,t,r,n){F.$events.change&&F.emit('change',e,t,r,n),e instanceof framework_builders.ErrorBuilder?e=e.plain():'object'===('undefined'==typeof e?'undefined':_typeof(e))&&(e=JSON.stringify(e));var o={message:e,name:t,url:r?'string'==typeof r?r:Parser.format(r):void 0,ip:n};return F.logger('changes',o.message,'url: '+o.url,'source: '+o.name,'ip: '+o.ip),F.changes&&(F.changes.push(o),F.changes.length>50&&F.changes.shift()),F},F.trace=function(e,t,r,n){if(!F.config.trace)return F;F.$events.trace&&F.emit('trace',e,t,r,n),e instanceof framework_builders.ErrorBuilder?e=e.plain():'object'===('undefined'==typeof e?'undefined':_typeof(e))&&(e=JSON.stringify(e)),F.datetime=new Date;var o={message:e,name:t,url:r?'string'==typeof r?r:Parser.format(r):void 0,ip:n,date:F.datetime};return F.logger('traces',o.message,'url: '+o.url,'source: '+o.name,'ip: '+o.ip),F.config['trace-console']&&console.log(F.datetime.format('yyyy-MM-dd HH:mm:ss'),'[trace]',e,'|','url: '+o.url,'source: '+o.name,'ip: '+o.ip),F.traces&&(F.traces.push(o),F.traces.length>50&&F.traces.shift()),F},F.module=function(e){return F.modules[e]||null},F.modify=function(e){return F.modificators||(F.modificators=[]),F.modificators.push(e),e.$owner=_owner,F},F.$load=function(e,t,r,n){function o(e,t,r,n,i){existsSync(s)&&(n||(n='.js'),Fs.readdirSync(e).forEach(function(a){var c=Fs.statSync(Path.join(e,a)).isDirectory();if(c&&i)return void r.push({name:a});if(c){if('.package'===n&&a.endsWith(n)){var u=a.substring(0,a.length-n.length);return void r.push({name:'/'===u[0]?u.substring(1):u,filename:Path.join(s,a),is:!0})}return t++,void o(Path.join(e,a),t,r,n)}var l=U.getExtension(a).toLowerCase();if(l&&(l='.'+l),l===n){var u=(t?U.$normalize(e).replace(s,'')+'/':'')+a.substring(0,a.length-l.length);r.push({name:'/'===u[0]?u.substring(1):u,filename:Path.join(s,u)+n})}}))}var i=[],s='';t||(t=directory),t='~'+t;try{F.temporary.internal.resources=Fs.readdirSync(F.path.resources()).map(function(e){return e.substring(0,e.lastIndexOf('.'))})}catch(e){F.temporary.internal.resources=[]}var a=[],c=[],u=t.indexOf('.package')!==-1;return e&&e.indexOf('modules')===-1||c.push(function(e){s=U.combine(t,u?'/modules/':F.config['directory-modules']),i=[],o(s,0,i,'.js'),i.forEach(function(e){return a.push(function(t){return F.install('module',e.name,e.filename,void 0,void 0,void 0,!0,void 0,void 0,t,n)})}),e()}),e&&e.indexOf('isomorphic')===-1||c.push(function(e){s=U.combine(t,u?'/isomorphic/':F.config['directory-isomorphic']),i=[],o(s,0,i,'.js'),i.forEach(function(e){return a.push(function(t){return F.install('isomorphic',e.name,e.filename,void 0,void 0,void 0,!0,void 0,void 0,t,n)})}),e()}),e&&e.indexOf('packages')===-1||c.push(function(e){s=U.combine(t,u?'/packages/':F.config['directory-packages']),i=[],o(s,0,i,'.package');var r=U.$normalize(s);i.forEach(function(t){return t.is?void U.ls(t.filename,function(o,i){var s=F.path.temp(t.name)+'.package';!existsSync(s)&&Fs.mkdirSync(s);for(var c=0,u=i.length;c<u;c++){var l=F.path.temp(U.$normalize(i[c]).replace(r,'')+'/');!existsSync(l)&&Fs.mkdirSync(l)}o.wait(function(e,r){var n=Fs.createReadStream(e);n.pipe(Fs.createWriteStream(Path.join(s,e.replace(t.filename,'').replace(/\.package$/i,'')))),n.on('end',r)},function(){setTimeout(function(){e(),a.push(function(e){return F.install('package2',t.name,t.filename,void 0,void 0,void 0,!0,void 0,void 0,e,n)})},50)})}):(a.push(function(e){return F.install('package',t.name,t.filename,void 0,void 0,void 0,!0,void 0,void 0,e,n)}),e())}),!i.length&&e()}),e&&e.indexOf('models')===-1||c.push(function(e){s=U.combine(t,u?'/models/':F.config['directory-models']),i=[],o(s,0,i),i.forEach(function(e){return a.push(function(t){return F.install('model',e.name,e.filename,void 0,void 0,void 0,!0,void 0,void 0,t,n)})}),e()}),e&&e.indexOf('themes')===-1||c.push(function(e){i=[],s=U.combine(t,u?'/themes/':F.config['directory-themes']),o(s,0,i,void 0,!0),i.forEach(function(e){var t=e.name,r=Path.join(s,t),o=Path.join(r,'index.js');F.themes[e.name]=U.path(r),F._length_themes++,existsSync(o)&&a.push(function(t){return F.install('theme',e.name,o,void 0,void 0,void 0,!0,void 0,void 0,t,n)})}),e()}),e&&e.indexOf('definitions')===-1||c.push(function(e){s=U.combine(t,u?'/definitions/':F.config['directory-definitions']),i=[],o(s,0,i),i.forEach(function(e){return a.push(function(t){return F.install('definition',e.name,e.filename,void 0,void 0,void 0,!0,void 0,void 0,t,n)})}),e()}),e&&e.indexOf('controllers')===-1||c.push(function(e){i=[],s=U.combine(t,u?'/controllers/':F.config['directory-controllers']),o(s,0,i),i.forEach(function(e){return a.push(function(t){return F.install('controller',e.name,e.filename,void 0,void 0,void 0,!0,void 0,void 0,t,n)})}),e()}),e&&e.indexOf('components')===-1||c.push(function(e){i=[],s=U.combine(t,u?'/components/':F.config['directory-components']),o(s,0,i,'.html'),i.forEach(function(e){return a.push(function(t){return F.install('component',e.name,e.filename,void 0,void 0,void 0,void 0,void 0,void 0,t,n)})}),e()}),c.async(function(){var t=a.length;F.consoledebug('load dependencies '+t+'x'),a.async(function(){e&&e.indexOf('service')===-1&&F.cache.stop(),F.$routesSort(),(!e||e.indexOf('dependencies')!==-1)&&F.$configure_dependencies(),F.consoledebug('load dependencies {0}x (done)'.format(t)),r&&r()})}),F},F.$startup=function(e){var t=Path.join(directory,'/startup/');if(!existsSync(t))return e();var r=[];return Fs.readdirSync(t).forEach(function(e){var t=U.getExtension(e).toLowerCase();'js'===t&&r.push(e)}),r.length?(r.wait(function(e,r){var n=t+e+(new Date).format('yyMMdd_HHmmss');Fs.renameSync(t+e,n);var o=Child.fork(n,[],{cwd:directory});o.on('exit',function(){o=null,r()})},e),this):e()},F.uptodate=function(e,t,r,n,o,i){'string'==typeof r&&'string'!=typeof n&&(n=r,r=null);var s={type:e,name:'',url:t,interval:n,options:r,count:0,updated:F.datetime,errors:[],callback:o};return F.uptodates||(F.uptodates=[]),F.uptodates.push(s),F.install(e,t,r,function(e,t){e&&s.errors.push(e),s.name=t,s.callback&&s.callback(e,t)},void 0,void 0,void 0,void 0,i),F},F.install=function(type,name,declaration,options,callback,internal,useRequired,skipEmit,uptodateName,next,packageName){var obj=null;'config'!==type&&'version'!==type&&'string'==typeof name&&(name.startsWith('http://')||name.startsWith('https://')?'object'===('undefined'==typeof declaration?'undefined':_typeof(declaration))&&(callback=options,options=declaration,declaration=name,name=''):'@'===name[0]&&(declaration=F.path.package(name.substring(1)),name=Path.basename(name).replace(/\.js$/i,''),void 0===useRequired&&(useRequired=!0)));var t='undefined'==typeof declaration?'undefined':_typeof(declaration),key='',tmp,content,err;if(F.datetime=new Date,'object'===t&&(t='undefined'==typeof options?'undefined':_typeof(options),'function'===t&&(callback=options),options=declaration,declaration=void 0),void 0===declaration&&(declaration=name,name=''),'function'==typeof options&&(callback=options,options=void 0),'eval'!==type&&'string'==typeof declaration){if(declaration.startsWith('http://')||declaration.startsWith('https://'))return'package'===type?(F.consoledebug('download',type,declaration),U.download(declaration,FLAGS_INSTALL,function(e,t){if(e)return F.error(e,'F.install(\'{0}\', \'{1}\')'.format(type,declaration),null),next&&next(),void(callback&&callback(e));var r=Path.basename(declaration,'.package'),n=F.path.temp(r+'.download'),o=Fs.createWriteStream(n),i=Crypto.createHash('md5');t.on('data',function(e){return i.update(e)}),t.pipe(o),o.on('finish',function(){var e=i.digest('hex');return F.temporary.versions[declaration]===e?(next&&next(),void(callback&&callback(null,uptodateName||name,!0))):(F.temporary.versions[declaration]=e,void F.install(type,r,n,options,callback,void 0,void 0,!0,uptodateName,next))})}),F):(F.consoledebug('download',type,declaration),U.request(declaration,FLAGS_INSTALL,function(e,t,r){if(200===r||e||(e=new Error(t)),e)F.error(e,'F.install(\'{0}\', \'{1}\')'.format(type,declaration),null),next&&next(),callback&&callback(e);else{var n=t.hash('md5');if(F.temporary.versions[declaration]===n)return next&&next(),void(callback&&callback(null,uptodateName||name,!0));F.temporary.versions[declaration]=n,F.install(type,name,t,options,callback,declaration,void 0,void 0,uptodateName,next)}}),F);if('~'===declaration[0]&&(declaration=declaration.substring(1)),'config'!==type&&'resource'!==type&&'package'!==type&&'component'!==type&&!REG_SCRIPTCONTENT.test(declaration)){if(!existsSync(declaration))throw new Error('The '+type+': '+declaration+' doesn\'t exist.');useRequired=!0}}if('middleware'===type)return F.routes.middleware[name]='function'==typeof declaration?declaration:eval(parseDefer(declaration)),F._length_middleware=Object.keys(F.routes.middleware).length,next&&next(),callback&&callback(null,name),key=type+'.'+name,F.dependencies[key]?F.dependencies[key].updated=F.datetime:(F.dependencies[key]={name:name,type:type,installed:F.datetime,updated:null,count:0},internal&&(F.dependencies[key].url=internal)),F.dependencies[key].count++,setTimeout(function(){F.emit(type+'#'+name),F.emit('install',type,name),F.temporary.ready[type+'#'+name]=F.datetime},500),F.consoledebug('install',type+'#'+name),F;if('config'===type||'configuration'===type||'settings'===type)return F.$configure_configs(declaration instanceof Array?declaration:declaration.toString().split('\n'),!0),setTimeout(function(){delete F.temporary['mail-settings'],F.emit(type+'#'+name,F.config),F.emit('install',type,name),F.temporary.ready[type+'#'+name]=F.datetime},500),F.consoledebug('install',type+'#'+name),next&&next(),callback&&callback(null,name),F;if('version'===type||'versions'===type)return F.$configure_versions(declaration.toString().split('\n')),setTimeout(function(){F.emit(type+'#'+name),F.emit('install',type,name),F.temporary.ready[type+'#'+name]=F.datetime},500),F.consoledebug('install',type+'#'+name),next&&next(),callback&&callback(null,name),F;if('workflow'===type||'workflows'===type)return F.$configure_workflows(declaration.toString().split('\n')),setTimeout(function(){F.emit(type+'#'+name),F.emit('install',type,name),F.temporary.ready[type+'#'+name]=F.datetime,F.consoledebug('install',type+'#'+name)},500),next&&next(),callback&&callback(null,name),F;if('sitemap'===type)return F.$cofnigure_sitemap(declaration.toString().split('\n')),setTimeout(function(){F.emit(type+'#'+name),F.emit('install',type,name),F.temporary.ready[type+'#'+name]=F.datetime,F.consoledebug('install',type+'#'+name)},500),next&&next(),callback&&callback(null,name),F;if('component'===type){!name&&internal&&(name=U.getName(internal).replace(/\.html/gi,'').trim()),F.uninstall(type,uptodateName||name,uptodateName?'uptodate':void 0);var hash='\n/*'+name.hash()+'*/\n',temporary=(F.id?'i-'+F.id+'_':'')+'components';content=parseComponent(internal?declaration:Fs.readFileSync(declaration).toString(ENCODING),name),content.js&&Fs.appendFileSync(F.path.temp(temporary+'.js'),hash+(F.config.debug?component_debug(name,content.js,'js'):content.js)+hash.substring(0,hash.length-1)),content.css&&Fs.appendFileSync(F.path.temp(temporary+'.css'),hash+(F.config.debug?component_debug(name,content.css,'css'):content.css)+hash.substring(0,hash.length-1)),content.js&&(F.components.js=!0),content.css&&(F.components.css=!0),content.body?(F.components.views[name]='.'+F.path.temp('component_'+name),Fs.writeFile(F.components.views[name].substring(1)+'.html',U.minifyHTML(content.body),NOOP)):delete F.components.views[name],F.components.has=!0;var link=F.config['static-url-components'];if(F.components.version=F.datetime.getTime(),F.components.links=(F.components.js?'<script src="{0}js?version={1}"></script>'.format(link,F.components.version):'')+(F.components.css?'<link type="text/css" rel="stylesheet" href="{0}css?version={1}" />'.format(link,F.components.version):''),content.install)try{var filecomponent=F.path.temp('component-'+name+'.js');_owner=(packageName?packageName+'@':'')+type+'#'+name,Fs.writeFileSync(filecomponent,parseDefer(content.install.trim())),obj=require(filecomponent),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(filecomponent)),obj.$owner=_owner,F.temporary.owners[_owner]=!0,_controller='',F.components.instances[name]=obj,obj='function'==typeof obj.install&&obj.install(options||F.config[_owner],name)}catch(e){F.error(e,'F.install(\'component\', \'{0}\')'.format(name))}else if(!internal){var js=declaration.replace(/\.html$/i,'.js');existsSync(js)&&(_owner=(packageName?packageName+'@':'')+type+'#'+name,F.temporary.owners[_owner]=!0,obj=require(js),obj.$owner=_owner,_controller='',F.components.instances[name]=obj,'function'==typeof obj.install&&obj.install(options||F.config[_owner],name),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration)))}return!skipEmit&&setTimeout(function(){F.emit(type+'#'+name),F.emit('install',type,name),F.temporary.ready[type+'#'+name]=F.datetime},500),F.consoledebug('install',type+'#'+name),next&&next(),callback&&callback(null,name),F}if('package'===type){var backup=new Backup,id=Path.basename(declaration,'.'+U.getExtension(declaration)),dir='~'===F.config['directory-temp'][0]?Path.join(F.config['directory-temp'].substring(1),id+'.package'):Path.join(F.path.root(),F.config['directory-temp'],id+'.package');return F.routes.packages[id]=dir,backup.restore(declaration,dir,function(){var e=Path.join(dir,'index.js');return existsSync(e)?(F.install('module',id,e,options||F.config['package#'+name],function(e){setTimeout(function(){F.emit('module#'+name),F.emit(type+'#'+name),F.emit('install','module',name),F.emit('install',type,name),F.temporary.ready['package#'+name]=F.datetime,F.temporary.ready['module#'+name]=F.datetime},500),F.consoledebug('install','package#'+name),callback&&callback(e,name)},internal,useRequired,!0,void 0),void(next&&next())):(next&&next(),void(callback&&callback(null,name)))}),F}if('theme'===type)return _owner=(packageName?packageName+'@':'')+type+'#'+name,declaration=parseDeferFile(type,declaration),obj=require(declaration),obj.$owner=_owner,F.temporary.owners[_owner]=!0,'function'==typeof obj.install&&obj.install(options||F.config[_owner],name),!skipEmit&&setTimeout(function(){F.emit(type+'#'+name),F.emit('install',type,name),F.temporary.ready[type+'#'+name]=F.datetime},500),F.consoledebug('install',type+'#'+name),next&&next(),callback&&callback(null,name),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration)),F;if('package2'===type){type=type.substring(0,type.length-1);var id=U.getName(declaration,'.package'),dir='~'===F.config['directory-temp'][0]?Path.join(F.config['directory-temp'].substring(1),id):Path.join(F.path.root(),F.config['directory-temp'],id),filename=Path.join(dir,'index.js');return F.install('module',id.replace(/\.package$/i,''),filename,options||F.config['package#'+name],function(e){setTimeout(function(){F.emit('module#'+name),F.emit(type+'#'+name),F.emit('install',type,name),F.emit('install','module',name),F.temporary.ready['package#'+name]=F.datetime,F.temporary.ready['module#'+name]=F.datetime},500),F.consoledebug('install','package#'+name),callback&&callback(e,name)},internal,useRequired,!0),next&&next(),F}var plus=F.id?'i-'+F.id+'_':'';if('view'===type){var item=F.routes.views[name];return key=type+'.'+name,void 0===item&&(item={},item.filename=F.path.temporary(plus+'installed-view-'+U.GUID(10)+'.tmp'),item.url=internal,item.count=0,F.routes.views[name]=item),item.count++,Fs.writeFileSync(item.filename,framework_internal.modificators(declaration,name)),setTimeout(function(){F.emit(type+'#'+name),F.emit('install',type,name),F.temporary.ready[type+'#'+name]=F.datetime},500),F.consoledebug('install',type+'#'+name),next&&next(),callback&&callback(null,name),F}if('definition'===type||'eval'===type){_controller='',_owner=(packageName?packageName+'@':'')+type+'#'+name,F.temporary.owners[_owner]=!0,err=null;try{useRequired?(declaration=parseDeferFile(type,declaration),delete require.cache[require.resolve(declaration)],obj=require(declaration),function(e){setTimeout(function(){return delete require.cache[e]},1e3)}(require.resolve(declaration))):obj='function'==typeof declaration?eval('('+parseDefer(declaration.toString())+')()'):eval(parseDefer(declaration))}catch(e){err=e}return err?(F.error(err,'F.install(\''+type+'\')',null),next&&next(),callback&&callback(err,name),F):(F.consoledebug('install',type+'#'+(name||'::undefined::')),next&&next(),callback&&callback(null,name),setTimeout(function(){F.emit(type+'#'+name),F.emit('install',type,name),F.temporary.ready[type+'#'+name]=F.datetime},500),F)}if('isomorphic'===type){content='',err=null;try{if(!name&&'string'==typeof internal){var tmp=internal.match(/[a-z0-9]+\.js$/i);tmp&&(name=tmp.toString().replace(/\.js/i,''))}useRequired?(declaration=parseDeferFile(type,declaration),delete require.cache[require.resolve(declaration)],obj=require(declaration),content=Fs.readFileSync(declaration).toString(ENCODING),function(e){setTimeout(function(){return delete require.cache[e]},1e3)}(require.resolve(declaration))):(obj='function'==typeof declaration?eval('('+parseDefer(declaration.toString())+')()'):eval(parseDefer(declaration)),content=declaration.toString())}catch(e){err=e}return err?(F.error(err,'F.install(\''+type+'\')',null),next&&next(),callback&&callback(err,name),F):('string'==typeof obj.id?name=obj.id:'string'==typeof obj.name&&(name=obj.name),obj.url?'/'!==obj.url[0]&&(obj.url='/'+obj.url):obj.url='/'+name+'.js',tmp=F.path.temp('isomorphic_'+name+'.min.js'),F.map(framework_internal.preparePath(obj.url),tmp),F.isomorphic[name]=obj,Fs.writeFileSync(tmp,prepare_isomorphic(name,framework_internal.compile_javascript(content,'#'+name))),F.consoledebug('install',type+'#'+name),next&&next(),callback&&callback(null,name),setTimeout(function(){F.emit(type+'#'+name,obj),F.emit('install',type,name,obj),F.temporary.ready[type+'#'+name]=F.datetime},500),F)}if('model'===type||'source'===type){_controller='',_owner=(packageName?packageName+'@':'')+type+'#'+name,F.temporary.owners[_owner]=!0,err=null;try{if(useRequired)declaration=parseDeferFile(type,declaration),obj=require(declaration),function(e){setTimeout(function(){return delete require.cache[e]},1e3)}(require.resolve(declaration));else{if('string'!=typeof declaration&&(declaration=declaration.toString()),!name&&'string'==typeof internal){var tmp=internal.match(/[a-z0-9]+\.js$/i);tmp&&(name=tmp.toString().replace(/\.js/i,''))}var filename=F.path.temporary(plus+'installed-'+type+'-'+U.GUID(10)+'.js');Fs.writeFileSync(filename,parseDefer(declaration)),obj=require(filename),function(e,t){setTimeout(function(){Fs.unlinkSync(t),delete require.cache[e]},1e3)}(require.resolve(filename),filename)}}catch(e){err=e}return err?(F.error(err,'F.install(\''+type+'\', \''+name+'\')',null),next&&next(),callback&&callback(err,name),F):('string'==typeof obj.id?name=obj.id:'string'==typeof obj.name&&(name=obj.name),_owner=(packageName?packageName+'@':'')+type+'#'+name,obj.$owner=_owner,name||(name=1e4*Math.random()>>0),key=type+'.'+name,tmp=F.dependencies[key],F.uninstall(type,uptodateName||name,uptodateName?'uptodate':void 0),F.temporary.owners[_owner]=!0,tmp?(F.dependencies[key]=tmp,F.dependencies[key].updated=F.datetime):(F.dependencies[key]={name:name,type:type,installed:F.datetime,updated:null,count:0},internal&&(F.dependencies[key].url=internal)),F.dependencies[key].count++,obj.reinstall?F.dependencies[key].reinstall=obj.reinstall.toString().parseDateExpiration():delete F.dependencies[key],'model'===type?F.models[name]=obj:F.sources[name]=obj,'function'==typeof obj.install&&obj.install(options||F.config[type+'#'+name],name),!skipEmit&&setTimeout(function(){F.emit(type+'#'+name,obj),F.emit('install',type,name,obj),F.temporary.ready[type+'#'+name]=F.datetime},500),F.consoledebug('install',type+'#'+name),next&&next(),callback&&callback(null,name),F)}if('module'===type||'controller'===type){var _ID=_controller='TMP'+U.random(1e4);_owner=(packageName?packageName+'@':'')+type+'#'+name,err=null;try{if(useRequired)declaration=parseDeferFile(type,declaration),obj=require(declaration),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration));else{if('string'!=typeof declaration&&(declaration=declaration.toString()),!name&&'string'==typeof internal){var tmp=internal.match(/[a-z0-9]+\.js$/i);tmp&&(name=tmp.toString().replace(/\.js/i,''))}filename=F.path.temporary(plus+'installed-'+type+'-'+U.GUID(10)+'.js'),Fs.writeFileSync(filename,parseDefer(declaration)),obj=require(filename),function(e,t){setTimeout(function(){Fs.unlinkSync(t),delete require.cache[e]},1e3)}(require.resolve(filename),filename)}}catch(e){err=e}if(err)return F.error(err,'F.install(\''+type+'\', \''+(name?'':internal)+'\')',null),next&&next(),callback&&callback(err,name),F;if('string'==typeof obj.id?name=obj.id:'string'==typeof obj.name&&(name=obj.name),name||(name=1e4*Math.random()>>0),_owner=(packageName?packageName+'@':'')+type+'#'+name,obj.$owner=_owner,obj.booting&&setTimeout(function(){var e=F.path.temp(name+('package'===U.getExtension(name)?'':'.package/'));'root'===obj.booting?(F.directory=directory=e,F.temporary.path={},F.temporary.notfound={},F.$configure_configs(),F.$configure_versions(),
F.$configure_dependencies(),F.$cofnigure_sitemap(),F.$configure_workflows()):(F.$configure_configs('@'+name+'/config'),F.config.debug?F.$configure_configs('@'+name+'/config-debug'):F.$configure_configs('@'+name+'/config-release'),F.isTest&&F.$configure_configs('@'+name+'/config-test'),F.$configure_versions('@'+name+'/versions'),F.$configure_dependencies('@'+name+'/dependencies'),F.$cofnigure_sitemap('@'+name+'/sitemap'),F.$configure_workflows('@'+name+'/workflows')),F.$load(void 0,e,void 0,name)},100),key=type+'.'+name,tmp=F.dependencies[key],F.uninstall(type,uptodateName||name,uptodateName?'uptodate':void 0,void 0,packageName),F.temporary.owners[_owner]=!0,tmp?(F.dependencies[key]=tmp,F.dependencies[key].updated=F.datetime):(F.dependencies[key]={name:name,type:type,installed:F.datetime,updated:null,count:0,_id:_ID},internal&&(F.dependencies[key].url=internal)),F.dependencies[key].dependencies=obj.dependencies,F.dependencies[key].count++,F.dependencies[key].processed=!1,obj.reinstall?F.dependencies[key].reinstall=obj.reinstall.toString().parseDateExpiration():delete F.dependencies[key].reinstall,_controller=_ID,obj.dependencies instanceof Array)for(var i=0,length=obj.dependencies.length;i<length;i++)if(!F.dependencies[type+'.'+obj.dependencies[i]])return F.temporary.dependencies[key]={obj:obj,options:options,callback:callback,skipEmit:skipEmit},next&&next(),F;F.install_make(key,name,obj,options,callback,skipEmit,type),'module'===type?F.modules[name]=obj:F.controllers[name]=obj,F.install_prepare(),next&&next()}return F},F.restart=function(){return F.isRestarted||(F.isRestarted=!0,F.emit('restart'),setTimeout(function(){return F.$restart()},1e3)),F},F.$restart=function(){return console.log('----------------------------------------------------> RESTART '+(new Date).format('yyyy-MM-dd HH:mm:ss')),F.server.setTimeout(0),F.server.timeout=0,F.server.close(function(){Object.keys(F.modules).forEach(function(e){var t=F.modules[e];t&&t.uninstall&&t.uninstall()}),Object.keys(F.models).forEach(function(e){var t=F.models[e];t&&t.uninstall&&t.uninstall()}),Object.keys(F.controllers).forEach(function(e){var t=F.controllers[e];t&&t.uninstall&&t.uninstall()}),Object.keys(F.workers).forEach(function(e){var t=F.workers[e];t&&t.kill&&(t.removeAllListeners(),t.kill('SIGTERM'))}),Object.keys(F.connections).forEach(function(e){var t=F.connections[e];t&&(t.removeAllListeners(),t.close())}),framework_builders.restart(),framework_image.restart(),framework_mail.restart(),U.restart(),framework_internal.restart(),F.cache.clear(),F.cache.stop(),F.$events={},F.global={},F.resources={},F.connections={},F.functions={},F.themes={},F.uptodates=null,F.versions=null,F.schedules=[],F.isLoaded=!1,F.isRestarted=!1,F.components={has:!1,css:!1,js:!1,views:{},instances:{},version:null,links:''},F.routes={sitemap:null,web:[],files:[],cors:[],websockets:[],middleware:{},redirects:{},resize:{},request:[],views:{},merge:{},mapping:{},packages:{},blocks:{},resources:{},mmr:{}},F.temporary={path:{},notfound:{},processing:{},range:{},views:{},versions:{},dependencies:{},other:{},internal:{},owners:{},ready:{},defer:{}},F.modificators=null,F.helpers={},F.modules={},F.models={},F.sources={},F.controllers={},F.dependencies={},F.isomorphic={},F.tests=[],F.errors=[],F.problems=[],F.changes=[],F.traces=[],F.workers={},F.convertors=[],F.databases={},F._request_check_redirect=!1,F._request_check_referer=!1,F._request_check_POST=!1,F._request_check_robot=!1,F._length_middleware=0,F._length_request_middleware=0,F._length_files=0,F._length_wait=0,F._length_themes=0,F._length_cors=0,F._length_subdomain_web=0,F._length_subdomain_websocket=0,F.isVirtualDirectory=!1,F.isTheme=!1,F.stats.other.restart++,setTimeout(function(){return F.removeAllListeners()},2e3),setTimeout(function(){var e=F.temporary.init;F.mode(e.isHTTPS?require('https'):http,e.name,e.options)},1e3)}),F},F.install_prepare=function(e){var t=Object.keys(F.temporary.dependencies);if(t.length){for(var r=0,n=t.length;r<n;r++){var o=t[r],i=F.temporary.dependencies[o],s=F.dependencies[o],a=!1;if(!s.processed){for(var c=0,u=s.dependencies.length;c<u;c++){var l=F.dependencies['module.'+s.dependencies[c]];if(!l||!l.processed){a=!0;break}}a||(delete F.temporary.dependencies[o],'module'===s.type?F.modules[s.name]=i.obj:F.controllers[s.name]=i.obj,F.install_make(o,s.name,i.obj,i.options,i.callback,i.skipEmit,s.type))}}return t=Object.keys(F.temporary.dependencies),clearTimeout(F.temporary.other.dependencies),F.temporary.other.dependencies=setTimeout(function(){var e=Object.keys(F.temporary.dependencies);if(e.length)throw new Error('Dependency exception (module): missing dependencies for: '+e.join(', ').trim());delete F.temporary.other.dependencies},1500),!t.length||e?F:(F.install_prepare(!0),F)}},F.install_make=function(e,t,r,n,o,i,s){var a=F.dependencies[e],c=a._id,s=a.type;F.temporary.internal[a._id]=t,_controller=c,_owner=s+'#'+t.replace(/\.package$/gi,''),'function'==typeof r.install&&r.install(n||F.config[_owner],t),a.processed=!0;for(var u=('module'===s?'#':'')+t,l=F.routes.web.length,p=0;p<l;p++)F.routes.web[p].controller===c&&(F.routes.web[p].controller=u);l=F.routes.websockets.length;for(var p=0;p<l;p++)F.routes.websockets[p].controller===c&&(F.routes.websockets[p].controller=u);l=F.routes.files.length;for(var p=0;p<l;p++)F.routes.files[p].controller===c&&(F.routes.files[p].controller=u);return F.$routesSort(),_controller='',t=t.replace(/\.package$/gi,''),i||setTimeout(function(){F.emit(s+'#'+t,r),F.emit('install',s,t,r),F.temporary.ready[s+'#'+t]=F.datetime},500),F.consoledebug('install',s+'#'+t),o&&o(null,t),F},F.uninstall=function(e,t,r,n,o){var i,s,a,c=null;if('route'===e||'web'===e)return i='string'==typeof t?'id:'===t.substring(0,3)?'id':'urlraw':'execute',s='execute'===i?t:'id'===i?t.substring(3).trim():t,F.routes.web=F.routes.web.remove(i,s),F.$routesSort(),F.consoledebug('uninstall',e+'#'+t),F;if('schedule'===e)return F.clearSchedule(t),F.consoledebug('uninstall',e+'#'+t),F;var u=(o?o+'@':'')+e+'#'+t;if('websocket'===e)return i='string'==typeof t?'id:'===t.substring(0,3)?'id':'urlraw':'onInitialize',s='onInitialize'===i?t:'id'===i?t.substring(3).trim():t,F.routes.websockets=F.routes.websockets.remove(i,s),F.$routesSort(),F.consoledebug('uninstall',e+'#'+t),F;if('file'===e)return i='string'==typeof t?'id:'===t.substring(0,3)?'id':'urlraw':'execute',s='execute'===i?t:'id'===i?t.substring(3).trim():t,F.routes.files=F.routes.files.remove(i,s),F.consoledebug('uninstall',e+'#'+t),F;if('schema'===e)a=t.split('/'),2===a.length?framework_builders.remove(a[0],a[1]):framework_builders.remove(void 0,a[0]),F.consoledebug('uninstall',e+'#'+t);else if('mapping'===e)delete F.routes.mapping[t],F.consoledebug('uninstall',e+'#'+t);else if('isomorphic'===e){var c=F.isomorphic[t];c.url&&delete F.routes.mapping[F.$version(c.url)],delete F.isomorphic[t],delete F.temporary.ready[e+'#'+t],F.consoledebug('uninstall',e+'#'+t)}else if('middleware'===e){if(!F.routes.middleware[t])return F;delete F.routes.middleware[t],delete F.dependencies[e+'.'+t],delete F.temporary.ready[e+'#'+t],F._length_middleware=Object.keys(F.routes.middleware).length;for(var l=0,p=F.routes.web.length;l<p;l++)a=F.routes.web[l],a.middleware&&a.middleware.length&&(a.middleware=a.middleware.remove(t));for(var l=0,p=F.routes.websockets.length;l<p;l++)a=F.routes.websocket[l],a.middleware&&a.middleware.length&&(a.middleware=a.middleware.remove(t));for(var l=0,p=F.routes.files.length;l<p;l++)a=F.routes.files[l],a.middleware&&a.middleware.length&&(a.middleware=a.middleware.remove(t));F.consoledebug('uninstall',e+'#'+t)}else{if('package'===e)return delete F.routes.packages[t],delete F.temporary.ready['package#'+t],F.uninstall('module',t,r,!0),F.consoledebug('uninstall',e+'#'+t),F;if('view'===e||'precompile'===e){if(c=F.routes.views[t],!c)return F;delete F.routes.views[t],delete F.dependencies[e+'.'+t],delete F.temporary.ready[e+'#'+t],fsFileExists(c.filename,function(r){r&&Fs.unlink(c.filename,NOOP),F.consoledebug('uninstall',e+'#'+t)})}else if('model'===e||'source'===e){if(c='model'===e?F.models[t]:F.sources[t],!c)return F;c.id&&delete require.cache[require.resolve(c.id)],F.$uninstall(u),'function'==typeof c.uninstall&&c.uninstall(r,t),'model'===e?delete F.models[t]:delete F.sources[t],delete F.dependencies[e+'.'+t],delete F.temporary.ready[e+'#'+t],F.consoledebug('uninstall',e+'#'+t)}else if('module'===e||'controller'===e){var f='module'===e;if(c=f?F.modules[t]:F.controllers[t],!c)return F;c.id&&delete require.cache[require.resolve(c.id)],F.$uninstall(u,o?'':(f?'#':'')+t),delete F.temporary.ready[e+'#'+t],F.consoledebug('uninstall',e+'#'+t),c&&(c.uninstall&&c.uninstall(r,t),f?delete F.modules[t]:delete F.controllers[t])}else if('component'===e){if(!F.components.instances[t])return F;c=F.components.instances[t],c&&(F.$uninstall(u),c.uninstall&&c.uninstall(r,t),delete F.components.instances[t]),delete F.components.instances[t],delete F.components.views[t],delete F.temporary.ready[e+'#'+t];var d,h,m=(F.id?'i-'+F.id+'_':'')+'components',g='\n/*'+t.hash()+'*/\n',v=g.substring(0,g.length-1),y=!1;F.components.js&&(d=Fs.readFileSync(F.path.temp(m+'.js')).toString('utf-8'),h=d.indexOf(g),h!==-1&&(d=d.substring(0,h)+d.substring(d.indexOf(v,h+v.length)+v.length),Fs.writeFileSync(F.path.temp(m+'.js'),d),y=!0)),F.components.css&&(d=Fs.readFileSync(F.path.temp(m+'.css')).toString('utf-8'),h=d.indexOf(g),h!==-1&&(d=d.substring(0,h)+d.substring(d.indexOf(v,h+v.length)+v.length),Fs.writeFileSync(F.path.temp(m+'.css'),d),y=!0)),y&&(F.components.version=U.GUID(5)),F.consoledebug('uninstall',e+'#'+t)}}return!n&&F.emit('uninstall',e,t),F},F.$uninstall=function(e,t){if(!F.temporary.owners[e])return F;t&&(F.routes.web=F.routes.web.remove('controller',t),F.routes.files=F.routes.files.remove('controller',t),F.routes.websockets=F.routes.websockets.remove('controller',t)),F.routes.web=F.routes.web.remove('owner',e),F.routes.files=F.routes.files.remove('owner',e),F.routes.websockets=F.routes.websockets.remove('owner',e),F.routes.cors=F.routes.cors.remove('owner',e),F.schedules=F.schedules.remove('owner',e),F.modificators&&(F.modificators=F.modificators.remove('$owner',e)),framework_builders.uninstall(e);for(var r=[],n=!1,o=0,i=F.owners.length;o<i;o++){var s=F.owners[o];if(s.owner===e)switch(s.type){case'redirects':delete F.routes.redirects[s.id],n=!0;break;case'resize':delete F.routes.resize[s.id];break;case'merge':delete F.routes.merge[s.id];break;case'mapping':delete F.routes.mapping[s.id];break;case'blocks':delete F.routes.blocks[s.id];break;case'middleware':UNINSTALL('middleware',s.id)}else r.push(s)}return n&&(F._request_check_redirect=Object.keys(F.routes.redirects).length>0),F.owners=r,F.$routesSort(),delete F.temporary.owners[e],F},F.register=function(e){var t,r='.'+U.getExtension(e),n=U.getName(e),o=e[0];switch('@'===o?e=F.path.package(e.substring(1)):'='===o&&('?'===e[1]?F.path.themes(F.config['default-theme']+e.substring(2)):e=F.path.themes(e.substring(1))),r){case'.resource':t=n.replace(r,''),F.routes.resources[t]?F.routes.resources[t].push(e):F.routes.resources[t]=[e],delete F.resources[t];break;default:throw new Error('Not supported registration type "'+r+'".')}return F},F.eval=function(e){return F.install('eval',e)},F.onError=function(e,t,r){return F.datetime=new Date,console.log('======= '+F.datetime.format('yyyy-MM-dd HH:mm:ss')+': '+(t?t+' ---> ':'')+e.toString()+(r?' ('+Parser.format(r)+')':''),e.stack),F},F.onAuthorize=null,F.onLocale=null,F.onTheme=null,F.onVersion=null,F.onMapping=function(e,t,r,n){if('/'!==e[0]&&(e='/'+e),F._length_themes){var o=e.indexOf('/',1);if(o!==-1){var i=e.substring(1,o);if(F.themes[i])return F.themes[i]+'public'+e.substring(o)}}return F.routes.mapping[e]?F.routes.mapping[e]:(t=framework_internal.preparePath(t,!0),n&&(t=$decodeURIComponent(t)),t=r?F.path.public_cache(t):'~'===t[0]?t.substring(1):'.'===t[0]?t:F.path.public_cache(t))},F.download=F.snapshot=function(e,t,r){return e=framework_internal.preparePath(e),e.match(/^http:|https:/gi)||('/'!==e[0]&&(e='/'+e),e='http://'+('auto'===F.ip?'0.0.0.0':F.ip)+':'+F.port+e),U.download(e,FLAGS_INSTALL,function(e,n){if(e)return r&&r(e),void(r=null);var o=Fs.createWriteStream(t);n.pipe(o),n.on('error',function(e){r&&r(e),r=null}),CLEANUP(o,function(){DESTROY(o),r&&r(null,t),r=null})}),F},F.findConnection=function(e){for(var t=Object.keys(F.connections),r=U.isRegExp(e),n=0,o=t.length;n<o;n++){var i=t[n];if(r){if(e.test(i))return F.connections[i]}else if(i.indexOf(e)!==-1)return F.connections[i]}},F.findConnections=function(e){for(var t=Object.keys(F.connections),r=U.isRegExp(e),n=[],o=0,i=t.length;o<i;o++){var s=t[o];e?r?e.test(s)&&n.push(F.connections[s]):s.indexOf(e)!==-1&&n.push(F.connections[s]):n.push(F.connections[s])}return n},F.onValidate=null,F.onParseXML=function(e){var t=U.parseXML(e);return F._length_convertors&&F.convert(t),t},F.onParseXML.$def=!0,F.$onParseXML=function(e){F.onParseXML.$def?(e.body=U.parseXML(e.buffer_data),F._length_convertors&&F.convert(e.body)):e.body=F.onParseXML(e.buffer_data)},F.onParseJSON=function(e){return JSON.parse(e)},F.onParseJSON.$def=!0,F.$onParseJSON=function(e){e.body=F.onParseJSON.$def?JSON.parse(e.buffer_data):F.onParseJSON(e.buffer_data)},F.onParseQuery=function(e){if(e){var t=Qs.parse(e,null,null,QUERYPARSEROPTIONS);return F._length_convertors&&F.convert(t),t}return{}},F.onParseQuery.$def=!0,F.$onParseQueryBody=function(e){F.onParseQuery.$def?e.buffer_data?(e.body=Qs.parse(e.buffer_data,null,null,QUERYPARSEROPTIONS),F._length_convertors&&F.convert(e.body)):e.body={}:e.body=F.onParseQuery(e.buffer_data,e)},F.$onParseQueryUrl=function(e){F.onParseQuery.$def?(e._querydata=Qs.parse(e.uri.query,null,null,QUERYPARSEROPTIONS),F._length_convertors&&F.convert(e._querydata)):e._querydata=F.onParseQuery(e.uri.query,e)},F.onSchema=function(e,t,r,n,o,i){var s=GETSCHEMA(t,r);s?s.make(e.body,o,onSchema_callback,n,i):n(new Error('Schema "'+t+'/'+r+'" not found.'))},F.onMail=function(e,t,r,n,o){var i;'string'==typeof n&&(i=o,o=n,n=i);var s=Mail.create(t,r);if(e instanceof Array)for(var a=0,c=e.length;a<c;a++)s.to(e[a]);else s.to(e);s.from(F.config['mail-address-from']||'',F.config.name),o?s.reply(o):(i=F.config['mail-address-reply'],i&&i.length>3&&s.reply(i)),i=F.config['mail-address-copy'],i&&i.length>3&&s.bcc(i);var u=F.temporary['mail-settings'];if(!u){var l=F.config['mail-smtp-options'];l&&(u=l),F.temporary['mail-settings']=u||{}}return s.$sending=setTimeout(function(){return s.send(F.config['mail-smtp'],u,n)},5),s},F.onMeta=function(){for(var e='',t=arguments.length,r=this,n=0;n<t;n++){var o=U.encode(arguments[n]);if(null!=o&&o.length)switch(n){case 0:e+='<title>'+(o+('/'===F.url||F.config['allow-custom-titles']?'':' - '+F.config.name))+'</title>';break;case 1:e+='<meta name="description" content="'+o+'" />';break;case 2:e+='<meta name="keywords" content="'+o+'" />';break;case 3:var i=o.substring(0,6),s='http:/'===i||'https:'===i||'//'===o.substring(0,2)?o:r.hostname(r.routeImage(o));e+='<meta property="og:image" content="'+s+'" /><meta name="twitter:image" content="'+s+'" />'}}return e},F.log=function(){F.datetime=new Date;for(var e=F.datetime.getFullYear()+'-'+(F.datetime.getMonth()+1).toString().padLeft(2,'0')+'-'+F.datetime.getDate().toString().padLeft(2,'0'),t=F.datetime.getHours().toString().padLeft(2,'0')+':'+F.datetime.getMinutes().toString().padLeft(2,'0')+':'+F.datetime.getSeconds().toString().padLeft(2,'0'),r='',n=arguments.length,o=0;o<n;o++){var i=arguments[o];void 0===i?i='undefined':null===i?i='null':'object'===('undefined'==typeof i?'undefined':_typeof(i))&&(i=Util.inspect(i)),r+=(r?' ':'')+i}return F.path.verify('logs'),U.queue('F.log',5,function(n){return Fs.appendFile(U.combine(F.config['directory-logs'],e+'.log'),t+' | '+r+'\n',n)}),F},F.logger=function(){var e=arguments;F.datetime=new Date;for(var t=F.datetime.getFullYear()+'-'+(F.datetime.getMonth()+1).toString().padLeft(2,'0')+'-'+F.datetime.getDate().toString().padLeft(2,'0')+' '+F.datetime.getHours().toString().padLeft(2,'0')+':'+F.datetime.getMinutes().toString().padLeft(2,'0')+':'+F.datetime.getSeconds().toString().padLeft(2,'0'),r='',n=arguments.length,o=1;o<n;o++){var i=arguments[o];void 0===i?i='undefined':null===i?i='null':'object'===('undefined'==typeof i?'undefined':_typeof(i))&&(i=Util.inspect(i)),r+=(r?' ':'')+i}return F.path.verify('logs'),U.queue('F.logger',5,function(n){return Fs.appendFile(U.combine(F.config['directory-logs'],e[0]+'.log'),t+' | '+r+'\n',n)}),F},F.logmail=function(e,t,r,n){('undefined'==typeof r?'undefined':_typeof(r))===FUNCTION?(n=r,r=t,t=null):void 0===r&&(r=t,t=null),t||(t=F.config.name+' v'+F.config.version);var r='<!DOCTYPE html><html><head><title>'+t+'</title><meta charset="utf-8" /></head><body><pre style="max-width:600px;font-size:13px;line-height:16px">'+('object'===('undefined'==typeof r?'undefined':_typeof(r))?JSON.stringify(r).escape():r)+'</pre></body></html>';return F.onMail(e,t,r,n)},F.usage=function(e){var t=process.memoryUsage(),r=Object.keys(F.cache.items),n=Object.keys(F.resources),o=Object.keys(F.controllers),i=Object.keys(F.connections),s=Object.keys(F.workers),a=Object.keys(F.modules),c=Object.keys(F.isomorphic),u=Object.keys(F.models),l=Object.keys(F.helpers),p=Object.keys(F.temporary.path),f=Object.keys(F.temporary.notfound),d=Object.keys(F.temporary.range),h=Object.keys(F.routes.redirects),m=Object.keys(F.temporary.defer),g={};g.framework={datetime:F.datetime,pid:process.pid,node:process.version,version:'v'+F.version_header,platform:process.platform,processor:process.arch,uptime:Math.floor(process.uptime()/60),memoryTotal:(t.heapTotal/1024/1024).floor(2),memoryUsage:(t.heapUsed/1024/1024).floor(2),memoryRss:(t.rss/1024/1024).floor(2),mode:F.config.debug?'debug':'release',port:F.port,ip:F.ip,directory:process.cwd()};for(var v=Object.keys(U.queuecache),y=0,b=0,E=v.length;b<E;b++)y+=U.queuecache[v[b]].pending.length;return g.counter={resource:n.length,controller:o.length,module:a.length,isomorphic:c.length,cache:r.length,worker:s.length,connection:i.length,schedule:F.schedules.length,helpers:l.length,error:F.errors.length,problem:F.problems.length,queue:y,files:p.length,notfound:f.length,streaming:d.length,modificator:F.modificators?F.modificators.length:0,viewphrases:$VIEWCACHE.length,uptodates:F.uptodates?F.uptodates.length:0,defer:m.length},g.routing={webpage:F.routes.web.length,sitemap:F.routes.sitemap?Object.keys(F.routes.sitemap).length:0,websocket:F.routes.websockets.length,file:F.routes.files.length,middleware:Object.keys(F.routes.middleware).length,redirect:h.length,mmr:Object.keys(F.routes.mmr).length},g.stats=F.stats,g.redirects=h,e?(g.controllers=[],o.forEach(function(e){var t=F.controllers[e];g.controllers.push({name:e,usage:t.usage?t.usage():null})}),g.connections=[],i.forEach(function(e){g.connections.push({name:e,online:F.connections[e].online})}),g.modules=[],a.forEach(function(e){var t=F.modules[e];g.modules.push({name:e,usage:t.usage?t.usage():null})}),g.models=[],u.forEach(function(e){var t=F.models[e];g.models.push({name:e,usage:t.usage?t.usage():null})}),g.uptodates=F.uptodates,g.helpers=l,g.cache=r,g.resources=n,g.errors=F.errors,g.problems=F.problems,g.changes=F.changes,g.traces=F.traces,g.files=p,g.streaming=d,g.other=Object.keys(F.temporary.other),g):g},F.onCompileView=function(e,t,r){return t},F.onCompileStyle=null,F.onCompileScript=null,F.compile_file=function(e){return fsFileRead(e.options.filename,function(t,r){var n=e.req,o=n.uri;if(t)return F.error(t,e.options.filename,o),F.temporary.notfound[n.$key]=!0,delete F.temporary.processing[n.$key],void e.$file();var i=F.path.temp((F.id?'i-'+F.id+'_':'')+createTemporaryKey(o.pathname));F.path.verify('temp'),Fs.writeFileSync(i,F.compile_content(n.extension,framework_internal.parseBlock(F.routes.blocks[o.pathname],r.toString(ENCODING)),e.options.filename),ENCODING);var s=Fs.statSync(i);F.temporary.path[n.$key]=[i,s.size,s.mtime.toUTCString()],delete F.temporary.processing[n.$key],e.$file()}),F},F.compile_merge=function(e){var t=e.req,r=t.uri,n=F.routes.merge[r.pathname],o=n.filename;if(!F.config.debug&&existsSync(o)){var i=Fs.statSync(o);return F.temporary.path[t.$key]=[o,i.size,i.mtime.toUTCString()],delete F.temporary.processing[t.$key],void e.$file()}var s=Fs.createWriteStream(o);s.on('finish',function(){var r=Fs.statSync(o);F.temporary.path[t.$key]=[o,r.size,r.mtime.toUTCString()],delete F.temporary.processing[t.$key],e.$file()});var a=0,c=null;return n.files.wait(function(e,o){var i;if('#'!==e[0]){var u=e.split('#');i=u[1],i&&(e=u[0])}if(e.startsWith('http://')||e.startsWith('https://'))return void U.request(e,FLAGS_DOWNLOAD,function(r,n){var c=F.compile_content(t.extension,framework_internal.parseBlock(i,n),e);'js'===t.extension?';'!==c[c.length-1]&&(c+=';'):'html'===t.extension&&c[c.length-1]!==NEWLINE&&(c+=NEWLINE),DEBUG&&merge_debug_writer(s,e,t.extension,a++,i),s.write(c),o()});if('~'!==e[0]){var l=F.path.public(e);F.isVirtualDirectory&&!existsSync(l)&&(l=F.path.virtual(e)),e=l}else e=e.substring(1);var p=e.indexOf('*');if(p!==-1){var l=e.substring(p+1).toLowerCase(),f=l.length;return!c&&(c=[]),c.push(arguments[0]),void U.ls(e.substring(0,p),function(e){for(var t=0,r=e.length;t<r;t++)n.files.push('~'+e[t]);o()},function(e,t){return!!t||e.substring(e.length-f).toLowerCase()===l})}fsFileRead(e,function(c,u){if(c)return F.error(c,n.filename,r),void o();var l=F.compile_content(t.extension,framework_internal.parseBlock(i,u.toString(ENCODING)),e);'js'===t.extension?';'!==l[l.length-1]&&(l+=';'):'html'===t.extension&&l[l.length-1]!==NEWLINE&&(l+=NEWLINE),DEBUG&&merge_debug_writer(s,e,t.extension,a++,i),s.write(l),o()})},function(){if(s.end(),c)for(var e=0,t=c.length;e<t;e++)n.files.splice(n.files.indexOf(c[e]),1)}),F},F.compile_virtual=function(e){var t=e.req,r=e.options.filename.replace(F.config['directory-public'],F.config['directory-public-virtual']);return r===e.options.filename?(F.temporary.notfound[t.$key]=!0,delete F.temporary.processing[t.$key],void e.$file()):void fsFileExists(r,function(n,o,i,s){return n?void(e.noCompress||'js'!==t.extension&&'css'!==t.extension||REG_NOCOMPRESS.test(e.options.filename)?(F.temporary.path[t.$key]=[r,o,s.mtime.toUTCString()],delete F.temporary.processing[t.$key],e.$file()):(e.options.filename=r,F.compile_file(e))):(F.temporary.notfound[t.$key]=!0,delete F.temporary.processing[t.$key],void e.$file())})},F.compile_check=function(e){var t=e.req,r=t.uri;return F.routes.merge[r.pathname]?(F.compile_merge(e),F):(fsFileExists(e.options.filename,function(r,n,o,i){if(r){if(!(e.noCompress||'js'!==t.extension&&'css'!==t.extension||REG_NOCOMPRESS.test(e.options.filename)))return F.compile_file(e);F.temporary.path[t.$key]=[e.options.filename,n,i.mtime.toUTCString()],delete F.temporary.processing[t.$key],e.$file()}else F.isVirtualDirectory?F.compile_virtual(e):(F.temporary.notfound[t.$key]=!0,delete F.temporary.processing[t.$key],e.$file())}),F)},F.compile_content=function(e,t,r){if(r&&REG_NOCOMPRESS.test(r))return t;switch(e){case'js':return F.config['allow-compile-script']?framework_internal.compile_javascript(t,r):t;case'css':t=F.config['allow-compile-style']?framework_internal.compile_css(t,r):t;var n=t.match(REG_COMPILECSS);if(n)for(var o=0,i=n.length;o<i;o++){var s=n[o],a=s.substring(4,s.length-1);t=t.replace(s,'url('+F.$version(a)+')')}return t}return t},F.responseStatic=function(e,t,r){return t.options.callback=r,t.continue(),F},F.restore=function(e,t,r,n){var o=new Backup;o.restore(e,t,r,n)},F.backup=function(e,t,r,n){var o=t.length,i=120;return U.ls(t,function(t,s){s.wait(function(t,r){var s=t.substring(o).replace(/\\/g,'/')+'/';return n&&!n(s)?r():void Fs.appendFile(e,s.padRight(i)+':#\n',r)},function(){t.wait(function(t,r){var s=t.substring(o).replace(/\\/g,'/');return n&&!n(s)?r():void Fs.readFile(t,function(t,n){Zlib.gzip(n,function(t,n){return t?(F.error(t,'F.backup()',e),r()):void Fs.appendFile(e,s.padRight(i)+':'+n.toString('base64')+'\n',r)})})},r)})}),this},F.exists=function(e,t,r,n){'function'==typeof r&&(n=r,r=10);var o=e.$key=createTemporaryKey(e),i=F.path.temp(o),s=!1;return RELEASE&&e.headers['if-none-match']===ETAG+F.config['etag-version']&&(s=!0),F.isProcessed(o)||s?(t.options.filename=i,t.$file(),F):(U.queue('F.exists',r,function(r){fsFileExists(i,function(o){o?(t.options.filename=i,t.options.callback=r,t.$file()):n(r,i,e,t)})}),F)},F.isProcessed=function(e){if(e.url){var t=e.url,r=t.indexOf('?');r!==-1&&(t=t.substring(0,r)),e=F.path.public($decodeURIComponent(t))}return!F.temporary.notfound[e]&&void 0!==F.temporary.path[e]},F.isProcessing=function(e){if(!e.url)return!!F.temporary.processing[e];var t=e.url,r=t.indexOf('?');return r!==-1&&(t=t.substring(0,r)),e=U.combine(F.config['directory-public'],$decodeURIComponent(t)),!!F.temporary.processing[e]},F.noCache=function(e,t){return e.noCache(),t&&t.noCache(),F},F.responseFile=function(e,t,r,n,o,i,s){return t.$key=s,t.options.filename=r,t.options.download=n,t.options.headers=o,t.options.callback=i,t.$file(),F},F.touch=function(e){if(e){var t=createTemporaryKey(e);delete F.temporary.path[t],delete F.temporary.notfound[t]}else F.temporary.path={},F.temporary.notfound={};return F},F.responsePipe=function(e,t,r,n,o,i){return t.pipe(r,n,o,i),F},F.responseCustom=function(e,t){return t.$custom(),F},F.responseImage=function(e,t,r,n,o,i){return'object'===('undefined'==typeof r?'undefined':_typeof(r))?t.options.stream=r:t.options.filename=r,t.options.headers=o,t.options.callback=i,t.options.make=n,t.$image(),F},F.responseImageWithoutCache=function(e,t,r,n,o,i){'object'===('undefined'==typeof r?'undefined':_typeof(r))?t.options.stream=r:t.options.filename=r,t.options.headers=o,t.options.callback=i,t.options.make=n,t.options.cache=!1,t.$image()},F.responseStream=function(e,t,r,n,o,i,s,a){return t.options.type=r,t.options.stream=n,t.options.download=o,t.options.headers=i,t.options.compress=!a,t.options.callback=s,t.$stream(),F},F.responseBinary=function(e,t,r,n,o,i,s,a){return t.options.type=r,t.options.body=n,t.options.encoding=o,t.options.download=i,t.options.headers=s,t.options.callback=a,t.$binary(),F},F.setModified=function(e,t,r){return'string'==typeof r?t.setHeader('Etag',r+F.config['etag-version']):t.setHeader('Last-Modified',r.toUTCString()),F},F.notModified=function(e,t,r,n){var o='undefined'==typeof r?'undefined':_typeof(r);if('boolean'===o){var i=r;r=n,n=i,o='undefined'==typeof r?'undefined':_typeof(r)}var s='string'===o,a=e.headers[s?'if-none-match':'if-modified-since'];if(s){if(a!==r+F.config['etag-version'])return!1}else{if(!a)return!1;var c=void 0===r?(new Date).toUTCString():r.toUTCString();if(n){if(new Date(Date.parse(a))===new Date(c))return!1}else if(new Date(Date.parse(a))<new Date(c))return!1}var u;return s?(u=HEADERS.notModifiedEtag,u.Etag=a):(u=HEADERS.notModifiedLastModifiedDate,u['Last-Modified']=a),t.success=!0,t.writeHead(304,u),t.end(),F.stats.response.notModified++,response_end(t),!0},F.responseCode=function(e,t,r,n){return t.options.code=r,n&&(t.options.problem=n),t.$throw(),F},F.response400=function(e,t,r){return t.options.code=400,r&&(t.options.problem=r),t.$throw(),F},F.response401=function(e,t,r){return t.options.code=401,r&&(t.options.problem=r),t.$throw(),F},F.response403=function(e,t,r){return t.options.code=403,r&&(t.options.problem=r),t.$throw(),F},F.response404=function(e,t,r){return t.options.code=404,r&&(t.options.problem=r),t.$throw(),F},F.response408=function(e,t,r){return t.options.code=408,r&&(t.options.problem=r),t.$throw(),F},F.response431=function(e,t,r){return t.options.code=431,r&&(t.options.problem=r),t.$throw(),F},F.response500=function(e,t,r){return t.throw500(r),F},F.response501=function(e,t,r){return t.options.code=501,r&&(t.options.problem=r),t.$throw(),F},F.response503=function(e,t){var r='';for(var n in F.waits)r+=(t.options.body?', ':'')+'<u>'+n+'</u>';return t.options.code=503,t.options.headers=HEADERS.response503,t.options.body='<html><head><meta charset="utf-8" /></head><body style="font:normal normal 11px Arial;color:gray;line-height:16px;padding:10px;background-color:white"><div style="font-size:14px;color:#505050">Please wait (<span id="time">10</span>) for <b>'+(F.config.name+' v'+F.config.version)+'</b> application.</div>The application is waiting for: '+r+'.<script>var i=10;setInterval(function(){i--;if(i<0)return;document.getElementById("time").innerHTML=(i===0?"refreshing":i);if(i===0)window.location.reload();},1000);</script></body></html>',t.$throw(),F},F.responseContent=function(e,t,r,n,o,i,s){return t.options.code=r,t.options.body=n,t.options.type=o,t.options.compress=void 0===i||i===!0,t.options.headers=s,t.$text(),F},F.responseRedirect=function(e,t,r,n){return t.options.url=r,t.options.permanent=n,t.$redirect(),F},F.load=function(e,t,r){return r&&'.'===r[0]&&r.length<4?F.directory=directory=U.$normalize(Path.normalize(directory+'/..')):r&&(F.directory=directory=U.$normalize(r)),F.isWorker=!0,F.config.debug=e,F.isDebug=e,global.DEBUG=e,global.RELEASE=!e,global.I=global.isomorphic=F.isomorphic,F.consoledebug('startup'),F.$startup(function(){F.consoledebug('startup (done)'),F.$configure_configs(),t&&t.indexOf('versions')===-1||F.$configure_versions(),t&&t.indexOf('workflows')===-1||F.$configure_workflows(),t&&t.indexOf('sitemap')===-1||F.$cofnigure_sitemap(),F.consoledebug('init'),F.cache.init(),F.emit('init'),F.isLoaded=!0,F.$load(t,directory,function(){setTimeout(function(){try{F.emit('load',F),F.emit('ready',F)}catch(e){F.error(e,'F.on("load/ready")')}F.removeAllListeners('load'),F.removeAllListeners('ready'),delete F.tests,delete F.test,delete F.testing,delete F.assert},500),F.config['allow-debug']&&(F.consoledebug('done'),F.usagesnapshot())})}),F},F.initialize=function(e,t,r,n){r||(r={});var o=r.port,i=r.ip;if(r.config&&U.copy(r.config,F.config),(r.debug||r['allow-debug'])&&(F.config['allow-debug']=!0),F.isHTTPS='undefined'==typeof e.STATUS_CODES,isNaN(o)&&'string'!=typeof o&&(o=null),F.config.debug=t,F.isDebug=t,global.DEBUG=t,global.RELEASE=!t,global.I=global.isomorphic=F.isomorphic,F.$configure_configs(),F.$configure_versions(),F.$configure_workflows(),F.$cofnigure_sitemap(),F.isTest&&F.$configure_configs('config-test',!1),F.cache.init(),F.consoledebug('init'),F.emit('init'),!o)if('auto'===F.config['default-port']){var s=+(process.env.PORT||'');isNaN(s)||(o=s)}else o=F.config['default-port'];return F.port=o||8e3,null!==i?(F.ip=i||F.config['default-ip']||'127.0.0.1','null'!==F.ip&&'undefined'!==F.ip&&'auto'!==F.ip||(F.ip=void 0)):F.ip=void 0,null==F.ip&&(F.ip='auto'),F.server&&(F.server.removeAllListeners(),Object.keys(F.connections).forEach(function(e){var t=F.connections[e];t&&(t.removeAllListeners(),t.close())}),F.server.close()),r.https?F.server=e.createServer(r.https,F.listener):F.server=e.createServer(F.listener),F.config['allow-performance']&&F.server.on('connection',connection_tunning),F.config['allow-websocket']&&F.server.on('upgrade',F._upgrade),F.consoledebug('HTTP listening'),F.server.listen(F.port,'auto'===F.ip?void 0:F.ip),F.consoledebug('clear temporary'),F.clear(function(){F.consoledebug('clear temporary (done)'),F.$load(void 0,directory,function(){if(F.isLoaded=!0,F.config['allow-debug']&&(F.consoledebug('done'),F.usagesnapshot()),process.connected&&!n||F.console(),setTimeout(function(){try{F.emit('load',F),F.emit('ready',F)}catch(e){F.error(e,'F.on("load/ready")')}F.removeAllListeners('load'),F.removeAllListeners('ready'),r.package&&INSTALL('package',r.package)},500),F.isTest){var e=r.sleep||r.delay||1e3;return global.TEST=!0,global.assert=require('assert'),setTimeout(function(){return F.test(!0,r.tests||r.test)},e),F}setTimeout(function(){F.isTest||(delete F.tests,delete F.test,delete F.testing,delete F.assert)},5e3)})},!0),F},F.http=function(e,t){return F.consoledebug('begin'),null==t&&(t={}),!t.port&&(t.port=+process.argv[2]),F.mode(require('http'),e,t)},F.https=function(e,t){return F.consoledebug('begin'),F.mode(require('https'),e,t||{})},F.mode=function(e,t,r){
var n=!1;if(r.directory&&(F.directory=directory=r.directory),'string'==typeof e){switch(e){case'debug':case'development':n=!0}return F.config.debug=n,F.config.trace=n,F.isDebug=n,global.DEBUG=n,global.RELEASE=!n,F}switch(F.isWorker=!1,t.toLowerCase().replace(/\.|\s/g,'-')){case'release':case'production':break;case'debug':case'develop':case'development':n=!0;break;case'test':case'testing':case'test-debug':case'debug-test':case'testing-debug':n=!0,F.isTest=!0;break;case'test-release':case'release-test':case'testing-release':case'test-production':case'testing-production':n=!1}var o=!1;return F.temporary.init?o=!0:F.temporary.init={name:t,isHTTPS:'undefined'==typeof e.STATUS_CODES,options:r},F.config.trace=n,F.consoledebug('startup'),F.$startup(function(){F.consoledebug('startup (done)'),F.initialize(e,n,r,o)}),F},F.console=function(){console.log('===================================================='),console.log('PID         : '+process.pid),console.log('Node.js     : '+process.version),console.log('Total.js    : v'+F.version_header),console.log('OS          : '+Os.platform()+' '+Os.release()),console.log('===================================================='),console.log('Name        : '+F.config.name),console.log('Version     : '+F.config.version),console.log('Author      : '+F.config.author),console.log('Date        : '+F.datetime.format('yyyy-MM-dd HH:mm:ss')),console.log('Mode        : '+(F.config.debug?'debug':'release')),console.log('====================================================\n'),console.log('{2}://{0}:{1}/'.format(F.ip,F.port,F.isHTTPS?'https':'http')),console.log('')},F.usagesnapshot=function(e){return Fs.writeFile(e||F.path.root('usage.log'),JSON.stringify(F.usage(!0),null,'    '),NOOP),F},F.consoledebug=function(){if(!F.config['allow-debug'])return F;for(var e=[(new Date).format('yyyy-MM-dd HH:mm:ss'),'--------->'],t=0;t<arguments.length;t++)e.push(arguments[t]);return console.log.apply(console,e),F},F.reconnect=function(){return void 0!==F.config['default-port']&&(F.port=F.config['default-port']),void 0!==F.config['default-ip']&&(F.ip=F.config['default-ip']),F.server.close(function(){return F.server.listen(F.port,F.ip)}),F},F.service=function(e){UIDGENERATOR.date=F.datetime.format('yyMMddHHmm'),UIDGENERATOR.index=1;var t=!1;if(F.temporary.notfound={},e%F.config['default-interval-clear-cache']===0){F.$events.clear&&F.emit('clear','temporary',F.temporary),F.temporary.path={},F.temporary.range={},F.temporary.views={},F.temporary.other={},global.$VIEWCACHE&&global.$VIEWCACHE.length&&(global.$VIEWCACHE=[]),Image.clear();var r=F.datetime.add('-5 minutes');for(var n in F.databases)F.databases[n]&&F.databases[n].inmemorylastusage<r&&F.databases[n].release();t=!0,F.config['allow-debug']&&F.consoledebug('clear temporary cache')}if(e%F.config['default-interval-precompile-views']===0)for(var n in F.routes.views){var o=F.routes.views[n];F.install('view',n,o.url,null)}e%F.config['default-interval-clear-dnscache']===0&&(F.$events.clear&&F.emit('clear','dns'),U.clearDNS(),F.config['allow-debug']&&F.consoledebug('clear DNS cache'));var i=F.config['default-interval-websocket-ping'];if(i>0&&e%i===0){var s=!1;for(var o in F.connections){var a=F.connections[o];a&&(a.check(),a.ping(),s=!0)}s&&F.config['allow-debug']&&F.consoledebug('ping websocket connections')}if(F.uptodates&&e%F.config['default-interval-uptodate']===0&&F.uptodates.length){var c=!1;F.uptodates.wait(function(e,t){return e.updated.add(e.interval)>F.datetime?t():(e.updated=F.datetime,e.count++,void setTimeout(function(){F.config['allow-debug']&&F.consoledebug('uptodate',e.type+'#'+e.url),F.install(e.type,e.url,e.options,function(r,n,o){return F.config['allow-debug']&&F.consoledebug('uptodate',e.type+'#'+e.url+' (done)'),o?t():(r?(e.errors.push(r),e.errors.length>50&&F.errors.shift()):(c=!0,e.name=n,F.$events.uptodate&&F.emit('uptodate',e.type,n)),e.callback&&e.callback(r,n),void t())},void 0,void 0,void 0,void 0,e.name)},e.name?500:1))},function(){c&&(F.temporary.path={},F.temporary.range={},F.temporary.views={},F.temporary.other={},global.$VIEWCACHE&&global.$VIEWCACHE.length&&(global.$VIEWCACHE=[]))})}if(e%F.config['default-interval-clear-resources']===0&&(F.$events.clear&&F.emit('clear','resources'),F.resources={},t=!0,F.config['allow-debug']&&F.consoledebug('clear resources')),e%1e3===0&&(DATE_EXPIRES=F.datetime.add('y',1).toUTCString()),F.$events.service&&F.emit('service',e),F.config['allow-debug']&&(F.consoledebug('service ({0}x)'.format(e)),F.usagesnapshot()),t&&global.gc&&setTimeout(function(){global.gc(),F.config['allow-debug']&&F.consoledebug('gc()')},1e3),!F.schedules.length)return F;for(var u=F.datetime.getTime(),l=0;;){var p=F.schedules[l++];if(!p)break;p.expire>u||(l--,p.repeat?p.expire=F.datetime.add(p.repeat):F.schedules.splice(l,1),F.config['allow-debug']&&F.consoledebug('schedule',p.id),p.fn.call(F))}return F},F.listener=function(e,t){if(e.options=t.options={},t.req=e,e.res=t,F._length_wait)return F.response503(e,t);if(!e.host)return t.throw400();var r=e.headers;if(e.$protocol=e.connection.encrypted||'https'===r['x-forwarded-protocol']?'https':'http',e.uri=framework_internal.parseURI(e),F.stats.request.request++,F.$events.request&&F.emit('request',e,t),F._request_check_redirect){var n=F.routes.redirects[e.$protocol+'://'+e.host];if(n)return F.stats.response.forward++,t.options.url=n.url+(n.path?e.url:''),t.options.permanent=n.permanent,void t.$redirect()}e.path=framework_internal.routeSplit(e.uri.pathname),e.processing=0,e.isAuthorized=!0,e.xhr='XMLHttpRequest'===r['x-requested-with'],t.success=!1,e.session=null,e.user=null,e.isStaticFile=F.config['allow-handle-static-files']&&U.isStaticFile(e.uri.pathname),e.isStaticFile?e.extension=U.getExtension(e.uri.pathname):F.onLocale&&(e.$language=F.onLocale(e,t,e.isStaticFile)),F.reqstats(!0,!0),F._length_request_middleware?async_middleware(0,e,t,F.routes.request,requestcontinue_middleware):F.$requestcontinue(e,t,r)},F.$requestcontinue=function(e,t,r){if(e&&t&&!t.headersSent&&!t.success){if(e.isStaticFile)return F.stats.request.file++,F._length_files?new Subscribe(F,e,t,3).file():t.continue(),F;e.body=EMPTYOBJECT,e.files=EMPTYARRAY,e.isProxy='total.js'===r['x-proxy'],e.buffer_exceeded=!1,e.buffer_has=!1,e.$flags=e.method[0]+e.method[1],F.stats.request.web++;var n=[e.method.toLowerCase()],o=e.headers['content-type']||'';e.mobile?(e.$flags+='a',F.stats.request.mobile++):F.stats.request.desktop++,e.$protocol[5]&&(e.$flags+=e.$protocol[5]),e.$type=0,n.push(e.$protocol);var i=e.method,s=i[0];if('P'===s||'D'===s){e.buffer_data=U.createBuffer();var a=o.lastIndexOf(';'),c=o;switch(a!==-1&&(c=c.substring(0,a)),c.substring(c.length-4)){case'json':e.$flags+='b',n.push('json'),e.$type=1,o='';break;case'oded':e.$type=3,o='';break;case'data':e.$flags+='c',e.$upload=!0,n.push('upload');break;case'/xml':e.$flags+='d',n.push('xml'),e.$type=2,o='';break;case'lace':e.$type=4,n.push('mmr'),e.$flags+='e';break;default:o?(o='',n.push('raw')):(e.$type=3,o='')}}if(e.isProxy&&(e.$flags+='f',n.push('proxy')),'text/event-stream'===r.accept&&(e.$flags+='g',n.push('sse')),F.config.debug&&(e.$flags+='h',n.push('debug')),e.xhr&&(F.stats.request.xhr++,e.$flags+='i',n.push('xhr')),F._request_check_robot&&e.robot&&(e.$flags+='j'),F._request_check_referer){var u=r.referer;u&&u.indexOf(r.host)!==-1&&(e.$flags+='k',n.push('referer'))}e.flags=n,F.$events['request-begin']&&F.emit('request-begin',e,t);var l=F._length_cors&&e.headers.origin;switch(s){case'G':return F.stats.request.get++,l?F.$cors(e,t,cors_callback0):new Subscribe(F,e,t,0).end(),F;case'O':return F.stats.request.options++,l?F.$cors(e,t,cors_callback0):new Subscribe(framework,e,t,0).end(),F;case'H':return F.stats.request.head++,l?F.$cors(e,t,cors_callback0):new Subscribe(F,e,t,0).end(),F;case'D':return F.stats.request.delete++,l?F.$cors(e,t,cors_callback1):new Subscribe(F,e,t,1).urlencoded(),F;case'P':if(F._request_check_POST)return o?(l?F.$cors(e,t,cors_callback_multipart,o):4===e.$type?F.$requestcontinue_mmr(e,t,o):new Subscribe(F,e,t,2).multipart(o),F):('PUT'===i?F.stats.request.put++:'PATCH'===i?F.stats.request.path++:F.stats.request.post++,l?F.$cors(e,t,cors_callback1):new Subscribe(F,e,t,1).urlencoded(),F)}return F.$events['request-end']&&F.emit('request-end',e,t),F.reqstats(!1,!1),F.stats.request.blocked++,t.writeHead(403),t.end(),F}},F.$requestcontinue_mmr=function(e,t,r){var n=F.routes.mmr[e.url];return F.stats.request.mmr++,n?(F.path.verify('temp'),void framework_internal.parseMULTIPART_MIXED(e,r,F.config['directory-temp'],n.exec)):(F.$events['request-end']&&F.emit('request-end',e,t),F.reqstats(!1,!1),F.stats.request.blocked++,t.writeHead(403),void t.end())},F.$cors=function(e,t,r,n){for(var o,i=!1,s=0;s<F._length_cors;s++)if(o=F.routes.cors[s],framework_internal.routeCompare(e.path,o.url,!1,o.isASTERIX)){i=!0;break}if(!i)return r(e,t,n);var a=!1,c=e.headers;if(i||(a=!0),i=!1,!a&&o.headers){i=!1;for(var s=0,u=o.headers.length;s<u;s++)if(c[o.headers[s]]){i=!0;break}i||(a=!0)}if(!a&&o.methods){i=!1;var l=c['access-control-request-method']||e.method;if('OPTIONS'!==l){for(var s=0,u=o.methods.length;s<u;s++)if(l.indexOf(o.methods[s])!==-1){i=!0;break}i||(a=!0)}}var p=c.origin.toLowerCase();if(!a&&o.origins){i=!1;for(var s=0,u=o.origins.length;s<u;s++)if(o.origins[s].indexOf(p)!==-1){i=!0;break}i||(a=!0)}var f,d='OPTIONS'===e.method;return t.setHeader('Access-Control-Allow-Origin',o.origins?o.origins:o.credentials?i?p:o.origins?o.origins:p:c.origin),o.credentials&&t.setHeader('Access-Control-Allow-Credentials','true'),f='Access-Control-Allow-Methods',o.methods?t.setHeader(f,o.methods.join(', ')):t.setHeader(f,d?c['access-control-request-method']||'*':e.method),f='Access-Control-Allow-Headers',o.headers?t.setHeader(f,o.headers.join(', ')):t.setHeader(f,c['access-control-request-headers']||'*'),o.age&&t.setHeader('Access-Control-Max-Age',o.age),a?(r=null,F.$events['request-end']&&F.emit('request-end',e,t),F.reqstats(!1,!1),F.stats.request.blocked++,t.writeHead(404),void t.end()):d?(r=null,F.$events['request-end']&&F.emit('request-end',e,t),F.reqstats(!1,!1),t.writeHead(200),t.end(),F):r(e,t,n)},F._upgrade=function(e,t,r){if('websocket'===(e.headers.upgrade||'').toLowerCase()){t.setTimeout(0),t.on('error',NOOP);var n=e.headers;e.$protocol=e.connection.encrypted||'https'===n['x-forwarded-protocol']?'https':'http',e.uri=framework_internal.parseURI(e),F.$events.websocket&&F.emit('websocket',e,t,r),F.stats.request.websocket++,e.session=null,e.user=null,e.flags=[e.secured?'https':'http','get'],e.$wspath=U.path(e.uri.pathname);var o=new WebSocketClient(e,t,r);e.path=framework_internal.routeSplit(e.uri.pathname),e.websocket=o,F.onLocale&&(e.$language=F.onLocale(e,t)),F._length_request_middleware?async_middleware(0,e,e.websocket,F.routes.request,websocketcontinue_middleware):F.$websocketcontinue(e,e.$wspath,n)}},F.$websocketcontinue=function(e,t){var r=F.onAuthorize;if(r)r.call(F,e,e.websocket,e.flags,function(r,n){n&&(e.user=n);var o=F.lookup_websocket(e,e.websocket.uri.pathname,r?1:2);o?F.$websocketcontinue_process(o,e,t):(e.websocket.close(),e.connection.destroy())});else{var n=F.lookup_websocket(e,e.websocket.uri.pathname,0);n?F.$websocketcontinue_process(n,e,t):(e.websocket.close(),e.connection.destroy())}},F.$websocketcontinue_process=function(e,t,r){var n=t.websocket;if(!n.prepare(e.flags,e.protocols,e.allow,e.length,F.version_header))return n.close(),void t.connection.destroy();var o=r+(e.flags.length?'#'+e.flags.join('-'):'');e.isBINARY?n.type=1:e.isJSON&&(n.type=3);var i=function(){if(F.connections[o])return void n.upgrade(F.connections[o]);var i=new WebSocket(r,e.controller,o);i.route=e,i.options=e.options,F.connections[o]=i,e.onInitialize.apply(i,framework_internal.routeParam(e.param.length?t.split:t.path,e)),process.nextTick(next_upgrade_continue,n,i)};e.middleware?async_middleware(0,t,t.websocket,e.middleware,i,e.options):i()},F.reqstats=function(e){return e?F.stats.request.pending++:F.stats.request.pending--,F.stats.request.pending<0&&(F.stats.request.pending=0),F},F.model=function(e){var t=F.models[e];if(t||null===t)return t;var r=U.combine(F.config['directory-models'],e+'.js');return existsSync(r)&&F.install('model',e,r,void 0,void 0,void 0,!0),F.models[e]||null},F.source=function(e,t,r){var n=F.sources[e];if(n||null===n)return n;var o=U.combine(F.config['directory-source'],e+'.js');return existsSync(o)&&F.install('source',e,o,t,r,void 0,!0),F.sources[e]||null},F.include=function(e,t,r){return F.source(e,t,r)},F.mail=function(e,t,r,n,o,i){if('string'==typeof o){var s=i;i=o,o=s}var a=EMPTYCONTROLLER;a.layoutName='',a.themeName=U.parseTheme(r),a.themeName?r=prepare_viewname(r):this.onTheme?a.themeName=this.onTheme(a):a.themeName='';var c;return'string'==typeof i&&(t=t.indexOf('@(')===-1?F.translate(i,t):F.translator(i,t),a.language=i),a.mail(e,t,r,n,o,c)},F.view=function(e,t,r,n,o){var i=EMPTYCONTROLLER;if('object'===('undefined'==typeof r?'undefined':_typeof(r))){var s=n;n=r,r=s}i.layoutName=r||'',i.language=o||'',i.repository='object'===('undefined'==typeof n?'undefined':_typeof(n))&&n?n:EMPTYOBJECT;var a=U.parseTheme(e);return a?(i.themeName=a,e=prepare_viewname(e)):this.onTheme?i.themeName=this.onTheme(i):i.themeName=void 0,i.view(e,t,!0)},F.viewCompile=function(e,t,r,n,o){var i=EMPTYCONTROLLER;if('object'===('undefined'==typeof r?'undefined':_typeof(r))){var s=n;n=r,r=s}return i.layoutName=r||'',i.language=o||'',i.themeName=void 0,i.repository='object'===('undefined'==typeof n?'undefined':_typeof(n))&&n?n:EMPTYOBJECT,i.viewCompile(e,t,!0)},F.assert=function(e,t,r,n,o,i,s){if('function'==typeof t)return F.tests.push({name:_test+': '+e,priority:F.testsPriority,index:F.tests.length,run:t}),F;var a='GET',c=0;if(s=s?U.extend({},s):{},r instanceof Array){c=r.length;for(var u=0;u<c;u++)switch(r[u].toLowerCase()){case'xhr':s['X-Requested-With']='XMLHttpRequest';break;case'referer':case'referrer':s.Referer=t;break;case'json':s['Content-Type']=CT_JSON;break;case'xml':s['Content-Type']='text/xml';break;case'get':case'head':case'options':a=r[u].toUpperCase(),o&&(t+='object'===('undefined'==typeof o?'undefined':_typeof(o))?'?'+Qs.stringify(o):'?'===o[0]?o:'?'+o,o='');break;case'upload':s['Content-Type']='multipart/form-data';break;case'robot':s['User-Agent']?s['User-Agent']+=' Bot':s['User-Agent']='Bot';break;case'mobile':s['User-Agent']?s['User-Agent']+=' iPhone':s['User-Agent']='iPhone';break;case'post':case'put':case'delete':a=r[u].toUpperCase(),s['Content-Type']||(s['Content-Type']='application/x-www-form-urlencoded');break;case'raw':s['Content-Type']='application/octet-stream'}}if(s['X-Assertion-Testing']='1',i){var l=[],p=Object.keys(i);c=p.length;for(var u=0;u<c;u++)l.push(p[u]+'='+encodeURIComponent(i[p[u]]));l.length&&(s.Cookie=l.join('; '))}var f={name:_test+': '+e,priority:F.testsPriority,index:F.tests.length,url:t,callback:n,method:a,data:o,headers:s};return F.tests.push(f),F},F.testing=function(e,t){if(void 0===e&&(e=!0),!F.tests.length){if(!F.testsFiles.length)return t&&t(F.isTestError===!0),e&&F.stop(F.isTestError?1:0),F;var r=F.testsFiles.shift();return r&&r.fn.call(F,F),F.testing(e,t),F}var n=function(e,t,r){var n=Math.floor(new Date-t)+' ms';r?(F.isTestError=!0,console.error('Failed [x] '.padRight(20,'.')+' '+e+' <'+(r.name.toLowerCase().indexOf('assert')!==-1?r.toString():r.stack)+'> ['+n+']')):console.info('Passed '.padRight(20,'.')+' '+e+' ['+n+']')},o=F.tests.shift(),i=o.name,s=new Date;if(o.run)return F.testContinue=function(r){n(i,s,r),r?F.testsNO++:F.testsOK++,F.testing(e,t)},o.run.call(F,function(){n(i,s),F.testsOK++,F.testing(e,t)},i),F;var a=function(r){r.on('data',function(e){this._buffer?(CONCAT[0]=this._buffer,CONCAT[1]=e,this._buffer=Buffer.concat(CONCAT)):this._buffer=e}),r.on('end',function(){r.removeAllListeners();var a=r.headers.cookie||'',c={};if(a.length)for(var u=a.split(';'),l=u.length,p=0;p<l;p++){var f=u[p].trim().split('=');c[f.shift()]=unescape(f.join('='))}try{o.callback(null,this._buffer?this._buffer.toString(ENCODING):'',r.statusCode,r.headers,c,i),n(i,s),F.testsOK++}catch(e){F.testsNO++,n(i,s,e)}F.testing(e,t)}),r.resume()},c=Parser.parse((o.url.startsWith('http://',!0)||o.url.startsWith('https://',!0)?'':'http://'+F.ip+':'+F.port)+o.url);'function'==typeof o.data&&(o.data=o.data()),'string'!=typeof o.data&&(o.data=(o.headers[HEADER_TYPE]||'').indexOf('json')!==-1?JSON.stringify(o.data):Qs.stringify(o.data));var u;o.data&&o.data.length&&(u=U.createBuffer(o.data),o.headers[HEADER_LENGTH]=u.length),c.method=o.method,c.headers=o.headers;var l='https:'===c.protocol?require('https'):http,p='POST'===o.method||'PUT'===o.method||'DELETE'===o.method||'PATCH'===o.method?l.request(c,a):l.get(c,a);return p.on('error',function(r){p.removeAllListeners(),n(i,s,r),F.testsNO++,F.testing(e,t)}),p.end(u),F},F.test=function(e,t,r){void 0===e&&(e=!0),'function'==typeof t?(r=t,t=[]):t=t||[];var n=0,o=F.config['directory-tests'];F.isTest=!0,F.$configure_configs('config-test',!0);var i=function(e,t,r){var n=Math.floor(new Date-t)+' ms';r?(F.isTestError=!0,console.error('Failed [x] '.padRight(20,'.')+' '+e+' <'+(r.name.toLowerCase().indexOf('assert')!==-1?r.toString():r.stack)+'> ['+n+']')):console.info('Passed '.padRight(20,'.')+' '+e+' ['+n+']')},s=function(){F.testsResults.length&&(console.log(''),console.log('===================== RESULTS ======================'),console.log(''),F.testsResults.forEach(function(e){return e()}))};return F.testsFiles=[],F.testsResults||(F.testsResults=[]),F.testsOK||(F.testsOK=0),F.testsNO||(F.testsNO=0),U.ls(U.combine(o),function(a){a.forEach(function(e){var r=Path.relative(U.combine(o),e),s=e,a=U.getExtension(s).toLowerCase();if('js'===a&&(!t.length||t.indexOf(r.substring(0,r.length-3))!==-1)){var c=require(s),u=new Date;try{var l=void 0!==c.run,p=void 0!==c.isInstall,f=void 0!==c.init,d=void 0!==c.load;if(_test=r,c.disabled===!0)return;F.testsPriority=void 0===c.priority?F.testsFiles.length:c.priority;var h=null;if(l?h=c.run:p?h=c.install:f?h=c.init:d&&(h=c.loadname),null===h)return;F.testsFiles.push({name:r,index:F.testsFiles.length,fn:h,priority:F.testsPriority}),c.usage&&function(e){F.testsResults.push(function(){return e.usage(r)})}(c),n++}catch(e){i('Failed',u,e)}}}),_test='',F.testsFiles.sort(function(e,t){return e.priority>t.priority?1:e.priority<t.priority?-1:e.index>t.index?1:e.index<t.index?-1:0}),setTimeout(function(){console.log('===================== TESTING ======================'),n&&console.log(''),F.testing(e,function(){console.log(''),console.log('Passed ...',F.testsOK),console.log('Failed ...',F.testsNO),console.log(''),s(),F.isTest=!1,console.log(''),r&&r()})},100)}),F},F.clear=function(e,t){var r=F.path.temp(),n=F.id?'i-'+F.id+'_':'';return t&&F.config['disable-clear-temporary-directory']?(U.ls(r,function(t){F.unlink(t,function(){e&&e()})},function(e,t){if(t||n&&!e.substring(r.length).startsWith(n))return!1;if(e.indexOf('.package')!==-1)return!0;var o=U.getExtension(e);return'js'===o||'css'===o||'tmp'===o||'upload'===o||'html'===o||'htm'===o}),F):existsSync(r)?(U.ls(r,function(o,i){if(t){for(var s=[],a=0,c=o.length;a<c;a++){var u=o[a].substring(r.length);n&&!u.startsWith(n)||(u.indexOf('/')===-1||u.indexOf('.package/')!==-1)&&!u.endsWith('.jsoncache')&&s.push(o[a])}o=s,i=i.remove(function(e){return e.indexOf('.package')===-1})}F.unlink(o,function(){return F.rmdir(i,e)})}),t||(F.temporary.path={},F.temporary.range={},F.temporary.notfound={}),F):(e&&e(),F)},F.unlink=function(e,t){if('string'==typeof e&&(e=[e]),!e.length)return t&&t(),F;var r=e.shift();return r?Fs.unlink(r,function(){return F.unlink(e,t)}):t&&t(),F},F.rmdir=function(e,t){if('string'==typeof e&&(e=[e]),!e.length)return t&&t(),F;var r=e.shift();return r?Fs.rmdir(r,function(){return F.rmdir(e,t)}):t&&t(),F},F.encrypt=function(e,t,r){if(void 0===e)return'';var n='undefined'==typeof e?'undefined':_typeof(e);if('boolean'==typeof t){var o=r;r=t,t=o}return'function'===n?e=e():'number'===n?e=e.toString():'object'===n&&(e=JSON.stringify(e)),e.encrypt(F.config.secret+'='+t,r)},F.decrypt=function(e,t,r){if('boolean'==typeof t){var n=r;r=t,t=n}'boolean'!=typeof r&&(r=!0);var o=(e||'').decrypt(F.config.secret+'='+t);if(!o)return null;if(r){if(o.isJSON())try{return JSON.parse(o)}catch(e){}return null}return o},F.hash=function(e,t,r){var n=Crypto.createHash(e),o='';return'string'==typeof r?o=r:r!==!1&&(o=F.config.secret||''),n.update(t.toString()+o,ENCODING),n.digest('hex')},F.resource=function(e,t){t||(t=e,e=null),e||(e='default');var r=F.resources[e];if(r)return r[t]||'';var n,o=F.routes.resources[e],i='';if(o)for(var s=0,a=o.length;s<a;s++)n=o[s],existsSync(n)&&(i+=(i?'\n':'')+Fs.readFileSync(n).toString(ENCODING));var n=U.combine(F.config['directory-resources'],e+'.resource');existsSync(n)&&(i+=(i?'\n':'')+Fs.readFileSync(n).toString(ENCODING));var c=i.parseConfig();return F.resources[e]=c,c[t]||''},F.translate=function(e,t){if(t||(t=e,e=void 0),'#'===t[0]&&' '!==t[1])return F.resource(e,t.substring(1));var r=F.resource(e,'T'+t.hash());return r?r:t},F.translator=function(e,t){return framework_internal.parseLocalization(t,e)},F.$cofnigure_sitemap=function(e,t){if(!e||'string'==typeof e){var r=prepare_filename(e||'sitemap');e=existsSync(r,!0)?Fs.readFileSync(r).toString(ENCODING).split('\n'):null}if(!e||!e.length)return F;!t&&F.routes.sitemap||(F.routes.sitemap={});for(var n=0,o=e.length;n<o;n++){var i=e[n];if(i&&'#'!==i[0]&&'// '!==i.substring(0,3)){var s=i.indexOf(' :');if(s!==-1||(s=i.indexOf('\t:'),s!==-1)){var a=i.substring(0,s).trim(),c=i.substring(s+2).trim(),u=c.split('-->'),l=u[1].trim(),p=!1;l.endsWith('*')&&(p=!0,l=l.substring(0,l.length-1));var f=u[0].trim(),d=f.startsWith('@('),h=l.startsWith('@(');d&&(f=f.substring(2,f.length-1).trim()),h&&(l=l.substring(2,l.length-1).trim()),F.routes.sitemap[a]={name:f,url:l,parent:u[2]?u[2].trim():null,wildcard:p,formatName:f.indexOf('{')!==-1,formatUrl:l.indexOf('{')!==-1,localizeName:d,localizeUrl:h}}}}return F},F.sitemap=function(e,t,r){if(!F.routes.sitemap)return EMPTYARRAY;'string'==typeof t&&(r=t,t=!1);var n=REPOSITORY_SITEMAP+e+'$'+(t?'1':'0')+'$'+(r||'');if(F.temporary.other[n])return F.temporary.other[n];var o,i,s,a=e;if(t===!0){o=F.routes.sitemap[e];var c={sitemap:a,id:'',name:'',url:'',last:!0,selected:!0,index:0,wildcard:!1,formatName:!1,formatUrl:!1};return o?(s=o.name,o.localizeName&&(s=F.translate(r,s)),i=o.url,o.localizeUrl&&(i=F.translate(r,i)),c.sitemap=a,c.id=e,c.formatName=o.formatName,c.formatUrl=o.formatUrl,c.localizeUrl=o.localizeUrl,c.localizeName=o.localizeName,c.name=s,c.url=i,c.wildcard=o.wildcard,F.temporary.other[n]=c,c):c}for(var u=[],l=0;;){if(o=F.routes.sitemap[e],!o)break;if(s=o.name,i=o.url,o.localizeName&&(s=F.translate(r,o.name)),o.localizeUrl&&(i=F.translate(r,i)),u.push({sitemap:a,id:e,name:s,url:i,last:0===l,first:!o.parent,selected:0===l,index:l,wildcard:o.wildcard,formatName:o.formatName,formatUrl:o.formatUrl,localizeName:o.localizeName,localizeUrl:o.localizeUrl}),l++,e=o.parent,!e)break}return u.reverse(),F.temporary.other[n]=u,u},F.sitemap_navigation=function(e,t){var r=REPOSITORY_SITEMAP+'_n_'+(e||'')+'$'+(t||'');if(F.temporary.other[r])return F.temporary.other[r];for(var n=Object.keys(F.routes.sitemap),o=[],i=0,s=0,a=n.length;s<a;s++){var c=F.routes.sitemap[n[s]];if(!(e&&c.parent!==e||!e&&c.parent)){var u=c.name,l=c.url;c.localizeName&&(u=F.translate(t,u)),c.localizeUrl&&(l=F.translate(t,l)),o.push({id:e||'',name:u,url:l,last:0===i,first:!c.parent,selected:0===i,index:i,wildcard:c.wildcard,formatName:c.formatName,formatUrl:c.formatUrl}),i++}}return o.quicksort('name'),F.temporary.other[r]=o,o},F.sitemap_add=function(e){return F.$cofnigure_sitemap(e instanceof Array?e:[e]),F},F.$configure_dependencies=function(e,t){if(!e||'string'==typeof e){var r=prepare_filename(e||'dependencies');e=existsSync(r,!0)?Fs.readFileSync(r).toString(ENCODING).split('\n'):null}if(!e)return F;for(var n,o,i,s=[],a=0,c=e.length;a<c;a++){var u=e[a];if(u&&'#'!==u[0]&&'// '!==u.substring(0,3)){var l=u.indexOf(' :');if(l!==-1||(l=u.indexOf('\t:'),l!==-1)){var p=u.substring(0,l).trim(),f=u.substring(l+2).trim(),d=0;if(o=void 0,i=void 0,l=p.indexOf('('),l!==-1&&(i=p.substring(l,p.indexOf(')',l)).replace(/\(|\)/g,'').trim(),p=p.substring(0,l).trim()),l=f.indexOf('-->'),l!==-1){var h=f.substring(l+3).trim();h.isJSON()&&(o=JSON.parse(h)),f=f.substring(0,l).trim()}switch(p){case'package':case'packages':case'pkg':n='package',d=9;break;case'module':case'modules':n='module',d=10;break;case'model':case'models':n='model',d=8;break;case'source':case'sources':n='source',d=3;break;case'controller':case'controllers':n='controller',d=4;break;case'view':case'views':d=3,n='view';break;case'version':case'versions':d=3,n='version';break;case'config':case'configuration':d=11,n='config';break;case'isomorphic':case'isomorphics':d=6,n='isomorphic';break;case'definition':case'definitions':d=5,n='definition';break;case'middleware':case'middlewares':n='middleware',d=4;break;case'component':case'components':d=7,n='component'}n&&!function(e,t,r,n){n?s.push({priority:d,fn:function(o){return F.uptodate(e,t,r,n,o)}}):s.push({priority:d,fn:function(n){return F.install(e,t,r,void 0,void 0,void 0,void 0,void 0,void 0,n)}})}(n,f,o,i)}}}return s.quicksort('priority',!1),s.wait(function(e,t){e.fn(t)},t),F},F.$configure_workflows=function(e,t){if(void 0===e||'string'==typeof e){var r=prepare_filename(e||'workflows');e=existsSync(r,!0)?Fs.readFileSync(r).toString(ENCODING).split('\n'):null}return t&&(F.workflows={}),e&&e.length?(e.forEach(function(e){if(e=e.trim(),!e.startsWith('//')){var t=e.indexOf(':');if(t!==-1){var r=e.substring(0,t).trim(),n=-1,o=[],i=r.indexOf('(');if(i!==-1){var s=r.substring(i+1,r.indexOf(')',i+1)).trim();r=r.substring(0,i).trim(),s=s.replace(/^default\//gi,''),r=s+'#'+r}e.substring(t+1).split('-->').forEach(function(e,t){e=e.trim().replace(/\"/g,'\''),e.endsWith('(response)')&&(n=t,e=e.replace('(response)','').trim());var r=e.split(':');2===r.length?o.push('$'+r[0].trim()+'('+r[1].trim()+', options)'):o.push('$'+r[0]+'(options)')}),F.workflows[r]=new Function('model','options','callback','return model.$async(callback'+(n===-1?'':', '+n)+').'+o.join('.')+';')}}}),F):F},F.$configure_versions=function(e,t){if(void 0===e||'string'==typeof e){var r=prepare_filename(e||'versions');e=existsSync(r,!0)?Fs.readFileSync(r).toString(ENCODING).split('\n'):null}if(!e)return t&&(F.versions=null),F;t||(F.versions={}),F.versions||(F.versions={});for(var n=0,o=e.length;n<o;n++){var i=e[n];if(i&&'#'!==i[0]&&'// '!==i.substring(0,3)){'/'!==i[0]&&(i='/'+i);var s=i.indexOf(' :'),a=!1;if(s===-1&&(s=i.indexOf('\t:'),s===-1)){if(s=i.indexOf('-->'),s===-1)continue;a=!0}var c=a?3:2,u=i.substring(0,s).trim(),r=i.substring(s+c).trim();F.versions[u]=r,a&&F.map(r,F.path.public(u))}}return F},F.$configure_configs=function(e,t){var r='undefined'==typeof e?'undefined':_typeof(e);if('string'===r){var n=prepare_filename(e);if(!existsSync(n,!0))return F;e=Fs.readFileSync(n).toString(ENCODING).split('\n')}if(!e){var o=U.combine('/','config'),i=U.combine('/','config-'+(F.config.debug?'debug':'release'));e=[];var s=F.path.configs();if(existsSync(s))for(var a=Fs.readdirSync(s),c=0,u=a.length;c<u;c++){var l=a[c].match(/\-(debug|release|test)$/i);if(l){if(l=l[0].toString().toLowerCase(),'-debug'===l&&!F.isDebug)continue;if('-release'===l&&F.isDebug)continue;if('-test'===l&&!F.isTest)continue}e=e.concat(Fs.readFileSync(s+a[c]).toString(ENCODING).split('\n'))}existsSync(o)&&Fs.lstatSync(o).isFile()&&(e=e.concat(Fs.readFileSync(o).toString(ENCODING).split('\n'))),existsSync(i)&&Fs.lstatSync(i).isFile()&&(e=e.concat(Fs.readFileSync(i).toString(ENCODING).split('\n')))}var p=function(){process.title='total: '+F.config.name.removeDiacritics().toLowerCase().replace(REG_EMPTY,'-').substring(0,8),F.isVirtualDirectory=existsSync(U.combine(F.config['directory-public-virtual']))};if(!(e instanceof Array&&e.length))return p(),F;void 0===t&&(t=!0);for(var a,f,d,h={},m=null,u=e.length,c=0;c<u;c++){var g=e[c];if(g&&'#'!==g[0]&&'/'!==g[0]&&'/'!==g[1]){var v=g.indexOf(':');if(v!==-1){var y=g.substring(0,v).trim();if('debug'!==y&&'resources'!==y)switch(d=g.substring(v+1).trim(),v=y.indexOf('('),v!==-1?(f=y.substring(v+1,y.indexOf(')')).trim().toLowerCase(),y=y.substring(0,v).trim()):f='',y){case'default-cors-maxage':case'default-request-length':case'default-websocket-request-length':case'default-request-timeout':case'default-interval-clear-cache':case'default-interval-clear-resources':case'default-interval-precompile-views':case'default-interval-uptodate':case'default-interval-websocket-ping':case'default-maximum-file-descriptors':case'default-interval-clear-dnscache':h[y]=U.parseInt(d);break;case'default-image-consumption':case'default-image-quality':h[y]=U.parseInt(d.replace(/\%|\s/g,''));break;case'static-accepts-custom':m=d.replace(REG_ACCEPTCLEANER,'').split(',');break;case'default-root':d&&(h[y]=U.path(d));break;case'static-accepts':h[y]={},a=d.replace(REG_ACCEPTCLEANER,'').split(',');for(var b=0;b<a.length;b++)h[y][a[b]]=!0;break;case'mail.smtp':case'mail.smtp.options':case'mail.address.from':case'mail.address.copy':case'mail.address.bcc':case'mail.address.reply':a='mail.address.bcc'===y?'mail-address-copy':y.replace(/\./g,'-'),OBSOLETE(y,'is renamed to "'+a+'"'),h[a]=d;break;case'allow-gzip':case'allow-websocket':case'allow-performance':case'allow-compile-html':case'allow-compile-style':case'allow-compile-script':case'allow-defer':case'allow-debug':case'disable-strict-server-certificate-validation':case'disable-clear-temporary-directory':case'trace':case'allow-cache-snapshot':h[y]='true'===d.toLowerCase()||'1'===d||'on'===d;break;case'allow-compress-html':h['allow-compile-html']='true'===d.toLowerCase()||'1'===d||'on'===d;break;case'version':h[y]=d;break;default:if('string'===f)h[y]=d;else if('number'===f||'currency'===f||'float'===f||'double'===f)h[y]=d.isNumber(!0)?d.parseFloat():d.parseInt();else if('boolean'===f||'bool'===f)h[y]=d.parseBoolean();else if('eval'===f||'object'===f||'array'===f)try{h[y]=new Function('return '+d)()}catch(e){F.error(e,'F.configure('+y+')')}else'json'===f?h[y]=d.parseJSON():'date'===f||'datetime'===f||'time'===f?h[y]=d.parseDate():'env'===f||'environment'===f?h[y]=process.env[d]:h[y]=d.isNumber()?U.parseInt(d):d.isNumber(!0)?U.parseFloat(d):d.isBoolean()?'true'===d.toLowerCase():d}}}}U.extend(F.config,h,t);var a=F.config['mail-smtp-options'];'string'==typeof a&&a&&(a=new Function('return '+a)(),F.config['mail-smtp-options']=a),F.config['directory-temp']||(F.config['directory-temp']='~'+U.path(Path.join(Os.tmpdir(),'totaljs'+F.directory.hash()))),F.config['etag-version']||(F.config['etag-version']=F.config.version.replace(/\.|\s/g,'')),F.config['default-timezone']&&(process.env.TZ=F.config['default-timezone']),m&&m.length&&m.forEach(function(e){return F.config['static-accepts'][e]=!0}),F.config['disable-strict-server-certificate-validation']===!0&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED='0'),F.config['allow-performance']&&(http.globalAgent.maxSockets=9999);var E=F.config['default-xpoweredby'];return Object.keys(HEADERS).forEach(function(e){Object.keys(HEADERS[e]).forEach(function(t){'Cache-Control'===t&&(HEADERS[e][t]=HEADERS[e][t].replace(/max-age=\d+/,'max-age='+F.config['default-response-maxage'])),'X-Powered-By'===t&&(E?HEADERS[e][t]=E:delete HEADERS[e][t])})}),IMAGEMAGICK='im'===F.config['default-image-converter'],p(),F.emit('configure',F.config),F},F.routeScript=function(e,t){return e.endsWith('.js')||(e+='.js'),F.$routeStatic(e,F.config['static-url-script'],t)},F.routeStyle=function(e,t){return F.$routeStatic(e+(e.endsWith('.css')?'':'.css'),F.config['static-url-style'],t)},F.routeImage=function(e,t){return F.$routeStatic(e,F.config['static-url-image'],t)},F.routeVideo=function(e,t){return F.$routeStatic(e,F.config['static-url-video'],t)},F.routeFont=function(e,t){return F.$routeStatic(e,F.config['static-url-font'],t)},F.routeDownload=function(e,t){return F.$routeStatic(e,F.config['static-url-download'],t);
},F.routeStatic=function(e,t){return F.$routeStatic(e,F.config['static-url'],t)},F.$routeStatic=function(e,t,r){var n=e+t+'$'+r,o=F.temporary.other[n];if(RELEASE&&o)return o;if('~'===e[0])e=e.substring('~'===e[1]?2:1),r='';else if('='===e[0]){var i=e.indexOf('/');i!==-1&&(r=e.substring(1,i),e=e.substring(i+1),'?'===r&&(r=F.config['default-theme']))}var s;return REG_ROUTESTATIC.test(e)?s=e:'/'===e[0]?s=U.join(r,this.$version(e)):(s=U.join(r,t,this.$version(e)),REG_HTTPHTTPS.test(s)&&(s=s.substring(1))),F.temporary.other[n]=framework_internal.preparePath(this.$version(s))},F.$version=function(e){return F.versions&&(e=F.versions[e]||e),F.onVersion&&(e=F.onVersion(e)||e),e},F.$versionprepare=function(e){var t=e.match(REG_VERSIONS);if(!t)return e;for(var r=0,n=t.length;r<n;r++){var o=t[r].toString(),i=5;'h'===o[0]&&(i=6);var s=o.substring(i,o.length-1);e=e.replace(t[r],o.substring(0,i)+F.$version(s)+'"')}return e},F.lookup=function(e,t,r,n){var o='#'===t[0],i=F._length_subdomain_web&&e.subdomain?e.subdomain.join('.'):null;o&&(e.path=[t]),e.$isAuthorized=!0;var s;if(!o&&(s='#'+t+'$'+n+e.$flags+(i?'$'+i:''),F.temporary.other[s]))return F.temporary.other[s];for(var a=F.routes.web.length,c=0;c<a;c++){var u=F.routes.web[c];if(u.CUSTOM){if(!u.CUSTOM(t,e,r))continue}else{if(F._length_subdomain_web&&!framework_internal.routeCompareSubdomain(i,u.subdomain))continue;if(u.isASTERIX){if(!framework_internal.routeCompare(e.path,u.url,o,!0))continue}else if(!framework_internal.routeCompare(e.path,u.url,o))continue}{if(!o){if(u.isPARAM&&u.regexp){for(var l=!1,p=0,f=u.regexpIndexer.length;p<f;p++){var d=e.path[u.regexpIndexer[p]];if(void 0===d){l=!0;break}if(!u.regexp[u.regexpIndexer[p]].test(d)){l=!0;break}}if(l)continue}if(u.flags&&u.flags.length){var h=framework_internal.routeCompareFlags2(e,u,n);if(h===-1&&(e.$isAuthorized=!1),h<1)continue}return s&&u.isCACHE&&e.$isAuthorized&&(F.temporary.other[s]=u),u}if(u.isSYSTEM)return u}}return null},F.lookup_websocket=function(e,t,r){var n=F._length_subdomain_websocket&&e.subdomain?e.subdomain.join('.'):null,o=F.routes.websockets.length;e.$isAuthorized=!0;for(var i=0;i<o;i++){var s=F.routes.websockets[i];if(s.CUSTOM){if(!s.CUSTOM(t,e))continue}else{if(F._length_subdomain_websocket&&!framework_internal.routeCompareSubdomain(n,s.subdomain))continue;if(s.isASTERIX){if(!framework_internal.routeCompare(e.path,s.url,!1,!0))continue}else if(!framework_internal.routeCompare(e.path,s.url,!1))continue}if(s.isPARAM&&s.regexp){for(var a=!1,c=0,u=s.regexpIndexer.length;c<u;c++){var l=e.path[s.regexpIndexer[c]];if(void 0===l){a=!0;break}if(!s.regexp[s.regexpIndexer[c]].test(l)){a=!0;break}}if(a)continue}if(s.flags&&s.flags.length){var p=framework_internal.routeCompareFlags2(e,s,r);if(p===-1&&(e.$isAuthorized=!1),p<1)continue}return s}return null},F.accept=function(e,t){return'.'===e[0]&&(e=e.substring(1)),F.config['static-accepts'][e]=!0,t&&U.setContentType(e,t),F},F.worker=function(e,t,r,n){var o=null,i='undefined'==typeof t?'undefined':_typeof(t);if('number'===i&&void 0===r&&(r=t,t=null,i='undefined'),'string'===i&&(o=F.workers[t]),t instanceof Array&&(n=t,t=null,r=void 0),r instanceof Array&&(n=r,r=void 0),o)return o;var s='@'===e[0]?F.path.package(e.substring(1)):U.combine(F.config['directory-workers'],e);return n||(n=[]),o=Child.fork('.'===s[s.length-3]?s:s+'.js',n,HEADERS.workers),t||(t=e+'_'+(new Date).getTime()),o.__id=t,F.workers[t]=o,o.on('exit',function(){var e=this;e.__timeout&&clearTimeout(e.__timeout),delete F.workers[e.__id],o&&(o.removeAllListeners(),o=null)}),'number'!=typeof r?o:(o.__timeout=setTimeout(function(){o&&o.kill('SIGKILL')},r),o)},F.worker2=function(e,t,r,n){if('function'==typeof t)n=r,r=t,t=void 0;else if('number'==typeof r){var o=n;n=r,r=o}!t||t instanceof Array||(t=[t]);var i=F.worker(e,e,n,t);return i.__worker2?i:(i.__worker2=!0,i.on('error',function(e){r&&r(e),r=null}),i.on('exit',function(){r&&r(),r=null}),i)},F.wait=function(e,t){return F.waits||(F.waits={}),void 0!==t?(t?F.waits[e]=!0:delete F.waits[e],F._length_wait=Object.keys(F.waits).length,t):(F.waits[e]?delete F.waits[e]:(F.waits[e]=!0,t=!0),F._length_wait=Object.keys(F.waits).length,t===!0)},FrameworkRoute.prototype={get id(){return this.route.id},set id(e){this.route.id=e},get description(){return this.route.description},set description(e){this.route.description=e},get maxlength(){return this.route.length},set maxlength(e){this.route.length=e},get options(){return this.route.options},set options(e){this.route.options=e},get url(){return this.route.urlraw},get flags(){return this.route.flags||EMPTYARRAY}},FrameworkRoute.prototype.make=function(e){return e&&e.call(this,this),this},FrameworkRoute.prototype.setId=function(e){return this.route.id=e,this},FrameworkRoute.prototype.setDecription=function(e){return this.route.description=e,this},FrameworkRoute.prototype.setTimeout=function(e){return this.route.timeout=e,this},FrameworkRoute.prototype.setMaxLength=function(e){return this.route.length=e,this},FrameworkRoute.prototype.setOptions=function(e){return this.route.options=e,this},FrameworkPath.prototype.verify=function(e){var t='$directory-'+e;if(F.temporary.path[t])return F;var r=F.config['directory-'+e]||e,n=U.combine(r);return!existsSync(n)&&Fs.mkdirSync(n),F.temporary.path[t]=!0,F},FrameworkPath.prototype.exists=function(e,t){return Fs.lstat(e,function(e,r){return t(!e,r?r.size:0,!!r&&r.isFile())}),F},FrameworkPath.prototype.public=function(e){return U.combine(F.config['directory-public'],e)},FrameworkPath.prototype.public_cache=function(e){var t='public_'+e,r=F.temporary.other[t];return r?r:F.temporary.other[t]=U.combine(F.config['directory-public'],e)},FrameworkPath.prototype.private=function(e){return U.combine(F.config['directory-private'],e)},FrameworkPath.prototype.isomorphic=function(e){return U.combine(F.config['directory-isomorphic'],e)},FrameworkPath.prototype.configs=function(e){return U.combine(F.config['directory-configs'],e)},FrameworkPath.prototype.virtual=function(e){return U.combine(F.config['directory-public-virtual'],e)},FrameworkPath.prototype.logs=function(e){return this.verify('logs'),U.combine(F.config['directory-logs'],e)},FrameworkPath.prototype.models=function(e){return U.combine(F.config['directory-models'],e)},FrameworkPath.prototype.temp=function(e){return this.verify('temp'),U.combine(F.config['directory-temp'],e)},FrameworkPath.prototype.temporary=function(e){return this.temp(e)};FrameworkPath.prototype.views=function(e){return U.combine(F.config['directory-views'],e)};FrameworkPath.prototype.workers=function(e){return U.combine(F.config['directory-workers'],e)},FrameworkPath.prototype.databases=function(e){return this.verify('databases'),U.combine(F.config['directory-databases'],e)},FrameworkPath.prototype.modules=function(e){return U.combine(F.config['directory-modules'],e)},FrameworkPath.prototype.controllers=function(e){return U.combine(F.config['directory-controllers'],e)},FrameworkPath.prototype.definitions=function(e){return U.combine(F.config['directory-definitions'],e)},FrameworkPath.prototype.tests=function(e){return U.combine(F.config['directory-tests'],e)},FrameworkPath.prototype.resources=function(e){return U.combine(F.config['directory-resources'],e)},FrameworkPath.prototype.services=function(e){return U.combine(F.config['directory-services'],e)},FrameworkPath.prototype.packages=function(e){return U.combine(F.config['directory-packages'],e)},FrameworkPath.prototype.themes=function(e){return U.combine(F.config['directory-themes'],e)},FrameworkPath.prototype.components=function(e){return U.combine(F.config['directory-components'],e)},FrameworkPath.prototype.root=function(e){var t=Path.join(directory,e||'');return F.isWindows?t.replace(/\\/g,'/'):t},FrameworkPath.prototype.package=function(e,t){if(void 0===t){var r=e.indexOf('/');r!==-1&&(t=e.substring(r+1),e=e.substring(0,r))}var n=F.config['directory-temp'],o='~'===n[0]?Path.join(n.substring(1),e+'.package',t||''):Path.join(directory,n,e+'.package',t||'');return F.isWindows?o.replace(REG_WINDOWSPATH,'/'):o},FrameworkCache.prototype.init=function(){return clearInterval(this.interval),this.interval=setInterval(function(){return F.cache.recycle()},6e4),F.config['allow-cache-snapshot']&&this.load(),this},FrameworkCache.prototype.save=function(){return Fs.writeFile(F.path.temp((F.id?'i-'+F.id+'_':'')+'F.jsoncache'),JSON.stringify(this.items),NOOP),this},FrameworkCache.prototype.load=function(){var e=this;return Fs.readFile(F.path.temp((F.id?'i-'+F.id+'_':'')+'F.jsoncache'),function(t,r){if(!t)try{r=JSON.parse(r.toString('utf8'),function(e,t){return'string'==typeof t&&t.isJSONDate()?new Date(t):t}),e.items=r}catch(e){}}),e},FrameworkCache.prototype.stop=function(){return clearInterval(this.interval),this},FrameworkCache.prototype.clear=function(){return this.items={},this},FrameworkCache.prototype.recycle=function(){var e=this.items;F.datetime=new Date,this.count++;for(var t in e){var r=e[t];r?r.expire<F.datetime&&(F.emit('cache-expire',t,r.value),delete e[t]):delete e[t]}return F.config['allow-cache-snapshot']&&this.save(),F.service(this.count),this},FrameworkCache.prototype.set=FrameworkCache.prototype.add=function(e,t,r,n){var o='undefined'==typeof r?'undefined':_typeof(r);switch(o){case'string':r=r.parseDateExpiration();break;case'undefined':r=F.datetime.add('m',5)}return this.items[e]={value:t,expire:r},F.$events['cache-set']&&F.emit('cache-set',e,t,r,n),t},FrameworkCache.prototype.read=FrameworkCache.prototype.get=function(e,t){var r=this.items[e];return r?(F.datetime=new Date,r.expire<F.datetime?(this.items[e]=void 0,F.$events['cache-expire']&&F.emit('cache-expire',e,r.value),t):r.value):t},FrameworkCache.prototype.read2=FrameworkCache.prototype.get2=function(e,t){var r=this.items[e];return r?r.expire<F.datetime?(this.items[e]=void 0,F.$events['cache-expire']&&F.emit('cache-expire',e,r.value),t):r.value:t},FrameworkCache.prototype.setExpire=function(e,t){var r=this.items[e];return r&&(r.expire='string'==typeof t?t.parseDateExpiration():t),this},FrameworkCache.prototype.remove=function(e){var t=this.items[e];return t&&(this.items[e]=void 0),t},FrameworkCache.prototype.removeAll=function(e){var t=0,r=U.isRegExp(e);for(var n in this.items){if(r){if(!e.test(n))continue}else if(n.indexOf(e)===-1)continue;this.remove(n),t++}return t},FrameworkCache.prototype.fn=function(e,t,r){var n=this,o=n.read2(e);return o?(r&&r(o,!0),n):(t(function(t,o){n.add(e,t,o),r&&r(t,!1)}),n)},Subscribe.prototype.success=function(){var e=this;return e.timeout&&clearTimeout(e.timeout),e.timeout=null,e.isCanceled=!0,e.controller&&(e.controller.res.controller=null,e.controller.req.controller=null,e.controller=null),e},Subscribe.prototype.file=function(){var e=this;return e.req.on('end',subscribe_file),e.req.resume(),e},Subscribe.prototype.multipart=function(e){var t=this,r=t.req;return F.stats.request.upload++,t.route=F.lookup(r,r.uri.pathname,r.flags,0),t.header=e,t.route?(F.path.verify('temp'),framework_internal.parseMULTIPART(r,e,t.route,F.config['directory-temp'],t),t):(F.reqstats(!1,!1),F.stats.request.blocked++,t.res.writeHead(403),t.res.end(),t)},Subscribe.prototype.urlencoded=function(){var e=this;return e.route=F.lookup(e.req,e.req.uri.pathname,e.req.flags,0),e.route?(e.req.buffer_has=!0,e.req.buffer_exceeded=!1,e.req.on('data',subscribe_parse),e.end(),e):(F.stats.request.blocked++,F.reqstats(!1,!1),e.res.writeHead(403),e.res.end(),F.$events['request-end']&&F.emit('request-end',e.req,e.res),e.req.clear(!0),e)},Subscribe.prototype.end=function(){var e=this;e.req.on('end',subscribe_end),e.req.resume()},Subscribe.prototype.execute=function(e,t){var r=this,n=r.route,o=r.req,i=r.res;if(!t&&n||(F.stats.response['error'+e]++,500!==e&&F.$events.error&&F.emit('error'+e,o,i,r.exception)),!n)return 400===e&&r.exception instanceof framework_builders.ErrorBuilder?(F.stats.response.errorBuilder++,o.$language&&r.exception.setResource(o.$language),i.options.body=r.exception.output(),i.options.type=r.exception.contentType,i.$text()):(i.options.body=U.httpStatus(e)+prepare_error(r.exception),i.options.type=CT_TEXT,i.options.code=e||404,i.$text()),r;var s=n.controller;n.isMOBILE_VARY&&(o.$mobile=!0),void 0===n.currentViewDirectory&&(n.currentViewDirectory=s&&'#'!==s[0]&&'default'!==s&&'unknown'!==s?'/'+s+'/':'');var a=new Controller(s,o,i,r,n.currentViewDirectory);a.isTransfer=r.isTransfer,a.exception=r.exception,r.controller=a,!r.isCanceled&&n.timeout&&(r.timeout&&clearTimeout(r.timeout),r.timeout=setTimeout(subscribe_timeout,n.timeout,r)),n.isDELAY&&r.res.writeContinue(),r.isSchema&&(o.body.$$controller=a),n.middleware?async_middleware(0,o,i,n.middleware,subscribe_timeout_middleware,n.options,a,r):r.doExecute()},Subscribe.prototype.prepare=function(e,t){var r=this,n=r.req,o=r.res,i=F.onAuthorize;if(i){var s=e.length;return i(n,o,e,function(t,o){var i=s!==e.length;i&&(n.$flags+=e.slice(s).join('')),'boolean'!=typeof t&&(o=t,t=!o),n.isAuthorized=t,r.doAuthorize(t,o,i)}),r}r.route||(r.route=F.lookup(n,n.buffer_exceeded?'#431':t||n.uri.pathname,n.flags,0)),r.route||(r.route=F.lookup(n,'#404',EMPTYARRAY,0));var a=n.buffer_exceeded?431:404;return r.schema&&r.route?r.validate(r.route,subscribe_validate_callback,a):r.execute(a),r},Subscribe.prototype.doExecute=function(){var e=this,t=e.route.controller,r=e.controller,n=e.req;try{if(F.onTheme&&(r.themeName=F.onTheme(r)),r.isCanceled)return e;if(F.$events.controller&&F.emit('controller',r,t,e.route.options),r.isCanceled)return e;e.route.isCACHE&&!F.temporary.other[n.uri.pathname]&&(F.temporary.other[n.uri.pathname]=n.path),e.route.isGENERATOR?async.call(r,e.route.execute,!0)(r,framework_internal.routeParam(e.route.param.length?n.split:n.path,e.route)):e.route.execute.apply(r,framework_internal.routeParam(e.route.param.length?n.split:n.path,e.route))}catch(o){r=null,F.error(o,t,n.uri),e.exception=o,e.route=F.lookup(n,'#500',EMPTYARRAY,0),e.execute(500,!0)}return e},Subscribe.prototype.doAuthorize=function(e,t,r){var n=this,o=n.req,i=e?1:2;o.$flags+=i,t&&(o.user=t);var s=o.buffer_exceeded?431:401;if(n.route&&n.route.isUNIQUE&&!r&&(!n.route.MEMBER||n.route.MEMBER===i))return void(401===s&&n.schema?n.validate(n.route,subscribe_validate_callback,s):n.execute(s,!0));var a=F.lookup(o,o.buffer_exceeded?'#431':o.uri.pathname,o.flags,o.buffer_exceeded?0:i),c=o.$isAuthorized?404:401,s=o.buffer_exceeded?431:c;return!a&&(a=F.lookup(o,'#'+c,EMPTYARRAY,0)),n.route=a,n.route&&n.schema?n.validate(n.route,subscribe_validate_callback,s):n.execute(s),n},Subscribe.prototype.doEnd=function(){var e=this.req,t=this.route;if(e.buffer_exceeded)return t=F.lookup(e,'#431',EMPTYARRAY,0),e.buffer_data=null,t?(this.route=t,this.execute(431,!0)):this.res.throw431(),this;if(!e.buffer_data||t&&t.isBINARY||(e.buffer_data=e.buffer_data.toString(ENCODING)),!e.buffer_data)return t&&t.schema&&(this.schema=!0),e.buffer_data=null,this.prepare(e.flags,e.uri.pathname),this;if(t.isXML){if(2!==e.$type)return this.route400('Invalid "Content-Type".'),e.buffer_data=null,this;try{F.$onParseXML(e),e.buffer_data=null,this.prepare(e.flags,e.uri.pathname)}catch(t){F.error(t,null,e.uri),this.route500(t)}return this}if(this.route.isRAW)return e.body=e.buffer_data,e.buffer_data=null,this.prepare(e.flags,e.uri.pathname),this;if(!e.$type)return e.buffer_data=null,this.route400('Invalid "Content-Type".'),this;if(1===e.$type)try{F.$onParseJSON(e),e.buffer_data=null}catch(e){return this.route400('Invalid JSON data.'),this}else F.$onParseQueryBody(e);return this.route.schema&&(this.schema=!0),e.buffer_data=null,this.prepare(e.flags,e.uri.pathname),this},Subscribe.prototype.validate=function(e,t,r){var n=this.req;if(this.schema=!1,!e.schema||'DELETE'===n.method)return t(this,r);var o=this;F.onSchema(n,e.schema[0],e.schema[1],function(e,i){e?(o.route400(e),t=null):(F.stats.request.schema++,n.body=i,o.isSchema=!0,t(o,r))},e.schema[2],e.novalidate)},Subscribe.prototype.route400=function(e){var t=this;return t.route=F.lookup(t.req,'#400',EMPTYARRAY,0),t.exception=e,t.execute(400,!0),t},Subscribe.prototype.route500=function(e){var t=this;return t.route=F.lookup(t.req,'#500',EMPTYARRAY,0),t.exception=e,t.execute(500,!0),t},Subscribe.prototype.doEndfile=function(){var e=this,t=e.req,r=e.res;if(!F._length_files)return r.continue();for(var n=0;n<F._length_files;n++){var o=F.routes.files[n];try{if(o.extensions&&!o.extensions[e.req.extension])continue;if(o.url){var i=!1,s=o.url.length;if(!o.wildcard&&!o.fixedfile&&s!==t.path.length-1)continue;for(var a=0;a<s;a++)if(o.url[a]!==t.path[a]){i=!0;break}if(i)continue}else if(o.onValidate&&!o.onValidate.call(framework,t,r,!0))continue;return o.middleware?e.doEndfile_middleware(o):o.execute.call(framework,t,r,!1),e}catch(n){return F.error(n,o.controller,t.uri),r.throw500(),e}}r.continue()},Subscribe.prototype.doEndfile_middleware=function(e){var t=this;async_middleware(0,t.req,t.res,e.middleware,function(){try{e.execute.call(framework,t.req,t.res,!1)}catch(r){F.error(r,e.controller+' :: '+e.name,t.req.uri),t.res.throw500()}},e.options)},Subscribe.prototype.doParsepost=function(e){var t=this,r=t.req;return r.buffer_exceeded?t:(r.buffer_exceeded||(CONCAT[0]=r.buffer_data,CONCAT[1]=e,r.buffer_data=Buffer.concat(CONCAT)),r.buffer_data.length<t.route.length?t:(r.buffer_exceeded=!0,r.buffer_data=U.createBuffer(),t))},Subscribe.prototype.doCancel=function(){var e=this;F.stats.response.timeout++,clearTimeout(e.timeout),e.timeout=null,e.controller&&(e.controller.isTimeout=!0,e.controller.isCanceled=!0,e.route=F.lookup(e.req,'#408',EMPTYARRAY,0),e.execute(408,!0))},Controller.prototype={get schema(){return'default'===this.route.schema[0]?this.route.schema[1]:this.route.schema.join('/')},get workflow(){return this.route.schema_workflow},get sseID(){return this.req.headers['last-event-id']||null},get route(){return this.subscribe.route},get options(){return this.subscribe.route.options},get flags(){return this.subscribe.route.flags},get path(){return F.path},get get(){return OBSOLETE('controller.get','Instead of controller.get use controller.query'),this.req.query},get query(){return this.req.query},get post(){return OBSOLETE('controller.post','Instead of controller.post use controller.body'),this.req.body},get body(){return this.req.body},get files(){return this.req.files},get subdomain(){return this.req.subdomain},get ip(){return this.req.ip},get xhr(){return this.req.xhr},get url(){return U.path(this.req.uri.pathname)},get uri(){return this.req.uri},get cache(){return F.cache},get config(){return F.config},get controllers(){return F.controllers},get isProxy(){return this.req.isProxy},get isDebug(){return F.config.debug},get isTest(){return'1'===this.req.headers['x-assertion-testing']},get isSecure(){return this.req.isSecure},get secured(){return this.req.secured},get session(){return this.req.session},set session(e){this.req.session=e},get user(){return this.req.user},get referrer(){return this.req.headers.referer||''},set user(e){this.req.user=e},get mobile(){return this.req.mobile},get robot(){return this.req.robot},get viewname(){var e=this.req.path[this.req.path.length-1];return e&&'/'!==e||(e='index'),e}},Controller.prototype.$get=Controller.prototype.$read=function(e,t){return this.getSchema().get(e,t,this),this},Controller.prototype.$query=function(e,t){return this.getSchema().query(e,t,this),this},Controller.prototype.$save=function(e,t){var r=this;if(framework_builders.isSchema(r.body))r.body.$$controller=r,r.body.$save(e,t);else{var n=r.getSchema().default();n.$$controller=r,n.$save(e,t)}return r},Controller.prototype.$remove=function(e,t){var r=this;return r.getSchema().remove(e,t,r),this},Controller.prototype.$workflow=function(e,t,r){var n=this;return framework_builders.isSchema(n.body)?(n.body.$$controller=n,n.body.$workflow(e,t,r)):n.getSchema().workflow2(e,t,r,n),n},Controller.prototype.$workflow2=function(e,t,r){var n=this;return n.getSchema().workflow2(e,t,r,n),n},Controller.prototype.$hook=function(e,t,r){var n=this;return framework_builders.isSchema(n.body)?(n.body.$$controller=n,n.body.$hook(e,t,r)):n.getSchema().hook2(e,t,r,n),n},Controller.prototype.$hook2=function(e,t,r){var n=this;return n.getSchema().hook2(e,t,r,n),n},Controller.prototype.$transform=function(e,t,r){var n=this;return framework_builders.isSchema(n.body)?(n.body.$$controller=n,n.body.$transform(e,t,r)):n.getSchema().transform2(e,t,r,n),n},Controller.prototype.$transform2=function(e,t,r){var n=this;return n.getSchema().transform2(e,t,r,n),n},Controller.prototype.$operation=function(e,t,r){var n=this;return framework_builders.isSchema(n.body)?(n.body.$$controller=n,n.body.$operation(e,t,r)):n.getSchema().operation2(e,t,r,n),n},Controller.prototype.$operation2=function(e,t,r){var n=this;return n.getSchema().operation2(e,t,r,n),n},Controller.prototype.$exec=function(e,t,r){var n=this;if(framework_builders.isSchema(n.body))return n.body.$$controller=n,n.body.$exec(e,t,r),n;var o=n.getSchema().create();return o.$$controller=n,o.$exec(e,t,r),n},Controller.prototype.$async=function(e,t){var r=this;if(framework_builders.isSchema(r.body))return r.body.$$controller=r,r.body.$async(e,t);var n=r.getSchema().default();return n.$$controller=r,n.$async(e,t)},Controller.prototype.getSchema=function(){var e=this.subscribe.route;if(!e.schema||!e.schema[1])throw new Error('The controller\'s route does not define any schema.');var t=GETSCHEMA(e.schema[0],e.schema[1]);if(t)return t;throw new Error('Schema "{0}" does not exist.'.format(e.schema[1]))},Controller.prototype.component=function(e,t){var r=F.components.views[e];if(r){var n=framework_internal.viewEngine(e,r,this);if(n)return n.call(this,this,this.repository,this.$model,this.session,this.query,this.body,this.url,F.global,F.helpers,this.user,this.config,F.functions,0,this.outputPartial,this.req.cookie,this.req.files,this.req.mobile,t||EMPTYOBJECT)}return''},Controller.prototype.components=function(){return this},Controller.prototype.$components=function(e,t){if(e){for(var r=Object.keys(F.components.instances),n=[],o=0,i=r.length;o<i;o++){var s=F.components.instances[r[o]];if(s.group===e){var a=this.component(r[o],t);a&&n.push(a)}}return n.join('\n')}return''},Controller.prototype.cookie=function(e,t,r,n){var o=this;return void 0===t?o.req.cookie(e):(o.res.cookie(e,t,r,n),o)},Controller.prototype.clear=function(){var e=this;return e.req.clear(),e},Controller.prototype.translate=function(e,t){return t||(t=e,e=this.language),F.translate(e,t)},Controller.prototype.middleware=function(e,t,r){if('string'==typeof e&&(e=[e]),'function'==typeof t){var n=r;r=t,t=n}t||(t=EMPTYOBJECT);var o=this;return async_middleware(0,o.req,o.res,e,function(){return r&&r()},t,o),o},Controller.prototype.pipe=function(e,t,r){return this.res.proxy(e,t,null,r),this},Controller.prototype.encrypt=function(){return F.encrypt.apply(framework,arguments)},Controller.prototype.decrypt=function(){return F.decrypt.apply(framework,arguments)},Controller.prototype.hash=function(){return F.hash.apply(framework,arguments)},Controller.prototype.header=function(e,t){return this.res.setHeader(e,t),this},Controller.prototype.host=function(e){return this.req.hostname(e)},Controller.prototype.hostname=function(e){return this.req.hostname(e)},Controller.prototype.resource=function(e,t){return F.resource(e,t)},Controller.prototype.error=function(e){var t=this;if(e instanceof ErrorBuilder)return t.content(e),t;var r=F.error('string'==typeof e?new Error(e):e,t.name,t.uri);return void 0===e?r:(t.subscribe&&(t.subscribe.exception=e,t.exception=e),t)},Controller.prototype.invalid=function(e){var t=this;e&&(t.status=e);var r=new ErrorBuilder;return process.nextTick(next_controller_invalid,t,r),r},Controller.prototype.wtf=Controller.prototype.problem=function(e){return F.problem(e,this.name,this.uri,this.ip),this},Controller.prototype.change=function(e){return F.change(e,this.name,this.uri,this.ip),this},Controller.prototype.trace=function(e){return F.trace(e,this.name,this.uri,this.ip),this},Controller.prototype.transfer=function(e,t){var r=this,n=F.routes.web.length,o=framework_internal.routeSplit(e.trim()),i='#'===e[0],s=!t||0===t.length,a=null;r.req.$isAuthorized=!0;for(var c=0;c<n;c++){var u=F.routes.web[c];if(u.isASTERIX){if(!framework_internal.routeCompare(o,u.url,i,!0))continue}else if(!framework_internal.routeCompare(o,u.url,i))continue;if(s){a=u;break}if(u.flags&&u.flags.length){var l=framework_internal.routeCompareFlags(u.flags,t,!0);if(l===-1&&(r.req.$isAuthorized=!1),l<1)continue}a=u;break}return!!a&&(r.cancel(),r.req.path=EMPTYARRAY,r.subscribe.isTransfer=!0,r.subscribe.success(),r.subscribe.route=a,r.subscribe.execute(404),!0)},Controller.prototype.cancel=function(){return this.isCanceled=!0,this},Controller.prototype.log=function(){return F.log.apply(framework,arguments),this},Controller.prototype.logger=function(){return F.logger.apply(framework,arguments),this},Controller.prototype.meta=function(){var e=this;return arguments[0]&&(e.repository[REPOSITORY_META_TITLE]=arguments[0]),arguments[1]&&(e.repository[REPOSITORY_META_DESCRIPTION]=arguments[1]),arguments[2]&&arguments[2].length&&(e.repository[REPOSITORY_META_KEYWORDS]=arguments[2]instanceof Array?arguments[2].join(', '):arguments[2]),arguments[3]&&(e.repository[REPOSITORY_META_IMAGE]=arguments[3]),e},Controller.prototype.$dns=function(){for(var e='',t=arguments.length,r=0;r<t;r++)e+='<link rel="dns-prefetch" href="'+this._preparehostname(arguments[r])+'" />';return this.head(e),''},Controller.prototype.$prefetch=function(){for(var e='',t=arguments.length,r=0;r<t;r++)e+='<link rel="prefetch" href="'+this._preparehostname(arguments[r])+'" />';return this.head(e),''},Controller.prototype.$prerender=function(){for(var e='',t=arguments.length,r=0;r<t;r++)e+='<link rel="prerender" href="'+this._preparehostname(arguments[r])+'" />';return this.head(e),''},Controller.prototype.$next=function(e){return this.head('<link rel="next" href="'+this._preparehostname(e)+'" />'),''},Controller.prototype.$prev=function(e){return this.head('<link rel="prev" href="'+this._preparehostname(e)+'" />'),''},Controller.prototype.$canonical=function(e){return this.head('<link rel="canonical" href="'+this._preparehostname(e)+'" />'),''},Controller.prototype.$meta=function(){var e=this;if(arguments.length)return e.meta.apply(e,arguments),'';F.$events['controller-render-meta']&&F.emit('controller-render-meta',e);var t=e.repository;return F.onMeta.call(e,t[REPOSITORY_META_TITLE],t[REPOSITORY_META_DESCRIPTION],t[REPOSITORY_META_KEYWORDS],t[REPOSITORY_META_IMAGE])},Controller.prototype.title=function(e){return this.$title(e),this},Controller.prototype.description=function(e){return this.$description(e),this},Controller.prototype.keywords=function(e){return this.$keywords(e),this},Controller.prototype.author=function(e){return this.$author(e),this},Controller.prototype.$title=function(e){return e&&(this.repository[REPOSITORY_META_TITLE]=e),''},Controller.prototype.$title2=function(e){var t=this.repository[REPOSITORY_META_TITLE];return e&&(this.repository[REPOSITORY_META_TITLE]=(t?t:'')+e),''},Controller.prototype.$description=function(e){return e&&(this.repository[REPOSITORY_META_DESCRIPTION]=e),''},Controller.prototype.$keywords=function(e){return e&&e.length&&(this.repository[REPOSITORY_META_KEYWORDS]=e instanceof Array?e.join(', '):e),''},Controller.prototype.$author=function(e){return e&&(this.repository[REPOSITORY_META_AUTHOR]=e),''},Controller.prototype.sitemap_navigation=function(e,t){return F.sitemap_navigation(e,t||this.language)},Controller.prototype.sitemap_url=function(e,t,r,n,o,i,s){e||(e=this.repository[REPOSITORY_SITEMAP]);var a=F.sitemap(e,!0,this.language);return a?a.url.format(t,r,n,o,i,s):''},Controller.prototype.sitemap_name=function(e,t,r,n,o,i,s){e||(e=this.repository[REPOSITORY_SITEMAP]);var a=F.sitemap(e,!0,this.language);return a?a.name.format(t,r,n,o,i,s):''},Controller.prototype.sitemap_change=function(e,t,r,n,o,i,s,a){var c=this,u=c.repository[REPOSITORY_SITEMAP];u||(u=c.sitemap(e)),u.$cloned||(u=U.clone(u),u.$cloned=!0,c.repository[REPOSITORY_SITEMAP]=u);for(var l='function'==typeof r,p=0,f=u.length;p<f;p++){var d=u[p];if(d.id===e){var h=d[t];return l?d[t]=r(d[t]):'name'===t?d[t]=d.formatName?d[t].format(r,n,o,i,s,a):r:'url'===t?d[t]=d.formatUrl?d[t].format(r,n,o,i,s,a):r:d[t]=r,'name'===t&&c.repository[REPOSITORY_META_TITLE]===h&&(c.repository[REPOSITORY_META_TITLE]=d[t]),c}}return c},Controller.prototype.sitemap_replace=function(e,t,r){var n=this,o=n.repository[REPOSITORY_SITEMAP];o||(o=n.sitemap(e)),o.$cloned||(o=U.clone(o),o.$cloned=!0,n.repository[REPOSITORY_SITEMAP]=o);for(var i=0,s=o.length;i<s;i++){var a=o[i];if(a.id===e){var c=n.repository[REPOSITORY_META_TITLE]===a.name;return a.name='function'==typeof t?t(a.name):a.formatName?a.name.format(t):t,a.url='function'==typeof r?r(a.url):a.formatUrl?a.url.format(r):r,c&&(n.repository[REPOSITORY_META_TITLE]=a.name),n}}return n},Controller.prototype.$sitemap_change=function(){return this.sitemap_change.apply(this,arguments),''},Controller.prototype.$sitemap_replace=function(){return this.sitemap_replace.apply(this,arguments),''},Controller.prototype.sitemap=function(e){var t,r=this;return e instanceof Array?(r.repository[REPOSITORY_SITEMAP]=e,r):e?(t=F.sitemap(e,!1,r.language),r.repository[REPOSITORY_SITEMAP]=t,r.repository[REPOSITORY_META_TITLE]||(t=t.last(),t&&(r.repository[REPOSITORY_META_TITLE]=t.name)),r.repository[REPOSITORY_SITEMAP]):(t=r.repository[REPOSITORY_SITEMAP],t?t:r.repository.sitemap||EMPTYARRAY)},Controller.prototype.$sitemap=function(){var e=this;return e.sitemap.apply(e,arguments),''},Controller.prototype.module=function(e){return F.module(e)},Controller.prototype.layout=function(e){var t=this;return t.layoutName=e,t},Controller.prototype.theme=function(e){var t=this;return t.themeName=e,t},Controller.prototype.$layout=function(e){var t=this;return t.layoutName=e,''},Controller.prototype.model=function(e){return F.model(e)},Controller.prototype.mail=function(e,t,r,n,o){'function'==typeof n&&(o=n,n=null);var i=this;'string'==typeof i.language&&(t=t.indexOf('@(')===-1?F.translate(i.language,t):F.translator(i.language,t));var s=i.layoutName,a=i.view(r,n,!0);return i.layoutName=s,F.onMail(e,t,a,o)},Controller.prototype.notModified=function(e,t){return F.notModified(this.req,this.res,e,t)},Controller.prototype.setModified=function(e){return F.setModified(this.req,this.res,e),this},Controller.prototype.setExpires=function(e){return e&&this.res.setHeader('Expires',e.toUTCString()),this},Controller.prototype.$template=function(e,t,r,n){return this.$viewToggle(!0,e,t,r,n)},Controller.prototype.$templateToggle=function(e,t,r,n,o){return this.$viewToggle(e,t,r,n,o)},Controller.prototype.$view=function(e,t,r,n){return this.$viewToggle(!0,e,t,r,n)},Controller.prototype.$viewCompile=function(e,t){var r=this,n=r.layoutName;r.layoutName='';var o=r.viewCompile(e,t,null,!0);return r.layoutName=n,o||''},Controller.prototype.$viewToggle=function(e,t,r,n,o){if(!e)return'';var i,s=this;if(n){i='$view.'+t+'.'+(o||'');var a=s.cache.read2(i);if(a)return a}var c=s.layoutName;s.layoutName='';var u=s.view(t,r,null,!0);return s.layoutName=c,u?(n&&s.cache.add(i,u,n),u):''},Controller.prototype.place=function(e){var t=REPOSITORY_PLACE+'_'+e,r=arguments.length;if(1===r)return this.repository[t]||'';for(var n='',o=1;o<r;o++){var i=arguments[o];switch(i=i?i.toString():'',U.getExtension(i)){case'js':i='<script src="'+i+'"></script>';break;case'css':i='<link rel="stylesheet" href="'+i+'" />'}n+=i}return this.repository[t]=(this.repository[t]||'')+n,this},Controller.prototype.section=function(e,t,r){var n='$section_'+e;return void 0===t?this.repository[n]:r?(this.repository[n]=t,this):(this.repository[n]?this.repository[n]+=t:this.repository[n]=t,this)},Controller.prototype.$place=function(){var e=this;return 1===arguments.length?e.place.apply(e,arguments):(e.place.apply(e,arguments),'')},Controller.prototype.$url=function(e){return e?this.req.hostname(this.url):this.url;
},Controller.prototype.$helper=function(){return this.helper.apply(this,arguments)},Controller.prototype.href=function(e,t){var r=this;if(!arguments.length){var n=Qs.stringify(r.query);return n?'?'+n:''}var o,i='undefined'==typeof e?'undefined':_typeof(e);if('string'===i){var s='$href'+e,a=r[s]||'';if(!a){o=U.copy(r.query);for(var c=2;c<arguments.length;c++)o[arguments[c]]=void 0;o[e]='\0';for(var u=Object.keys(o),c=0,l=u.length;c<l;c++){var n=o[u[c]];void 0!==n&&(a+=(a?'&':'')+u[c]+'='+(e===u[c]?'\0':querystring_encode(n)))}r[s]=a}a=a.replace('\0',querystring_encode(t,r.query[e]));for(var c=2;c<arguments.length;c++){var p=a.indexOf(arguments[c]+'=');if(p!==-1){var f=a.indexOf('&',p);a=a.substring(0,p)+a.substring(f===-1?a.length:f+1)}}return a?'?'+a:''}return t&&(o=U.copy(r.query),U.extend(o,t)),null!=t&&(o[e]=t),o=Qs.stringify(o),void 0===t&&'string'===i&&(o+=(o?'&':'')+e),r.url+(o?'?'+o:'')},Controller.prototype.$checked=function(e,t,r){return this.$isValue(e,t,r,'checked="checked"')},Controller.prototype.$disabled=function(e,t,r){return this.$isValue(e,t,r,'disabled="disabled"')},Controller.prototype.$selected=function(e,t,r){return this.$isValue(e,t,r,'selected="selected"')},Controller.prototype.$set=function(){return''},Controller.prototype.$readonly=function(e,t,r){return this.$isValue(e,t,r,'readonly="readonly"')},Controller.prototype.$header=function(e,t){return this.header(e,t),''},Controller.prototype.$text=function(e,t,r){return this.$input(e,'text',t,r)},Controller.prototype.$password=function(e,t,r){return this.$input(e,'password',t,r)},Controller.prototype.$hidden=function(e,t,r){return this.$input(e,'hidden',t,r)},Controller.prototype.$radio=function(e,t,r,n){if('string'==typeof n){var o=n;n=SINGLETON('!$radio'),n.label=o}return n.value=r,this.$input(e,'radio',t,n)},Controller.prototype.$checkbox=function(e,t,r){if('string'==typeof r){var n=r;r=SINGLETON('!$checkbox'),r.label=n}return this.$input(e,'checkbox',t,r)},Controller.prototype.$textarea=function(e,t,r){var n='<textarea';'object'!==('undefined'==typeof r?'undefined':_typeof(r))&&(r=EMPTYOBJECT),n+=' name="'+t+'" id="'+(r.id||t)+ATTR_END;for(var o in r)switch(o){case'name':case'id':break;case'required':case'disabled':case'readonly':case'value':n+=' '+o+'="'+o+ATTR_END;break;default:n+=' '+o+'="'+r[o].toString().encode()+ATTR_END}return void 0===e?n+'></textarea>':n+'>'+(e[t]||r.value||'')+'</textarea>'},Controller.prototype.$input=function(e,t,r,n){var o=['<input'];'object'!==('undefined'==typeof n?'undefined':_typeof(n))&&(n=EMPTYOBJECT);var i=n.value||'';o+=' type="'+t+ATTR_END,o+='radio'===t?' name="'+r+ATTR_END:' name="'+r+'" id="'+(n.id||r)+ATTR_END,n.autocomplete&&(o+=n.autocomplete===!0||'on'===n.autocomplete?' autocomplete="on"':' autocomplete="off"');for(var s in n)switch(s){case'name':case'id':case'type':case'autocomplete':case'checked':case'value':case'label':break;case'required':case'disabled':case'readonly':case'autofocus':o+=' '+s+'="'+s+ATTR_END;break;default:o+=' '+s+'="'+n[s].toString().encode()+ATTR_END}var a='';return void 0!==e&&(a=e[r],'checkbox'===t&&('1'!=a&&'true'!==a&&a!==!0&&'on'!==a||(o+=' checked="checked"'),a=i||'1'),'radio'===t&&(i=(i||'').toString(),a.toString()===i&&(o+=' checked="checked"'),a=i||'')),o+=void 0===a?' value="'+(n.value||'').toString().encode()+ATTR_END:' value="'+(a||'').toString().encode()+ATTR_END,o+=' />',n.label?'<label>'+o+' <span>'+n.label+'</span></label>':o},Controller.prototype._preparehostname=function(e){if(!e)return e;var t=e.substring(0,5);return'http:'===t||'https'===t||'/'===t[0]&&'/'===t[1]?e:this.host(e)},Controller.prototype.head=function(){var e=this;if(!arguments.length){var t=e.repository[REPOSITORY_META_AUTHOR]||e.config.author;return(t?'<meta name="author" content="'+t+'" />':'')+(e.repository[REPOSITORY_HEAD]||'')}for(var r=e.repository[REPOSITORY_HEAD]||'',n=0;n<arguments.length;n++){var o=arguments[n],i='$head-'+o;if(!e.repository[i])if(e.repository[i]=!0,'<'!==o[0]){var s=o.substring(0,7),a='/'!==s[0]&&'/'!==s[1]&&'http://'!==s&&'https:/'!==s,c=U.getExtension(o);'css'===c?r+='<link type="text/css" rel="stylesheet" href="'+(a?e.routeStyle(o):o)+'" />':'js'===c&&(r+='<script src="'+(a?e.routeScript(o):o)+'"></script>')}else r+=o}return e.repository[REPOSITORY_HEAD]=r,e},Controller.prototype.$head=function(){return this.head.apply(this,arguments),''},Controller.prototype.$isValue=function(e,t,r,n){return e?(t=t||' ',r=r||'',t+n+r):''},Controller.prototype.$modified=function(e){var t,r=this,n='undefined'==typeof e?'undefined':_typeof(e);if('number'===n)t=new Date(e);else if('string'===n){var o=e.split(' ');t=o[0].split('-');var i=(o[1]||'').split(':'),s=U.parseInt(t[0]||''),a=U.parseInt(t[1]||'')-1,c=U.parseInt(t[2]||'')-1;a<0&&(a=0),c<0&&(c=0);var u=U.parseInt(i[0]||''),l=U.parseInt(i[1]||''),p=U.parseInt(i[2]||'');t=new Date(s,a,c,u,l,p,0)}else U.isDate(e)&&(t=e);return t&&r.setModified(t),''},Controller.prototype.$etag=function(e){return this.setModified(e),''},Controller.prototype.$options=function(e,t,r,n){var o='undefined'==typeof e?'undefined':_typeof(e);if(!e)return'';var i=!1,s=null;e instanceof Array||'object'!==o||(i=!0,s=e,e=Object.keys(e)),U.isArray(e)||(e=[e]),t=t||'';var a='';i||(void 0===n&&(n=n||r||'value'),void 0===r&&(r=r||'name'));var c=!1,u=0;u=e.length;for(var l=0;l<u;l++){var p=e[l],o='undefined'==typeof p?'undefined':_typeof(p),f='',d='',h=!1;i?r===!0?(d=s[p],f=p,n||(n='')):(d=p,f=s[p],f||(f='')):'object'===o?(f=p[r]||'',d=p[n]||'','function'==typeof f&&(f=f(l)),'function'==typeof d&&(d=d(l,f))):(f=p,d=p),c||(h=d==t,c=h),a+='<option value="'+d.toString().encode()+'"'+(h?' selected="selected"':'')+'>'+f.toString().encode()+'</option>'}return a},Controller.prototype.$script=function(){return 1===arguments.length?this.$js(arguments[0]):this.$js.apply(this,arguments)},Controller.prototype.$js=function(){for(var e=this,t='',r=0;r<arguments.length;r++)t+=e.routeScript(arguments[r],!0);return t},Controller.prototype.$absolute=function(e,t){var r,n,o=this;if(t||(t=o.hostname()),e instanceof Array){n=U.getExtension(e[0]),r='';for(var i=0,s=e.length;i<s;i++)switch(n){case'js':r+=o.routeScript(e[i],!0,t);break;case'css':r+=o.routeStyle(e[i],!0,t);break;default:r+=o.routeStatic(e[i],t)}return r}switch(n=U.getExtension(e)){case'js':return o.routeScript(e,!0,t);case'css':return o.routeStyle(e,!0,t)}return o.routeStatic(e,t)},Controller.prototype.$import=function(){for(var e=this,t='',r=0;r<arguments.length;r++){var n=arguments[r];if('head'!==n)if('meta'!==n)if('components'===n&&F.components.has)t+=F.components.links;else{var o=n.substring(n.lastIndexOf('.')),i='!'!==n[0];switch(i||(n=n.substring(1)),'#'===n[0]&&(o='.js'),o){case'.js':t+=e.routeScript(n,i);break;case'.css':t+=e.routeStyle(n,i);break;case'.ico':t+=e.$favicon(n);break;case'.mp4':case'.avi':case'.ogv':case'.webm':case'.mov':case'.mpg':case'.mpe':case'.mpeg':case'.m4v':t+=e.routeVideo(n);break;case'.jpg':case'.gif':case'.png':case'.jpeg':t+=e.routeImage(n);break;default:t+=e.routeStatic(n)}}else t+=e.$meta();else t+=e.head()}return t},Controller.prototype.$css=function(){for(var e=this,t='',r=0;r<arguments.length;r++)t+=e.routeStyle(arguments[r],!0);return t},Controller.prototype.$image=function(e,t,r,n,o){var i='';'object'===('undefined'==typeof t?'undefined':_typeof(t))&&(r=t.height,n=t.alt,o=t.class,i=t.style,t=t.width);var s='<img src="'+this.routeImage(e)+ATTR_END;return t>0&&(s+=' width="'+t+ATTR_END),r>0&&(s+=' height="'+r+ATTR_END),n&&(s+=' alt="'+n.encode()+ATTR_END),o&&(s+=' class="'+o+ATTR_END),i&&(s+=' style="'+i+ATTR_END),s+' border="0" />'},Controller.prototype.$download=function(e,t,r,n){var o='<a href="'+F.routeDownload(e)+ATTR_END;return r&&(o+=' download="'+r+ATTR_END),n&&(o+=' class="'+n+ATTR_END),o+'>'+(t||e)+'</a>'},Controller.prototype.$json=function(e,t,r,n){'boolean'==typeof t&&(n=r,r=t,t=null),'function'==typeof r&&(n=r,r=!1);var o=r?JSON.stringify(e,n,4):JSON.stringify(e,n);return t?'<script type="application/json" id="'+t+'">'+o+'</script>':o},Controller.prototype.$favicon=function(e){var t='image/x-icon';null==e&&(e='favicon.ico');var r='favicon#'+e;return F.temporary.other[r]?F.temporary.other[r]:(e.lastIndexOf('.png')!==-1?t='image/png':e.lastIndexOf('.gif')!==-1&&(t='image/gif'),F.temporary.other[r]='<link rel="shortcut icon" href="'+F.routeStatic('/'+e)+'" type="'+t+'" />')},Controller.prototype._routeHelper=function(e,t){return t.call(framework,prepare_staticurl(e,!1),this.themeName)},Controller.prototype.routeScript=function(e,t,r){void 0===e&&(e='default.js');var n;if('#'===e[0]){var o=F.isomorphic[e.substring(1)];if(!o)return F.error('Isomorphic library {0} doesn\'t exist.'.format(e.substring(1))),'';n=o.url}else n=this._routeHelper(e,F.routeScript),r&&U.isRelative(n)&&(n=F.isWindows?U.join(r,n):U.join(r,n).substring(1));return t?'<script src="'+n+'"></script>':n},Controller.prototype.routeStyle=function(e,t,r){var n=this;void 0===e&&(e='default.css');var o=n._routeHelper(e,F.routeStyle);return r&&U.isRelative(o)&&(o=F.isWindows?U.join(r,o):U.join(r,o).substring(1)),t?'<link type="text/css" rel="stylesheet" href="'+o+'" />':o},Controller.prototype.routeImage=function(e){return this._routeHelper(e,F.routeImage)},Controller.prototype.routeVideo=function(e){return this._routeHelper(e,F.routeVideo)},Controller.prototype.routeFont=function(e){return F.routeFont(e)},Controller.prototype.routeDownload=function(e){return this._routeHelper(e,F.routeDownload)},Controller.prototype.routeStatic=function(e,t){var r=this._routeHelper(e,F.routeStatic);return t&&U.isRelative(r)?F.isWindows?U.join(t,r):U.join(t,r).substring(1):r},Controller.prototype.template=function(e,t){return this.view(e,t,!0)},Controller.prototype.helper=function(e){var t=F.helpers[e];if(!t)return'';for(var r=[],n=1;n<arguments.length;n++)r.push(arguments[n]);return t.apply(this,r)},Controller.prototype.json=function(e,t,r,n){var o=this,i=o.res;return'boolean'==typeof t&&(n=r,r=t),i.options.code=o.status,i.options.type=CT_JSON,i.options.headers=t,'HEAD'===o.req.method?(i.options.body=EMPTYBUFFER,i.options.type=CT_JSON,i.$text(),F.stats.response.json++,o):(e instanceof framework_builders.ErrorBuilder?(o.req.$language&&!e.isResourceCustom&&e.setResource(o.req.$language),e.contentType?i.options.type=e.contentType:i.options.type=e=e.output(),F.stats.response.errorBuilder++):(framework_builders.isSchema(e)&&(e=e.$clean()),e=r?JSON.stringify(e,n,4):JSON.stringify(e,n)),F.stats.response.json++,i.options.body=e,i.$text(),o.precache&&o.precache(e,i.options.type,t),o)},Controller.prototype.jsonp=function(e,t,r,n,o){var i=this,s=i.res;return'boolean'==typeof r&&(o=n,n=r),s.options.code=i.status,s.options.headers=r,s.options.type='application/x-javascript','HEAD'===i.req.method?(s.options.body=EMPTYBUFFER,s.$text(),F.stats.response.json++,i):(!e&&(e='callback'),t instanceof framework_builders.ErrorBuilder?(i.req.$language&&!t.isResourceCustom&&t.setResource(i.req.$language),t=t.json(n),F.stats.response.errorBuilder++):(framework_builders.isSchema(t)&&(t=t.$clean()),t=n?JSON.stringify(t,o,4):JSON.stringify(t,o)),s.options.body=e+'('+t+')',s.$text(),F.stats.response.json++,i.precache&&i.precache(e+'('+t+')',s.options.type,r),i)},Controller.prototype.callback=function(e){var t=this;return function(r,n){var o=r instanceof framework_builders.ErrorBuilder;return void 0!==n||U.isError(r)||o||(n=r,r=null),r?o&&!e?(t.req.$language&&!r.isResourceCustom&&r.setResource(t.req.$language),t.content(r)):o&&r.unexpected?t.view500(r):t.view404(r):void('string'==typeof e?t.view(e,n):t.json(n))}},Controller.prototype.custom=function(){return!this.res.success&&(this.res.$custom(),!0)},Controller.prototype.noClear=function(e){return this.req._manual=void 0===e||e,this},Controller.prototype.content=function(e,t,r){var n=this,o=n.res;if(o.options.code=n.status,o.options.headers=r,e instanceof ErrorBuilder){var i=e.output();e.contentType?o.options.type=e.contentType:o.options.type=CT_JSON,e=i,F.stats.response.errorBuilder++}else o.options.type=t||CT_TEXT;return o.options.body=e,o.$text(),n.precache&&200===n.status&&(n.layout(''),n.precache(e,o.options.type,r,!0)),n},Controller.prototype.plain=function(e,t){var r=this,n=r.res;if(n.options.code=r.status,n.options.headers=t,n.options.type=CT_TEXT,'HEAD'===r.req.method)return n.options.body=EMPTYBUFFER,n.$text(),F.stats.response.plain++,r;var o='undefined'==typeof e?'undefined':_typeof(e);return null==e?e='':'object'===o?(framework_builders.isSchema(e)&&(e=e.$clean()),e=e?JSON.stringify(e,null,4):''):e=e?e.toString():'',n.options.body=e,n.$text(),F.stats.response.plain++,r.precache&&r.precache(e,n.options.type,t),r},Controller.prototype.empty=function(e){var t=this,r=t.res;return'number'==typeof e&&(t.status=e,e=null),r.options.code=t.status,r.options.headers=e,r.options.body=EMPTYBUFFER,r.options.type=CT_TEXT,r.options.compress=!1,r.$text(),F.stats.response.empty++,t},Controller.prototype.destroy=function(e){var t=this;return e&&t.problem(e),t.res.success||t.res.headersSent||!t.isConnected?t:(t.subscribe.success(),t.req.connection.destroy(),F.stats.response.destroy++,t)},Controller.prototype.file=function(e,t,r,n){e='~'===e[0]?e.substring(1):F.path.public_cache(e);var o=this.res;return o.options.filename=e,o.options.download=t,o.options.headers=r,o.options.callback=n,o.$file(),this},Controller.prototype.image=function(e,t,r,n){var o=this.res;return'string'==typeof e?(e='~'===e[0]?e.substring(1):F.path.public_cache(e),o.options.filename=e):o.options.stream=e,o.options.make=t,r&&(o.options.headers=r),n&&(o.options.callback=n),o.$image(),this},Controller.prototype.stream=function(e,t,r,n,o,i){var s=this.res;return s.options.type=e,s.options.stream=t,s.options.download=r,s.options.headers=n,s.options.done=o,s.options.compress=!i,s.$stream(),this},Controller.prototype.throw400=Controller.prototype.view400=function(e){return controller_error_status(this,400,e)},Controller.prototype.throw401=Controller.prototype.view401=function(e){return controller_error_status(this,401,e)},Controller.prototype.throw403=Controller.prototype.view403=function(e){return controller_error_status(this,403,e)},Controller.prototype.throw404=Controller.prototype.view404=function(e){return controller_error_status(this,404,e)},Controller.prototype.throw500=Controller.prototype.view500=function(e){var t=this;return F.error(e instanceof Error?e:new Error((e||'').toString()),t.name,t.req.uri),controller_error_status(t,500,e)},Controller.prototype.throw501=Controller.prototype.view501=function(e){return controller_error_status(this,501,e)},Controller.prototype.redirect=function(e,t){this.precache&&this.precache(null,null,null);var r=this.res;return r.options.url=e,r.options.permanent=t,r.$redirect(),this},Controller.prototype.binary=function(e,t,r,n,o){var i=this.res;if('object'===('undefined'==typeof r?'undefined':_typeof(r))){var s=r;r=n,n=o,o=s}return'object'===('undefined'==typeof n?'undefined':_typeof(n))&&(o=n,n=o),i.options.body=e,i.options.type=t,i.options.download=n,i.options.headers=o,i.options.encoding=r,i.$binary(),this},Controller.prototype.baa=function(e){var t=this;if(t.precache&&t.precache(null,null,null),void 0===e)return t.req.authorization();var r=t.res,n=SINGLETON('!controller.baa');return n['WWW-Authenticate']='Basic realm="'+(e||'Administration')+'"',r.options.code=401,r.options.body='401: NOT AUTHORIZED',r.options.compress=!1,r.options.headers=n,r.options.type=CT_TEXT,r.$text(),t.cancel(),null},Controller.prototype.sse=function(e,t,r,n){var o=this,i=o.res;if(!o.isConnected)return o;if(!o.type&&i.success)throw new Error('Response was sent.');if(o.type>0&&1!==o.type)throw new Error('Response was used.');o.type||(o.type=1,void 0===n&&(n=o.subscribe.route.timeout),o.subscribe.success(),o.req.on('close',function(){return o.close()}),i.success=!0,i.writeHead(o.status,HEADERS.sse)),e='object'===('undefined'==typeof e?'undefined':_typeof(e))?JSON.stringify(e):e.replace(/\n/g,'\\n').replace(/\r/g,'\\r');var s='\n',a='';return t&&(a='event: '+t+s),a+='data: '+e+s,r&&(a+='id: '+r+s),n>0&&(a+='retry: '+n+s),a+=s,i.write(a),F.stats.response.sse++,o},Controller.prototype.mmr=function(e,t,r){var n=this,o=n.res;return'function'==typeof t&&(r=t,t=e),t||(t=e),!n.isConnected||!n.type&&o.success||n.type&&2!==n.type?(r=null,n):(n.type||(n.type=2,n.boundary='----totaljs'+U.GUID(10),n.subscribe.success(),n.req.on('close',function(){return n.close()}),o.success=!0,HEADERS.mmr[HEADER_TYPE]='multipart/x-mixed-replace; boundary='+n.boundary,o.writeHead(n.status,HEADERS.mmr)),o.write('--'+n.boundary+NEWLINE+HEADER_TYPE+': '+U.getContentType(U.getExtension(e))+NEWLINE+NEWLINE),F.stats.response.mmr++,'string'==typeof t&&(t=Fs.createReadStream(t)),t.pipe(o,HEADERS.mmrpipe),CLEANUP(t,function(){return r&&r()}),n)},Controller.prototype.close=function(e){var t=this;return void 0===e&&(e=!0),t.isConnected?t.type?(t.isConnected=!1,t.res.success=!0,F.reqstats(!1,!1),F.$events['request-end']&&F.emit('request-end',t.req,t.res),t.type=0,e&&t.res.end(),t.req.clear(!0),t):(t.isConnected=!1,t.res.success?t:(t.res.success=!0,F.reqstats(!1,!1),F.$events['request-end']&&F.emit('request-end',t.req,t.res),e&&t.res.end(),t.req.clear(!0),t)):t},Controller.prototype.proxy=function(e,t,r,n){var o,i=this;return'number'==typeof r&&(o=n,n=r,r=o),'function'==typeof t&&(o=r,r=t,t=o),U.request(e,FLAGS_PROXY,t,function(e,t,n,o){r&&((o['content-type']||'').lastIndexOf('/json')!==-1&&(t=F.onParseJSON(t)),r.call(i,e,t,n,o))},null,HEADERS.proxy,ENCODING,n||1e4)},Controller.prototype.proxy2=function(e,t,r,n){'object'===('undefined'==typeof t?'undefined':_typeof(t))&&(n=r,r=t,t=void 0);var o=this,i=[],s=o.req,a=s.headers['content-type'],c={};i.push(s.method),i.push('dnscache'),a===CT_JSON&&i.push('json');var u,l,p=s.method[0];'G'!==p&&'H'!==p&&'O'!==p||e.indexOf('?')===-1&&(u=Qs.stringify(o.query),u&&(e+='?'+u)),l=Object.keys(s.headers);for(var f=0,d=l.length;f<d;f++)switch(l[f]){case'x-forwarded-for':case'x-forwarded-protocol':case'x-nginx-proxy':case'connection':case'content-type':case'host':case'accept-encoding':break;default:c[l[f]]=s.headers[l[f]]}if(r){l=Object.keys(r);for(var f=0,d=l.length;f<d;f++)c[l[f]]=r[l[f]]}return U.request(e,i,o.body,function(e,r,n,i){return e?(t&&t(e),void o.invalid().push(e)):(o.status=n,t&&t(e,r,n,i),void o.content(r,(i['content-type']||'text/plain').replace(REG_ENCODINGCLEANER,'')))},null,c,ENCODING,n||1e4)},Controller.prototype.view=function(e,t,r,n){var o=this;if('string'!=typeof e?(n=r,r=t,t=e,e=o.viewname):void 0===n&&'boolean'==typeof r&&(n=r,r=null),!n&&o.res&&o.res.success)return o;void 0===o.layoutName&&(o.layoutName=F.config['default-layout']),void 0===o.themeName&&(o.themeName=F.config['default-theme']);var i='view#='+this.themeName+'/'+o._currentView+'/'+e,s=F.temporary.other[i],a=o.isLayout;if(o.isLayout=!1,!s){var c=e[0],u='/'===c?1:'~'===c&&'~'===e[1]?4:'~'===c?2:'@'===c?3:'.'===c?5:'='===c?6:0,l=!1;s=e,o.themeName&&u<3&&(s='.'+F.path.themes(o.themeName+'/views/'+(a||u?'':o._currentView.substring(1))+(u?e.substring(1):e)).replace(REG_SANITIZE_BACKSLASH,'/'),l=!0),4===u&&(s=s.substring(1),e=e.substring(1),u=2),l||a||u||(s=o._currentView+e),l||2!==u&&3!==u||(s=e.substring(1)),3===u&&(s='.'+F.path.package(s)),6===u&&(c=U.parseTheme(s),e=e.substring(e.indexOf('/')+1),s='.'+F.path.themes(c+'/views/'+e).replace(REG_SANITIZE_BACKSLASH,'/')),F.temporary.other[i]=s}return o.$viewrender(s,framework_internal.viewEngine(e,s,o),t,r,n,a)},Controller.prototype.viewCompile=function(e,t,r,n){return r===!0&&(n=!0,r=void 0),this.$viewrender('[dynamic view]',framework_internal.viewEngineCompile(e,this.language,this),t,r,n)},Controller.prototype.$viewrender=function(e,t,r,n,o,i){var s,a=this;if(!t)return s=new Error('View "'+e+'" not found.'),o?(F.error(s,a.name,a.uri),a.outputPartial):i?(a.res.throw500(s),a):(a.view500(s),a);var c='';a.$model=r,i&&(a._currentView=a._defaultView||'');var u=F.helpers;try{c=t.call(a,a,a.repository,r,a.session,a.query,a.body,a.url,F.global,u,a.user,a.config,F.functions,0,o?a.outputPartial:a.output,a.req.cookie,a.req.files,a.req.mobile,EMPTYOBJECT)}catch(t){return s=new Error('View "'+e+'": '+t.message),o?(a.error(s),a.partial?a.outputPartial='':a.output='',i=!1,c):(a.view500(s),a)}if(i||!a.precache||200!==a.status||o||a.precache(c,CT_HTML,n,!0),i||!a.layoutName){if(a.outputPartial='',a.output='',i=!1,o)return c;if(a.subscribe.success(),!a.isConnected)return a;var l=a.res;return l.options.body=c,l.options.code=a.status,l.options.type=CT_HTML,l.options.headers=n,l.$text(),F.stats.response.view++,a}return o?a.outputPartial=c:a.output=c,a.isLayout=!0,c=a.view(a.layoutName,a.$model,n,o),o?(a.outputPartial='',a.isLayout=!1,c):a},Controller.prototype.memorize=function(e,t,r,n,o){var i=this;if(r===!0)return n.call(i),i;i.themeName&&(e+='#'+i.themeName);var s=i.cache.read2();if(!s)return i.$memorize_prepare(e,t,r,n,o);if('function'==typeof r){var a=n;n=r,o=a}i.layoutName=s.layout,i.themeName=s.theme;var c=i.res;if(c.options.code=i.status,c.options.type=s.type,c.options.headers=s.headers,c.options.body=s.content,s.type!==CT_HTML)return o&&o.call(i),void c.$text();switch(s.type){case CT_TEXT:return F.stats.response.plain++,i;case CT_JSON:return F.stats.response.json++,i;case CT_HTML:F.stats.response.view++}for(var u=s.repository.length,l=0;l<u;l++){var e=s.repository[l].key;void 0===i.repository[e]&&(i.repository[e]=s.repository[l].value)}return o&&o.call(i),i.layoutName?(i.output=U.createBuffer(s.content),i.isLayout=!0,i.view(i.layoutName,null)):(i.subscribe.success(),c.$text()),i},Controller.prototype.$memorize_prepare=function(e,t,r,n,o){var i=this,s='$memorize'+e;return F.temporary.processing[s]?(setTimeout(function(){!i.subscribe.isCanceled&&i.memorize(e,t,r,n,o)},500),i):(i.precache=function(r,n,o,a){if(!r&&!n&&!o)return delete F.temporary.processing[s],void(i.precache=null);var c={content:r,type:n||CT_TEXT,layout:i.layoutName,theme:i.themeName};if(o&&(c.headers=o),a){c.repository=[];for(var u in i.repository){var r=i.repository[u];void 0!==r&&c.repository.push({key:u,value:r})}}i.cache.add(e,c,t),i.precache=null,delete F.temporary.processing[s]},'function'==typeof r&&(n=r),F.temporary.processing[s]=!0,n.call(i),i)};var NEWLINE='\r\n',SOCKET_RESPONSE='HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: {0}\r\n\r\n',SOCKET_RESPONSE_COMPRESS='HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: {0}\r\nSec-WebSocket-Extensions: permessage-deflate\r\n\r\n',SOCKET_RESPONSE_PROTOCOL='HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: {0}\r\nSec-WebSocket-Protocol: {1}\r\n\r\n',SOCKET_RESPONSE_PROTOCOL_COMPRESS='HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: {0}\r\nSec-WebSocket-Protocol: {1}\r\nSec-WebSocket-Extensions: permessage-deflate\r\n\r\n',SOCKET_HASH='258EAFA5-E914-47DA-95CA-C5AB0DC85B11',SOCKET_ALLOW_VERSION=[13];WebSocket.prototype={get global(){return F.global},get config(){return F.config},get cache(){return F.cache},get isDebug(){return F.config.debug},get path(){return F.path},get fs(){return F.fs},get isSecure(){return this.req.isSecure},get secured(){return this.req.secured}},WebSocket.prototype.emit=function(e,t,r,n,o,i,s,a){var c=this.$events[e];if(c){for(var u=!1,l=0,p=c.length;l<p;l++)c[l].$once&&(u=!0),c[l].call(this,t,r,n,o,i,s,a);u&&(c=c.remove(function(e){return e.$once}),c.length?this.$events[e]=c:this.$events[e]=void 0)}return this},WebSocket.prototype.on=function(e,t){return this.$events[e]?this.$events[e].push(t):this.$events[e]=[t],this},WebSocket.prototype.once=function(e,t){return t.$once=!0,this.on(e,t)},WebSocket.prototype.removeListener=function(e,t){var r=this.$events[e];return r&&(r=r.remove(function(e){return e===t}),r.length?this.$events[e]=r:this.$events[e]=void 0),this},WebSocket.prototype.removeAllListeners=function(e){return e===!0?this.$events=EMPTYOBJECT:e?this.$events[e]=void 0:this.$events={},this},WebSocket.prototype.send=function(e,t,r,n){var o=this._keys;if(!o||!o.length)return this;for(var i,s=!1,a=0,c=o.length;a<c;a++){var u=o[a],l=this.connections[u];if(t)if(t instanceof Array){if(!websocket_valid_array(u,t))continue}else{if(!(t instanceof Function))throw new Error('Invalid "id" argument.');if(!websocket_valid_fn(u,l,t))continue}if(r)if(r instanceof Array){if(websocket_valid_array(u,r))continue}else{if(!(r instanceof Function))throw new Error('Invalid "blacklist" argument.');if(websocket_valid_fn(u,l,r))continue}void 0===i&&(3===l.type?(s=!0,i=JSON.stringify(e,n)):i=e),l.send(i,s),F.stats.response.websocket++}return this},WebSocket.prototype.ping=function(){var e=this._keys;if(!e)return this;var t=e.length;if(!t)return this;this.$ping=!0,F.stats.other.websocketPing++;for(var r=0;r<t;r++)this.connections[e[r]].ping();return this},WebSocket.prototype.close=function(e,t,r){var n=this._keys;if(!n)return this;'string'==typeof e&&(r=t,t=e,e=null);var o=n.length;if(!o)return this;if(!e||!e.length){for(var i=0;i<o;i++){var s=n[i];this.connections[s].close(t,r),this._remove(s)}return this._refresh(),this}for(var a=e instanceof Array,c='function'==typeof e?e:null,i=0;i<o;i++){var s=n[i];if(!a||e.indexOf(s)!==-1){var u=this.connections[s];c&&!c.call(this,s,u)||(u.close(t,r),this._remove(s))}}return this._refresh(),this},WebSocket.prototype.error=function(e){var t=F.error('string'==typeof e?new Error(e):e,this.name,this.path);return void 0===e?t:this},WebSocket.prototype.wtf=WebSocket.prototype.problem=function(e){return F.problem(e,this.name,this.uri),this},WebSocket.prototype.change=function(e){return F.change(e,this.name,this.uri,this.ip),this},WebSocket.prototype.all=function(e){if(this._keys)for(var t=0,r=this._keys.length;t<r;t++)e(this.connections[this._keys[t]],t);return this},WebSocket.prototype.find=function(e){var t=this;if(!t._keys)return t;for(var r=t._keys.length,n='function'==typeof e,o=0;o<r;o++){var i=t.connections[t._keys[o]];if(n){if(e(i,i.id))return i}else if(i.id===e)return i}return null},WebSocket.prototype.destroy=function(e){var t=this;return e&&t.problem(e),t.connections||t._keys?(t.close(),t.$events.destroy&&t.emit('destroy'),setTimeout(function(){t._keys.forEach(function(e){var r=t.connections[e];r&&(r._isClosed=!0,r.socket.removeAllListeners())}),t.connections=null,t._keys=null,t.route=null,t.buffer=null,delete F.connections[t.id],t.removeAllListeners()},1e3),t):t},WebSocket.prototype.autodestroy=function(e){var t=this,r='websocket:'+t.id;return t.on('open',function(){return clearTimeout2(r)}),t.on('close',function(){!t.online&&setTimeout2(r,function(){e&&e.call(t),t.destroy()},5e3)}),t},WebSocket.prototype._refresh=function(){return this.connections?(this._keys=Object.keys(this.connections),this.online=this._keys.length):this.online=0,this},WebSocket.prototype._remove=function(e){return this.connections&&delete this.connections[e],this},WebSocket.prototype._add=function(e){return this.connections[e._id]=e,this},WebSocket.prototype.resource=function(e,t){return F.resource(e,t)},WebSocket.prototype.log=function(){return F.log.apply(framework,arguments),this},WebSocket.prototype.logger=function(){return F.logger.apply(framework,arguments),this},WebSocket.prototype.check=function(){return this.$ping?(this.all(function(e){e.$ping||(e.close(),F.stats.other.websocketCleaner++)}),this):this},WebSocketClient.prototype={get protocol(){return(this.req.headers['sec-websocket-protocol']||'').replace(REG_EMPTY,'').split(',')},get ip(){return this.req.ip},get get(){return this.req.query},get query(){return this.req.query},get uri(){return this.req.uri},get config(){return this.container.config},get global(){return this.container.global},get session(){return this.req.session},set session(e){this.req.session=e},get user(){return this.req.user},set user(e){this.req.user=e},get mobile(){return this.req.mobile}},WebSocketClient.prototype.isWebSocket=!0,WebSocketClient.prototype.cookie=function(e){return this.req.cookie(e)},WebSocketClient.prototype.prepare=function(e,t,r,n){e=e||EMPTYARRAY,t=t||EMPTYARRAY,r=r||EMPTYARRAY;var o=this;o.length=n;var i=o.req.headers.origin||'',n=r.length;if(n&&r.indexOf('*')===-1)for(var s=0;s<n;s++)if(i.indexOf(r[s])===-1)return!1;if(n=t.length)for(var s=0;s<n;s++)if(o.protocol.indexOf(t[s])===-1)return!1;if(SOCKET_ALLOW_VERSION.indexOf(U.parseInt(o.req.headers['sec-websocket-version']))===-1)return!1;var a=(o.req.headers['sec-websocket-extensions']||'').indexOf('permessage-deflate')!==-1,c=t.length?(a?SOCKET_RESPONSE_PROTOCOL_COMPRESS:SOCKET_RESPONSE_PROTOCOL).format(o.$weboscket_key(o.req),t.join(', ')):(a?SOCKET_RESPONSE_COMPRESS:SOCKET_RESPONSE).format(o.$weboscket_key(o.req));return o.socket.write(U.createBuffer(c,'binary')),a&&(o.inflatepending=[],o.inflatelock=!1,o.inflate=Zlib.createInflateRaw(),o.inflate.$websocket=o,o.inflate.on('error',F.error()),o.inflate.on('data',websocket_inflate),o.deflatepending=[],o.deflatelock=!1,o.deflate=Zlib.createDeflateRaw(),o.deflate.$websocket=o,o.deflate.on('error',F.error()),o.deflate.on('data',websocket_deflate)),o._id=Date.now()+U.GUID(5),o.id=o._id,!0},WebSocketClient.prototype.upgrade=function(e){var t=this;return t.container=e,t.socket.$websocket=this,t.socket.on('data',websocket_ondata),t.socket.on('error',websocket_onerror),t.socket.on('close',websocket_close),t.socket.on('end',websocket_close),t.container._add(t),t.container._refresh(),F.$events['websocket-begin']&&F.emit('websocket-begin',t.container,t),t.container.$events.open&&t.container.emit('open',t),t},WebSocketClient.prototype._ondata=function(e){if(e&&(CONCAT[0]=this.buffer,CONCAT[1]=e,this.buffer=Buffer.concat(CONCAT)),this.buffer.length>this.length)return this.errors++,void(this.container.$events.error&&this.container.emit('error',new Error('Maximum request length exceeded.'),this));switch(15&this.buffer[0]){case 1:1!==this.type&&this.parse();break;case 2:1===this.type&&this.parse();break;case 8:this.close();break;case 9:this.socket.write(U.getWebSocketFrame(0,'',10)),this.buffer=U.createBufferSize(),this.$ping=!0;break;case 10:this.$ping=!0,this.buffer=U.createBufferSize()}},WebSocketClient.prototype.parse=function(){var e=this.buffer[1];if((128&e)>>7!==1)return this;var t=U.getMessageLength(this.buffer,F.isLE),r=127&this.buffer[1];if(r=126==r?4:127==r?10:2,r+t+4>this.buffer.length)return this;var n=U.createBufferSize(4);if(this.buffer.copy(n,0,r,r+4),this.inflate){for(var o=U.createBufferSize(t),i=0;i<t;i++)o[i]=this.buffer[r+4+i]^n[i%4];this.inflatepending.push(o),this.parseInflate()}else if(1!==this.type){for(var s='',i=0;i<t;i++)s+=String.fromCharCode(this.buffer[r+4+i]^n[i%4]);this._decode(s)}else for(var a=U.createBufferSize(t),i=0;i<t;i++)a[i]=this.buffer[r+4+i]^n[i%4];return this.buffer=this.buffer.slice(r+t+4,this.buffer.length),this.buffer.length>=2&&U.getMessageLength(this.buffer,F.isLE)&&this.parse(),this},WebSocketClient.prototype.parseInflate=function(){var e=this;if(!e.inflatelock){var t=e.inflatepending.shift();t&&(e.inflatechunks=[],e.inflatechunkslength=0,e.inflatelock=!0,e.inflate.write(t),e.inflate.write(U.createBuffer(WEBSOCKET_COMPRESS)),e.inflate.flush(function(){var t=buffer_concat(e.inflatechunks,e.inflatechunkslength);e.inflatechunks=null,e.inflatelock=!1,e._decode(1===e.type?t:t.toString(ENCODING)),e.parseInflate()}))}},WebSocketClient.prototype._decode=function(e){if(1!==this.type)if(3===this.type)try{this.container.config['default-websocket-encodedecode']===!0&&(e=$decodeURIComponent(e)),e.isJSON()&&this.container.emit('message',this,F.onParseJSON(e,this.req))}catch(e){DEBUG&&(this.errors++,this.container.$events.error&&this.container.emit('error',new Error('JSON parser: '+e.toString()),this))}else this.container.emit('message',this,this.container.config['default-websocket-encodedecode']===!0?$decodeURIComponent(e):e);else this.container.emit('message',this,new Uint8Array(e).buffer);
},WebSocketClient.prototype._onerror=function(e){this.isClosed||(REG_WEBSOCKET_ERROR.test(e.stack)?(this.isClosed=!0,this._onclose()):this.container.$events.error&&this.container.emit('error',e,this))},WebSocketClient.prototype._onclose=function(){this._isClosed||(this.isClosed=!0,this._isClosed=!0,this.inflate&&(this.inflate.removeAllListeners(),this.inflate=null,this.inflatechunks=null),this.deflate&&(this.deflate.removeAllListeners(),this.deflate=null,this.deflatechunks=null),this.container._remove(this._id),this.container._refresh(),this.container.$events.close&&this.container.emit('close',this),this.socket.removeAllListeners(),F.$events['websocket-end']&&F.emit('websocket-end',this.container,this))},WebSocketClient.prototype.send=function(e,t,r){if(this.isClosed)return this;if(1!==this.type){var n=3===this.type?t?e:JSON.stringify(e,r):(e||'').toString();this.container.config['default-websocket-encodedecode']===!0&&n&&(n=encodeURIComponent(n)),this.deflate?(this.deflatepending.push(U.createBuffer(n)),this.sendDeflate()):this.socket.write(U.getWebSocketFrame(0,n,1))}else e&&(this.deflate?(this.deflatepending.push(U.createBuffer(e)),this.sendDeflate()):this.socket.write(U.getWebSocketFrame(0,new Int8Array(e),2)));return this},WebSocketClient.prototype.sendDeflate=function(){var e=this;if(!e.deflatelock){var t=e.deflatepending.shift();t&&(e.deflatechunks=[],e.deflatechunkslength=0,e.deflatelock=!0,e.deflate.write(1===e.type?new Int8Array(t):t),e.deflate.flush(function(){var t=buffer_concat(e.deflatechunks,e.deflatechunkslength);t=t.slice(0,t.length-4),e.deflatelock=!1,e.deflatechunks=null,e.socket.write(U.getWebSocketFrame(0,t,1===e.type?2:1,!0)),e.sendDeflate()}))}},WebSocketClient.prototype.ping=function(){return this.isClosed||(this.socket.write(U.getWebSocketFrame(0,'',9)),this.$ping=!1),this},WebSocketClient.prototype.close=function(e,t){return this.isClosed||(this.isClosed=!0,this.socket.end(U.getWebSocketFrame(t||1e3,e?encodeURIComponent(e):'',8))),this},WebSocketClient.prototype.$weboscket_key=function(e){var t=Crypto.createHash('sha1');return t.update((e.headers['sec-websocket-key']||'')+SOCKET_HASH),t.digest('base64')},Backup.prototype.restoreKey=function(e){var t=this,r=t.read;if(1===r.status)return void t.restoreValue(e);var n=-1,o=e;return 2===r.status?(CONCAT[0]=r.key,CONCAT[1]=o,o=Buffer.concat(CONCAT),n=o.indexOf(t.bufKey)):n=o.indexOf(t.bufKey),n===-1?(CONCAT[0]=r.key,CONCAT[1]=e,r.key=Buffer.concat(CONCAT),void(r.status=2)):(r.status=1,r.key=o.slice(0,n),t.restoreValue(o.slice(n+1)),void(o=null))},Backup.prototype.restoreValue=function(e){var t=this,r=t.read;if(1!==r.status)return void t.restoreKey(e);var n=e.indexOf(t.bufNew);return n===-1?(CONCAT[0]=r.value,CONCAT[1]=e,void(r.value=Buffer.concat(CONCAT))):(CONCAT[0]=r.value,CONCAT[1]=e.slice(0,n),r.value=Buffer.concat(CONCAT),t.restoreFile(r.key.toString('utf8').replace(REG_EMPTY,''),r.value.toString('utf8').replace(REG_EMPTY,'')),r.status=0,r.value=U.createBufferSize(),r.key=U.createBufferSize(),void t.restoreKey(e.slice(n+1)))},Backup.prototype.restore=function(e,t,r,n){if(!existsSync(e))return void(r&&r(new Error('Package not found.'),t));var o=this;o.filter=n,o.cache={},o.createDirectory(t,!0),o.path=t;var i=Fs.createReadStream(e);return i.on('data',function(e){return o.restoreKey(e)}),r?(r.path=t,i.on('end',function(){o.callback(r),i=null}),void i.resume()):void i.resume()},Backup.prototype.callback=function(e){var t=this;return t.pending<=0?e(null,e.path):void setTimeout(function(){return t.callback(e)},100)},Backup.prototype.restoreFile=function(e,t){var r=this;if('function'!=typeof r.filter||r.filter(e)){if('#'===t)return void r.createDirectory(e);var n=e,o=e.lastIndexOf('/');o!==-1&&(n=e.substring(0,o).trim(),n&&r.createDirectory(n));var i=U.createBuffer(t,'base64');r.pending++,Zlib.gunzip(i,function(t,n){Fs.writeFile(Path.join(r.path,e),n,function(){return r.pending--}),i=null})}},Backup.prototype.createDirectory=function(e,t){var r=this;if(!r.cache[e]){r.cache[e]=!0,'/'===e[0]&&(e=e.substring(1));var n=F.isWindows;n?'\\'===e[e.length-1]&&(e=e.substring(0,e.length-1)):'/'===e[e.length-1]&&(e=e.substring(0,e.length-1));var o=n?e.replace(/\//g,'\\').split('\\'):e.split('/'),i='';n&&o[0].indexOf(':')!==-1&&o.shift();for(var s=0,a=o.length;s<a;s++){var c=o[s];i+=n?(i?'\\':'')+c:(i?'/':'')+c;var u=Path.join(r.path,i);t&&(u=(n?'\\':'/')+u),!existsSync(u)&&Fs.mkdirSync(u)}}},http.ServerResponse.prototype.cookie=function(e,t,r,n){var o=this;if(!o.headersSent&&!o.success){var i=e+'=',s=[i+t],a='undefined'==typeof r?'undefined':_typeof(r);r&&!U.isDate(r)&&'object'===a&&(n=r,r=n.expires||n.expire||null),'string'===a&&(r=r.parseDateExpiration()),n||(n={}),n.path=n.path||'/',r&&s.push('Expires='+r.toUTCString()),n.domain&&s.push('Domain='+n.domain),n.path&&s.push('Path='+n.path),n.secure&&s.push('Secure'),(n.httpOnly||n.httponly||n.HttpOnly)&&s.push('HttpOnly');var c=o.getHeader('set-cookie')||[],u=c.findIndex(function(e){return e.startsWith(i)});return u!==-1&&c.splice(u,1),c.push(s.join('; ')),o.setHeader('Set-Cookie',c),o}},http.ServerResponse.prototype.noCache=function(){var e=this;return e.removeHeader(HEADER_CACHE),e.removeHeader('Etag'),e.removeHeader('Last-Modified'),e},http.ServerResponse.prototype.status=function(e){return this.options.code=e,this},http.ServerResponse.prototype.send=function(e,t,r){if(this.headersSent)return this;this.controller&&this.controller.subscribe.success();var n=this,o=this.req,i=r,s='HEAD'===o.method;switch(void 0===t&&(t=e,e=n.$statuscode||200),'undefined'==typeof t?'undefined':_typeof(t)){case'string':i||(i='text/html');break;case'number':i||(i='text/plain'),t=U.httpStatus(t);break;case'boolean':case'object':s||(t instanceof framework_builders.ErrorBuilder?(t=t.output(),i=t.contentType,F.stats.response.errorBuilder++):t=JSON.stringify(t),!i&&(i=CT_JSON))}var a=o.headers['accept-encoding']||'',c={};c[HEADER_CACHE]='private',c.Vary='Accept-Encoding'+(o.$mobile?', User-Agent':''),i===CT_JSON&&(c[HEADER_CACHE]='private, no-cache, no-store, must-revalidate'),/text|application/.test(i)&&(i+='; charset=utf-8'),c[HEADER_TYPE]=i,n.$custom(),!a&&isGZIP(o)&&(a='gzip');var u=F.config['allow-gzip']&&a.indexOf('gzip')!==-1;if(s)return u&&(c['Content-Encoding']='gzip'),n.writeHead(200,c),n.end(),n;if(!u)return n.writeHead(e,c),n.end(t,ENCODING),n;var l=U.createBuffer(t);return Zlib.gzip(l,function(r,o){return r?(n.writeHead(e,c),void n.end(t,ENCODING)):(c['Content-Encoding']='gzip',n.writeHead(e,c),void n.end(o,ENCODING))}),n},http.ServerResponse.prototype.content=function(e,t,r,n,o){if('object'===('undefined'==typeof n?'undefined':_typeof(n))){var i=o;o=n,n=i}var s=this;return s.options.code=e,s.options.compress=void 0===n||n===!0,s.options.body=t,s.options.type=r,o&&(s.options.headers=o),s.$text(),s},http.ServerResponse.prototype.redirect=function(e,t){return this.options.url=e,t&&(this.options.permanent=t),this.$redirect(),this},http.ServerResponse.prototype.file=function(e,t,r,n){return this.options.filename=e,r&&(this.options.headers=r),n&&(this.options.callback=n),t&&(this.options.download=t),this.$file()},http.ServerResponse.prototype.stream=function(e,t,r,n,o,i){var s=this;return s.options.type=e,s.options.stream=t,r&&(s.options.download=r),n&&(s.options.headers=n),o&&(s.options.callback=o),s.options.compress=!i,s.$stream(),s},http.ServerResponse.prototype.binary=function(e,t,r,n,o){return this.options.type=t,this.options.body=e,this.options.encoding=r,n&&(this.options.download=n),o&&(this.options.headers=o),this.$binary(),this},http.ServerResponse.prototype.proxy=function(e,t,r,n){var o=this;return o.success||o.headersSent?o:(n&&(o.options.callback=n),t&&(o.options.headers=t),r&&(o.options.timeout=r),U.resolve(e,function(e,t){var n={};n[HEADER_CACHE]='private',o.options.headers&&U.extend_headers2(n,o.options.headers);var i={protocol:t.protocol,auth:t.auth,method:'GET',hostname:t.hostname,port:t.port,path:t.path,agent:!1,headers:n},s='https:'===i.protocol?require('https'):http,a=F.config['allow-gzip']&&(o.req.headers['accept-encoding']||'').lastIndexOf('gzip')!==-1,c=s.get(i,function(e){if(!o.success&&!o.headersSent){var t=e.headers['content-type'],r=(e.headers['content-encoding']||'').lastIndexOf('gzip')!==-1,n=!r&&a&&(t.indexOf('text/')!==-1||t.lastIndexOf('javascript')!==-1||t.lastIndexOf('json')!==-1),i=e.headers['content-disposition']||'';return i&&o.setHeader('Content-Disposition',i),o.setHeader(HEADER_TYPE,t),o.setHeader('Vary','Accept-Encoding'+(o.req.$mobile?', User-Agent':'')),o.on('error',function(){e.close(),response_end(o)}),n?(o.setHeader('Content-Encoding','gzip'),void e.pipe(Zlib.createGzip()).pipe(o)):void(r&&!a?e.pipe(Zlib.createGunzip()).pipe(o):e.pipe(o))}});r&&c.setTimeout(r,function(){o.throw408()}),c.on('close',function(){o.success||(F.stats.response.pipe++,response_end(o))})}),o)},http.ServerResponse.prototype.image=function(e,t,r,n){var o=this;return o.options.make=t,r&&(o.options.headers=r),n&&(o.options.callback=n),'object'===('undefined'==typeof e?'undefined':_typeof(e))?o.options.stream=e:o.options.filename=e,o.$image(),o},http.ServerResponse.prototype.image_nocache=function(e,t,r,n){return this.options.cache=!1,this.image(e,t,r,n)},http.ServerResponse.prototype.json=function(e){var t=this;return F.stats.response.json++,t.options.body=JSON.stringify(e),t.options.type=CT_JSON,t.$text()},http.ServerResponse.prototype.continue=function(e){var t=this,r=t.req;if(e&&(t.options.callback=e),t.success||t.headersSent)return t;if(!F.config['static-accepts'][r.extension])return t.throw404(),t;if(r.$key=createTemporaryKey(r),F.temporary.notfound[r.$key])return t.throw404(),F;var n=r.uri.pathname,o=n.lastIndexOf('/'),i=F.routes.resize[n.substring(0,o+1)],s=!1,a=null;if(i?(n=n.substring(o+1),s=i.extension['*']||i.extension[r.extension],s?(n=i.path+$decodeURIComponent(n),a=F.onMapping(n,n,!1,!1)):a=F.onMapping(n,n,!0,!0)):a=F.onMapping(n,n,!0,!0),!s)return F.components.has&&F.components[r.extension]&&r.uri.pathname===F.config['static-url-components']+r.extension&&(t.noCompress=!0,a=F.path.temp('components.'+r.extension)),t.options.filename=a,t.$file(),F;if(!i.ishttp)return t.options.cache=i.cache,t.options.make=i.fn,t.options.filename=a,void t.$image();if(F.temporary.processing[r.uri.pathname])return void setTimeout($continue_timeout,500,t);var c=F.path.temp(r.$key);return F.temporary.path[r.$key]?(t.options.filename=r.uri.pathname,t.$file(),F):(F.temporary.processing[r.uri.pathname]=!0,U.download(n,FLAGS_DOWNLOAD,function(e,n){var o=Fs.createWriteStream(c);n.pipe(o),CLEANUP(o,function(){delete F.temporary.processing[r.uri.pathname];var e=n.headers['content-type'];return 200===n.statusCode&&e&&e.startsWith('image/')?(t.options.cache=i.cache,t.options.filename=c,t.options.maker=i.fn,void t.$image()):void t.throw404()})}),t)},http.ServerResponse.prototype.$file=function(){var e=this,t=e.options;if(e.headersSent)return e;var r=this.req;if(!r.$key&&(r.$key=createTemporaryKey(r)),F.temporary.notfound[r.$key])return DEBUG&&(F.temporary.notfound[r.$key]=void 0),e.throw404(),F;'@'===t.filename[0]&&(t.filename=F.path.package(t.filename.substring(1)));var n,o=F.temporary.path[r.$key];if(r.extension||(r.$key&&(r.extension=U.getExtension(r.$key)),!r.extension&&o&&(r.extension=U.getExtension(o),n=r.extension.lastIndexOf(';'),n!==-1&&(r.extension=r.extension.substring(0,n))),!r.extension&&t.filename&&(r.extension=U.getExtension(t.filename))),o&&RELEASE&&r.headers['if-modified-since']===o[2])return $file_notmodified(e,o),F;if(void 0===o)return F.isProcessing(r.$key)?(r.processing>F.config['default-request-timeout']?e.throw408():(r.processing+=500,setTimeout($file_processing,500,e)),F):(F.temporary.processing[r.$key]=!0,F.compile_check(e),F);var i,s=U.getContentType(r.extension),a=r.headers['accept-encoding']||'';!a&&isGZIP(r)&&(a='gzip');var c=F.config['allow-gzip']&&COMPRESSION[s]&&a.indexOf('gzip')!==-1,u=r.headers.range,l=RELEASE&&'text/cache-manifest'!==s;return i=l?c?u?HEADERS.file_release_compress_range:HEADERS.file_release_compress:u?HEADERS.file_release_range:HEADERS.file_release:c?u?HEADERS.file_debug_compress_range:HEADERS.file_debug_compress:u?HEADERS.file_debug_range:HEADERS.file_debug,r.$mobile?i.Vary='Accept-Encoding, User-Agent':i.Vary='Accept-Encoding',i[HEADER_TYPE]=s,REG_TEXTAPPLICATION.test(s)&&(i[HEADER_TYPE]+='; charset=utf-8'),l&&!e.getHeader('Expires')?i.Expires=DATE_EXPIRES:i.Expires&&delete i.Expires,e.options.headers&&(i=U.extend_headers(i,e.options.headers)),e.options.download?i['Content-Disposition']='attachment; filename="'+encodeURIComponent(e.options.download)+'"':i['Content-Disposition']&&delete i['Content-Disposition'],e.getHeader('Last-Modified')?delete i['Last-Modified']:i['Last-Modified']=o[2],i.Etag=ETAG+F.config['etag-version'],u?($file_range(o[0],u,i,e),F):(DEBUG&&F.isProcessed(r.$key)&&(F.temporary.path[r.$key]=void 0),o[1]&&!c?i[HEADER_LENGTH]=o[1]:i[HEADER_LENGTH]&&delete i[HEADER_LENGTH],F.stats.response.file++,void('HEAD'===r.method?(e.writeHead(e.options.code||200,i),e.end(),response_end(e)):c?(e.writeHead(e.options.code||200,i),fsStreamRead(o[0],void 0,$file_compress,e)):(e.writeHead(e.options.code||200,i),fsStreamRead(o[0],void 0,$file_nocompress,e))))},http.ServerResponse.prototype.$redirect=function(){var e=this;return e.headersSent?e:(HEADERS.redirect.Location=e.options.url,e.writeHead(e.options.permanent?301:302,HEADERS.redirect),e.end(),response_end(e),F.stats.response.redirect++,e)},http.ServerResponse.prototype.$binary=function(){var e=this;if(e.headersSent)return e;var t=e.req,r=e.options,n=t.headers['accept-encoding']||'';!n&&isGZIP(t)&&(n='gzip');var o=F.config['allow-gzip']&&COMPRESSION[r.type]&&n.indexOf('gzip')!==-1,i=o?HEADERS.binary_compress:HEADERS.binary;return i.Vary='Accept-Encoding'+(t.$mobile?', User-Agent':''),r.download?i['Content-Disposition']='attachment; filename='+encodeURIComponent(r.download):i['Content-Disposition']&&delete i['Content-Disposition'],i[HEADER_TYPE]=r.type,r.headers&&(i=U.extend_headers(i,r.headers)),F.stats.response.binary++,'HEAD'===t.method?(e.writeHead(r.code||200,i),e.end(),response_end(e)):o?(e.writeHead(r.code||200,i),Zlib.gzip(r.encoding&&'binary'!==r.encoding?r.body.toString(r.encoding):r.body,function(t,r){return e.end(r)}),response_end(e)):(e.writeHead(r.code||200,i),e.end(r.encoding&&'binary'!==r.encoding?r.body.toString(r.encoding):r.body),response_end(e)),F},http.ServerResponse.prototype.$stream=function(){var e=this,t=e.req,r=e.options;if(e.headersSent)return e;var n=t.headers['accept-encoding']||'';!n&&isGZIP(t)&&(n='gzip');var o,i=(void 0===r.compress||r.compress)&&F.config['allow-gzip']&&COMPRESSION[r.type]&&n.indexOf('gzip')!==-1;return o=RELEASE?i?HEADERS.stream_release_compress:HEADERS.stream_release:i?HEADERS.stream_debug_compress:HEADERS.stream_debug,o.Vary='Accept-Encoding'+(t.$mobile?', User-Agent':''),RELEASE&&(o.Expires=DATE_EXPIRES,o['Last-Modified']='Mon, 01 Jan 2001 08:00:00 GMT'),r.download?o['Content-Disposition']='attachment; filename='+encodeURIComponent(r.download):o['Content-Disposition']&&delete o['Content-Disposition'],o[HEADER_TYPE]=r.type,r.headers&&(o=U.extend_headers(o,r.headers)),F.stats.response.stream++,F.reqstats(!1,t.isStaticFile),'HEAD'===t.method?(e.writeHead(r.code||200,o),e.end(),response_end(e),F):i?(e.writeHead(r.code||200,o),e.on('error',function(){return r.stream.close()}),r.stream.pipe(Zlib.createGzip()).pipe(e),framework_internal.onFinished(e,function(){return framework_internal.destroyStream(r.stream)}),response_end(e),F):(e.writeHead(r.code||200,o),framework_internal.onFinished(e,function(){return framework_internal.destroyStream(r.stream)}),r.stream.pipe(e),response_end(e),F)},http.ServerResponse.prototype.$image=function(){var e=this,t=e.options;if(t.cache===!1)return $image_nocache(e);var r=this.req;if(!r.$key&&(r.$key=createTemporaryKey(r)),F.temporary.notfound[r.$key])return DEBUG&&(F.temporary.notfound[r.$key]=void 0),e.throw404(),F;var n=r.$key||createTemporaryKey(r);if(F.temporary.notfound[n])return e.throw404(),e;var o=F.temporary.path[n];if(t.filename&&'@'===t.filename[0]&&(t.filename=F.path.package(t.filename.substring(1))),void 0!==o)return e.$file(),F;if(F.isProcessing(r.$key))return r.processing>F.config['default-request-timeout']?e.throw408():(r.processing+=500,setTimeout($image_processing,500,e)),F;var i=F.id?'i-'+F.id+'_':'';return t.name=F.path.temp(i+n),F.temporary.processing[n]=!0,t.stream?fsFileExists(t.name,$image_stream,e):fsFileExists(t.filename,$image_filename,e),F},http.ServerResponse.prototype.$custom=function(){return F.stats.response.custom++,response_end(this),this},http.ServerResponse.prototype.$text=function(){var e=this,t=e.req,r=e.options;if(e.headersSent)return e;var n=t.headers['accept-encoding']||'';!n&&isGZIP(t)&&(n='gzip');var o,i=!(!F.config['allow-gzip']||void 0!==r.compress&&!r.compress)&&n.indexOf('gzip')!==-1;return o=t.$mobile?i?HEADERS.content_mobile_release:HEADERS.content_mobile:i?HEADERS.content_compress:HEADERS.content,r.type===CT_JSON?o[HEADER_CACHE]='private, no-cache, no-store, must-revalidate':o[HEADER_CACHE]='private',REG_TEXTAPPLICATION.test(r.type)&&(r.type+='; charset=utf-8'),o[HEADER_TYPE]=r.type,r.headers&&(o=U.extend_headers(o,r.headers)),'HEAD'===t.method?(e.writeHead(r.code||200,o),e.end()):i?(e.writeHead(r.code||200,o),Zlib.gzip(r.body instanceof Buffer?r.body:U.createBuffer(r.body),function(t,r){return e.end(r,e.options.encoding||ENCODING)})):(e.writeHead(r.code||200,o),e.end(r.body,e.options.encoding||ENCODING)),response_end(e),e},http.ServerResponse.prototype.throw400=function(e){return this.options.code=400,e&&(this.options.problem=e),this.$throw()},http.ServerResponse.prototype.throw401=function(e){return this.options.code=401,e&&(this.options.problem=e),this.$throw()},http.ServerResponse.prototype.throw403=function(e){return this.options.code=403,e&&(this.options.problem=e),this.$throw()},http.ServerResponse.prototype.throw404=function(e){return this.options.code=404,e&&(this.options.problem=e),this.$throw()},http.ServerResponse.prototype.throw408=function(e){return this.options.code=408,e&&(this.options.problem=e),this.$throw()},http.ServerResponse.prototype.throw431=function(e){return this.options.code=431,e&&(this.options.problem=e),this.$throw()},http.ServerResponse.prototype.throw500=function(e){return e&&F.error(e,null,this.req.uri),this.options.code=500,this.options.body=U.httpStatus(500)+e?prepare_error(e):'',this.$throw()},http.ServerResponse.prototype.throw501=function(e){return this.options.code=501,e&&(this.options.problem=e),this.$throw()},http.ServerResponse.prototype.$throw=function(){var e=this;if(e.success||e.headersSent)return e;var t=e.req;e.options.problem&&F.problem(e.options.problem,'response'+e.options.code+'()',t.uri,t.ip),e.writeHead(e.options.code||501,e.options.headers||HEADERS.responseCode),'HEAD'===t.method?e.end():e.end(e.options.body||U.httpStatus(e.options.code));var r='error'+e.options.code;return F.$events[r]&&F.emit(r,t,e,e.options.problem),F.stats.response[r]++,response_end(e),e};var _tmp=http.IncomingMessage.prototype;http.IncomingMessage.prototype={get ip(){var e=this;if(e._ip)return e._ip;var t=e.headers['x-forwarded-for'];return t?e._ip=t.split(',',1)[0]||e.connection.remoteAddress:e._ip||(e._ip=e.connection.remoteAddress),e._ip},get query(){var e=this;return!e._querydata&&F.$onParseQueryUrl(e),e._querydata},set query(e){this._querydata=e},get subdomain(){var e=this;if(e._subdomain)return e._subdomain;var t=e.uri.host.toLowerCase().replace(/^www\./i,'').split('.');return t.length>2?e._subdomain=t.slice(0,t.length-2):e._subdomain=null,e._subdomain},get host(){return this.headers.host},get split(){return this.$path?this.$path:this.$path=framework_internal.routeSplit(this.uri.pathname,!0)},get secured(){return'https:'===this.uri.protocol||'wss:'===this.uri.protocol},get language(){return this.$language||(this.$language=(((this.headers['accept-language']||'').split(';')[0]||'').split(',')[0]||'').toLowerCase()),this.$language},get mobile(){return void 0===this.$mobile&&(this.$mobile=REG_MOBILE.test(this.headers['user-agent'])),this.$mobile},get robot(){return void 0===this.$robot&&(this.$robot=REG_ROBOT.test(this.headers['user-agent'])),this.$robot},set language(e){this.$language=e}},http.IncomingMessage.prototype.__proto__=_tmp,http.IncomingMessage.prototype.signature=function(e){return F.encrypt((this.headers['user-agent']||'')+'#'+this.ip+'#'+this.url+'#'+(e||''),'request-signature',!1)},http.IncomingMessage.prototype.localize=function(){return F.onLocale&&(this.$language=F.onLocale(this,this.res,this.isStaticFile)),this.$language},http.IncomingMessage.prototype.noCache=function(){return delete this.headers['if-none-match'],delete this.headers['if-modified-since'],this},http.IncomingMessage.prototype.notModified=function(e,t){return F.notModified(this,this.res,e,t)},http.IncomingMessage.prototype.cookie=function(e){if(this.cookies)return $decodeURIComponent(this.cookies[e]||'');var t=this.headers.cookie;if(!t)return'';this.cookies={};for(var r=t.split(';'),n=0,o=r.length;n<o;n++){var i=r[n].trim(),s=i.indexOf('=');s!==-1&&(this.cookies[i.substring(0,s)]=i.substring(s+1))}return $decodeURIComponent(this.cookies[e]||'')},http.IncomingMessage.prototype.authorization=function(){var e=this.headers.authorization;if(!e)return HEADERS.authorization;var t={user:'',password:'',empty:!0};try{var r=U.createBuffer(e.replace('Basic ','').trim(),'base64').toString(ENCODING).split(':');t.user=r[0]||'',t.password=r[1]||'',t.empty=!t.user||!t.password}catch(e){}return t},http.IncomingMessage.prototype.authorize=function(e){var t=F.onAuthorize;if(!t)return e(null,null,!1),this;var r=this;return t(r,r.res,r.flags,function(t,n){'boolean'!=typeof t&&(n=t,t=!n),r.isAuthorized=t,e(null,n,t)}),this},http.IncomingMessage.prototype.clear=function(e){var t=this,r=t.files;if(!r||e&&t._manual)return t;t.body=null,t.query=null,t.cookies=null;var n=r.length;if(!n)return t;for(var o=[],i=0;i<n;i++)r[i].rem&&o.push(r[i].path);return F.unlink(o),t.files=null,t},http.IncomingMessage.prototype.hostname=function(e){var t=this,r=t.uri;return e&&'/'!==e[0]&&(e='/'+e),r.protocol+'//'+r.hostname+(r.port&&80!==r.port?':'+r.port:'')+(e||'')},global.Controller=Controller,process.on('uncaughtException',function(e){return e.toString().indexOf('listen EADDRINUSE')!==-1?('function'==typeof process.send&&process.send('eaddrinuse'),console.log('\nThe IP address and the PORT is already in use.\nYou must change the PORT\'s number or IP address.\n'),void process.exit('SIGTERM')):F.isTest?void(F.testContinue&&F.testContinue(e)):void F.error(e,'',null)}),process.on('SIGTERM',function(){return F.stop()}),process.on('SIGINT',function(){return F.stop()}),process.on('exit',function(){return F.stop()}),process.on('message',function(e,t){return'string'!=typeof e?void(F.$events.message&&F.emit('message',e,t)):'debugging'===e?void U.wait(function(){return F.isLoaded},function(){F.isLoaded=void 0,F.console()},1e4,500):'reconnect'===e?void F.reconnect():'reconfigure'===e?(F.$configure_configs(),F.$configure_versions(),F.$configure_workflows(),F.$cofnigure_sitemap(),void F.emit(e)):'reset'===e?void F.cache.clear():'stop'===e||'exit'===e?void F.stop():void(F.$events.message&&F.emit('message',e,t))}),global.setTimeout2=function(e,t,r,n,o){var i=':'+e;if(n>0){var s=i+':limit';if(F.temporary.internal[s]>=n)return;return F.temporary.internal[s]=(F.temporary.internal[s]||0)+1,F.temporary.internal[i]&&clearTimeout(F.temporary.internal[i]),F.temporary.internal[i]=setTimeout(function(){F.temporary.internal[s]=void 0,t&&t()},r,o)}return F.temporary.internal[i]&&clearTimeout(F.temporary.internal[i]),F.temporary.internal[i]=setTimeout(t,r,o)},global.clearTimeout2=function(e){var t=':'+e;return!!F.temporary.internal[t]&&(clearTimeout(F.temporary.internal[t]),F.temporary.internal[t]=void 0,F.temporary.internal[t+':limit']&&(F.temporary.internal[t+':limit']=void 0),!0)};var EMPTYCONTROLLER=new Controller('',null,null,null,'');EMPTYCONTROLLER.isConnected=!1,EMPTYCONTROLLER.req={},EMPTYCONTROLLER.req.url='',EMPTYCONTROLLER.req.uri=EMPTYOBJECT,EMPTYCONTROLLER.req.query=EMPTYOBJECT,EMPTYCONTROLLER.req.body=EMPTYOBJECT,EMPTYCONTROLLER.req.files=EMPTYARRAY;