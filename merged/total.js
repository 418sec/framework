// Copyright 2012-2016 (c) Peter Å irka <petersirka@gmail.com>
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

"use strict";function Framework(){this.id=null,this.version=2e3,this.version_header="2.0.0-56",this.version_node=process.version.toString().replace("v","").replace(/\./g,"").parseFloat(),this.config={debug:!1,trace:!0,name:"total.js",version:"1.01",author:"",secret:os.hostname()+"-"+os.platform()+"-"+os.arch(),"etag-version":"","directory-controllers":"/controllers/","directory-views":"/views/","directory-definitions":"/definitions/","directory-temp":"/tmp/","directory-models":"/models/","directory-resources":"/resources/","directory-public":"/public/","directory-public-virtual":"/app/","directory-modules":"/modules/","directory-source":"/source/","directory-logs":"/logs/","directory-tests":"/tests/","directory-databases":"/databases/","directory-workers":"/workers/","directory-packages":"/packages/","directory-private":"/private/","directory-isomorphic":"/isomorphic/","directory-configs":"/configs/","directory-services":"/services/","directory-themes":"/themes/","static-url":"","static-url-script":"/js/","static-url-style":"/css/","static-url-image":"/img/","static-url-video":"/video/","static-url-font":"/fonts/","static-url-download":"/download/","static-accepts":{".jpg":!0,".png":!0,".gif":!0,".ico":!0,".js":!0,".css":!0,".txt":!0,".xml":!0,".woff":!0,".woff2":!0,".otf":!0,".ttf":!0,".eot":!0,".svg":!0,".zip":!0,".rar":!0,".pdf":!0,".docx":!0,".xlsx":!0,".doc":!0,".xls":!0,".html":!0,".htm":!0,".appcache":!0,".manifest":!0,".map":!0,".ogv":!0,".ogg":!0,".mp4":!0,".mp3":!0,".webp":!0,".webm":!0,".swf":!0,".package":!0,".json":!0,".md":!0,".m4v":!0,".jsx":!0},"default-layout":"layout","default-theme":"","default-request-length":10,"default-websocket-request-length":2,"default-websocket-encodedecode":!0,"default-maximum-file-descriptors":0,"default-timezone":"","default-root":"","default-response-maxage":"11111111","default-cors-maxage":120,"default-request-timeout":5e3,"default-image-converter":"gm","default-image-quality":93,"allow-handle-static-files":!0,"allow-gzip":!0,"allow-websocket":!0,"allow-compile-script":!0,"allow-compile-style":!0,"allow-compile-html":!0,"allow-performance":!1,"allow-custom-titles":!1,"allow-compatibility":!1,"disable-strict-server-certificate-validation":!0,"disable-clear-temporary-directory":!0,"default-interval-clear-resources":20,"default-interval-clear-cache":7,"default-interval-precompile-views":61,"default-interval-websocket-ping":3,"default-interval-clear-dnscache":120},this.global={},this.resources={},this.connections={},this.functions={},this.themes={},this.versions=null,this.schedules=[],this.isDebug=!0,this.isTest=!1,this.isLoaded=!1,this.isWorker=!0,this.isCluster=require("cluster").isWorker,this.routes={sitemap:null,web:[],files:[],cors:[],websockets:[],middleware:{},redirects:{},resize:{},request:[],views:{},merge:{},mapping:{},packages:{},blocks:{},resources:{}},this.behaviours=null,this.modificators=null,this.helpers={},this.modules={},this.models={},this.sources={},this.controllers={},this.dependencies={},this.isomorphic={},this.tests=[],this.errors=[],this.problems=[],this.changes=[],this.server=null,this.port=0,this.ip="",this.workers={},this.databases={},this.directory=HEADERS.workers.cwd=directory,this.isLE=os.endianness?"LE"===os.endianness():!0,this.isHTTPS=!1,this.datetime=new Date,this.temporary={path:{},processing:{},range:{},views:{},dependencies:{},other:{},internal:{}},this.stats={other:{websocketPing:0,websocketCleaner:0,obsolete:0,restart:0},request:{request:0,pending:0,web:0,xhr:0,file:0,websocket:0,get:0,options:0,head:0,post:0,put:0,path:0,upload:0,blocked:0,"delete":0,mobile:0,desktop:0},response:{view:0,json:0,websocket:0,timeout:0,custom:0,binary:0,pipe:0,file:0,destroy:0,stream:0,streaming:0,plain:0,empty:0,redirect:0,forward:0,restriction:0,notModified:0,sse:0,error400:0,error401:0,error403:0,error404:0,error408:0,error431:0,error500:0,error501:0}},this.cache=new FrameworkCache,this.path=new FrameworkPath,this.restrictions=new FrameworkRestrictions,this._request_check_redirect=!1,this._request_check_referer=!1,this._request_check_POST=!1,this._request_check_robot=!1,this._length_middleware=0,this._length_request_middleware=0,this._length_files=0,this._length_wait=0,this._length_themes=0,this._length_cors=0,this._length_subdomain_web=0,this._length_subdomain_websocket=0,this.isVirtualDirectory=!1,this.isTheme=!1,this.isWindows="win"===os.platform().substring(0,3).toLowerCase()}function merge_middleware(e,r){"string"==typeof r&&(r=[r]);for(var t=0,n=r.length;n>t;t++){var o=e.indexOf(r[t]);-1===o&&e.push(r[t])}return e}function merge_debug_writer(e,r,t,n,o){var i="===========================================================================================",s="js"===t?"/*\n":"css"===t?"/*!\n":"<!--\n",a="js"===t||"css"===t?"\n */":"\n-->",u="html"!==t?" * ":" ";e.write((n>0?"\n\n":"")+s+u+i+"\n"+u+"MERGED: "+r+"\n"+(o?u+"BLOCKS: "+o+"\n":"")+u+i+a+"\n\n",ENCODING)}function FrameworkRestrictions(){this.is=!1,this.isAllowedIP=!1,this.isBlockedIP=!1,this.isAllowedCustom=!1,this.isBlockedCustom=!1,this.allowedIP=[],this.blockedIP=[],this.allowedCustom={},this.blockedCustom={},this.allowedCustomKeys=[],this.blockedCustomKeys=[]}function FrameworkPath(){}function FrameworkCache(){this.items={},this.count=1,this.interval=null}function Subscribe(e,r,t,n){this.req=r,this.res=t}function Controller(e,r,t,n,o){this.subscribe=n,this.name=e,r?(this.language=r.$language,this.req=r):this.req=EMPTYREQUEST,this.type=0,this.status=200,this.isConnected=!0,this.isController=!0,this.repository={},this._currentView=o,t?(this.res=t,this.res.controller=this):this.res=EMPTYOBJECT}function WebSocket(e,r,t){this._keys=[],this.id=t,this.online=0,this.connections={},this.repository={},this.name=r,this.isController=!0,this.url=framework_utils.path(e),this.route=null}function websocket_valid_array(e,r){return-1!==r.indexOf(e)}function websocket_valid_fn(e,r,t){return!!t(e,r)}function WebSocketClient(e,r,t){this.$ping=!0,this.container,this._id,this.id="",this.socket=r,this.req=e,this.errors=0,this.buffer=new Buffer(0),this.length=0,this.type=2}function Backup(){this.file=[],this.directory=[],this.path="",this.read={key:new Buffer(0),value:new Buffer(0),status:0},this.pending=0,this.cache={},this.complete=NOOP,this.filter=function(){return!0},this.bufKey=new Buffer(":"),this.bufNew=new Buffer("\n")}function $decodeURIComponent(e){try{return decodeURIComponent(e)}catch(r){return e}}function fsFileRead(e,r){U.queue("framework.files",F.config["default-maximum-file-descriptors"],function(t){fs.readFile(e,function(e,n){t(),r(e,n)})})}function fsFileExists(e,r){U.queue("framework.files",F.config["default-maximum-file-descriptors"],function(t){fs.lstat(e,function(e,n){t(),r(!e&&n.isFile(),n?n.size:0,n?n.isFile():!1)})})}function fsStreamRead(e,r,t){t||(t=r,r=void 0);var n;r?(n=HEADERS.fsStreamReadRange,n.start=r.start,n.end=r.end):n=HEADERS.fsStreamRead,U.queue("framework.files",F.config["default-maximum-file-descriptors"],function(r){var o=fs.createReadStream(e,n);o.on("error",noop),t(o,r)})}function createTemporaryKey(e){return(e.uri?e.uri.pathname:e).replace(TEMPORARY_KEY_REGEX,"-").substring(1)}function prepare_error(e){return framework.isDebug&&e?e instanceof ErrorBuilder?" :: "+e.plain():e.stack?" :: "+e.stack.toString():" :: "+e.toString():""}function prepare_filename(e){return"@"===e[0]?framework.isWindows?framework_utils.combine(framework.config["directory-temp"],e.substring(1)):framework.path["package"](e.substring(1)):framework_utils.combine("/",e)}function prepare_staticurl(e,r){if(!e)return e;if("~"===e[0]){if(r)return framework_utils.path(e.substring(1))}else if("//"===e.substring(0,2)||"http:/"===e.substring(0,6)||"https:/"===e.substring(0,7))return e;return e}function prepare_isomorphic(e){e=e.replace(/\.js$/i,"");var r=framework.isomorphic[e];return r=r?r.$$output:"",'if(window["isomorphic"]===undefined)window.isomorphic={};isomorphic["'+e+'"]=(function(framework,F,U,utils,Utils,is_client,is_server){var module={},exports=module.exports={};'+r+";return exports;})(null,null,null,null,null,true,false)"}function isGZIP(e){var r=e.headers["user-agent"];return r?-1!==r.lastIndexOf("Firefox"):!1}function prepare_viewname(e){return e.substring(e.indexOf("/",2)+1)}function existsSync(e,r){try{var t=fs.statSync(e);return t?r?t.isFile():!0:!1}catch(n){return!1}}function async_middleware(e,r,t,n,o,i,s){if(t.success||t.headersSent)return s&&s.subscribe.success(),void(o=null);var a=n[e++];if(!a)return o&&o();var u=framework.routes.middleware[a];if(!u)return framework.error("Middleware not found: "+a,null,r.uri),async_middleware(e,r,t,n,o,i,s);var c=u.call(framework,r,t,function(a){return a?(t.throw500(a),void(o=null)):void async_middleware(e,r,t,n,o,i,s)},i,s);c===!1&&(o=null)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};!function(e){function r(e){this.name=e,this.collection={}}function t(e,r){this.parent=e,this.name=r,this.primary,this.trim=!0,this.schema={},this.properties=[],this.resourcePrefix,this.resourceName,this.transforms,this.operations,this.constants,this.onPrepare,this.onDefault,this.onValidate=framework.onValidate,this.onSave,this.onGet,this.onRemove,this.onQuery,this.onError,this.gcache={},this.dependencies,this.fields,this.fields_allow,this.CurrentSchemaInstance=function(){},this.CurrentSchemaInstance.prototype=new a,this.CurrentSchemaInstance.prototype.$$schema=this}function n(e,r){r.raw="string";var t=e.indexOf("(");return-1===t?r:(r.length=e.substring(t+1,e.length-1).parseInt(),r.raw=e.substring(0,t),r)}function o(e,r,t){return e.gcache[r]?e.gcache[r]:e.gcache[r]="function*"===t.toString().substring(0,9)}function i(e,r){return e.trim?r.trim():r}function s(e){if(!e)return e;var r="undefined"==typeof e?"undefined":_typeof(e);if("object"!==r||e instanceof Date)return e;var t,n;if(e instanceof Array){t=e.length,n=new Array(t);for(var o=0;t>o;o++)if(r=_typeof(e[o]),"object"!==r||e[o]instanceof Date){if("function"===r)continue;n[o]=e[o]}else n[o]=s(e[o]);return n}n={};for(var i in e)if(!v[i]){var u=e[i];if(u instanceof a)n[i]=s(u);else{var r="undefined"==typeof u?"undefined":_typeof(u);if("object"!==r||u instanceof Date){if("function"===r)continue;n[i]=u}else n[i]=s(e[i])}}return n}function a(){}function u(e){this.items=[],this.transformName=E.error_default,this.onResource=e,this.resourceName=framework.config["default-errorbuilder-resource-name"]||"default",this.resourcePrefix=framework.config["default-errorbuilder-resource-prefix"]||"",this.isResourceCustom=!1,this.count=0,this.replacer=[],this.isPrepared=!1,this.contentType="application/json",e||this._resource()}function c(){this.builder={}}function l(e,r){return void 0===e?r:e}function f(e,r,t,n){this.isNext=!1,this.isPrev=!1,this.isFirst=!1,this.isLast=!1,this.nextPage=0,this.prevPage=0,this.lastPage=0,this.firstPage=0,this.items=Math.max(0,+e),this.count=0,this.skip=0,this.take=0,this.page=0,this.max=0,this.visible=!1,this.format=n||"?page={0}",this.refresh(e,r,t),this.transformName=E.pagination_default}function p(e,r,t,n){this.url=e,this.page=r,this.selected=t,this.enabled=n}function d(){}var m=e.exports;global.framework_builders=e.exports;var h='The field "@" is required.',g="default",v={$$schema:!0,$$result:!0,$callback:!0,$$async:!0},y=/\s/g,b=/\s|\.|\-|\(|\)/g,w=Object.prototype.hasOwnProperty,k={},E={pagination:{},error:{},objectbuilder:{},transformbuilder:{}};return r.prototype.get=function(e){return this.collection[e]},r.prototype.create=function(e){var r=this;return r.collection[e]=new t(r,e),r.collection[e]},r.prototype.remove=function(e){var r=this;if(!e)return delete k[e],void(r.collection=null);var t=r.collection[e];return t&&t.remove(),t=null,r},r.prototype.destroy=function(e){return this.remove(e)},t.prototype.allow=function(e){var r=this;r.fields_allow||(r.fields_allow=[]);for(var t=0,n=arguments.length;n>t;t++)arguments[t]instanceof Array?arguments[t].forEach(function(e){return r.fields_allow.push(e)}):r.fields_allow.push(arguments[t]);return r},t.prototype.define=function(e,r,n,o){var i=this;if(e instanceof Array){for(var s=0,a=e.length;a>s;s++)i.define(e[s],r,n,o);return i}switch(void 0!==n&&"boolean"!=typeof n&&(o=n,n=!1),r instanceof t&&(r=r.name),i.schema[e]=i.$parse(e,r,n,o),i.schema[e].type){case 7:i.dependencies||(i.dependencies=[]),i.dependencies.push(e)}return i.fields=Object.keys(i.schema),n?(null==i.properties&&(i.properties=[]),-1!==i.properties.indexOf(e)?i:(i.properties.push(e),i)):i},t.prototype.setPrimary=function(e){return this.primary=e,this},t.prototype.filter=function(e,r,t){var n=this;if("boolean"==typeof r){var o=t;t=r,r=o}var i=void 0===r?[]:{},s="undefined"==typeof e?"undefined":_typeof(e),a="string"===s?"*"===e[0]||"%"===e[0]:!1,u=!1;a?e=e.substring(1):"object"===s&&(u=framework_utils.isRegExp(e));for(var c in n.schema){var l=n.schema[c];if(l){var f=_typeof(l.custom);if(a){if("string"!==f)continue;if(-1===l.custom.indexOf(e)){if(!t)continue}else if(t)continue}else if(u){if("string"!==f)continue;if(e.test(l.current)){if(t)continue}else if(!t)continue}else if(l.custom!==e){if(!t)continue}else if(t)continue;void 0===r?i.push(c):i[c]=r[c]}}return i},t.prototype.$parse=function(e,r,t,o){var i="undefined"==typeof r?"undefined":_typeof(r),s={};if(s.raw=r,s.type=0,s.length=0,s.required=!!t,s.isArray=!1,s.custom=o||"",null===r)return s;if("[]"===r)return s.isArray=!0,s;if("function"===i)return r===Number?(s.type=2,s):r===String?(s.type=3,s):r===Boolean?(s.type=4,s):r===Date?(s.type=5,s):r===Array?(s.isArray=!0,s):r===Object?(s.type=6,s):s;if("object"===i)return s;"["===r[0]&&(r=r.substring(1,r.length-1),s.isArray=!0,s.raw=r);var a=r.toLowerCase();return"object"===a?(s.type=6,s):"array"===a?(s.isArray=!0,s):a.contains(["string","text","varchar","nvarchar"])?(s.type=3,n(a,s)):-1!==a.indexOf("capitalize")||-1!==a.indexOf("camel")?(s.type=3,s.subtype="capitalize",n(a,s)):-1!==a.indexOf("lower")?(s.subtype="lowercase",s.type=3,n(a,s)):-1!==a.indexOf("upper")?(s.subtype="uppercase",s.type=3,n(a,s)):"uid"===a?(s.type=3,s.length=20,s.raw="string",s.subtype="uid",s):"email"===a?(s.type=3,s.length=120,s.raw="string",s.subtype="email",s):"json"===a?(s.type=3,s.raw="string",s.subtype="json",s):"url"===a?(s.type=3,s.length=500,s.raw="string",s.subtype="url",s):"zip"===a?(s.type=3,s.length=10,s.raw="string",s.subtype="zip",s):"phone"===a?(s.type=3,s.length=20,s.raw="string",s.subtype="phone",s):a.contains(["int","byte"])?(s.type=1,s):a.contains(["decimal","number","float","double"])?(s.type=2,s):-1!==a.indexOf("bool")?(s.type=4,s):a.contains(["date","time"])?(s.type=5,s):(s.type=7,s)},t.prototype.getDependencies=function(){var e=this,r=[];for(var t in e.schema){var n=e.schema[t];if("string"==typeof n){var o="]"===n[0];o&&(n=n.substring(1,n.length-1));var i=e.parent.get(n);void 0!==("undefined"==typeof i?"undefined":_typeof(i))&&r.push({name:t,isArray:o,schema:i})}}return r},t.prototype.setValidate=function(e,r){var t=this;return void 0===r&&e instanceof Array?(t.properties=e,t):("function"!=typeof e?(t.properties=e,t.onValidate=r):t.onValidate=e,t)},t.prototype.setPrefix=function(e){return this.resourcePrefix=e,this},t.prototype.setResource=function(e){return this.resourceName=e,this},t.prototype.setDefault=function(e){var r=this;return r.onDefault=e,r},t.prototype.setPrepare=function(e){var r=this;return r.onPrepare=e,r},t.prototype.setSave=function(e){var r=this;return r.onSave=e,r},t.prototype.setError=function(e){var r=this;return r.onError=e,r},t.prototype.setGet=function(e){var r=this;return r.onGet=e,r},t.prototype.setQuery=function(e){var r=this;return r.onQuery=e,r},t.prototype.setRemove=function(e){var r=this;return r.onRemove=e,r},t.prototype.constant=function(e,r){var t=this;return void 0===r?t.constants?t.constants[e]:void 0:(t.constants||(t.constants={}),t.constants[e]=r,t)},t.prototype.addTransform=function(e,r){var t=this;return"function"==typeof e&&(r=e,e="default"),t.transforms||(t.transforms={}),t.transforms[e]=r,t},t.prototype.addOperation=function(e,r){var t=this;return"function"==typeof e&&(r=e,e="default"),t.operations||(t.operations={}),t.operations[e]=r,t},t.prototype.addWorkflow=function(e,r){var t=this;return"function"==typeof e&&(r=e,e="default"),t.workflows||(t.workflows={}),t.workflows[e]=r,t},t.prototype.find=function(e){return this.parent.get(e)},t.prototype.destroy=function(){var e=this;delete e.parent.collection[e.name],e.properties=null,e.schema=null,e.onDefault=null,e.onValidate=null,e.onSave=null,e.onRead=null,e.onRemove=null,e.onQuery=null,e.workflows=null,e.transforms=null},t.prototype.save=function(e,r,t,n){"boolean"==typeof t?(n=t,t=r,r=void 0):void 0===t&&(t=r,r=void 0),"function"!=typeof t&&(t=function(){});var i=this,s="save";return i.$prepare(e,function(e,a){if(e)return void t(e,a);var c=new u;return i.resourceName&&c.setResource(i.resourceName),i.resourcePrefix&&c.setPrefix(i.resourcePrefix),o(i,s,i.onSave)?(t.success=!1,void async.call(i,i.onSave)(function(e){e&&!t.success&&(t.success=!0,c.push(e),i.onError&&i.onError(c,a,s),t(c))},c,a,r,function(e){if(!t.success){(2===arguments.length||e instanceof Error||e instanceof u)&&((e instanceof Error||e instanceof u)&&c!==e&&c.push(e),e=arguments[1]);var r=c.hasError();r&&i.onError&&i.onError(c,a,s),t.success=!0,t(r?c:null,void 0===e?a:e)}},n!==!0)):(i.onSave(c,a,r,function(e){i.$process(arguments,a,s,void 0,c,e,t)},n!==!0),i)}),i},t.prototype.get=t.prototype.read=function(e,r){void 0===r&&(r=e,e=void 0),"function"!=typeof r&&(r=function(){});var t=this,n=new u;t.resourceName&&n.setResource(t.resourceName),t.resourcePrefix&&n.setPrefix(t.resourcePrefix);var i=t["default"](),s="get";return o(t,s,t.onGet)?(r.success=!1,async.call(t,t.onGet)(function(e){e&&!r.success&&(r.success=!0,n.push(e),t.onError&&t.onError(n,model,s),r(n))},n,i,e,function(e){if(!r.success){(2===arguments.length||e instanceof Error||e instanceof u)&&((e instanceof Error||e instanceof u)&&n!==e&&n.push(e),e=arguments[1]),r.success=!0;var o=n.hasError();o&&t.onError&&t.onError(n,model,s),r(o?n:null,void 0===e?i:e)}}),t):(t.onGet(n,i,e,function(e){t.$process(arguments,i,s,void 0,n,e,r)}),t)},t.prototype.remove=function(e,r){void 0===r&&(r=e,e=void 0);var t=this,n=new u,i="remove";return t.resourceName&&n.setResource(t.resourceName),t.resourcePrefix&&n.setPrefix(t.resourcePrefix),o(t,i,t.onRemove)?(r.success=!1,async.call(t,t.onRemove)(function(e){e&&!r.success&&(r.success=!0,n.push(e),t.onError&&t.onError(n,model,i),r(n))},n,e,function(o){if(!r.success){(2===arguments.length||o instanceof Error||o instanceof u)&&((o instanceof Error||o instanceof u)&&n!==o&&n.push(o),o=arguments[1]);var s=n.hasError();s&&t.onError&&t.onError(n,model,i),r.success=!0,r(s?n:null,void 0===o?e:o)}}),t):(t.onRemove(n,e,function(e){t.$process(arguments,void 0,i,void 0,n,e,r)}),t)},t.prototype.query=function(e,r){void 0===r&&(r=e,e=void 0);var t=this,n=new u,i="query";return t.resourceName&&n.setResource(t.resourceName),t.resourcePrefix&&n.setPrefix(t.resourcePrefix),o(t,i,t.onQuery)?(r.success=!1,async.call(t,t.onQuery)(function(e){e&&!r.success&&(r.success=!0,n.push(e),t.onError&&t.onError(n,model,i),r(n))},n,e,function(e){if(!r.success){(2===arguments.length||e instanceof Error||e instanceof u)&&((e instanceof Error||e instanceof u)&&n!==e&&n.push(e),e=arguments[1]);var o=n.hasError();o&&t.onError&&t.onError(n,model,i),r.success=!0,r(n.hasError()?n:null,e)}}),t):(t.onQuery(n,e,function(e){t.$process(arguments,void 0,i,void 0,n,e,r)}),t)},t.prototype.validate=function(e,r,t,n,o,i,s){var a=this;a.onValidate;if(void 0===n&&(n=new u,a.resourceName&&n.setResource(a.resourceName),a.resourcePrefix&&n.setPrefix(a.resourcePrefix)),a.resourcePrefix&&(n.resourcePrefix=a.resourcePrefix),a.resourceName&&(n.resourceName=a.resourceName),t&&(n.resourceName=t),r&&(n.resourcePrefix=r),o&&(o=a.filter(o)),i?i+=".":i="",framework_utils.validate_builder.call(a,e,n,a.name,a.parent.collection,a.name,s,o,i),!a.dependencies)return n;for(var c=0,l=a.dependencies.length;l>c;c++){var f=a.dependencies[c],p=a.schema[f],d=a.parent.collection[p.raw];if(d)if(p.isArray)for(var m=e[f],h=0,g=m.length;g>h;h++)d.validate(e[f][h],r,t,n,o,i+f+"["+h+"]",h);else d.validate(e[f],r,t,n,o,i+f,h);else framework.error(new Error('Schema "'+p.raw+'" not found (validation).'))}return n},t.prototype.create=function(){return this["default"]()},t.prototype.Create=function(){return this["default"]()},t.prototype.$make=function(e){return e},t.prototype.$prepare=function(e,r){var t=this;return e&&"function"==typeof e.$save?r(null,e):t.make(e,function(e,t){return r(e,t)}),t},t.prototype["default"]=function(){var e=this,r=e.schema;if(null===r)return null;var t=e.onDefault,n=new e.CurrentSchemaInstance;for(var o in r){var i=r[o];if(t){var s=t(o,!0,e.name);if(void 0!==s){n[o]=s;continue}}switch(i.type){case 0:case 6:n[o]=i.isArray?[]:null;break;case 1:case 2:n[o]=i.isArray?[]:0;break;case 3:n[o]=i.isArray?[]:"";break;case 4:n[o]=i.isArray?[]:!1;break;case 5:n[o]=i.isArray?[]:new Date;break;case 7:if(i.isArray)n[o]=[];else{var a=e.find(i.raw);a?n[o]=a["default"]():(framework.error(new Error('Schema: "'+o+"."+i.raw+'" not found in "'+e.parent.name+'".')),n[o]=null)}}}return n},t.prototype.make=function(e,r,t){var n=this;if("function"==typeof e)return e.call(n,n),n;if("function"==typeof r){var o=t;t=r,r=o}var i=n.prepare(e),s=n.validate(i,void 0,void 0,void 0,r);return s.hasError()?(n.onError&&n.onError(s,e,"make"),t&&t(s,null),i):(t&&t(null,i),i)},t.prototype.load=t.prototype.make,t.prototype.$onprepare=function(e,r,t,n){if(!this.onPrepare)return r;var o=this.onPrepare(e,r,t,n);return void 0===o?r:o},t.prototype.prepare=function(e,r){var t=this,n=t.schema;if(null===n)return null;if(null===e||void 0===e)return t["default"]();var o,s,a=new t.CurrentSchemaInstance,u=t.onDefault;for(var c in n){var f=e[c];w.call(e,c)||(f=void 0),void 0===f&&u&&(f=u(c,!1,t.name)),void 0===f&&(f="");var p=n[c],d="undefined"==typeof f?"undefined":_typeof(f);if("function"===d&&(f=f()),p.isArray)if(f instanceof Array){a[c]=[];for(var m=0,h=f.length;h>m;m++){switch(o=f[m],d="undefined"==typeof o?"undefined":_typeof(o),p.type){case 0:o=t.$onprepare(c,o,m,e);break;case 1:o=t.$onprepare(c,framework_utils.parseInt(o),m,e);break;case 2:o=t.$onprepare(c,framework_utils.parseFloat(o),m,e);break;case 3:switch(o=void 0===o||null===o?"":i(t,o.toString()),p.length&&o.length<o.length&&(o=o.substring(0,p.length)),p.subtype){case"uid":!o||p.required||o.isUID()||(o="");break;case"url":!o||p.required||o.isURL()||(o="");break;case"email":o=o.toLowerCase().replace(y,""),!o||p.required||o.isEmail()||(o="");break;case"phone":o=o.replace(b,""),!o||p.required||o.isPhone()||(o="");break;case"capitalize":o=o.capitalize();break;case"lowercase":o=o.toLowerCase();break;case"uppercase":o=o.toUpperCase();break;case"json":!o||p.required||o.isJSON()||(o="")}o=t.$onprepare(c,o,m,e);break;case 4:o&&(o=o.toString().toLowerCase()),o=t.$onprepare(c,"true"===o||"1"===o||"on"===o,m,e);break;case 5:"string"===d?o&&(o=o.trim().parseDate()):"number"===d&&(o=new Date(o)),o=framework_utils.isDate(o)?t.$onprepare(c,o,m,e):void 0;break;case 6:o=t.$onprepare(c,o,m,e);break;case 7:s=t.parent.get(p.raw),s?(o=s.prepare(o,r),r&&r.push({name:p.raw,value:t.$onprepare(c,o,m,e)})):o=null,o=t.$onprepare(c,o,m,e)}void 0!==o&&a[c].push(o)}}else a[c]=u?l(u(c,!1,t.name),[]):[];else switch(p.type){case 0:break;case 1:a[c]=t.$onprepare(c,framework_utils.parseInt(f),void 0,e);break;case 2:a[c]=t.$onprepare(c,framework_utils.parseFloat(f),void 0,e);break;case 3:switch(o=void 0===f||null===f?"":i(t,f.toString()),p.length&&p.length<o.length&&(o=o.substring(0,p.length)),p.subtype){case"uid":!o||p.required||o.isUID()||(o="");break;case"email":o=o.toLowerCase().replace(y,""),!o||p.required||o.isEmail()||(o="");break;case"url":!o||p.required||o.isURL()||(o="");break;case"zip":!o||p.required||o.isZIP()||(o="");break;case"phone":o=o.replace(b,""),!o||p.required||o.isPhone()||(o="");break;case"capitalize":o=o.capitalize();break;case"lowercase":o=o.toLowerCase();break;case"uppercase":o=o.toUpperCase();break;case"json":!o||p.required||o.isJSON()||(o="")}a[c]=t.$onprepare(c,o,void 0,e);break;case 4:o=f?f.toString().toLowerCase():null,a[c]=t.$onprepare(c,"true"===o||"1"===o||"on"===o,void 0,e);break;case 5:o=null,"string"===d?f&&(o=f.trim().parseDate()):"number"===d&&(o=new Date(f)),o=framework_utils.isDate(o)?t.$onprepare(c,o,void 0,e):u?l(u(c,!1,t.name),null):null,a[c]=o;break;case 6:a[c]=t.$onprepare(c,e[c],void 0,e);break;case 7:if(!f&&(f=u?l(u(c,!1,t.name),null):null,null===f)){a[c]=null;break}if(f&&"function"==typeof f.$schema&&(o=f.$schema(),o&&o.name&&o.name===p.raw)){a[c]=f;break}s=t.parent.get(p.raw),s?(a[c]=s.prepare(f,void 0),r&&r.push({name:p.raw,value:t.$onprepare(c,a[c],void 0,e)})):a[c]=null}}if(t.fields_allow)for(var g=0,v=t.fields_allow.length;v>g;g++){var k=t.fields_allow[g],f=e[k];void 0!==f&&(a[k]=f)}return a},t.prototype.transform=function(e,r,t,n,i){var s=this;"string"!=typeof e&&(n=t,t=r,r=e,e="default"),"boolean"==typeof n?(i=n,n=t,t=void 0):void 0===n&&(n=t,t=void 0),"function"!=typeof n&&(n=function(){});var a=s.transforms?s.transforms[e]:void 0;if(!a)return n((new u).push("","Transform not found.")),s;var c="transform";if(i===!0){var l=new u;return s.resourceName&&l.setResource(s.resourceName),s.resourcePrefix&&l.setPrefix(s.resourcePrefix),a.call(s,l,r,t,function(t){s.$process(arguments,r,c,e,l,t,n)},i!==!0),s}return s.$prepare(r,function(r,l){if(r)return void n(r,l);var f=new u;return s.resourceName&&f.setResource(s.resourceName),s.resourcePrefix&&f.setPrefix(s.resourcePrefix),o(s,"transform."+e,a)?(n.success=!1,void async.call(s,a)(function(r){r&&!n.success&&(n.success=!0,f.push(r),s.onError&&s.onError(f,l,c,e),n(f))},f,l,t,function(r){if(!n.success){(2===arguments.length||r instanceof Error||r instanceof u)&&((r instanceof Error||r instanceof u)&&f!==r&&f.push(r),r=arguments[1]);var t=f.hasError();t&&s.onError&&s.onError(f,l,c,e),n.success=!0,n(t?f:null,void 0===r?l:r)}},i!==!0)):void a.call(s,f,l,t,function(r){s.$process(arguments,l,c,e,f,r,n)},s.name)}),s},t.prototype.transform2=function(e,r,t){return"function"==typeof r&&(t=r,r=void 0),void 0===t&&(t=NOOP),this.transform(e,null,r,t,!0)},t.prototype.$process=function(e,r,t,n,o,i,s){var a=this;(e.length>1||i instanceof Error||i instanceof u)&&((i instanceof Error||i instanceof u||"string"==typeof i)&&o!==i&&o.push(i),i=e[1]);var c=o.hasError();return c&&a.onError&&a.onError(o,r,t,n),s(c?o:null,void 0===i?r:i,r),a},t.prototype.workflow=function(e,r,t,n,i){var s=this;"string"!=typeof e&&(n=t,t=r,r=e,e="default"),"boolean"==typeof n?(i=n,n=t,t=void 0):void 0===n&&(n=t,t=void 0),"function"!=typeof n&&(n=function(){});var a=s.workflows?s.workflows[e]:void 0;if(!a)return n((new u).push("","Workflow not found.")),s;var c="workflow";if(i===!0){var l=new u;return s.resourceName&&l.setResource(s.resourceName),s.resourcePrefix&&l.setPrefix(s.resourcePrefix),a.call(s,l,r,t,function(t){s.$process(arguments,r,c,e,l,t,n)},i!==!0),s}return s.$prepare(r,function(r,l){if(r)return void n(r,l);var f=new u;return s.resourceName&&f.setResource(s.resourceName),s.resourcePrefix&&f.setPrefix(s.resourcePrefix),o(s,"workflow."+e,a)?(n.success=!1,void async.call(s,a)(function(r){r&&!n.success&&(n.success=!0,f.push(r),s.onError&&s.onError(f,l,c,e),n(f))},f,l,t,function(r){if(!n.success){(2===arguments.length||r instanceof Error||r instanceof u)&&((r instanceof Error||r instanceof u)&&f!==r&&f.push(r),r=arguments[1]);var t=f.hasError();t&&s.onError&&s.onError(f,l,c,e),n.success=!0,n(t?f:null,void 0===r?l:r)}},i!==!0)):void a.call(s,f,l,t,function(r){s.$process(arguments,l,c,e,f,r,n)},i!==!0)}),s},t.prototype.workflow2=function(e,r,t){return"function"==typeof r&&(t=r,r=void 0),void 0===t&&(t=NOOP),this.workflow(e,null,r,t,!0)},t.prototype.operation=function(e,r,t,n,i){var s=this,a="undefined"==typeof t?"undefined":_typeof(t),c="undefined"==typeof n?"undefined":_typeof(n);"undefined"===c?"function"===a?(n=t,t=r,r=void 0):"undefined"===a&&(t=r,r=void 0):"undefined"===a?(t=r,r=void 0):"boolean"===c&&(i=n,n=t,t=void 0),"function"==typeof t&&(n=t,t=void 0),"function"!=typeof n&&(n=function(){});var l=s.operations?s.operations[e]:void 0;if(!l)return n((new u).push("","Operation not found.")),s;var f=new u,p="operation";return s.resourceName&&f.setResource(s.resourceName),s.resourcePrefix&&f.setPrefix(s.resourcePrefix),o(s,"operation."+e,l)?(n.success=!1,async.call(s,l)(function(t){t&&!n.success&&(n.success=!0,f.push(t),s.onError&&s.onError(f,r,p,e),n(f))},f,r,t,function(t){if(!n.success){(2===arguments.length||t instanceof Error||t instanceof u)&&((t instanceof Error||t instanceof u)&&f!==t&&f.push(t),t=arguments[1]);var o=f.hasError();o&&s.onError&&s.onError(f,r,p,e),n.success=!0,n(o?f:null,t)}},i!==!0),s):(l.call(s,f,r,t,function(t){s.$process(arguments,r,p,e,f,t,n)},i!==!0),s)},t.prototype.operation2=function(e,r,t){return"function"==typeof r&&(t=r,r=void 0),void 0===t&&(t=NOOP),this.operation(e,null,r,t,!0)},t.prototype.clean=function(e){return s(e)},t.prototype.instancePrototype=function(){return this.CurrentSchemaInstance.prototype},a.prototype.$$schema=null,a.prototype.$async=function(e,r){var t=this;return void 0===e&&(e=NOOP),t.$$async=[],t.$$result=[],t.$callback=e,setImmediate(function(){t.$$async.async(function(){var n=t.$$result;delete t.$$result,delete t.$$async,e(null,void 0!==r?n[r]:n)})}),t},a.prototype.$save=function(e,r){var t=this;return t.$$async?(t.$$async.push(function(r){t.$$schema.save(t,e,function(e,n){if(t.$$result&&t.$$result.push(e?null:n),!e)return r();r=null;var n=t.$$result;delete t.$$result,delete t.$$async,t.$callback(e,n)})}),t):(t.$$schema.save(t,e,r),t)},a.prototype.$remove=function(e,r){var t=this;return t.$$async?(t.$$async.push(function(r){t.$$schema.remove(t,e,function(e,n){if(t.$$result&&t.$$result.push(e?null:n),!e)return r();r=null;var n=t.$$result;delete t.$$result,delete t.$$async,t.$callback(e,n)})}),t):(t.$$schema.remove(e,r),t)},a.prototype.$default=function(){return this.$$schema["default"]()},a.prototype.$destroy=function(){return this.$$schema.destroy()},a.prototype.$transform=function(e,r,t){var n=this;return n.$$async?(n.$$async.push(function(t){n.$$schema.transform(e,n,r,function(e,r){if(n.$$result&&n.$$result.push(e?null:r),!e)return t();t=null;var r=n.$$result;delete n.$$result,delete n.$$async,n.$callback(e,r)})}),n):(n.$$schema.transform(e,n,r,t),n)},a.prototype.$workflow=function(e,r,t){var n=this;return n.$$async?(n.$$async.push(function(t){n.$$schema.workflow(e,n,r,function(e,r){if(n.$$result&&n.$$result.push(e?null:r),!e)return t();t=null;var r=n.$$result;delete n.$$result,delete n.$$async,n.$callback(e,r)})}),n):(n.$$schema.workflow(e,n,r,t),n)},a.prototype.$operation=function(e,r,t){var n=this;return n.$$async?(n.$$async.push(function(t){n.$$schema.operation(e,n,r,function(e,r){if(n.$$result&&n.$$result.push(e?null:r),!e)return t();t=null;var r=n.$$result;delete n.$$result,delete n.$$async,n.$callback(e,r)})}),n):(n.$$schema.operation(e,n,r,t),n)},a.prototype.$clean=function(){return this.$$schema.clean(this)},a.prototype.$clone=function(){return framework_utils.extend(new this.$$schema.CurrentSchemaInstance,this,!0)},a.prototype.$prepare=function(){return this.$$schema.prepare(this)},a.prototype.$schema=function(){return this.$$schema},a.prototype.$validate=function(e,r,t){return this.$$schema.validate(this,e,r,t)},a.prototype.$constant=function(e){return this.$$schema.constant(e)},m.isSchema=function(e){return e instanceof a},m.eachschema=function(e,r){void 0===r&&(r=e,e=void 0);for(var t=e?[e]:Object.keys(k),n=0,o=t.length;o>n;n++){var i=k[t[n]];if(i)for(var s=Object.keys(i.collection),a=0,u=s.length;u>a;a++)r(i.name,i.collection[s[a]].name,i.collection[s[a]])}},m.getschema=function(e,r){r||(r=e,e=g);var t=k[e];if(t){var n=t.get(r);return n?n:void 0;
}},m.newschema=function(e,t){e||(e=g),void 0===k[e]&&(k[e]=new r(e));var n;return t&&(n=k[e].get(t),n||(n=k[e].create(t))),n},m.remove=function(e){delete k[e]},m.isJoin=function(e,r){return r?"["===r[0]?!0:void 0===e?!1:void 0!==e[r]:!1},m.validation=function(e,r,t){if(void 0===k[g])return[];var n=k[g].get(e);if(void 0===n)return[];if(t instanceof Array&&"function"==typeof r){var o=t;t=r,r=o}if("function"==typeof t)return n.onValidate=t,r?n.properties=r:n.properties=Object.keys(n.schema),!0;if(!t){var i=n.properties;return void 0===i?Object.keys(n.schema):i||[]}return n.onValidate=t,t},m.validate=function(e,r,t,n){var o=k[g];return void 0===o?null:(o=o.get(e),void 0===o?null:o.validate(r,t,n))},m.create=function(e){return m.defaults(e)},m.defaults=function(e){if(void 0===k[g])return null;var r=k[g].get(e);return void 0===r?null:r["default"]()},m.prepare=function(e,r){if(void 0===k[g])return null;var t=k[g].get(e);return void 0===t?null:t.prepare(r)},u.prototype={get errors(){var e=this;return e.isPrepared||e.prepare(),e._transform()},get error(){var e=this;return e.isPrepared||e.prepare(),e._transform()}},u.prototype.resource=function(e,r){var t=this;return t.isResourceCustom=!0,t.resourceName=e||"default",t.resourcePrefix=r||"",t._resource()},u.prototype.setContentType=function(e){return this.contentType=e,this},u.prototype.setResource=function(e){var r=this;return r.isResourceCustom=!0,r.resourceName=e||"default",r._resource()},u.prototype.setPrefix=function(e){var r=this;return r.isResourceCustom=!0,r.resourcePrefix=e||"",r._resource()},u.prototype._resource=function(){var e=this;return e.onResource=e._resource_handler,e},u.prototype._resource_handler=function(e){var r=this;return"undefined"!=typeof framework?framework.resource(r.resourceName,r.resourcePrefix+e):""},u.prototype.exception=function(e){return this.items.push({name:"",error:e}),this},u.prototype.add=function(e,r,t,n){return this.push(e,r,t,n)},u.prototype.push=function(e,r,t,n){var o=this;if(o.isPrepared=!1,e instanceof u){if(e.hasError()){for(var i=0,s=e.items.length;s>i;i++)o.items.push(e.items[i]);o.count=o.items.length}return o}if(e instanceof Array){for(var i=0,s=e.length;s>i;i++)o.push(e[i],void 0,t,n);return o}if(r instanceof Array){for(var i=0,s=r.length;s>i;i++)o.push(e,r[i],t,n);return o}return"object"===("undefined"==typeof e?"undefined":_typeof(e))&&(t=r,r=e,e=""),e||r?null===r?o:(r||(r="@"),r instanceof Error&&(o.unexpected=!0,r=r.toString()),o.items.push({name:e,error:"string"==typeof r?r:r.toString(),path:t,index:n}),o.count=o.items.length,o):o},u.prototype.remove=function(e){var r=this;return r.items=r.items.remove("name",e),r.count=r.items.length,r},u.prototype.hasError=function(e){var r=this;return e?-1!==r.items.findIndex("name",e):r.items.length>0},u.prototype.read=function(e){var r=this;r.isPrepared||r.prepare();var t=r.items.findItem("name",e);return t?t.error:null},u.prototype.clear=function(){var e=this;return e.items=[],e.count=0,e},u.prototype.replace=function(e,r){var t=this;return t.isPrepared=!1,t.replacer[e]=r,t},u.prototype.json=function(e,r){var t=this.prepare().items;return e?JSON.stringify(t,r,"	"):JSON.stringify(t,r)},u.prototype.plain=function(){for(var e=this.prepare().items,r="",t=0,n=e.length;n>t;t++)r+=(r?", ":"")+e[t].error;return r},u.prototype.JSON=function(e,r){return this.json(e,r)},u.prototype._prepare=function(){var e=this;if(!e.onResource)return e;for(var r=e.items,t=r.length,n=0;t>n;n++){var o=r[n];"@"===o.error[0]&&(1===o.error.length?o.error=e.onResource(o.name):o.error=e.onResource(o.error.substring(1)),o.error||(o.error=h.replace("@",o.name)))}return e},u.prototype._transform=function(e){var r=this,t=e||r.transformName;if(!t)return r.items;var n=E.error[t];return n?n.call(r):r.items},u.prototype.output=function(){var e=this;if(!e.transformName)return e.json();var r=E.error[e.transformName];return r?(e.prepare(),r.call(e)):e.json()},u.prototype.toString=function(){var e=this;e.isPrepared||e.prepare();for(var r=e.items,t=r.length,n=[],o=0;t>o;o++)n.push(r[o].error||r[o].name);return n.join("\n")},u.prototype.setTransform=function(e){var r=this;return r.transformName=e,r},u.prototype.transform=function(e){var r=this;return r.prepare()._transform(e)},u.prototype._prepareReplace=function(){var e=this,r=e.items,t=r.length,n=Object.keys(e.replacer),o=n.length;if(!t||!o)return e;for(var i=0;t>i;i++)for(var s=r[i],a=0;o>a;a++){var u=n[a];s.error=s.error.replace(u,e.replacer[u])}return e},u.prototype.prepare=function(){var e=this;return e.isPrepared?e:(e._prepare()._prepareReplace(),e.isPrepared=!0,e)},u.addTransform=function(e,r,t){E.error[e]=r,t&&u.setDefaultTransform(e)},u.removeTransform=function(e){delete E.error[e]},u.setDefaultTransform=function(e){void 0===e?delete E.error_default:E.error_default=e},p.prototype.html=function(){return'<a href="'+this.url+'"'+(this.selected?' class="selected">':">")+this.page+"</a>"},f.addTransform=function(e,r,t){E.pagination[e]=r,t&&f.setDefaultTransform(e)},f.setDefaultTransform=function(e){void 0===e?delete E.pagination_default:E.pagination_default=e},f.removeTransform=function(e){delete E.pagination[e]},f.prototype.refresh=function(e,r,t){var n=this;return n.page=Math.max(1,+r)-1,n.page<=0&&(n.page=0),n.items=Math.max(0,+e),n.max=Math.max(1,+t),n.skip=n.page*n.max,n.count=Math.ceil(n.items/n.max),n.take=Math.min(n.max,n.items-n.skip),n.lastPage=n.count,n.firstPage=1,n.prevPage=n.page?n.page:1,n.nextPage=n.page+2<n.count-1?n.page+2:n.count,n.isPrev=n.page>0,n.isNext=n.page<n.count-1,n.isFirst=0===n.page,n.isLast=n.page===n.count-1,n.visible=n.count>1,n.page++,n},f.prototype.setTransform=function(e){var r=this;return r._transform=e,r},f.prototype.transform=function(e){var r=this,t=e||r.transformName;if(!t)throw new Error("A transformation of Pagination not found.");var n=E.pagination[t];if(void 0===n)return r.render();for(var o=[],i=1;i<arguments.length;i++)o.push(arguments[i]);return n.apply(r,o)},f.prototype.prev=function(e){var r=this,t=0;return e=e||r.format,t=r.isPrev?r.page-1:r.count,new p(e.format(t,r.items,r.count),t,!1,r.isPrev)},f.prototype.next=function(e){var r=this,t=0;return e=e||r.format,t=r.isNext?r.page+1:1,new p(e.format(t,r.items,r.count),t,!1,r.isNext)},f.prototype.last=function(e){var r=this,t=r.count;return e=e||r.format,new p(e.format(t,r.items,r.count),t,!1,r.count>0)},f.prototype.first=function(e){var r=this,t=1;return e=e||r.format,new p(e.format(t,r.items,r.count),t,!1,r.count>0)},f.prototype.prepare=function(e,r,t){var n=this;if(n.transformName)return E.pagination[n.transformName].apply(n,arguments);var o=[];if(r=r||n.format,"string"==typeof e){var i=r;r=e,e=i}var s="html"===t;if(void 0===e||null===e){for(var a=1;a<n.count+1;a++)s?o.push(n.prepare_html(r,a,n.count,n.items,a===n.page)):o.push(new p(r.format(a,n.items,n.count),a,a===n.page,!0));return o}var u=Math.floor(e/2),c=n.count,l=n.page-u,f=n.page+u,d=0;0>=l&&(d=Math.abs(l),l=1,f+=d),f>=c&&(f=c,l=c-e,0>=l&&(l=1));for(var a=l;f+1>a;a++)s?o.push(n.prepare_html(r,a,n.count,n.items,a===n.page)):o.push(new p(r.format(a,n.items,n.count),a,a===n.page,!0));return o},f.prototype.prepare_html=function(e,r,t,n,o){return'<a href="'+e.format(r,n,t)+'"'+(o?' class="selected">':">")+r+"</a>"},f.prototype.render=function(e,r){return this.prepare(e,r)},f.prototype.html=function(e,r){return this.prepare(e,r,"html").join("")},f.prototype.json=function(e,r){return JSON.stringify(this.prepare(e,r))},c.prototype.add=function(e,r){var t=this;if("object"!==("undefined"==typeof e?"undefined":_typeof(e)))return t.builder[e]=r,t;for(var n=Object.keys(e),o=0,i=n.length;i>o;o++)t.builder[n[o]]=e[n[o]];return t},c.prototype.remove=function(e){var r=this;return delete r.builder[e],r},c.prototype.read=function(e){return this.builder[e]||null},c.prototype.clear=function(){var e=this;return e.builder={},e},c.prototype.toString=function(e,r){if("boolean"==typeof e){var t=r;r=e,e=t}var n=this,o=[];return Object.keys(n.builder).forEach(function(e){var t=n.builder[e];t=void 0===t||null===t?"":t.toString(),r&&""===t||o.push(e+"="+encodeURIComponent(t))}),"string"==typeof e?"?"!==e[e.length-1]&&(e+="?"):e="",e+o.join("&")},c.prototype.hasValue=function(e){if(void 0===e)return!1;var r=this;"string"==typeof e&&(e=[e]);for(var t=0;t<e.length;t++){var n=r.builder[e[t]];if(void 0===n||null===n)return!1}return!0},c.prototype.toOne=function(e,r){var t=this,n=[];return e.forEach(function(e){n.push(t.builder[e]||"")}),n.join(r||"&")},d.transform=function(e,r){var t=2;void 0===r&&(r=e,e=E.transformbuilder_default,t=1);var n=E.transformbuilder[e];if(!n)return F.error('Transformation "'+e+'" not found.',"TransformBuilder.transform()"),r;var o=arguments.length-t;if(0>=o)return n.call(r,r);var i=new Array(o+1),s=1;i[0]=r;for(var a=t;a<arguments.length;a++)i[s++]=arguments[a];return n.apply(r,i)},d.addTransform=function(e,r,t){E.transformbuilder[e]=r,t&&d.setDefaultTransform(e)},d.setDefaultTransform=function(e){void 0===e?delete E.transformbuilder_default:E.transformbuilder_default=e},m.SchemaBuilder=r,m.ErrorBuilder=u,m.Pagination=f,m.UrlBuilder=c,m.TransformBuilder=d,global.ErrorBuilder=u,global.TransformBuilder=d,global.Pagination=f,global.UrlBuilder=c,global.SchemaBuilder=r,m.restart=function(){k={},Object.keys(E).forEach(function(e){E[e]={}})},e}({exports:{}}),function(e){function r(e,r,n){var o="https:"===e.protocol?R:C,i=r.post?o.request(e,function(n){return t(n,e,r)}):o.get(e,function(n){return t(n,e,r)});return r.callback?(i.on("error",function(t){r.callback&&(r.callback(t,"",0,void 0,e.host),r.callback=null,r.evt.removeAllListeners(),r.evt=null)}),i.setTimeout(r.timeout,function(){r.callback&&(r.callback(new Error(S.httpStatus(408)),"",0,void 0,e.host),r.callback=null,r.evt.removeAllListeners(),r.evt=null)}),i.on("response",function(e){return e.req=i}),void i.end(r.data)):void i.on("error",NOOP)}function t(e,t,n){if(e._buffer=null,e._bufferlength=0,301===e.statusCode||302===e.statusCode){if(n.redirect>3)return n.callback&&n.callback(new Error("Too many redirects."),"",0,void 0,t.host),n.evt&&(n.evt.removeAllListeners(),n.evt=null),e.req.removeAllListeners(),e.req=null,e.removeAllListeners(),void(e=null);n.redirect++;var o=x.parse(e.headers.location);return o.headers=t.headers,o.agent=!1,o.method=t.method,e.req.removeAllListeners(),e.req=null,n.resolve?void S.resolve(e.headers.location,function(t,i){t||(o.host=i.host),e.removeAllListeners(),e=null,r(o,n)}):(e.removeAllListeners(),e=null,r(o,n))}n.length=+e.headers["content-length"]||0,n.evt&&n.evt.emit("begin",n.length),e.on("data",function(e){var r=this;n.max&&r._bufferlength>n.max||(r._buffer?r._buffer=Buffer.concat([r._buffer,e]):r._buffer=e,r._bufferlength+=e.length,n.evt&&n.evt.emit("data",e,n.length?r._bufferlength/n.length*100:0))}),e.on("end",function(){var r=this,o=r._buffer?r._buffer.toString(n.encoding):"";delete r._buffer,n.evt&&(n.evt.emit("end",o,r.statusCode,r.headers,t.host),n.evt.removeAllListeners(),n.evt=null),n.callback&&(n.callback(null,"HEAD"===t.method?r.headers:o,r.statusCode,r.headers,t.host),n.callback=null),e.req&&e.req.removeAllListeners(),e.removeAllListeners()}),e.resume()}function n(e,r){r.length=0;var t="https:"===e.protocol?R:C,n=r.post?t.request(e,function(t){return o(t,e,r)}):t.get(e,function(t){return o(t,e,r)});return r.callback?(n.on("error",function(e){r.callback&&(r.callback(e),r.callback=null,r.evt.removeAllListeners(),r.evt=null)}),n.setTimeout(r.timeout,function(){r.callback&&(r.callback(new Error(S.httpStatus(408))),r.callback=null,r.evt.removeAllListeners(),r.evt=null)}),n.on("response",function(e){e.req=n,r.length=+e.headers["content-length"]||0,r.evt&&r.evt.emit("begin",r.length)}),void n.end(r.data)):void n.on("error",NOOP)}function o(e,r,t){if(e._bufferlength=0,301===e.statusCode||302===e.statusCode){if(t.redirect>3)return t.callback&&t.callback(new Error("Too many redirects.")),e.req.removeAllListeners(),e.req=null,e.removeAllListeners(),void(e=null);t.redirect++;var o=x.parse(e.headers.location);return o.headers=r.headers,o.agent=!1,o.method=r.method,e.req.removeAllListeners(),e.req=null,t.resolve?void S.resolve(e.headers.location,function(r,i){r||(o.host=i.host),e.removeAllListeners(),e=null,n(o,t)}):(e.removeAllListeners(),e=null,n(o,t))}e.on("data",function(e){var r=this;r._bufferlength+=e.length,t.evt&&t.evt.emit("data",e,t.length?r._bufferlength/t.length*100:0)}),e.on("end",function(){var n=this,o=n._buffer?n._buffer.toString(t.encoding):"";delete n._buffer,t.evt&&t.evt.emit("end",o,n.statusCode,n.headers,r.host),t.evt.removeAllListeners(),t.evt=null,e.req&&e.req.removeAllListeners(),e.removeAllListeners()}),e.resume(),t.callback(null,e)}function i(){return Math.floor(65536*Math.random()).toString(36)}function s(e,r,t){var n="undefined"==typeof r?"undefined":_typeof(r);switch(t.subtype){case"uid":var o=parseInt(r.substring(10,r.length-4),10);return isNaN(o)?!1:r[r.length-1]===(o%2?"1":"0");case"zip":return Y.test(r);case"email":return r.isEmail();case"json":return r.isJSON();case"url":return r.isURL();case"phone":return j.test(r)}return"number"===n?r>0:"string"===n?r.length>0:"boolean"===n?r===!0:null===r||void 0===r?!1:r instanceof Array?r.length>0:r instanceof Date?"I"!==r.toString()[0]:!0}function a(e,r){for(var t=e?2:0,n=r instanceof Int8Array,o=r.length,i=new Buffer(o+t),s=0;o>s;s++)n?i[s+t]=r[s]:i[s+t]=r.charCodeAt(s);return e?(i[0]=e>>8,i[1]=e,i):i}function u(e){var r=null;return 125>=e?(r=new Buffer(1),r[0]=e,r):65535>=e?(r=new Buffer(3),r[0]=126,r[1]=e>>8&255,r[2]=255&e,r):(r=new Buffer(9),r[0]=127,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=e>>24&255,r[6]=e>>16&255,r[7]=e>>8&255,r[8]=255&e,r)}function c(e){var r,t,n=0;if(0===e.length)return n;var o=e.length;for(r=0;o>r;r++)t=e.charCodeAt(r),n=(n<<5)-n+t,n|=0;return n}function l(e,r,t,n,o){this.isRunning=0,this.owner=e,this.name=r,this.fn=t,this.cb=n,this.waiting=o,this.interval=null,this.isCanceled=!1}function f(e){this._max=0,this._count=0,this._isRunning=!1,this._isEnd=!1,this.owner=e,this.onComplete=[],this.tasksPending={},this.tasksWaiting={},this.tasksAll=[],this.tasksTimeout={},this.isCanceled=!1,$.EventEmitter.call(this)}function p(){this.pending=[],this.pendingDirectory=[],this.directory=[],this.file=[],this.onComplete=null,this.onFilter=null,this.advanced=!1}function d(e,r,t){return t?e[r]|e[r+1]<<8|e[r+2]<<16|e[r+3]<<24|e[r+4]<<32|e[r+5]<<40|e[r+6]<<48|e[r+7]<<56:e[r+7]<<32|e[r+6]<<40|e[r+5]<<48|e[r+4]<<56|e[r+3]|e[r+2]<<8|e[r+1]<<16|e[r]<<24}function m(e){var r=S.queuecache[e];if(r&&(r.running--,r.running<0&&(r.running=0),r.pending.length)){var t=r.pending.shift();if(!t)return void(r.running=0);r.running++,function(e){setImmediate(function(){t(function(){m(e)})})}(e)}}function h(e,r,t){var n=e[r];e[r]=e[t],e[t]=n}function g(e,r){for(var t=1,n=e.length;n>t;t++){for(var o=e[t],i=t-1;i>=0&&!r(o,e[i],!0);i--)e[i+1]=e[i];e[i+1]=o}return e}function v(e,r,t,n,o){for(var i=r,s=t,a=e[n];;){for(;o(a,e[i]);)i++;for(s--;o(e[s],a);)s--;if(!(s>i))return i;h(e,i,s),i++}}function y(e,r){var t=[],n=[0,e.length,2*Math.floor(Math.log(e.length)/Math.log(2))];for(t.push(n);t.length;){n=t.pop();var o=n[0],i=n[1],s=n[2];if(s){s--;var a=Math.round((o+i)/2),u=v(e,o,i,a,r);i-u>16&&(n=[u,i,s],t.push(n)),u-o>16&&(n=[o,u,s],t.push(n))}else e=b(e,o,i,r)}return e=g(e,r)}function b(e,r,t,n){for(var o,i,s,a=Math.round((r+t)/2);a>=r;){for(o=a;t>o;o++){for(s=e[o],i=o;i>=a&&n(e[i-a],s);)e[i]=e[i-a],i-=a;e[i]=s}a=Math.round(a/2.2)}return e}function w(e,r){return r?1===e||0===e:1===e}function k(e,r){return r?-1===e||0===e:-1===e}function E(e,r,t){return y(e,function(e,n,o){return t?k(r(e,n),o):w(r(e,n),o)})}function _(e,r){this.name=e,this.max=r||50,this.index=0,this.filename="chunker_{0}-".format(e),this.stack=[],this.flushing=0,global.framework&&(this.filename=global.framework.path.temp(this.filename))}var S=e.exports;global.framework_utils=e.exports;var O=require("dns"),x=require("url"),T=require("querystring"),C=require("http"),R=require("https"),A=require("path"),N=require("fs"),$=require("events"),D=require("crypto");global.framework_utils||(global.framework_utils=S);var P=/\.\w{2,8}($|\?)+/,F=new RegExp("^[a-zA-Z0-9-_.+]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,6}$"),I=/^(http|https):\/\/(?:(?:(?:[\w\.\-\+!$&'\(\)*\+,;=]|%[0-9a-f]{2})+:)*(?:[\w\.\-\+%!$&'\(\)*\+,;=]|%[0-9a-f]{2})+@)?(?:(?:[a-z0-9\-\.]|%[0-9a-f]{2})+|(?:\[(?:[0-9a-f]{0,4}:)*(?:[0-9a-f]{0,4})\]))(?::[0-9]+)?(?:[\/|\?](?:[\w#!:\.\?\+=&@!$'~*,;\/\(\)\[\]\-]|%[0-9a-f]{2})*)?$/i,j=/^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$/im,H=/^[\s]+|[\s]+$/g,q=/(\d{1,2}\.\d{1,2}\.\d{4})|(\d{4}\-\d{1,2}\-\d{1,2})|(\d{1,2}\:\d{1,2}(\:\d{1,2})?)/g,L=/yyyy|yy|M+|d+|HH|H|hh|h|mm|m|ss|s|a|ww|w/g,M=/\{\d+\}/g,B=/\\/g,G=/<\/?[^>]+(>|$)/g,U=/[^\u0000-\u007e]/g,z=/^\d{14,}[a-z]{3}[01]{1}$/,Y=/^\d{5}(?:[-\s]\d{4})?$/,W=/\w+\=\".*?\"/g,J=/&gt;|\&lt;|\&quot;|&apos;|&amp;/g,V={a:"",e:"",i:"",o:"",u:"",b:1,f:1,p:1,v:1,c:2,g:2,j:2,k:2,q:2,s:2,x:2,z:2,d:3,t:3,l:4,m:5,n:5,r:6},X="utf8",K="\r\n",Z="win"===require("os").platform().substring(0,3).toLowerCase(),Q=["January","February","March","April","May","Juny","July","August","September","October","November","December"],ee=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],re={},te={flags:"r"},ne={end:!1},oe=[];Object.freeze(oe);for(var ie=[{b:" ",c:"Â "},{b:"0",c:"ß"},{b:"A",c:"â¶ï¼¡ÃÃÃáº¦áº¤áºªáº¨ÃÄÄáº°áº®áº´áº²È¦Ç ÃÇáº¢ÃÇºÇÈÈáº áº¬áº¶á¸ÄÈºâ±¯"},{b:"AA",c:"ê²"},{b:"AE",c:"ÃÇ¼Ç¢"},{b:"AO",c:"ê´"},{b:"AU",c:"ê¶"},{b:"AV",c:"ê¸êº"},{b:"AY",c:"ê¼"},{b:"B",c:"â·ï¼¢á¸á¸á¸ÉÆ"},{b:"C",c:"â¸ï¼£ê¾á¸ÄCÄÄÄÃÆÈ»"},{b:"D",c:"â¹ï¼¤á¸Äá¸á¸á¸á¸ÄÆÆá´ê¹"},{b:"Dh",c:"Ã"},{b:"DZ",c:"Ç±Ç"},{b:"Dz",c:"Ç²Ç"},{b:"E",c:"Éâºï¼¥ÃÃÃá»áº¾á»á»áº¼Äá¸á¸ÄÄÃáººÄÈÈáº¸á»È¨á¸Äá¸á¸ÆÆá´"},{b:"F",c:"ê¼â»ï¼¦á¸Æê»"},{b:"G",c:"â¼ï¼§Ç´Äá¸ ÄÄ Ç¦Ä¢Ç¤Æê ê½ê¾É¢"},{b:"H",c:"â½ï¼¨Ä¤á¸¢á¸¦Èá¸¤á¸¨á¸ªÄ¦â±§â±µê"},{b:"I",c:"â¾ï¼©ÃÃÃÄ¨ÄªÄ¬Ä°Ãá¸®á»ÇÈÈá»Ä®á¸¬Æ"},{b:"J",c:"â¿ï¼ªÄ´ÉÈ·"},{b:"K",c:"âï¼«á¸°Ç¨á¸²Ä¶á¸´Æâ±©êêêê¢"},{b:"L",c:"âï¼¬Ä¿Ä¹Ä½á¸¶á¸¸Ä»á¸¼á¸ºÅÈ½â±¢â± êêê"},{b:"LJ",c:"Ç"},{b:"Lj",c:"Ç"},{b:"M",c:"âï¼­á¸¾á¹á¹â±®ÆÏ»"},{b:"N",c:"ê¤È âï¼®Ç¸ÅÃá¹Åá¹Åá¹á¹Æêá´"},{b:"NJ",c:"Ç"},{b:"Nj",c:"Ç"},{b:"O",c:"âï¼¯ÃÃÃá»á»á»á»Ãá¹È¬á¹Åá¹á¹ÅÈ®È°ÃÈªá»ÅÇÈÈÆ á»á»á» á»á»¢á»á»ÇªÇ¬ÃÇ¾ÆÆêê"},{b:"OE",c:"Å"},{b:"OI",c:"Æ¢"},{b:"OO",c:"ê"},{b:"OU",c:"È¢"},{b:"P",c:"âï¼°á¹á¹Æ¤â±£êêê"},{b:"Q",c:"âï¼±êêÉ"},{b:"R",c:"âï¼²Åá¹ÅÈÈá¹á¹Åá¹Éâ±¤êê¦ê"},{b:"S",c:"âï¼³áºÅá¹¤Åá¹ Å á¹¦á¹¢á¹¨ÈÅâ±¾ê¨ê"},{b:"T",c:"âï¼´á¹ªÅ¤á¹¬ÈÅ¢á¹°á¹®Å¦Æ¬Æ®È¾ê"},{b:"Th",c:"Ã"},{b:"TZ",c:"ê¨"},{b:"U",c:"âï¼µÃÃÃÅ¨á¹¸Åªá¹ºÅ¬ÃÇÇÇÇá»¦Å®Å°ÇÈÈÆ¯á»ªá»¨á»®á»¬á»°á»¤á¹²Å²á¹¶á¹´É"},{b:"V",c:"âï¼¶á¹¼á¹¾Æ²êÉ"},{b:"VY",c:"ê "},{b:"W",c:"âï¼·áºáºÅ´áºáºáºâ±²"},{b:"X",c:"âï¼¸áºáº"},{b:"Y",c:"âï¼¹á»²ÃÅ¶á»¸È²áºÅ¸á»¶á»´Æ³Éá»¾"},{b:"Z",c:"âï¼ºÅ¹áºÅ»Å½áºáºÆµÈ¤â±¿â±«ê¢"},{b:"a",c:"âï½áºÃ Ã¡Ã¢áº§áº¥áº«áº©Ã£ÄÄáº±áº¯áºµáº³È§Ç¡Ã¤Çáº£Ã¥Ç»ÇÈÈáº¡áº­áº·á¸Äâ±¥ÉÉ"},{b:"aa",c:"ê³"},{b:"ae",c:"Ã¦Ç½Ç£"},{b:"ao",c:"êµ"},{b:"au",c:"ê·"},{b:"av",c:"ê¹ê»"},{b:"ay",c:"ê½"},{b:"b",c:"âï½á¸á¸á¸ÆÆÉÆ"},{b:"c",c:"ï½âÄÄÄÄÃ§á¸ÆÈ¼ê¿â"},{b:"d",c:"âï½á¸Äá¸á¸á¸á¸ÄÆÉÉÆá§Ôêª"},{b:"dh",c:"Ã°"},{b:"dz",c:"Ç³Ç"},{b:"e",c:"âï½Ã¨Ã©Ãªá»áº¿á»á»áº½Äá¸á¸ÄÄÃ«áº»ÄÈÈáº¹á»È©á¸Äá¸á¸ÉÇ"},{b:"f",c:"âï½á¸Æ"},{b:"ff",c:"ï¬"},{b:"fi",c:"ï¬"},{b:"fl",c:"ï¬"},{b:"ffi",c:"ï¬"},{b:"ffl",c:"ï¬"},{b:"g",c:"âï½ÇµÄá¸¡ÄÄ¡Ç§Ä£Ç¥É ê¡ê¿áµ¹"},{b:"h",c:"âï½Ä¥á¸£á¸§Èá¸¥á¸©á¸«áºÄ§â±¨â±¶É¥"},{b:"hv",c:"Æ"},{b:"i",c:"âï½Ã¬Ã­Ã®Ä©Ä«Ä­Ã¯á¸¯á»ÇÈÈá»Ä¯á¸­É¨Ä±"},{b:"j",c:"âï½ÄµÇ°É"},{b:"k",c:"âï½á¸±Ç©á¸³Ä·á¸µÆâ±ªêêêê£"},{b:"l",c:"âï½ÅÄºÄ¾á¸·á¸¹Ä¼á¸½á¸»Å¿ÅÆÉ«â±¡êêêÉ­"},{b:"lj",c:"Ç"},{b:"m",c:"âï½á¸¿á¹á¹É±É¯"},{b:"n",c:"âï½Ç¹ÅÃ±á¹Åá¹Åá¹á¹ÆÉ²Åêê¥Ð»Ô"},{b:"nj",c:"Ç"},{b:"o",c:"âï½Ã²Ã³Ã´á»á»á»á»Ãµá¹È­á¹Åá¹á¹ÅÈ¯È±Ã¶È«á»ÅÇÈÈÆ¡á»á»á»¡á»á»£á»á»Ç«Ç­Ã¸Ç¿êêÉµÉá´"},{b:"oe",c:"Å"},{b:"oi",c:"Æ£"},{b:"oo",c:"ê"},{b:"ou",c:"È£"},{b:"p",c:"âï½á¹á¹Æ¥áµ½êêêÏ"},{b:"q",c:"â ï½Éêê"},{b:"r",c:"â¡ï½Åá¹ÅÈÈá¹á¹Åá¹ÉÉ½êê§ê"},{b:"s",c:"â¢ï½Åá¹¥Åá¹¡Å¡á¹§á¹£á¹©ÈÅÈ¿ê©êáºÊ"},{b:"ss",c:"Ã"},{b:"t",c:"â£ï½á¹«áºÅ¥á¹­ÈÅ£á¹±á¹¯Å§Æ­Êâ±¦ê"},{b:"th",c:"Ã¾"},{b:"tz",c:"ê©"},{b:"u",c:"â¤ï½Ã¹ÃºÃ»Å©á¹¹Å«á¹»Å­Ã¼ÇÇÇÇá»§Å¯Å±ÇÈÈÆ°á»«á»©á»¯á»­á»±á»¥á¹³Å³á¹·á¹µÊ"},{b:"v",c:"â¥ï½á¹½á¹¿ÊêÊ"},{b:"vy",c:"ê¡"},{b:"w",c:"â¦ï½áºáºÅµáºáºáºáºâ±³"},{b:"x",c:"â§ï½áºáº"},{b:"y",c:"â¨ï½á»³Ã½Å·á»¹È³áºÃ¿á»·áºá»µÆ´Éá»¿"},{b:"z",c:"â©ï½ÅºáºÅ¼Å¾áºáºÆ¶È¥Éâ±¬ê£"}],se=0;se<ie.length;se+=1)for(var ae=ie[se].c,ue=0;ue<ae.length;ue+=1)re[ae[ue]]=ie[se].b;ie=null;var ce={aac:"audio/aac",ai:"application/postscript",appcache:"text/cache-manifest",avi:"video/avi",bin:"application/octet-stream",bmp:"image/bmp",coffee:"text/coffeescript",css:"text/css",csv:"text/csv",doc:"application/msword",docx:"application/msword",dtd:"application/xml-dtd",eps:"application/postscript",exe:"application/octet-stream",geojson:"application/json",gif:"image/gif",gzip:"application/x-gzip",htm:"text/html",html:"text/html",ico:"image/x-icon",ics:"text/calendar",ifb:"text/calendar",jpe:"image/jpeg",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json",jsx:"text/jsx",less:"text/css",m4a:"audio/mp4a-latm",m4v:"video/x-m4v",manifest:"text/cache-manifest",md:"text/x-markdown",mid:"audio/midi",midi:"audio/midi",mov:"video/quicktime",mp3:"audio/mpeg",mp4:"video/mp4",mpe:"video/mpeg",mpeg:"video/mpeg",mpg:"video/mpeg",mpga:"audio/mpeg",mtl:"text/plain",mv4:"video/mv4",obj:"text/plain",ogg:"application/ogg",ogv:"video/ogg","package":"text/plain",pdf:"application/pdf",png:"image/png",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.ms-powerpoint",ps:"application/postscript",rar:"application/x-rar-compressed",rtf:"text/rtf",sass:"text/css",scss:"text/css",sh:"application/x-sh",stl:"application/sla",svg:"image/svg+xml",swf:"application/x-shockwave-flash",tar:"application/x-tar",tif:"image/tiff",tiff:"image/tiff",txt:"text/plain",wav:"audio/x-wav",webm:"video/webm",webp:"image/webp",woff:"application/font-woff",woff2:"application/font-woff2",xht:"application/xhtml+xml",xhtml:"application/xhtml+xml",xls:"application/vnd.ms-excel",xlsx:"application/vnd.ms-excel",xml:"application/xml",xpm:"image/x-xpixmap",xsl:"application/xml",xslt:"application/xslt+xml",zip:"application/zip"},le={},fe=Object.prototype.hasOwnProperty;return S.isEmpty=function(e){if(!e)return!0;if(e.length)return!1;for(var r in e)if(fe.call(e,r))return!1;return!0},S.isEqual=function(e,r,t){for(var n=t?t:Object.keys(e),o=0,i=n.length;i>o;o++){var s=n[o],a=e[s],u=r[s],c="undefined"==typeof a?"undefined":_typeof(a),l="undefined"==typeof u?"undefined":_typeof(u);if(c!==l)return!1;if(a!==u){if(a instanceof Date&&u instanceof Date){if(a.getTime()===u.getTime())continue;return!1}if(a instanceof Array&&u instanceof Array){if(JSON.stringify(a)===JSON.stringify(u))continue;return!1}if("object"!==c||"object"!==l||!S.isEqual(a,u))return!1}}return!0},S.wait=function(e,r,t,n){if(e()===!0)return r(null,!0);var o=null,i=setInterval(function(){return e()===!0?(clearInterval(i),clearTimeout(o),void(r&&r(null,!0))):void 0},n||500);o=setTimeout(function(){clearInterval(i),r&&r(new Error("Timeout."),!1)},t||5e3)},S.$$wait=function(e,r,t){return function(n){S.wait(e,n,r,t)}},S.resolve=function(e,r){var t=x.parse(e);return r?le[t.host]?(t.host=le[t.host],void r(null,t)):void O.resolve4(t.hostname,function(e,n){return e?void setImmediate(function(){O.resolve4(t.hostname,function(e,n){return e?r(e,t):(le[t.host]=n[0],t.host=n[0],void r(null,t))})}):(le[t.host]=n[0],t.host=n[0],void r(null,t))}):le[t.host]},S.$$resolve=function(e){return function(r){return S.resolve(e,r)}},S.clearDNS=function(){le={}},S.keywords=function(e,r,t,n,o,i){void 0===r&&(r=!0),i=i||2,n=n||200,o=o||20;var s=[],a="soundex"===t;if(e instanceof Array){for(var u=0,c=e.length;c>u;u++)if(e[u]){var l=(r?e[u].removeDiacritics().toLowerCase().replace(/y/g,"i"):e[u].toLowerCase()).replace(/\n/g," ").split(" ");if(l&&l.length)for(var f=0,p=l.length;p>f;f++)s.push(l[f])}}else s=(r?e.removeDiacritics().toLowerCase().replace(/y/g,"i"):e.toLowerCase()).replace(/\n/g," ").split(" ");s||(s=[]);for(var d={},m=0,u=0,c=s.length;c>u;u++){var h=s[u].trim();if(!(h.length<i)){if(m>=n)break;if(r&&(h=h.replace(/\W|_/g,"")),t)if(a)h=h.soundex();else{var g=h.length/100*80;g>i+1&&(h=h.substring(0,g))}h.length<i||h.length>o||(d[h]?d[h]++:d[h]=1,m++)}}var v=Object.keys(d);return v.sort(function(e,r){var t=d[e],n=d[r];return t>n?-1:n>t?1:0}),v},S.request=function(e,t,n,o,i,s,a,u){"function"==typeof n?(u=a,a=s,s=i,i=o,o=n,n=""):n||(n=""),"number"==typeof i&&(i=null,u=i),"number"==typeof s&&(s=null,u=s),"number"==typeof a&&(a=null,u=a),o===NOOP&&(o=null);var c,l={length:0,timeout:1e4,evt:new $.EventEmitter,encoding:"string"!=typeof a?X:a,callback:o,post:!1,redirect:0},f=0;if(s=s?S.extend({},s):{},t instanceof Array)for(var p=0,d=t.length;d>p;p++)if(t[p]>0)l.timeout=t[p];else if("<"!==t[p][0])switch(t[p].toLowerCase()){case"utf8":case"ascii":case"base64":case"binary":case"hex":l.encoding=t[p];break;case"xhr":s["X-Requested-With"]="XMLHttpRequest";break;case"plain":s["Content-Type"]="text/plain";break;case"html":s["Content-Type"]="text/html";break;case"json":s["Content-Type"]="application/json",c||(c="POST"),f=1;break;case"xml":s["Content-Type"]="text/xml",c||(c="POST"),f=2;break;case"get":case"options":case"head":c=t[p].toUpperCase();break;case"upload":s["Content-Type"]="multipart/form-data";break;case"post":case"put":case"delete":case"patch":c=t[p].toUpperCase(),s["Content-Type"]||(s["Content-Type"]="application/x-www-form-urlencoded");break;case"dnscache":l.resolve=!0}else l.max=1024*t[p].substring(1).trim().parseInt();if(c?l.post="POST"===c||"PUT"===c||"DELETE"===c||"PATCH"===c:c="GET","string"!=typeof n?n=1===f?JSON.stringify(n):T.stringify(n):"?"===n[0]&&(n=n.substring(1)),l.post||(n.length&&-1===e.indexOf("?")&&(e+="?"+n),n=""),i){var m="";for(var h in i)m+=(m?"; ":"")+h+"="+i[h];m&&(s.Cookie=m)}n.length&&(l.data=new Buffer(n,X),s["Content-Length"]=l.data.length);var g=x.parse(e);return g.method=c,g.agent=!1,g.headers=s,l.resolve?S.resolve(e,function(e,t){e||(g.host=t.host),r(g,l)}):r(g,l),l.evt},S.$$request=function(e,r,t,n,o,i,s){return function(a){S.request(e,r,t,a,n,o,i,s)}},S.btoa=function(e){return e instanceof Buffer?e.toString("base64"):new Buffer(e.toString(),"binary").toString("base64")},S.atob=function(e){return new Buffer(e,"base64").toString("binary")},S.download=function(e,r,t,o,i,s,a,u){"function"==typeof t&&(u=a,a=s,s=i,i=o,o=t,t=""),"number"==typeof i&&(i=null,u=i),"number"==typeof s&&(s=null,u=s),"number"==typeof a&&(a=null,u=a),"string"!=typeof a&&(a=X);var c="GET",l=0,f={callback:o,resolve:!1,length:0,evt:new $.EventEmitter,timeout:u||6e4,post:!1,encoding:a};if(s=s?S.extend({},s):{},null===t&&(t=""),r instanceof Array)for(var p=0,d=r.length;d>p;p++)if(r[p]>0)f.timeout=r[p];else switch(r[p].toLowerCase()){case"utf8":case"ascii":case"base64":case"binary":case"hex":f.encoding=r[p];break;case"xhr":s["X-Requested-With"]="XMLHttpRequest";break;case"plain":s["Content-Type"]="text/plain";break;case"html":s["Content-Type"]="text/html";break;case"json":s["Content-Type"]="application/json",l=1;break;case"xml":s["Content-Type"]="text/xml",l=2;break;case"get":case"head":case"options":c=r[p].toUpperCase();break;case"upload":s["Content-Type"]="multipart/form-data";break;case"post":case"patch":case"delete":case"put":c=r[p].toUpperCase(),s["Content-Type"]||(s["Content-Type"]="application/x-www-form-urlencoded");break;case"dnscache":f.resolve=!0}if(f.post="POST"===c||"PUT"===c||"DELETE"===c||"PATCH"===c,"string"!=typeof t?t=1===l?JSON.stringify(t):T.stringify(t):"?"===t[0]&&(t=t.substring(1)),f.post||(t.length&&-1===e.indexOf("?")&&(e+="?"+t),t=""),i){var m="";for(var h in i)m+=(m?"; ":"")+h+"="+i[h];m&&(s.Cookie=m)}var g=x.parse(e);return g.method=c,g.agent=!1,g.headers=s,t.length&&(f.data=new Buffer(t,X),s["Content-Length"]=f.data.length),f.resolve?S.resolve(e,function(e,r){e||(g.host=r.host),n(g,f)}):n(g,f),f.evt},S.$$download=function(e,r,t,n,o,i,s){return function(a){S.download(e,r,t,a,n,o,i,s)}},S.send=function(e,r,t,n,o,i,s,a){"string"==typeof r&&(r=N.createReadStream(r,te));var u="----totaljs"+Math.random().toString(16).substring(2),c={};if(i&&S.extend(c,i),o){var l="";for(var f in o)l+=(l?"; ":"")+f+"="+o[f];l&&(c.Cookie=l)}e=S.getName(e),c["Cache-Control"]="max-age=0",c["Content-Type"]="multipart/form-data; boundary="+u;var p=new $.EventEmitter,d=x.parse(t),m={protocol:d.protocol,auth:d.auth,method:s||"POST",hostname:d.hostname,port:d.port,path:d.path,agent:!1,headers:c},h=0,g=function(e){e.body=new Buffer(0),e._bufferlength=0,e.on("data",function(r){e.body=Buffer.concat([e.body,r]),e._bufferlength+=r.length,p.emit("data",r,h?e._bufferlength/h*100:0)}),e.on("end",function(){var e=this;p.emit("end",e.statusCode,e.headers),p.removeAllListeners(),p=null,n&&n(null,e.body.toString("utf8"),e.statusCode,e.headers,d.host),e.body=null})},v="https:"===m.protocol?R:C,y=v.request(m,g);y.on("response",function(e){h=+e.headers["content-length"]||0,p.emit("begin",h)}),y.setTimeout(a||6e4,function(){y.removeAllListeners(),y=null,p.removeAllListeners(),p=null,n&&n(new Error(S.httpStatus(408)),"",408,void 0,d.host)}),y.on("error",function(e){y.removeAllListeners(),y=null,p.removeAllListeners(),p=null,n&&n(e,"",0,void 0,d.host)}),y.on("close",function(){y.removeAllListeners(),y=null});var b=K+K+"--"+u+K+'Content-Disposition: form-data; name="File"; filename="'+e+'"'+K+"Content-Type: "+S.getContentType(S.getExtension(e))+K+K;return y.write(b),r.length?(y.end(r.toString(X)+K+K+"--"+u+"--"),p):(r.on("end",function(){return y.end(K+K+"--"+u+"--")}),r.pipe(y,ne),p)},S.$$send=function(e,r,t,n,o,i,s){return function(a){S.send(e,r,t,a,n,o,i,s)}},S.trim=function(e){if(!e)return e;var r="undefined"==typeof e?"undefined":_typeof(e);if("string"===r)return e.trim();if(e instanceof Array){for(var t=0,n=e.length;n>t;t++){var o=e[t];r="undefined"==typeof o?"undefined":_typeof(o),"object"!==r?"string"===r&&(e[t]=o.trim()):S.trim(o)}return e}return"object"!==r?e:(Object.keys(e).forEach(function(r){var t=e[r],n="undefined"==typeof t?"undefined":_typeof(t);return"object"===n?void S.trim(t):void("string"===n&&(e[r]=t.trim()))}),e)},S.noop=global.noop=global.NOOP=function(){},S.httpStatus=function(e,r){return void 0===r&&(r=!0),(r?e+": ":"")+C.STATUS_CODES[e]},S.extend=function(e,r,t){if(null===e||null===r)return e;if("object"!==("undefined"==typeof e?"undefined":_typeof(e))||"object"!==("undefined"==typeof r?"undefined":_typeof(r)))return e;void 0===t&&(t=!0);for(var n=Object.keys(r),o=n.length;o--;){var i=n[o];(t||void 0===e[i])&&(e[i]=S.clone(r[i]))}return e},S.clone=function(e,r,t){if(!e)return e;var n="undefined"==typeof e?"undefined":_typeof(e);if("object"!==n||e instanceof Date)return e;var o,i;if(e instanceof Array){o=e.length,i=new Array(o);for(var s=0;o>s;s++)if(n=_typeof(e[s]),"object"!==n||e[s]instanceof Date){if(t&&"function"===n)continue;i[s]=e[s]}else i[s]=S.clone(e[s],r,t);return i}i={};for(var a in e)if(!r||!r[a]){var u=e[a],n="undefined"==typeof u?"undefined":_typeof(u);if("object"!==n||u instanceof Date){if(t&&"function"===n)continue;i[a]=u}else i[a]=S.clone(e[a],r,t)}return i},S.copy=function(e,r){if(void 0===r)return S.extend({},e,!0);if(!r||!e)return r;if("object"!==("undefined"==typeof r?"undefined":_typeof(r))||"object"!==("undefined"==typeof e?"undefined":_typeof(e)))return r;for(var t=Object.keys(e),n=t.length;n--;){var o=t[n];void 0!==r[o]&&(r[o]=S.clone(e[o]))}return r},S.reduce=function(e,r,t){if(!(r instanceof Array)&&"object"===("undefined"==typeof r?"undefined":_typeof(r)))return S.reduce(e,Object.keys(r),t);var n={};return Object.keys(e).forEach(function(o){t?-1===r.indexOf(o)&&(n[o]=e[o]):-1!==r.indexOf(o)&&(n[o]=e[o])}),n},S.assign=function(e,r,t){if(null===e||void 0===e)return e;for(var n=r.split("."),o=e[n[0]],i=1;i<n.length-1;i++)o=o[n[i]];return o[n[n.length-1]]="function"==typeof t?t(o[n[n.length-1]]):t,e},S.isRelative=function(e){return!("//"===e.substring(0,2)||-1!==e.indexOf("http://")||-1!==e.indexOf("https://"))},S.streamer=function(e,r,t){"function"==typeof r&&(t=r,r=void 0);var n=0,o=new Buffer(0);if(e=new Buffer(e,"utf8"),r&&(r=new Buffer(r,"utf8")),!r){var i=e.length;return function(r){if(r){o=Buffer.concat([o,r]);var s=o.indexOf(e);if(-1!==s)for(;-1!==s;)if(t(o.toString("utf8",0,s+i),n++),o=o.slice(s+i),s=o.indexOf(e),-1===s)return}}}var s=e.length,a=r.length,u=-1,c=-1,l=!1;return function(i){if(i){if(o=Buffer.concat([o,i]),!l){if(u=o.indexOf(e),-1===u)return;l=!0}if(!l||(c=o.indexOf(r,u+s),-1!==c))for(;-1!==u;){if(t(o.toString("utf8",u,c+a),n++),o=o.slice(c+a),l=!1,u=o.indexOf(e),-1===u)return;if(l=!0,c=o.indexOf(r,u+s),-1===c)return}}}},S.encode=function(e){if(void 0===e)return"";var r="undefined"==typeof e?"undefined":_typeof(e);return"string"!==r&&(e=e.toString()),e.encode()},S.decode=function(e){if(void 0===e)return"";var r="undefined"==typeof e?"undefined":_typeof(e);
return"string"!==r&&(e=e.toString()),e.decode()},S.isStaticFile=function(e){return P.test(e)},S.parseInt=function(e,r){if(void 0===e||null===e)return r||0;var t="undefined"==typeof e?"undefined":_typeof(e);return"number"===t?e:("string"!==t?e.toString():e).parseInt()},S.parseBool=S.parseBoolean=function(e,r){if(void 0===e||null===e)return void 0===r?!1:r;var t="undefined"==typeof e?"undefined":_typeof(e);if("boolean"===t)return e;if("number"===t)return e>0;var n="string"!==t?e.toString():e;return n.parseBool(r)},S.parseFloat=function(e,r){if(void 0===e||null===e)return r||0;var t="undefined"==typeof e?"undefined":_typeof(e);if("number"===t)return e;var n="string"!==t?e.toString():e;return n.parseFloat(r)},S.isArray=function(e){return e instanceof Array},S.isRegExp=function(e){return!(!e||"function"!=typeof e.test)},S.isDate=function(e){return e instanceof Date&&e.getTime()>-1},S.isError=function(e){return!(!e||!e.stack)},S.isObject=function(e){try{return!(!e||Object.getPrototypeOf(e)!==Object.prototype)}catch(r){return!1}},S.getContentType=function(e){return"."===e[0]&&(e=e.substring(1)),ce[e.toLowerCase()]||"application/octet-stream"},S.getExtension=function(e){var r=e.lastIndexOf(".");return-1===r?"":-1===e.indexOf("/",r-1)?e.substring(r+1):""},S.getName=function(e){var r=e.length-1,t=e[r];"/"!==t&&"\\"!==t||(e=e.substring(0,r));var n=e.lastIndexOf("/");return-1!==n?e.substring(n+1):(n=e.lastIndexOf("\\"),-1!==n?e.substring(n+1):e)},S.setContentType=function(e,r){if("."===e[0]&&(e=e.substring(1)),e.length>8){var t=P.toString().replace(/\,\d+\}/,","+e.length+"}").substring(1);P=new RegExp(t.substring(0,t.length-1))}return ce[e.toLowerCase()]=r,!0},S.etag=function(e,r){for(var t=0,n=e.length,o=0;n>o;o++)t+=e.charCodeAt(o);return t.toString()+(r?":"+r:"")},S.path=function(e,r){return e||(e=""),r=r||"/",e[e.length-1]===r?e:e+r},S.join=function(){for(var e=[""],r=0;r<arguments.length;r++){var t=arguments[r];if(t){"/"===t[0]&&(t=t.substring(1));var n=t.length-1;"/"===t[n]&&(t=t.substring(0,n)),e.push(t)}}return e=e.join("/"),Z&&e.indexOf(":")>-1?e.substring(1):e},S.$normalize=function(e){return Z?e.replace(B,"/"):e},S.random=function(e,r){return e=e||1e5,r=r||0,Math.floor(Math.random()*(e-r+1))+r},S.GUID=function(e){e=e||40;for(var r="",t=0;e/3+1>t;t++)r+=i();return r.substring(0,e)},S.validate_builder=function(e,r,t,n,o,i,a,u){var c=n[t],l=c.onValidate||framework.onValidate||NOOP,f=void 0===o?"":o+".",p=c.properties;u||(u=""),null==e&&(e={});for(var d=0;d<p.length;d++){var m=p[d].toString();if(!a||-1!==a.indexOf(m)){var h=e[m],g="undefined"==typeof h?"undefined":_typeof(h),v=n[t].schema[m];if(void 0!==h){if("function"===g&&(h=e[m]()),"object"!==g&&Builders.isJoin(n,m)&&(g="object"),"object"===g&&!S.isDate(h)&&(c=n[t]))if(c=c.schema[m]||null,c===Date||c===String||c===Number||c===Boolean);else if(c&&"string"==typeof c){var y="["===c[0];if(!y){S.validate_builder(h,r,t,n,f+m,i,void 0,u);continue}if(c=c.substring(1,c.length-1).trim(),!(h instanceof Array)){r.add(u+m,u?"@"+m:"@",f+m,i);continue}if(void 0===n[c]){var b=l(m,h,f+m,e,t,v);if(void 0===b&&(b=s(m,h,v)))continue;if(g="undefined"==typeof b?"undefined":_typeof(b),"string"===g){r.add(u+m,b,f+m,i);continue}if("boolean"===g&&!b){r.add(u+m,u?"@"+m:"@",f+m,i);continue}b.isValid===!1&&r.add(u+m,b.error,f+m,i);continue}var w=l(m,h,f+m,e,t,v);if(void 0===w&&(w=s(m,h,v)))continue;if(void 0!==w){if(g="undefined"==typeof w?"undefined":_typeof(w),"string"===g){r.add(u+m,w,f+m,i);continue}if("boolean"===g&&!w){r.add(u+m,u?"@"+m:"@",f+m,i);continue}if(w.isValid===!1){r.add(u+m,w.error,f+m,i);continue}}for(var k=h.length,E=0;k>E;E++)S.validate_builder(h[E],r,c,n,f+m,E,void 0,u);continue}var _=l(m,h,f+m,e,t,v);void 0===_&&(_=s(m,h,v))||(g="undefined"==typeof _?"undefined":_typeof(_),"string"!==g?"boolean"!==g?_.isValid===!1&&r.add(u+m,_.error,f+m,i):_||r.add(u+m,u?"@"+m:"@",f+m,i):r.add(u+m,_,f+m,i))}else r.add(u+m,"@",f+m)}}return r},S.combine=function(){for(var e=framework.directory,r=0,t=arguments.length;t>r;r++){var n=arguments[r];n&&("/"===n[0]&&(n=n.substring(1)),"~"===n[0]?e=n.substring(1):e+=("/"!==e[e.length-1]?"/":"")+n)}return S.$normalize(e)},S.removeDiacritics=function(e){return e.replace(U,function(e){return re[e]||e})},S.parseXML=function(e){for(var r=-1,t=0,n=0,o=[],i={},s=-1;;){if(r=e.indexOf("<![CDATA[",r),-1===r)break;t=e.indexOf("]]>",r+9),e=e.substring(0,r)+e.substring(r+9,t).trim().encode()+e.substring(t+3),r+=9}for(r=-1,t=0;;){if(r=e.indexOf("<",r+1),-1===r)break;if(t=e.indexOf(">",r+1),-1===t)break;var a=e.substring(r,t+1),u=a[1];if("?"!==u&&"/"!==u){n=a.indexOf(" ");var c=!0;-1===n&&(n=a.length-1,c=!1),s=r+a.length;var l="/"===a[a.length-2],f=a.substring(1,n);if(l||o.push(f),c){var p=a.match(W);if(null!==p){for(var d={},m=p.length,h=0;m>h;h++){var g=p[h].indexOf('"');d[p[h].substring(0,g-1)]=p[h].substring(g+1,p[h].length-1).decode()}i[o.join(".")+(l?"."+f:"")+"[]"]=d}}}else{var v=o.pop();if(-1===s||v!==a.substring(2,a.length-1))continue;var y=(o.length?o.join(".")+".":"")+v,b=e.substring(s,r).decode();void 0===i[y]?i[y]=b:i[y]instanceof Array?i[y].push(b):i[y]=[i[y],b],s=-1}}return i},S.parseJSON=function(e){try{return JSON.parse(e)}catch(r){return null}},S.parseQuery=function(e){return framework.onParseQuery(e)},S.getWebSocketFrame=function(e,r,t){var n=a(e,r),o=n.length,i=u(o),s=new Buffer(1+i.length+o);return s[0]=128|t,i.copy(s,1,0,i.length),n.copy(s,i.length+1,0,o),s},S.distance=function(e,r,t,n){var o=6371,i=(t-e).toRad(),s=(n-r).toRad(),a=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e.toRad())*Math.cos(t.toRad())*Math.sin(s/2)*Math.sin(s/2),u=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return(o*u).floor(3)},S.ls=function(e,r,t){var n=new p;n.onComplete=r,"string"==typeof t?(t=t.toLowerCase(),t.onFilter=function(e,r){return r?!0:e.toLowerCase().indexOf(t)}):S.isRegExp(t)?t.onFilter=function(e,r){return r?!0:!!e.match(t)}:n.onFilter=t||null,n.walk(e)},S.ls2=function(e,r,t){var n=new p;n.advanced=!0,n.onComplete=r,"string"==typeof t?(t=t.toLowerCase(),t.onFilter=function(e,r){return r?!0:e.toLowerCase().indexOf(t)}):S.isRegExp(t)?t.onFilter=function(e,r){return r?!0:!!e.match(t)}:n.onFilter=t||null,n.walk(e)},Date.prototype.add=function(e,r){var t=this;if(e.constructor===Number)return new Date(t.getTime()+(e-e%1));if(void 0===r){var n=e.split(" ");e=n[1],r=S.parseInt(n[0])}var o=new Date(t.getTime());switch(e){case"s":case"ss":case"sec":case"second":case"seconds":return o.setSeconds(o.getSeconds()+r),o;case"m":case"mm":case"minute":case"min":case"minutes":return o.setMinutes(o.getMinutes()+r),o;case"h":case"hh":case"hour":case"hours":return o.setHours(o.getHours()+r),o;case"d":case"dd":case"day":case"days":return o.setDate(o.getDate()+r),o;case"w":case"ww":case"week":case"weeks":return o.setDate(o.getDate()+7*r),o;case"M":case"MM":case"month":case"months":return o.setMonth(o.getMonth()+r),o;case"y":case"yyyy":case"year":case"years":return o.setFullYear(o.getFullYear()+r),o}return o},Date.prototype.diff=function(e,r){if(1===arguments.length)r=e,e=Date.now();else{var t="undefined"==typeof e?"undefined":_typeof(e);"string"===t?e=Date.parse(e):S.isDate(e)&&(e=e.getTime())}var n=this.getTime()-e;switch(r){case"s":case"ss":case"second":case"seconds":return n=Math.ceil(n/1e3),0===n?n.toString().parseInt():n;case"m":case"mm":case"minute":case"minutes":return n=Math.ceil(n/1e3/60),0===n?n.toString().parseInt():n;case"h":case"hh":case"hour":case"hours":return n=Math.ceil(n/1e3/60/60),0===n?n.toString().parseInt():n;case"d":case"dd":case"day":case"days":return n=Math.ceil(n/1e3/60/60/24),0===n?n.toString().parseInt():n;case"M":case"MM":case"month":case"months":return n=Math.ceil(n/1e3/60/60/672),0===n?n.toString().parseInt():n;case"y":case"yyyy":case"year":case"years":return n=Math.ceil(n/1e3/60/60/8064),0===n?n.toString().parseInt():n}return NaN},Date.prototype.extend=function(e){var r=new Date(this),t=e.match(q);if(!t)return r;for(var n=0,o=t.length;o>n;n++){var i,s,a=t[n];-1===a.indexOf(":")?-1===a.indexOf("-")?-1===a.indexOf(".")||(i=a.split("."),s=+i[0],r.setDate(s),i[1]&&(s=+i[1],isNaN(s)||r.setMonth(s-1)),i[2]&&(s=+i[2],isNaN(s)||r.setFullYear(s))):(i=a.split("-"),s=+i[0],r.setFullYear(s),i[1]&&(s=+i[1],isNaN(s)||r.setMonth(s-1)),i[2]&&(s=+i[2],isNaN(s)||r.setDate(s))):(i=a.split(":"),s=+i[0],isNaN(s)||r.setHours(s),i[1]&&(s=+i[1],isNaN(s)||r.setMinutes(s)),i[2]&&(s=+i[2],isNaN(s)||r.setSeconds(s)))}return r},Date.prototype.compare=function(e){var r=this,t=r.getTime()-e.getTime();return 0===t?0:0>t?-1:1},Date.compare=function(e,r){return"string"==typeof e&&(e=e.parseDate()),"string"==typeof r&&(r=r.parseDate()),e.compare(r)},Date.prototype.format=function(e,r){var t=this,n=!1;if(e&&"!"===e[0]&&(n=!0,e=e.substring(1)),void 0===e||null===e||""===e)return t.getFullYear()+"-"+(t.getMonth()+1).toString().padLeft(2,"0")+"-"+t.getDate().toString().padLeft(2,"0")+"T"+t.getHours().toString().padLeft(2,"0")+":"+t.getMinutes().toString().padLeft(2,"0")+":"+t.getSeconds().toString().padLeft(2,"0")+"."+t.getMilliseconds().toString().padLeft(3,"0")+"Z";var o=t.getHours();return n&&o>=12&&(o-=12),e.replace(L,function(e){switch(e){case"yyyy":return t.getFullYear();case"yy":return t.getFullYear().toString().substring(2);case"MMM":var n=Q[t.getMonth()];return(framework?framework.resource(r,n)||n:n).substring(0,3);case"MMMM":var n=Q[t.getMonth()];return framework?framework.resource(r,n)||n:n;case"MM":return(t.getMonth()+1).toString().padLeft(2,"0");case"M":return t.getMonth()+1;case"ddd":var n=ee[t.getDay()];return(framework?framework.resource(r,n)||n:n).substring(0,3);case"dddd":var n=ee[t.getDay()];return framework?framework.resource(r,n)||n:n;case"dd":return t.getDate().toString().padLeft(2,"0");case"d":return t.getDate();case"HH":case"hh":return o.toString().padLeft(2,"0");case"H":case"h":return t.getHours();case"mm":return t.getMinutes().toString().padLeft(2,"0");case"m":return t.getMinutes();case"ss":return t.getSeconds().toString().padLeft(2,"0");case"s":return t.getSeconds();case"w":case"ww":var i=new Date(+t);return i.setHours(0,0,0),i.setDate(i.getDate()+4-(i.getDay()||7)),i=Math.ceil(((i-new Date(i.getFullYear(),0,1))/864e5+1)/7),"ww"===e?i.toString().padLeft(2,"0"):i;case"a":var s="AM";return t.getHours()>=12&&(s="PM"),s}})},Date.prototype.toUTC=function(e){var r=this.getTime()+6e4*this.getTimezoneOffset();return e?r:new Date(r)},String.prototype.trim||(String.prototype.trim=function(){return this.replace(H,"")}),String.prototype.replaceAt||(String.prototype.replaceAt=function(e,r){var t=this;return t.substr(0,e)+r+t.substr(e+r.length)}),String.prototype.startsWith=function(e,r){var t,n=this,o=e.length;return r===!0?(t=n.substring(0,o),t.length===o&&t.toLowerCase()===e.toLowerCase()):(t=r?n.substr(r,o):n.substring(0,o),t.length===o&&t===e)},String.prototype.endsWith=function(e,r){var t,n=this,o=e.length;return r===!0?(t=n.substring(n.length-o),t.length===o&&t.toLowerCase()===e.toLowerCase()):(t=r>0?n.substr(n.length-r-o,o):n.substring(n.length-o),t.length===o&&t===e)},String.prototype.replacer=function(e,r){var t=this,n=t.indexOf(e);return-1===n?t:t.substring(0,n)+r+t.substring(n+e.length)},String.prototype.hash=function(e,r){var t=this;switch(r&&(t+=r),(e||"").toLowerCase()){case"md5":return t.md5();case"sha1":return t.sha1();case"sha256":return t.sha256();case"sha512":return t.sha512();default:return c(t)}},String.prototype.count=function(e){var r=0,t=0;do r=this.indexOf(e,r+e.length),r>0&&t++;while(r>0);return t},String.prototype.parseXML=function(){return framework.onParseXML(this)},String.prototype.parseJSON=function(){return S.parseJSON(this)},String.prototype.parseQuery=function(){return S.parseQuery(this)},String.prototype.parseDate=function(){var e=this.trim(),r=e.charCodeAt(e.length-1);if(41===r)return new Date(e);if(90===r)return new Date(Date.parse(e));var t=-1===e.indexOf(" ")?e.split("T"):e.split(" "),n=t[0].indexOf(":"),o=t[0].length;if(-1!==n){var i=t[1];t[1]=t[0],t[0]=i}void 0===t[0]&&(t[0]="");for(var s=void 0===t[1]?!0:0===t[1].length,a=0;o>a;a++){var u=t[0].charCodeAt(a);if(!(u>47&&58>u)&&45!==u&&46!==u&&s)return new Date(e)}void 0===t[1]&&(t[1]="00:00:00");var c=-1===t[0].indexOf("-"),l=(t[0]||"").split(c?".":"-"),f=(t[1]||"").split(":"),p=[];if(l.length<4&&f.length<2)return new Date(e);n=(f[2]||"").indexOf("."),-1!==n?(f[3]=f[2].substring(n+1),f[2]=f[2].substring(0,n)):f[3]="0",p.push(+l[c?2:0]),p.push(+l[1]),p.push(+l[c?0:2]),p.push(+f[0]),p.push(+f[1]),p.push(+f[2]),p.push(+f[3]);for(var d=new Date,a=0,o=p.length;o>a;a++){isNaN(p[a])&&(p[a]=0);var m=p[a];if(0===m)switch(a){case 0:0>=m&&(p[a]=d.getFullYear());break;case 1:0>=m&&(p[a]=d.getMonth()+1);break;case 2:0>=m&&(p[a]=d.getDate())}}return new Date(p[0],p[1]-1,p[2],p[3],p[4],p[5])},String.prototype.parseDateExpiration=function(){for(var e=this,r=e.split(" "),t=new Date,n=r.length,o=0;n>o;o+=2){var i=r[o].parseInt();if(0!==i){var s=r[o+1]||"";""!==s&&(t=t.add(s,i))}}return t},String.prototype.contains=function(e,r){var t=this;if("string"==typeof e)return-1!==t.indexOf(e,"number"==typeof r?r:0);for(var n=e.length,o=0;n>o;o++){var i=-1!==t.indexOf(e[o]);if(r){if(!i)return!1}else if(i)return!0}return r},String.prototype.localeCompare2=function(e){return this.removeDiacritics().localeCompare(e.removeDiacritics())},String.prototype.parseConfig=function(e){for(var r,t,n,o,i=this.split("\n"),s=i.length,a=S.extend({},e),u=0;s>u;u++){var c=i[u];if(c&&"#"!==c[0]&&"//"!==c.substring(0,2)&&(n=c.indexOf(" :"),-1!==n||(n=c.indexOf("	:"),-1!==n)))switch(t=c.substring(0,n).trim(),o=c.substring(n+2).trim(),n=t.indexOf("("),-1!==n?(r=t.substring(n+1,t.indexOf(")")).trim().toLowerCase(),t=t.substring(0,n).trim()):r="",r){case"string":a[t]=o;break;case"number":case"float":case"double":case"currency":a[t]=o.isNumber(!0)?o.parseFloat():o.parseInt();break;case"boolean":case"bool":a[t]=o.parseBoolean();break;case"eval":case"object":case"array":a[t]=new Function("return "+o)();break;case"json":a[t]=o.parseJSON();break;case"date":case"time":case"datetime":a[t]=o.parseDate();break;default:a[t]=o}}return a},String.prototype.format=function(){var e=arguments;return this.replace(M,function(r){var t=e[+r.substring(1,r.length-1)];return null!==t&&void 0!==t||(t=""),t})},String.prototype.encode=function(){for(var e="",r=0,t=this.length;t>r;r++){var n=this[r];switch(n){case"<":e+="&lt;";break;case">":e+="&gt;";break;case'"':e+="&quot;";break;case"'":e+="&apos;";break;case"&":e+="&amp;";break;default:e+=n}}return e},String.prototype.decode=function(){return this.replace(J,function(e){switch(e){case"&gt;":return">";case"&lt;":return"<";case"&quot;":return'"';case"&apos;":return"'";case"&amp;":return"&";default:return e}})},String.prototype.urlEncode=function(){return encodeURIComponent(this)},String.prototype.urlDecode=function(){return decodeURIComponent(this)},String.prototype.params=function(e){var r=this;if(void 0===e||null===e)return r;var t=/\{{2}[^}\n]*\}{2}/g;return r.replace(t,function(r){var t=!1,n=r.substring(2,r.length-2).trim(),o="",i=n.indexOf("|");-1!==i&&(o=n.substring(i+1,n.length).trim(),n=n.substring(0,i).trim()),"!"===n[0]?n=n.substring(1):t=!0;var s;if(-1!==n.indexOf(".")){var a=n.split(".");2===a.length?e[a[0]]&&(s=e[a[0]][a[1]]):3===a.length?e[a[0]]&&e[a[0]][a[1]]&&(s=e[a[0]][a[1]][a[2]]):4===a.length&&(e[a[0]]&&e[a[0]][a[1]]&&e[a[0]][a[1]][a[2]]?s=e[a[0]][a[1]][a[2]][a[3]]:5===a.length&&e[a[0]]&&e[a[0]][a[1]]&&e[a[0]][a[1]][a[2]]&&e[a[0]][a[1]][a[2]][a[3]]&&(s=e[a[0]][a[1]][a[2]][a[3]][a[4]]))}else s=0===n.length?e:e[n];if("function"==typeof s&&(s=s(i)),void 0===s)return r;if(o.length){var u="undefined"==typeof s?"undefined":_typeof(s);if("string"===u){var c=+o;isNaN(c)||(s=s.max(c+3,"..."))}else("number"===u||S.isDate(s))&&(o.isNumber()&&(o=+o),s=s.format(o))}return s=s.toString(),t?S.encode(s):s})},String.prototype.max=function(e,r){var t=this;return"string"!=typeof r&&(r="..."),t.length>e?t.substring(0,e-r.length)+r:t},String.prototype.isJSON=function(){var e=this;if(e.length<=1)return!1;for(var r,t,n=e.length-1,o=0;;)if(r=e[o++]," "!==r&&"\n"!==r&&"\r"!==r&&"	"!==r)break;for(;;)if(t=e[n--]," "!==t&&"\n"!==t&&"\r"!==t&&"	"!==t)break;return'"'===r&&'"'===t||"["===r&&"]"===t||"{"===r&&"}"===t},String.prototype.isURL=function(){var e=this;return e.length<=7?!1:I.test(e)},String.prototype.isZIP=function(){var e=this;return Y.test(e)},String.prototype.isEmail=function(){var e=this;return e.length<=4?!1:F.test(e)},String.prototype.isPhone=function(){var e=this;return e.length<6?!1:j.test(e)},String.prototype.isUID=function(){var e=this;return e.length<18?!1:z.test(e)},String.prototype.parseInt=function(e){var r=this.trim(),t=+r;return isNaN(t)?e||0:t},String.prototype.parseBool=String.prototype.parseBoolean=function(){var e=this.toLowerCase();return"true"===e||"1"===e||"on"===e},String.prototype.parseFloat=function(e){var r=this.trim();-1!==r.indexOf(",")&&(r=r.replace(",","."));var t=+r;return isNaN(t)?e||0:t},String.prototype.capitalize=function(){for(var e,r=[],t=0,n=this.length;n>t;t++){var e=this[t-1];e=e&&" "!==e&&"	"!==e&&"\n"!==e?this[t]:this[t].toUpperCase(),r.push(e)}return r.join("")},String.prototype.toUnicode=function(){for(var e="",r=this,t=r.length,n=0;t>n;++n)e+=r.charCodeAt(n)>126||r.charCodeAt(n)<32?"\\u"+r.charCodeAt(n).hex(4):r[n];return e},String.prototype.fromUnicode=function(){var e=this.replace(/\\u([\d\w]{4})/gi,function(e,r){return String.fromCharCode(parseInt(r,16))});return unescape(e)},String.prototype.sha1=function(e){var r=D.createHash("sha1");return r.update(this+(e||""),X),r.digest("hex")},String.prototype.sha256=function(e){var r=D.createHash("sha256");return r.update(this+(e||""),X),r.digest("hex")},String.prototype.sha512=function(e){var r=D.createHash("sha512");return r.update(this+(e||""),X),r.digest("hex")},String.prototype.md5=function(e){var r=D.createHash("md5");return r.update(this+(e||""),X),r.digest("hex")},String.prototype.toSearch=function(){return this.replace(/[^a-zA-ZÃ¡-Å¾Ã-Å½\d\s:]/g,"").trim().replace(/\s{2,}/g," ").toLowerCase().removeDiacritics().replace(/y/g,"i")},String.prototype.toKeywords=String.prototype.keywords=function(e,r,t,n,o){return S.keywords(this,e,r,t,n,o)},String.prototype.encrypt=function(e,r){var t="0"+this,n=t.length,o=e.length,i=r?S.random(120)+40:65,s=n+i%o,a=[],u=0;a[0]=String.fromCharCode(i);for(var c=this.length+e.length,l=s-1;l>0;l--)u=t.charCodeAt(l%n),a[l]=String.fromCharCode(u^(e.charCodeAt(l%o)^i));var f=new Buffer(c+"="+a.join(""),X).toString("base64").replace(/\//g,"-").replace(/\+/g,"_");return u=f.indexOf("="),u>0?f.substring(0,u):f},String.prototype.decrypt=function(e){var r=this.replace(/\-/g,"/").replace(/\_/g,"+"),t=r.length%4;if(t>0)for(var n=0;t>n;n++)r+="=";r=new Buffer(r,"base64").toString(X);var o=r.indexOf("=");if(-1===o)return null;var i=+r.substring(0,o);if(isNaN(i))return null;r=r.substring(o+1);for(var s=r.length,a=r.charCodeAt(0),u=e.length,c=s-a%u,l=[],n=c-1;n>0;n--)o=r.charCodeAt(n)^(a^e.charCodeAt(n%u)),l[n]=String.fromCharCode(o);var f=l.join("");return i!==f.length+e.length?null:f},String.prototype.base64ToFile=function(e,r){var t=this,n=t.indexOf(",");return-1===n?n=0:n++,r?N.writeFile(e,t.substring(n),"base64",r):N.writeFile(e,t.substring(n),"base64",S.noop),this},String.prototype.base64ToBuffer=function(){var e=this,r=e.indexOf(",");return-1===r?r=0:r++,new Buffer(e.substring(r),"base64")},String.prototype.base64ContentType=function(){var e=this,r=e.indexOf(";");return-1===r?"":e.substring(5,r)},String.prototype.removeDiacritics=function(){return S.removeDiacritics(this)},String.prototype.indent=function(e,r){var t="";for(void 0===r&&(r=" ");e--;)t+=r;return t+this},String.prototype.isNumber=function(e){var r=this,t=r.length;if(!t)return!1;e=e||!1;for(var n=0;t>n;n++){var o=r.charCodeAt(n);if(!e||44!==o&&46!==o){if(48>o||o>57)return!1}else e=!1}return!0},String.prototype.padLeft||(String.prototype.padLeft=function(e,r){var t=this,n=e-t.length;if(0>n)return t;for(void 0===r&&(r=" ");n--;)t=r+t;return t}),String.prototype.padRight||(String.prototype.padRight=function(e,r){var t=this,n=e-t.length;if(0>n)return t;for(void 0===r&&(r=" ");n--;)t+=r;return t}),String.prototype.insert=function(e,r){var t=this,n=t.substring(0,e),o=r.toString()+t.substring(e);return n+o},String.prototype.slug=String.prototype.toSlug=String.prototype.toLinker=String.prototype.linker=function(e){e=e||60;for(var r=this.trim().toLowerCase().removeDiacritics(),t="",n=r.length,o=0;n>o;o++){var i=r[o],s=r.charCodeAt(o);if(t.length>=e)break;if(s>31&&48>s){if("-"===t[t.length-1])continue;t+="-"}else s>47&&58>s?t+=i:s>94&&123>s&&(t+=i)}var a=t.length-1;return"-"===t[a]?t.substring(0,a):t},String.prototype.pluralize=function(e,r,t,n){var o=this;return o.parseInt().pluralize(e,r,t,n)},String.prototype.isBoolean=function(){var e=this.toLowerCase();return"true"===e||"false"===e},String.prototype.isAlphaNumeric=function(){var e=/^[A-Za-z0-9]+$/;return!!this.match(e)},String.prototype.soundex=function(){for(var e=this.toLowerCase().split(""),r=e.shift(),t=r.toUpperCase(),n=0,o=e.length;o>n;n++){var i=V[e[n]];void 0!==i&&(n?i!==e[n-1]&&(t+=i):i!==V[r]&&(t+=i))}return(t+"000").substring(0,4)},String.prototype.removeTags=function(){return this.replace(G,"")},Number.prototype.floor=function(e){return Math.floor(this*Math.pow(10,e))/Math.pow(10,e)},Number.prototype.padLeft=function(e,r){return this.toString().padLeft(e,r||"0")},Number.prototype.padRight=function(e,r){return this.toString().padRight(e,r||"0")},Number.prototype.async=function(e,r){var t=this;return t?(e(t--,function(){return setImmediate(function(){return t.async(e,r)})}),t):(r&&r(),t)},Number.prototype.format=function(e,r,t){var n=this;if("string"==typeof e)return n.format2(e);var o=n.toString(),i="",s="",a="-"===o[0]?"-":"";a&&(o=o.substring(1));var u=o.indexOf(".");if("string"==typeof e){var c=r;r=e,e=c}void 0===r&&(r=" "),-1!==u&&(i=o.substring(u+1),o=o.substring(0,u)),u=-1;for(var l=o.length-1;l>=0;l--)u++,u>0&&u%3===0&&(s=r+s),s=o[l]+s;return(e||i.length)&&(i=i.length>e?i.substring(0,e||0):i.padRight(e||0,"0")),i.length&&void 0===t&&(t="."===r?",":"."),a+s+(i.length?t+i:"")},Number.prototype.add=function(e,r){if(void 0===e||null===e)return this;if("number"==typeof e)return this+e;var t=e.charCodeAt(0),n=!1;(48>t||t>57)&&(n=!0,e=e.substring(1));var o,i=e.length,s=!1;if("%"===e[i-1]){if(e=e.substring(0,i-1),s=!0,n){var a=e.parseFloat();switch(t){case 42:o=this*(this/100*a);break;case 43:o=this+this/100*a;break;case 45:o=this-this/100*a;break;case 47:o=this/(this/100*a)}return void 0!==r?o.floor(r):o}return o=this/100*e.parseFloat(),void 0!==r?o.floor(r):o}switch(o=e.parseFloat(),t){case 42:o=this*o;break;case 43:o=this+o;break;case 45:o=this-o;break;case 47:o=this/o;break;case 47:o=this/o;break;default:o=this}return void 0!==r?o.floor(r):o},Number.prototype.format2=function(e){var r=0,t=this.toString(),n=0,o=0,i=0,s="",a=0;if("string"==typeof e){var u=!1;a=e.length;for(var c=0;a>c;c++){var l=e[c];"#"===l&&(u?o++:n++),"."===l&&(u=!0)}var f=t,p="";if(r=t.indexOf("."),-1!==r&&(f=t.substring(0,r),p=t.substring(r+1)),f.length>n){i=f.length-n;for(var d="",c=0;i>c;c++)d+="#";e=d+e}f.length<n&&(f=f.padLeft(n," ")),p.length<o&&(p=p.padRight(o,"0")),p.length>o&&(p=p.substring(0,o)),u=!1,r=0;var m=!0;a=e.length;for(var c=0;a>c;c++){var l=e[c];if("#"===l){var h=u?p[r]:f[r];m&&(m=-1!==[","," "].indexOf(h)),m||(s+=h),r++}else{if(m)continue;"."===l&&(u=!0,r=0),s+=l}}return s}if(s="### ### ###",n=t.indexOf("."),i=e||0,0===i&&-1!==n&&(i=t.length-(n+1)),i>0){s+=".";for(var c=0;i>c;c++)s+="#"}return this.format(s)},Number.prototype.pluralize=function(e,r,t,n){var o=this,i="";i=0==o?e||"":1==o?r||"":o>1&&5>o?t||"":n;var s=i.indexOf("#");if(-1===s)return i;var a=i.lastIndexOf("#"),u=i.substring(s,a+1);return o.format(u)+i.replace(u,"")},Number.prototype.hex=function(e){for(var r=this.toString(16).toUpperCase();r.length<e;)r="0"+r;return r},Number.prototype.VAT=function(e,r,t){var n=this,o="undefined"==typeof r?"undefined":_typeof(r);if("boolean"===o){var i=t;t=r,r=i,o="undefined"==typeof r?"undefined":_typeof(r)}return"undefined"===o&&(r=2),void 0===t&&(t=!0),0===e||0===n?n:t?(n/(e/100+1)).floor(r):(n*(e/100+1)).floor(r)},Number.prototype.discount=function(e,r){var t=this;return void 0===r&&(r=2),(t-t/100*e).floor(r)},Number.prototype.parseDate=function(e){return new Date(this+(e||0))},"undefined"==typeof Number.prototype.toRad&&(Number.prototype.toRad=function(){return this*Math.PI/180}),Array.prototype.take=function(e){for(var r=[],t=this,n=t.length,o=0;n>o;o++)if(r.push(t[o]),r.length>=e)return r;return r},Array.prototype.extend=function(e,r){for(var t="function"==typeof e,n=0,o=this.length;o>n;n++)t?this[n]=e(this[n],n):this[n]=S.extend(this[n],e,r);return this},Array.prototype.first=function(e){var r=this[0];return void 0===r?e:r},Array.prototype.toObject=function(e){for(var r=this,t={},n=0,o=r.length;o>n;n++){var i=r[n];e?t[i[e]]=i:t[i]=!0}return t},Array.prototype.compare=function(e,r,t){for(var n=this,o={},i={},s=n.length,a=r.length,u=Math.max(s,a),c={},l=0;u>l;l++){var f=n[l];f&&(o[f[e]]=l);var p=r[l];p&&(i[p[e]]=l)}for(var d=-1,l=0;u>l;l++){var m,h,f=n[l],p=r[l];if(f){if(m=f[e],c[m])continue;c[m]=!0,d=i[m],void 0===d?t(f,void 0,l,-1):t(f,r[d],l,d)}if(p){if(h=p[e],c[h])continue;c[h]=!0,d=o[h],void 0===d?t(void 0,p,-1,l):t(n[d],p,d,l)}}},Array.prototype.pair=function(e,r,t,n){if(e instanceof Array){var o=e;e=r,r=o}r||(r=new Array(0));for(var i=r.length,s=0;;){var a=this[s++];if(!a)break;for(var u=!1,c=0;i>c;c++)if(a[e]===r[c][e]){t(a,r[c]),u=!0;break}!u&&n&&(s--,this.splice(s,1))}return this},Array.prototype.last=function(e){var r=this[this.length-1];return void 0===r?e:r},Array.prototype.quicksort=Array.prototype.orderBy=function(e,r,t){var n=this.length;if(!n||1===n)return this;"boolean"==typeof e&&(r=e,e=void 0),void 0===t&&(t=3),void 0===r&&(r=!0);var o=this,i=0,s=e?o[0][e]:o[0];switch("undefined"==typeof s?"undefined":_typeof(s)){case"string":i=s.length>20&&"T"===s[11]&&"-"===s[5]?4:1;break;case"number":i=2;break;case"boolean":i=3;break;default:if(!S.isDate(s))return o;i=4}return E(o,function(n,o){var s=e?n[e]:n,a=e?o[e]:o;return 1===i?s&&a?r?s.substring(0,t).removeDiacritics().localeCompare(a.substring(0,t).removeDiacritics()):a.substring(0,t).removeDiacritics().localeCompare(s.substring(0,t).removeDiacritics()):0:2===i?s>a?r?1:-1:a>s?r?-1:1:0:3===i?s===!0&&a===!1?r?1:-1:s===!1&&a===!0?r?-1:1:0:4===i&&s&&a?(s.getTime||(s=new Date(s)),a.getTime||(a=new Date(a)),s.getTime()>a.getTime()?r?1:-1:s.getTime()<a.getTime()?r?-1:1:0):0}),o},Array.prototype.trim=function(){for(var e=this,r=[],t=0,n=e.length;n>t;t++)"string"==typeof e[t]&&(e[t]=e[t].trim()),e[t]&&r.push(e[t]);return r},Array.prototype.skip=function(e){for(var r=[],t=this,n=t.length,o=0;n>o;o++)o>=e&&r.push(t[o]);return r},Array.prototype.where=function(e,r){for(var t=this,n=[],o="function"==typeof e,i=void 0!==r,s=0,a=t.length;a>s;s++)if(o)e.call(t,t[s],s)&&n.push(t[s]);else if(i){if(!t[s])continue;t[s][e]===r&&n.push(t[s])}else t[s]===e&&n.push(t[s]);return n},Array.prototype.findItem=Array.prototype.find=function(e,r){var t=this,n=t.findIndex(e,r);return-1===n?null:t[n]},Array.prototype.findIndex=function(e,r){for(var t=this,n="function"==typeof e,o=void 0!==r,i=0,s=t.length;s>i;i++)if(n){if(e.call(t,t[i],i))return i}else if(o){if(!t[i])continue;if(t[i][e]===r)return i}else if(t[i]===e)return i;return-1},Array.prototype.remove=function(e,r){for(var t=this,n=[],o="function"==typeof e,i=void 0!==r,s=0,a=t.length;a>s;s++)if(o)e.call(t,t[s],s)||n.push(t[s]);else if(i){if(!t[s])continue;t[s][e]!==r&&n.push(t[s])}else t[s]!==e&&n.push(t[s]);return n},Array.prototype.random=function(){var e=this;return e[S.random(e.length-1)]},Array.prototype.wait=Array.prototype.waitFor=function(e,r,t){var n=this,o=!1;if(!e.$index&&(e.$pending=0,e.$index=0,o=!0,"number"==typeof r)){var i=t;t=r,r=i}void 0===t&&(t=1);var s=t===!0?n.shift():n[e.$index];if(e.$index++,void 0===s)return e.$pending?n:(r&&r(),e.$index=0,n);if(e.$pending++,e.call(n,s,function(){setImmediate(function(){e.$pending--,n.wait(e,r,t)})}),!o||t===!0)return n;for(var a=1;t>a;a++)n.wait(e,r,0);return n},Array.prototype.async=function(e,r){var t=this,n=!1;"function"==typeof e?(r=e,e=1):void 0===e&&(e=1),void 0===t.$pending&&(t.$pending=0,n=!0);var o=t.shift();if(void 0===o)return t.$pending?t:(delete t.$pending,r&&r(),t);for(var i=0;e>i;i++)i&&(o=t.shift()),t.$pending++,o(function(){setImmediate(function(){t.$pending--,t.async(1,r)})});return t},Array.prototype.randomize=function(){var e=this,r=(10*Math.floor(1e8*Math.random())).toString(),t=0,n=0;return e.sort(function(e,o){var i=r[t++];return void 0===i&&(i=r[0],t=0),n>i?(n=i,-1):n===i?(n=i,0):(n=i,1)}),e},Array.prototype.limit=function(e,r,t,n){void 0===n&&(n=0);for(var o=[],i=this,s=n+e,a=n;s>a;a++){var u=i[a];{if(void 0===u)return o.length?(r(o,function(){return t&&t()},n,n+e),i):(t&&t(),i);o.push(u)}}return o.length?(r(o,function(){return s<i.length?void i.limit(e,r,t,s):void(t&&t())},n,n+e),i):(t&&t(),i)},Array.prototype.unique=function(e){for(var r=this,t=[],n=0,o=0,i=r.length;i>o;o++){var s=r[o];if(e)if(0!==n){for(var a=!0,u=0;n>u;u++)if(t[u][e]===s[e]){a=!1;break}a&&(t.push(s),n++)}else t.push(s),n++;else-1===t.indexOf(s)&&t.push(s)}return t},l.prototype.run=function(){var e=this;try{if(e.isCanceled)return e.complete(),e;e.isRunning=1,e.owner.tasksWaiting[e.name]=!0,e.owner.emit("begin",e.name);var r=e.owner.tasksTimeout[e.name];r>0&&(e.interval=setTimeout(function(){e.timeout()},r)),e.fn(function(){setImmediate(function(){e.complete()})})}catch(t){e.owner.emit("error",e.name,t),e.complete()}return e},l.prototype.timeout=function(e){var r=this;return e>0?(clearTimeout(r.interval),setTimeout(function(){r.timeout()},e),r):0>=e?(clearTimeout(r.interval),setTimeout(function(){r.timeout()},e),r):(setImmediate(function(){r.cancel(!0)}),r)},l.prototype.cancel=function(e){var r=this;return r.isCanceled=!0,e?r.owner.emit("timeout",r.name):r.owner.emit("cancel",r.name),r.fn=null,r.cb=null,r.complete(),r},l.prototype.complete=function(){var e=this,r=e.owner;if(e.isRunning=2,delete r.tasksPending[e.name],delete r.tasksWaiting[e.name],!e.isCanceled)try{r.emit("end",e.name),e.cb&&e.cb()}catch(t){r.emit("error",t,e.name)}return setImmediate(function(){r.reload(),r.refresh()}),r},f.prototype={get count(){return this._count},get percentage(){var e=this,r=100-Math.floor(100*e._count/e._max);return r?r:0}},f.prototype.__proto__=Object.create($.EventEmitter.prototype,{constructor:{value:f,enumberable:!1}}),f.prototype.reload=function(){var e=this;return e.tasksAll=Object.keys(e.tasksPending),e.emit("percentage",e.percentage),e},f.prototype.cancel=function(e){var r=this;if(void 0===e){r.isCanceled=!0;for(var t=0;t<r._count;t++)r.cancel(r.tasksAll[t]);return!0}var n=r.tasksPending[e];return n?(delete r.tasksPending[e],delete r.tasksWaiting[e],n.cancel(),n=null,r.reload(),r.refresh(),!0):!1},f.prototype.await=function(e,r,t){var n=this;return n.isCanceled?!1:("function"==typeof e&&(t=r,r=e,e=S.GUID(6)),void 0!==n.tasksPending[e]?!1:(n.tasksPending[e]=new l(n,e,r,t,null),n._max++,n.reload(),n.refresh(),!0))},f.prototype.wait=function(e,r,t,n){var o=this;return o.isCanceled?!1:("function"==typeof r&&(n=t,t=r,r=null),void 0!==o.tasksPending[e]?!1:(o.tasksPending[e]=new l(o,e,t,n,r),o._max++,o.reload(),o.refresh(),!0))},f.prototype.complete=function(e){return this.run(e)},f.prototype.run=function(e){var r=this;return r._isRunning=!0,e&&r.onComplete.push(e),r.refresh(),r},f.prototype.isRunning=function(e){var r=this;if(!e)return r._isRunning;var t=r.tasksPending[e];return t?1===t.isRunning:!1},f.prototype.isWaiting=function(e){var r=this,t=r.tasksPending[e];return t?0===t.isRunning:!1},f.prototype.isPending=function(e){var r=this,t=r.tasksPending[e];return!!t},f.prototype.timeout=function(e,r){var t=this;return r?(t.tasksTimeout[e]=r,t):(delete t.tasksTimeout[e],t)},f.prototype.refresh=function(e){var r=this;if(!r._isRunning||r._isEnd)return r;
r._count=r.tasksAll.length;for(var t=0;;){var e=r.tasksAll[t++];if(!e)break;var n=r.tasksPending[e];if(void 0===n)break;r.isCanceled||n.isCanceled?(delete r.tasksPending[e],delete r.tasksWaiting[e],r.tasksAll.splice(t,1),r._count=r.tasksAll.length,t--):0===n.isRunning&&(n.waiting&&r.tasksPending[n.waiting]||n.run())}if(0===r._count){r._isRunning=!1,r._isEnd=!0,r.emit("complete"),r.emit("percentage",100),r._max=0;var o=r.onComplete,i=o.length;r.onComplete=[];for(var s=0;i>s;s++)try{o[s]()}catch(a){r.emit("error",a)}setImmediate(function(){r._isEnd=!1})}return r},p.prototype.reset=function(){var e=this;e.file=[],e.directory=[],e.pendingDirectory=[]},p.prototype.walk=function(e){var r=this;if(e instanceof Array){for(var t=e.length,n=0;t>n;n++)r.pendingDirectory.push(e[n]);return void r.next()}N.readdir(e,function(t,n){if(t)return r.next();for(var o=n.length,i=0;o>i;i++)r.pending.push(A.join(e,n[i]));r.next()})},p.prototype.stat=function(e){var r=this;N.stat(e,function(t,n){return t?r.next():!n.isDirectory()||r.onFilter&&!r.onFilter(e,!0)?(r.onFilter&&!r.onFilter(e,!1)||r.file.push(r.advanced?{filename:e,stats:n}:e),void r.next()):(r.directory.push(e),r.pendingDirectory.push(e),void r.next())})},p.prototype.next=function(){var e=this;if(e.pending.length){var r=e.pending.shift();return void e.stat(r)}if(e.pendingDirectory.length){var t=e.pendingDirectory.shift();return void e.walk(t)}e.onComplete(e.advanced?e.file.filename:e.file,e.directory)},S.Async=f,S.sync=function(e,r){return function(){var t,n,o=[].slice.call(arguments),i=!1,s=r||this;return o.push(function(){t=arguments,!i&&n&&(i=!0,n.apply(s,t))}),e.apply(s,o),function(e){n=e,!i&&t&&(i=!0,n.apply(s,t))}}},S.sync2=function(e,r){return function(){var t,n,o=!1,i=r||this,s=[].slice.call(arguments);return s.push(function(){t=arguments,!o&&n&&(o=!0,n.apply(i,t))}),e.apply(i,s),function(e){n=e,!o&&t&&(o=!0,n.apply(i,t))}}()},S.async=function(e,r){var t=this;return function(n){function o(e,r){var t,i;try{var a=!e;switch(a){case!0:t=u.next(r);break;case!1:t=u["throw"](e)}}catch(c){if(!n)return;return i="undefined"==typeof n?"undefined":_typeof(n),"object"===i&&n.isController?void(c instanceof ErrorBuilder?n.content(c):n.view500(c)):void("function"===i&&setImmediate(function(){return n(c)}))}if(t.done)return void("function"==typeof n&&n(null,t.value));var l=t.value instanceof Promise;if("function"!=typeof t.value&&!l)return void o.call(s,null,t.value);try{if(l)return void t.value.then(function(e){return o.call(s,null,e)});t.value.call(s,function(){o.apply(s,arguments)})}catch(c){setImmediate(function(){return o.call(s,c)})}}var i,s=this;if(arguments.length)if(r)i=arguments[1];else{i=[];for(var a=1;a<arguments.length;a++)i.push(arguments[a])}else i=new Array(0);var u=e.apply(t,i);return o(null),u.value}},S.getMessageLength=function(e,r){var t=127&e[1];return 126===t?e.length<4?-1:d([e[3],e[2],0,0,0,0,0,0],0,r):127===t?e.Length<10?-1:d([e[9],e[8],e[7],e[6],e[5],e[4],e[3],e[2]],0,r):t},S.queuecache={},S.queue=function(e,r,t){if(!t)return!1;if(!r)return t(NOOP),!0;void 0===S.queuecache[e]&&(S.queuecache[e]={limit:r,running:0,pending:[]});var n=S.queuecache[e];return n.running>=n.limit?(n.pending.push(t),!1):(n.running++,function(e){setImmediate(function(){t(function(){m(e)})})}(e),!0)},S.minifyStyle=function(e){return require("./internal").compile_css(e)},S.minifyScript=function(e){return require("./internal").compile_javascript(e)},S.minifyHTML=function(e){return require("./internal").compile_html(e)},S.restart=function(){S.queuecache={},le={}},S.parseTheme=function(e){if("="!==e[0])return"";var r=e.indexOf("/",2);return-1===r?"":(e=e.substring(1,r),"?"===e?framework.config["default-theme"]:e)},S.set=function(e,r,t){var n="S+"+r;if(global.framework&&framework.temporary.other[n])return framework.temporary.other[n](e,t);for(var o=r.split("."),i=[],s="",a=0,u=o.length;u>a;a++){s+=(""!==s?".":"")+o[a];var c=o[a]instanceof Array?"[]":"{}";{if(a===u-1){if("{}"===c)break;s=s.substring(0,s.lastIndexOf("[")),i.push("if(!(w."+s+" instanceof Array))w."+s+"="+c);break}i.push("if(typeof(w."+s+')!=="object"||w.'+s+"===null)w."+s+"="+c)}}var l=new Function("w","a","b",i.join(";")+";w."+r.replace(/\'/,"'")+"=a;return a");global.framework&&(framework.temporary.other[n]=l),l(e,t,r)},S.get=function(e,r){var t="G="+r;if(global.framework&&framework.temporary.other[t])return framework.temporary.other[t](e);for(var n=r.split("."),o=[],i="",s=0,a=n.length-1;a>s;s++){var u=n[s],c=u.lastIndexOf("[");-1!==c&&o.push("if(!w."+(i?i+".":"")+u.substring(0,c)+")return"),i+=(""!==i?".":"")+n[s],o.push("if(!w."+i+")return")}var l=new Function("w",o.join(";")+";return w."+r.replace(/\'/,"'"));return global.framework&&(framework.temporary.other[t]=l),l(e)},global.Async=global.async=S.async,global.sync=global.SYNCHRONIZE=S.sync,global.sync2=S.sync2,_.prototype.append=_.prototype.write=function(e){var r=this;return r.stack.push(e),r.stack.length>=r.max&&(r.flushing++,N.writeFile(r.filename+r.index++ +".json",JSON.stringify(r.stack),function(){return r.flushing--}),r.stack=[]),r},_.prototype.end=function(){var e=this;return e.stack.length&&(e.flushing++,N.writeFile(e.filename+e.index++ +".json",JSON.stringify(e.stack),function(){return e.flushing--}),e.stack=[]),e},_.prototype.each=function(e,r,t){var n=this;return void 0===t&&(t=0),t>=n.index?r&&r():(n.read(t++,function(o,i){e(i,function(){return n.each(e,r,t)},t-1)}),n)},_.prototype.read=function(e,r){var t=this;return t.flushing?void(t.flushing_timeout=setTimeout(function(){return t.read(e,r)},300)):(N.readFile(t.filename+e+".json",function(e,t){return e?r(null,oe):void r(null,t.toString("utf8").parseJSON())}),t)},_.prototype.clear=function(){for(var e=this,r=[],t=0;t<e.index;t++)r.push(e.filename+t+".json");return r.wait(function(e,r){return N.unlink(e,r)}),e},_.prototype.destroy=function(){var e=this;return e.clear(),e.indexer=0,e.flushing=0,clearTimeout(e.flushing_timeout),e.stack=null,e},S.chunker=function(e,r){return new _(e,r)},e}({exports:{}}),function(e){function r(e,r){return e[r]<<8|e[r+1]}function t(e,r){return e[r]<<24|e[r+1]<<16|e[r+2]<<8|e[r+3]}function n(e,r,t,n){var o="undefined"==typeof e?"undefined":_typeof(e);this.width=t,this.height=n,this.builder=[],this.filename="string"===o?e:null,this.currentStream="object"===o?e:null,this.isIM=void 0===r||null===r?"im"===F.config["default-image-converter"]:r,this.outputType="string"===o?framework_utils.getExtension(e):"jpg"}var o=e.exports;global.framework_image=e.exports;var i={192:!0,193:!0,194:!0,195:!0,197:!0,198:!0,199:!0,201:!0,202:!0,203:!0,205:!0,206:!0,207:!0},s=require("child_process"),a=s.exec,u=s.spawn,c=require("fs"),l={};return global.framework_utils||(global.framework_utils=require("./utils")),o.measureGIF=function(e){return{width:e[6],height:e[8]}},o.measureJPG=function(e){var t=e.length,n=0,o=255==e[0]&&216==e[1];if(o){for(n+=2;t>n;){for(;255!=e[n];)n++;for(;255==e[n];)n++;{if(i[e[n]]){var s=r(e,n+6),a=r(e,n+4);return{width:s,height:a}}n+=r(e,++n)}}return null}},o.measurePNG=function(e){return{width:t(e,16),height:t(e,20)}},o.measureSVG=function(e){var r=e.toString("utf8").match(/(width=\"\d+\")+|(height=\"\d+\")+/g);if(r){for(var t=0,n=0,o=0,i=r.length;i>o;o++){var s=r[o];if(t>0&&n>0)break;0===t&&s.startsWith('width="')&&(t=+s.match(/\d+/g),isNaN(t)&&(t=0)),0===n&&s.startsWith('height="')&&(n=+s.match(/\d+/g),isNaN(n)&&(n=0))}return{width:t,height:n}}},n.prototype.clear=function(){var e=this;return e.builder=[],e},n.prototype.measure=function(e){var r=this,t=r.filename.lastIndexOf(".");if(!r.filename)return void e(new Error("Measure does not support stream."));if(-1===t)return void e(new Error("This type of file is not supported."));var n=r.filename.substring(t).toLowerCase(),i=require("fs").createReadStream(r.filename,{start:0,end:".jpg"===n?4e4:24});return i.on("data",function(r){switch(n){case".jpg":return void e(null,o.measureJPG(r));case".gif":return void e(null,o.measureGIF(r));case".png":return void e(null,o.measurePNG(r))}e(new Error("This type of file is not supported."))}),i.on("error",e),r},n.prototype.$$measure=function(){var e=this;return function(r){e.measure(r)}},n.prototype.save=function(e,r,t){var n=this;"function"==typeof e&&(r=e,e=null),n.builder.length||n.minify(),e=e||n.filename||"";var o=n.cmd(n.filename?n.filename:"-",e);framework.isWindows&&(o=o.replace(/\//g,"\\"));var i=a(o,function(t,o,s){if(i.kill(),i=null,n.clear(),r){if(t)return void r(t,!1);var a=l[n.outputType];if(!a)return r(null,!0);var u=c.createReadStream(e),f=c.createWriteStream(e+"_");u.pipe(a()).pipe(f),f.on("finish",function(){c.rename(e+"_",e,function(){return r(null,!0)})})}});return n.currentStream&&(n.currentStream instanceof Buffer?i.stdin.end(n.currentStream):n.currentStream.pipe(i.stdin)),CLEANUP(i.stdin),t&&t(i.stdin),n},n.prototype.$$save=function(e,r){var t=this;return function(n){t.save(e,n,r)}},n.prototype.pipe=function(e,r,t){var n=this;if("object"===("undefined"==typeof r?"undefined":_typeof(r))&&(t=r,r=null),n.builder.length){r||(r=n.outputType);var o=u(n.isIM?"convert":"gm",n.arg(n.filename?n.filename:"-",(r?r+":":"")+"-"));o.stderr.on("data",e.emit.bind(e,"error")),o.stdout.on("data",e.emit.bind(e,"data")),o.stdout.on("end",e.emit.bind(e,"end")),o.on("error",e.emit.bind(e,"error"));var i=l[r];return i?o.stdout.pipe(i()).pipe(e,t):o.stdout.pipe(e,t),n.currentStream&&(n.currentStream instanceof Buffer?o.stdin.end(n.currentStream):n.currentStream.pipe(o.stdin)),n}},n.prototype.stream=function(e,r){var t=this;if(t.builder.length){e||(e=t.outputType);var n=u(t.isIM?"convert":"gm",t.arg(t.filename?t.filename:"-",(e?e+":":"")+"-"));t.currentStream&&(t.currentStream instanceof Buffer?n.stdin.end(t.currentStream):t.currentStream.pipe(n.stdin)),r&&r(n.stdin);var o=l[e];return o?n.stdout.pipe(o()):n.stdout}},n.prototype.cmd=function(e,r){var t=this,n="";t.builder.sort(function(e,r){return e.priority>r.priority?1:-1});for(var o=t.builder.length,i=0;o>i;i++)n+=(n?" ":"")+t.builder[i].cmd;return(t.isIM?"convert":"gm -convert")+' "'+e+'" '+n+' "'+r+'"'},n.prototype.arg=function(e,r){var t=this,n=[];t.isIM||n.push("-convert"),e&&n.push(e),t.builder.sort(function(e,r){return e.priority>r.priority?1:-1});for(var o=t.builder.length,i=0;o>i;i++){var s=t.builder[i],a=s.cmd.indexOf(" ");-1===a?n.push(s.cmd):(n.push(s.cmd.substring(0,a)),n.push(s.cmd.substring(a+1).replace(/\"/g,"")))}return r&&n.push(r),n},n.prototype.identify=function(e){var r=this;return a((r.isIM?"identify":"gm identify")+' "'+r.fileName+'"',function(r,t,n){if(r)return void e(r,null);var o=t.split(" "),i=o[2].split("x"),s={type:o[1],width:framework_utils.parseInt(i[0]),height:framework_utils.parseInt(i[1])};e(null,s)}),r},n.prototype.$$identify=function(){var e=this;return function(r){e.identify(r)}},n.prototype.push=function(e,r,t){var n=this;return n.builder.push({cmd:e+(r?' "'+r+'"':""),priority:t}),n},n.prototype.output=function(e){var r=this;return"."===e[0]&&(e=e.substring(1)),r.outputType=e,r},n.prototype.resize=function(e,r,t){t=t||"";var n=this,o="";return e&&r?o=e+"x"+r:e&&!r?o=e+"x":!e&&r&&(o="x"+r),n.push("-resize",o+t,1)},n.prototype.thumbnail=function(e,r,t){t=t||"";var n=this,o="";return e&&r?o=e+"x"+r:e&&!r?o=e:!e&&r&&(o="x"+r),n.push("-thumbnail",o+t,1)},n.prototype.geometry=function(e,r,t){t=t||"";var n=this,o="";return e&&r?o=e+"x"+r:e&&!r?o=e:!e&&r&&(o="x"+r),n.push("-geometry",o+t,1)},n.prototype.filter=function(e){return this.push("-filter",e,1)},n.prototype.trim=function(){return this.push("-trim +repage",1)},n.prototype.extent=function(e,r){var t=this,n="";return e&&r?n=e+"x"+r:e&&!r?n=e:!e&&r&&(n="x"+r),t.push("-extent",n,4)},n.prototype.miniature=function(e,r,t,n){return this.filter(n||"Box").thumbnail(e,r).background(t?t:"white").align("center").extent(e,r)},n.prototype.resizeCenter=function(e,r,t){return this.resize(e,r,"^").background(t?t:"white").align("center").crop(e,r)},n.prototype.resizeAlign=function(e,r,t,n){return this.resize(e,r,"^").background(n?n:"white").align(t||"center").crop(e,r)},n.prototype.scale=function(e,r,t){t=t||"";var n=this,o="";return e&&r?o=e+"x"+r:e&&!r?o=e:!e&&r&&(o="x"+r),n.push("-scale",o+t,1)},n.prototype.crop=function(e,r,t,n){return this.push("-crop",e+"x"+r+"+"+(t||0)+"+"+(n||0),4)},n.prototype.quality=function(e){return this.push("-quality",e||80,5)},n.prototype.align=function(e){var r="";switch(e.toLowerCase().replace("-","")){case"left top":case"top left":r="NorthWest";break;case"left bottom":case"bottom left":r="SouthWest";break;case"right top":case"top right":r="NorthEast";break;case"right bottom":case"bottom right":r="SouthEast";break;case"left center":case"center left":case"left":r="West";break;case"right center":case"center right":case"right":r="East";break;case"bottom center":case"center bottom":case"bottom":r="South";break;case"top center":case"center top":case"top":r="North";break;case"center center":case"center":case"middle":r="Center";break;default:r=e}return this.push("-gravity",r,3)},n.prototype.gravity=function(e){return this.align(e)},n.prototype.blur=function(e){return this.push("-blur",e,10)},n.prototype.normalize=function(){return this.push("-normalize",null,10)},n.prototype.rotate=function(e){return this.push("-rotate",e||0,8)},n.prototype.flip=function(){return this.push("-flip",null,10)},n.prototype.flop=function(){return this.push("-flop",null,10)},n.prototype.minify=function(){return this.push("+profile","*")},n.prototype.grayscale=function(){return this.push("-colorspace","Gray",10)},n.prototype.bitdepth=function(e){return this.push("-depth",e,10)},n.prototype.colors=function(e){return this.push("-colors",e,10)},n.prototype.background=function(e){return this.push("-background",e,2)},n.prototype.fill=function(e){return this.push("-fill",e,2)},n.prototype.sepia=function(e){return this.push("-modulate","115,0,100",4).push("-colorize","7,21,50",5)},n.prototype.make=function(e){return e.call(this,this),this},n.prototype.command=function(e,r,t){return this.push(e,r,t||10)},o.Image=n,o.Picture=n,o.init=function(e,r,t,o){return new n(e,r,t,o)},o.load=function(e,r,t,o){return new n(e,r,t,o)},o.middleware=function(e,r){"."===e[0]&&(e=e.substring(1)),l[e]=r},o.restart=function(){l={}},e}({exports:{}}),function(e){function r(){this.debug=!1,this.Message=t,this.Mail=t,this.connections={}}function t(e,r){this.subject=e||"",this.body=r||"",this.files,this.addressTo=[],this.addressReply,this.addressCC,this.addressBCC,this.addressFrom={name:"",address:""},this.closed=!1,this.tls=!1,this.$callback}function n(e){for(var r=0,t="",n=e.length;n>r;){var o=r+68;o>n&&(o=n),t+=e.substring(r,o)+l,r=o}return t}function o(e){return e?"=?utf-8?B?"+new Buffer(e.toString()).toString("base64")+"?=":""}var i=e.exports;global.framework_mail=e.exports;var s=require("net"),a=require("tls"),u=require("events"),c=require("fs"),l="\r\n",f=/\besmtp\b/i,p=/\d+/,d=[],m={notvalid:"E-mail address is not valid",resolve:"Cannot resolve MX of ",connection:"Cannot connect to any SMTP server."};global.framework_utils||(global.framework_utils=require("./utils")),r.prototype.__proto__=Object.create(u.EventEmitter.prototype,{constructor:{value:r,enumberable:!1}}),r.prototype.create=function(e,r){return new t(e,r)},t.prototype.callback=function(e){return this.$callback=e,this},t.prototype.sender=function(e,r){return this.from(e,r)},t.prototype.from=function(e,r){if(">"===e[e.length-1]){var t=e.indexOf("<");r=e.substring(0,t-1),e=e.substring(t+1,e.length-1)}if(!e.isEmail())throw new Error(m.notvalid);var n=this;return n.addressFrom.name=r||"",n.addressFrom.address=e,n},t.prototype.to=function(e,r,t){if("boolean"==typeof r&&(t=r,r=void 0),">"===e[e.length-1]){var n=e.indexOf("<");r=e.substring(0,n-1),e=e.substring(n+1,e.length-1)}if(!e.isEmail())throw new Error(m.notvalid);var o=this;return t&&(o.addressTo=[]),r?(o.addressTo.push({email:e,name:r}),o):(o.addressTo.push(e),o)},t.prototype.cc=function(e,r,t){if("boolean"==typeof r&&(t=r,r=void 0),">"===e[e.length-1]){var n=e.indexOf("<");r=e.substring(0,n-1),e=e.substring(n+1,e.length-1)}if(!e.isEmail())throw new Error(m.notvalid);var o=this;return!t&&o.addressCC||(o.addressCC=[]),r?(o.addressCC.push({email:e,name:r}),o):(o.addressCC.push(e),o)},t.prototype.bcc=function(e,r){if(!e.isEmail())throw new Error(m.notvalid);var t=this;return!r&&t.addressBCC||(t.addressBCC=[]),t.addressBCC.push(e),t},t.prototype.reply=function(e,r){if(!e.isEmail())throw new Error(m.notvalid);var t=this;return!r&&t.addressReply||(t.addressReply=[]),t.addressReply.push(e),t},t.prototype.attachment=function(e,r){var t=this;r||(r=framework_utils.getName(e));var n=framework_utils.getExtension(r);return t.files||(t.files=[]),t.files.push({name:r,filename:e,contentType:framework_utils.getContentType(n),extension:n}),t},t.prototype.manually=function(){var e=this;return e.$sending?(clearTimeout(e.$sending),e):e},t.prototype.attachmentInline=function(e,r,t){var n=this;void 0===r&&(r=framework_utils.getName(e)),n.files||(n.files=[]);var o=framework_utils.getExtension(r);return n.files.push({name:r,filename:e,contentType:framework_utils.getContentType(o),disposition:"inline",contentId:t,extension:o}),n},t.prototype.send=function(e,r,t){return h.send(e,r,this,t),this},r.prototype.switchToTLS=function(e,r){var t=this;e.tls=!0,e.socket.removeAllListeners();var n=framework_utils.copy(r.tls,{socket:e.socket,host:e.socket.$host,ciphers:"SSLv3"});e.socket2=a.connect(n,function(){return t._send(e,r,!0)}),e.socket2.on("error",function(r){if(h.destroy(e),t.closed=!0,t.callback&&(t.callback(r),t.callback=null),!e["try"]&&-1===r.stack.indexOf("ECONNRESET"))try{h.emit("error",r,e)}catch(n){F.error(r,"FrameworkMail")}}),e.socket2.on("clientError",function(r){if(h.destroy(e),t.callback&&(t.callback(r),t.callback=null),!e["try"])try{h.emit("error",r,e)}catch(n){F.error(r,"FrameworkMail")}}),e.socket2.on("connect",function(){r.secure||t._send(e,r)})},r.prototype.destroy=function(e){return e.destroyed?this:(e.destroyed=!0,e.closed=!0,e.socket&&(e.socket.removeAllListeners(),e.socket.end(),e.socket.destroy(),e.socket=null),e.socket2&&(e.socket2.removeAllListeners(),e.socket2.end(),e.socket2.destroy(),e.socket2=null),delete this.connections[e.id],this)},r.prototype._writeattachment=function(e){var r=e.files?e.files.shift():!1;if(!r)return h._writeline(e,"--"+e.boundary+"--","","."),this;var t=r.name,n=c.createReadStream(r.filename,{encoding:"base64"}),o=[],i=r.extension,s="ics"===i;return o.push("--"+e.boundary),s||(r.contentId?(o.push('Content-Disposition: inline; filename="'+t+'"'),o.push("Content-ID: <"+r.contentId+">")):o.push('Content-Disposition: attachment; filename="'+t+'"')),o.push("Content-Type: "+i+";"+(s?' charset="utf-8"; method=REQUEST':"")),o.push("Content-Transfer-Encoding: base64"),o.push(l),h._writeline(e,o.join(l)),n.on("data",function(r){for(var t=r.length,n=0,o=0;t>n;)n+=68,n>t&&(n=t),h._writeline(e,r.slice(o,n).toString("base64")),o=n}),CLEANUP(n,function(){h._writeline(e,l),h._writeattachment(e)}),this},r.prototype["try"]=function(e,r,t){return this.send(e,r,void 0,t)},r.prototype.send2=function(e,r){var t=framework.temporary["mail-settings"];if(!t){var n=framework.config["mail.smtp.options"];n&&n.isJSON()&&(t=JSON.parse(n)),t||(t={}),framework.temporary["mail-settings"]=t}return this.send(framework.config["mail.smtp"],t,e,r)},r.prototype.send=function(e,r,t,n){r instanceof Array?(n=t,t=r,r={}):"function"==typeof r&&(n=r,r={});var o=this,i=framework_utils.GUID(10);o.connections[i]={};var u=o.connections[i];if(u.id=i,u["try"]=void 0===t,u.messages=u["try"]?d:t instanceof Array?t:[t],u.callback=n,u.closed=!1,u.message=null,u.files=null,u.count=0,u.socket,u.tls=!1,u.date=new Date,e=e||null,r&&r.secure&&!r.port&&(r.port=465),r=framework_utils.copy(r,{secure:!1,port:25,user:"",password:"",timeout:1e4,tls:null}),r.secure){var c=framework_utils.copy(r);c.host=e,u.socket=a.connect(c,function(){return h._send(u,r)})}else u.socket=s.createConnection(r.port,e);return u.socket.$host=e,u.host=e.substring(e.lastIndexOf(".",e.lastIndexOf(".")-1)+1),u.socket.on("error",function(e){if(h.destroy(u),u.callback&&(u.callback(e),u.callback=null),!u["try"]&&-1===e.stack.indexOf("ECONNRESET"))try{h.emit("error",e,u)}catch(r){F.error(e,"FrameworkMail")}}),u.socket.on("clientError",function(e){if(h.destroy(u),u.callback&&(u.callback(e),u.callback=null),!u["try"])try{h.emit("error",e,u)}catch(r){F.error(e,"FrameworkMail")}}),u.socket.on("connect",function(){r.secure||h._send(u,r)}),o},r.prototype._writemessage=function(e,r){var t=this,i=e.messages.shift(),s=[];e.boundary="--totaljs"+e.date.getTime()+e.count,e.files=i.files,e.count++,r.push("MAIL FROM: <"+i.addressFrom.address+">"),s.push("Message-ID: <"+framework_utils.GUID()+"@WIN-"+framework_utils.GUID(4)+">"),s.push("MIME-Version: 1.0"),s.push("From: "+(i.addressFrom.name?o(i.addressFrom.name)+" <"+i.addressFrom.address+">":i.addressFrom.address));var a;if(i.headers)for(var u=Object.keys(i.headers),c=0,a=u.length;a>c;c++)s.push(u[c]+": "+i.headers[u[c]]);a=i.addressTo.length;var f,p,d="";if(a){for(var c=0;a>c;c++)p=i.addressTo[c],f=p instanceof Object?"<"+p.email+">":"<"+p+">",r.push("RCPT TO: "+f),d+=(d?", ":"")+(p instanceof Object?o(p.name)+" ":"")+f;s.push("To: "+d),d=""}if(i.addressCC){a=i.addressCC.length;for(var c=0;a>c;c++)p=i.addressCC[c],f=p instanceof Object?"<"+p.email+">":"<"+p+">",r.push("RCPT TO: "+f),d+=(d?", ":"")+(p instanceof Object?o(p.name)+" ":"")+f;s.push("Cc: "+d),d=""}if(i.addressBCC){a=i.addressBCC.length;for(var c=0;a>c;c++)r.push("RCPT TO: <"+i.addressBCC[c]+">")}if(r.push("DATA"),r.push(""),s.push("Date: "+e.date.toUTCString()),s.push("Subject: "+o(i.subject)),i.addressReply){a=i.addressReply.length;for(var c=0;a>c;c++)d+=(""!==d?", ":"")+"<"+i.addressReply[c]+">";s.push("Reply-To: "+d),d=""}return s.push("Content-Type: multipart/mixed; boundary="+e.boundary),s.push(""),s.push("--"+e.boundary),s.push("Content-Type: "+(-1!==i.body.indexOf("<")&&-1!==i.body.lastIndexOf(">")?"text/html":"text/plain")+"; charset=utf-8"),s.push("Content-Transfer-Encoding: base64"),s.push(""),s.push(n(new Buffer(i.body.replace(/\r\n/g,"\n").replace(/\n/g,l)).toString("base64"))),e.message=s.join(l),e.messagecallback=i.$callback,s=null,t},r.prototype._writeline=function(e){if(e.closed)return!1;for(var r=e.socket2?e.socket2:e.socket,t=1;t<arguments.length;t++){var n=arguments[t];n&&(h.debug&&console.log("SEND",n),r.write(n+l))}return!0},r.prototype._send=function(e,r,t){var n=this,o=[],i=new Date,s=("--totaljs"+i.getTime(),!1),a=!1,u="",c="",d=[],m="",g=e.socket2?e.socket2:e.socket,v=e.host,y=!r.tls||e.tls&&r.tls;y&&h.emit("send",e),g.setEncoding("utf8"),g.setTimeout(r.timeout||8e3,function(){var r=new Error(framework_utils.httpStatus(408));if(h.destroy(e),e.callback&&(e.callback(r),e.callback=null),!e["try"])try{h.emit("error",r,e)}catch(t){F.error(r,"FrameworkMail")}}),g.on("end",function(){h.destroy(e),e.callback&&(e.callback(),e.callback=null)}),g.on("data",function(r){if(!e.closed){if(r=r.toString("utf8"),!r.endsWith(l))return void(m+=r);var t=(m+r).split(l);m&&(m="");for(var n=0,o=t.length;o>n;n++){var i=t[n];i&&g&&g.emit("line",i)}}}),g.on("line",function(t){t=t.toUpperCase(),h.debug&&console.log("<---",t);var i=+t.match(p)[0];if(250!==i||a||(-1!==t.indexOf("AUTH LOGIN PLAIN")||-1!==t.indexOf("AUTH PLAIN LOGIN")||r.user&&r.password)&&(u="plain",a=!0,-1===t.indexOf("XOAUTH")?(d.push("AUTH LOGIN"),d.push(new Buffer(r.user).toString("base64")),d.push(new Buffer(r.password).toString("base64"))):d.push("AUTH PLAIN "+new Buffer("\x00"+r.user+"\x00"+r.password).toString("base64"))),"-"!==t.substring(3,4))switch(!s&&a&&(s=!0,i=334),i){case 220:if(e.isTLS)return void h.switchToTLS(e,r);c=e.isTLS||r.user&&r.password||f.test(t)?"EHLO":"HELO",h._writeline(e,c+" "+v);break;case 250:case 251:case 235:case 999:if(e.messagecallback&&(e.messagecallback(),e.messagecallback=null),h._writeline(e,o.shift()),o.length)return;return e.messages.length?(h._writemessage(e,o),void h._writeline(e,o.shift())):void h._writeline(e,"QUIT");case 221:return h.destroy(e),void(e.callback&&(e.callback(null,e["try"]?!0:e.count),e.callback=null));case 334:if(!n.tls&&!e.isTLS&&r.tls)return e.isTLS=!0,void h._writeline(e,"STARTTLS");var l=d.shift();if(!l){var m=new Error("Forbidden.");if(h.destroy(e),e.callback&&(e.callback(m),e.callback=null),e["try"])return;try{h.emit("error",m,e)}catch(y){F.error(m,"FrameworkMail")}return}return void h._writeline(e,l);case 354:return h._writeline(e,e.message),h._writeattachment(e),void(e.message=null);default:if(400>i)return;var m=new Error(t);if(!e["try"])try{h.emit("error",m,e)}catch(y){F.error(m,"FrameworkMail")}return e.messagecallback&&(e.messagecallback(m),e.messagecallback=null),e.message?(o=[],e.count--,void g.emit("line","999 TRY NEXT MESSAGE")):(h.destroy(e),void(e.callback&&(e.callback(m),e.callback=null)))}}),t&&n._writeline(e,"EHLO "+v)},i.restart=function(){h.removeAllListeners(),h.debug=!1};var h=new r;return e.exports=h,e}({exports:{}}),function(module){function parse_multipart_header(e){var r=new Array(2),t=' name="',n=t.length,o=e.indexOf(t),i="";return-1!==o&&(i=e.substring(o+n,e.indexOf('"',o+n))),i?r[0]=i:r[0]="undefined_"+Math.floor(1e5*Math.random()).toString(),t=' filename="',n=t.length,o=e.indexOf(t),i="",-1!==o&&(i=e.substring(o+n,e.indexOf('"',o+n))),-1!==o&&(i=e.substring(o+n,e.indexOf('"',o+n))),i?r[1]=i:r[1]=null,r}function HttpFile(){this.name,this.filename,this.type,this.path,this.length=0,this.width=0,this.height=0}function compile_autovendor(e){var r=/\n|\s{2,}/g,t=/\s?\{\s{1,}/g,n=/\s?\}\s{1,}/g,o=/\s?\:\s{1,}/g,i=/\s?\;\s{1,}/g,s=/\,\s{1,}/g,a="@#auto-vendor-prefix#@",u=e.startsWith(a);return u?e=e.replace(a,""):(a="/*auto*/",u=-1!==e.indexOf(a),u&&(e=e.replace(a,""))),u&&(e=autoprefixer(e)),e.replace(r,"").replace(t,"{").replace(n,"}").replace(o,":").replace(i,";").replace(s,function(e,r,t){for(var n=r;n>0;n--)if(("'"===t[n]||'"'===t[n])&&":"===t[n-1])return e;return","}).replace(/\s\}/g,"}").replace(/\s\{/g,"{").trim()}function autoprefixer(e){var r=["filter","appearance","column-count","column-gap","column-rule","display","transform","transform-style","transform-origin","transition","user-select","animation","perspective","animation-name","animation-duration","animation-timing-function","animation-delay","animation-iteration-count","animation-direction","animation-play-state","opacity","background","background-image","font-smoothing","text-size-adjust","backface-visibility","box-sizing","overflow-scrolling"];e=autoprefixer_keyframes(e);for(var t,n=[],o=0,i=0;i<r.length;i++)for(t=r[i],o=0;-1!==o;)if(o=e.indexOf(t,o+1),-1!==o){var s=e.indexOf(";",o),a=e.indexOf("}",o),u=Math.min(s,a);if(-1===u&&(u=Math.max(s,a)),-1!==u){var c="-"===e.substring(o-1,o);if(!c){var l=e.substring(o,u);u=l.indexOf(":"),-1!==u&&l.substring(0,u+1).replace(/\s/g,"")===t+":"&&n.push({name:t,property:l})}}}for(var f=[],p=n.length,i=0;p>i;i++){var d=n[i].name;t=n[i].property;var m=t,h=";",g=m+h;if("opacity"!==d)if("background"!==d&&"background-image"!==d)if("text-overflow"!==d)if("display"!==d)g+="-webkit-"+m+h,g+="-moz-"+m,-1===d.indexOf("animation")&&(g+=h+"-ms-"+m),g+=h+"-o-"+m,e=e.replacer(t,"@[["+f.length+"]]"),f.push(g);else{if(-1===t.indexOf("box"))continue;g=m+h,g+=m.replacer("box","-webkit-box")+h,g+=m.replacer("box","-moz-box"),e=e.replacer(t,"@[["+f.length+"]]"),f.push(g)}else g=m+h,g+=m.replacer("text-overflow","-ms-text-overflow"),e=e.replacer(t,"@[["+f.length+"]]"),f.push(g);else{if(-1===t.indexOf("linear-gradient"))continue;g=m.replacer("linear-","-webkit-linear-")+h,g+=m.replacer("linear-","-moz-linear-")+h,g+=m.replacer("linear-","-o-linear-")+h,g+=m.replacer("linear-","-ms-linear-")+h,g+=m,e=e.replacer(t,"@[["+f.length+"]]"),f.push(g)}else{var v=+m.replace("opacity","").replace(":","").replace(/\s/g,"");if(isNaN(v))continue;g+="filter:alpha(opacity="+Math.floor(100*v)+")",e=e.replacer(t,"@[["+f.length+"]]"),f.push(g)}}p=f.length;for(var i=0;p>i;i++)e=e.replacer("@[["+i+"]]",f[i]);return f=null,n=null,r=null,e}function autoprefixer_keyframes(e){for(var r=[],t=0;-1!==t;)if(t=e.indexOf("@keyframes",t+1),-1!==t){for(var n=0,o=-1,i=t+10;i<e.length;i++)if("{"===e[i]&&n++,"}"===e[i]){if(!(n>1)){o=i;break}n--}if(-1!==o){var s=e.substring(t,o+1);r.push({name:"keyframes",property:s})}}for(var a=[],u=r.length,c=0;u>c;c++){var l=r[c].name,f=r[c].property;if("keyframes"===l){var p=f.substring(1),d="\n",m="@"+p+d;m+="@-webkit-"+p+d,m+="@-moz-"+p+d,m+="@-o-"+p+d,e=e.replacer(f,"@[["+a.length+"]]"),a.push(m)}}u=a.length;for(var c=0;u>c;c++)e=e.replace("@[["+c+"]]",a[c]);return r=null,a=null,e}function JavaScript(e){function r(){for(u=13,t(3);u!==f;)switch(u){case 32:t(a(l)?1:2);break;case 13:switch(l){case 123:case 91:case 40:case 43:case 45:t(1);break;case 32:t(3);break;default:t(a(l)?1:2)}break;default:switch(l){case 32:if(a(u)){t(1);break}t(3);break;case 13:switch(u){case 125:case 93:case 41:case 43:case 45:case 34:case 92:t(1);break;default:t(a(u)?1:3)}break;default:t(1)}}}function t(e){if(1>=e&&s(u),2>=e&&(u=l,39===u||34===u))for(;s(u),u=i(),u!==l;){if(13>=u)return void(framework&&framework.error("Error: JSMIN unterminated string literal: "+u,"JavaScript compressor"));92===u&&(s(u),u=i())}if(3>=e&&(l=n(),47===l&&(40===u||44===u||61===u||91===u||33===u||58===u||38===u||124===u||63===u||123===u||125===u||59===u||13===u))){for(s(u),s(l);u=i(),47!==u;){if(92===u)s(u),u=i();else if(13>=u)return void(c=f);s(u)}l=n()}}function n(){var e=i();if(47!==e)return e;switch(o()){case 47:for(;;)if(e=i(),13>=e)return e;break;case 42:for(i();;)switch(i()){case 42:if(47===o())return i(),32;break;case f:return void(e=f)}break;default:return e}return e}function o(){return d=i()}function i(){var r=d;return d=f,r===f&&(r=e.charCodeAt(m++),isNaN(r)&&(r=f)),r>=32||13===r||r===f?r:10===r?13:32}function s(e){13===e||10===e?p.push(" "):p.push(String.fromCharCode(e))}function a(e){return e>=97&&122>=e||e>=48&&57>=e||e>=65&&90>=e||95===e||36===e||92===e||e>126}var u,l,f=-1,p=[],d=f,m=0;return r(),p.join("")}function MultipartParser(){this.boundary=null,this.boundaryChars=null,this.lookbehind=null,this.state=S.PARSER_UNINITIALIZED,this.index=null,this.flags=0}function view_parse_localization(e,r){var t=!1;if(e=e.replace(/@\{notranslate\}/gi,function(e){return t=!0,""}).trim(),t)return e;var n=view_find_localization(e,0),o="",i=0;if(!n)return e;for(;n;)n&&(o+=e.substring(i?i+1:0,n.beg)+framework.translate(r,n.command)),i=n.end,n=view_find_localization(e,n.end);return o+=e.substring(i+1)}function view_parse(content,minify,filename,controller){function escaper(e){var r=e.match(/[^\>]\n\s{1,}$/);return nocompressHTML?isFirst||(isFirst=!0,e=e.replace(/^\s+/,"")):e=compressHTML(e,minify),e?(!nocompressHTML&&r&&(e+=" "),e.match(/\n|\r|\'|\\/)?DELIMITER_UNESCAPE+escape(e)+DELIMITER_UNESCAPE_END:DELIMITER+e+DELIMITER):"$EMPTY"}minify&&(content=removeComments(content));var nocompressHTML=!1,nocompressJS=!1,nocompressCSS=!1;content=content.replace(/@\{nocompress\s\w+}/gi,function(e){var r=e.lastIndexOf(" ");if(-1===r)return"";switch(e.substring(r,e.length-1).trim()){case"all":nocompressHTML=!0,nocompressJS=!0,nocompressCSS=!0;break;case"html":nocompressHTML=!0;break;case"js":case"script":case"javascript":nocompressJS=!0;break;case"css":case"style":nocompressCSS=!0}return""}).trim(),nocompressJS||(content=compressJS(content,0,filename)),nocompressCSS||(content=compressCSS(content,0,filename)),content=framework._version_prepare(content);var DELIMITER="'",DELIMITER_UNESCAPE="unescape('",DELIMITER_UNESCAPE_END="')",SPACE=" ",builder="var $EMPTY='';var $length=0;var $source=null;var $tmp=index;var $output=$EMPTY",command=view_find_command(content,0),compressed="",nocompress=!1,isFirst=!1,pharse="";command||(builder+="+"+escaper(content));for(var old=null,newCommand="",tmp="",index=0,counter=0,functions=[],functionsName=[],isFN=!1,isSECTION=!1,isCOMPILATION=!1,builderTMP="",sectionName="",compileName="",text;command;){old?(text=content.substring(old.end+1,command.beg),
text&&(view_parse_plus(builder)&&(builder+="+"),builder+=escaper(text))):(text=content.substring(0,command.beg),text&&(view_parse_plus(builder)&&(builder+="+"),builder+=escaper(text)));var cmd=content.substring(command.beg+2,command.end).trim(),cmd8=cmd.substring(0,8),cmd7=cmd.substring(0,7);if(cmd=cmd.replace(/helpers\.[a-z0-9A-Z_$]+\(.*?\)+/g,function(e){var r=e.indexOf("(");return-1===r?e:e.substring(0,r)+".call(self"+(e.endsWith("()")?")":","+e.substring(r+1))}),pharse=cmd,"'"===cmd[0]||'"'===cmd[0])builder+="+"+DELIMITER+new Function("self","return self.$import("+cmd[0]+"!"+cmd.substring(1)+")")(controller)+DELIMITER;else if("compile"===cmd7&&-1===cmd.lastIndexOf(")"))builderTMP=builder+"+(framework.onCompileView.call(self,'"+(" "===cmd8[7]?cmd.substring(8):"")+"',",builder="",sectionName=cmd.substring(8),isCOMPILATION=!0,isFN=!0;else if("section "===cmd8&&-1===cmd.lastIndexOf(")"))builderTMP=builder,builder="+(function(){var $output=$EMPTY",sectionName=cmd.substring(8),isSECTION=!0,isFN=!0;else if("helper "===cmd7)builderTMP=builder,builder="function "+cmd.substring(7).trim()+"{var $output=$EMPTY",isFN=!0,functionsName.push(cmd.substring(7,cmd.indexOf("(",7)).trim());else if("foreach "===cmd8)counter++,-1!==cmd.indexOf("foreach var ")&&(cmd=cmd.replace(" var ",SPACE)),cmd=view_prepare_keywords(cmd),newCommand=(cmd.substring(8,cmd.indexOf(SPACE,8))||"").trim(),index=cmd.trim().indexOf(SPACE,newCommand.length+10),-1===index&&(index=cmd.indexOf("[",newCommand.length+10)),builder+="+(function(){var $source="+cmd.substring(index).trim()+";if (!($source instanceof Array) || !$source.length)return $EMPTY;var $length=$source.length;var $output=$EMPTY;var index=0;for(var i=0;i<$length;i++){index = i;var "+newCommand+"=$source[i];$output+=$EMPTY";else if("end"===cmd)isFN&&0>=counter?(counter=0,isCOMPILATION?(builder=builderTMP+"unescape($EMPTY"+builder+"),model) || $EMPTY)",builderTMP=""):isSECTION?(builder=builderTMP+builder+";repository['$section_"+sectionName+"']=repository['$section_"+sectionName+"']?repository['$section_"+sectionName+"']+$output:$output;return $EMPTY})()",builderTMP=""):(builder+=";return $output;}",functions.push(builder),builder=builderTMP,builderTMP=""),isSECTION=!1,isCOMPILATION=!1,isFN=!1):(counter--,builder+="}return $output;})()",newCommand="");else if("if "===cmd.substring(0,3))builder+=";if ("+view_prepare_keywords(cmd).substring(3)+"){$output+=$EMPTY";else if("else if"===cmd7)builder+="} else if ("+view_prepare_keywords(cmd).substring(7)+") {$output+=$EMPTY";else if("else"===cmd)builder+="} else {$output+=$EMPTY";else if("endif"===cmd||"fi"===cmd)builder+="}$output+=$EMPTY";else{tmp=view_prepare(command.command,newCommand,functionsName,function(){return nocompress=!0});var can=!1;if(RELEASE)for(var a=0,al=RENDERNOW.length;al>a;a++)if(tmp.startsWith(RENDERNOW[a])){if(-1!==tmp.indexOf("+"))continue;if(!tmp.match(REG_SKIP_1)||tmp.match(REG_SKIP_2))continue;if(!a){var isMeta=-1!==tmp.indexOf("'meta'"),isHead=-1!==tmp.indexOf("'head'");if(tmp=tmp.replace(/\'(meta|head)\'\,/g,"").replace(/(\,\,|\,\)|\s{1,})/g,""),isMeta||isHead){var tmpimp="";isMeta&&(tmpimp+=isMeta?"'meta'":""),isHead&&(tmpimp+=(tmpimp?",":"")+(isHead?"'head'":"")),builder+="+self.$import("+tmpimp+")"}}can=!0;break}if(can){var fn=new Function("self","return "+tmp);builder+="+"+DELIMITER+fn(controller).replace(/\\/g,"\\\\")+DELIMITER}else tmp&&(view_parse_plus(builder)&&(builder+="+"),builder+=wrapTryCatch(tmp,command.command,command.line))}old=command,command=view_find_command(content,command.end)}old&&(text=content.substring(old.end+1),text&&(builder+="+"+escaper(text))),RELEASE&&(builder=builder.replace(/(\+\$EMPTY\+)/g,"+").replace(/(\$output\=\$EMPTY\+)/g,"$output=").replace(/(\$output\+\=\$EMPTY\+)/g,"$output+=").replace(/(\}\$output\+\=\$EMPTY)/g,"}").replace(/(\{\$output\+\=\$EMPTY\;)/g,"{").replace(/(\+\$EMPTY\+)/g,"+").replace(/(\>\'\+\'\<)/g,"><").replace(/\'\+\'/g,""));var fn="(function(self,repository,model,session,query,body,url,global,helpers,user,config,functions,index,output,date,cookie,files,mobile){var get=query;var post=body;var theme=this.themeName;var language=this.language;var cookie=function(name){return controller.req.cookie(name);};"+(functions.length?functions.join("")+";":"")+"var controller=self;"+builder+";return $output;})";return eval(fn)}function view_prepare_keywords(e){return e.replace(/\s+(sitemap_navigation\(|sitemap\()+/g,function(e){return" self."+e.trim()})}function wrapTryCatch(e,r,t){return framework.isDebug?"(function(){try{return "+e+"}catch(e){throw new Error(unescape('"+escape(r)+"') + ' - Line: "+t+" - ' + e.message.toString());}return $EMPTY})()":e}function view_parse_plus(e){var r=e[e.length-1];return"!"!==r&&"?"!==r&&"+"!==r&&"."!==r&&":"!==r}function view_prepare(e,r,t){var n=e.indexOf("."),o=e.indexOf("("),i=e.indexOf("["),s=[],a=0;-1!==n&&s.push(n),-1!==o&&s.push(o),-1!==i&&s.push(i);var u=Math.min.apply(this,s);-1===u&&(u=e.length);var c=e.substring(0,u);if(c===r)return"$STRING("+e+").encode()";if("!"===c[0]&&c.substring(1)===r)return"$STRING("+e.substring(1)+")";switch(c){case"foreach":case"end":return"";case"section":return a=e.indexOf("("),-1===a?"":"(repository['$section_"+e.substring(a+1,e.length-1).replace(/\'|\"/g,"")+"'] || '')";case"log":case"LOG":return"("+("log"===c?"framework.":"")+e+"?$EMPTY:$EMPTY)";case"logger":case"LOGGER":return"("+("logger"===c?"framework.":"")+e+"?$EMPTY:$EMPTY)";case"console":return"("+e+"?$EMPTY:$EMPTY)";case"cookie":return"$STRING("+e+").encode()";case"!cookie":return"$STRING("+e+")";case"isomorphic":return"$STRING("+e+").encode()";case"!isomorphic":return"$STRING("+e+")";case"model":case"repository":case"get":case"post":case"query":case"global":case"session":case"user":case"config":case"controller":return view_is_assign(e)?"self.$set("+e+")":"$STRING("+e+").encode()";case"body":return view_is_assign(e)?"self.$set("+e+")":-1===e.lastIndexOf(".")?"output":"$STRING("+e+").encode()";case"files":return e;case"mobile":return e;case"CONFIG":case"function":case"MODEL":case"SCHEMA":case"MODULE":case"functions":return"$STRING("+e+").encode()";case"!controller":case"!repository":case"!get":case"!post":case"!body":case"!query":case"!global":case"!session":case"!user":case"!config":case"!functions":case"!model":case"!CONFIG":case"!SCHEMA":case"!function":case"!MODEL":case"!MODULE":return"$STRING("+e.substring(1)+")";case"language":return e;case"resource":return"$STRING(self."+e+").encode()";case"RESOURCE":return"$STRING(self."+e.toLowerCase()+").encode()";case"!resource":case"!RESOURCE":return"$STRING(self."+e.substring(1)+")";case"host":case"hostname":return-1===e.indexOf("(")?"self.host()":"self."+e;case"href":return-1===e.indexOf("(")?"self.href()":"self."+e;case"url":return-1!==e.indexOf("(")?"self.$"+e:"self."+e;case"title":case"description":case"keywords":return-1!==e.indexOf("(")?"self.$"+e:"(repository['$"+e+"'] || '').toString().encode()";case"!title":case"!description":case"!keywords":return"(repository['$"+e.substring(1)+"'] || '')";case"head":return-1!==e.indexOf("(")?"self.$"+e:"self."+e+"()";case"sitemap_url":case"sitemap_name":case"sitemap_navigation":return"self."+e;case"sitemap":case"place":return-1!==e.indexOf("(")?"self.$"+e:"(repository['$"+e+"'] || '')";case"meta":return-1!==e.indexOf("(")?"self.$"+e:"self.$meta()";case"js":case"script":case"css":case"favicon":case"import":return"self.$"+e+(-1===e.indexOf("(")?"()":"");case"index":return"("+e+")";case"routeJS":case"routeCSS":case"routeScript":case"routeStyle":case"routeImage":case"routeFont":case"routeDownload":case"routeVideo":case"routeStatic":return"self."+e;case"TRANSLATE":return e;case"translate":return"self."+e;case"json":case"image":case"layout":case"template":case"templateToggle":case"view":case"viewToggle":case"helper":case"download":case"selected":case"disabled":case"checked":case"etag":case"header":case"modified":case"options":case"readonly":case"canonical":case"dns":case"next":case"prefetch":case"prerender":case"prev":case"sitemap_change":return"self.$"+e;case"now":return"(new Date()"+e.substring(3)+")";case"radio":case"text":case"checkbox":case"hidden":case"textarea":case"password":return"self.$"+exports.appendModel(e);case"helpers":return e;default:return framework.helpers[c]?"helpers."+view_insert_call(e):"$STRING("+(-1===t.indexOf(c)?"!"===e[0]?e.substring(1)+")":e+").encode()":e+")")}return e}function view_insert_call(e){var r=e.indexOf("(");if(-1===r)return e;for(var t=e.length,n=0,o=r+1;t>o;o++){var i=e[o];if("("===i||")"===i)if("("!==i){if(!(n>0)){var s=e.substring(r+1);return e.substring(0,r)+".call(self"+(s.length>1?","+s:")")}n--}else n++}return e}function view_is_assign(e){for(var r=e.length,t=0,n=0;r>n;n++){var o=e[n];if("["!==o)if("]"!==o){var i=e[n+1]||"";if("+"===o&&("+"===i||"="===i)&&!t)return!0;if("-"===o&&("-"===i||"="===i)&&!t)return!0;if("*"===o&&("*"===i||"="===i)&&!t)return!0;if("="===o&&!t)return!0}else t--;else t++}return!1}function view_find_command(e,r){if(r=e.indexOf("@{",r),-1===r)return null;for(var t=e.length,n=0,o=r+2;t>o;o++){var i=e[o];if("{"!==i){if("}"===i){if(!(n>0))return{beg:r,end:o,line:view_line_counter(e.substr(0,r)),command:e.substring(r+2,o).trim()};n--}}else n++}return null}function view_line_counter(e){var r=e.match(/\n/g);return r?r.length:0}function view_find_localization(e,r){if(r=e.indexOf("@(",r),-1===r)return null;for(var t=e.length,n=0,o=r+2;t>o;o++){var i=e[o];if("("!==i){if(")"===i){if(!(n>0))return{beg:r,end:o,command:e.substring(r+2,o).trim()};n--}}else n++}return null}function removeCondition(e,r){if(r){if("+"===e[0])return e.substring(1,e.length)}else if("+"===e[e.length-1])return e.substring(0,e.length-1);return e}function removeComments(e){for(var r="<!--",t="-->",n=e.indexOf(r),o=0;-1!==n&&(o=e.indexOf(t,n+4),-1!==o);){var i=e.substring(n,o+3);-1===i.indexOf("[if")&&-1===i.indexOf("[endif")?(e=e.replacer(i,""),n=e.indexOf(r,o+3)):n=e.indexOf(r,o+3)}return e}function compressJS(e,r,t){if(!framework.config["allow-compile-script"])return e;var n='<script type="text/javascript">',o="</script>",i=e.indexOf(n,r||0);if(-1===i&&(n="<script>",i=e.indexOf(n,r||0),-1===i))return e;var s=e.indexOf(o,i+n.length);if(-1===s)return e;var a=e.substring(i,s+o.length).trim(),u=e.indexOf(a);if(-1===u)return e;var c=a.substring(n.length,a.length-o.length).trim(),l=exports.compile_javascript(c,t);return e=e.replacer(a,n+l.trim()+o.trim()),compressJS(e,i+l.length+9,t)}function compressCSS(e,r,t){var n='<style type="text/css">',o="</style>",i=e.indexOf(n,r||0);if(-1===i&&(n="<style>",i=e.indexOf(n,r||0),-1===i))return e;var s=e.indexOf(o,i+n.length);if(-1===s)return e;var a=e.substring(i,s+o.length),u=a.substring(n.length,a.length-o.length).trim(),c=exports.compile_css(u,t);return e=e.replacer(a,(n+c.trim()+o).trim()),compressCSS(e,i+c.length+8,t)}function variablesCSS(e){if(!e)return e;var r={};return e=e.replace(/\$[a-z0-9-_]+\:.*?;/gi,function(e){var t=e.indexOf(":");if(-1===t)return e;var n=e.substring(0,t).trim();return r[n]=e.substring(t+1,e.length-1).trim(),""}),e=e.replace(/\$[a-z0-9-_]+/gi,function(e,t){var n=(e.length+t,r[e]);return n?n:e}).trim()}function nested(e,r,t){if(!e)return e;for(var n,o,i=0,s="",a=!1,u=0,c=!1,l="",f=!1,p="",d=!1,m="";;){var h=e[i++];if(!h)break;if("/"!==h||"*"!==e[i]){if(d)m+=h,"*"===h&&"/"===e[i]&&(d=!1,i++,"auto*"===m&&(s+="/*auto*/"));else if("\n"!==h&&"\r"!==h)if("$"===h&&t&&t(),"@"===h&&(o=i,f=!0),!f||p||";"!==h&&"{"!==h||(p=h,";"!==h))if(l+=h,"{"!==h){if("}"===h){if(u>0){u--,c=!0;continue}if(!c){s+=l,l="",a=!1,f=!1,p="";continue}if(f){-1!==l.indexOf("@keyframes")?s+=l:(o=l.indexOf("{"),s+=l.substring(0,o+1)+process_nested(l.substring(o),r).trim()+"}"),a=!1,f=!1,p="",l="";continue}for(var g=n-1,v="";;){var y=e[g--];if("{"!==y){if("}"===y||"\n"===y||"\r"===y||void 0===y||p&&p===y)break;v=y+v}}a=!1,f=!1,p="",l="",s+=process_nested(e.substring(n-1,i),(r||"")+v.trim())}}else{if(a){u++;continue}a=!0,u=0,n=i,c=!1}else s+=e.substring(o-1,i),f=!1,l=""}else d=!0,i++,m=""}return s+l}function process_nested(e,r){return e=e.trim(),e=make_nested(e.substring(1,e.length-1),r),nested(e,r)}function make_nested(e,r){for(var t,n=0,o="",i="",s=0,a=!1,u=!1;;){var c=e[n++];if(!c)break;if("\n"!==c&&"\r"!==c)if(" "===c&&" "===o[o.length-1]||(o+=c),"{"!==c){if("}"===c){if(s>0){s--,u=!0;continue}if(!u){i+=r+" "+o.trim(),o="",a=!1;continue}i+=o}}else{if(a){s++;continue}a=!0,s=0,t=n,u=!1}}return i}function compressHTML(e,r){if(!e||!r)return e;e=removeComments(e);for(var t=["script","textarea","pre","code"],n="["+(new Date).getTime()+"]#",o={},i=0,s=t.length,a=0;s>a;a++)for(var u=t[a],c="<"+u,l="</"+u,f=e.indexOf(c),p=0,d=l.length;-1!==f&&(p=e.indexOf(l,f+3),-1!==p);){var m=n+i++,h=e.substring(f,p+d);if(!a){if(p=h.indexOf(">"),d=h.indexOf('type="text/template"'),p>d&&-1!==d){f=e.indexOf(c,f+c.length);continue}if(d=h.indexOf('type="text/html"'),p>d&&-1!==d){f=e.indexOf(c,f+c.length);continue}if(d=h.indexOf('type="text/ng-template"'),p>d&&-1!==d){f=e.indexOf(c,f+c.length);continue}}o[m]=h,e=e.replacer(h,m),f=e.indexOf(c,f+c.length)}for(;;){if(!e.match(REG_6))break;e=e.replace(REG_6,function(e){return e.replace(/\s+/g," ")})}e=e.replace(/>\n\s+/g,">").replace(/(\w|\W)\n\s+</g,function(e){return e.trim().replace(/\s/g,"")}).replace(REG_5,"><").replace(REG_4,function(e){var r=e[e.length-1];return"<"===r?r:" "+r}).replace(REG_1,"").replace(REG_2,"");for(var m in o)e=e.replacer(m,o[m]);return e}function viewengine_read(e,r,t){var n,o=framework.config,i="."===e[0],s=i?e.substring(1):framework.path.views(e);if(RELEASE){n="404/"+e;var a=framework.temporary.other[n];if(void 0!==a)return null}if(existsSync(s))return view_parse(view_parse_localization(viewengine_modify(fs.readFileSync(s).toString("utf8"),s),r),o["allow-compile-html"],s,t);if(i)return RELEASE&&(framework.temporary.other[n]=null),null;var u=e.lastIndexOf("/");return-1===u?(RELEASE&&(framework.temporary.other[n]=null),null):(s=framework.path.views(e.substring(u+1)),existsSync(s)?view_parse(view_parse_localization(viewengine_modify(fs.readFileSync(s).toString("utf8"),s),r),o["allow-compile-html"],s,t):(RELEASE&&(framework.temporary.other[n]=null),null))}function viewengine_modify(e,r){if(!framework.modificators)return e;for(var t=0,n=framework.modificators.length;n>t;t++){var o=framework.modificators[t]("view",r,e);o&&(e=o)}return e}function viewengine_load(e,r,t){var n=t.language;if(framework.temporary.other[e]||(framework.temporary.other[e]=-1!==e.indexOf("@{")||-1!==e.indexOf("<")),framework.temporary.other[e])return viewengine_dynamic(e,n,t);var o=framework.routes.views[e];o?r="."+o.filename:r+=".html";var i="view#"+r;n&&(i+=n);var s=framework.temporary.views[i]||null;return s?s:(s=viewengine_read(r,n,t),framework.isDebug||(framework.temporary.views[i]=s),s)}function viewengine_dynamic(e,r,t){var n=r+"_"+e.hash(),o=framework.temporary.views[n]||null;return o?o:(o=view_parse(view_parse_localization(viewengine_modify(e,""),r),framework.config["allow-compile-html"],null,t),framework.isDebug||(framework.temporary.views[n]=o),o)}function cleanURL(e,r){for(var t,n=e.substring(0,r),o=!1,i=r,s=e.length;s>i;i++){var a=e[i];("/"!==a||"/"!==t||o)&&(t=a,n+=a)}return n}function destroyStream(e){return e instanceof ReadStream?(e.destroy(),"function"!=typeof e.close?e:(e.on("open",function(){"number"==typeof this.fd&&this.close()}),e)):e instanceof Stream?("function"==typeof e.destroy&&e.destroy(),e):e}function first(e,r){function t(){n(),r.apply(null,arguments)}function n(){for(var e,r=0,t=i.length;t>r;r++)e=i[r],e.ee.removeListener(e.event,e.fn)}function o(e){r=e}for(var i=[],s=0,a=e.length;a>s;s++)for(var u=e[s],c=u[0],l=1,f=u.length;f>l;l++){var p=u[l],d=listener(p,t);c.on(p,d),i.push({ee:c,event:p,fn:d})}return o.cancel=n,o}function listener(e,r){return function(t){for(var n=new Array(arguments.length),o=this,i="error"===e?t:null,s=0;s<n.length;s++)n[s]=arguments[s];r(i,o,e,n)}}function onFinished(e,r){return isFinished(e)!==!1?(setImmediate(r,null,e),e):(attachListener(e,r),e)}function attachFinishedListener(e,r){function t(e){o.cancel(),i.cancel(),s=!0,r(e)}function n(r){e.removeListener("socket",n),s||o!==i||(i=first([[r,"error","close"]],t))}var o,i,s=!1;return o=i=first([[e,"end","finish"]],t),e.socket?void n(e.socket):(e.on("socket",n),void(e.socket||patchAssignSocket(e,n)))}function attachListener(e,r){var t=e.__onFinished;t&&t.queue||(t=e.__onFinished=createListener(e),attachFinishedListener(e,t)),t.queue.push(r)}function createListener(e){function r(t){if(e.__onFinished===r&&(e.__onFinished=null),r.queue){var n=r.queue;r.queue=null;for(var o=0,i=n.length;i>o;o++)n[o](t,e)}}return r.queue=[],r}function patchAssignSocket(e,r){var t=e.assignSocket;"function"==typeof t&&(e.assignSocket=function(e){t.call(this,e),r(e)})}function isFinished(e){var r=e.socket;return"boolean"==typeof e.finished?Boolean(e.finished||r&&!r.writable):"boolean"==typeof e.complete?Boolean(e.upgrade||!r||!r.readable||e.complete&&!e.readable):void 0}function existsSync(e){try{return!!fs.statSync(e)}catch(r){return!1}}var exports=module.exports;global.framework_internal=module.exports;var crypto=require("crypto"),fs=require("fs"),ReadStream=require("fs").ReadStream,Stream=require("stream"),ENCODING="utf8",EMPTYARRAY=[],EMPTYOBJECT={};Object.freeze(EMPTYOBJECT),Object.freeze(EMPTYARRAY);var REG_1=/[\n\r\t]+/g,REG_2=/\s{2,}/g,REG_3=/\/{1,}/g,REG_4=/\n\s{2,}./g,REG_5=/>\n\s{1,}</g,REG_6=/[\<\w\"\u0080-\u07ff\u0400-\u04FF]+\s{2,}[\w\u0080-\u07ff\u0400-\u04FF\>]+/,REG_BLOCK_BEG=/\@\{block.*?\}/gi,REG_BLOCK_END=/\@\{end\}/gi,REG_SKIP_1=/\(\'|\"/g,REG_SKIP_2=/\,(\s)?\w+/g,HTTPVERBS={GET:!0,POST:!0,OPTIONS:!0,PUT:!0,DELETE:!0,PATCH:!0,upload:!0,HEAD:!0,TRACE:!0,PROPFIND:!0},RENDERNOW=["self.$import(","self.route","self.$js(","self.$css(","self.$favicon(","self.$script(","$STRING(self.resource(","$STRING(self.RESOURCE(","self.translate(","language","self.sitemap_url(","self.sitemap_name("];global.$STRING=function(e){return null!=e?e.toString():""},exports.parseMULTIPART=function(e,r,t,n,o){var i=r.split(";")[1];if(!i)return framework._request_stats(!1,!1),framework.stats.request.error400++,o.res.writeHead(400),void o.res.end();e.once("close",function(){e.$upload||e.clear()});var s,a,u,c=new MultipartParser,l=0,f=t.length,p=Date.now(),d=0,m="";e.files=[],e.body={};for(var h=0,g=e.ip.length;g>h;h++)"."!==e.ip[h]&&":"!==e.ip[h]&&(m+=e.ip[h]);i=i.substring(i.indexOf("=",2)+1),e.buffer_exceeded=!1,e.buffer_has=!0,c.initWithBoundary(i),c.onPartBegin=function(){a=new HttpFile,a.$data=new Buffer(""),a.$step=0,a.$is=!1,a.length=0},c.onHeaderValue=function(r,t,o){if(!e.buffer_exceeded){var i=r.slice(t,o).toString(ENCODING);if(1===a.$step){var u=i.indexOf(";");return-1===u?a.type=i.trim():a.type=i.substring(0,u).trim(),void(a.$step=2)}if(0===a.$step){if(i=parse_multipart_header(i),a.$step=1,a.$is=null!==i[1],a.name=i[0],!a.$is)return void destroyStream(s);a.filename=i[1],a.path=framework_utils.combine(n,(framework.id?"i-"+framework.id+"_":"")+"u"+m+"-"+p+"-"+framework_utils.random(1e5)+".upload"),s=fs.createWriteStream(a.path,{flags:"w"}),s.once("close",function(){return d--}),s.once("error",function(e){return d--}),d++}}},c.onPartData=function(r,t,n){if(!e.buffer_exceeded){var o=r.slice(t,n),i=o.length;if(l+=i,l>=f)return e.buffer_exceeded=!0,void(u?u.push(a.path):u=[a.path]);if(!a.$is)return void(a.$data=Buffer.concat([a.$data,o]));if(a.length)return s.write(o),void(a.length+=i);var c=null;if(!e.behaviour("disable-measuring"))switch(a.type){case"image/jpeg":c=framework_image.measureJPG(r.slice(t));break;case"image/gif":c=framework_image.measureGIF(o);break;case"image/png":c=framework_image.measurePNG(o);break;case"image/svg+xml":c=framework_image.measureSVG(o)}c?(a.width=c.width,a.height=c.height):(a.width=0,a.height=0),e.files.push(a),framework.emit("upload-begin",e,a),s.write(o),a.length+=i}},c.onPartEnd=function(){if(s&&(s.end(),s=null),!e.buffer_exceeded){if(a.$is)return delete a.$data,delete a.$is,delete a.$step,void framework.emit("upload-end",e,a);a.$data=a.$data.toString(ENCODING);var r=e.body[a.name];if(void 0===r)return void(e.body[a.name]=a.$data);if(r instanceof Array)return void e.body[a.name].push(a.$data);r=[r],r.push(a.$data),e.body[a.name]=r}},c.onEnd=function(){var e=function r(){return d?void setImmediate(r):(u&&framework.unlink(u),void o.doEnd())};e()},e.on("data",function(e){return c.write(e)}),e.on("end",function(){e.buffer_exceeded||(e.$upload=!0),c.end()})},exports.routeSplit=function(e,r){var t;if(!r&&(t=framework.temporary.other[e]))return t;if(!e||"/"===e)return t=["/"];var n=!1,o="",i=0;t=[];for(var s=0,a=e.length;a>s;s++){var u=e[s];if("/"!==u)o+=r?u:u.toLowerCase(),n="/"===u;else{if(n)continue;o&&(t.push(o),i++,o="")}}return o?t.push(o):i||t.push("/"),t},exports.routeSplitCreate=function(e,r){r||(e=e.toLowerCase()),"/"===e[0]&&(e=e.substring(1)),"/"===e[e.length-1]&&(e=e.substring(0,e.length-1));for(var t=0,n=0,o=[],i=0,s=e.length;s>i;i++)switch(e[i]){case"/":if(0!==t)break;o.push(e.substring(n+(o.length?1:0),i)),n=i;break;case"{":t++;break;case"}":t--}return t||o.push(e.substring(n+(o.length?1:0),e.length)),1!==o.length||o[0]||(o[0]="/"),o},exports.routeCompare=function(e,r,t,n){var o=e.length,i=r.length;if(i!==o&&!n)return!1;if(n&&1===i&&"/"===r[0])return!0;for(var s=1===o&&"/"===e[0],a=0;o>a;a++){var u=r[a];if(!t&&n&&void 0===u)return!0;if((t||s||"{"!==u[0])&&e[a]!==u)return t?!1:n?a>=i:!1}return!0},exports.routeCompareSubdomain=function(e,r){if(!e&&!r||e&&!r)return!0;if(!e&&r)return!1;for(var t=0,n=r.length;n>t;t++){if("*"===r[t])return!0;var o=r[t].lastIndexOf("*");if(-1===o){if(r[t]===e)return!0}else if(-1!==e.indexOf(r[t].replace("*","")))return!0}return!1},exports.routeCompareFlags=function(e,r,t){for(var n=!1,o=e,i=r,s=e.length,a=r.length,u=s>a?o:i,c=s>a?i:o,l=Math.max(s,a),f="authorize",p="unauthorize",d=0;l>d;d++){var m=u[d],h=m[0];if("!"!==h&&"#"!==h&&"$"!==h&&"@"!==h&&"+"!==h&&(!t||m!==f&&m!==p)){var g=c.indexOf(m),v=m.toUpperCase();if(-1===g&&!HTTPVERBS[v])return m===f||m===p?-1:0;n=n||-1!==g&&HTTPVERBS[v]}}return n?1:0},exports.routeCompareFlags2=function(e,r,t){if(!r.isWEBSOCKET){if(r.isXHR&&!e.xhr)return 0;if(r.isMOBILE&&!e.mobile)return 0;if(r.isROBOT&&!e.robot)return 0;var n=e.method;if(r.method){if(r.method!==n)return 0}else if(-1===r.flags.indexOf(n.toLowerCase()))return 0;if(r.isREFERER&&-1===e.flags.indexOf("referer"))return 0;if(!r.isMULTIPLE&&r.isJSON&&-1===e.flags.indexOf("json"))return 0}for(var o=!1,i=0,s=e.flags.length;s>i;i++){var a=e.flags[i];switch(a){case"json":continue;case"xml":if(r.isRAW||r.isXML)continue;return 0;case"proxy":if(!r.isPROXY)return 0;continue;case"debug":if(!r.isDEBUG&&r.isRELEASE)return 0;continue;case"release":if(!r.isRELEASE&&r.isDEBUG)return 0;continue;case"referer":continue;case"upload":if(!r.isUPLOAD)return 0;continue;case"https":if(!r.isHTTPS&&r.isHTTP)return 0;continue;case"http":if(!r.isHTTP&&r.isHTTPS)return 0;continue;case"xhr":case"+xhr":if(!r.isBOTH&&!r.isXHR)return 0;continue}var u="@"===a[0];if(t&&r.isMEMBER){var c=a.substring(0,3);if(!r.isGET&&"aut"!==c&&"una"!==c&&-1===r.flags.indexOf(a)||r.isROLE&&u&&-1===r.flags.indexOf(a)||r.isROLE&&!u)return 0}else if(!u||!o||r.isROLE){var l=r.flags.indexOf(a);if(-1===l)return r.isMEMBER?0:-1;u&&(o=!0)}}return 1},exports.routeParam=function(e,r){if(!r||!e||!r.param.length)return EMPTYARRAY;for(var t=[],n=0,o=r.param.length;o>n;n++){var i=e[r.param[n]];t.push("/"===i?"":i)}return t},HttpFile.prototype.copy=function(e,r){var t=this;if(!r)return void fs.createReadStream(t.path).pipe(fs.createWriteStream(e));var n=fs.createReadStream(t.path),o=fs.createWriteStream(e);return n.on("close",r),n.pipe(o),t},HttpFile.prototype.$$copy=function(e){var r=this;return function(t){return r.copy(e,t)}},HttpFile.prototype.readSync=function(){return fs.readFileSync(this.path)},HttpFile.prototype.read=function(e){var r=this;return fs.readFile(r.path,e),r},HttpFile.prototype.$$read=function(){var e=this;return function(r){e.read(r)}},HttpFile.prototype.md5=function(e){var r=this,t=crypto.createHash("md5"),n=fs.createReadStream(r.path);return n.on("data",function(e){t.update(e)}),n.on("error",function(r){e(r,null)}),onFinished(n,function(){destroyStream(n),e(null,t.digest("hex"))}),r},HttpFile.prototype.$$md5=function(){var e=this;return function(r){e.md5(r)}},HttpFile.prototype.stream=function(e){var r=this;return fs.createReadStream(r.path,e)},HttpFile.prototype.pipe=function(e,r){var t=this;return fs.createReadStream(t.path,r).pipe(e,r)},HttpFile.prototype.isImage=function(){var e=this;return-1!==e.type.indexOf("image/")},HttpFile.prototype.isVideo=function(){var e=this;return-1!==e.type.indexOf("video/")},HttpFile.prototype.isAudio=function(){var e=this;return-1!==e.type.indexOf("audio/")},HttpFile.prototype.image=function(e){var r=e;return void 0===r&&(r="im"===framework.config["default-image-converter"]),framework_image.init(this.path,r,this.width,this.height)},exports.compile_css=function(e,r){if(global.framework){if(framework.modificators)for(var t=0,n=framework.modificators.length;n>t;t++){var o=framework.modificators[t]("style",r,e);o&&(e=o)}if(framework.onCompileStyle)return framework.onCompileStyle(r,e)}try{var i=!1;return e=nested(e,"",function(){i=!0}),e=compile_autovendor(e),i&&(e=variablesCSS(e)),e}catch(s){return framework.error(new Error("CSS compiler exception: "+s.message)),""}},exports.compile_javascript=function(e,r){var t="object"===_typeof(global.framework);try{if(t){if(framework.modificators)for(var n=0,o=framework.modificators.length;o>n;n++){var i=framework.modificators[n]("script",r,e);i&&(e=i)}if(framework.onCompileScript)return framework.onCompileScript(r,e).trim()}return JavaScript(e).trim()}catch(s){return t&&framework.error(s,"JavaScript compressor"),e}},exports.compile_html=function(e,r){return compressCSS(compressJS(compressHTML(e,!0),0,r),0,r)};var Buffer=require("buffer").Buffer,s=0,S={PARSER_UNINITIALIZED:s++,START:s++,START_BOUNDARY:s++,HEADER_FIELD_START:s++,HEADER_FIELD:s++,HEADER_VALUE_START:s++,HEADER_VALUE:s++,HEADER_VALUE_ALMOST_DONE:s++,HEADERS_ALMOST_DONE:s++,PART_DATA_START:s++,PART_DATA:s++,PART_END:s++,END:s++},f=1,F={PART_BOUNDARY:f,LAST_BOUNDARY:f*=2},LF=10,CR=13,SPACE=32,HYPHEN=45,COLON=58,A=97,Z=122,lower=function(e){return 32|e};for(s in S)exports[s]=S[s];return exports.MultipartParser=MultipartParser,MultipartParser.stateToString=function(e){for(var r in S){var t=S[r];if(t===e)return r}},MultipartParser.prototype.initWithBoundary=function(e){var r=this;r.boundary=new Buffer(e.length+4),r.boundary.write("\r\n--",0,"ascii"),r.boundary.write(e,4,"ascii"),r.lookbehind=new Buffer(r.boundary.length+8),r.state=S.START,r.boundaryChars={};for(var t=0;t<r.boundary.length;t++)r.boundaryChars[r.boundary[t]]=!0},MultipartParser.prototype.write=function(e){var r,t,n=this,o=0,i=e.length,s=n.index,a=n.index,u=n.state,c=n.flags,l=n.lookbehind,f=n.boundary,p=n.boundaryChars,d=n.boundary.length,m=d-1,h=e.length,g=function(e){n[e+"Mark"]=o},v=function(e){delete n[e+"Mark"]},y=function(e,r,t,o){if(void 0===t||t!==o){var i="on"+e.substr(0,1).toUpperCase()+e.substr(1);i in n&&n[i](r,t,o)}},b=function(r,t){var i=r+"Mark";i in n&&(t?(y(r,e,n[i],o),delete n[i]):(y(r,e,n[i],e.length),n[i]=0))};for(o=0;i>o;o++)switch(r=e[o],u){case S.PARSER_UNINITIALIZED:return o;case S.START:a=0,u=S.START_BOUNDARY;case S.START_BOUNDARY:if(a==f.length-2){if(r===HYPHEN)c|=F.LAST_BOUNDARY;else if(r!==CR)return o;a++;break}if(a-1===f.length-2){if(c&F.LAST_BOUNDARY&&r===HYPHEN)y("end"),u=S.END,c=0;else{if(c&F.LAST_BOUNDARY||r!==LF)return o;a=0,y("partBegin"),u=S.HEADER_FIELD_START}break}r!==f[a+2]&&(a=-2),r===f[a+2]&&a++;break;case S.HEADER_FIELD_START:u=S.HEADER_FIELD,g("headerField"),a=0;case S.HEADER_FIELD:if(r===CR){v("headerField"),u=S.HEADERS_ALMOST_DONE;break}if(a++,r===HYPHEN)break;if(r===COLON){if(1===a)return o;b("headerField",!0),u=S.HEADER_VALUE_START;break}if(t=lower(r),A>t||t>Z)return o;break;case S.HEADER_VALUE_START:if(r===SPACE)break;g("headerValue"),u=S.HEADER_VALUE;case S.HEADER_VALUE:r===CR&&(b("headerValue",!0),y("headerEnd"),u=S.HEADER_VALUE_ALMOST_DONE);break;case S.HEADER_VALUE_ALMOST_DONE:if(r!==LF)return o;u=S.HEADER_FIELD_START;break;case S.HEADERS_ALMOST_DONE:if(r!==LF)return o;y("headersEnd"),u=S.PART_DATA_START;break;case S.PART_DATA_START:u=S.PART_DATA,g("partData");case S.PART_DATA:if(s=a,!a){for(o+=m;h>o&&!(e[o]in p);)o+=d;o-=m,r=e[o]}if(a<f.length)f[a]===r?(a||b("partData",!0),a++):a=0;else if(a===f.length)a++,r===CR?c|=F.PART_BOUNDARY:r===HYPHEN?c|=F.LAST_BOUNDARY:a=0;else if(a-1===f.length)if(c&F.PART_BOUNDARY){if(a=0,r===LF){c&=~F.PART_BOUNDARY,y("partEnd"),y("partBegin"),u=S.HEADER_FIELD_START;break}}else c&F.LAST_BOUNDARY&&r===HYPHEN?(y("partEnd"),y("end"),u=S.END,c=0):a=0;a?l[a-1]=r:s&&(y("partData",l,0,s),s=0,g("partData"),o--);break;case S.END:break;default:return o}return b("headerField"),b("headerValue"),b("partData"),n.index=a,n.state=u,n.flags=c,i},MultipartParser.prototype.end=function(){var e=this,r=function(e,r){var t="on"+r.substr(0,1).toUpperCase()+r.substr(1);t in e&&e[t]()};if(e.state===S.HEADER_FIELD_START&&0===e.index||e.state===S.PART_DATA&&e.index==e.boundary.length)r(e,"partEnd"),r(e,"end");else if(e.state!=S.END)return r(e,"partEnd"),r(e,"end"),new Error("MultipartParser.end(): stream ended unexpectedly: "+e.explain())},MultipartParser.prototype.explain=function(){return"state = "+MultipartParser.stateToString(this.state)},exports.appendModel=function(e){var r=e.indexOf("(");if(-1===r)return e;var t=e.substring(r+1);return e.substring(0,r)+"(model"+(")"===t[0]?t:","+t)},exports.preparePath=function(e,r){var t=framework.config["default-root"];if(!t)return e;var n="/"===e[0];return n&&"/"===e[1]||":"===e[4]||":"===e[5]?e:r?e.substring(t.length-1):n?t+e.substring(1):t+e},exports.parseURI=function(e,r){var t,n,o=framework.temporary.other[r.host];o?(t=o.port,n=o.hostname):(t=r.host.lastIndexOf(":"),-1===t?(t=null,n=r.host):(n=r.host.substring(0,t),t=r.host.substring(t+1)),framework.temporary.other[r.host]={port:t,hostname:n});var i,s=r.url.indexOf("?",1),a=null;-1===s?(s=null,i=r.url):(i=r.url.substring(0,s),s=r.url.substring(s),a=s.substring(1));var u=i.indexOf("//");return-1!==u&&(i=cleanURL(i,u),r.url=i,s&&(r.url+=s)),{auth:null,hash:null,host:r.host,hostname:n,href:e+"://"+r.host+r.url,path:r.url,pathname:i,port:t,protocol:e+":",query:a,search:s,slashes:!0}},exports.encodeUnicodeURL=function(e){for(var r=e,t=0,n=e.length;n>t;t++){var o=e.charCodeAt(t);o>127&&(r=r.replace(e[t],encodeURIComponent(e[t])))}return r},exports.parseBlock=function(e,r){if(-1===r.search(REG_BLOCK_BEG))return r;var t="\n",n=r.split(t),o=!1,i=!1,s="";e=(e||"").replace(/\s/g,"").split(",");for(var a=0,u=n.length;u>a;a++){var c=n[a];if(c)if(-1===c.search(REG_BLOCK_END))if(o){if(i)continue;s+=c+t}else{var l=c.search(REG_BLOCK_BEG);if(l)if(-1!==l){o=!0,i=!0;for(var f=c.substring(l+8,c.indexOf("}",l)).replace(/\|\|/g,",").replace(/\s/g,"").split(","),p=0,d=f.length;d>p;p++)if(-1!==e.indexOf(f[p])){i=!1;break}}else s+=c+t}else o=!1,i=!1}return s.trim()},exports.viewEngine=viewengine_load,exports.parseLocalization=view_parse_localization,exports.findLocalization=view_find_localization,exports.destroyStream=destroyStream,exports.onFinished=onFinished,exports.modificator=viewengine_modify,module}({exports:{}}),function(e){function r(e,r){this.filename=r+C,this.filenameTemp=r+A,this.filenameMeta=r+N,this.directory=T.dirname(r),this.filenameBackup=framework_utils.join(this.directory,e+"_backup"+C),this.name=e,this.pending_update=[],this.pending_append=[],this.pending_reader=[],this.pending_reader_view=[],this.pending_remove=[],this.views={},this.step=0,this.pending_drops=!1,this.pending_views=!1,this.binary=new o(this,this.directory+"/"+this.name+"-binary/"),this.iscache=!1,this.metadata,this.$meta(),this.$timeoutmeta}function t(){this.$callback=NOOP}function n(){this.$take=0,this.$skip=0,this.$filter=[],this.$sort,this.$first=!1,this.$scope=0,
this.$fields,this.$callback=NOOP}function o(e,r){this.db=e,this.directory=r,this.exists=!1}function i(e){this.filename=e,this.items=[],this.is=!1,this.callback}function s(e,r,t){return t.value===e[t.name]}function a(e,r,t){return t.value<e[t.name]}function u(e,r,t){return t.value>e[t.name]}function c(e,r,t){return t.value<=e[t.name]}function l(e,r,t){return t.value>=e[t.name]}function f(e,r,t){return t.value!==e[t.name]}function p(e,r,t){var n=e[t.name];return n?t.value===new Date(n):!1}function d(e,r,t){var n=e[t.name];return n?t.value<new Date(n):!1}function m(e,r,t){var n=e[t.name];return n?t.value>new Date(n):!1}function h(e,r,t){var n=e[t.name];return n?t.value<=new Date(n):!1}function g(e,r,t){var n=e[t.name];return n?t.value>=new Date(n):!1}function v(e,r,t){var n=e[t.name];return n?t.value!==new Date(n):!1}function y(e,r,t){var n=e[t.name];return n?n.startsWith(t.value):!1}function b(e,r,t){var n=e[t.name];return n?n.endsWith(t.value):!1}function w(e,r,t){var n=e[t.name];if(!n)return!1;if(t.value instanceof Array){for(var o=0,i=t.value.length;i>o;o++)if(-1!==n.toLowerCase().indexOf(t.value[o]))return!0;return!1}return-1!==n.toLowerCase().indexOf(t.value)}function k(e,r,t){var n=e[t.name];return n>=t.a&&n<=t.b}function E(e,r,t){var n=e[t.name];if(n instanceof Array){for(var o=0,i=n.length;i>o;o++)if(-1!==t.value.indexOf(n[o]))return!0;return!1}return-1!==t.value.indexOf(n)}function _(e,r,t){var n=e[t.name];if(n instanceof Array){for(var o=0,i=n.length;i>o;o++)if(-1!==t.value.indexOf(n[o]))return!1;return!0}return-1===t.value.indexOf(n)}function S(e,r,t){if(e)return e;var n=t instanceof Array;return(!t||n&&!t.length)&&r.$callback_emptyerror?(new ErrorBuilder).push(r.$callback_emptyerror):null}var O=e.exports;global.framework_nosql=e.exports;var x=require("fs"),T=require("path");global.framework_utils||(global.framework_utils=require("./utils")),global.framework_image||(global.framework_image=require("./image")),global.framework_nosql||(global.framework_nosql=O);var C=".nosql",R=".nosql-binary",A=".nosql-tmp",N=".meta",$=2e3,D="\n",P=[],F=/^[\s]+|[\s]+$/g;return Object.freeze(P),O.load=function(e,t){return new r(e,t)},r.prototype.meta=function(e,r){var t=this;return void 0===r?t.metadata?t.metadata[e]:void 0:(t.metadata||(t.metadata={}),t.metadata[e]=r,clearTimeout(t.timeoutmeta),t.timeoutmeta=setTimeout(function(){return t.$meta(!0)},500),t)},r.prototype.insert=function(e){var r=this,n=new t;return r.pending_append.push({doc:JSON.stringify(e.$clean?e.$clean():e),builder:n}),r.next(1),n},r.prototype.update=function(e){var r=this,t=new n;return r.pending_update.push({builder:t,doc:e,count:0}),setImmediate(function(){return r.next(2)}),t},r.prototype.backup=function(e,r){"boolean"==typeof e&&(r=e,e="");var n=this;if(r)return n.remove(e||"");var o=new t,i=x.createReadStream(n.filename);return i.pipe(x.createWriteStream(e||n.filenameBackup)),i.on("error",function(e){o.$callback&&o.$callback(S(e,o)),o.$callback=null}),i.on("end",function(){o.$callback&&o.$callback(S(null,o,!0),!0),o.$callback=null}),o},r.prototype.drop=function(){var e=this;return e.pending_drops=!0,setImmediate(function(){return e.next(7)}),e},r.prototype.free=function(){var e=this;return delete framework.databases[e.name],e},r.prototype.modify=function(e){var r=this,t=new n,o=e.$clean?e.$clean():e,i=Object.keys(o);return i.length?(r.pending_update.push({builder:t,doc:e,count:0,keys:i}),setImmediate(function(){return r.next(2)}),t):t},r.prototype.remove=function(e){var r=this,t=new n,o=void 0===e?void 0:e||r.filenameBackup;return o&&(o=new i(o)),r.pending_remove.push({builder:t,count:0,backup:o}),setImmediate(function(){return r.next(3)}),t},r.prototype.find=function(e){var r=this,t=new n;return e?(r.pending_reader_view.push({builder:t,count:0,counter:0,view:e}),setImmediate(function(){return r.next(6)})):(r.pending_reader.push({builder:t,count:0,counter:0,view:e}),setImmediate(function(){return r.next(4)})),t},r.prototype.count=function(e){var r=this,t=new n;return e?(r.pending_reader_view.push({builder:t,count:0,view:e,type:1}),setImmediate(function(){return r.next(6)})):(r.pending_reader.push({builder:t,count:0,view:e,type:1}),setImmediate(function(){return r.next(4)})),t},r.prototype.one=function(e){var r=this,t=new n;return t.first(),e?(r.pending_reader_view.push({builder:t,count:0,view:e}),setImmediate(function(){return r.next(6)})):(r.pending_reader.push({builder:t,count:0,view:e}),setImmediate(function(){return r.next(4)})),t},r.prototype.top=function(e,r){var t=this,o=new n;return o.take(e),r?(t.pending_reader_view.push({builder:o,count:0,counter:0,view:r}),setImmediate(function(){return t.next(6)})):(t.pending_reader.push({builder:o,count:0,counter:0,view:r}),setImmediate(function(){return t.next(4)})),o},r.prototype.view=function(e){var r=new n;return this.views[e]={},this.views[e]=r,this.views[e].$filename=this.filename.replace(/\.nosql/,"#"+e+".nosql"),r},r.prototype.next=function(e){var r=this;return e&&r.step?r:6!==r.step&&r.pending_reader_view.length?(r.$readerview(),r):4!==r.step&&r.pending_reader.length?(r.$reader(),r):1!==r.step&&r.pending_append.length?(r.$append(),r):2!==r.step&&r.pending_update.length?(r.$update(),r):3!==r.step&&r.pending_remove.length?(r.$remove(),r):5!==r.step&&r.pending_views?(r.$views(),r):7!==r.step&&r.pending_drops?(r.$drop(),r):(r.step!==e&&(r.step=0,setImmediate(function(){return r.next(0)})),r)},r.prototype.refresh=function(){var e=this;return e.iscache&&framework.cache.removeAll("$nosql"),e.views?(e.pending_views=!0,setImmediate(function(){return e.next(5)}),e):e},r.prototype.$meta=function(e){var r=this;if(e)return x.writeFile(r.filenameMeta,JSON.stringify(r.metadata),NOOP),r;try{r.metadata=JSON.parse(x.readFileSync(r.filenameMeta).toString("utf8"))}catch(t){}return r},r.prototype.$append=function(){var e=this;return e.step=1,e.pending_append.length?(e.pending_append.splice(0).limit(20,function(r,t){for(var n=[],o=0,i=r.length;i>o;o++)n.push(r[o].doc);x.appendFile(e.filename,n.join(D)+D,function(e){for(var n=0,o=r.length;o>n;n++){var i=r[n].builder.$callback;i&&i(e,1)}t()})},function(){setImmediate(function(){e.next(0),setImmediate(function(){return e.refresh()})})}),e):(e.next(0),e)},r.prototype.$update=function(){var e=this;if(e.step=2,!e.pending_update.length)return e.next(0),e;var r=x.createReadStream(e.filename),t=x.createWriteStream(e.filenameTemp),n=e.pending_update.splice(0),o=n.length,i=!1;return r.on("data",framework_utils.streamer(D,function(e,r){for(var s=JSON.parse(e.trim()),a=0;o>a;a++){var u=n[a],c=u.builder,l=c.compare(s,r),f=s;if(l){if(u.keys)for(var p=0,d=u.keys.length;d>p;p++){var m=u.doc[u.keys[p]];"function"==typeof m?f[u.keys[p]]=m(f[u.keys[p]]):f[u.keys[p]]=m}else f="function"==typeof u.doc?u.doc(f):u.doc;u.count++,i=!0}}t.write(JSON.stringify(f)+D)})),CLEANUP(t,function(){x.rename(e.filenameTemp,e.filename,function(r){for(var t=0;o>t;t++){var s=n[t];s.builder.$callback&&s.builder.$callback(S(r,s.builder,s.count),s.count)}setImmediate(function(){e.next(0),i&&setImmediate(function(){return e.refresh()})})})}),CLEANUP(r,function(){return t.end()}),e},r.prototype.$reader=function(){var e=this;if(e.step=4,!e.pending_reader.length)return e.next(0),e;for(var r=0,t=e.pending_reader.splice(0);;){var n=t[r++];if(!n)break;var o=n.builder.$cache_key;if(o){var i=framework.cache.get(o);i&&(n.builder.$callback(S(err,n.builder,i.items),i.items,i.count),r--,t.splice(r,1))}}return t.length?(e.$reader2(e.filename,t,function(){return e.next(0)}),e):(e.next(0),e)},r.prototype.$readerview=function(){var e=this;if(e.step=6,!e.pending_reader_view.length)return e.next(0),e;for(var r={},t=!0,n=0,o=e.pending_reader_view.length;o>n;n++){var i=e.pending_reader_view[n],s=e.views[i.view].$filename;if(i.builder.$cache_key){var a=framework.cache.get(i.builder.$cache_key);if(a){i.builder.$callback(S(err,i.builder,a.items),a.items,a.count);continue}}t=!1,r[s]?r[s].push(i):r[s]=[i]}return e.pending_reader_view=[],t?(e.next(0),e):(Object.keys(r).wait(function(t,n){e.$reader2(t,r[t],n)},function(){return e.next(0)},5),e)},r.prototype.$reader2=function(e,r,t){var n=this,o=x.createReadStream(e),i=r,s=i.length;return o.on("data",framework_utils.streamer(D,function(e,r){for(var t=JSON.parse(e.trim()),n=0;s>n;n++){var o=i[n],a=o.builder,u=a.compare(t,r);u&&(o.count++,!a.$sort&&(a.$skip&&a.$skip>r||a.$take&&a.$take<=o.counter)||(o.counter++,o.type||(o.response?o.response.push(u):o.response=[u])))}})),CLEANUP(o,function(){for(var e=0;s>e;e++){var r,n=i[e],o=n.builder;o.$sort?(n.count&&(o.$sort.name?n.response.quicksort(o.$sort.name,o.$sort.asc):n.response.sort(o.$sort),o.$skip&&o.$take?n.response=n.response.splice(o.$skip,o.$take):o.$skip?n.response=n.response.splice(o.$skip):o.$take&&(n.response=n.response.splice(0,o.$take))),r=o.$first?n.response?n.response[0]:void 0:n.response||P,o.$cache_key&&framework.cache.add(o.$cache_key,{items:r,count:n.count},o.$cache_expire),o.$callback(S(null,o,r),1===n.type?n.count:r,n.count),o.done()):(r=o.$first?n.response?n.response[0]:void 0:n.response||P,o.$cache_key&&framework.cache.add(o.$cache_key,{items:r,count:n.count},o.$cache_expire),o.$callback(S(null,o,r),1===n.type?n.count:r,n.count))}t()}),n},r.prototype.$views=function(){var e=this;if(e.step=5,!e.pending_views)return e.next(0),e;e.pending_views=!1;var r=Object.keys(e.views),t=r.length;if(!t)return e.next(0),e;for(var n=[],o=0;t>o;o++)n.push({response:[],name:r[o],builder:e.views[r[o]],count:0,counter:0});var i=x.createReadStream(e.filename);return i.on("data",framework_utils.streamer(D,function(o,i){for(var s=JSON.parse(o.trim()),a=0;t>a;a++){var u=e.views[r[a]],c=u.compare(s,i);c&&(n[a].count++,!u.$sort&&(u.$skip&&u.$skip>i||u.$take&&u.$take<n[a].counter)||(n[a].counter++,u.type||n[a].response.push(c)))}})),CLEANUP(i,function(){n.wait(function(e,r){var t=e.builder;t.$sort&&(t.$sort.name?e.response.quicksort(t.$sort.name,t.$sort.asc):e.response.sort(t.$sort),t.$skip&&t.$take?e.response=e.response.splice(t.$skip,t.$take):t.$skip?e.response=e.response.splice(t.$skip):t.$take&&(e.response=e.response.splice(0,t.$take)));var n=t.$filename;x.unlink(n,function(){e.response.limit(20,function(e,r){for(var t=[],o=0,i=e.length;i>o;o++)t.push(JSON.stringify(e[o]));x.appendFile(n,t.join(D)+D,r)},r)})},5)}),e},r.prototype.$remove=function(){var e=this;if(e.step=3,!e.pending_remove.length)return e.next(0),e;var r=x.createReadStream(e.filename),t=x.createWriteStream(e.filenameTemp),n=e.pending_remove.splice(0),o=n.length,i=!1;return r.on("data",framework_utils.streamer(D,function(e,r){for(var s=JSON.parse(e.trim()),a=0;o>a;a++){var u=n[a],c=u.builder,l=c.compare(s,r);if(!l)return void t.write(e);u.backup&&u.backup.write(e),u.count++,i=!0}})),CLEANUP(t,function(){x.rename(e.filenameTemp,e.filename,function(r){for(var t=0;o>t;t++){var s=n[t];s.builder.$callback&&s.builder.$callback(S(null,s.builder,s.count),s.count)}setImmediate(function(){e.next(0),i&&setImmediate(function(){return e.refresh()})})})}),CLEANUP(r,function(){return t.end()}),e},r.prototype.$drop=function(){var e=this;if(e.step=7,!e.pending_drops)return e.next(0),e;e.pending_drops=!1;var r=[e.filename,e.filenameTemp];Object.keys(e.views).forEach(function(t){return r.push(e.views[t].$filename)});try{x.readdirSync(e.binary.directory).forEach(function(t){t.startsWith(e.name+"#")&&t.endsWith(R)&&r.push(framework_utils.join(e.binary.directory,t))})}catch(t){}return r.wait(function(e,r){return x.unlink(e,r)},function(){return e.next(0)},5),e},t.prototype.callback=function(e,r){if("string"==typeof e){var t=r;r=e,e=t}return this.$callback=e,this.$callback_emptyerror=r,this},n.prototype.first=function(){return this.$first=!0,this.take(1)},n.prototype.make=function(e){return e.call(this,this),this},n.prototype.compare=function(e,r){for(var t=!0,n=!1,o=0,i=this.$filter.length;i>o;o++){var s=this.$filter[o];if(!n||!s.scope){var a=s.filter(e,o,s);if(a!==!0){if(!s.scope)return;t=!1}else t=!0,s.scope&&(n=!0)}}if(t){if(this.$prepare)return this.$prepare(e,r);if(!this.$fields)return e;for(var u={},o=0,i=this.$fields.length;i>o;o++){var c=this.$fields[o];u[c]=e[c]}return u}},n.prototype.filter=function(e){return this.$filter.push({scope:this.$scope,filter:e}),this},n.prototype.where=function(e,r,t){var n;void 0===t&&(t=r,r="=");var o=framework_utils.isDate(t);switch(r){case"=":n=o?p:s;break;case"<":n=o?m:u;break;case"<=":n=o?g:l;break;case">":n=o?d:a;break;case">=":n=o?h:c;break;case"<>":case"!=":n=o?v:f}return this.$filter.push({scope:this.$scope,filter:n,name:e,value:t}),this},n.prototype.like=n.prototype.search=function(e,r,t){var n;switch(t||(t="*"),t){case"beg":n=y;break;case"end":n=b;break;case"*":if(n=w,r instanceof Array)for(var o=0,i=r.length;i>o;o++)r[o]=r[o].toLowerCase();else r=r.toLowerCase()}return this.$filter.push({scope:this.$scope,name:e,filter:n,value:r}),this},n.prototype.take=function(e){return this.$take=e,this},n.prototype.limit=function(e){return this.$take=e,this},n.prototype.page=function(e,r){return this.skip(e*r),this.take(r)},n.prototype.skip=function(e){return this.$skip=e,this},n.prototype.callback=function(e,r){if("string"==typeof e){var t=r;r=e,e=t}return this.$callback=e,this.$callback_emptyerror=r,this},n.prototype.sort=function(e,r){return"function"==typeof e?(this.$sort=e,this):(this.$sort={name:e,asc:!r},this)},n.prototype["in"]=function(e,r){return r instanceof Array||(r=[r]),this.$filter.push({scope:this.$scope,name:e,filter:E,value:r}),this},n.prototype.notin=function(e,r){return r instanceof Array||(r=[r]),this.$filter.push({scope:this.$scope,name:e,filter:_,value:r}),this},n.prototype.between=function(e,r,t){return this.$filter.push({scope:this.$scope,name:e,filter:k,a:r,b:t}),this},n.prototype.or=function(){return this.$scope=1,this},n.prototype.end=function(){return this.$scope=0,this},n.prototype.and=function(){return this.$scope=0,this},n.prototype.done=function(){return this.$filter=null,this.$sort=null,this},n.prototype.cache=function(e,r){return this.$cache_key="$nosql_"+e,this.$cache_expire=r,this},n.prototype.fields=function(){this.$fields||(this.$fields=[]);for(var e=0,r=arguments.length;r>e;e++)this.$fields.push(arguments[e]);return this},n.prototype.prepare=function(e){return this.$prepare=e,this},o.prototype.insert=function(e,r,t){var n=this,o=framework_utils.getContentType(framework_utils.getExtension(e)),i="function"==typeof r;if(i||!r){i&&(t=r,r=void 0);var s=x.createReadStream(e);return CLEANUP(s),n.insert_stream(null,framework_utils.getName(e),o,s,t)}if("string"==typeof r)r=new Buffer(r,"base64");else if(r.resume)return n.insert_stream(null,e,o,r,t);var a,u=r.length,c=framework_utils.getExtension(e);switch(n.check(),c){case"gif":a=framework_image.measureGIF(r);break;case"png":a=framework_image.measurePNG(r);break;case"jpg":case"jpeg":a=framework_image.measureJPG(r);break;case"svg":a=framework_image.measureSVG(r)}a||(a={width:0,height:0});var l={name:e,size:u,type:o,width:a.width,height:a.height},f=new Buffer($);f.fill(" "),f.write(JSON.stringify(l));var p=(new Date).format("yyMMddHHmm")+"T"+framework_utils.GUID(5),d=n.db.name+"#"+p,m=x.createWriteStream(T.join(n.directory,d+R));return m.write(f,"binary"),m.end(r),CLEANUP(m),t&&t(null,p,l),p},o.prototype.insert_stream=function(e,r,t,n,o){var i=this;i.check();var s={name:r,size:0,type:t,width:0,height:0},a=new Buffer($);a.fill(" "),a.write(JSON.stringify(s)),e||(e=(new Date).format("yyMMddHHmm")+"T"+framework_utils.GUID(5));var u=i.db.name+"#"+e,c=x.createWriteStream(framework_utils.join(i.directory,u+R));return c.write(a,"binary"),n.pipe(c),CLEANUP(c),o&&o(null,e,s),e},o.prototype.update=function(e,r,t,n){var o=framework_utils.getContentType(framework_utils.getExtension(r)),i="function"==typeof t;if(i||!t){i&&(n=t,t=void 0);var s=x.createReadStream(r);return CLEANUP(s),u.insert_stream(e,framework_utils.getName(r),o,s,n)}if("string"==typeof t&&(t=new Buffer(t,"base64")),t.resume)return this.insert_stream(e,r,o,t,n);var a,u=this,c=t.length,l=framework_utils.getExtension(r);switch(u.check(),l){case"gif":a=framework_image.measureGIF(t);break;case"png":a=framework_image.measurePNG(t);break;case"jpg":case"jpeg":a=framework_image.measureJPG(t);break;case"svg":a=framework_image.measureSVG(t)}a||(a={width:0,height:0});var f={name:r,size:c,type:o,width:a.width,height:a.height},p=new Buffer($);p.fill(" "),p.write(JSON.stringify(f));var d=x.createWriteStream(framework_utils.join(u.directory,e+R));return d.write(p,"binary"),d.end(t),CLEANUP(d),n&&n(null,e,f),e},o.prototype.read=function(e,r){var t=this;t.check(),-1===e.indexOf("#")&&(e=t.db.name+"#"+e);var n=framework_utils.join(t.directory,e+R),o=x.createReadStream(n,{start:0,end:$-1,encoding:"binary"});return o.on("error",function(e){return r(e)}),o.on("data",function(e){var t=new Buffer(e,"binary").toString("utf8").replace(F,"");o=x.createReadStream(n,{start:$}),r(null,o,JSON.parse(t))}),t.db},o.prototype.remove=function(e,r){var t=this,n=e;t.check(),-1===n.indexOf("#")&&(n=t.db.name+"#"+n);var o=framework_utils.join(t.directory,n+R);return x.unlink(o,function(e){r&&r(null,!e)}),t.db},o.prototype.check=function(){var e=this;if(e.exists)return e;e.exists=!0;try{x.mkdirSync(e.directory)}catch(r){}return e},i.prototype.write=function(e){return this.items.push(e),this.flush(),this},i.prototype.flush=function(){var e=this;if(e.is)return e;if(!e.items.length)return e;var r=e.items.join("");return e.is=!0,x.appendFile(e.filename,r,function(){e.is=!1,e.flush()}),e.items=[],e},e}({exports:{}});var qs=require("querystring"),os=require("os"),fs=require("fs"),zlib=require("zlib"),path=require("path"),crypto=require("crypto"),parser=require("url"),events=require("events"),http=require("http"),child=require("child_process"),util=require("util"),ENCODING="utf8",RESPONSE_HEADER_CACHECONTROL="Cache-Control",RESPONSE_HEADER_CONTENTTYPE="Content-Type",RESPONSE_HEADER_CONTENTLENGTH="Content-Length",CONTENTTYPE_TEXTPLAIN="text/plain",CONTENTTYPE_TEXTHTML="text/html",REQUEST_COMPRESS_CONTENTTYPE={"text/plain":!0,"text/javascript":!0,"text/css":!0,"text/jsx":!0,"application/x-javascript":!0,"application/json":!0,"text/xml":!0,"image/svg+xml":!0,"text/x-markdown":!0,"text/html":!0},TEMPORARY_KEY_REGEX=/\//g,REG_MOBILE=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|Tablet/i,REG_ROBOT=/search|agent|bot|crawler/i,REG_VERSIONS=/(href|src)="[a-zA-Z0-9\/\:\-\.]+\.(jpg|js|css|png|gif|svg|html|ico|json|less|sass|scss|swf|txt|webp|woff|woff2|xls|xlsx|xml|xsl|xslt|zip|rar|csv|doc|docx|eps|gzip|jpe|jpeg|manifest|mov|mp3|mp4|ogg|package|pdf)"/gi,REG_MULTIPART=/\/form\-data$/i,REG_COMPILECSS=/url\(.*?\)/g,REG_ROUTESTATIC=/^(\/\/|https\:|http\:)+/g,REG_EMPTY=/\s/g,REG_SANITIZE_BACKSLASH=/\/\//g,REG_WEBSOCKET_ERROR=/ECONNRESET|EHOSTUNREACH|EPIPE|is closed/gi,REG_WINDOWSPATH=/\\/g,REG_SCRIPTCONTENT=/\<|\>|;/,REG_HTTPHTTPS=/^(\/)?(http|https)\:\/\//i,REG_TEXTAPPLICATION=/text|application/,REQUEST_PROXY_FLAGS=["post","json"],EMPTYARRAY=[],EMPTYOBJECT={},EMPTYREQUEST={uri:{}},SINGLETONS={};Object.freeze(EMPTYOBJECT),Object.freeze(EMPTYARRAY),Object.freeze(EMPTYREQUEST),global.EMPTYOBJECT=EMPTYOBJECT,global.EMPTYARRAY=EMPTYARRAY;var RANGE={start:0,end:0},HEADERS={},SUCCESSHELPER={success:!0};HEADERS.responseCode={},HEADERS.responseCode[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN,HEADERS.responseRedirect={},HEADERS.responseRedirect[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTHTML+"; charset=utf-8",HEADERS.responseRedirect[RESPONSE_HEADER_CONTENTLENGTH]="0",HEADERS.sse={},HEADERS.sse[RESPONSE_HEADER_CACHECONTROL]="no-cache, no-store, must-revalidate",HEADERS.sse.Pragma="no-cache",HEADERS.sse.Expires="0",HEADERS.sse[RESPONSE_HEADER_CONTENTTYPE]="text/event-stream",HEADERS.proxy={},HEADERS.proxy["X-Proxy"]="total.js",HEADERS["responseFile.etag"]={},HEADERS["responseFile.etag"]["Last-Modified"]="Mon, 01 Jan 2001 08:00:00 GMT",HEADERS["responseFile.etag"]["Access-Control-Allow-Origin"]="*",HEADERS["responseFile.etag"][RESPONSE_HEADER_CACHECONTROL]="public, max-age=11111111",HEADERS["responseFile.release.compress"]={},HEADERS["responseFile.release.compress"][RESPONSE_HEADER_CACHECONTROL]="public, max-age=11111111",HEADERS["responseFile.release.compress"].Vary="Accept-Encoding",HEADERS["responseFile.release.compress"]["Access-Control-Allow-Origin"]="*",HEADERS["responseFile.release.compress"]["Last-Modified"]="Mon, 01 Jan 2001 08:00:00 GMT",HEADERS["responseFile.release.compress"]["Content-Encoding"]="gzip",HEADERS["responseFile.release.compress.range"]={},HEADERS["responseFile.release.compress.range"]["Accept-Ranges"]="bytes",HEADERS["responseFile.release.compress.range"][RESPONSE_HEADER_CACHECONTROL]="public, max-age=11111111",HEADERS["responseFile.release.compress.range"].Vary="Accept-Encoding",HEADERS["responseFile.release.compress.range"]["Access-Control-Allow-Origin"]="*",HEADERS["responseFile.release.compress.range"]["Last-Modified"]="Mon, 01 Jan 2001 08:00:00 GMT",HEADERS["responseFile.release.compress.range"]["Content-Encoding"]="gzip",HEADERS["responseFile.release.compress.range"][RESPONSE_HEADER_CONTENTLENGTH]="0",HEADERS["responseFile.release.compress.range"]["Content-Range"]="",HEADERS["responseFile.release"]={},HEADERS["responseFile.release"][RESPONSE_HEADER_CACHECONTROL]="public, max-age=11111111",HEADERS["responseFile.release"].Vary="Accept-Encoding",HEADERS["responseFile.release"]["Access-Control-Allow-Origin"]="*",HEADERS["responseFile.release"]["Last-Modified"]="Mon, 01 Jan 2001 08:00:00 GMT",HEADERS["responseFile.release.range"]={},HEADERS["responseFile.release.range"]["Accept-Ranges"]="bytes",HEADERS["responseFile.release.range"][RESPONSE_HEADER_CACHECONTROL]="public, max-age=11111111",HEADERS["responseFile.release.range"].Vary="Accept-Encoding",HEADERS["responseFile.release.range"]["Access-Control-Allow-Origin"]="*",HEADERS["responseFile.release.range"]["Last-Modified"]="Mon, 01 Jan 2001 08:00:00 GMT",HEADERS["responseFile.release.range"][RESPONSE_HEADER_CONTENTLENGTH]="0",HEADERS["responseFile.release.range"]["Content-Range"]="",HEADERS["responseFile.debug.compress"]={},HEADERS["responseFile.debug.compress"][RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate",HEADERS["responseFile.debug.compress"].Vary="Accept-Encoding",HEADERS["responseFile.debug.compress"]["Access-Control-Allow-Origin"]="*",HEADERS["responseFile.debug.compress"].Pragma="no-cache",HEADERS["responseFile.debug.compress"].Expires="0",HEADERS["responseFile.debug.compress"]["Content-Encoding"]="gzip",HEADERS["responseFile.debug.compress.range"]={},HEADERS["responseFile.debug.compress.range"]["Accept-Ranges"]="bytes",HEADERS["responseFile.debug.compress.range"][RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate",HEADERS["responseFile.debug.compress.range"].Vary="Accept-Encoding",HEADERS["responseFile.debug.compress.range"]["Access-Control-Allow-Origin"]="*",HEADERS["responseFile.debug.compress.range"]["Content-Encoding"]="gzip",HEADERS["responseFile.debug.compress.range"].Pragma="no-cache",HEADERS["responseFile.debug.compress.range"].Expires="0",HEADERS["responseFile.debug.compress.range"][RESPONSE_HEADER_CONTENTLENGTH]="0",HEADERS["responseFile.debug.compress.range"]["Content-Range"]="",HEADERS["responseFile.debug"]={},HEADERS["responseFile.debug"][RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate",HEADERS["responseFile.debug"].Vary="Accept-Encoding",HEADERS["responseFile.debug"].Pragma="no-cache",HEADERS["responseFile.debug"].Expires="0",HEADERS["responseFile.debug"]["Access-Control-Allow-Origin"]="*",HEADERS["responseFile.debug.range"]={},HEADERS["responseFile.debug.range"]["Accept-Ranges"]="bytes",HEADERS["responseFile.debug.range"][RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate",HEADERS["responseFile.debug.range"].Vary="Accept-Encoding",HEADERS["responseFile.debug.range"]["Access-Control-Allow-Origin"]="*",HEADERS["responseFile.debug.range"].Pragma="no-cache",HEADERS["responseFile.debug.range"].Expires="0",HEADERS["responseFile.debug.range"][RESPONSE_HEADER_CONTENTLENGTH]="0",HEADERS["responseFile.debug.range"]["Content-Range"]="",HEADERS["responseContent.mobile.compress"]={},HEADERS["responseContent.mobile.compress"].Vary="Accept-Encoding, User-Agent",HEADERS["responseContent.mobile.compress"]["Content-Encoding"]="gzip",HEADERS["responseContent.mobile"]={},HEADERS["responseContent.mobile"].Vary="Accept-Encoding, User-Agent",HEADERS["responseContent.compress"]={},HEADERS["responseContent.compress"][RESPONSE_HEADER_CACHECONTROL]="private",HEADERS["responseContent.compress"].Vary="Accept-Encoding",HEADERS["responseContent.compress"]["Content-Encoding"]="gzip",HEADERS.responseContent={},HEADERS.responseContent.Vary="Accept-Encoding",HEADERS["responseStream.release.compress"]={},HEADERS["responseStream.release.compress"][RESPONSE_HEADER_CACHECONTROL]="public, max-age=11111111",HEADERS["responseStream.release.compress"]["Access-Control-Allow-Origin"]="*",HEADERS["responseStream.release.compress"]["Content-Encoding"]="gzip",HEADERS["responseStream.release"]={},HEADERS["responseStream.release"][RESPONSE_HEADER_CACHECONTROL]="public, max-age=11111111",HEADERS["responseStream.release"]["Access-Control-Allow-Origin"]="*",HEADERS["responseStream.debug.compress"]={},HEADERS["responseStream.debug.compress"][RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate",HEADERS["responseStream.debug.compress"].Pragma="no-cache",HEADERS["responseStream.debug.compress"].Expires="0",HEADERS["responseStream.debug.compress"]["Access-Control-Allow-Origin"]="*",HEADERS["responseStream.debug.compress"]["Content-Encoding"]="gzip",HEADERS["responseStream.debug"]={},HEADERS["responseStream.debug"][RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate",HEADERS["responseStream.debug"].Pragma="no-cache",HEADERS["responseStream.debug"].Expires="0",HEADERS["responseStream.debug"]["Access-Control-Allow-Origin"]="*",HEADERS["responseBinary.compress"]={},HEADERS["responseBinary.compress"][RESPONSE_HEADER_CACHECONTROL]="public",HEADERS["responseBinary.compress"]["Content-Encoding"]="gzip",HEADERS.responseBinary={},HEADERS.responseBinary[RESPONSE_HEADER_CACHECONTROL]="public",HEADERS.redirect={Location:""},HEADERS.authorization={user:"",password:"",empty:!0},HEADERS.fsStreamRead={flags:"r",mode:"0666",autoClose:!0},HEADERS.fsStreamReadRange={flags:"r",mode:"0666",autoClose:!0,start:0,end:0},HEADERS.workers={cwd:""};var _controller="",_test;global.framework_internal||(global.framework_internal=require("./internal")),global.framework_builders||(global.framework_builders=require("./builders")),global.framework_utils||(global.framework_utils=require("./utils")),global.framework_mail||(global.framework_mail=require("./mail")),global.framework_image||(global.framework_image=global.Image=require("./image")),global.framework_nosql||(global.framework_nosql=require("./nosql")),global.Builders=framework_builders;var utils=global.Utils=global.utils=global.U=framework_utils;global.Mail=framework_mail,global.INCLUDE=global.SOURCE=function(e,r){return framework.source(e,r)},global.MODULE=function(e){return framework.module(e)},global.NOSQL=function(e){return framework.nosql(e)},global.DB=global.DATABASE=function(){return"object"===_typeof(framework.database)?framework.database:framework.database.apply(framework,arguments)},global.CONFIG=function(e){return framework.config[e]},global.INSTALL=function(e,r,t,n,o){return framework.install(e,r,t,n,o)},global.UNINSTALL=function(e,r,t){return framework.uninstall(e,r,t)},global.RESOURCE=function(e,r){return framework.resource(e,r)},global.TRANSLATE=function(e,r){return framework.translate(e,r)},global.TRANSLATOR=function(e,r){return framework.translator(e,r)},global.LOG=function(){return framework.log.apply(framework,arguments)},global.LOGGER=function(){return framework.logger.apply(framework,arguments)},global.MODEL=function(e){return framework.model(e)},global.GETSCHEMA=function(e,r){return framework_builders.getschema(e,r)},global.UID=function(){var e=UIDGENERATOR.index%2?1:0;return UIDGENERATOR.date+(UIDGENERATOR.index++).padLeft(4,"0")+UIDGENERATOR.instance+e},global.MAKE=global.TRANSFORM=function(e,r){if("function"==typeof e){var t=r;r=e,e=t}var n;return"function"==typeof r?(n={},r.call(n,n)):n=r,e?TransformBuilder.transform.apply(n,arguments):n},global.SINGLETON=function(e){return SINGLETONS[e]||(SINGLETONS[e]={})},global.NEWTRANSFORM=function(e,r,t){return TransformBuilder.addTransform.apply(this,arguments)},global.NEWSCHEMA=function(e,r){return r||(r=e,e="default"),framework_builders.newschema(e,r)},global.EACHSCHEMA=function(e,r){return framework_builders.eachschema(e,r)},global.FUNCTION=function(e){return framework.functions[e]},global.ROUTING=function(e){return framework.routing(e)},global.SCHEDULE=function(e,r,t){return framework.schedule(e,r,t)},global.FINISHED=function(e,r){framework_internal.onFinished(e,r)},global.DESTROY=function(e){framework_internal.destroyStream(e)},global.CLEANUP=function(e,r){var t=function(){FINISHED(e,function(){DESTROY(e),r&&(r(),r=null)})};e.on("error",t),e.readable?e.on("end",t):e.on("finish",t)},global.SUCCESS=function(e,r){if("function"==typeof e)return function(r,t){e(r,SUCCESS(r,t))};var t;if(e instanceof Error?(t=e,e=!1):e instanceof framework_builders.ErrorBuilder?e.hasError()?(t=e.output(),e=!1):e=!0:null!==e&&void 0!==e||(e=!0),!r)return SUCCESSHELPER.success=!!e,SUCCESSHELPER;var n={success:e};return t&&(n.error=t),void 0===r?n:(n.value=r,n)},global.TRY=function(e,r){try{return e(),!0}catch(t){return r?r(r):F.error(r),!1}},global.OBSOLETE=function(e,r){console.log(':: OBSOLETE / IMPORTANT ---> "'+e+'"',r),framework.stats.other.obsolete++},global.DEBUG=!1,global.TEST=!1,global.RELEASE=!1,global.is_client=!1,global.is_server=!0;var directory=framework_utils.$normalize(require.main?path.dirname(require.main.filename):process.cwd()),DATE_EXPIRES=(new Date).add("y",1).toUTCString(),UIDGENERATOR={date:(new Date).format("yyMMddHHmm"),instance:"abcdefghijklmnoprstuwxy".split("").randomize().join("").substring(0,3),index:1},controller_error_status=function(e,r,t){return 500!==r&&t&&e.problem(t),e.res.success||e.res.headersSent||!e.isConnected?e:(e.req.path=EMPTYARRAY,e.subscribe.success(),e.subscribe.route=framework.lookup(e.req,"#"+r),e.subscribe.exception=t,e.subscribe.execute(r,!0),e)};Framework.prototype.__proto__=new events.EventEmitter,Framework.prototype.behaviour=function(e,r){var t=this;t.behaviours||(t.behaviours={}),"string"==typeof r&&(r=[r]),e=framework_internal.preparePath(e),t.behaviours[e]||(t.behaviours[e]={});for(var n=0;n<r.length;n++)t.behaviours[e][r[n]]=!0;return t},Framework.prototype.refresh=function(e){var r=this;return r.emit("clear","refresh"),r.resources={},r.databases={},r._configure(),r._configure_versions(),r._configure_sitemap(),r.temporary.path={},r.temporary.range={},r.temporary.views={},r.temporary.other={},r.emit("reconfigure"),r},Framework.prototype.controller=function(e){return this.controllers[e]||null},Framework.prototype.useConfig=function(e){return this._configure(e,!0)},Framework.prototype._routesSort=function(){var e=this;e.routes.web.sort(function(e,r){return e.priority>r.priority?-1:e.priority<r.priority?1:0}),e.routes.websockets.sort(function(e,r){return e.priority>r.priority?-1:e.priority<r.priority?1:0});for(var r,t={},n=e.routes.web.length,o=0;n>o;o++){var i=e.routes.web[o],s=e.temporary.internal[i.controller];s&&(i.controller=s),!i.isMOBILE||i.isUPLOAD||i.isXHR||i.isJSON||i.isSYSTEM||i.isXML||-1===i.flags.indexOf("get")||(r=i.url.join("/"),t[r]=!0)}for(var o=0;n>o;o++){var i=e.routes.web[o];i.isMOBILE||i.isUPLOAD||i.isXHR||i.isJSON||i.isSYSTEM||i.isXML||-1===i.flags.indexOf("get")||(r=i.url.join("/"),i.isMOBILE_VARY=t[r]===!0)}return e},Framework.prototype.database=function(e){return this.nosql(e)},Framework.prototype.nosql=function(e){var r=this,t=r.databases[e];return t?t:(r.path.verify("databases"),t=framework_nosql.load(e,r.path.databases(e)),
r.databases[e]=t,t)},Framework.prototype.stop=function(e){var r=this;for(var t in framework.workers){var n=framework.workers[t];n&&n.kill&&n.kill(e||"SIGTERM")}return framework.emit("exit"),r.isWorker||"function"!=typeof process.send||process.send("stop"),r.cache.stop(),r.server&&r.server.close(),process.exit(e||"SIGTERM"),r},Framework.prototype.redirect=function(e,r,t,n){var o=this,i=e.startsWith("http://")||e.startsWith("https");if(i)return"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),"/"===r[r.length-1]&&(r=r.substring(0,r.length-1)),o.routes.redirects[e]={url:r,path:t,permanent:n},o._request_check_redirect=!0,o;"/"!==e[0]&&(e="/"+e);var s;return t instanceof Array?(s=t,t=n===!0):n instanceof Array?(s=n,t=t===!0):t=t===!0,n=t,framework.route(e,function(){return r.startsWith("http://")||r.startsWith("https://")?void this.redirect(r+this.href(),n):("/"!==r[0]&&(r="/"+r),void this.redirect(r+this.href(),n))},s),o},Framework.prototype.schedule=function(e,r,t){void 0===t&&(t=r,r=!1);var n=this,o="undefined"==typeof e?"undefined":_typeof(e);"string"===o?e=e.parseDate():"number"===o&&(e=new Date(e));var i=e.getTime();framework_utils.GUID(5)+framework_utils.random(1e4);return r&&(r=r.replace("each","1")),n.schedules.push({expire:i,fn:t,repeat:r}),n},Framework.prototype.resize=function(e,r,t){var n=this,o={},i=!0;if("function"==typeof t){var s=t;t=r,r=s}var a=e.match(/\*.\*$|\*?\.(jpg|png|gif|jpeg)$/gi);if(a)switch(e=e.replace(a,""),a.toString().toLowerCase()){case"*.*":o["*"]=!0;break;case"*.jpg":case"*.gif":case"*.png":case"*.jpeg":o[a.toString().toLowerCase().replace(/\*/g,"")]=!0}var u=e;if(t&&t.length)for(var c=0,l=t.length;l>c;c++){var f=t[c];"."!==f[0]?"/"===f[0]||f.match(/^http\:|https\:/gi)?u=f:"nocache"===f&&(i=!1):o[f]=!0}return o.length||(o[".jpg"]=!0,o[".jpeg"]=!0,o[".png"]=!0,o[".gif"]=!0),n.routes.resize[e]={fn:r,path:u||e,ishttp:!!u.match(/http\:|https\:/gi),extension:o,cache:i},n},Framework.prototype.restful=function(e,r,t,n,o,i){var s,a=this;t&&(s=[],r&&s.push.apply(s,r),a.route(e,s,t));var u=framework_utils.path(e)+"{id}";return n&&(s=[],r&&s.push.apply(s,r),a.route(u,s,n)),o&&(s=["post"],r&&s.push.apply(s,r),a.route(e,s,o),s=["put"],r&&s.push.apply(s,r),a.route(u,s,o)),i&&(s=["delete"],r&&s.push.apply(s,r),a.route(u,s,i)),a},Framework.prototype.cors=function(e,r,t){var n,o=this,i={},s=[],a=[],u=[];if(r instanceof Array)for(var c=0,l=r.length;l>c;c++){var f=r[c],p="undefined"==typeof f?"undefined":_typeof(f);if("string"===p)f=f.toLowerCase();else if("number"===p){n=f;continue}if("boolean"===p||f.startsWith("credential"))t=!0;else if(f.startsWith("http://")||f.startsWith("https://"))s.push(f);else switch(f){case"post":case"put":case"delete":case"options":case"patch":case"head":case"get":a.push(f.toUpperCase());break;default:u.push(r[c])}}return i.isASTERIX=-1!==e.lastIndexOf("*"),i.isASTERIX&&(e=e.replace("*","")),i.url=framework_internal.routeSplitCreate(framework_internal.preparePath(framework_internal.encodeUnicodeURL(e.trim()))),i.origins=s.length?s:null,i.methods=a.length?a:null,i.headers=u.length?u:null,i.credentials=t,i.age=n||framework.config["default-cors-maxage"],o.routes.cors.push(i),o._length_cors=o.routes.cors.length,o.routes.cors.sort(function(e,r){var t=e.url.length,n=r.url.length;return t>n?-1:n>t?1:e.isASTERIX&&r.isASTERIX?1:0}),o},Framework.prototype.web=Framework.prototype.route=function(e,r,t,n){var o,i,s,a=this;if(e instanceof Array)return e.forEach(function(e){a.route(e,r,t,n)}),a;var u="function"==typeof e?e:null;if(u&&(e="/"),"#"===e[0])if(e=e.substring(1),"400"!==e&&"401"!==e&&"403"!==e&&"404"!==e&&"408"!==e&&"431"!==e&&"500"!==e&&"501"!==e){var c=a.sitemap(e,!0);if(!c)throw new Error('Sitemap item "'+e+'" not found.');o=e,e=c.url,c.wildcard&&(e+="*")}else e="#"+e;e||(e="/"),"["!==e[0]&&"/"!==e[0]&&(e="/"+e),e.endsWith("/")&&(e=e.substring(0,e.length-1)),e=framework_internal.encodeUnicodeURL(e);var l="undefined"==typeof r?"undefined":_typeof(r),f=0,p=e;o||(o=e),("object"===l||r instanceof Array)&&(i=r,r=t,t=i),"string"===l?(s=r,r=function(e){var r=framework_utils.parseTheme(e);return r&&(e=prepare_viewname(e)),function(){"~"===e[0]?this.themeName="":r&&(this.themeName=r),this.view(e)}}(s)):"function"!=typeof r&&(s=e,s.endsWith("/")&&(s=s.substring(0,s.length-1)),f=s.lastIndexOf("/"),-1!==f&&(s=s.substring(f+1)),s&&"/"!==s||(s="index"),r=function(e){return function(){"~"===e[0]&&this.theme(""),this.view(e)}}(s));var d=0,m=null;d=e.count("/"),"["===e[0]&&(f=e.indexOf("]"),f>0&&(m=e.substring(1,f).trim().toLowerCase().split(","),e=e.substring(f+1),d+=-1!==m.indexOf("*")?50:100));var h=-1!==e.indexOf("*");h&&(e=e.replace("*","").replace("//","/"),d-=100);var g,v,y,b=!1,w=!1,k="",E="GeneratorFunction"===r.constructor.name||0===r.toString().indexOf("function*"),_=!1,S=!1,O=!1,x=!1,T=!1,C=!1,R=!1,A=null,N=[];if(t){i=[];for(var $=0,D=0;D<t.length;D++){var P=_typeof(t[D]);if("number"!==P)if("object"!==P){var I=t[D][0];if("%"!==I)if("#"!==I)if("*"!==I){var j=t[D].toString().toLowerCase();if(j.startsWith("http://")||j.startsWith("https://"))N.push(j);else switch($++,j){case"json":S=!0;continue;case"delay":$--,O=!0;continue;case"binary":T=!0;continue;case"cors":C=!0,$--;continue;case"credential":case"credentials":N.push(j),$--;continue;case"sync":case"yield":case"synchronize":E=!0,$--;continue;case"noxhr":case"-xhr":w=!0;continue;case"raw":b=!0,i.push(j);break;case"mobile":_=!0;break;case"robot":x=!0,a._request_check_robot=!0;break;case"authorize":case"authorized":d+=2,i.push("authorize");break;case"unauthorize":case"unauthorized":d+=2,i.push("unauthorize");break;case"logged":d+=2,i.push("authorize");break;case"unlogged":i.push("unauthorize");break;case"referer":case"referrer":i.push("referer");break;case"delete":case"get":case"head":case"options":case"patch":case"post":case"propfind":case"put":case"trace":i.push(j),k+=(k?",":"")+j,N.push(j);break;default:"@"===j[0]&&(R=!0),i.push(j)}}else g=t[D].substring(1).replace(/\\/g,"/").split("/"),1===g.length&&(g[1]=g[0],g[0]="default"),f=g[1].indexOf("#"),-1!==f&&(g[2]=g[1].substring(f+1),g[1]=g[1].substring(0,f));else A||(A=[]),A.push(t[D].substring(1));else a.behaviour(""===e?"/":e,t[D].substring(1))}else y=t[D];else v=t[D]}t=i,d+=2*$}else t=["get"],k="get";var H=!1;-1===t.indexOf("logged")&&-1===t.indexOf("authorize")&&-1===t.indexOf("unauthorize")&&-1===t.indexOf("unlogged")&&(H=!0);var q=framework_internal.routeSplitCreate(framework_internal.preparePath(e.trim())),L=[],M=null,B=null;-1!==e.indexOf("{")&&(q.forEach(function(e,r){if("{"===e.substring(0,1)){L.push(r);var t=e.substring(1,e.length-1);if("/"===t[0]){var n=t.lastIndexOf("/");-1!==n&&(M||(M={},B=[]),M[r]=new RegExp(t.substring(1,n),t.substring(n+1)),B.push(r))}}}),d-=L.length),-1!==e.indexOf("#")&&(d-=100),-1!==t.indexOf("proxy")&&(S=!0,d++),(S||-1!==t.indexOf("xml")||b)&&-1===t.indexOf("delete")&&-1===t.indexOf("post")&&-1===t.indexOf("put")&&-1===t.indexOf("patch")&&(t.push("post"),k+=(k?",":"")+"post",d++),-1!==t.indexOf("upload")&&-1===t.indexOf("post")&&-1===t.indexOf("put")&&(t.push("post"),k+=(k?",":"")+"post"),-1===t.indexOf("get")&&-1===t.indexOf("options")&&-1===t.indexOf("post")&&-1===t.indexOf("delete")&&-1===t.indexOf("put")&&-1===t.indexOf("upload")&&-1===t.indexOf("head")&&-1===t.indexOf("trace")&&-1===t.indexOf("patch")&&-1===t.indexOf("propfind")&&(t.push("get"),k+=(k?",":"")+"get"),-1!==t.indexOf("referer")&&(a._request_check_referer=!0),a._request_check_POST||-1===t.indexOf("delete")&&-1===t.indexOf("post")&&-1===t.indexOf("put")&&-1===t.indexOf("upload")&&-1===t.indexOf("json")&&-1===t.indexOf("patch")&&-1===t.indexOf("options")||(a._request_check_POST=!0);var G=!1;return-1!==k.indexOf(",")&&(G=!0),k=-1!==k.indexOf(",")||""===k?void 0:k.toUpperCase(),"#"===o[1]&&(o=o.substring(1)),T&&!b&&(T=!1,console.warn('framework.route() skips "binary" flag because the "raw" flag is not defined.')),m&&a._length_subdomain_web++,a.routes.web.push({name:o,priority:d,schema:g,subdomain:m,controller:_controller?_controller:"unknown",url:q,param:L,flags:t||[],method:k,execute:r,length:1024*(n||a.config["default-request-length"]),middleware:A,timeout:void 0===v?O?0:a.config["default-request-timeout"]:v,isGET:-1!==t.indexOf("get"),isMULTIPLE:G,isJSON:S,isXML:-1!==t.indexOf("xml"),isRAW:b,isBINARY:T,isMOBILE:_,isROBOT:x,isMOBILE_VARY:_,isGENERATOR:E,isMEMBER:H,isASTERIX:h,isROLE:R,isREFERER:-1!==t.indexOf("referer"),isHTTPS:-1!==t.indexOf("https"),isHTTP:-1!==t.indexOf("http"),isDEBUG:-1!==t.indexOf("debug"),isRELEASE:-1!==t.indexOf("release"),isPROXY:-1!==t.indexOf("proxy"),isBOTH:!w,isXHR:-1!==t.indexOf("xhr"),isUPLOAD:-1!==t.indexOf("upload"),isSYSTEM:e.startsWith("/#"),isCACHE:!(e.startsWith("/#")||u||L.length||h),isPARAM:L.length>0,isDELAY:O,CUSTOM:u,options:y,regexp:M,regexpIndexer:B}),a.emit("route","web",a.routes.web[a.routes.web.length-1]),C&&F.cors(p,N),_controller||a._routesSort(),a},Framework.prototype.routing=function(e){for(var r=this,t=0,n=r.routes.web.length;n>t;t++){var o=r.routes.web[t];if(o.name===e){var i=framework_utils.path(o.url.join("/"));return"/"!==i[0]&&(i="/"+i),{controller:o.controller,url:i,id:o.id,flags:o.flags,middleware:o.middleware,execute:o.execute,timeout:o.timeout,options:o.options,length:o.length}}}},Framework.prototype.merge=function(e){for(var r=[],t=this,n=1,o=arguments.length;o>n;n++){var i=arguments[n];i instanceof Array||(i=[i]);for(var s=0,a=i.length;a>s;s++){var u=i[s],c=u[0];"@"===c?u="~"+framework.path["package"](u.substring(1)):"="===c&&(u="~"+framework.path.themes(u.substring(1))),r.push(u)}}e=framework_internal.preparePath(t._version(e)),"/"!==e[0]&&(e="/"+e);var l=t.path.temp((t.id?"i-"+t.id+"_":"")+"merge-"+createTemporaryKey(e));return t.routes.merge[e]={filename:l,files:r},t},Framework.prototype.mapping=function(e,r){return this.map.apply(this,arguments)},Framework.prototype.send=function(e,r){return process.send(e,r),this},Framework.prototype.map=function(e,r,t){"/"!==e[0]&&(e="/"+e);var n=!1,o=this;if(r=framework_utils.$normalize(r),e=framework_internal.preparePath(o._version(e)),"#"===r[0])return o.routes.mapping[e]=r,o;var i,s=r.indexOf("#");if(-1!==s){var a=r.split("#");r=a[0],i=a[1]}var u=r[0];"@"===u?(r=o.path["package"](r.substring(1)),n=!0):"="===u&&(r=framework.isWindows?framework_utils.combine(framework.config["directory-themes"],r.substring(1)):o.path.themes(r.substring(1)),n=!0);var c=framework_utils.getExtension(r).length>0;if(!n&&!r.startsWith(directory)){var a="~"===r[0]?o.path.root(r.substring(1)):o.path["public"](r);existsSync(a)&&(r=a)}if(c)return o.routes.mapping[e]=r,i&&(o.routes.blocks[e]=i),o;e=framework_utils.path(e),r=framework_utils.path(r);var l=r,f="",p=!1;if("/"===l[0]&&(p=!0),"~"===l[0]&&(f+="~",l=l.substring(1)),"."===l[0]&&(f+=".",l=l.substring(1)),p||"/"!==l[0]||(f+="/",l=l.substring(1)),t instanceof Array)for(var d=0,m=t.length;m>d;d++)"."===t[d][0]&&(t[d]=t[d].substring(1)),t[d]=t[d].toLowerCase();return setTimeout(function(){framework_utils.ls(framework.isWindows?r.replace(/\//g,"\\"):r,function(n){for(var s=0,a=n.length;a>s;s++){framework.isWindows&&(n[s]=n[s].replace(r,"").replace(/\\/g,"/"));var u=n[s].replace(l,"");if(t)if("function"==typeof t){if(!t(u))continue}else if(-1===t.indexOf(framework_utils.getExtension(u).toLowerCase()))continue;"/"===u[0]&&(u=u.substring(1));var c=e+u;o.routes.mapping[c]=f+n[s],i&&(o.routes.blocks[c]=i)}})},n?500:1),this},Framework.prototype.middleware=function(e,r){var t=this;return t.install("middleware",e,r),t},Framework.prototype.use=function(e,r,t){var n=this;if(!r&&!t){if(e instanceof Array)for(var o=0;o<e.length;o++)n.routes.request.push(e[o]);else n.routes.request.push(e);return n._length_request_middleware=n.routes.request.length,n}r instanceof Array&&(t=r,r=null);var i;if(r&&(r=framework_internal.routeSplitCreate(framework_internal.preparePath(r.trim())).join("/")),!t||-1!==t.indexOf("web"))for(var o=0,s=n.routes.web.length;s>o;o++)i=n.routes.web[o],r&&!i.url.join("/").startsWith(r)||(i.middleware||(i.middleware=[]),merge_middleware(i.middleware,e));if(!t||-1!==t.indexOf("file")||-1!==t.indexOf("files"))for(var o=0,s=n.routes.files.length;s>o;o++)i=n.routes.files[o],r&&!i.url.join("/").startsWith(r)||(i.middleware||(i.middleware=[]),merge_middleware(i.middleware,e));if(!t||-1!==t.indexOf("websocket")||-1!==t.indexOf("websockets"))for(var o=0,s=n.routes.websockets.length;s>o;o++)i=n.routes.websockets[o],r&&!i.url.join("/").startsWith(r)||(i.middleware||(i.middleware=[]),merge_middleware(i.middleware,e));return n},Framework.prototype.websocket=function(e,r,t,n){var o,i="function"==typeof e?e:null;if(i&&(e="/"),"#"===e[0]){e=e.substring(1);var s=f.sitemap(e,!0);if(!s)throw new Error('Sitemap item "'+e+'" not found.');e=s.url,s.wildcard&&(e+="*")}""===e&&(e="/"),e=framework_internal.encodeUnicodeURL(e);var a,u,c,l,f=this,p=0,d=e.indexOf("]"),m=null;p=e.count("/"),d>0&&(m=e.substring(1,d).trim().toLowerCase().split(","),e=e.substring(d+1),p+=-1!==m.indexOf("*")?50:100);var h=-1!==e.indexOf("*");h&&(e=e.replace("*","").replace("//","/"),p=-10-p);var g=framework_internal.routeSplitCreate(framework_internal.preparePath(e.trim())),v=[],y=null,b=null;-1!==e.indexOf("{")&&(g.forEach(function(e,r){if("{"===e.substring(0,1)){v.push(r);var t=e.substring(1,e.length-1);if("/"===t[0]){var n=t.lastIndexOf("/");-1!==n&&(y||(y={},b=[]),y[r]=new RegExp(t.substring(1,n),t.substring(n+1)),b.push(r))}}}),p-=v.length),"string"==typeof u&&(u=u[u]),"string"==typeof l&&(l=l[l]),o=[];var w=!1,k=!1,E=!1,_=0,S=!0;void 0===t&&(t=[]);for(var O=0;O<t.length;O++){var x=t[O],T="undefined"==typeof x?"undefined":_typeof(x);if("object"!==T)if("number"!==T)if("#"!==x[0])if(x=x.toString().toLowerCase(),x.startsWith("http://")||x.startsWith("https://"))u||(u=[]),u.push(x);else if(_++,"json"===x&&(w=!0),"binary"===x&&(k=!0),"raw"===x&&(k=!1,w=!1),"@"!==x[0]){if("json"!==x&&"binary"!==x&&"raw"!==x)switch(x){case"authorize":case"authorized":p++,o.push("authorize"),S=!1;break;case"unauthorize":case"unauthorized":p++,S=!1,o.push("unauthorize");break;case"get":case"http":case"https":case"debug":case"release":o.push(x);break;default:l||(l=[]),l.push(x)}}else E=!0,o.push(x);else a||(a=[]),a.push(t[O].substring(1));else n=x;else c=t[O]}return t=o,-1===t.indexOf("get")&&t.unshift("get"),p+=2*_,m&&f._length_subdomain_websocket++,f.routes.websockets.push({controller:_controller?_controller:"unknown",url:g,param:v,subdomain:m,priority:p,flags:t||[],onInitialize:r,protocols:l||[],allow:u||[],length:1024*(n||f.config["default-websocket-request-length"]),isWEBSOCKET:!0,isMEMBER:S,isJSON:w,isBINARY:k,isROLE:E,isASTERIX:h,isHTTPS:t.indexOf("https"),isHTTP:t.indexOf("http"),isDEBUG:t.indexOf("debug"),isRELEASE:t.indexOf("release"),CUSTOM:i,middleware:a?a:null,options:c,isPARAM:v.length>0,regexp:y,regexpIndexer:b}),f.emit("route","websocket",f.routes.websockets[f.routes.websockets.length-1]),_controller||f._routesSort(),f},Framework.prototype.file=function(e,r,t){var n,o=this;if(e instanceof Array){n=r;var i=t;t=e,e=n,r=i}else r instanceof Array&&(n=r,r=t,t=n);!r&&e&&(r=e,e=void 0);var s,a,u,c,l=!1,f=!1;if(t)for(var p=0,d=t.length;d>p;p++){var m=t[p];"object"!==("undefined"==typeof m?"undefined":_typeof(m))?("#"===m[0]&&(a||(a=[]),a.push(m.substring(1))),"."===m[0]&&(m=m.substring(1).toLowerCase(),s||(s={}),s[m]=!0)):u=m}if("string"==typeof e){if("/"===e&&(e=""),c=e?framework_internal.routeSplitCreate(e):EMPTYARRAY,e=void 0,n=c.last(),"*.*"===n)l=!0,c.splice(c.length-1,1);else if(n){var h=n.indexOf("*.");-1!==h?(s={},s[n.substring(h+2).trim()]=!0,l=!1,c.splice(c.length-1,1)):"*"===n?(l=!0,c.splice(c.length-1,1)):framework_utils.getExtension(n)&&(f=!0,l=!1)}}else s||e||(e=r);return o.routes.files.push({controller:_controller?_controller:"unknown",url:c,fixedfile:f,wildcard:l,extensions:s,onValidate:e,execute:r,middleware:a,options:u}),o.routes.files.sort(function(e,r){return e.url?r.url&&e.url.length>r.url.length?-1:1:-1}),o.emit("route","file",o.routes.files[o.routes.files.length-1]),o._length_files++,o},Framework.prototype.localize=function(e,r,t){e=e.replace("*","");var n=this;r===!0?(r=[],t=!0):r||(r=[]);var o;t||(o=r.indexOf("minify"),-1===o&&(o=r.indexOf("compress")),t=-1!==o,-1!==o&&r.splice(o,1));var o=e.lastIndexOf(".");return-1!==o?(r.push(e.substring(o).toLowerCase()),e=e.substring(0,o)):r.push(".html",".htm",".md",".txt"),e=framework_internal.preparePath(e),n.file(e,function(e,r,o){var i="locate_"+(e.$language?e.$language:"default")+"_"+e.url,s=framework.temporary.other[i];if(s)return void framework.responseContent(e,r,200,s,framework_utils.getContentType(e.extension),!0);var a=e.uri.pathname,u=n.onMapping(a,a,!0,!0);fs.readFile(u,function(n,o){return n?r.throw404():(o=framework.translator(e.$language,o.toString(ENCODING)),!t||"html"!==e.extension&&"htm"!==e.extension||(o=framework_internal.compile_html(o,u)),RELEASE&&(framework.temporary.other[i]=o),void framework.responseContent(e,r,200,o,framework_utils.getContentType(e.extension),!0))})},r),n},Framework.prototype.error=function(e,r,t){if(!arguments.length)return function(e){e&&framework.error(e,r,t)};if(!e)return this;var n=this;return n.errors&&(n.errors.push({error:e.stack,name:r,url:t?parser.format(t):null,date:new Date}),n.errors.length>50&&n.errors.shift()),n.onError(e,r,t),n},Framework.prototype.problem=function(e,r,t,n){var o=this;o.emit("problem",e,r,t,n),e instanceof framework_builders.ErrorBuilder?e=e.plain():"object"===("undefined"==typeof e?"undefined":_typeof(e))&&(e=JSON.stringify(e));var i={message:e,name:r,url:t?parser.format(t):null,ip:n};return o.logger("problems",i.message,"url: "+i.url,"controller: "+i.name,"ip: "+i.ip),o.problems?(o.problems.push(i),o.problems.length>50&&o.problems.shift(),o):o},Framework.prototype.change=function(e,r,t,n){var o=this;o.emit("change",e,r,t,n),e instanceof framework_builders.ErrorBuilder?e=e.plain():"object"===("undefined"==typeof e?"undefined":_typeof(e))&&(e=JSON.stringify(e));var i={message:e,name:r,url:t?parser.format(t):null,ip:n};return o.logger("changes",i.message,"url: "+i.url,"controller: "+i.name,"ip: "+i.ip),o.changes?(o.changes.push(i),o.changes.length>50&&o.changes.shift(),o):o},Framework.prototype.trace=function(e,r,t,n){var o=this;if(!o.config.trace)return o;o.emit("trace",e,r,t,n),e instanceof framework_builders.ErrorBuilder?e=e.plain():"object"===("undefined"==typeof e?"undefined":_typeof(e))&&(e=JSON.stringify(e));var i={message:e,name:r,url:t?parser.format(t):null,ip:n};return o.logger("traces",i.message,"url: "+i.url,"controller: "+i.name,"ip: "+i.ip),o.traces?(o.traces.push(i),o.traces.length>50&&o.traces.shift(),o):o},Framework.prototype.module=function(e){return this.modules[e]||null},Framework.prototype.modify=function(e){var r=this;return r.modificators||(r.modificators=[]),r.modificators.push(e),r},Framework.prototype.$load=function(e,r){function t(e,r,n,o,s){existsSync(i)&&(o||(o=".js"),fs.readdirSync(e).forEach(function(a){var u=fs.statSync(path.join(e,a)).isDirectory();if(u&&s)return void n.push({name:a});if(u){if(".package"===o&&a.endsWith(o)){var c=a.substring(0,a.length-o.length);return void n.push({name:"/"===c[0]?c.substring(1):c,filename:path.join(i,a),is:!0})}return r++,void t(path.join(e,a),r,n,o)}var l=framework_utils.getExtension(a).toLowerCase();if(l&&(l="."+l),l===o){var c=(r?framework_utils.$normalize(e).replace(i,"")+"/":"")+a.substring(0,a.length-l.length);n.push({name:"/"===c[0]?c.substring(1):c,filename:path.join(i,c)+o})}}))}var n=this,o=[],i="";if(r||(r=directory),r="~"+r,e&&-1===e.indexOf("modules")||(i=framework_utils.combine(r,n.config["directory-modules"]),o=[],t(i,0,o,".js"),o.forEach(function(e){return n.install("module",e.name,e.filename,void 0,void 0,void 0,!0)})),e&&-1===e.indexOf("isomorphic")||(i=framework_utils.combine(r,n.config["directory-isomorphic"]),o=[],t(i,0,o,".js"),o.forEach(function(e){return n.install("isomorphic",e.name,e.filename,void 0,void 0,void 0,!0)})),!e||-1!==e.indexOf("packages")){i=framework_utils.combine(r,n.config["directory-packages"]),o=[],t(i,0,o,".package");var s=framework_utils.$normalize(i);o.forEach(function(e){return e.is?void framework_utils.ls(e.filename,function(r,t){var o=framework.path.temp(e.name)+".package";existsSync(o)||fs.mkdirSync(o);for(var i=0,a=t.length;a>i;i++){var u=framework.path.temp(framework_utils.$normalize(t[i]).replace(s,"")+"/");existsSync(u)||fs.mkdirSync(u)}r.wait(function(r,t){var n=fs.createReadStream(r);n.pipe(fs.createWriteStream(path.join(o,r.replace(e.filename,"").replace(/\.package$/i,"")))),n.on("end",t)},function(){setTimeout(function(){return n.install("package2",e.name,e.filename,void 0,void 0,void 0,!0)},50)})}):void n.install("package",e.name,e.filename,void 0,void 0,void 0,!0)})}return e&&-1===e.indexOf("models")||(i=framework_utils.combine(r,n.config["directory-models"]),o=[],t(i,0,o),o.forEach(function(e){return n.install("model",e.name,e.filename,void 0,void 0,void 0,!0)})),e&&-1===e.indexOf("themes")||(o=[],i=framework_utils.combine(r,n.config["directory-themes"]),t(i,0,o,void 0,!0),o.forEach(function(e){var r=e.name,t=path.join(i,r),o=path.join(t,"index.js");n.themes[e.name]=framework_utils.path(t),n._length_themes++,existsSync(o)&&n.install("theme",e.name,o,void 0,void 0,void 0,!0)})),e&&-1===e.indexOf("definitions")||(i=framework_utils.combine(r,n.config["directory-definitions"]),o=[],t(i,0,o),o.forEach(function(e){return n.install("definition",e.name,e.filename,void 0,void 0,void 0,!0)})),e&&-1===e.indexOf("controllers")||(o=[],i=framework_utils.combine(r,n.config["directory-controllers"]),t(i,0,o),o.forEach(function(e){return n.install("controller",e.name,e.filename,void 0,void 0,void 0,!0)})),n._routesSort(),e&&-1===e.indexOf("dependencies")||n._configure_dependencies(),n},Framework.prototype.$startup=function(e){var r=path.join(directory,"/startup/");if(!existsSync(r))return e();var t=[];return fs.readdirSync(r).forEach(function(e){var r=framework_utils.getExtension(e).toLowerCase();"js"===r&&t.push(e)}),t.length?(t.wait(function(e,t){var n=r+e+(new Date).format("yyMMdd_HHmmss");fs.renameSync(r+e,n);var o=child.fork(n,[],{cwd:directory});o.on("exit",function(){o=null,t()})},e),this):e()},Framework.prototype.install=function(type,name,declaration,options,callback,internal,useRequired,skipEmit){var self=this,obj=null;"config"!==type&&"version"!==type&&"string"==typeof name&&(name.startsWith("http://")||name.startsWith("https://")?"object"===("undefined"==typeof declaration?"undefined":_typeof(declaration))&&(callback=options,options=declaration,declaration=name,name=""):"@"===name[0]&&(declaration=framework.path["package"](name.substring(1)),name=path.basename(name).replace(/\.js$/i,""),void 0===useRequired&&(useRequired=!0)));var t="undefined"==typeof declaration?"undefined":_typeof(declaration),key="",tmp;if("object"===t&&(t="undefined"==typeof options?"undefined":_typeof(options),"function"===t&&(callback=options),options=declaration,declaration=void 0),void 0===declaration&&(declaration=name,name=""),"string"==typeof declaration){if(declaration.startsWith("http://")||declaration.startsWith("https://"))return"package"===type?(framework_utils.download(declaration,["get"],function(e,r){if(e)return self.error(e,"framework.install('{0}', '{1}')".format(type,declaration),null),void(callback&&callback(e));var t=path.basename(declaration,".package"),n=framework.path.temp(t+".package"),o=fs.createWriteStream(n);r.pipe(o),o.on("finish",function(){return self.install(type,t,n,options,void 0,void 0,!0)})}),self):(framework_utils.request(declaration,["get"],function(e,r,t){return 200===t||e||(e=new Error(r)),e?(self.error(e,"framework.install('{0}', '{1}')".format(type,declaration),null),void(callback&&callback(e))):void self.install(type,name,r,options,callback,declaration)}),self);if("~"===declaration[0]&&(declaration=declaration.substring(1)),"config"!==type&&"resource"!==type&&"package"!==type&&!REG_SCRIPTCONTENT.test(declaration)){if(!existsSync(declaration))throw new Error("The "+type+": "+declaration+" doesn't exist.");useRequired=!0}}if("middleware"===type)return self.routes.middleware[name]="function"==typeof declaration?declaration:eval(declaration),self._length_middleware=Object.keys(self.routes.middleware).length,callback&&callback(null),key=type+"."+name,self.dependencies[key]?self.dependencies[key].updated=new Date:(self.dependencies[key]={name:name,type:type,installed:new Date,updated:null,count:0},internal&&(self.dependencies[key].url=internal)),self.dependencies[key].count++,setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),self;if("config"===type||"configuration"===type||"settings"===type)return self._configure(declaration instanceof Array?declaration:declaration.toString().split("\n"),!0),setTimeout(function(){delete self.temporary["mail-settings"],self.emit(type+"#"+name,framework.config),self.emit("install",type,name)},500),callback&&callback(null),self;if("version"===type||"versions"===type)return self._configure_versions(declaration.toString().split("\n")),setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(null),self;if("sitemap"===type)return self._configure_sitemap(declaration.toString().split("\n")),setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(null),self;if("package"===type){var backup=new Backup,id=path.basename(declaration,".package"),dir=path.join(framework.path.root(),framework.config["directory-temp"],id+".package");return self.routes.packages[id]=dir,backup.restore(declaration,dir,function(){var e=path.join(dir,"index.js");existsSync(e)&&self.install("module",id,e,options,function(e){setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(e)},internal,useRequired,!0)}),self}if("theme"===type)return obj=require(declaration),"function"==typeof obj.install&&obj.install(options,name),skipEmit||setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(null),function(e,r){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration),declaration),self;if("package2"===type){var id=framework_utils.getName(declaration,".package"),dir=path.join(framework.path.root(),framework.config["directory-temp"],id),filename=path.join(dir,"index.js");return self.install("module",id,filename,options,function(e){setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(e)},internal,useRequired,!0),self}var plus=self.id?"i-"+self.id+"_":"";if("view"===type){var item=self.routes.views[name];return key=type+"."+name,void 0===item&&(item={},item.filename=self.path.temporary(plus+"installed-view-"+framework_utils.GUID(10)+".tmp"),item.url=internal,item.count=0,self.routes.views[name]=item),item.count++,fs.writeFileSync(item.filename,framework_internal.modificator(declaration,name)),setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(null),self}if("definition"===type||"eval"===type){_controller="";try{useRequired?(delete require.cache[require.resolve(declaration)],obj=require(declaration),function(e){setTimeout(function(){return delete require.cache[e]},1e3)}(require.resolve(declaration))):obj="function"==typeof declaration?eval("("+declaration.toString()+")()"):eval(declaration)}catch(ex){return self.error(ex,"framework.install('"+type+"')",null),callback&&callback(ex),self}return callback&&callback(null),setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),self}if("isomorphic"===type){var content="";try{if(!name&&"string"==typeof internal){var tmp=internal.match(/[a-z0-9]+\.js$/i);tmp&&(name=tmp.toString().replace(/\.js/i,""))}useRequired?(delete require.cache[require.resolve(declaration)],obj=require(declaration),content=fs.readFileSync(declaration).toString(ENCODING),function(e){setTimeout(function(){return delete require.cache[e]},1e3)}(require.resolve(declaration))):(obj="function"==typeof declaration?eval("("+declaration.toString()+")()"):eval(declaration),content=declaration.toString())}catch(ex){return self.error(ex,"framework.install('"+type+"')",null),callback&&callback(ex),self}return"string"==typeof obj.id?name=obj.id:"string"==typeof obj.name&&(name=obj.name),obj.url&&framework.map(framework_internal.preparePath(obj.url),"#"+name),framework.isomorphic[name]=obj,framework.isomorphic[name].$$output=framework_internal.compile_javascript(content,"#"+name),callback&&callback(null),setTimeout(function(){self.emit(type+"#"+name,obj),self.emit("install",type,name,obj)},500),self}if("model"===type||"source"===type){_controller="";try{if(useRequired)obj=require(declaration),function(e){setTimeout(function(){return delete require.cache[e]},1e3)}(require.resolve(declaration));else{if("string"!=typeof declaration&&(declaration=declaration.toString()),!name&&"string"==typeof internal){var tmp=internal.match(/[a-z0-9]+\.js$/i);tmp&&(name=tmp.toString().replace(/\.js/i,""))}var filename=self.path.temporary(plus+"installed-"+type+"-"+framework_utils.GUID(10)+".js");fs.writeFileSync(filename,declaration),obj=require(filename),function(e,r){setTimeout(function(){fs.unlinkSync(r),delete require.cache[e]},1e3)}(require.resolve(filename),filename)}}catch(ex){return self.error(ex,"framework.install('"+type+"', '"+name+"')",null),callback&&callback(ex),self}return"string"==typeof obj.id?name=obj.id:"string"==typeof obj.name&&(name=obj.name),name||(name=1e4*Math.random()>>0),key=type+"."+name,tmp=self.dependencies[key],self.uninstall(type,name),tmp?(self.dependencies[key]=tmp,self.dependencies[key].updated=new Date):(self.dependencies[key]={name:name,type:type,installed:new Date,updated:null,count:0},internal&&(self.dependencies[key].url=internal)),self.dependencies[key].count++,obj.reinstall?self.dependencies[key].reinstall=obj.reinstall.toString().parseDateExpiration():delete self.dependencies[key],"model"===type?self.models[name]=obj:self.sources[name]=obj,"function"==typeof obj.install&&obj.install(options,name),skipEmit||setTimeout(function(){self.emit(type+"#"+name,obj),self.emit("install",type,name,obj)},500),callback&&callback(null),self}if("module"===type||"controller"===type){var _ID=_controller="TMP"+framework_utils.random(1e4);try{if(useRequired)obj=require(declaration),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration));else{if("string"!=typeof declaration&&(declaration=declaration.toString()),!name&&"string"==typeof internal){var tmp=internal.match(/[a-z0-9]+\.js$/i);tmp&&(name=tmp.toString().replace(/\.js/i,""))}filename=self.path.temporary(plus+"installed-"+type+"-"+framework_utils.GUID(10)+".js"),fs.writeFileSync(filename,declaration),obj=require(filename),function(e,r){setTimeout(function(){fs.unlinkSync(r),delete require.cache[e]},1e3)}(require.resolve(filename),filename)}}catch(ex){return self.error(ex,"framework.install('"+type+"', '"+(name?"":internal)+"')",null),callback&&callback(ex),self}if("string"==typeof obj.id?name=obj.id:"string"==typeof obj.name&&(name=obj.name),name||(name=1e4*Math.random()>>0),obj.booting&&setTimeout(function(){var e=framework.path.temp(name+"/");"root"===obj.booting?(framework.directory=directory=e,framework.temporary.path={},framework._configure(),framework._configure_versions(),framework._configure_dependencies(),framework._configure_sitemap()):(framework._configure("@"+name+"/config"),framework.config.debug?framework._configure("@"+name+"/config-debug"):framework._configure("@"+name+"/config-release"),framework.isTest&&framework._configure("@"+name+"/config-test"),framework._configure_versions("@"+name+"/versions"),framework._configure_dependencies("@"+name+"/dependencies"),framework._configure_sitemap("@"+name+"/sitemap")),framework.$load(void 0,e)},100),key=type+"."+name,tmp=self.dependencies[key],self.uninstall(type,name),tmp?(self.dependencies[key]=tmp,self.dependencies[key].updated=new Date):(self.dependencies[key]={
name:name,type:type,installed:new Date,updated:null,count:0,_id:_ID},internal&&(self.dependencies[key].url=internal)),self.dependencies[key].dependencies=obj.dependencies,self.dependencies[key].count++,self.dependencies[key].processed=!1,obj.reinstall?self.dependencies[key].reinstall=obj.reinstall.toString().parseDateExpiration():delete self.dependencies[key].reinstall,_controller=_ID,obj.dependencies instanceof Array)for(var i=0,length=obj.dependencies.length;length>i;i++)if(!self.dependencies[type+"."+obj.dependencies[i]])return self.temporary.dependencies[key]={obj:obj,options:options,callback:callback,skipEmit:skipEmit},self;return self.install_make(key,name,obj,options,callback,skipEmit),"module"===type?self.modules[name]=obj:self.controllers[name]=obj,self.install_prepare(),self}return self},Framework.prototype.restart=function(){var e=this;return e.isRestart?e:(F.emit("restart"),setTimeout(function(){return e.$restart()},1e3),e)},Framework.prototype.$restart=function(){var e=this;return console.log("----------------------------------------------------> RESTART "+(new Date).format("yyyy-MM-dd HH:mm:ss")),e.server.setTimeout(0),e.server.timeout=0,e.server.close(function(){Object.keys(e.modules).forEach(function(r){var t=e.modules[r];t&&t.uninstall&&t.uninstall()}),Object.keys(e.models).forEach(function(r){var t=e.models[r];t&&t.uninstall&&t.uninstall()}),Object.keys(e.controllers).forEach(function(r){var t=e.controllers[r];t&&t.uninstall&&t.uninstall()}),Object.keys(e.workers).forEach(function(r){var t=e.workers[r];t&&t.kill&&(t.removeAllListeners(),t.kill("SIGTERM"))}),Object.keys(e.connections).forEach(function(r){var t=e.connections[r];t&&(t.removeAllListeners(),t.close())}),framework_builders.restart(),framework_image.restart(),framework_mail.restart(),framework_utils.restart(),e.cache.clear(),e.cache.stop(),e.global={},e.resources={},e.connections={},e.functions={},e.themes={},e.versions=null,e.schedules=[],e.isLoaded=!1,e.isRestart=!1,e.routes={sitemap:null,web:[],files:[],cors:[],websockets:[],middleware:{},redirects:{},resize:{},request:[],views:{},merge:{},mapping:{},packages:{},blocks:{},resources:{}},e.behaviours=null,e.modificators=null,e.helpers={},e.modules={},e.models={},e.sources={},e.controllers={},e.dependencies={},e.isomorphic={},e.tests=[],e.errors=[],e.problems=[],e.changes=[],e.workers={},e.databases={},e._request_check_redirect=!1,e._request_check_referer=!1,e._request_check_POST=!1,e._request_check_robot=!1,e._length_middleware=0,e._length_request_middleware=0,e._length_files=0,e._length_wait=0,e._length_themes=0,e._length_cors=0,e._length_subdomain_web=0,e._length_subdomain_websocket=0,e.isVirtualDirectory=!1,e.isTheme=!1,e.stats.other.restart++,setTimeout(function(){return e.removeAllListeners()},2e3),setTimeout(function(){var r=e.temporary.init;e.mode(r.isHTTPS?require("https"):http,r.name,r.options)},1e3)}),e},Framework.prototype.install_prepare=function(e){var r=this,t=Object.keys(r.temporary.dependencies);if(t.length){for(var n=0,o=t.length;o>n;n++){var i=t[n],s=r.temporary.dependencies[i],a=r.dependencies[i],u=!1;if(!a.processed){for(var c=0,l=a.dependencies.length;l>c;c++){var f=r.dependencies["module."+a.dependencies[c]];if(!f||!f.processed){u=!0;break}}u||(delete r.temporary.dependencies[i],"module"===a.type?r.modules[a.name]=s.obj:r.controllers[a.name]=s.obj,r.install_make(i,a.name,s.obj,s.options,s.callback,s.skipEmit))}}return t=Object.keys(r.temporary.dependencies),clearTimeout(r.temporary.other.dependencies),r.temporary.other.dependencies=setTimeout(function(){var e=Object.keys(framework.temporary.dependencies);if(e.length)throw new Error("Dependency exception (module): missing dependencies for: "+e.join(", ").trim());delete r.temporary.other.dependencies},1500),t.length?e?r:(r.install_prepare(!0),r):r}},Framework.prototype.install_make=function(e,r,t,n,o,i){var s=this,a=s.dependencies[e],u=a._id,c=a.type;s.temporary.internal[a._id]=r,_controller=u,"function"==typeof t.install&&t.install(n,r),a.processed=!0;for(var l=("module"===c?"#":"")+r,f=s.routes.web.length,p=0;f>p;p++)s.routes.web[p].controller===u&&(s.routes.web[p].controller=l);f=s.routes.websockets.length;for(var p=0;f>p;p++)s.routes.websockets[p].controller===u&&(s.routes.websockets[p].controller=l);f=s.routes.files.length;for(var p=0;f>p;p++)s.routes.files[p].controller===u&&(s.routes.files[p].controller=l);return s._routesSort(),_controller="",i||setTimeout(function(){s.emit(c+"#"+r,t),s.emit("install",c,r,t)},500),o&&o(null),s},Framework.prototype.uninstall=function(e,r,t,n){var o=this,i=null;if("schema"===e)return framework_builders.remove(r),o.emit("uninstall",e,r),o;if("mapping"===e)return delete o.routes.mapping[r],o.emit("uninstall",e,r),o;if("isomorphic"===e){var i=o.isomorphic[r];return i.url&&delete o.routes.mapping[o._version(i.url)],delete o.isomorphic[r],o.emit("uninstall",e,r),o}if("middleware"===e)return o.routes.middleware[r]?(delete o.routes.middleware[r],delete o.dependencies[e+"."+r],o._length_middleware=Object.keys(o.routes.middleware).length,o.emit("uninstall",e,r),o):o;if("package"===e)return delete o.routes.packages[r],o.uninstall("module",r,t,!0),o;if("view"===e||"precompile"===e)return(i=o.routes.views[r])?(delete o.routes.views[r],delete o.dependencies[e+"."+r],fsFileExists(i.filename,function(e){e&&fs.unlink(i.filename)}),o.emit("uninstall",e,r),o):o;if("model"===e||"source"===e)return(i="model"===e?o.models[r]:o.sources[r])?(i.id&&delete require.cache[require.resolve(i.id)],"function"==typeof i.uninstall&&(framework.config["allow-compatibility"]?i.uninstall(o,t,r):i.uninstall(t,r)),"model"===e?delete o.models[r]:delete o.sources[r],delete o.dependencies[e+"."+r],o._routesSort(),o.emit("uninstall",e,r),o):o;if("module"===e||"controller"===e){var s="module"===e;if(i=s?o.modules[r]:o.controllers[r],!i)return o;i.id&&delete require.cache[require.resolve(i.id)];var a=(s?"#":"")+r;return o.routes.web=o.routes.web.remove("controller",a),o.routes.files=o.routes.files.remove("controller",a),o.routes.websockets=o.routes.websockets.remove("controller",a),i&&(i.uninstall&&(framework.config["allow-compatibility"]?i.uninstall(o,t,r):i.uninstall(t,r)),s?delete o.modules[r]:delete o.controllers[r]),o._routesSort(),delete o.dependencies[e+"."+r],n||o.emit("uninstall",e,r),o}return o},Framework.prototype.register=function(e){var r,t="."+framework_utils.getExtension(e),n=this,o=framework_utils.getName(e),i=e[0];switch("@"===i?e=framework.path["package"](e.substring(1)):"="===i&&("?"===e[1]?framework.path.themes(framework.config["default-theme"]+e.substring(2)):e=framework.path.themes(e.substring(1))),t){case".resource":r=o.replace(t,""),n.routes.resources[r]?n.routes.resources[r].push(e):n.routes.resources[r]=[e],delete n.resources[r];break;default:throw new Error('Not supported registration type "'+t+'".')}return n},Framework.prototype.eval=function(e){return this.install("eval",e)},Framework.prototype.onError=function(e,r,t){return console.log("======= "+(new Date).format("yyyy-MM-dd HH:mm:ss")+": "+(r?r+" ---> ":"")+e.toString()+(t?" ("+parser.format(t)+")":""),e.stack),this},Framework.prototype.onAuthorize=null,Framework.prototype.onLocate=null,Framework.prototype.onTheme=null,Framework.prototype.onVersion=null,Framework.prototype.onMapping=function(e,r,t,n){if("/"!==e[0]&&(e="/"+e),this._length_themes){var o=e.indexOf("/",1);if(-1!==o){var i=e.substring(1,o);if(this.themes[i])return this.themes[i]+"public"+e.substring(o)}}return this.routes.mapping[e]?this.routes.mapping[e]:(r=framework_internal.preparePath(r,!0),n&&(r=$decodeURIComponent(r)),r=t?framework.path.public_cache(r):"~"===r[0]?r.substring(1):"."===r[0]?r:framework.path.public_cache(r))},Framework.prototype.snapshot=function(e,r,t){var n=this;if(e=framework_internal.preparePath(e),!e.match(/^http:|https:/gi)){"/"!==e[0]&&(e="/"+e);var o="auto"===n.ip?"0.0.0.0":n.ip;e="http://"+o+":"+n.port+e}return framework_utils.download(e,["get"],function(e,n){var o=fs.createWriteStream(r);n.pipe(o),FINISHED(o,function(){DESTROY(o),t&&setImmediate(t)})}),n},Framework.prototype.findConnection=function(e){for(var r=this,t=Object.keys(r.connections),n=framework_utils.isRegExp(e),o=0,i=t.length;i>o;o++){var s=t[o];if(n){if(e.test(s))return r.connections[s]}else if(-1!==s.indexOf(e))return r.connections[s]}},Framework.prototype.findConnections=function(e){for(var r=this,t=Object.keys(r.connections),n=framework_utils.isRegExp(e),o=[],i=0,s=t.length;s>i;i++){var a=t[i];n?e.test(a)&&o.push(r.connections[a]):-1!==a.indexOf(e)&&o.push(r.connections[a])}return o},Framework.prototype.onValidate=null,Framework.prototype.onParseXML=function(e){return framework_utils.parseXML(e)},Framework.prototype.onParseJSON=function(e){return JSON.parse(e)},Framework.prototype.onParseQuery=function(e){return e?qs.parse(e):{}},Framework.prototype.onSchema=function(e,r,t,n,o){var i=GETSCHEMA(r,t);return i?void i.make(e.body,function(e,r){e?n(e):n(null,r)},o):void n(new Error("Schema not found."))},Framework.prototype.onMail=function(e,r,t,n,o){var i;"string"==typeof n&&(i=o,o=n,n=i);var s=Mail.create(r,t);if(e instanceof Array)for(var a=0,u=e.length;u>a;a++)s.to(e[a]);else s.to(e);var c=this;s.from(c.config["mail.address.from"]||"",c.config.name),i=c.config["mail.address.reply"],o?s.reply(o):i&&i.isEmail()&&s.reply(c.config["mail.address.reply"]),i=c.config["mail.address.copy"],i&&i.isEmail()&&s.bcc(i);var l=c.temporary["mail-settings"];if(!l){var f=c.config["mail.smtp.options"];if(f){var p="undefined"==typeof f?"undefined":_typeof(f);"string"===p?l=f.parseJSON():"object"===p&&(l=f)}l||(l={}),c.temporary["mail-settings"]=l}return s.$sending=setTimeout(function(){return s.send(c.config["mail.smtp"],l,n)},5),s},Framework.prototype.onMeta=function(){for(var e=this,r="",t=arguments.length,n=0;t>n;n++){var o=framework_utils.encode(arguments[n]);if(null!==o&&o.length)switch(n){case 0:r+="<title>"+(o+("/"===e.url||e.config["allow-custom-titles"]?"":" - "+e.config.name))+"</title>";break;case 1:r+='<meta name="description" content="'+o+'" />';break;case 2:r+='<meta name="keywords" content="'+o+'" />';break;case 3:var i=o.substring(0,6),s="http:/"===i||"https:"===i||"//"===o.substring(0,2)?o:e.hostname(e.routeImage(o));r+='<meta property="og:image" content="'+s+'" /><meta name="twitter:image" content="'+s+'" />'}}return r},Framework.prototype.log=function(){for(var e=this,r=new Date,t=r.getFullYear()+"-"+(r.getMonth()+1).toString().padLeft(2,"0")+"-"+r.getDate().toString().padLeft(2,"0"),n=r.getHours().toString().padLeft(2,"0")+":"+r.getMinutes().toString().padLeft(2,"0")+":"+r.getSeconds().toString().padLeft(2,"0"),o="",i=arguments.length,s=0;i>s;s++){var a=arguments[s];void 0===a?a="undefined":null===a?a="null":"object"===("undefined"==typeof a?"undefined":_typeof(a))&&(a=util.inspect(a)),o+=(o?" ":"")+a}return e.path.verify("logs"),framework_utils.queue("framework.log",5,function(r){return fs.appendFile(framework_utils.combine(e.config["directory-logs"],t+".log"),n+" | "+o+"\n",r)}),e},Framework.prototype.logger=function(){for(var e=arguments,r=this,t=new Date,n=t.getFullYear()+"-"+(t.getMonth()+1).toString().padLeft(2,"0")+"-"+t.getDate().toString().padLeft(2,"0")+" "+t.getHours().toString().padLeft(2,"0")+":"+t.getMinutes().toString().padLeft(2,"0")+":"+t.getSeconds().toString().padLeft(2,"0"),o="",i=arguments.length,s=1;i>s;s++){var a=arguments[s];void 0===a?a="undefined":null===a?a="null":"object"===("undefined"==typeof a?"undefined":_typeof(a))&&(a=util.inspect(a)),o+=(o?" ":"")+a}return r.path.verify("logs"),framework_utils.queue("framework.logger",5,function(t){return fs.appendFile(framework_utils.combine(r.config["directory-logs"],e[0]+".log"),n+" | "+o+"\n",t)}),r},Framework.prototype.logmail=function(e,r,t,n){("undefined"==typeof t?"undefined":_typeof(t))===FUNCTION?(n=t,t=r,r=null):void 0===t&&(t=r,r=null),r||(r=framework.config.name+" v"+framework.config.version);var t="<!DOCTYPE html><html><head><title>"+r+'</title><meta charset="utf-8" /></head><body><pre style="max-width:600px;font-size:13px;line-height:16px">'+("object"===("undefined"==typeof t?"undefined":_typeof(t))?JSON.stringify(t).escape():t)+"</pre></body></html>";return framework.onMail(e,r,t,n)},Framework.prototype.usage=function(e){var r=this,t=process.memoryUsage(),n=Object.keys(r.cache.items),o=Object.keys(r.resources),i=Object.keys(r.controllers),s=Object.keys(r.connections),a=Object.keys(r.workers),u=Object.keys(r.modules),c=Object.keys(r.isomorphic),l=Object.keys(r.models),f=Object.keys(r.helpers),p=Object.keys(r.temporary.path),d=Object.keys(r.temporary.range),m=Object.keys(r.routes.redirects),h={};h.framework={pid:process.pid,node:process.version,version:"v"+r.version_header,platform:process.platform,processor:process.arch,uptime:Math.floor(process.uptime()/60),memoryTotal:(t.heapTotal/1024/1024).floor(2),memoryUsage:(t.heapUsed/1024/1024).floor(2),mode:r.config.debug?"debug":"release",port:r.port,ip:r.ip,directory:process.cwd()};for(var g=Object.keys(framework_utils.queuecache),v=0,y=0,b=g.length;b>y;y++)v+=framework_utils.queuecache[g[y]].pending.length;return h.counter={resource:o.length,controller:i.length,module:u.length,isomorphic:c.length,cache:n.length,worker:a.length,connection:s.length,schedule:r.schedules.length,helpers:f.length,error:r.errors.length,problem:r.problems.length,queue:v,files:p.length,streaming:d.length,modificator:r.modificators?r.modificators.length:0},h.routing={webpage:r.routes.web.length,sitemap:r.routes.sitemap?Object.keys(r.routes.sitemap).length:0,websocket:r.routes.websockets.length,file:r.routes.files.length,middleware:Object.keys(r.routes.middleware).length,redirect:m.length},h.stats=r.stats,h.redirects=m,r.restrictions.is&&(h.restrictions={allowed:[],blocked:[],allowedHeaders:r.restrictions.allowedCustomKeys,blockedHeaders:r.restrictions.blockedCustomKeys}),e?(h.controllers=[],i.forEach(function(e){var t=r.controllers[e];h.controllers.push({name:e,usage:void 0===t.usage?null:t.usage()})}),h.connections=[],s.forEach(function(e){h.connections.push({name:e,online:r.connections[e].online})}),h.modules=[],u.forEach(function(e){var t=r.modules[e];h.modules.push({name:e,usage:void 0===t.usage?null:t.usage()})}),h.models=[],l.forEach(function(e){var t=r.models[e];h.models.push({name:e,usage:void 0===t.usage?null:t.usage()})}),h.helpers=f,h.cache=n,h.resources=o,h.errors=r.errors,h.problems=r.problems,h.changes=r.changes,h.traces=r.traces,h.files=p,h.streaming=d,h.other=Object.keys(r.temporary.other),h):h},Framework.prototype.onCompileView=function(e,r,t){return r},Framework.prototype.onCompileStyle=null,Framework.prototype.onCompileScript=null,Framework.prototype.compileContent=function(e,r,t){var n=this;if(t&&(-1!==t.indexOf(".min.")||-1!==t.indexOf("-min.")))return r;switch(e){case"js":return n.config["allow-compile-script"]?framework_internal.compile_javascript(r,t):r;case"css":r=n.config["allow-compile-style"]?framework_internal.compile_css(r,t):r;var o=r.match(REG_COMPILECSS);return o?(o.forEach(function(e){var t=e.substring(4,e.length-1);r=r.replace(e,"url("+n._version(t)+")")}),r):r}return r},Framework.prototype.compileFile=function(e,r,t,n,o){var i=this;return fsFileRead(t,function(s,a){if(s)return i.error(s,t,e),i.temporary.path[r]=null,void o();var u=i.path.temp((i.id?"i-"+i.id+"_":"")+createTemporaryKey(e.pathname));i.path.verify("temp"),fs.writeFileSync(u,i.compileContent(n,framework_internal.parseBlock(i.routes.blocks[e.pathname],a.toString(ENCODING)),t),ENCODING),i.temporary.path[r]=u+";"+fs.statSync(u).size,o()}),i},Framework.prototype.compileMerge=function(e,r,t,n){var o=this,i=o.routes.merge[e.pathname],s=i.filename;if(!o.config.debug&&existsSync(s))return o.temporary.path[r]=s+";"+fs.statSync(s).size,n(),o;var a=fs.createWriteStream(s);a.on("finish",function(){o.temporary.path[r]=s+";"+fs.statSync(s).size,n()});var u,c=0;return i.files.wait(function(r,n){var s;if("#"!==r[0]){var l=r.split("#");s=l[1],s&&(r=l[0])}if(r.startsWith("http://")||r.startsWith("https://"))return void framework_utils.request(r,["get"],function(e,i){var u=o.compileContent(t,framework_internal.parseBlock(s,i),r);"js"===t?";"!==u[u.length-1]&&(u+=";"):"html"===t&&u[u.length-1]!==NEWLINE&&(u+=NEWLINE),framework.isDebug&&merge_debug_writer(a,r,t,c++,s),a.write(u),n()});if("#"===r[0])return framework.isDebug&&merge_debug_writer(a,r,"js",c++,s),a.write(prepare_isomorphic(r.substring(1))),void n();if("~"!==r[0]){var f=o.path["public"](r);o.isVirtualDirectory&&!existsSync(f)&&(f=o.path.virtual(r)),r=f}else r=r.substring(1);var p=r.indexOf("*");if(-1!==p){var f=r.substring(p+1).toLowerCase(),d=f.length;return u||(u=[]),u.push(arguments[0]),void framework_utils.ls(r.substring(0,p),function(e,r){for(var t=0,o=e.length;o>t;t++)i.files.push("~"+e[t]);n()},function(e,r){return r?!0:e.substring(e.length-d).toLowerCase()===f})}fsFileRead(r,function(u,l){if(u)return o.error(u,i.filename,e),void n();var f=o.compileContent(t,framework_internal.parseBlock(s,l.toString(ENCODING)),r);"js"===t?";"!==f[f.length-1]&&(f+=";"):"html"===t&&f[f.length-1]!==NEWLINE&&(f+=NEWLINE),framework.isDebug&&merge_debug_writer(a,r,t,c++,s),a.write(f),n()})},function(){if(a.end(),u)for(var e=0,r=u.length;r>e;e++)i.files.splice(i.files.indexOf(u[e]),1)}),o},Framework.prototype.compileValidation=function(e,r,t,n,o){var i=this;return i.routes.merge[e.pathname]?(i.compileMerge(e,r,n,o),i):(fsFileExists(t,function(s,a){return s?"js"!==n&&"css"!==n||-1!==t.lastIndexOf(".min.")||-1!==t.lastIndexOf("-min.")?(i.temporary.path[r]=t+";"+a,void o()):(i.compileFile(e,r,t,n,o),i):i.isVirtualDirectory?void i.compileValidationVirtual(e,r,t,n,o):(i.temporary.path[r]=null,void o())}),i)},Framework.prototype.compileValidationVirtual=function(e,r,t,n,o){var i=this,s=t.replace(i.config["directory-public"],i.config["directory-public-virtual"]);return s===t?(i.temporary.path[r]=null,void o()):(t=s,void fsFileExists(t,function(s,a){return s?"js"!==n&&"css"!==n||-1!==t.lastIndexOf(".min.")||-1!==t.lastIndexOf("-min.")?(i.temporary.path[r]=t+";"+a,void o()):(i.compileFile(e,r,t,n,o),i):(i.temporary.path[r]=null,void o())}))},Framework.prototype.responseStatic=function(e,r,t){var n=this;if(r.success||r.headersSent)return t&&t(),n;if(!n.config["static-accepts"]["."+e.extension])return n.response404(e,r),t&&t(),n;var o,i=e.uri.pathname,s=i.lastIndexOf("/"),a=n.routes.resize[i.substring(0,s+1)]||null,u=!1;if(a?(i=i.substring(s+1),s=i.lastIndexOf("."),u=a.extension["*"]||a.extension[i.substring(s).toLowerCase()],u?(i=a.path+$decodeURIComponent(i),o=n.onMapping(i,i,!1,!1)):o=n.onMapping(i,i,!0,!0)):o=n.onMapping(i,i,!0,!0),!u){if("#"!==o[0])return n.responseFile(e,r,o,void 0,void 0,t),n;var c=o.substring(1),l=n.isomorphic[c];if(!l)return n.response404(e,r),void(t&&t());var f=framework_utils.etag(o,(l.version||"")+"-"+(n.config["etag-version"]||""));if(RELEASE&&n.notModified(e,r,f))return void(t&&t());var p={};return RELEASE&&(p.Etag=f,p.Expires=DATE_EXPIRES,p[RESPONSE_HEADER_CACHECONTROL]="public, max-age="+n.config["default-response-maxage"]),n.responseContent(e,r,200,prepare_isomorphic(c),"text/javascript",!0,p),t&&t(),n}if(!a.ishttp){var d=a.cache?n.responseImage:n.responseImageWithoutCache;return void d.call(n,e,r,o,function(e){return a.fn.call(e,e)},void 0,t)}if(n.temporary.processing[e.uri.pathname])return void setTimeout(function(){return n.responseStatic(e,r,t)},500);var c=createTemporaryKey(e),m=n.path.temp(c);return n.temporary.path[c]?(n.responseFile(e,r,e.uri.pathname,void 0,void 0,t),n):(n.temporary.processing[e.uri.pathname]=!0,framework_utils.download(i,["get","dnscache"],function(o,i){var s=fs.createWriteStream(m);i.pipe(s),CLEANUP(s,function(){delete n.temporary.processing[e.uri.pathname];var o=i.headers["content-type"];if(200!==i.statusCode||!o||!o.startsWith("image/"))return n.response404(e,r),void(t&&t());var s=a.cache?n.responseImage:n.responseImageWithoutCache;s.call(n,e,r,m,function(e){return a.fn.call(e,e)},void 0,t)})}),n)},Framework.prototype.restore=function(e,r,t,n){var o=new Backup;o.restore(e,r,t,n)},Framework.prototype.backup=function(e,r,t,n){var o=r.length,i=120;return framework_utils.ls(r,function(r,s){s.wait(function(r,t){var s=r.substring(o).replace(/\\/g,"/")+"/";return n&&!n(s)?t():void fs.appendFile(e,s.padRight(i)+":#\n",t)},function(){r.wait(function(r,t){var s=r.substring(o).replace(/\\/g,"/");return n&&!n(s)?t():void fs.readFile(r,function(r,n){zlib.gzip(n,function(r,n){return r?(framework.error(r,"framework.backup()",e),t()):void fs.appendFile(e,s.padRight(i)+":"+n.toString("base64")+"\n",t)})})},t)})}),this},Framework.prototype.exists=function(e,r,t,n){"function"==typeof t&&(n=t,t=10);var o=this,i=createTemporaryKey(e),s=o.path.temp(i),a=!1;if(RELEASE){var u=framework_utils.etag(e.url,o.config["etag-version"]);e.headers["if-none-match"]===u&&(a=!0)}return o.isProcessed(i)||a?(o.responseFile(e,r,s),o):(framework_utils.queue("framework.exists",t,function(t){fsFileExists(s,function(o){return o?void framework.responseFile(e,r,s,void 0,void 0,t):void n(t,s)})}),o)},Framework.prototype.isProcessed=function(e){var r=this;if(e.url){var t=e.url,n=t.indexOf("?");-1!==n&&(t=t.substring(0,n)),e=framework.path["public"]($decodeURIComponent(t))}return void 0!==r.temporary.path[e]},Framework.prototype.isProcessing=function(e){var r=this;if(!e.url)return!!r.temporary.processing[e];var t=e.url,n=t.indexOf("?");return-1!==n&&(t=t.substring(0,n)),e=framework_utils.combine(r.config["directory-public"],$decodeURIComponent(t)),!!r.temporary.processing[e]},Framework.prototype.noCache=function(e,r){return e.noCache(),r&&r.noCache(),this},Framework.prototype.responseFile=function(e,r,t,n,o,i,s){var a=this;if(r.success||r.headersSent)return i&&i(),a;"@"===t[0]&&(t=framework.path["package"](t.substring(1))),s||(s=createTemporaryKey(e));var u=a.temporary.path[s];if(null===u)return a.config.debug&&delete a.temporary.path[s],a.response404(e,r),i&&i(),a;var c,l=framework_utils.etag(e.url,a.config["etag-version"]),f=e.extension;if(f||(s&&(f=framework_utils.getExtension(s)),!f&&u&&(f=framework_utils.getExtension(u)),!f&&t&&(f=framework_utils.getExtension(t))),!a.config.debug&&e.headers["if-none-match"]===l)return c=HEADERS["responseFile.etag"],!r.getHeader("ETag")&&l?c.ETag=l:c.ETag&&delete c.ETag,r.getHeader("Expires")?c.Expires&&delete c.Expires:c.Expires=DATE_EXPIRES,c[RESPONSE_HEADER_CONTENTTYPE]=framework_utils.getContentType(f),r.success=!0,r.writeHead(304,c),r.end(),a.stats.response.notModified++,a._request_stats(!1,e.isStaticFile),i&&i(),e.isStaticFile||a.emit("request-end",e,r),e.clear(!0),a;if(void 0===u)return a.isProcessing(s)?e.processing>a.config["default-request-timeout"]?void a.response408(e,r):(e.processing+=500,setTimeout(function(){return framework.responseFile(e,r,t,n,o,i,s)},500),a):(a.temporary.processing[s]=!0,a.compileValidation(e.uri,s,t,f,function(){delete a.temporary.processing[s],framework.responseFile(e,r,t,n,o,i,s)}),a);var p=u.lastIndexOf(";"),d=null;-1===p?p=u.length:d=u.substring(p+1),u=u.substring(0,p);var m=framework_utils.getContentType(f),h=e.headers["accept-encoding"]||"";!h&&isGZIP(e)&&(h="gzip");var g=a.config["allow-gzip"]&&REQUEST_COMPRESS_CONTENTTYPE[m]&&-1!==h.indexOf("gzip"),v=e.headers.range||"",y=RELEASE&&"text/cache-manifest"!==m;return c=y?g?v?HEADERS["responseFile.release.compress.range"]:HEADERS["responseFile.release.compress"]:v?HEADERS["responseFile.release.range"]:HEADERS["responseFile.release"]:g?v?HEADERS["responseFile.debug.compress.range"]:HEADERS["responseFile.debug.compress"]:v?HEADERS["responseFile.debug.range"]:HEADERS["responseFile.debug"],e.$mobile?c.Vary="Accept-Encoding, User-Agent":c.Vary="Accept-Encoding",c[RESPONSE_HEADER_CONTENTTYPE]=m,REG_TEXTAPPLICATION.test(m)&&(c[RESPONSE_HEADER_CONTENTTYPE]+="; charset=utf-8"),y&&!r.getHeader("Expires")?c.Expires=DATE_EXPIRES:c.Expires&&delete c.Expires,o&&(c=framework_utils.extend({},c,!0),framework_utils.extend(c,o,!0)),n?c["Content-Disposition"]='attachment; filename="'+encodeURIComponent(n)+'"':c["Content-Disposition"]&&delete c["Content-Disposition"],y&&l&&!r.getHeader("ETag")?c.Etag=l:c.Etag&&delete c.Etag,r.success=!0,v?(a.responseRange(u,v,c,e,r,i),a):(a.config.debug&&a.isProcessed(s)&&delete a.temporary.path[s],d&&"0"!==d&&!g?c[RESPONSE_HEADER_CONTENTLENGTH]=d:c[RESPONSE_HEADER_CONTENTLENGTH]&&delete c[RESPONSE_HEADER_CONTENTLENGTH],a.stats.response.file++,a._request_stats(!1,e.isStaticFile),"HEAD"===e.method?(r.writeHead(200,c),r.end(),i&&i(),e.isStaticFile||a.emit("request-end",e,r),e.clear(!0),a):g?(r.writeHead(200,c),fsStreamRead(u,void 0,function(t,n){framework_internal.onFinished(r,function(e){framework_internal.destroyStream(t),n()}),t.pipe(zlib.createGzip()).pipe(r),i&&i(),e.isStaticFile||a.emit("request-end",e,r),e.clear(!0)}),a):(r.writeHead(200,c),fsStreamRead(u,void 0,function(t,n){t.pipe(r),framework_internal.onFinished(r,function(e){framework_internal.destroyStream(t),n()}),i&&i(),e.isStaticFile||a.emit("request-end",e,r),e.clear(!0)}),a))},Framework.prototype.touch=function(e){return e?delete this.temporary.path[createTemporaryKey(e)]:this.temporary.path={},this},Framework.prototype.responsePipe=function(e,r,t,n,o,i){var s=this;if(r.success||r.headersSent)return s;var a=parser.parse(t),u={};u[RESPONSE_HEADER_CACHECONTROL]="private",n&&framework_utils.extend(u,n,!0);var c={protocol:a.protocol,auth:a.auth,method:"GET",hostname:a.hostname,port:a.port,path:a.path,agent:!1,headers:u},l="https:"===c.protocol?require("https"):http,f=-1!==(e.headers["accept-encoding"]||"").lastIndexOf("gzip"),p=l.get(c,function(t){if(!r.success&&!r.headersSent){var n=t.headers["content-type"],o=-1!==(t.headers["content-encoding"]||"").lastIndexOf("gzip"),s=!o&&f&&(-1!==n.indexOf("text/")||-1!==n.lastIndexOf("javascript")||-1!==n.lastIndexOf("json")),a=t.headers["content-disposition"]||"";return a&&r.setHeader("Content-Disposition",a),r.setHeader(RESPONSE_HEADER_CONTENTTYPE,n),r.setHeader("Vary","Accept-Encoding"+(e.$mobile?", User-Agent":"")),r.on("error",function(e){t.close(),i&&(i(e),i=null)}),s?(r.setHeader("Content-Encoding","gzip"),void t.pipe(zlib.createGzip()).pipe(r)):void(!f&&o?t.pipe(zlib.createGunzip()).pipe(r):t.pipe(r))}});return o&&p.setTimeout(o,function(){s.response408(e,r),i&&(i(new Error(framework_utils.httpStatus(408))),i=null)}),p.on("close",function(){r.success||r.headersSent||(r.success=!0,s.stats.response.pipe++,s._request_stats(!1,e.isStaticFile),r.success=!0,e.isStaticFile||s.emit("request-end",e,r),e.clear(!0),i&&i())}),s},Framework.prototype.responseCustom=function(e,r){var t=this;if(!r.success&&!r.headersSent)return r.success=!0,t.stats.response.custom++,t._request_stats(!1,e.isStaticFile),e.isStaticFile||t.emit("request-end",e,r),e.clear(!0),t},Framework.prototype.responseImage=function(e,r,t,n,o,i){var s=this,a=createTemporaryKey(e),u=s.temporary.path[a];if(null===u)return s.response404(e,r),i&&i(),s;var c=null;if("object"===("undefined"==typeof t?"undefined":_typeof(t))?c=t:"@"===t[0]&&(t=s.path["package"](t.substring(1))),void 0!==u)return s.responseFile(e,r,"",void 0,o,i,a),s;var l="im"===s.config["default-image-converter"];if(s.isProcessing(a))return e.processing>s.config["default-request-timeout"]?(s.response408(e,r),void(i&&i())):(e.processing+=500,void setTimeout(function(){return s.responseImage(e,r,t,n,o,i)},500));var f=s.id?"i-"+s.id+"_":"";return u=s.path.temp(f+a),s.temporary.processing[a]=!0,c?(fsFileExists(u,function(t){if(t)return delete s.temporary.processing[a],s.temporary.path[a]=u,s.responseFile(e,r,u,void 0,o,i,a),void(s.isDebug&&delete s.temporary.path[a]);s.path.verify("temp");var f=framework_image.load(c,l);n(f);var p=framework_utils.getExtension(u);if(p!==f.outputType){var d=u.lastIndexOf("."+p);-1!==d?u=u.substring(0,d)+"."+f.outputType:u+="."+f.outputType}f.save(u,function(t){return delete s.temporary.processing[a],t?(s.temporary.path[a]=null,s.response500(e,r,t),i&&i(),void(s.isDebug&&delete s.temporary.path[a])):(s.temporary.path[a]=u+";"+fs.statSync(u).size,void s.responseFile(e,r,u,void 0,o,i,a))})}),s):(fsFileExists(t,function(c){if(!c)return delete s.temporary.processing[a],s.temporary.path[a]=null,s.response404(e,r),i&&i(),void(s.isDebug&&delete s.temporary.path[a]);s.path.verify("temp");var f=framework_image.load(t,l);n(f);var p=framework_utils.getExtension(u);if(p!==f.outputType){var d=u.lastIndexOf("."+p);-1!==d?u=u.substring(0,d)+"."+f.outputType:u+="."+f.outputType}f.save(u,function(t){return delete s.temporary.processing[a],t?(s.temporary.path[a]=null,s.response500(e,r,t),i&&i(),void(s.isDebug&&delete s.temporary.path[a])):(s.temporary.path[a]=u+";"+fs.statSync(u).size,void s.responseFile(e,r,u,void 0,o,i,a))})}),s)},Framework.prototype.responseImagePrepare=function(e,r,t,n,o,i){var s=this,a=createTemporaryKey(e),u=s.temporary.path[a];return null===u?(s.response404(e,r),i&&i(),s):void 0!==u?(s.responseFile(e,r,"",void 0,o,i,a),s):s.isProcessing(a)?e.processing>s.config["default-request-timeout"]?(s.response408(e,r),void(i&&i())):(e.processing+=500,void setTimeout(function(){return s.responseImage(e,r,filename,n,o,i)},500)):(t.call(s,function(t){return t?void s.responseImage(e,r,t,n,o,i):(s.response404(e,r),void(i&&i()))}),s)},Framework.prototype.responseImageWithoutCache=function(e,r,t,n,o,i){var s=this,a=null;"object"===("undefined"==typeof t?"undefined":_typeof(t))?a=t:"@"===t[0]&&(t=framework.path["package"](t.substring(1)));var u="im"===s.config["default-image-converter"];if(a){var c=framework_image.load(a,u);return n(c),s.responseStream(e,r,framework_utils.getContentType(c.outputType),c.stream(),null,o,i),s}return fsFileExists(t,function(a){if(!a)return s.response404(e,r),void(i&&i());s.path.verify("temp");var c=framework_image.load(t,u);n(c),s.responseStream(e,r,framework_utils.getContentType(c.outputType),c.stream(),null,o,i)}),s},Framework.prototype.responseStream=function(e,r,t,n,o,i,s,a){var u=this;if(r.success||r.headersSent)return s&&s(),u;-1===t.lastIndexOf("/")&&(t=framework_utils.getContentType(t));var c=e.headers["accept-encoding"]||"";!c&&isGZIP(e)&&(c="gzip");var l,f=a===!1&&u.config["allow-gzip"]&&REQUEST_COMPRESS_CONTENTTYPE[t]&&-1!==c.indexOf("gzip");return l=RELEASE?f?HEADERS["responseStream.release.compress"]:HEADERS["responseStream.release"]:f?HEADERS["responseStream.debug.compress"]:HEADERS["responseStream.debug"],l.Vary="Accept-Encoding"+(e.$mobile?", User-Agent":""),RELEASE&&(l.Expires=DATE_EXPIRES,l["Last-Modified"]="Mon, 01 Jan 2001 08:00:00 GMT"),i&&(l=framework_utils.extend({},l,!0),framework_utils.extend(l,i,!0)),o?l["Content-Disposition"]="attachment; filename="+encodeURIComponent(o):l["Content-Disposition"]&&delete l["Content-Disposition"],l[RESPONSE_HEADER_CONTENTTYPE]=t,u.stats.response.stream++,u._request_stats(!1,e.isStaticFile),"HEAD"===e.method?(r.writeHead(200,l),r.end(),s&&s(),e.isStaticFile||u.emit("request-end",e,r),e.clear(!0),u):f?(r.writeHead(200,l),r.on("error",function(){return n.close()}),n.pipe(zlib.createGzip()).pipe(r),framework_internal.onFinished(r,function(){return framework_internal.destroyStream(n)}),s&&s(),e.isStaticFile||u.emit("request-end",e,r),e.clear(!0),u):(r.writeHead(200,l),framework_internal.onFinished(r,function(e){return framework_internal.destroyStream(n)}),n.pipe(r),s&&s(),e.isStaticFile||u.emit("request-end",e,r),e.clear(!0),u)},Framework.prototype.responseRange=function(e,r,t,n,o,i){var s=this,a=r.replace(/bytes=/,"").split("-"),u=+a[0]||0,c=+a[1]||0,l=s.temporary.range[e];l||(l=fs.statSync(e).size,s.temporary.range[e]=l),0===c&&(c=l-1),u>c&&(u=0,c=l-1);var f=c-u+1;return t[RESPONSE_HEADER_CONTENTLENGTH]=f,t["Content-Range"]="bytes "+u+"-"+c+"/"+l,"HEAD"===n.method?(o.writeHead(206,t),o.end(),s.stats.response.streaming++,s._request_stats(!1,n.isStaticFile),i&&i(),n.isStaticFile||s.emit("request-end",n,o),s):(o.writeHead(206,t),RANGE.start=u,RANGE.end=c,fsStreamRead(e,RANGE,function(e,r){framework_internal.onFinished(o,function(){framework_internal.destroyStream(e),
r()}),e.pipe(o),s.stats.response.streaming++,s._request_stats(!1,n.isStaticFile),i&&i(),n.isStaticFile||s.emit("request-end",n,o)}),s)},Framework.prototype.responseBinary=function(e,r,t,n,o,i,s,a){var u=this;if(r.success||r.headersSent)return a&&a(),u;o||(o="binary"),-1===t.lastIndexOf("/")&&(t=framework_utils.getContentType(t));var c=e.headers["accept-encoding"]||"";!c&&isGZIP(e)&&(c="gzip");var l=u.config["allow-gzip"]&&REQUEST_COMPRESS_CONTENTTYPE[t]&&-1!==c.indexOf("gzip"),f=l?HEADERS["responseBinary.compress"]:HEADERS.responseBinary;return f.Vary="Accept-Encoding"+(e.$mobile?", User-Agent":""),s&&(f=framework_utils.extend({},f,!0),framework_utils.extend(f,s,!0)),i?f["Content-Disposition"]="attachment; filename="+encodeURIComponent(i):f["Content-Disposition"]&&delete f["Content-Disposition"],f[RESPONSE_HEADER_CONTENTTYPE]=t,u.stats.response.binary++,u._request_stats(!1,e.isStaticFile),"HEAD"===e.method?(r.writeHead(200,f),r.end(),a&&a(),e.isStaticFile||u.emit("request-end",e,r),e.clear(!0),u):l?(r.writeHead(200,f),zlib.gzip("binary"===o?n:n.toString(o),function(e,t){return r.end(t)}),a&&a(),e.isStaticFile||u.emit("request-end",e,r),u):(r.writeHead(200,f),r.end("binary"===o?n:n.toString(o)),a&&a(),e.isStaticFile||u.emit("request-end",e,r),e.clear(!0),u)},Framework.prototype.setModified=function(e,r,t){var n=this,o="string"==typeof t;return o?(r.setHeader("Etag",t+":"+n.config["etag-version"]),n):(r.setHeader("Last-Modified",t.toUTCString()),n)},Framework.prototype.notModified=function(e,r,t,n){var o=this,i="undefined"==typeof t?"undefined":_typeof(t);if("boolean"===i){var s=t;t=n,n=s,i="undefined"==typeof t?"undefined":_typeof(t)}var a="string"===i,u=e.headers[a?"if-none-match":"if-modified-since"];if(a){if(!u)return!1;var c=t+":"+o.config["etag-version"];if(u!==c)return!1}else{if(!u)return!1;var l=void 0===t?(new Date).toUTCString():t.toUTCString();if(n){if(new Date(Date.parse(u))===new Date(l))return!1}else if(new Date(Date.parse(u))<new Date(l))return!1}return r.success=!0,r.writeHead(304),r.end(),o.stats.response.notModified++,o._request_stats(!1,e.isStaticFile),e.isStaticFile||o.emit("request-end",e,r),!0},Framework.prototype.responseCode=function(e,r,t,n){var o=this;if(n&&o.problem(n,"response"+t+"()",e.uri,e.ip),r.success||r.headersSent)return o;o._request_stats(!1,e.isStaticFile),r.success=!0,r.writeHead(t,HEADERS.responseCode),"HEAD"===e.method?r.end():r.end(framework_utils.httpStatus(t)),e.isStaticFile||o.emit("request-end",e,r),e.clear(!0);var i="error"+t;return o.emit(i,e,r,n),o.stats.response[i]++,o},Framework.prototype.response400=function(e,r,t){return this.responseCode(e,r,400,t)},Framework.prototype.response401=function(e,r,t){return this.responseCode(e,r,401,t)},Framework.prototype.response403=function(e,r,t){return this.responseCode(e,r,403,t)},Framework.prototype.response404=function(e,r,t){return this.responseCode(e,r,404,t)},Framework.prototype.response408=function(e,r,t){return this.responseCode(e,r,408,t)},Framework.prototype.response431=function(e,r,t){return this.responseCode(e,r,431,t)},Framework.prototype.response500=function(e,r,t){var n=this;return t&&n.error(t,null,e.uri),r.success||r.headersSent?n:(n._request_stats(!1,e.isStaticFile),r.success=!0,r.writeHead(500,HEADERS.responseCode),"HEAD"===e.method?r.end():r.end(framework_utils.httpStatus(500)+prepare_error(t)),e.isStaticFile||n.emit("request-end",e,r),e.clear(!0),n.stats.response.error500++,n)},Framework.prototype.response501=function(e,r,t){return this.responseCode(e,r,501,t)},Framework.prototype.response503=function(e,r){var t=this,n="",o={};o[RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate",o[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTHTML,r.writeHead(503,o);for(var i in t.waits)n+=(n?", ":"")+"<u>"+i+"</u>";return r.end('<html><head><meta charset="utf-8" /></head><body style="font:normal normal 11px Arial;color:gray;line-height:16px;padding:10px;background-color:white"><div style="font-size:14px;color:#505050">Please wait (<span id="time">10</span>) for <b>'+(t.config.name+" v"+t.config.version)+"</b> application.</div>The application is waiting for: "+n+'.<script>var i=10;setInterval(function(){i--;if(i<0)return;document.getElementById("time").innerHTML=(i===0?"refreshing":i);if(i===0)window.location.reload();},1000);</script></body></html>',ENCODING),t},Framework.prototype.responseContent=function(e,r,t,n,o,i,s){var a=this;if(r.success||r.headersSent)return a;r.success=!0,n||(n="");var u=e.headers["accept-encoding"]||"";!u&&isGZIP(e)&&(u="gzip");var c,l=i?-1!==u.indexOf("gzip"):!1;return c=e.$mobile?l?HEADERS["responseContent.mobile.compress"]:HEADERS["responseContent.mobile"]:l?HEADERS["responseContent.compress"]:HEADERS.responseContent,s&&(c=framework_utils.extend({},c,!0),framework_utils.extend(c,s,!0)),"application/json"===o?c[RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate":c[RESPONSE_HEADER_CACHECONTROL]="private",REG_TEXTAPPLICATION.test(o)&&(o+="; charset=utf-8"),c[RESPONSE_HEADER_CONTENTTYPE]=o,"HEAD"===e.method?(r.writeHead(t,c),r.end(),a._request_stats(!1,e.isStaticFile),e.isStaticFile||a.emit("request-end",e,r),e.clear(!0),a):l?(r.writeHead(t,c),zlib.gzip(new Buffer(n),function(e,t){return r.end(t,ENCODING)}),a._request_stats(!1,e.isStaticFile),e.isStaticFile||a.emit("request-end",e,r),e.clear(!0),a):(r.writeHead(t,c),r.end(n,ENCODING),a._request_stats(!1,e.isStaticFile),e.isStaticFile||a.emit("request-end",e,r),e.clear(!0),a)},Framework.prototype.responseRedirect=function(e,r,t,n){var o=this;if(!r.success&&!r.headersSent){o._request_stats(!1,e.isStaticFile),r.success=!0;var i=HEADERS.responseRedirect;return i.Location=t,r.writeHead(n?301:302,i),r.end(),e.isStaticFile||o.emit("request-end",e,r),e.clear(!0),o}},Framework.prototype.load=function(e,r,t){var n=this;return t&&"."===t[0]&&t.length<4?n.directory=directory=framework_utils.$normalize(path.normalize(directory+"/..")):t&&(n.directory=directory=framework_utils.$normalize(t)),n.isWorker=!0,n.config.debug=e,n.isDebug=e,global.DEBUG=e,global.RELEASE=!e,global.isomorphic=n.isomorphic,n.$startup(function(){n._configure(),r&&-1===r.indexOf("versions")||n._configure_versions(),r&&-1===r.indexOf("sitemap")||n._configure_sitemap(),n.cache.init(),n.emit("init"),n.isLoaded=!0,setTimeout(function(){try{n.emit("load",n),n.emit("ready",n)}catch(e){n.error(e,'framework.on("load/ready")')}n.removeAllListeners("load"),n.removeAllListeners("ready"),delete framework.tests,delete framework.test,delete framework.testing,delete framework.assert},500),n.$load(r,directory)}),n},Framework.prototype.initialize=function(e,r,t,n){var o=this;t||(t={});var i=t.port,s=t.ip;return t.config&&framework_utils.copy(t.config,o.config),o.isHTTPS="undefined"==typeof e.STATUS_CODES,isNaN(i)&&"string"!=typeof i&&(i=null),o.config.debug=r,o.isDebug=r,global.DEBUG=r,global.RELEASE=!r,global.isomorphic=o.isomorphic,o._configure(),o._configure_versions(),o._configure_sitemap(),o.isTest&&o._configure("config-test",!1),o.cache.init(),o.emit("init"),o.clear(function(){if(o.$load(void 0,directory),!i)if("auto"===o.config["default-port"]){var r=+(process.env.PORT||"");isNaN(r)||(i=r)}else i=o.config["default-port"];if(o.port=i||8e3,null!==s?(o.ip=s||o.config["default-ip"]||"127.0.0.1","null"!==o.ip&&"undefined"!==o.ip&&"auto"!==o.ip||(o.ip=void 0)):o.ip=void 0,void 0!==o.ip&&null!==o.ip||(o.ip="auto"),o.server&&(o.server.removeAllListeners(),Object.keys(o.connections).forEach(function(e){var r=o.connections[e];r&&(r.removeAllListeners(),r.close())}),o.server.close()),t.https?o.server=e.createServer(t.https,o.listener):o.server=e.createServer(o.listener),o.config["allow-performance"]&&o.server.on("connection",function(e){e.setNoDelay(!0),e.setKeepAlive(!0,10)}),o.config["allow-websocket"]&&o.server.on("upgrade",framework._upgrade),o.server.listen(o.port,"auto"===o.ip?void 0:o.ip),o.isLoaded=!0,process.connected&&!n||o.console(),setTimeout(function(){try{o.emit("load",o),o.emit("ready",o)}catch(e){o.error(e,'framework.on("load/ready")')}o.removeAllListeners("load"),o.removeAllListeners("ready"),t["package"]&&INSTALL("package",t["package"])},500),o.isTest){var a=t.sleep||t.delay||1e3;return global.TEST=!0,global.assert=require("assert"),setTimeout(function(){return o.test(!0,t.tests||t.test)},a),o}setTimeout(function(){framework.isTest||(delete framework.tests,delete framework.test,delete framework.testing,delete framework.assert)},5e3)},!0),o},Framework.prototype.http=function(e,r){return void 0===r&&(r={}),r.port||(r.port=+process.argv[2]),this.mode(require("http"),e,r)},Framework.prototype.https=function(e,r){return void 0===r&&(r={}),this.mode(require("https"),e,r)},Framework.prototype.mode=function(e,r,t){var n=this,o=!1,i=!1;if("string"==typeof e){switch(e){case"debug":case"development":i=!0}return n.config.debug=i,n.config.trace=i,n.isDebug=i,global.DEBUG=i,global.RELEASE=!i,n}switch(n.isWorker=!1,r.toLowerCase().replace(/\.|\s/g,"-")){case"release":case"production":break;case"debug":case"develop":case"development":i=!0;break;case"test":case"testing":case"test-debug":case"debug-test":case"testing-debug":o=!0,i=!0,n.isTest=!0;break;case"test-release":case"release-test":case"testing-release":case"test-production":case"testing-production":o=!0,i=!1}var s=!1;return n.temporary.init?s=!0:n.temporary.init={name:r,isHTTPS:"undefined"==typeof e.STATUS_CODES,options:t},n.config.trace=i,n.$startup(function(r){return n.initialize(e,i,t,s)}),n},Framework.prototype.console=function(){console.log("===================================================="),console.log("PID          : "+process.pid),console.log("node.js      : "+process.version),console.log("total.js     : v"+F.version_header),console.log("===================================================="),console.log("Name         : "+F.config.name),console.log("Version      : "+F.config.version),console.log("Author       : "+F.config.author),console.log("Date         : "+(new Date).format("yyyy-MM-dd HH:mm:ss")),console.log("Mode         : "+(F.config.debug?"debug":"release")),console.log("====================================================\n"),console.log("{2}://{0}:{1}/".format(F.ip,F.port,F.isHTTPS?"https":"http")),console.log("")},Framework.prototype.reconnect=function(){var e=this;return void 0!==e.config["default-port"]&&(e.port=e.config["default-port"]),void 0!==e.config["default-ip"]&&(e.ip=e.config["default-ip"]),e.server.close(function(){return e.server.listen(e.port,e.ip)}),e},Framework.prototype._service=function(e){var r=this;if(r.datetime=new Date,UIDGENERATOR.date=r.datetime.format("yyMMddHHmm").substring(1),UIDGENERATOR.index=1,r.config.debug&&(r.resources={}),e%r.config["default-interval-clear-cache"]===0&&(r.emit("clear","temporary",r.temporary),r.temporary.path={},r.temporary.range={},r.temporary.views={},r.temporary.other={}),e%r.config["default-interval-precompile-views"]===0)for(var t in r.routes.views){var n=r.routes.views[t];r.install("view",t,n.url,null)}e%r.config["default-interval-clear-dnscache"]===0&&(r.emit("clear","dns"),framework_utils.clearDNS());var o=r.config["default-interval-websocket-ping"];if(o>0&&e%o===0)for(var n in r.connections){var i=r.connections[n];i&&(i.check(),i.ping())}e%r.config["default-interval-clear-resources"]===0&&(r.emit("clear","resources"),r.resources={},global.gc&&setTimeout(global.gc,1e3)),e%1e3===0&&(DATE_EXPIRES=r.datetime.add("y",1).toUTCString()),r.emit("service",e);var s=r.schedules.length;if(!s)return r;for(var a=r.datetime.getTime(),u=0;;){var c=r.schedules[u++];if(!c)break;c.expire>a||(u--,c.repeat?c.expire=r.datetime.add(c.repeat):r.schedules.splice(u,1),c.fn.call(r))}return r},Framework.prototype.listener=function(e,r){var t=framework;if(!e.host)return t.stats.response.destroy++,r.writeHead(403),void r.end();if(t._length_wait)return t.response503(e,r);var n=e.headers,o=e.connection.encrypted||"https"===n["x-forwarded-protocol"]?"https":"http";if(r.req=e,e.res=r,e.uri=framework_internal.parseURI(o,e),t.stats.request.request++,t.emit("request",e,r),t._request_check_redirect){var i=t.routes.redirects[o+"://"+e.host];if(i)return t.stats.response.forward++,void t.responseRedirect(e,r,i.url+(i.path?e.url:""),i.permanent)}if(!t.restrictions.is||!t._request_restriction(e,r,n)){e.path=framework_internal.routeSplit(e.uri.pathname),e.processing=0,e.isAuthorized=!0,e.xhr="XMLHttpRequest"===n["x-requested-with"],r.success=!1,e.session=null,e.user=null,e.isStaticFile=framework.config["allow-handle-static-files"]&&framework_utils.isStaticFile(e.uri.pathname);var s=!0;if(e.isStaticFile)switch(e.extension=framework_utils.getExtension(e.uri.pathname),e.extension){case"html":case"htm":case"txt":case"md":s=!0;break;default:s=!1}return s&&t.onLocate&&(e.$language=t.onLocate(e,r,e.isStaticFile)),t._request_stats(!0,!0),t._length_request_middleware&&!e.behaviour("disable-middleware")?async_middleware(0,e,r,t.routes.request,function(){return t._request_continue(r.req,r,r.req.headers,o)}):void t._request_continue(e,r,n,o)}},Framework.prototype._request_restriction=function(e,r,t){var n=this;if(n.restrictions.isAllowedIP)for(var o=0,i=n.restrictions.allowedIP.length;i>o;o++){var s=n.restrictions.allowedIP[o];if(-1===e.ip.indexOf(s))return n.stats.response.restriction++,r.writeHead(403),r.end(),!0}if(n.restrictions.isBlockedIP)for(var o=0,i=n.restrictions.blockedIP.length;i>o;o++){var s=n.restrictions.blockedIP[o];if(-1!==e.ip.indexOf(s))return n.stats.response.restriction++,r.writeHead(403),r.end(),!0}return n.restrictions.isAllowedCustom&&!n.restrictions._allowedCustom(t)?(n.stats.response.restriction++,r.writeHead(403),r.end(),!0):n.restrictions.isBlockedCustom&&n.restrictions._blockedCustom(t)?(n.stats.response.restriction++,r.writeHead(403),r.end(),!0):!1},Framework.prototype._request_continue=function(e,r,t,n){if(e&&r&&!r.headersSent&&!r.success){var o=this;if(e.isStaticFile)return o.stats.request.file++,o._length_files?(new Subscribe(o,e,r,3).file(),o):o.responseStatic(e,r);e.body=EMPTYOBJECT,e.files=EMPTYARRAY,e.isProxy="total.js"===t["x-proxy"],e.buffer_exceeded=!1,e.buffer_data=new Buffer(""),e.buffer_has=!1,e.$flags=e.method,o.stats.request.web++;var i=[e.method.toLowerCase()],s=e.headers["content-type"]||"";e.mobile?(e.$flags+="_m_",o.stats.request.mobile++):o.stats.request.desktop++,e.$flags+=n,e.$type=0,i.push(n);var a=e.method,u=a[0];if("P"===u||"D"===u){var c=s.lastIndexOf(";"),l=s;switch(-1!==c&&(l=l.substring(0,c)),l.substring(l.length-4)){case"json":e.$flags+="json",i.push("json"),e.$type=1,s="";break;case"/xml":e.$flags+="xml",i.push("xml"),e.$type=2,s="";break;case"oded":e.$type=3,s="";break;case"data":e.$flags+="upload",i.push("upload");break;default:s?(s="",i.push("raw")):(e.$type=3,s="")}}if(e.isProxy&&(e.$flags+="proxy",i.push("proxy")),"text/event-stream"===t.accept&&(e.$flags+="sse",i.push("sse")),o.config.debug&&(e.$flags+="debug",i.push("debug")),e.xhr&&(o.stats.request.xhr++,e.$flags+="xhr",i.push("xhr")),o._request_check_referer){var f=t.referer;f&&-1!==f.indexOf(t.host)&&(e.$flags+="referer",i.push("referer"))}e.flags=i,o.emit("request-begin",e,r);var p=e.headers.origin&&o._length_cors;switch(u){case"G":return o.stats.request.get++,p?(o._cors(e,r,function(e,r){return new Subscribe(framework,e,r,0).end()}),o):(new Subscribe(o,e,r,0).end(),o);case"O":return o.stats.request.options++,p?(o._cors(e,r),o):(new Subscribe(framework,e,r,0).end(),o);case"H":return o.stats.request.head++,p?(o._cors(e,r,function(e,r){return new Subscribe(framework,e,r,0).end()}),o):(new Subscribe(o,e,r,0).end(),o);case"D":return o.stats.request["delete"]++,p?(o._cors(e,r,function(e,r){return new Subscribe(framework,e,r,1).urlencoded()}),o):(new Subscribe(o,e,r,1).urlencoded(),o);case"P":if(o._request_check_POST)return s?(o.stats.request.upload++,p?(o._cors(e,r,function(e,r,t){return new Subscribe(o,e,r,2).multipart(t)},s),o):(new Subscribe(o,e,r,2).multipart(s),o)):("PUT"===a?o.stats.request.put++:"PATCH"===a?o.stats.request.path++:o.stats.request.post++,p?(o._cors(e,r,function(e,r){return new Subscribe(o,e,r,1).urlencoded()}),o):(new Subscribe(o,e,r,1).urlencoded(),o))}return o.emit("request-end",e,r),o._request_stats(!1,!1),o.stats.request.blocked++,r.writeHead(403),r.end(),o}},Framework.prototype._cors=function(e,r,t,n){for(var o,i=this,s=!1,a=0;a<i._length_cors;a++)if(o=i.routes.cors[a],framework_internal.routeCompare(e.path,o.url,!1,o.isASTERIX)){s=!0;break}if(!s)return t(e,r,n);var u=!1,c=e.headers;if(s||(u=!0),s=!1,!u&&o.headers){s=!1;for(var a=0,l=o.headers.length;l>a;a++)if(c[o.headers[a]]){s=!0;break}s||(u=!0)}if(!u&&o.methods){s=!1;var f=c["access-control-request-method"]||e.method;if("OPTIONS"!==f){for(var a=0,l=o.methods.length;l>a;a++)-1!==f.indexOf(o.methods[a])&&(s=!0);s||(u=!0)}}var p=c.origin.toLowerCase();if(!u&&o.origins){s=!1;for(var a=0,l=o.origins.length;l>a;a++)if(-1!==o.origins[a].indexOf(p)){s=!0;break}s||(u=!0)}var d,m="OPTIONS"===e.method;return r.setHeader("Access-Control-Allow-Origin",o.origins?o.origins:o.credentials?s?p:o.origins?o.origins:p:c.origin),o.credentials&&r.setHeader("Access-Control-Allow-Credentials","true"),d="Access-Control-Allow-Methods",o.methods?r.setHeader(d,o.methods.join(", ")):r.setHeader(d,m?c["access-control-request-method"]||"*":e.method),d="Access-Control-Allow-Headers",o.headers?r.setHeader(d,o.headers.join(", ")):r.setHeader(d,c["access-control-request-headers"]||"*"),o.age&&r.setHeader("Access-Control-Max-Age",o.age),u?(t=null,i.emit("request-end",e,r),i._request_stats(!1,!1),i.stats.request.blocked++,r.writeHead(404),void r.end()):m?(t=null,i.emit("request-end",e,r),i._request_stats(!1,!1),r.writeHead(200),r.end(),i):t(e,r,n)},Framework.prototype._upgrade=function(e,r,t){if("websocket"===(e.headers.upgrade||"").toLowerCase()){r.setTimeout(0);var n=framework,o=e.headers,i=e.connection.encrypted||"https"===o["x-forwarded-protocol"]?"https":"http";if(e.uri=framework_internal.parseURI(i,e),n.emit("websocket",e,r,t),n.stats.request.websocket++,!n.restrictions.is||!n._request_restriction(e,res,o)){e.session=null,e.user=null,e.flags=[e.secured?"https":"http","get"];var s=framework_utils.path(e.uri.pathname),a=new WebSocketClient(e,r,t);return e.path=framework_internal.routeSplit(e.uri.pathname),e.websocket=a,n.onLocate&&(e.$language=n.onLocate(e,r)),n._length_request_middleware&&!e.behaviour("disable-middleware")?async_middleware(0,e,e.websocket,n.routes.request,function(){return n._upgrade_prepare(e,s,e.headers)}):void n._upgrade_prepare(e,s,o)}}},Framework.prototype._upgrade_prepare=function(e,r,t){var n=this,o=n.onAuthorize;if(!o){var i=n.lookup_websocket(e,e.websocket.uri.pathname,!0);return i?void n._upgrade_continue(i,e,r):(e.websocket.close(),void e.connection.destroy())}o.call(n,e,e.websocket,e.flags,function(t,o){o&&(e.user=o),e.flags.push(t?"authorize":"unauthorize");var i=n.lookup_websocket(e,e.websocket.uri.pathname,!1);return i?void n._upgrade_continue(i,e,r):(e.websocket.close(),void e.connection.destroy())})},Framework.prototype._upgrade_continue=function(e,r,t){var n=this,o=r.websocket;if(!o.prepare(e.flags,e.protocols,e.allow,e.length,n.version_header))return o.close(),void r.connection.destroy();var i=t+(e.flags.length?"#"+e.flags.join("-"):"");e.isBINARY?o.type=1:e.isJSON&&(o.type=3);var s=function(){if(n.connections[i])return void o.upgrade(n.connections[i]);var s=new WebSocket(t,e.controller,i);s.route=e,s.options=e.options,n.connections[i]=s,e.onInitialize.apply(s,framework_internal.routeParam(e.param.length?r.split:r.path,e)),setImmediate(function(){return o.upgrade(s)})};e.middleware?async_middleware(0,r,r.websocket,e.middleware,s,e.options):s()},Framework.prototype._request_stats=function(e,r){var t=this;return e?t.stats.request.pending++:t.stats.request.pending--,t.stats.request.pending<0&&(t.stats.request.pending=0),t},Framework.prototype.model=function(e){var r=this,t=r.models[e];if(t||null===t)return t;if(void 0!==r.models[e])return r.models[e];var n=path.join(directory,r.config["directory-models"],e+".js");return existsSync(n)&&r.install("model",e,n,void 0,void 0,void 0,!0),r.models[e]||null},Framework.prototype.source=function(e,r,t){var n=this,o=n.sources[e];if(o||null===o)return o;if(void 0!==n.sources[e])return n.sources[e];var i=path.join(directory,n.config["directory-source"],e+".js");return existsSync(i)&&n.install("source",e,i,r,t,void 0,!0),n.sources[e]||null},Framework.prototype.include=function(e,r,t){return this.source(e,r,t)},Framework.prototype._log=function(e,r,t,n){var o=this;if(!o.isDebug)return!1;for(var i=arguments.length,s=["---->"],a=0;i>a;a++)s.push(arguments[a]);setTimeout(function(){return console.log.apply(console,s)},1e3)},Framework.prototype.mail=function(e,r,t,n,o,i){if("string"==typeof o){var s=i;i=o,o=s}var a=new Controller("",null,null,null,"");a.layoutName="",a.themeName=framework_utils.parseTheme(t),a.themeName?t=prepare_viewname(t):this.onTheme&&(a.themeName=this.onTheme(a));var u;return"string"==typeof i&&(r=-1===r.indexOf("@(")?framework.translate(i,r):framework.translator(i,r),a.language=i),"object"===("undefined"==typeof repository?"undefined":_typeof(repository))&&repository&&(a.repository=repository),a.mail(e,r,t,n,o,u)},Framework.prototype.view=function(e,r,t,n,o){var i=new Controller("",null,null,null,"");if("object"===("undefined"==typeof t?"undefined":_typeof(t))){var s=n;n=t,t=s}i.layoutName=t||"",i.language=o;var a=framework_utils.parseTheme(e);a?(i.themeName=a,e=prepare_viewname(e)):this.onTheme&&(i.themeName=this.onTheme(i)),"object"===("undefined"==typeof n?"undefined":_typeof(n))&&n&&(i.repository=n);var u=i.view(e,r,!0);return i.repository=i.res=i.req=null,i=null,u},Framework.prototype.assert=function(e,r,t,n,o,i,s){var a=this;if("function"==typeof r)return a.tests.push({name:_test+": "+e,priority:framework.testsPriority,index:a.tests.length,run:r}),a;var u="GET",c=0,l=0;if(s=s?framework_utils.extend({},s):{},t instanceof Array){c=t.length;for(var f=0;c>f;f++)switch(t[f].toLowerCase()){case"xhr":s["X-Requested-With"]="XMLHttpRequest";break;case"referer":case"referrer":s.Referer=r;break;case"json":s["Content-Type"]="application/json",l=1;break;case"xml":s["Content-Type"]="text/xml",l=2;break;case"get":case"head":case"options":u=t[f].toUpperCase(),o&&(r+="object"===("undefined"==typeof o?"undefined":_typeof(o))?"?"+qs.stringify(o):"?"===o[0]?o:"?"+o,o="");break;case"upload":s["Content-Type"]="multipart/form-data";break;case"robot":s["User-Agent"]?s["User-Agent"]+=" Bot":s["User-Agent"]="Bot";break;case"mobile":s["User-Agent"]?s["User-Agent"]+=" iPhone":s["User-Agent"]="iPhone";break;case"post":case"put":case"delete":u=t[f].toUpperCase(),s["Content-Type"]||(s["Content-Type"]="application/x-www-form-urlencoded");break;case"raw":s["Content-Type"]="application/octet-stream"}}if(s["X-Assertion-Testing"]="1",i){var p=[],d=Object.keys(i);c=d.length;for(var f=0;c>f;f++)p.push(d[f]+"="+encodeURIComponent(i[d[f]]));p.length&&(s.Cookie=p.join("; "))}var m={name:_test+": "+e,priority:framework.testsPriority,index:a.tests.length,url:r,callback:n,method:u,data:o,headers:s};return a.tests.push(m),a},Framework.prototype.testing=function(e,r){void 0===e&&(e=!0);var t=this;if(!t.tests.length){if(!t.testsFiles.length)return r&&r(framework.isTestError===!0),e&&t.stop(framework.isTestError?1:0),t;var n=t.testsFiles.shift();return n&&n.fn.call(t,t),t.testing(e,r),t}var o=function(e,r,t){var n=Math.floor(new Date-r)+" ms";return t?(framework.isTestError=!0,void console.error("Failed [x] ".padRight(20,".")+" "+e+" <"+(-1!==t.name.toLowerCase().indexOf("assert")?t.toString():t.stack)+"> ["+n+"]")):void console.info("Passed ".padRight(20,".")+" "+e+" ["+n+"]")},i=t.tests.shift(),s=i.name,a=new Date;if(i.run)return framework.testContinue=function(n){o(s,a,n),n?framework.testsNO++:framework.testsOK++,t.testing(e,r)},i.run.call(t,function(){o(s,a),framework.testsOK++,t.testing(e,r)},s),t;var u=function(n){n.on("data",function(e){this._buffer?this._buffer=Buffer.concat([this._buffer,e]):this._buffer=e}),n.on("end",function(){n.removeAllListeners();var u=n.headers.cookie||"",c={};if(u.length)for(var l=u.split(";"),f=l.length,p=0;f>p;p++){var d=l[p].trim().split("=");c[d.shift()]=unescape(d.join("="))}try{i.callback(null,this._buffer?this._buffer.toString(ENCODING):"",n.statusCode,n.headers,c,s),o(s,a),framework.testsOK++}catch(m){framework.testsNO++,o(s,a,m)}t.testing(e,r)}),n.resume()},c=parser.parse((i.url.startsWith("http://",!0)||i.url.startsWith("https://",!0)?"":"http://"+t.ip+":"+t.port)+i.url);"function"==typeof i.data&&(i.data=i.data()),"string"!=typeof i.data&&(i.data=-1!==(i.headers[RESPONSE_HEADER_CONTENTTYPE]||"").indexOf("json")?JSON.stringify(i.data):qs.stringify(i.data));var l;i.data&&i.data.length&&(l=new Buffer(i.data,ENCODING),i.headers[RESPONSE_HEADER_CONTENTLENGTH]=l.length),c.method=i.method,c.headers=i.headers;var f="https:"===c.protocol?require("https"):http,p="POST"===i.method||"PUT"===i.method||"DELETE"===i.method||"PATCH"===i.method?f.request(c,u):f.get(c,u);return p.on("error",function(n){p.removeAllListeners(),o(s,a,n),t.testsNO++,t.testing(e,r)}),p.end(l),t},Framework.prototype.test=function(e,r,t){var n=this;void 0===e&&(e=!0),"function"==typeof r?(t=r,r=[]):r=r||[];var o=0;n.isTest=!0;var i=n.config["directory-tests"];n._configure("config-test",!0);var s=function(e,r,t){var n=Math.floor(new Date-r)+" ms";return t?(framework.isTestError=!0,void console.error("Failed [x] ".padRight(20,".")+" "+e+" <"+(-1!==t.name.toLowerCase().indexOf("assert")?t.toString():t.stack)+"> ["+n+"]")):void console.info("Passed ".padRight(20,".")+" "+e+" ["+n+"]")},a=function(){framework.testsResults.length&&(console.log(""),console.log("===================== RESULTS ======================"),console.log(""),framework.testsResults.forEach(function(e){return e()}))};return framework.testsFiles=[],framework.testsResults||(framework.testsResults=[]),framework.testsOK||(framework.testsOK=0),framework.testsNO||(framework.testsNO=0),framework_utils.ls(framework_utils.combine(i),function(u){u.forEach(function(e){var t=path.relative(framework_utils.combine(i),e),a=e,u=framework_utils.getExtension(a).toLowerCase();if("js"===u&&(!r.length||-1!==r.indexOf(t.substring(0,t.length-3)))){var c=require(a),l=new Date;try{var f=void 0!==c.run,p=void 0!==c.isInstall,d=void 0!==c.init,m=void 0!==c.load;if(_test=t,c.disabled===!0)return;framework.testsPriority=void 0===c.priority?n.testsFiles.length:c.priority;var h=null;if(f?h=c.run:p?h=c.install:d?h=c.init:m&&(h=c.loadname),null===h)return;n.testsFiles.push({name:t,index:n.testsFiles.length,fn:h,priority:framework.testsPriority}),c.usage&&!function(e){framework.testsResults.push(function(){return e.usage(t)})}(c),o++}catch(g){s("Failed",l,g)}}}),_test="",n.testsFiles.sort(function(e,r){return e.priority>r.priority?1:e.priority<r.priority?-1:e.index>r.index?1:e.index<r.index?-1:0}),setTimeout(function(){console.log("===================== TESTING ======================"),o&&console.log(""),n.testing(e,function(){console.log(""),console.log("Passed ...",framework.testsOK),console.log("Failed ...",framework.testsNO),console.log(""),a(),n.isTest=!1,console.log(""),t&&t()})},100)}),n},Framework.prototype.clear=function(e,r){var t=this,n=t.path.temp(),o=t.id?"i-"+t.id+"_":"";return r&&t.config["disable-clear-temporary-directory"]?(framework_utils.ls(n,function(r,n){t.unlink(r),e&&e()},function(e,r){if(r||o&&!e.substring(n.length).startsWith(o))return!1;var t=framework_utils.getExtension(e);return"js"===t||"css"===t||"tmp"===t||"upload"===t||"html"===t||"htm"===t}),t):existsSync(n)?(framework_utils.ls(n,function(i,s){if(r){for(var a=[],u=0,c=i.length;c>u;u++){var l=i[u].substring(n.length);o&&!l.startsWith(o)||-1===l.indexOf("/")&&a.push(i[u])}i=a,s=[]}t.unlink(i,function(){return t.rmdir(s,e)})}),r||(t.temporary.path={},t.temporary.range={}),this):(e&&e(),t)},Framework.prototype.unlink=function(e,r){var t=this;if("string"==typeof e&&(e=[e]),!e.length)return void(r&&r());var n=e.shift();return n?(fs.unlink(n,function(n){t.unlink(e,r)}),t):void(r&&r())},Framework.prototype.rmdir=function(e,r){var t=this;if("string"==typeof e&&(e=[e]),!e.length)return void(r&&r());var n=e.shift();return n?(fs.rmdir(n,function(){t.rmdir(e,r)}),t):void(r&&r())},Framework.prototype.encrypt=function(e,r,t){var n=this;if(void 0===e)return"";var o="undefined"==typeof e?"undefined":_typeof(e);if("boolean"==typeof r){var i=t;t=r,r=i}return"function"===o&&(e=e()),"number"===o&&(e=e.toString()),"object"===o&&(e=JSON.stringify(e)),e.encrypt(n.config.secret+"="+r,t)},Framework.prototype.decrypt=function(e,r,t){if("boolean"==typeof r){var n=t;t=r,r=n}"boolean"!=typeof t&&(t=!0);var o=this,i=(e||"").decrypt(o.config.secret+"="+r);if(null===i)return null;if(t){if(i.isJSON())try{return JSON.parse(i)}catch(s){}return null}return i},Framework.prototype.hash=function(e,r,t){var n=crypto.createHash(e),o="";return"string"==typeof t?o=t:t!==!1&&(o=this.config.secret||""),n.update(r.toString()+o,ENCODING),n.digest("hex")},Framework.prototype.resource=function(e,r){r||(r=e,e=null),e||(e="default");var t=this,n=t.resources[e];if(n)return n[r]||"";var o,i=t.routes.resources[e],s="";if(i)for(var a=0,u=i.length;u>a;a++)o=i[a],existsSync(o)&&(s+=(s?"\n":"")+fs.readFileSync(o).toString(ENCODING));var o=framework_utils.combine(t.config["directory-resources"],e+".resource");existsSync(o)&&(s+=(s?"\n":"")+fs.readFileSync(o).toString(ENCODING));var c=s.parseConfig();return t.resources[e]=c,c[r]||""},Framework.prototype.translate=function(e,r){if(r||(r=e,e=void 0),"#"===r[0]&&" "!==r[1])return this.resource(e,r.substring(1));var t=this.resource(e,"T"+r.hash());return t?t:r},Framework.prototype.translator=function(e,r){return framework_internal.parseLocalization(r,e)},Framework.prototype._configure_sitemap=function(e,r){if(!e||"string"==typeof e){var t=prepare_filename(e||"sitemap");e=existsSync(t,!0)?fs.readFileSync(t).toString(ENCODING).split("\n"):null}var n=this;if(!e||!e.length)return n;r&&(n.routes.sitemap={}),n.routes.sitemap||(n.routes.sitemap={});for(var o=0,i=e.length;i>o;o++){var s=e[o];if(s&&"#"!==s[0]&&"// "!==s.substring(0,3)){var a=s.indexOf(" :");if(-1!==a||(a=s.indexOf("	:"),-1!==a)){var u=s.substring(0,a).trim(),c=s.substring(a+2).trim(),l=c.split("-->"),f=l[1].trim(),p=!1;f.endsWith("*")&&(p=!0,f=f.substring(0,f.length-1)),n.routes.sitemap[u]={name:l[0].trim(),url:f,parent:l[2]?l[2].trim():null,wildcard:p}}}}return n},Framework.prototype.sitemap=function(e,r,t){var n=this;if(!n.routes.sitemap)return EMPTYARRAY;if("string"==typeof r){t=r,r=t}var o=REPOSITORY_SITEMAP+e+"$"+(r?"1":"0")+"$"+(t||"");if(n.temporary.other[o])return n.temporary.other[o];var i,s=e;if(r===!0){i=n.routes.sitemap[e];var a={sitemap:s,id:"",name:"",url:"",last:!0,selected:!0,index:0,wildcard:!1};if(!i)return a;var u=i.name;u.startsWith("@(")&&(u=n.translate(t,u.substring(2,u.length-1).trim()));var c=i.url;return c.startsWith("@(")&&(c=n.translate(t,c.substring(2,c.length-1).trim())),a.sitemap=s,a.id=e,a.name=u,a.url=c,a.wildcard=i.wildcard,n.temporary.other[o]=a,a}for(var l=[],f=0;;){if(i=n.routes.sitemap[e],!i)break;var u=i.name;if(u.startsWith("@(")&&(u=n.translate(t,i.name.substring(2,i.name.length-1))),l.push({sitemap:s,id:e,name:u,url:i.url,last:0===f,first:!i.parent,selected:0===f,index:f,wildcard:i.wildcard}),f++,e=i.parent,!e)break}return l.reverse(),n.temporary.other[o]=l,l},Framework.prototype.sitemap_navigation=function(e,r){var t=this,n=REPOSITORY_SITEMAP+"_n_"+(e||"")+"$"+(r||"");if(t.temporary.other[n])return t.temporary.other[n];for(var o=Object.keys(t.routes.sitemap),i=[],s=0,a=0,u=o.length;u>a;a++){var c=t.routes.sitemap[o[a]];if(!(e&&c.parent!==e||!e&&c.parent)){var l=c.name;l.startsWith("@(")&&(l=t.translate(r,c.name.substring(2,c.name.length-1))),i.push({id:e||"",name:l,url:c.url,last:0===s,first:!c.parent,selected:0===s,index:s,wildcard:c.wildcard}),s++}}return i.quicksort("name"),t.temporary.other[n]=i,i},Framework.prototype._configure_dependencies=function(e){
if(!e||"string"==typeof e){var r=prepare_filename(e||"dependencies");e=existsSync(r,!0)?fs.readFileSync(r).toString(ENCODING).split("\n"):null}var t=this;if(!e)return t;for(var n=0,o=e.length;o>n;n++){var i=e[n];if(i&&"#"!==i[0]&&"// "!==i.substring(0,3)){var s=i.indexOf(" :");if(-1!==s||(s=i.indexOf("	:"),-1!==s)){var a=i.substring(0,s).trim(),u=i.substring(s+2).trim(),c={};if(s=u.indexOf("-->"),-1!==s){var l=u.substring(s+3).trim();l.isJSON()&&(c=JSON.parse(l)),u=u.substring(0,s).trim()}switch(a){case"package":case"packages":case"pkg":t.install("package",u,c);break;case"module":case"modules":t.install("module",u,c);break;case"model":case"models":t.install("model",u,c);break;case"source":case"sources":t.install("source",u,c);break;case"controller":case"controllers":t.install("controller",u,c);break;case"view":case"views":t.install("view",u,c);break;case"version":case"versions":t.install("version",u,c);break;case"config":case"configuration":t.install("config",u,c);break;case"isomorphic":case"isomorphics":t.install("isomorphic",u,c);break;case"definition":case"definitions":t.install("definition",u,c);break;case"middleware":case"middlewares":t.install("middleware",u,c)}}}}return t},Framework.prototype._configure_versions=function(e,r){var t=this;if(void 0===e||"string"==typeof e){var n=prepare_filename(e||"versions");e=existsSync(n,!0)?fs.readFileSync(n).toString(ENCODING).split("\n"):null}if(!e)return r&&(t.versions=null),t;r||(t.versions={}),t.versions||(t.versions={});for(var o=0,i=e.length;i>o;o++){var s=e[o];if(s&&"#"!==s[0]&&"// "!==s.substring(0,3)){"/"!==s[0]&&(s="/"+s);var a=s.indexOf(" :"),u=!1;if(-1===a&&(a=s.indexOf("	:"),-1===a)){if(a=s.indexOf("-->"),-1===a)continue;u=!0}var c=u?3:2,l=s.substring(0,a).trim(),n=s.substring(a+c).trim();t.versions[l]=n,u&&t.map(n,t.path["public"](l))}}return t},Framework.prototype._configure=function(e,r){var t=this,n="undefined"==typeof e?"undefined":_typeof(e);if("string"===n){var o=prepare_filename(e);if(!existsSync(o,!0))return t;e=fs.readFileSync(o).toString(ENCODING).split("\n")}if(!e){var i=framework_utils.combine("/","config"),s=framework_utils.combine("/","config-"+(t.config.debug?"debug":"release"));e=[];var a=t.path.configs();if(existsSync(a))for(var u=fs.readdirSync(a),c=0,l=u.length;l>c;c++){var f=u[c].match(/\-(debug|release|test)$/i);if(f){if(f=f[0].toString().toLowerCase(),"-debug"===f&&!t.isDebug)continue;if("-release"===f&&t.isDebug)continue;if("-test"===f&&!t.isTest)continue}e=e.concat(fs.readFileSync(a+u[c]).toString(ENCODING).split("\n"))}existsSync(i)&&fs.lstatSync(i).isFile()&&(e=e.concat(fs.readFileSync(i).toString(ENCODING).split("\n"))),existsSync(s)&&fs.lstatSync(s).isFile()&&(e=e.concat(fs.readFileSync(s).toString(ENCODING).split("\n")))}var p=function(){process.title="total: "+t.config.name.removeDiacritics().toLowerCase().replace(REG_EMPTY,"-").substring(0,8),t.isVirtualDirectory=existsSync(framework_utils.combine(t.config["directory-public-virtual"]))};if(!e instanceof Array||!e.length)return p(),t;void 0===r&&(r=!0);for(var u,d,m,h={},g=null,l=e.length,c=0;l>c;c++){var v=e[c];if(v&&"#"!==v[0]&&"/"!==v[0]&&"/"!==v[1]){var y=v.indexOf(":");if(-1!==y){var b=v.substring(0,y).trim();if("debug"!==b&&"resources"!==b)switch(m=v.substring(y+1).trim(),y=b.indexOf("("),-1!==y?(d=b.substring(y+1,b.indexOf(")")).trim().toLowerCase(),b=b.substring(0,y).trim()):d="",b){case"default-cors-maxage":case"default-request-length":case"default-websocket-request-length":case"default-request-timeout":case"default-interval-clear-cache":case"default-interval-clear-resources":case"default-interval-precompile-views":case"default-interval-websocket-ping":case"default-maximum-file-descriptors":case"default-interval-clear-dnscache":h[b]=framework_utils.parseInt(m);break;case"static-accepts-custom":g=m.replace(REG_EMPTY,"").split(",");break;case"default-root":m&&(h[b]=framework_utils.path(m));break;case"static-accepts":h[b]={},u=m.replace(REG_EMPTY,"").split(",");for(var w=0;w<u.length;w++)h[b][u[w]]=!0;break;case"allow-gzip":case"allow-websocket":case"allow-performance":case"allow-compile-html":case"allow-compile-style":case"allow-compile-script":case"disable-strict-server-certificate-validation":case"disable-clear-temporary-directory":case"trace":h[b]="true"===m.toLowerCase()||"1"===m||"on"===m;break;case"allow-compress-html":h["allow-compile-html"]="true"===m.toLowerCase()||"1"===m||"on"===m;break;case"version":h[b]=m;break;default:"string"===d?h[b]=m:"number"===d||"currency"===d||"float"===d||"double"===d?h[b]=m.isNumber(!0)?m.parseFloat():m.parseInt():"boolean"===d||"bool"===d?h[b]=m.parseBoolean():"eval"===d||"object"===d||"array"===d?h[b]=new Function("return "+m)():"json"===d?h[b]=m.parseJSON():"date"===d||"datetime"===d||"time"===d?h[b]=m.parseDate():h[b]=m.isNumber()?framework_utils.parseInt(m):m.isNumber(!0)?framework_utils.parseFloat(m):m.isBoolean()?"true"===m.toLowerCase():m}}}}return framework_utils.extend(t.config,h,r),t.config["etag-version"]||(t.config["etag-version"]=t.config.version.replace(/\.|\s/g,"")),t.config["default-timezone"]&&(process.env.TZ=t.config["default-timezone"]),g&&g.length&&g.forEach(function(e){t.config["static-accepts"][e]=!0}),t.config["disable-strict-server-certificate-validation"]===!0&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),t.config["allow-performance"]&&(http.globalAgent.maxSockets=9999),Object.keys(HEADERS).forEach(function(e){Object.keys(HEADERS[e]).forEach(function(r){"Cache-Control"===r&&(HEADERS[e][r]=HEADERS[e][r].replace(/max-age=\d+/,"max-age="+t.config["default-response-maxage"]))})}),p(),t.emit("configure",t.config),t},Framework.prototype.routeScript=function(e,r){var t=this;return-1===e.lastIndexOf(".js")&&(e+=".js"),t._routeStatic(e,t.config["static-url-script"],r)},Framework.prototype.routeStyle=function(e,r){var t=this;return-1===e.lastIndexOf(".css")&&(e+=".css"),t._routeStatic(e,t.config["static-url-style"],r)},Framework.prototype.routeImage=function(e,r){var t=this;return t._routeStatic(e,t.config["static-url-image"],r)},Framework.prototype.routeVideo=function(e,r){var t=this;return t._routeStatic(e,t.config["static-url-video"],r)},Framework.prototype.routeFont=function(e,r){var t=this;return t._routeStatic(e,t.config["static-url-font"],r)},Framework.prototype.routeDownload=function(e,r){var t=this;return t._routeStatic(e,t.config["static-url-download"],r)},Framework.prototype.routeStatic=function(e,r){var t=this;return t._routeStatic(e,t.config["static-url"],r)},Framework.prototype._routeStatic=function(e,r,t){var n=e+r+"$"+t,o=framework.temporary.other[n];if(RELEASE&&o)return o;if("~"===e[0])e=e.substring("~"===e[1]?2:1),t="";else if("="===e[0]){var i=e.indexOf("/");-1!==i&&(t=e.substring(1,i),e=e.substring(i+1),"?"===t&&(t=framework.config["default-theme"]))}var s;return e.match(REG_ROUTESTATIC)?s=e:"/"===e[0]?s=framework_utils.join(t,this._version(e)):(s=framework_utils.join(t,r,this._version(e)),REG_HTTPHTTPS.test(s)&&(s=s.substring(1))),framework.temporary.other[n]=framework_internal.preparePath(this._version(s))},Framework.prototype._version=function(e){var r=this;return r.versions&&(e=r.versions[e]||e),r.onVersion&&(e=r.onVersion(e)||e),e},Framework.prototype._version_prepare=function(e){var r=this,t=e.match(REG_VERSIONS);if(!t)return e;for(var n=0,o=t.length;o>n;n++){var i=t[n].toString(),s=5;"h"===i[0]&&(s=6);var a=i.substring(s,i.length-1);e=e.replace(t[n],i.substring(0,s)+r._version(a)+'"')}return e},Framework.prototype.lookup=function(e,r,t,n){var o=this,i="#"===r[0],s=o._length_subdomain_web&&e.subdomain?e.subdomain.join("."):null;i&&(e.path=[r]),e.$isAuthorized=!0;var a;if(!i&&(a="#"+r+"$"+e.$flags+(s?"$"+s:""),framework.temporary.other[a]))return framework.temporary.other[a];for(var u=o.routes.web.length,c=0;u>c;c++){var l=o.routes.web[c];if(l.CUSTOM){if(!l.CUSTOM(r,e,t))continue}else{if(o._length_subdomain_web&&!framework_internal.routeCompareSubdomain(s,l.subdomain))continue;if(l.isASTERIX){if(!framework_internal.routeCompare(e.path,l.url,i,!0))continue}else if(!framework_internal.routeCompare(e.path,l.url,i))continue}{if(!i){if(l.isPARAM&&l.regexp){for(var f=!1,p=0,d=l.regexpIndexer.length;d>p;p++){var m=e.path[l.regexpIndexer[p]];if(void 0===m){f=!0;break}if(!l.regexp[l.regexpIndexer[p]].test(m)){f=!0;break}}if(f)continue}if(l.flags&&l.flags.length){var h=framework_internal.routeCompareFlags2(e,l,n?!0:l.isMEMBER);if(-1===h&&(e.$isAuthorized=!1),1>h)continue}return a&&l.isCACHE&&e.$isAuthorized&&(framework.temporary.other[a]=l),l}if(l.isSYSTEM)return l}}return null},Framework.prototype.lookup_websocket=function(e,r,t){var n=this,o=n._length_subdomain_websocket&&e.subdomain?e.subdomain.join("."):null,i=n.routes.websockets.length;e.$isAuthorized=!0;for(var s=0;i>s;s++){var a=n.routes.websockets[s];if(a.CUSTOM){if(!a.CUSTOM(r,e))continue}else{if(n._length_subdomain_websocket&&!framework_internal.routeCompareSubdomain(o,a.subdomain))continue;if(a.isASTERIX){if(!framework_internal.routeCompare(e.path,a.url,!1,!0))continue}else if(!framework_internal.routeCompare(e.path,a.url,!1))continue}if(a.isPARAM&&a.regexp){for(var u=!1,c=0,l=a.regexpIndexer.length;l>c;c++){var f=e.path[a.regexpIndexer[c]];if(void 0===f){u=!0;break}if(!a.regexp[a.regexpIndexer[c]].test(f)){u=!0;break}}if(u)continue}if(a.flags&&a.flags.length){var p=framework_internal.routeCompareFlags2(e,a,t?!0:a.isMEMBER);if(-1===p&&(e.$isAuthorized=!1),1>p)continue}return a}return null},Framework.prototype.accept=function(e,r){var t=this;return"."!==e[0]&&(e="."+e),t.config["static-accepts"][e]=!0,r&&framework_utils.setContentType(e,r),t},Framework.prototype.worker=function(e,r,t,n){var o=this,i=null,s="undefined"==typeof r?"undefined":_typeof(r);if("number"===s&&void 0===t&&(t=r,r=null,s="undefined"),"string"===s&&(i=o.workers[r]||null),r instanceof Array&&(n=r,r=null,t=void 0),t instanceof Array&&(n=t,t=void 0),i)return i;var a=framework_utils.combine(o.config["directory-workers"],e)+".js";return n||(n=[]),i=child.fork(a,n,HEADERS.workers),r||(r=e+"_"+(new Date).getTime()),i.__id=r,o.workers[r]=i,i.on("exit",function(){var e=this;e.__timeout&&clearTimeout(e.__timeout),delete framework.workers[e.__id],setImmediate(function(){i.removeAllListeners(),i=null})}),"number"!=typeof t?i:(i.__timeout=setTimeout(function(){i.kill(),i=null},t),i)},Framework.prototype.worker2=function(e,r,t,n){var o=this;if("function"==typeof r)n=t,t=r,r=void 0;else if("number"==typeof t){var i=n;n=t,t=i}!r||r instanceof Array||(r=[r]);var s=o.worker(e,e,n,r);return s.__worker2?s:(s.__worker2=!0,s.on("error",function(e){t&&(t(e),t=null)}),s.on("exit",function(){t&&(t(),t=null)}),s)},Framework.prototype.wait=function(e,r){var t=this;return t.waits||(t.waits={}),void 0!==r?(r?t.waits[e]=!0:delete t.waits[e],t._length_wait=Object.keys(t.waits).length,r):(t.waits[e]?delete t.waits[e]:(t.waits[e]=!0,r=!0),t._length_wait=Object.keys(t.waits).length,r===!0)},FrameworkRestrictions.prototype.allow=function(e,r){var t=this;return void 0===r?(t.allowedIP.push(e),t.refresh(),framework):(void 0===t.allowedCustom[e]?t.allowedCustom[e]=[r]:t.allowedCustom[e].push(r),t.refresh(),framework)},FrameworkRestrictions.prototype.disallow=function(e,r){var t=this;return void 0===r?(t.blockedIP.push(e),t.refresh(),framework):(void 0===t.blockedCustom[e]?t.blockedCustom[e]=[r]:t.blockedCustom[e].push(r),t.refresh(),framework)},FrameworkRestrictions.prototype.refresh=function(){var e=this;return e.isAllowedIP=e.allowedIP.length>0,e.isBlockedIP=e.blockedIP.length>0,e.isAllowedCustom=!framework_utils.isEmpty(e.allowedCustom),e.isBlockedCustom=!framework_utils.isEmpty(e.blockedCustom),e.allowedCustomKeys=Object.keys(e.allowedCustom),e.blockedCustomKeys=Object.keys(e.blockedCustom),e.is=e.isAllowedIP||e.isBlockedIP||e.isAllowedCustom||e.isBlockedCustom,framework},FrameworkRestrictions.prototype.clearIP=function(){var e=this;return e.allowedIP=[],e.blockedIP=[],e.refresh(),framework},FrameworkRestrictions.prototype.clearHeaders=function(){var e=this;return e.allowedCustom={},e.blockedCustom={},e.allowedCustomKeys=[],e.blockedCustomKeys=[],e.refresh(),framework},FrameworkRestrictions.prototype._allowedCustom=function(e){for(var r=this,t=r.allowedCustomKeys.length,n=0;t>n;n++){var o=r.allowedCustomKeys[n],i=e[o];if(void 0===i)return!1;for(var s=r.allowedCustom[o],a=s.length,u=0;a>u;u++)if(-1===i.search(s[u]))return!1}return!0},FrameworkRestrictions.prototype._blockedCustom=function(e){for(var r=this,t=r.blockedCustomKeys.length,n=0;t>n;n++){var o=r.blockedCustomKeys[n],i=e[o];if(void 0===i)return!1;for(var s=r.blockedCustom[o],a=s.length,u=0;a>u;u++)if(-1!==i.search(s[u]))return!0}return!1},FrameworkPath.prototype.verify=function(e){var r="$directory-"+e;if(framework.temporary.path[r])return framework;var t=framework_utils.combine(framework.config["directory-"+e]);return existsSync(t)||fs.mkdirSync(t),framework.temporary.path[r]=!0,framework},FrameworkPath.prototype.exists=function(e,r){return fsFileExists(e,r),framework},FrameworkPath.prototype["public"]=function(e){return framework_utils.combine(framework.config["directory-public"],e)},FrameworkPath.prototype.public_cache=function(e){var r="public_"+e,t=framework.temporary.other[r];return t?t:framework.temporary.other[r]=framework_utils.combine(framework.config["directory-public"],e)},FrameworkPath.prototype["private"]=function(e){return framework_utils.combine(framework.config["directory-private"],e)},FrameworkPath.prototype.isomorphic=function(e){return framework_utils.combine(framework.config["directory-isomorphic"],e)},FrameworkPath.prototype.configs=function(e){return framework_utils.combine(framework.config["directory-configs"],e)},FrameworkPath.prototype.virtual=function(e){return framework_utils.combine(framework.config["directory-public-virtual"],e)},FrameworkPath.prototype.logs=function(e){return this.verify("logs"),framework_utils.combine(framework.config["directory-logs"],e)},FrameworkPath.prototype.models=function(e){return framework_utils.combine(framework.config["directory-models"],e)},FrameworkPath.prototype.temp=function(e){return this.verify("temp"),framework_utils.combine(framework.config["directory-temp"],e)},FrameworkPath.prototype.temporary=function(e){return this.temp(e)},FrameworkPath.prototype.views=function(e){return framework_utils.combine(framework.config["directory-views"],e)},FrameworkPath.prototype.workers=function(e){return framework_utils.combine(framework.config["directory-workers"],e)},FrameworkPath.prototype.databases=function(e){return this.verify("databases"),framework_utils.combine(framework.config["directory-databases"],e)},FrameworkPath.prototype.modules=function(e){return framework_utils.combine(framework.config["directory-modules"],e)},FrameworkPath.prototype.controllers=function(e){return framework_utils.combine(framework.config["directory-controllers"],e)},FrameworkPath.prototype.definitions=function(e){return framework_utils.combine(framework.config["directory-definitions"],e)},FrameworkPath.prototype.tests=function(e){return framework_utils.combine(framework.config["directory-tests"],e)},FrameworkPath.prototype.resources=function(e){return framework_utils.combine(framework.config["directory-resources"],e)},FrameworkPath.prototype.services=function(e){return framework_utils.combine(framework.config["directory-services"],e)},FrameworkPath.prototype.packages=function(e){return framework_utils.combine(framework.config["directory-packages"],e)},FrameworkPath.prototype.themes=function(e){return framework_utils.combine(framework.config["directory-themes"],e)},FrameworkPath.prototype.root=function(e){var r=path.join(directory,e||"");return framework.isWindows?r.replace(/\\/g,"/"):r},FrameworkPath.prototype["package"]=function(e,r){if(void 0===r){var t=e.indexOf("/");-1!==t&&(r=e.substring(t+1),e=e.substring(0,t))}var n=path.join(directory,framework.config["directory-temp"],e+".package",r||"");return framework.isWindows?n.replace(REG_WINDOWSPATH,"/"):n},FrameworkCache.prototype.init=function(){return this.interval=setInterval(function(){return framework.cache.recycle()},6e4),this},FrameworkCache.prototype.stop=function(){var e=this;return clearInterval(e.interval),e},FrameworkCache.prototype.clear=function(){var e=this;return e.items={},e},FrameworkCache.prototype.recycle=function(){var e=this,r=e.items,t=new Date;e.count++;for(var n in r){var o=r[n];o.expire<t&&(framework.emit("cache-expire",n,o.value),delete r[n])}return framework._service(e.count),e},FrameworkCache.prototype.add=function(e,r,t,n){var o=this,i="undefined"==typeof t?"undefined":_typeof(t);switch(i){case"string":t=t.parseDateExpiration();break;case"undefined":t=(new Date).add("m",5)}return o.items[e]={value:r,expire:t},framework.emit("cache-set",e,r,t,n),r},FrameworkCache.prototype.set=function(e,r,t,n){return this.add(e,r,t,n)},FrameworkCache.prototype.read=function(e,r){return this.get(e)},FrameworkCache.prototype.get=function(e,r){var t=this,n=t.items[e];return n?n.expire<new Date?(delete t.items[e],"undefined"==typeof r?null:r):n.value:"undefined"==typeof r?null:r},FrameworkCache.prototype.setExpire=function(e,r){var t=this,n=t.items[e];return n?("string"==typeof r&&(r=r.parseDateExpiration()),n.expire=r,t):t},FrameworkCache.prototype.remove=function(e){var r=this,t=r.items[e]||null;return delete r.items[e],t},FrameworkCache.prototype.removeAll=function(e){var r=this,t=0,n=framework_utils.isRegExp(e);for(var o in r.items){if(n){if(!e.test(o))continue}else if(-1===o.indexOf(e))continue;r.remove(o),t++}return t},FrameworkCache.prototype.fn=function(e,r,t){var n=this,o=n.read(e);return o?(t&&t(o),n):(r(function(r,o){n.add(e,r,o),t&&t(r)}),n)};var REPOSITORY_HEAD="$head",REPOSITORY_META="$meta",REPOSITORY_META_TITLE="$title",REPOSITORY_META_DESCRIPTION="$description",REPOSITORY_META_KEYWORDS="$keywords",REPOSITORY_META_IMAGE="$image",REPOSITORY_PLACE="$place",REPOSITORY_SITEMAP="$sitemap",ATTR_END='"';Subscribe.prototype.success=function(){var e=this;return e.timeout&&clearTimeout(e.timeout),e.timeout=null,e.isCanceled=!0,e.controller&&e.controller.res&&(e.controller.res.controller=null,e.controller=null),e},Subscribe.prototype.file=function(){var e=this,r=this;return r.req.on("end",function(){return r.doEndfile(e)}),r.req.resume(),r},Subscribe.prototype.multipart=function(e){var r=this,t=r.req;return r.route=framework.lookup(t,t.uri.pathname,t.flags,!0),r.header=e,r.route?(framework.path.verify("temp"),framework_internal.parseMULTIPART(t,e,r.route,framework.config["directory-temp"],r),r):(framework._request_stats(!1,!1),framework.stats.request.blocked++,r.res.writeHead(403),r.res.end(),r)},Subscribe.prototype.urlencoded=function(){var e=this;return e.route=framework.lookup(e.req,e.req.uri.pathname,e.req.flags,!0),e.route?(e.req.buffer_has=!0,e.req.buffer_exceeded=!1,e.req.on("data",function(r){return e.doParsepost(r)}),e.end(),e):(framework.stats.request.blocked++,framework._request_stats(!1,!1),e.res.writeHead(403),e.res.end(),framework.emit("request-end",e.req,e.res),e.req.clear(!0),e)},Subscribe.prototype.end=function(){var e=this;e.req.on("end",function(){return e.doEnd()}),e.req.resume()},Subscribe.prototype.execute=function(e,r){var t=this,n=t.route,o=t.req,i=t.res;if(!r&&n||(framework.stats.response["error"+e]++,500!==e&&framework.emit("error"+e,o,i,t.exception)),!n){if(e||(e=404),400===e&&t.exception instanceof framework_builders.ErrorBuilder){o.$language&&t.exception.resource(o.$language,framework.config["default-errorbuilder-resource-prefix"]);var s=t.exception.output();return framework.responseContent(o,i,200,s,t.exception.contentType,framework.config["allow-gzip"]),t}return framework.responseContent(o,i,e,framework_utils.httpStatus(e)+prepare_error(t.exception),CONTENTTYPE_TEXTPLAIN,framework.config["allow-gzip"]),t}var a=n.controller;n.isMOBILE_VARY&&(o.$mobile=!0),void 0===n.currentViewDirectory&&(n.currentViewDirectory="#"!==a[0]&&"default"!==a&&""!==a?"/"+a+"/":"");var u=new Controller(a,o,i,t,n.currentViewDirectory);return u.isTransfer=t.isTransfer,u.exception=t.exception,t.controller=u,!t.isCanceled&&n.timeout&&(t.timeout&&clearTimeout(t.timeout),t.timeout=setTimeout(function(){t.controller&&t.controller.precache&&t.controller.precache(null,null,null),t.doCancel()},n.timeout)),n.isDELAY&&t.res.writeContinue(),framework._length_middleware&&n.middleware?void async_middleware(0,o,i,n.middleware,function(){return t.doExecute()},n.options,u):t.doExecute()},Subscribe.prototype.prepare=function(e,r){var t=this,n=t.req,o=t.res,i=framework.onAuthorize;if(i){var s=e.length;return i(n,o,e,function(r,o){s!==e.length&&(n.$flags+=e.slice(s).join("")),"boolean"!=typeof r&&(o=r,r=!o),n.isAuthorized=r,t.doAuthorization(r,o)}),t}t.route||(t.route=framework.lookup(n,n.buffer_exceeded?"#431":r||n.uri.pathname,n.flags)),t.route||(t.route=framework.lookup(n,"#404"));var a=n.buffer_exceeded?431:404;return t.schema&&t.route?(t.validate(t.route,function(){return t.execute(a)}),t):void t.execute(a)},Subscribe.prototype.doExecute=function(){var e=this,r=e.route.controller,t=e.controller,n=e.req;try{return framework.onTheme&&(t.themeName=framework.onTheme(t)),t.isCanceled?e:(framework.emit("controller",t,r,e.route.options),t.isCanceled?e:(e.route.isCACHE&&!framework.temporary.other[n.uri.pathname]&&(framework.temporary.other[n.uri.pathname]=n.path),e.route.isGENERATOR?async.call(t,e.route.execute,!0)(t,framework_internal.routeParam(e.route.param.length?n.split:n.path,e.route)):e.route.execute.apply(t,framework_internal.routeParam(e.route.param.length?n.split:n.path,e.route)),e))}catch(o){t=null,framework.error(o,r,n.uri),e.exception=o,e.route=framework.lookup(n,"#500"),e.execute(500,!0)}return e},Subscribe.prototype.doAuthorization=function(e,r){var t=this,n=t.req,o=e?"authorize":"unauthorize";if(n.flags.push(o),n.$flags+=o,r&&(n.user=r),t.route&&!t.route.isMEMBER&&e)return t.schema?void t.validate(t.route,function(){return t.execute(a)}):void t.execute(n.buffer_exceeded?431:401,!0);var i=framework.lookup(n,n.buffer_exceeded?"#431":n.uri.pathname,n.flags),s=n.$isAuthorized?404:401;i||(i=framework.lookup(n,"#"+s)),t.route=i;var a=n.buffer_exceeded?431:s;return t.schema&&i?(t.validate(t.route,function(){return t.execute(a)}),t):(t.execute(a),t)},Subscribe.prototype.doEnd=function(){var e=this,r=e.req,t=e.res,n=e.route;if(r.buffer_exceeded)return n=framework.lookup(r,"#431"),r.buffer_data=null,n?(e.route=n,e.execute(431,!0),e):(framework.response431(r,t),e);n&&n.isBINARY||(r.buffer_data=r.buffer_data.toString(ENCODING));if(!r.buffer_data)return n&&n.schema&&(e.schema=!0),r.buffer_data=null,e.prepare(r.flags,r.uri.pathname),e;if(n.isXML){if(2!==r.$type)return e.route400('Invalid "Content-Type".'),r.buffer_data=null,e;try{r.body=framework.onParseXML(r.buffer_data.trim()),r.buffer_data=null,e.prepare(r.flags,r.uri.pathname)}catch(o){F.error(o,null,r.uri),e.route500(o)}return e}if(e.route.isRAW)return r.body=r.buffer_data,r.buffer_data=null,e.prepare(r.flags,r.uri.pathname),e;if(!r.$type)return r.buffer_data=null,e.route400('Invalid "Content-Type".'),e;if(1===r.$type)try{r.body=framework.onParseJSON(r.buffer_data),r.buffer_data=null}catch(i){return e.route400("Invalid JSON data."),e}else r.body=framework.onParseQuery(r.buffer_data);return e.route.schema&&(e.schema=!0),r.buffer_data=null,e.prepare(r.flags,r.uri.pathname),e},Subscribe.prototype.validate=function(e,r){var t=this,n=t.req;return t.schema=!1,e.schema&&"DELETE"!==n.method?void framework.onSchema(n,e.schema[0],e.schema[1],function(e,o){return e?(t.route400(e),r=null,t):(n.body=o,void r())},e.schema[2]):r()},Subscribe.prototype.route400=function(e){var r=this;return r.route=framework.lookup(r.req,"#400"),r.exception=e,r.execute(400,!0),r},Subscribe.prototype.route500=function(e){var r=this;return r.route=framework.lookup(r.req,"#500"),r.exception=e,r.execute(500,!0),r},Subscribe.prototype.doEndfile=function(){var e=this,r=e.req,t=e.res;if(!framework._length_files)return void framework.responseStatic(e.req,e.res);for(var n=0;n<framework._length_files;n++){var o=framework.routes.files[n];try{if(o.extensions&&!o.extensions[e.req.extension])continue;if(o.url){var i=!1,s=o.url.length;if(!o.wildcard&&!o.fixedfile&&s!==r.path.length-1)continue;for(var a=0;s>a;a++)if(o.url[a]!==r.path[a]){i=!0;break}if(i)continue}else if(o.onValidate&&!o.onValidate.call(framework,r,t,!0))continue;return o.middleware?e.doEndfile_middleware(o):o.execute.call(framework,r,t,!1),e}catch(u){return framework.error(u,o.controller,r.uri),framework.responseContent(r,t,500,"500 - internal server error",CONTENTTYPE_TEXTPLAIN,framework.config["allow-gzip"]),e}}return framework.responseStatic(e.req,e.res),e},Subscribe.prototype.doEndfile_middleware=function(e){var r=this;async_middleware(0,r.req,r.res,e.middleware,function(){try{e.execute.call(framework,r.req,r.res,!1)}catch(t){framework.error(t,e.controller+" :: "+e.name,r.req.uri),framework.responseContent(r.req,r.res,500,"500 - internal server error",CONTENTTYPE_TEXTPLAIN,framework.config["allow-gzip"])}},e.options)},Subscribe.prototype.doParsepost=function(e){var r=this,t=r.req;return t.buffer_exceeded?r:(t.buffer_exceeded||(t.buffer_data=Buffer.concat([t.buffer_data,e])),t.buffer_data.length<r.route.length?r:(t.buffer_exceeded=!0,t.buffer_data=new Buffer(""),r))},Subscribe.prototype.doCancel=function(){var e=this;framework.stats.response.timeout++,clearTimeout(e.timeout),e.timeout=null,e.controller&&(e.controller.isTimeout=!0,e.controller.isCanceled=!0,e.route=framework.lookup(e.req,"#408"),e.execute(408,!0))},Controller.prototype={get sseID(){return this.req.headers["last-event-id"]||null},get route(){return this.subscribe.route},get options(){return this.subscribe.route.options},get flags(){return this.subscribe.route.flags},get path(){return framework.path},get get(){return this.req.query},get query(){return this.req.query},get post(){return this.req.body},get body(){return this.req.body},get files(){return this.req.files},get subdomain(){return this.req.subdomain},get ip(){return this.req.ip},get xhr(){return this.req.xhr},get url(){return framework_utils.path(this.req.uri.pathname)},get uri(){return this.req.uri},get cache(){return framework.cache},get config(){return framework.config},get controllers(){return framework.controllers},get isProxy(){return this.req.isProxy},get isDebug(){return framework.config.debug},get isTest(){return"1"===this.req.headers["x-assertion-testing"]},get isSecure(){return this.req.isSecure},get secured(){return this.req.secured},get session(){return this.req.session},set session(e){this.req.session=e},get user(){return this.req.user},set user(e){this.req.user=e},get mobile(){return this.req.mobile},get robot(){return this.req.robot},get viewname(){var e=this.req.path[this.req.path.length-1];return e&&"/"!==e||(e="index"),e}},Controller.prototype.$get=Controller.prototype.$read=function(e,r){return this.getSchema().get(e,r),this},Controller.prototype.$query=function(e,r){return this.getSchema().query(e,r),this},Controller.prototype.$save=function(e,r){var t=this;return framework_builders.isSchema(t.body)?t.body.$save(e,r):t.getSchema()["default"]().$save(e,r),t},Controller.prototype.$remove=function(e,r){var t=this;return t.getSchema().remove(e,r),this},Controller.prototype.$workflow=function(e,r,t){var n=this;return framework_builders.isSchema(n.body)?n.body.$workflow(e,r,t):n.getSchema().workflow(e,null,r,t,!0),n},Controller.prototype.$workflow2=function(e,r,t){var n=this;return n.getSchema().workflow2(e,r,t),n},Controller.prototype.$transform=function(e,r,t){var n=this;return framework_builders.isSchema(n.body)?n.body.$transform(e,r,t):n.getSchema().transform(e,null,r,t,!0),n},Controller.prototype.$transform2=function(e,r,t){var n=this;return n.getSchema().transform2(e,r,t),n},Controller.prototype.$operation=function(e,r,t){var n=this;return framework_builders.isSchema(n.body)?n.body.$operation(e,r,t):n.getSchema().operation(e,null,r,t,!0),n},Controller.prototype.$operation2=function(e,r,t){var n=this;return n.getSchema().operation2(e,r,t),n},Controller.prototype.$async=function(e,r){var t=this;return framework_builders.isSchema(t.body)?t.body.$async(e,r):t.getSchema()["default"]().$async(e,r)},Controller.prototype.getSchema=function(){var e=this.subscribe.route;if(!e.schema||!e.schema[1])throw new Error("The controller's route does not define any schema.");var r=GETSCHEMA(e.schema[0],e.schema[1]);if(!r)throw new Error('Schema "{0}" does not exist.'.format(e.schema[1]));return r},Controller.prototype.cookie=function(e,r,t,n){var o=this;return void 0===r?o.req.cookie(e):(o.res.cookie(e,r,t,n),o)},Controller.prototype.clear=function(){var e=this;return e.req.clear(),e},Controller.prototype.translate=function(e,r){return r||(r=e,e=this.language),framework.translate(e,r)},Controller.prototype.middleware=function(e,r,t){if("string"==typeof e&&(e=[e]),"function"==typeof r){var n=t;t=r,r=n}r||(r={});var o=this;return async_middleware(0,o.req,o.res,e,function(){t&&t()},r,o),o},Controller.prototype.pipe=function(e,r,t){var n=this;if("function"==typeof r){var o=t;t=r,r=o}return n.res.success||n.res.headersSent||!n.isConnected?n:(framework.responsePipe(n.req,n.res,e,r,null,function(){n.subscribe.success(),t&&t()}),n)},Controller.prototype.encrypt=function(){return framework.encrypt.apply(framework,arguments)},Controller.prototype.decrypt=function(){return framework.decrypt.apply(framework,arguments)},Controller.prototype.hash=function(){return framework.hash.apply(framework,arguments)},Controller.prototype.date=function(e,r,t){void 0===t&&(t=r,r=new Date);var n="string"==typeof r?r.parseDate():r,o="string"==typeof t?t.parseDate():t,i=n.compare(o);switch(e){case">":return 1===i;case">=":case"=>":return 1===i||0===i;case"<":return-1===i;case"<=":case"=<":return-1===i||0===i;case"=":return 0===i}return!0},Controller.prototype.header=function(e,r){var t=this;return t.res.setHeader(e,r),t},Controller.prototype.host=function(e){var r=this;return r.req.hostname(e)},Controller.prototype.hostname=function(e){var r=this;return r.req.hostname(e)},Controller.prototype.resource=function(e,r){return framework.resource(e,r)},Controller.prototype.error=function(e){var r=this;if(e instanceof ErrorBuilder)return r.content(e),r;var t=framework.error("string"==typeof e?new Error(e):e,r.name,r.uri);return void 0===e?t:r.subscribe?(r.subscribe.exception=e,r.exception=e,r):r},Controller.prototype.invalid=function(e){var r=this;e&&(r.status=e);var t=new ErrorBuilder;return setImmediate(function(e){return r.content(t)}),t},Controller.prototype.problem=function(e){var r=this;return framework.problem(e,r.name,r.uri,r.ip),r},Controller.prototype.change=function(e){var r=this;return framework.change(e,r.name,r.uri,r.ip),r},Controller.prototype.trace=function(e){var r=this;return framework.trace(e,r.name,r.uri,r.ip),r},Controller.prototype.transfer=function(e,r){var t=this,n=framework.routes.web.length,o=framework_internal.routeSplit(e.trim()),i="#"===e[0],s=!r||0===r.length,a=null;t.req.$isAuthorized=!0;for(var u=0;n>u;u++){var c=framework.routes.web[u];if(c.isASTERIX){if(!framework_internal.routeCompare(o,c.url,i,!0))continue}else if(!framework_internal.routeCompare(o,c.url,i))continue;if(s){a=c;break}if(c.flags&&c.flags.length){var l=framework_internal.routeCompareFlags(c.flags,r,!0);if(-1===l&&(t.req.$isAuthorized=!1),1>l)continue}a=c;break}return a?(t.cancel(),t.req.path=EMPTYARRAY,t.subscribe.isTransfer=!0,t.subscribe.success(),t.subscribe.route=a,t.subscribe.execute(404),!0):!1},Controller.prototype.cancel=function(){var e=this;return e.isCanceled=!0,e},Controller.prototype.log=function(){var e=this;return framework.log.apply(framework,arguments),e},Controller.prototype.logger=function(){var e=this;return framework.logger.apply(framework,arguments),e},Controller.prototype.meta=function(){var e=this;return arguments[0]&&(e.repository[REPOSITORY_META_TITLE]=arguments[0]),arguments[1]&&(e.repository[REPOSITORY_META_DESCRIPTION]=arguments[1]),arguments[2]&&arguments[2].length&&(e.repository[REPOSITORY_META_KEYWORDS]=arguments[2]instanceof Array?arguments[2].join(", "):arguments[2]),
arguments[3]&&(e.repository[REPOSITORY_META_IMAGE]=arguments[3]),e},Controller.prototype.$dns=function(e){for(var r="",t=this,n=arguments.length,o=0;n>o;o++)r+='<link rel="dns-prefetch" href="'+t._prepareHost(arguments[o])+'" />';return t.head(r),""},Controller.prototype.$prefetch=function(){for(var e="",r=this,t=arguments.length,n=0;t>n;n++)e+='<link rel="prefetch" href="'+r._prepareHost(arguments[n])+'" />';return r.head(e),""},Controller.prototype.$prerender=function(e){for(var r="",t=this,n=arguments.length,o=0;n>o;o++)r+='<link rel="prerender" href="'+t._prepareHost(arguments[o])+'" />';return t.head(r),""},Controller.prototype.$next=function(e){var r=this;return r.head('<link rel="next" href="'+r._prepareHost(e)+'" />'),""},Controller.prototype.$prev=function(e){var r=this;return r.head('<link rel="prev" href="'+r._prepareHost(e)+'" />'),""},Controller.prototype.$canonical=function(e){var r=this;return r.head('<link rel="canonical" href="'+r._prepareHost(e)+'" />'),""},Controller.prototype.$meta=function(){var e=this;if(arguments.length)return e.meta.apply(e,arguments),"";framework.emit("controller-render-meta",e);var r=e.repository;return framework.onMeta.call(e,r[REPOSITORY_META_TITLE],r[REPOSITORY_META_DESCRIPTION],r[REPOSITORY_META_KEYWORDS],r[REPOSITORY_META_IMAGE])},Controller.prototype.title=function(e){var r=this;return r.$title(e),r},Controller.prototype.description=function(e){var r=this;return r.$description(e),r},Controller.prototype.keywords=function(e){var r=this;return r.$keywords(e),r},Controller.prototype.$title=function(e){var r=this;return e&&(r.repository[REPOSITORY_META_TITLE]=e),""},Controller.prototype.$description=function(e){var r=this;return e&&(r.repository[REPOSITORY_META_DESCRIPTION]=e),""},Controller.prototype.$keywords=function(e){var r=this;return e&&e.length&&(r.repository[REPOSITORY_META_KEYWORDS]=e instanceof Array?e.join(", "):e),""},Controller.prototype.sitemap_navigation=function(e,r){return framework.sitemap_navigation(e,r||this.language)},Controller.prototype.sitemap_url=function(e,r,t,n,o,i,s){var a=this;e||(e=a.repository[REPOSITORY_SITEMAP]);var u=F.sitemap(e,!0,a.language);return u?u.url.format(r,t,n,o,i,s):""},Controller.prototype.sitemap_name=function(e,r,t,n,o,i,s){var a=this;e||(e=a.repository[REPOSITORY_SITEMAP]);var u=F.sitemap(e,!0,a.language);return u?u.name.format(r,t,n,o,i,s):""},Controller.prototype.sitemap_change=function(e,r,t){var n=this.repository[REPOSITORY_SITEMAP];n||(n=this.sitemap(e)),n.$cloned||(n=framework_utils.clone(n),n.$cloned=!0,this.repository[REPOSITORY_SITEMAP]=n);for(var o=0,i=n.length;i>o;o++)if(n[o].id===e)return"function"==typeof t?n[o][r]=t(n[o][r]):n[o][r]=t,this;return this},Controller.prototype.$sitemap_change=function(e,r,t){return this.sitemap_change.apply(this,arguments),""},Controller.prototype.sitemap=function(e){var r,t=this;return e instanceof Array?(t.repository[REPOSITORY_SITEMAP]=e,t):e?(r=framework.sitemap(e,!1,t.language),t.repository[REPOSITORY_SITEMAP]=r,t.repository[REPOSITORY_META_TITLE]||(r=r.last(),r&&(t.repository[REPOSITORY_META_TITLE]=r.name)),t.repository[REPOSITORY_SITEMAP]):(r=t.repository[REPOSITORY_SITEMAP],r?r:t.repository.sitemap||[])},Controller.prototype.$sitemap=function(e){var r=this;return r.sitemap.apply(r,arguments),""},Controller.prototype.module=function(e){return framework.module(e)},Controller.prototype.layout=function(e){var r=this;return r.layoutName=e,r},Controller.prototype.theme=function(e){var r=this;return r.themeName=e,r},Controller.prototype.$layout=function(e){var r=this;return r.layoutName=e,""},Controller.prototype.model=function(e){return framework.model(e)},Controller.prototype.mail=function(e,r,t,n,o){"function"==typeof n&&(o=n,n=null);var i=this;"string"==typeof i.language&&(r=-1===r.indexOf("@(")?framework.translate(i.language,r):framework.translator(i.language,r));var s=i.layoutName,a=i.view(t,n,!0);return i.layoutName=s,framework.onMail(e,r,a,o)},Controller.prototype.notModified=function(e,r){var t=this;return framework.notModified(t.req,t.res,e,r)},Controller.prototype.setModified=function(e){var r=this;return framework.setModified(r.req,r.res,e),r},Controller.prototype.setExpires=function(e){var r=this;return e?(r.res.setHeader("Expires",e.toUTCString()),r):r},Controller.prototype.$template=function(e,r,t,n){return this.$viewToggle(!0,e,r,t,n)},Controller.prototype.$templateToggle=function(e,r,t,n,o){return this.$viewToggle(e,r,t,n,o)},Controller.prototype.$view=function(e,r,t,n){return this.$viewToggle(!0,e,r,t,n)},Controller.prototype.$viewToggle=function(e,r,t,n,o){if(!e)return"";var i,s=this;if(n){i="$view."+r+"."+(o||"");var a=s.cache.read(i);if(a)return a}var u=s.layoutName;s.layoutName="";var c=s.view(r,t,null,!0);return s.layoutName=u,null===c?"":(n&&s.cache.add(i,c,n),c)},Controller.prototype.place=function(e){var r=this,t=REPOSITORY_PLACE+"_"+e,n=arguments.length;if(1===n)return r.repository[t]||"";for(var o="",i=1;n>i;i++){var s=arguments[i];s=s?s.toString():"",s.endsWith(".js")&&(s='<script src="'+s+'"></script>'),o+=s}return r.repository[t]=(r.repository[t]||"")+o,r},Controller.prototype.section=function(e,r,t){var n=this,o="$section_"+e;return void 0===r?n.repository[o]:t?(n.repository[o]=r,n):(n.repository[o]?n.repository[o]+=r:n.repository[o]=r,n)},Controller.prototype.$place=function(){var e=this;return 1===arguments.length?e.place.apply(e,arguments):(e.place.apply(e,arguments),"")},Controller.prototype.$url=function(e){var r=this;return e?r.req.hostname(r.url):r.url},Controller.prototype.$helper=function(e){var r=this;return r.helper.apply(r,arguments)},Controller.prototype.href=function(e,r){var t=this;if(!arguments.length){var n=qs.stringify(t.query);return n?"?"+n:""}var o="undefined"==typeof e?"undefined":_typeof(e),i=framework_utils.copy(t.query);return r&&"object"===o&&framework_utils.extend(i,r),void 0!==r&&null!==r&&(i[e]=r),i=qs.stringify(i),void 0===r&&"string"===o&&(i&&(i+="&"),i+=e),t.url+(i?"?"+i:"")},Controller.prototype.$checked=function(e,r,t){var n=this;return n.$isValue(e,r,t,'checked="checked"')},Controller.prototype.$disabled=function(e,r,t){var n=this;return n.$isValue(e,r,t,'disabled="disabled"')},Controller.prototype.$selected=function(e,r,t){var n=this;return n.$isValue(e,r,t,'selected="selected"')},Controller.prototype.$set=function(e){return""},Controller.prototype.$readonly=function(e,r,t){var n=this;return n.$isValue(e,r,t,'readonly="readonly"')},Controller.prototype.$header=function(e,r){return this.header(e,r),""},Controller.prototype.$text=function(e,r,t){return this.$input(e,"text",r,t)},Controller.prototype.$password=function(e,r,t){return this.$input(e,"password",r,t)},Controller.prototype.$hidden=function(e,r,t){return this.$input(e,"hidden",r,t)},Controller.prototype.$radio=function(e,r,t,n){return"string"==typeof n&&(n={label:n}),n.value=t,this.$input(e,"radio",r,n)},Controller.prototype.$checkbox=function(e,r,t){return"string"==typeof t&&(t={label:t}),this.$input(e,"checkbox",r,t)},Controller.prototype.$textarea=function(e,r,t){var n="<textarea";"object"!==("undefined"==typeof t?"undefined":_typeof(t))&&(t={}),n+=' name="'+r+'" id="'+(t.id||r)+ATTR_END;for(var o in t)switch(o){case"name":case"id":break;case"required":case"disabled":case"readonly":case"value":n+=" "+o+'="'+o+ATTR_END;break;default:n+=" "+o+'="'+t[o].toString().encode()+ATTR_END}if(void 0===e)return n+"></textarea>";var i=e[r]||t.value||"";return n+">"+i.toString().encode()+"</textarea>"},Controller.prototype.$input=function(e,r,t,n){var o=["<input"];"object"!==("undefined"==typeof n?"undefined":_typeof(n))&&(n={});var i=n.value||"";o+=' type="'+r+ATTR_END,o+="radio"===r?' name="'+t+ATTR_END:' name="'+t+'" id="'+(n.id||t)+ATTR_END,n.autocomplete&&(o+=n.autocomplete===!0||"on"===n.autocomplete?' autocomplete="on"':' autocomplete="off"');for(var s in n)switch(s){case"name":case"id":case"type":case"autocomplete":case"checked":case"value":case"label":break;case"required":case"disabled":case"readonly":case"autofocus":o+=" "+s+'="'+s+ATTR_END;break;default:o+=" "+s+'="'+n[s].toString().encode()+ATTR_END}var a="";return void 0!==e&&(a=e[t],"checkbox"===r&&("1"!=a&&"true"!==a&&a!==!0&&"on"!==a||(o+=' checked="checked"'),a=i||"1"),"radio"===r&&(i=(i||"").toString(),a.toString()===i&&(o+=' checked="checked"'),a=i||"")),o+=void 0!==a?' value="'+(a||"").toString().encode()+ATTR_END:' value="'+(n.value||"").toString().encode()+ATTR_END,o+=" />",n.label?"<label>"+o+" <span>"+n.label+"</span></label>":o},Controller.prototype._prepareHost=function(e){if(!e)return e;var r=e.substring(0,5);return"http:"===r||"https"===r||"/"===r[0]&&"/"===r[1]||(e=this.host(e)),e},Controller.prototype.head=function(){var e=this,r=arguments.length;if(!r)return framework.emit("controller-render-head",e),(e.config.author?'<meta name="author" content="'+e.config.author+'" />':"")+(e.repository[REPOSITORY_HEAD]||"");for(var t=e.repository[REPOSITORY_HEAD]||"",n="",o=0;r>o;o++){var i=arguments[o];if(-1===i.indexOf("<")){var s=i.substring(0,7),a="/"!==s[0]&&"/"!==s[1]&&"http://"!==s&&"https:/"!==s;i.endsWith(".css",!0)?n+='<link type="text/css" rel="stylesheet" href="'+(a?e.routeStyle(i):i)+'" />':-1!==i.endsWith(".js",!0)&&(n+='<script src="'+(a?e.routeScript(i):i)+'"></script>')}else n+=i}return t+=n,e.repository[REPOSITORY_HEAD]=t,e},Controller.prototype.$head=function(){var e=this;return e.head.apply(e,arguments),""},Controller.prototype.$isValue=function(e,r,t,n){return e?(r=r||" ",t=t||"",r+n+t):""},Controller.prototype.$modified=function(e){var r,t=this,n="undefined"==typeof e?"undefined":_typeof(e);if("number"===n)r=new Date(e);else if("string"===n){var o=e.split(" ");r=o[0].split("-");var i=(o[1]||"").split(":"),s=framework_utils.parseInt(r[0]||""),a=framework_utils.parseInt(r[1]||"")-1,u=framework_utils.parseInt(r[2]||"")-1;0>a&&(a=0),0>u&&(u=0);var c=framework_utils.parseInt(i[0]||""),l=framework_utils.parseInt(i[1]||""),f=framework_utils.parseInt(i[2]||"");r=new Date(s,a,u,c,l,f,0)}else framework_utils.isDate(e)&&(r=e);return void 0===r?"":(t.setModified(r),"")},Controller.prototype.$etag=function(e){return this.setModified(e),""},Controller.prototype.$options=function(e,r,t,n){var o="undefined"==typeof e?"undefined":_typeof(e);if(!e)return"";var i=!1,s=null;e instanceof Array||"object"!==o||(i=!0,s=e,e=Object.keys(e)),framework_utils.isArray(e)||(e=[e]),r=r||"";var a="";i||(void 0===n&&(n=n||t||"value"),void 0===t&&(t=t||"name"));var u=!1,c=0;c=e.length;for(var l=0;c>l;l++){var f=e[l],o="undefined"==typeof f?"undefined":_typeof(f),p="",d="",m=!1;i?t===!0?(d=s[f],p=f,n||(n="")):(d=f,p=s[f],p||(p="")):"object"===o?(p=f[t]||"",d=f[n]||"","function"==typeof p&&(p=p(l)),"function"==typeof d&&(d=d(l,p))):(p=f,d=f),u||(m=d==r,u=m),a+='<option value="'+d.toString().encode()+'"'+(m?' selected="selected"':"")+">"+p.toString().encode()+"</option>"}return a},Controller.prototype.$script=function(){var e=this;return e.$js.apply(e,arguments)},Controller.prototype.$js=function(){for(var e=this,r="",t=0;t<arguments.length;t++)r+=e.routeScript(arguments[t],!0);return r},Controller.prototype.$import=function(){for(var e=this,r="",t=0;t<arguments.length;t++){var n=arguments[t];if("head"!==n)if("meta"!==n){var o=n.substring(n.lastIndexOf(".")),i="!"!==n[0];switch(i||(n=n.substring(1)),o){case".js":r+=e.routeScript(n,i);break;case".css":r+=e.routeStyle(n,i);break;case".ico":r+=e.$favicon(n);break;case".mp4":case".avi":case".ogv":case".webm":case".mov":case".mpg":case".mpe":case".mpeg":case".m4v":r+=e.routeVideo(n);break;case".jpg":case".gif":case".png":case".jpeg":r+=e.routeImage(n);break;default:r+=e.routeStatic(n)}}else r+=e.$meta();else r+=e.head()}return r},Controller.prototype.$css=function(){for(var e=this,r="",t=0;t<arguments.length;t++)r+=e.routeStyle(arguments[t],!0);return r},Controller.prototype.$image=function(e,r,t,n,o){var i="";"object"===("undefined"==typeof r?"undefined":_typeof(r))&&(t=r.height,n=r.alt,o=r["class"],i=r.style,r=r.width);var s='<img src="'+this.routeImage(e)+ATTR_END;return r>0&&(s+=' width="'+r+ATTR_END),t>0&&(s+=' height="'+t+ATTR_END),n&&(s+=' alt="'+n.encode()+ATTR_END),o&&(s+=' class="'+o+ATTR_END),i&&(s+=' style="'+i+ATTR_END),s+' border="0" />'},Controller.prototype.$download=function(e,r,t,n){var o='<a href="'+framework.routeDownload(e)+ATTR_END;return t&&(o+=' download="'+t+ATTR_END),n&&(o+=' class="'+n+ATTR_END),o+">"+(r||e)+"</a>"},Controller.prototype.$json=function(e,r,t){if("boolean"==typeof r){var n=r;r=t,t=n}var o=t?JSON.stringify(e,null,4):JSON.stringify(e);return r?'<script type="application/json" id="'+r+'">'+o+"</script>":o},Controller.prototype.$favicon=function(e){var r="image/x-icon";void 0===e&&(e="favicon.ico");var t="favicon#"+e;return framework.temporary.other[t]?framework.temporary.other[t]:(-1!==e.lastIndexOf(".png")?r="image/png":-1!==e.lastIndexOf(".gif")&&(r="image/gif"),e=framework.routeStatic("/"+e),framework.temporary.other[t]='<link rel="shortcut icon" href="'+e+'" type="'+r+'" />')},Controller.prototype._routeHelper=function(e,r){return r.call(framework,prepare_staticurl(e,!1),this.themeName)},Controller.prototype.routeScript=function(e,r){var t=this;void 0===e&&(e="default.js");var n=t._routeHelper(e,framework.routeScript);return r?'<script src="'+n+'"></script>':n},Controller.prototype.routeStyle=function(e,r){var t=this;void 0===e&&(e="default.css");var n=t._routeHelper(e,framework.routeStyle);return r?'<link type="text/css" rel="stylesheet" href="'+n+'" />':n},Controller.prototype.routeImage=function(e){var r=this;return r._routeHelper(e,framework.routeImage)},Controller.prototype.routeVideo=function(e){var r=this;return r._routeHelper(e,framework.routeVideo)},Controller.prototype.routeFont=function(e){return framework.routeFont(e)},Controller.prototype.routeDownload=function(e){var r=this;return r._routeHelper(e,framework.routeDownload)},Controller.prototype.routeStatic=function(e){var r=this;return r._routeHelper(e,framework.routeStatic)},Controller.prototype.template=function(e,r){return this.view(e,r,!0)},Controller.prototype.helper=function(e){var r=this,t=framework.helpers[e];if(!t)return"";for(var n=[],o=1;o<arguments.length;o++)n.push(arguments[o]);return t.apply(r,n)},Controller.prototype.json=function(e,r,t,n){var o=this;if(o.res.success||o.res.headersSent||!o.isConnected)return o;if("HEAD"===o.req.method)return o.subscribe.success(),framework.responseContent(o.req,o.res,o.status,"","application/json",o.config["allow-gzip"],r),framework.stats.response.json++,o;"boolean"==typeof r&&(n=t,t=r);var i="application/json";return e instanceof framework_builders.ErrorBuilder?(o.language&&!e.isResourceCustom&&e.resource(o.language),e.contentType&&(i=e.contentType),e=e.output()):e=t?JSON.stringify(e,n,4):JSON.stringify(e,n),o.subscribe.success(),framework.responseContent(o.req,o.res,o.status,e,i,o.config["allow-gzip"],r),framework.stats.response.json++,o.precache&&o.precache(e,"application/json",r),o},Controller.prototype.jsonp=function(e,r,t,n,o){var i=this;return i.res.success||i.res.headersSent||!i.isConnected?i:"HEAD"===i.req.method?(i.subscribe.success(),framework.responseContent(i.req,i.res,i.status,"","application/x-javascript",i.config["allow-gzip"],t),framework.stats.response.json++,i):("boolean"==typeof t&&(o=n,n=t),e||(e="callback"),r instanceof framework_builders.ErrorBuilder?(i.language&&!r.isResourceCustom&&r.resource(i.language),r=r.json(n)):r=n?JSON.stringify(r,o,4):JSON.stringify(r,o),i.subscribe.success(),framework.responseContent(i.req,i.res,i.status,e+"("+r+")","application/x-javascript",i.config["allow-gzip"],t),framework.stats.response.json++,i.precache&&i.precache(e+"("+r+")","application/x-javascript",t),i)},Controller.prototype.callback=function(e){var r=this;return function(t,n){var o=t instanceof framework_builders.ErrorBuilder;return void 0!==n||framework_utils.isError(t)||o||(n=t,t=null),t?o&&!e?(r.language&&t.resource(r.language),r.content(t)):o&&t.unexpected?r.view500(t):r.view404(t):"string"==typeof e?r.view(e,n):void r.json(n)}},Controller.prototype.custom=function(){var e=this;return e.subscribe.success(),e.res.success||e.res.headersSent||!e.isConnected?!1:(framework.responseCustom(e.req,e.res),!0)},Controller.prototype.noClear=function(e){var r=this;return r.req._manual=void 0===e?!0:e,r},Controller.prototype.content=function(e,r,t){var n=this;if(n.res.success||n.res.headersSent||!n.isConnected)return n;if(e instanceof ErrorBuilder){var o=e.output();r||(r=e.contentType||"application/json"),e=o}return n.subscribe.success(),framework.responseContent(n.req,n.res,n.status,e,r||CONTENTTYPE_TEXTPLAIN,n.config["allow-gzip"],t),n.precache&&200===n.status&&(n.layout(""),n.precache(e,r||CONTENTTYPE_TEXTPLAIN,t,!0)),n},Controller.prototype.plain=function(e,r){var t=this;if(t.res.success||t.res.headersSent||!t.isConnected)return t;if("HEAD"===t.req.method)return t.subscribe.success(),framework.responseContent(t.req,t.res,t.status,"",CONTENTTYPE_TEXTPLAIN,t.config["allow-gzip"],r),framework.stats.response.plain++,t;var n="undefined"==typeof e?"undefined":_typeof(e);return e=void 0===e?"":"object"===n?e?JSON.stringify(e,null,4):"":e?e.toString():"",t.subscribe.success(),framework.responseContent(t.req,t.res,t.status,e,CONTENTTYPE_TEXTPLAIN,t.config["allow-gzip"],r),framework.stats.response.plain++,t.precache&&t.precache(e,CONTENTTYPE_TEXTPLAIN,r),t},Controller.prototype.empty=function(e){var r=this;if(r.res.success||r.res.headersSent||!r.isConnected)return r;var t=200;return"number"==typeof e&&(t=e,e=null),r.subscribe.success(),framework.responseContent(r.req,r.res,t,"",CONTENTTYPE_TEXTPLAIN,!1,e),framework.stats.response.empty++,r},Controller.prototype.destroy=function(e){var r=this;return e&&r.problem(e),r.res.success||r.res.headersSent||!r.isConnected?r:(r.subscribe.success(),r.req.connection.destroy(),framework.stats.response.destroy++,r)},Controller.prototype.file=function(e,r,t,n){var o=this;return o.res.success||o.res.headersSent||!o.isConnected?(n&&n(),o):(e="~"===e[0]?e.substring(1):framework.path.public_cache(e),o.subscribe.success(),framework.responseFile(o.req,o.res,e,r,t,n),o)},Controller.prototype.image=function(e,r,t,n){var o=this;return o.res.success||o.res.headersSent||!o.isConnected?(n&&n(),o):("string"==typeof e&&(e="~"===e[0]?e.substring(1):framework.path.public_cache(e)),o.subscribe.success(),framework.responseImage(o.req,o.res,e,r,t,n),o)},Controller.prototype.stream=function(e,r,t,n,o,i){var s=this;return s.res.success||s.res.headersSent||!s.isConnected?(o&&o(),s):(s.subscribe.success(),framework.responseStream(s.req,s.res,e,r,t,n,o,i),s)},Controller.prototype.throw400=Controller.prototype.view400=function(e){return controller_error_status(this,400,e)},Controller.prototype.throw401=Controller.prototype.view401=function(e){return controller_error_status(this,401,e)},Controller.prototype.throw403=Controller.prototype.view403=function(e){return controller_error_status(this,403,e)},Controller.prototype.throw404=Controller.prototype.view404=function(e){return controller_error_status(this,404,e)},Controller.prototype.throw500=Controller.prototype.view500=function(e){var r=this;return framework.error(e instanceof Error?e:new Error((e||"").toString()),r.name,r.req.uri),controller_error_status(r,500,e)},Controller.prototype.throw501=Controller.prototype.view501=function(e){return controller_error_status(this,501,e)},Controller.prototype.redirect=function(e,r){var t=this;return t.precache&&t.precache(null,null,null),t.res.success||t.res.headersSent||!t.isConnected?t:(HEADERS.redirect.Location=e,t.subscribe.success(),t.res.success=!0,t.res.writeHead(r?301:302,HEADERS.redirect),t.res.end(),framework._request_stats(!1,!1),framework.emit("request-end",t.req,t.res),t.req.clear(!0),framework.stats.response.redirect++,t)},Controller.prototype.binary=function(e,r,t,n,o){var i=this,s=i.res;if(i.res.success||i.res.headersSent||!i.isConnected)return i;if("object"===("undefined"==typeof t?"undefined":_typeof(t))){var a=t;t=n,n=o,o=a}return"object"===("undefined"==typeof n?"undefined":_typeof(n))&&(o=n,n=o),i.subscribe.success(),framework.responseBinary(i.req,s,r,e,t,n,o),i},Controller.prototype.baa=function(e){var r=this;if(r.precache&&r.precache(null,null,null),void 0===e)return r.req.authorization();var t={};return t["WWW-Authenticate"]='Basic realm="'+(e||"Administration")+'"',framework.responseContent(r.req,r.res,401,"401: NOT AUTHORIZED",CONTENTTYPE_TEXTPLAIN,!1,t),r.subscribe.success(),r.cancel(),null},Controller.prototype.sse=function(e,r,t,n){var o=this,i=o.res;if(!o.isConnected)return o;if(!o.type&&i.success)throw new Error("Response was sent.");if(o.type>0&&1!==o.type)throw new Error("Response was used.");o.type||(o.type=1,void 0===n&&(n=o.subscribe.route.timeout),o.subscribe.success(),o.req.on("close",function(){return o.close()}),i.success=!0,i.writeHead(o.status,HEADERS.sse)),e="object"===("undefined"==typeof e?"undefined":_typeof(e))?JSON.stringify(e):e.replace(/\n/g,"\\n").replace(/\r/g,"\\r");var s="\n",a="";return r&&(a="event: "+r+s),a+="data: "+e+s,t&&(a+="id: "+t+s),n>0&&(a+="retry: "+n+s),a+=s,i.write(a),framework.stats.response.sse++,o},Controller.prototype.close=function(e){var r=this;return void 0===e&&(e=!0),r.isConnected?r.type?(r.isConnected=!1,r.res.success=!0,framework._request_stats(!1,!1),framework.emit("request-end",r.req,r.res),r.type=0,e&&r.res.end(),r):(r.isConnected=!1,r.res.success?r:(r.res.success=!0,framework._request_stats(!1,!1),framework.emit("request-end",r.req,r.res),e&&r.res.end(),r)):r},Controller.prototype.proxy=function(e,r,t,n){var o,i=this;return"number"==typeof t&&(o=n,n=t,t=o),"function"==typeof r&&(o=t,t=r,r=o),framework_utils.request(e,REQUEST_PROXY_FLAGS,r,function(e,r,n,o){t&&(-1!==(o["content-type"]||"").lastIndexOf("/json")&&(r=framework.onParseJSON(r)),t.call(i,e,r,n,o))},null,HEADERS.proxy,ENCODING,n||1e4)},Controller.prototype.view=function(e,r,t,n){var o=this;if("string"!=typeof e?(n=t,t=r,r=e,e=o.viewname):void 0===n&&"boolean"==typeof t&&(n=t,t=null),!n&&o.res&&o.res.success)return o;void 0===o.layoutName&&(o.layoutName=framework.config["default-layout"]),void 0===o.themeName&&(o.themeName=framework.config["default-theme"]);var i="view#="+this.themeName+"/"+o._currentView+"/"+e,s=framework.temporary.other[i],a=o.isLayout;if(o.isLayout=!1,!s){var u=e[0],c="/"===u?1:"~"===u&&"~"===e[1]?4:"~"===u?2:"@"===u?3:"."===u?5:0,l=!1;s=e,o.themeName&&3>c&&(s="."+framework.path.themes(o.themeName+"/views/"+(a||c?"":o._currentView.substring(1))+(c?e.substring(1):e)).replace(REG_SANITIZE_BACKSLASH,"/"),l=!0),4===c&&(s=s.substring(1),e=e.substring(1),c=2),l||a||c||(s=o._currentView+e),l||2!==c&&3!==c||(s=e.substring(1)),3===c&&(s="."+framework.path["package"](s)),framework.temporary.other[i]=s}var f=framework_internal.viewEngine(e,s,o);if(!f){var p=new Error('View "'+s+'" not found.');return n?(framework.error(p,o.name,o.uri),o.outputPartial):a?(o.subscribe.success(),void framework.response500(o.req,o.res,p)):void o.view500(p)}var d="";o.$model=r,a&&(o._currentView=o._defaultView||"");var m=framework.helpers;try{d=f.call(o,o,o.repository,r,o.session,o.query,o.body,o.url,framework.global,m,o.user,o.config,framework.functions,0,n?o.outputPartial:o.output,o.date,o.req.cookie,o.req.files,o.req.mobile)}catch(h){var p=new Error("View: "+e+" - "+h.toString());return n?(o.error(p),o.isPartial?o.outputPartial="":o.output="",a=!1,d):void o.view500(p)}if(a||!o.precache||200!==o.status||n||o.precache(d,CONTENTTYPE_TEXTHTML,t,!0),a||!o.layoutName){if(o.outputPartial="",o.output="",a=!1,n)return d;if(o.subscribe.success(),!o.isConnected)return;return framework.responseContent(o.req,o.res,o.status,d,CONTENTTYPE_TEXTHTML,o.config["allow-gzip"],t),framework.stats.response.view++,o}return n?o.outputPartial=d:o.output=d,o.isLayout=!0,d=o.view(o.layoutName,o.$model,t,n),n?(o.outputPartial="",o.isLayout=!1,d):o},Controller.prototype.memorize=function(e,r,t,n,o){var i=this;if(t===!0)return n(),i;var s=i.cache.read(e);if(!s)return i.$memorize_prepare(e,r,t,n,o);if("function"==typeof t){var a=n;n=t,o=a}if(o&&o(),i.layoutName=s.layout,i.themeName=s.theme,s.type!==CONTENTTYPE_TEXTHTML)return i.subscribe.success(),void framework.responseContent(i.req,i.res,i.status,s.content,s.type,i.config["allow-gzip"],s.headers);switch(s.type){case CONTENTTYPE_TEXTPLAIN:return framework.stats.response.plain++,i;case"application/json":return framework.stats.response.json++,i;case CONTENTTYPE_TEXTHTML:framework.stats.response.view++}for(var u=s.repository.length,c=0;u>c;c++){var e=s.repository[c].key;void 0===i.repository[e]&&(i.repository[e]=s.repository[c].value)}return i.layoutName?(i.output=s.content,i.isLayout=!0,i.view(i.layoutName,null),i):(i.subscribe.success(),i.isConnected?(framework.responseContent(i.req,i.res,i.status,s.content,s.type,i.config["allow-gzip"],s.headers),i):i)},Controller.prototype.$memorize_prepare=function(e,r,t,n,o){var i=this,s="$memorize"+e;return framework.temporary.processing[s]?(setTimeout(function(){i.subscribe.isCanceled||i.memorize(e,r,t,n,o)},500),i):(i.precache=function(t,n,o,a){if(!t&&!n&&!o)return delete framework.temporary.processing[s],void(i.precache=null);var u={content:t,type:n,layout:i.layoutName,theme:i.themeName};if(o&&(u.headers=o),a){u.repository=[];for(var c in i.repository){var t=i.repository[c];void 0!==t&&u.repository.push({key:c,value:t})}}i.cache.add(e,u,r),i.precache=null,delete framework.temporary.processing[s]},"function"==typeof t&&(n=t),framework.temporary.processing[s]=!0,n(),i)};var NEWLINE="\r\n",SOCKET_RESPONSE="HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: {0}\r\n\r\n",SOCKET_RESPONSE_PROTOCOL="HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nSec-WebSocket-Accept: {0}\r\nSec-WebSocket-Protocol: {1}\r\n\r\n",SOCKET_RESPONSE_ERROR="HTTP/1.1 403 Forbidden\r\nConnection: close\r\nX-WebSocket-Reject-Reason: 403 Forbidden\r\n\r\n",SOCKET_HASH="258EAFA5-E914-47DA-95CA-C5AB0DC85B11",SOCKET_ALLOW_VERSION=[13];WebSocket.prototype={get global(){return framework.global},get config(){return framework.config},get cache(){return framework.cache},get isDebug(){return framework.config.debug},get path(){return framework.path},get fs(){return framework.fs},get isSecure(){return this.req.isSecure},get secured(){return this.req.secured}},WebSocket.prototype.__proto__=Object.create(events.EventEmitter.prototype,{constructor:{value:WebSocket,enumberable:!1}}),WebSocket.prototype.date=function(e,r,t){void 0===t&&(t=r,r=new Date);var n="string"==typeof r?r.parseDate():r,o="string"==typeof t?t.parseDate():t,i=n.compare(o);switch(e){case">":return 1===i;case">=":case"=>":return 1===i||0===i;case"<":return-1===i;case"<=":case"=<":return-1===i||0===i;case"=":return 0===i}return!0},WebSocket.prototype.send=function(e,r,t){var n=this,o=n._keys;if(!o||!o.length)return n;for(var i,s=r instanceof Array,a=t instanceof Array,u=!1,c=0,l=o.length;l>c;c++){var f=o[c],p=n.connections[f];if(r)if(s){if(!websocket_valid_array(f,r))continue}else if(!websocket_valid_fn(f,p,r))continue;if(t)if(a){if(websocket_valid_array(f,t))continue}else if(websocket_valid_fn(f,p,t))continue;void 0===i&&(3===p.type?(u=!0,i=JSON.stringify(e)):i=e),p.send(i,u),framework.stats.response.websocket++}return n},WebSocket.prototype.ping=function(){var e=this,r=e._keys;if(!r)return e;var t=r.length;if(0===t)return e;e.$ping=!0,framework.stats.other.websocketPing++;for(var n=0;t>n;n++)e.connections[r[n]].ping();return e},WebSocket.prototype.close=function(e,r,t){var n=this,o=n._keys;if(!o)return n;"string"==typeof e&&(t=r,r=e,e=null);var i=o.length;if(!i)return n;if(!e||!e.length){for(var s=0;i>s;s++){var a=o[s];n.connections[a].close(r,t),n._remove(a)}return n._refresh(),n}for(var u=e instanceof Array,c="function"==typeof e?e:null,s=0;i>s;s++){var a=o[s];if(!u||-1!==e.indexOf(a)){var l=n.connections[a];c&&!c.call(n,a,l)||(l.close(r,t),n._remove(a))}}return n._refresh(),n},WebSocket.prototype.error=function(e){var r=this,t=framework.error("string"==typeof e?new Error(e):e,r.name,r.path);return void 0===e?t:r},WebSocket.prototype.problem=function(e){var r=this;return framework.problem(e,r.name,r.uri),r},WebSocket.prototype.change=function(e){var r=this;return framework.change(e,r.name,r.uri,r.ip),r},WebSocket.prototype.all=function(e){var r=this;if(!r._keys)return r;for(var t=0,n=r._keys.length;n>t;t++){var o=r._keys[t];e(r.connections[o],t)}return r},WebSocket.prototype.find=function(e){var r=this;if(!r._keys)return r;for(var t=r._keys.length,n="function"==typeof e,o=0;t>o;o++){var i=r.connections[r._keys[o]];if(n){if(e(i,i.id))return i}else if(i.id===e)return i}return null},WebSocket.prototype.destroy=function(e){var r=this;return e&&r.problem(e),r.connections||r._keys?(r.close(),r.connections=null,r._keys=null,r.route=null,r.buffer=null,delete framework.connections[r.id],r.emit("destroy"),r.removeAllListeners(),r):r},WebSocket.prototype.proxy=function(e,r,t,n){var o=this;return"number"==typeof t&&(tmp=n,n=t,t=tmp),"function"==typeof r&&(tmp=t,t=r,r=tmp),framework_utils.request(e,REQUEST_PROXY_FLAGS,r,function(e,r,n,i){t&&(-1!==(i["content-type"]||"").lastIndexOf("/json")&&(r=framework.onParseJSON(r)),t.call(o,e,r,n,i))},null,HEADERS.proxy,ENCODING,n||1e4)},WebSocket.prototype._refresh=function(){var e=this;return e.connections?(e._keys=Object.keys(e.connections),e.online=e._keys.length,e):(e.online=0,e)},WebSocket.prototype._remove=function(e){var r=this;return delete r.connections[e],r},WebSocket.prototype._add=function(e){var r=this;return r.connections[e._id]=e,r},WebSocket.prototype.module=function(e){return framework.module(e)},WebSocket.prototype.model=function(e){return framework.model(e)},WebSocket.prototype.helper=function(e){var r=this,t=framework.helpers[e];if(!t)return"";for(var n=arguments.length,o=[],i=1;n>i;i++)o.push(arguments[i]);return t.apply(r,o)},WebSocket.prototype.resource=function(e,r){return framework.resource(e,r)},WebSocket.prototype.log=function(){var e=this;return framework.log.apply(framework,arguments),e},WebSocket.prototype.logger=function(){var e=this;return framework.logger.apply(framework,arguments),e},WebSocket.prototype.check=function(){var e=this;return e.$ping?(e.all(function(e){e.$ping||(e.close(),framework.stats.other.websocketCleaner++)}),e):e},WebSocketClient.prototype={get protocol(){return(this.req.headers["sec-websocket-protocol"]||"").replace(REG_EMPTY,"").split(",")},get ip(){return this.req.ip},get get(){return this.req.query},get query(){return this.req.query},get uri(){return this.req.uri},get config(){return this.container.config},get global(){return this.container.global},get session(){return this.req.session},set session(e){this.req.session=e},get user(){return this.req.user},set user(e){this.req.user=e}},WebSocketClient.prototype.__proto__=Object.create(events.EventEmitter.prototype,{constructor:{value:WebSocketClient,enumberable:!1}}),WebSocketClient.prototype.isWebSocket=!0,WebSocketClient.prototype.cookie=function(e){return this.req.cookie(e)},WebSocketClient.prototype.prepare=function(e,r,t,n,o){var i=this;e=e||[],r=r||[],t=t||[],i.length=n;var s=i.req.headers.origin||"",n=t.length;if(n&&-1===t.indexOf("*"))for(var a=0;n>a;a++)if(-1===s.indexOf(t[a]))return!1;if(n=r.length)for(var a=0;n>a;a++)if(-1===i.protocol.indexOf(r[a]))return!1;if(-1===SOCKET_ALLOW_VERSION.indexOf(framework_utils.parseInt(i.req.headers["sec-websocket-version"])))return!1;var u=r.length?SOCKET_RESPONSE_PROTOCOL.format(i._request_accept_key(i.req),r.join(", ")):SOCKET_RESPONSE.format(i._request_accept_key(i.req));return i.socket.write(new Buffer(u,"binary")),i._id=(i.ip||"").replace(/\./g,"")+framework_utils.GUID(20),i.id=i._id,!0},WebSocketClient.prototype.upgrade=function(e){var r=this;return r.container=e,r.socket.on("data",function(e){return r._ondata(e)}),r.socket.on("error",function(e){return r._onerror(e)}),r.socket.on("close",function(){return r._onclose();
}),r.socket.on("end",function(){return r._onclose()}),r.container._add(r),r.container._refresh(),framework.emit("websocket-begin",r.container,r),r.container.emit("open",r),r},WebSocketClient.prototype._ondata=function(e){var r=this;if(r){if(e&&(r.buffer=Buffer.concat([r.buffer,e])),r.buffer.length>r.length)return r.errors++,void r.container.emit("error",new Error("Maximum request length exceeded."),r);switch(15&r.buffer[0]){case 1:1!==r.type&&r.parse();break;case 2:1===r.type&&r.parse();break;case 8:r.close();break;case 9:r.socket.write(framework_utils.getWebSocketFrame(0,"",10)),r.buffer=new Buffer(0),r.$ping=!0;break;case 10:r.$ping=!0,r.buffer=new Buffer(0)}}},WebSocketClient.prototype.parse=function(){var e=this,r=e.buffer[1];if((128&r)>>7!==1)return e;var t=framework_utils.getMessageLength(e.buffer,framework.isLE),n=127&e.buffer[1];if(n=126==n?4:127==n?10:2,n+t+4>e.buffer.length)return e;var o=new Buffer(4);if(e.buffer.copy(o,0,n,n+4),1!==e.type){for(var i="",s=0;t>s;s++)i+=String.fromCharCode(e.buffer[n+4+s]^o[s%4]);if(3===e.type)try{i=e.container.config["default-websocket-encodedecode"]===!0?$decodeURIComponent(i):i,i.isJSON()&&e.container.emit("message",e,framework.onParseJSON(i))}catch(a){DEBUG&&(e.errors++,e.container.emit("error",new Error("JSON parser: "+a.toString()),e))}else e.container.emit("message",e,e.container.config["default-websocket-encodedecode"]===!0?$decodeURIComponent(i):i)}else{for(var u=new Buffer(t),s=0;t>s;s++)u[s]=e.buffer[n+4+s]^o[s%4];e.container.emit("message",e,new Uint8Array(u).buffer)}return e.buffer=e.buffer.slice(n+t+4,e.buffer.length),e.buffer.length>=2&&framework_utils.getMessageLength(e.buffer,framework.isLE)&&e.parse(),e},WebSocketClient.prototype._onerror=function(e){var r=this;if(r)return e.stack.match(REG_WEBSOCKET_ERROR)?(r.isClosed=!0,void r._onclose()):void r.container.emit("error",e,r)},WebSocketClient.prototype._onclose=function(){var e=this;e&&!e._isClosed&&(e._isClosed=!0,e.container._remove(e._id),e.container._refresh(),e.container.emit("close",e),e.socket.removeAllListeners(),framework.emit("websocket-end",e.container,e))},WebSocketClient.prototype.send=function(e,r){var t=this;if(!t||t.isClosed)return t;if(1!==t.type){var n=3===t.type?r?e:JSON.stringify(e):(e||"").toString();t.container.config["default-websocket-encodedecode"]===!0&&n&&(n=encodeURIComponent(n)),t.socket.write(framework_utils.getWebSocketFrame(0,n,1))}else e&&t.socket.write(framework_utils.getWebSocketFrame(0,new Int8Array(e),2));return t},WebSocketClient.prototype.ping=function(){var e=this;return!e||e.isClosed?e:(e.socket.write(framework_utils.getWebSocketFrame(0,"",9)),e.$ping=!1,e)},WebSocketClient.prototype.close=function(e,r){var t=this;return!t||t.isClosed?t:(e=e?encodeURIComponent(e):"",t.isClosed=!0,t.socket.end(framework_utils.getWebSocketFrame(r||1e3,e,8)),t)},WebSocketClient.prototype._request_accept_key=function(e){var r=crypto.createHash("sha1");return r.update((e.headers["sec-websocket-key"]||"")+SOCKET_HASH),r.digest("base64")},Backup.prototype.restoreKey=function(e){var r=this,t=r.read;if(1===t.status)return void r.restoreValue(e);var n=-1,o=e;return 2===t.status?(o=Buffer.concat([t.key,o]),n=o.indexOf(r.bufKey)):n=o.indexOf(r.bufKey),-1===n?(t.key=Buffer.concat([t.key,e]),void(t.status=2)):(t.status=1,t.key=o.slice(0,n),r.restoreValue(o.slice(n+1)),void(o=null))},Backup.prototype.restoreValue=function(e){var r=this,t=r.read;if(1!==t.status)return void r.restoreKey(e);var n=e.indexOf(r.bufNew);return-1===n?void(t.value=Buffer.concat([t.value,e])):(t.value=Buffer.concat([t.value,e.slice(0,n)]),r.restoreFile(t.key.toString("utf8").replace(REG_EMPTY,""),t.value.toString("utf8").replace(REG_EMPTY,"")),t.status=0,t.value=new Buffer(0),t.key=new Buffer(0),void r.restoreKey(e.slice(n+1)))},Backup.prototype.restore=function(e,r,t,n){if(!existsSync(e))return void(t&&t(new Error("Package not found."),r));var o=this;o.filter=n,o.cache={},o.createDirectory(r,!0),o.path=r;var i=fs.createReadStream(e);return i.on("data",function(e){return o.restoreKey(e)}),t?(t.path=r,i.on("end",function(){o.callback(t),i=null}),void i.resume()):void i.resume()},Backup.prototype.callback=function(e){var r=this;return r.pending<=0?e(null,e.path):void setTimeout(function(){return r.callback(e)},100)},Backup.prototype.restoreFile=function(e,r){var t=this;if("function"!=typeof t.filter||t.filter(e)){if("#"===r)return void t.createDirectory(e);var n=e,o=e.lastIndexOf("/");-1!==o&&(n=e.substring(0,o).trim(),n&&t.createDirectory(n));var i=new Buffer(r,"base64");t.pending++,zlib.gunzip(i,function(r,n){fs.writeFile(path.join(t.path,e),n,function(){return t.pending--}),i=null})}},Backup.prototype.createDirectory=function(e,r){var t=this;if(!t.cache[e]){t.cache[e]=!0,"/"===e[0]&&(e=e.substring(1));var n=framework.isWindows;n?"\\"===e[e.length-1]&&(e=e.substring(0,e.length-1)):"/"===e[e.length-1]&&(e=e.substring(0,e.length-1));var o=n?e.replace(/\//g,"\\").split("\\"):e.split("/"),i="";n&&-1!==o[0].indexOf(":")&&o.shift();for(var s=0,a=o.length;a>s;s++){var u=o[s];i+=n?(i?"\\":"")+u:(i?"/":"")+u;var c=path.join(t.path,i);r&&(c=(n?"\\":"/")+c),existsSync(c)||fs.mkdirSync(c)}}},http.ServerResponse.prototype.cookie=function(e,r,t,n){var o=this;if(!o.headersSent&&!o.success){var i=e+"=",s=[i+r],a="undefined"==typeof t?"undefined":_typeof(t);t&&!framework_utils.isDate(t)&&"object"===a&&(n=t,t=n.expires||n.expire||null),"string"===a&&(t=t.parseDateExpiration()),n||(n={}),n.path=n.path||"/",t&&s.push("Expires="+t.toUTCString()),n.domain&&s.push("Domain="+n.domain),n.path&&s.push("Path="+n.path),n.secure&&s.push("Secure"),(n.httpOnly||n.httponly||n.HttpOnly)&&s.push("HttpOnly");var u=o.getHeader("set-cookie")||[],c=u.findIndex(function(e){return e.startsWith(i)});return-1!==c&&u.splice(c,1),u.push(s.join("; ")),o.setHeader("Set-Cookie",u),o}},http.ServerResponse.prototype.noCache=function(){var e=this;return e.removeHeader(RESPONSE_HEADER_CACHECONTROL),e.removeHeader("Etag"),e.removeHeader("Last-Modified"),e},http.ServerResponse.prototype.send=function(e,r,t){var n=this;if(n.headersSent)return n;n.controller&&n.controller.subscribe.success();var o=n,i=n.req,s=t,a="HEAD"===i.method;switch(void 0===r&&(r=e,e=200),"undefined"==typeof r?"undefined":_typeof(r)){case"string":s||(s="text/html");break;case"number":s||(s="text/plain"),r=framework_utils.httpStatus(r);break;case"boolean":case"object":s||(s="application/json"),a||(r instanceof framework_builders.ErrorBuilder&&(r=obj.output()),r=JSON.stringify(r))}var u=i.headers["accept-encoding"]||"",c={};c[RESPONSE_HEADER_CACHECONTROL]="private",c.Vary="Accept-Encoding"+(i.$mobile?", User-Agent":""),"application/json"===s&&(c[RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate"),/text|application/.test(s)&&(s+="; charset=utf-8"),c[RESPONSE_HEADER_CONTENTTYPE]=s,framework.responseCustom(i,o),!u&&isGZIP(i)&&(u="gzip");var l=-1!==u.indexOf("gzip");if(a)return l&&(c["Content-Encoding"]="gzip"),o.writeHead(200,c),o.end(),n;if(!l)return o.writeHead(e,c),o.end(r,ENCODING),n;var f=new Buffer(r);return zlib.gzip(f,function(t,n){return t?(o.writeHead(e,c),void o.end(r,ENCODING)):(c["Content-Encoding"]="gzip",o.writeHead(e,c),void o.end(n,ENCODING))}),n},http.ServerResponse.prototype.throw400=function(e){this.controller&&this.controller.subscribe.success(),framework.response400(this.req,this,e)},http.ServerResponse.prototype.throw401=function(e){this.controller&&this.controller.subscribe.success(),framework.response401(this.req,this,e)},http.ServerResponse.prototype.throw403=function(e){this.controller&&this.controller.subscribe.success(),framework.response403(this.req,this,e)},http.ServerResponse.prototype.throw404=function(e){this.controller&&this.controller.subscribe.success(),framework.response404(this.req,this,e)},http.ServerResponse.prototype.throw408=function(e){this.controller&&this.controller.subscribe.success(),framework.response408(this.req,this,e)},http.ServerResponse.prototype.throw431=function(e){this.controller&&this.controller.subscribe.success(),framework.response431(this.req,this,e)},http.ServerResponse.prototype.throw500=function(e){this.controller&&this.controller.subscribe.success(),framework.response500(this.req,this,e)},http.ServerResponse.prototype.throw501=function(e){this.controller&&this.controller.subscribe.success(),framework.response501(this.req,this,e)},http.ServerResponse.prototype["continue"]=function(e){var r=this;return r.headersSent?(e&&e(),r):(r.controller&&r.controller.subscribe.success(),framework.responseStatic(r.req,r,e),r)},http.ServerResponse.prototype.content=function(e,r,t,n,o){var i=this;return i.headersSent?i:(i.controller&&i.controller.subscribe.success(),framework.responseContent(i.req,i,e,r,t,n,o),i)},http.ServerResponse.prototype.redirect=function(e,r){var t=this;return t.headersSent?t:(t.controller&&t.controller.subscribe.success(),framework.responseRedirect(t.req,t,e,r),t)},http.ServerResponse.prototype.file=function(e,r,t,n){var o=this;return o.headersSent?(n&&n(),o):(o.controller&&o.controller.subscribe.success(),framework.responseFile(o.req,o,e,r,t,n),o)},http.ServerResponse.prototype.stream=function(e,r,t,n,o,i){var s=this;return s.headersSent?(o&&o(),s):(s.controller&&s.controller.subscribe.success(),framework.responseStream(s.req,s,e,r,t,n,o,i),s)},http.ServerResponse.prototype.image=function(e,r,t,n){var o=this;return o.headersSent?(n&&n(),o):(o.controller&&o.controller.subscribe.success(),framework.responseImage(o.req,o,e,r,t,n),o)},http.ServerResponse.prototype.json=function(e){var r=this;return r.send(200,e,"application/json")};var _tmp=http.IncomingMessage.prototype;http.IncomingMessage.prototype={get ip(){var e=this;if(e._ip)return e._ip;var r=e.headers["x-forwarded-for"];return r?e._ip=r.split(",",1)[0]||e.connection.remoteAddress:e._ip||(e._ip=e.connection.remoteAddress),e._ip},get query(){var e=this;return e._dataGET?e._dataGET:(e._dataGET=framework.onParseQuery(e.uri.query),e._dataGET)},set query(e){this._dataGET=e},get subdomain(){var e=this;if(e._subdomain)return e._subdomain;var r=e.uri.host.toLowerCase().replace(/^www\./i,"").split(".");return r.length>2?e._subdomain=r.slice(0,r.length-2):e._subdomain=null,e._subdomain},get host(){return this.headers.host},get split(){return this.$path?this.$path:this.$path=framework_internal.routeSplit(this.uri.pathname,!0)},get secured(){return"https:"===this.uri.protocol||"wss:"===this.uri.protocol},get language(){return this.$language||(this.$language=(((this.headers["accept-language"]||"").split(";")[0]||"").split(",")[0]||"").toLowerCase()),this.$language},get mobile(){return void 0===this.$mobile&&(this.$mobile=REG_MOBILE.test(this.headers["user-agent"])),this.$mobile},get robot(){return void 0===this.$robot&&(this.$robot=REG_ROBOT.test(this.headers["user-agent"])),this.$robot},set language(e){this.$language=e}},http.IncomingMessage.prototype.__proto__=_tmp,http.IncomingMessage.prototype.signature=function(e){var r=this;return framework.encrypt((r.headers["user-agent"]||"")+"#"+r.ip+"#"+r.url+"#"+(e||""),"request-signature",!1)},http.IncomingMessage.prototype.noCache=function(){var e=this;return delete e.headers["if-none-match"],delete e.headers["if-modified-since"],e},http.IncomingMessage.prototype.behaviour=function(e){if(!framework.behaviours)return!1;var r=this.url;this.isStaticFile||"/"===r[r.length-1]||(r+="/");var t=framework.behaviours["*"],n=!1;return void 0!==t&&(t=t[e],void 0!==t&&(n=t)),t=framework.behaviours[r],void 0===t?n:(t=t[e],void 0===t?n:t)},http.IncomingMessage.prototype.cookie=function(e){var r=this;if(r.cookies)return $decodeURIComponent(r.cookies[e]||"");var t=r.headers.cookie;if(!t)return"";r.cookies={};for(var n=t.split(";"),o=0,i=n.length;i>o;o++){var s=n[o].trim(),a=s.indexOf("=");-1!==a&&(r.cookies[s.substring(0,a)]=s.substring(a+1))}return $decodeURIComponent(r.cookies[e]||"")},http.IncomingMessage.prototype.authorization=function(){var e=this,r=e.headers.authorization;if(!r)return HEADERS.authorization;var t=new Buffer(r.replace("Basic ","").trim(),"base64").toString(ENCODING).split(":"),n={user:"",password:"",empty:!0};return n.user=t[0]||"",n.password=t[1]||"",n.empty=!n.user||!n.password,n},http.IncomingMessage.prototype.authorize=function(e){var r=framework.onAuthorize;if(!r)return e(null,null,!1),this;var t=this;return r(t,t.res,t.flags,function(r,n){"boolean"!=typeof r&&(n=r,r=!n),t.isAuthorized=r,e(null,n,r)}),this},http.IncomingMessage.prototype.clear=function(e){var r=this,t=r.files;if(!t)return r;if(e&&r._manual)return r;r.body=null,r.query=null,r.cookies=null;var n=t.length;if(!n)return r;for(var o=[],i=0;n>i;i++)o.push(t[i].path);return framework.unlink(o),r.files=null,r},http.IncomingMessage.prototype.hostname=function(e){var r=this,t=r.uri;return e&&"/"!==e[0]&&(e="/"+e),t.protocol+"//"+t.hostname+(t.port&&80!==t.port?":"+t.port:"")+(e||"")};var framework=new Framework;global.framework=global.F=module.exports=framework,process.on("uncaughtException",function(e){return-1!==e.toString().indexOf("listen EADDRINUSE")?("function"==typeof process.send&&process.send("eaddrinuse"),console.log("\nThe IP address and the PORT is already in use.\nYou must change the PORT's number or IP address.\n"),void process.exit("SIGTERM")):framework.isTest?void(framework.testContinue&&framework.testContinue(e)):void framework.error(e,"",null)}),process.on("SIGTERM",function(){framework.stop()}),process.on("SIGINT",function(){framework.stop()}),process.on("exit",function(){framework.stop()}),process.on("message",function(e,r){return"string"!=typeof e?void framework.emit("message",e,r):"debugging"===e?void framework_utils.wait(function(){return framework.isLoaded},function(){delete framework.isLoaded,framework.console()},1e4,500):"reconnect"===e?void framework.reconnect():"reconfigure"===e?(framework._configure(),framework._configure_versions(),framework._configure_sitemap(),void framework.emit(e)):"reset"===e?void framework.cache.clear():"stop"===e||"exit"===e?void framework.stop():void framework.emit("message",e,r)});