// Copyright 2012-2015 (c) Peter Å irka <petersirka@gmail.com>
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function Framework(){this.id=null,this.version=1940,this.version_header="1.9.4";var e=process.version.toString().replace("v","").replace(/\./g,"");"0"!==e[0]||"0"!==e[1]?e=parseFloat(e):"0"===e[1]&&(e=parseFloat("0."+e.substring(1))),this.versionNode=e,this.config={debug:!1,name:"total.js",version:"1.01",author:"",secret:os.hostname()+"-"+os.platform()+"-"+os.arch(),"etag-version":"","directory-controllers":"/controllers/","directory-views":"/views/","directory-definitions":"/definitions/","directory-temp":"/tmp/","directory-models":"/models/","directory-resources":"/resources/","directory-public":"/public/","directory-public-virtual":"/app/","directory-modules":"/modules/","directory-source":"/source/","directory-logs":"/logs/","directory-tests":"/tests/","directory-databases":"/databases/","directory-workers":"/workers/","directory-packages":"/packages/","directory-private":"/private/","directory-isomorphic":"/isomorphic/","directory-configs":"/configs/","directory-services":"/services/","directory-themes":"/themes/","static-url":"","static-url-script":"/js/","static-url-style":"/css/","static-url-image":"/img/","static-url-video":"/video/","static-url-font":"/fonts/","static-url-download":"/download/","static-accepts":{".jpg":!0,".png":!0,".gif":!0,".ico":!0,".js":!0,".css":!0,".txt":!0,".xml":!0,".woff":!0,".woff2":!0,".otf":!0,".ttf":!0,".eot":!0,".svg":!0,".zip":!0,".rar":!0,".pdf":!0,".docx":!0,".xlsx":!0,".doc":!0,".xls":!0,".html":!0,".htm":!0,".appcache":!0,".manifest":!0,".map":!0,".ogg":!0,".mp4":!0,".mp3":!0,".webp":!0,".webm":!0,".swf":!0,".package":!0,".json":!0,".md":!0,".m4v":!0},"default-layout":"layout","default-theme":"","default-request-length":5,"default-websocket-request-length":2,"default-websocket-encodedecode":!0,"default-maximum-file-descriptors":0,"default-timezone":"","default-request-timeout":5e3,"default-image-converter":"gm","default-image-quality":93,"allow-handle-static-files":!0,"allow-gzip":!0,"allow-websocket":!0,"allow-compile-script":!0,"allow-compile-style":!0,"allow-compile-html":!0,"allow-performance":!1,"allow-custom-titles":!1,"allow-compatibility":!1,"disable-strict-server-certificate-validation":!0,"disable-clear-temporary-directory":!1,"default-interval-clear-resources":20,"default-interval-clear-cache":7,"default-interval-precompile-views":61,"default-interval-websocket-ping":3,"default-interval-clear-dnscache":2880},this.global={},this.resources={},this.connections={},this.functions={},this.themes={},this.versions=null,this.schedules=[],this.isDebug=!0,this.isTest=!1,this.isLoaded=!1,this.isWorker=!0,this.isCluster=require("cluster").isWorker,this.routes={sitemap:null,web:[],files:[],websockets:[],middleware:{},redirects:{},resize:{},request:[],views:{},merge:{},mapping:{},packages:{},blocks:{}},this.behaviours=null,this.modificators=null,this.helpers={},this.modules={},this.models={},this.sources={},this.controllers={},this.dependencies={},this.isomorphic={},this.tests=[],this.errors=[],this.problems=[],this.changes=[],this.server=null,this.port=0,this.ip="",this.workers={},this.databases={},this.directory=directory,this.isLE=os.endianness?"LE"===os.endianness():!0,this.isHTTPS=!1,this.temporary={path:{},processing:{},range:{},views:{},dependencies:{},other:{},internal:{}},this.stats={other:{websocketPing:0,websocketCleaner:0,obsolete:0},request:{request:0,pending:0,web:0,xhr:0,file:0,websocket:0,get:0,options:0,head:0,post:0,put:0,upload:0,blocked:0,"delete":0,mobile:0,desktop:0},response:{view:0,json:0,websocket:0,timeout:0,custom:0,binary:0,pipe:0,file:0,destroy:0,stream:0,streaming:0,plain:0,empty:0,redirect:0,forward:0,restriction:0,notModified:0,sse:0,error400:0,error401:0,error403:0,error404:0,error408:0,error431:0,error500:0,error501:0}},this.cache=new FrameworkCache,this.fs=new FrameworkFileSystem,this.path=new FrameworkPath,this.restrictions=new FrameworkRestrictions,this._request_check_redirect=!1,this._request_check_referer=!1,this._request_check_POST=!1,this._request_check_mobile=!1,this._length_middleware=0,this._length_request_middleware=0,this._length_files=0,this._length_wait=0,this._length_themes=0,this.isVirtualDirectory=!1,this.isTheme=!1,this.isWindows="win"===os.platform().substring(0,3).toLowerCase()}function merge_debug_writer(e,r,t,n,o){var i="===========================================================================================",s="js"===t?"/*\n":"css"===t?"/*!\n":"<!--\n",a="js"===t||"css"===t?"\n */":"\n-->",u="html"!==t?" * ":" ";e.write((n>0?"\n\n":"")+s+u+i+"\n"+u+"MERGED: "+r+"\n"+(o?u+"BLOCKS: "+o+"\n":"")+u+i+a+"\n\n",ENCODING)}function FrameworkRestrictions(){this.isRestrictions=!1,this.isAllowedIP=!1,this.isBlockedIP=!1,this.isAllowedCustom=!1,this.isBlockedCustom=!1,this.allowedIP=[],this.blockedIP=[],this.allowedCustom={},this.blockedCustom={},this.allowedCustomKeys=[],this.blockedCustomKeys=[]}function FrameworkFileSystem(){this.create={style:this.createStyle.bind(this),css:this.createStyle.bind(this),database:this.createDatabase.bind(this),file:this.createFile.bind(this),script:this.createScript.bind(this),js:this.createScript.bind(this),resource:this.createResource.bind(this),temporary:this.createTemporary.bind(this),temp:this.createTemporary.bind(this),view:this.createView.bind(this),worker:this.createWorker.bind(this)},this.rm={css:this.deleteStyle.bind(this),style:this.deleteStyle.bind(this),database:this.deleteDatabase.bind(this),file:this.deleteFile.bind(this),js:this.deleteScript.bind(this),script:this.deleteScript.bind(this),resource:this.deleteResource.bind(this),temporary:this.deleteTemporary.bind(this),temp:this.deleteTemporary.bind(this),view:this.deleteView.bind(this),worker:this.deleteWorker.bind(this)}}function FrameworkPath(){}function FrameworkCache(){this.items={},this.count=1,this.interval=null}function Subscribe(e,r,t,n){this.controller=null,this.req=r,this.res=t,this.route=null,this.timeout=null,this.isCanceled=!1,this.isTransfer=!1,this.header="",this.error=null}function Controller(e,r,t,n,o){this.subscribe=n,this.name=e,this.req=r,this.res=t,this.exception=null,r&&(this.language=r.$language),this.type=0,this.layoutName=framework.config["default-layout"],this.themeName=framework.config["default-theme"],this.status=200,this.isLayout=!1,this.isCanceled=!1,this.isConnected=!0,this.isTimeout=!1,this.isController=!0,this.isTransfer=!1,this.repository={},this.output=null,this.outputPartial=null,this.$model=null,this._currentImage="",this._currentDownload="",this._currentVideo="",this._currentScript="",this._currentStyle="",this._currentView=o,r||(this.req={uri:{}}),t||(this.res={}),this.res.controller=this}function WebSocket(e,r,t,n){this._keys=[],this.id=n,this.online=0,this.connections={},this.repository={},this.name=t,this.isController=!0,this.url=framework_utils.path(r),this.route=null}function WebSocketClient(e,r,t){this.handlers={ondata:this._ondata.bind(this),onerror:this._onerror.bind(this),onclose:this._onclose.bind(this)},this.$ping=!0,this.container=null,this._id=null,this.id="",this.socket=r,this.req=e,this.isClosed=!1,this.isWebSocket=!0,this.errors=0,this.buffer=new Buffer(0),this.length=0,this.cookie=e.cookie.bind(e),this.type=2,this._isClosed=!1}function Backup(){this.file=[],this.directory=[],this.path="",this.fileName="",this.read={key:"",value:"",status:0},this.pending=0,this.cache={},this.complete=function(){},this.filter=function(e){return!0}}function $decodeURIComponent(e){try{return decodeURIComponent(e)}catch(r){return e}}function fsFileRead(e,r){U.queue("framework.files",F.config["default-maximum-file-descriptors"],function(t){fs.readFile(e,function(e,n){t(),r(e,n)})})}function fsFileExists(e,r){U.queue("framework.files",F.config["default-maximum-file-descriptors"],function(t){fs.exists(e,function(e){t(),r(e)})})}function fsStreamRead(e,r,t,n){t||(t=r,r=void 0);var o={flags:"r",mode:"0666",autoClose:!0};r&&framework_utils.extend(o,r,!0),U.queue("framework.files",F.config["default-maximum-file-descriptors"],function(r){var n=fs.createReadStream(e,o);n.on("error",noop),t(n,r)})}function createTemporaryKey(e){return(e.uri?e.uri.pathname:e).replace(TEMPORARY_KEY_REGEX,"-").substring(1)}function prepare_error(e){return framework.isDebug&&e?e.stack?" :: "+e.stack.toString():" :: "+e.toString():""}function prepare_filename(e){return"@"===e[0]?framework.isWindows?framework_utils.combine(framework.config["directory-temp"],e.substring(1)):framework.path["package"](e.substring(1)):framework_utils.combine("/",e)}function prepare_isomorphic(e){e=e.replace(/\.js$/i,"");var r=framework.isomorphic[e];return r=r?r.$$output:"",'if(window["isomorphic"]===undefined)window.isomorphic={};isomorphic["'+e+'"]=(function(framework,F,U,utils,Utils,is_client,is_server){var module={},exports=module.exports={};'+r+";return exports;})(null,null,null,null,null,true,false)"}function isGZIP(e){var r=e.headers["user-agent"];return r?-1!==r.lastIndexOf("Firefox"):!1}!function(e){function r(e){this.name=e,this.collection={}}function t(e,r,t,n,o){this.parent=e,this.name=r,this.primary,this.trim=!0,this.schema=t,this.properties=void 0===o?Object.keys(t):o,this.resourcePrefix,this.resourceName,this.transforms,this.composes,this.operations,this.rules,this.constants,this.onPrepare,this.onDefault,this.onValidate=n?n:framework.onValidate,this.onSave,this.onGet,this.onRemove,this.onQuery,this.onError,this.gcache={};var i=this;setTimeout(function(){i.onValidation&&OBSOLETE(i.name,'Instead of "SchemaBuilderEntity.onValidation()" use "SchemaBuilderEntity.setValidate()"')},2e3)}function n(e,r,t){return e.gcache[r]?e.gcache[r]:e.gcache[r]="function*"===t.toString().substring(0,9)}function o(e,r){return e.trim?r.trim():r}function i(e){this.items=[],this.transformName=b.error_default,this.onResource=e,this.resourceName=framework.config["default-errorbuilder-resource-name"]||"default",this.resourcePrefix=framework.config["default-errorbuilder-resource-prefix"]||"",this.isResourceCustom=!1,this.count=0,this.replacer=[],this.isPrepared=!1,this.contentType="application/json",void 0===e&&this._resource()}function s(){this.builder={}}function a(e,r){return void 0===e?r:e}function u(e,r,t,n){this.isNext=!1,this.isPrev=!1,this.isFirst=!1,this.isLast=!1,this.nextPage=0,this.prevPage=0,this.lastPage=0,this.firstPage=0,this.items=Math.max(0,+e),this.count=0,this.skip=0,this.take=0,this.page=0,this.max=0,this.visible=!1,this.format=n||"?page={0}",this.refresh(e,r,t),this.transformName=b.pagination_default}function c(){}var l=e.exports;global.framework_builders=e.exports;var f="undefined",p="function",d="object",m="string",h="number",g="boolean",v='The field "@" is required.',y="default",w={},b={pagination:{},error:{},objectbuilder:{},transformbuilder:{}};return r.prototype.get=function(e){return this.collection[e]},r.prototype.add=function(e,r,n,o){var i=this;typeof r===f&&(r={});var s=Object.keys(r);n||(n=s),i.collection[e]=new t(i,e,{},o,n);for(var a=0,u=s.length;u>a;a++){var c=s[a];i.collection[e].define(c,r[c])}return i.collection[e]},r.prototype.create=function(){var e=this;return e.add.apply(e,arguments)},r.prototype.Create=function(){var e=this;return e.add.apply(e,arguments)},r.prototype.remove=function(e){var r=this;if(void 0===e)return delete w[e],void(r.collection=null);var t=r.collection[e];return t&&t.remove(),t=null,r},r.prototype.destroy=function(e){return this.remove(e)},t.prototype.define=function(e,r,n,o){var i=this;if(e instanceof Array){for(var s=0,a=e.length;a>s;s++)i.define(e[s],r,n,o);return i}return void 0!==n&&typeof n!==g&&(o=n,n=!1),r instanceof t&&(r=r.name),i.schema[e]=i.$parse(e,r,n,o),n?((void 0===i.properties||null===i.properties)&&(i.properties=[]),-1!==i.properties.indexOf(e)?i:(i.properties.push(e),i)):i},t.prototype.setPrimary=function(e){return this.primary=e,this},t.prototype.filter=function(e,r,t){var n=this;if(typeof r===g){var o=t;t=r,r=o}var i=void 0===r?[]:{},s=typeof e,a=s===m?"*"===e[0]||"%"===e[0]:!1,u=!1;a?e=e.substring(1):s===d&&(u=framework_utils.isRegExp(e));for(var c in n.schema){var l=n.schema[c];if(l){var f=typeof l.custom;if(a){if(f!==m)continue;if(-1===l.custom.indexOf(e)){if(!t)continue}else if(t)continue}else if(u){if(f!==m)continue;if(e.test(l.current)){if(t)continue}else if(!t)continue}else if(l.custom!==e){if(!t)continue}else if(t)continue;void 0===r?i.push(c):i[c]=r[c]}}return i},t.prototype.$parse=function(e,r,t,n){var o=typeof r,i={};if(i.raw=r,i.type=0,i.length=0,i.required=t?!0:!1,i.isArray=!1,i.custom=n||"",null===r)return i;if("[]"===r)return i.isArray=!0,i;if(o===p)return r===Number?(i.type=2,i):r===String?(i.type=3,i):r===Boolean?(i.type=4,i):r===Date?(i.type=5,i):r===Array?(i.isArray=!0,i):r===Object?(i.type=6,i):i;if(o===d)return i;"["===r[0]&&(r=r.substring(1,r.length-1),i.isArray=!0,i.raw=r);var s=r.toLowerCase();if("object"===s)return i.type=6,i;if("array"===s)return i.isArray=!0,i;if(s.contains([m,"text","varchar","nvarchar"])){i.type=3;var a=s.indexOf("(");if(-1===a)return i;var u=s.substring(a+1,s.length-1).parseInt();return i.length=u,i.raw=s.substring(0,a),i}return s.contains(["int","byte"])?(i.type=1,i):s.contains(["decimal",h,"float","double"])?(i.type=2,i):s.contains("bool",g)?(i.type=4,i):s.contains(["date","time"])?(i.type=5,i):(i.type=7,i)},t.prototype.getDependencies=function(){var e=this,r=[];for(var t in e.schema){var n=e.schema[t];if(typeof n===m){var o="]"===n[0];o&&(n=n.substring(1,n.length-1));var i=e.parent.get(n);void 0!==typeof i&&r.push({name:t,isArray:o,schema:i})}}return r},t.prototype.setValidate=function(e,r){var t=this;return void 0===r&&e instanceof Array?(t.properties=e,t):(typeof e!==p?(t.properties=e,t.onValidate=r):t.onValidate=e,t)},t.prototype.setValidation=function(e,r){return OBSOLETE(this.name,'Instead of "SchemaBuilderEntity.setValidation()" use "SchemaBuilderEntity.setValidate()"'),this.setValidate(e,r)},t.prototype.setPrefix=function(e){return this.resourcePrefix=e,this},t.prototype.setResource=function(e){return this.resourceName=e,this},t.prototype.setDefault=function(e){var r=this;return r.onDefault=e,r},t.prototype.setPrepare=function(e){var r=this;return r.onPrepare=e,r},t.prototype.setSave=function(e){var r=this;return r.onSave=e,r},t.prototype.setError=function(e){var r=this;return r.onError=e,r},t.prototype.setGet=function(e){var r=this;return r.onGet=e,r},t.prototype.setQuery=function(e){var r=this;return r.onQuery=e,r},t.prototype.setRemove=function(e){var r=this;return r.onRemove=e,r},t.prototype.setProperties=function(e){var r=this;return r.properties=e,r},t.prototype.addRule=function(e,r){var t=this;return void 0===r&&(r=e,e="default"),t.rules||(t.rules={}),t.rules[e]=r,t},t.prototype.constant=function(e,r){var t=this;return void 0===r?t.constants?t.constants[e]:void 0:(t.constants||(t.constants={}),t.constants[e]=r,t)},t.prototype.addTransform=function(e,r){var t=this;return typeof e===p&&(r=e,e="default"),t.transforms||(t.transforms={}),t.transforms[e]=r,t},t.prototype.addOperation=function(e,r){var t=this;return typeof e===p&&(r=e,e="default"),t.operations||(t.operations={}),t.operations[e]=r,t},t.prototype.addWorkflow=function(e,r){var t=this;return typeof e===p&&(r=e,e="default"),t.workflows||(t.workflows={}),t.workflows[e]=r,t},t.prototype.addCompose=function(e,r){var t=this;return typeof e===p&&(r=e,e="default"),t.composes||(t.composes={}),t.composes[e]=r,t},t.prototype.addComposer=function(e,r){return this.addCompose(e,r)},t.prototype.find=function(e){return this.parent.get(e)},t.prototype.rule=function(e,r){var t=this;if(r)return t.addRule(e,r);if(void 0!==t.rules)return void 0===e&&(e="default"),t.rules[e]},t.prototype.destroy=function(){var e=this;delete e.parent.collection[e.name],e.properties=null,e.schema=null,e.onDefault=null,e.onValidate=null,e.onValidation=null,e.onSave=null,e.onRead=null,e.onRemove=null,e.onQuery=null,e.workflows=null,e.transforms=null},t.prototype.save=function(e,r,t,o){typeof t===g?(o=t,t=r,r=void 0):void 0===t&&(t=r,r=void 0),typeof t!==p&&(t=function(){});var s=this,a="save";return s.$prepare(e,function(e,u){if(e)return void t(e,u);var c=new i;return s.resourceName&&c.setResource(s.resourceName),s.resourcePrefix&&c.setPrefix(s.resourcePrefix),n(s,a,s.onSave)?(t.success=!1,void async.call(s,s.onSave)(function(e){e&&!t.success&&(t.success=!0,c.push(e),s.onError&&s.onError(c,u,a),t(c))},c,u,r,function(e){if(!t.success){(2===arguments.length||e instanceof Error||e instanceof i)&&((e instanceof Error||e instanceof i)&&c!==e&&c.push(e),e=arguments[1]);var r=c.hasError();r&&s.onError&&s.onError(c,u,a),t.success=!0,t(r?c:null,void 0===e?u:e)}},o!==!0)):(s.onSave(c,u,r,function(e){s.$process(arguments,u,a,void 0,c,e,t)},o!==!0),s)}),s},t.prototype.get=function(e,r){void 0===r&&(r=e,e=void 0),typeof r!==p&&(r=function(){});var t=this,o=new i;t.resourceName&&o.setResource(t.resourceName),t.resourcePrefix&&o.setPrefix(t.resourcePrefix);var s=t["default"](),a="get";return n(t,a,t.onGet)?(r.success=!1,async.call(t,t.onGet)(function(e){e&&!r.success&&(r.success=!0,o.push(e),t.onError&&t.onError(o,model,a),r(o))},o,s,e,function(e){if(!r.success){(2===arguments.length||e instanceof Error||e instanceof i)&&((e instanceof Error||e instanceof i)&&o!==e&&o.push(e),e=arguments[1]),r.success=!0;var n=o.hasError();n&&t.onError&&t.onError(o,model,a),r(n?o:null,void 0===e?s:e)}}),t):(t.onGet(o,s,e,function(e){t.$process(arguments,s,a,void 0,o,e,r)}),t)},t.prototype.remove=function(e,r){void 0===r&&(r=e,e=void 0);var t=this,o=new i,s="remove";return t.resourceName&&o.setResource(t.resourceName),t.resourcePrefix&&o.setPrefix(t.resourcePrefix),n(t,s,t.onRemove)?(r.success=!1,async.call(t,t.onRemove)(function(e){e&&!r.success&&(r.success=!0,o.push(e),t.onError&&t.onError(o,model,s),r(o))},o,e,function(n){if(!r.success){(2===arguments.length||n instanceof Error||n instanceof i)&&((n instanceof Error||n instanceof i)&&o!==n&&o.push(n),n=arguments[1]);var a=o.hasError();a&&t.onError&&t.onError(o,model,s),r.success=!0,r(a?o:null,void 0===n?e:n)}}),t):(t.onRemove(o,e,function(e){t.$process(arguments,void 0,s,void 0,o,e,r)}),t)},t.prototype.query=function(e,r){void 0===r&&(r=e,e=void 0);var t=this,o=new i,s="query";return t.resourceName&&o.setResource(t.resourceName),t.resourcePrefix&&o.setPrefix(t.resourcePrefix),n(t,s,t.onQuery)?(r.success=!1,async.call(t,t.onQuery)(function(e){e&&!r.success&&(r.success=!0,o.push(e),t.onError&&t.onError(o,model,s),r(o))},o,e,function(e){if(!r.success){(2===arguments.length||e instanceof Error||e instanceof i)&&((e instanceof Error||e instanceof i)&&o!==e&&o.push(e),e=arguments[1]);var n=o.hasError();n&&t.onError&&t.onError(o,model,s),r.success=!0,r(o.hasError()?o:null,e)}}),t):(t.onQuery(o,e,function(e){t.$process(arguments,void 0,s,void 0,o,e,r)}),t)},t.prototype.validate=function(e,r,t,n,o){var s=this,a=s.onValidate||s.onValidation;return void 0===n&&(n=new i,s.resourceName&&n.setResource(s.resourceName),s.resourcePrefix&&n.setPrefix(s.resourcePrefix)),void 0!==a&&null!==a||(a=framework.onValidate||framework.onValidation,void 0!==a&&null!==a)?(s.resourcePrefix&&(n.resourcePrefix=s.resourcePrefix),s.resourceName&&(n.resourceName=s.resourceName),t&&(n.resourceName=t),r&&(n.resourcePrefix=r),o&&(o=s.filter(o)),framework_utils.validate_builder.call(s,e,n,s.name,s.parent.collection,s.name,void 0,o)):n},t.prototype.create=function(){return this["default"]()},t.prototype.Create=function(){return this["default"]()},t.prototype.$make=function(e){if(e.$save)return e;var r=this;return e.$async=function(r,t){return void 0===r&&(r=NOOP),e.$$async=[],e.$$result=[],e.$callback=r,setImmediate(function(){e.$$async.async(function(){var n=e.$$result;delete e.$$result,delete e.$$async,r(null,void 0!==t?n[t]:n)})}),e},e.$save=function(t,n){return e.$$async?(e.$$async.push(function(n){r.save(e,t,function(r,t){if(e.$$result&&e.$$result.push(r?null:t),!r)return n();n=null;var t=e.$$result;delete e.$$result,delete e.$$async,e.$callback(r,t)})}),e):(r.save(e,t,n),e)},e.$remove=function(t,n){return e.$$async?(e.$$async.push(function(n){r.remove(e,t,function(r,t){if(e.$$result&&e.$$result.push(r?null:t),!r)return n();n=null;var t=e.$$result;delete e.$$result,delete e.$$async,e.$callback(r,t)})}),e):(r.remove(t,n),e)},e.$default=function(){return r["default"]()},e.$destroy=function(){e=null},e.$transform=function(t,n,o){return e.$$async?(e.$$async.push(function(o){r.transform(t,e,n,function(r,t){if(e.$$result&&e.$$result.push(r?null:t),!r)return o();o=null;var t=e.$$result;delete e.$$result,delete e.$$async,e.$callback(r,t)})}),e):(r.transform(t,e,n,o),e)},e.$compose=function(t,n,o){return e.$$async?(e.$$async.push(function(o){r.compose(t,e,n,function(r,t){if(e.$$result&&e.$$result.push(r?null:t),!r)return o();o=null;var t=e.$$result;delete e.$$result,delete e.$$async,e.$callback(r,t)})}),e):(r.compose(t,e,n,o),e)},e.$workflow=function(t,n,o){return e.$$async?(e.$$async.push(function(o){r.workflow(t,e,n,function(r,t){if(e.$$result&&e.$$result.push(r?null:t),!r)return o();o=null;var t=e.$$result;delete e.$$result,delete e.$$async,e.$callback(r,t)})}),e):(r.workflow(t,e,n,o),e)},e.$operation=function(t,n,o){return e.$$async?(e.$$async.push(function(o){r.operation(t,e,n,function(r,t){if(e.$$result&&e.$$result.push(r?null:t),!r)return o();o=null;var t=e.$$result;delete e.$$result,delete e.$$async,e.$callback(r,t)})}),e):(r.operation(t,e,n,o),e)},e.$clean=function(){return r.clean(e)},e.$clone=function(){return r.$make(JSON.parse(JSON.stringify(e)))},e.$prepare=function(){return r.prepare(e)},e.$schema=function(){return r},e.$validate=function(t,n,o){return r.validate(e,t,n,o)},e.$rule=function(e){return r.rule(e)},e.$constant=function(e){return r.constant(e)},e},t.prototype.$prepare=function(e,r){var t=this;return typeof e.$save===p?(r(null,e),t):(t.make(e,function(e,t){r(e,t)}),t)},t.prototype["default"]=function(){var e=this,r=e.schema;if(null===r)return null;var t=e.onDefault,n=framework_utils.extend({},r,!0);for(var o in n){var i=n[o];if(t){var s=t(o,!0,e.name);if(void 0!==s){n[o]=s;continue}}switch(i.type){case 0:case 6:n[o]=i.isArray?[]:null;break;case 1:case 2:n[o]=i.isArray?[]:0;break;case 3:n[o]=i.isArray?[]:"";break;case 4:n[o]=i.isArray?[]:!1;break;case 5:n[o]=i.isArray?[]:new Date;break;case 7:if(i.isArray)n[o]=[];else{var a=e.find(i.raw);a?n[o]=a["default"]():(framework.error(new Error('Schema: "'+o+"."+i.raw+'" not found in "'+e.parent.name+'".')),n[o]=null)}}}return e.$make(n)},t.prototype.make=t.prototype.load=function(e,r,t){var n=this;if(typeof e===p)return e.call(n,n);var o=n.prepare(e);if(!n.onValidate&&!n.onValidation&&(n.onValidate=framework.onValidate||framework.onValidation,!n.onValidate))return r&&r(null,o),o;var i=n.validate(o,void 0,void 0,void 0,t);return i.hasError()?(n.onError&&n.onError(i,e,"make"),r&&r(i,null),o):(r&&r(null,o),o)},t.prototype.prepare=function(e,r){var t=this,n=t.schema;if(null===n)return null;if(null===e||void 0===e)return t["default"]();var i,s,u=function(r,n,o){if(!t.onPrepare)return n;var i=t.onPrepare(r,n,o,e);return void 0===i?n:i},c=framework_utils.extend({},n,!0),l=t.onDefault;for(var f in c){var g=e[f];e.hasOwnProperty(f)||(g=void 0),void 0===g&&l&&(g=l(f,!1,t.name)),void 0===g&&(g="");var v=c[f],y=typeof g;if(y===p&&(g=g()),v.isArray)if(g instanceof Array){c[f]=[];for(var w=0,b=g.length;b>w;w++){switch(i=e[f][w],y=typeof i,v.type){case 0:i=u(f,i,w);break;case 1:i=u(f,framework_utils.parseInt(i),w);break;case 2:i=u(f,framework_utils.parseFloat(i),w);break;case 3:i=void 0===i||null===i?"":o(t,i.toString()),v.length&&i.length<i.length&&(i=i.substring(0,v.length)),i=u(f,i,w);break;case 4:i&&(i=i.toString().toLowerCase()),i=u(f,"true"===i||"1"===i||"on"===i,w);break;case 5:y===m?i=""===i?null:i.trim().parseDate():y===d?i=framework_utils.isDate(i)?i:null:y===h&&(i=new Date(i)),null!==i&&typeof i===d&&"Invalid Date"===i.toString()&&(i=null),i=i?u(f,i,w):void 0;break;case 6:i=u(f,i,w);break;case 7:s=t.parent.get(v.raw),s?(i=s.prepare(i,r),r&&r.push({name:v.raw,value:u(f,i,w)})):i=null,i=u(f,i,w)}void 0!==i&&c[f].push(i)}}else c[f]=l?a(l(f,!1,t.name),[]):[];else switch(v.type){case 0:break;case 1:c[f]=u(f,framework_utils.parseInt(g));break;case 2:c[f]=u(f,framework_utils.parseFloat(g));break;case 3:i=void 0===g||null===g?"":o(t,g.toString()),v.length&&v.length<i.length&&(i=i.substring(0,v.length)),c[f]=u(f,i);break;case 4:i=g?g.toString().toLowerCase():null,c[f]=u(f,"true"===i||"1"===i||"on"===i);break;case 5:i=null,y===m?i=""===g?null:g.trim().parseDate():y===d?i=framework_utils.isDate(g)?g:null:y===h&&(i=new Date(g)),null!==i&&typeof i===d&&"Invalid Date"===i.toString()&&(i=null),i?c[f]=u(f,i):c[f]=l?a(l(f,!1,t.name),null):null;break;case 6:c[f]=u(f,e[f]);break;case 7:if(!g&&(g=l?a(l(f,!1,t.name),null):null,null===g)){c[f]=null;break}if(g&&typeof g.$schema===p&&(i=g.$schema(),i&&i.name&&i.name===v.raw)){c[f]=g;break}s=t.parent.get(v.raw),s?(c[f]=s.prepare(g),r&&r.push({name:v.raw,value:u(f,c[f])})):c[f]=null}}return t.$make(c)},t.prototype.transform=function(e,r,t,o,s){var a=this;typeof e!==m&&(o=t,t=r,r=e,e="default"),typeof o===g?(s=o,o=t,t=void 0):void 0===o&&(o=t,t=void 0),typeof o!==p&&(o=function(){});var u=a.transforms?a.transforms[e]:void 0;if(!u)return o((new i).add("","Transform not found.")),a;var c="transform";if(s===!0){var l=new i;return a.resourceName&&l.setResource(a.resourceName),a.resourcePrefix&&l.setPrefix(a.resourcePrefix),u.call(a,l,r,t,function(t){a.$process(arguments,r,c,e,l,t,o)},s!==!0),a}return a.$prepare(r,function(r,l){if(r)return void o(r,l);var f=new i;return a.resourceName&&f.setResource(a.resourceName),a.resourcePrefix&&f.setPrefix(a.resourcePrefix),n(a,"transform."+e,u)?(o.success=!1,void async.call(a,u)(function(r){r&&!o.success&&(o.success=!0,f.push(r),a.onError&&a.onError(f,l,c,e),o(f))},f,l,t,function(r){if(!o.success){(2===arguments.length||r instanceof Error||r instanceof i)&&((r instanceof Error||r instanceof i)&&f!==r&&f.push(r),r=arguments[1]);var t=f.hasError();t&&a.onError&&a.onError(f,l,c,e),o.success=!0,o(t?f:null,void 0===r?l:r)}},s!==!0)):void u.call(a,f,l,t,function(r){a.$process(arguments,l,c,e,f,r,o)},a.name)}),a},t.prototype.compose=function(e,r,t,o,s){var a=this;typeof e!==m&&(o=t,t=r,r=e,e="default"),typeof o===g?(s=o,o=t,t=void 0):void 0===o&&(o=t,t=void 0),typeof o!==p&&(o=function(){});var u=a.composes?a.composes[e]:void 0;if(!u)return o((new i).add("","Composer not found.")),a;var c="compose";if(s===!0){var l=new i;return a.resourceName&&l.setResource(a.resourceName),a.resourcePrefix&&l.setPrefix(a.resourcePrefix),u.call(a,l,r,t,function(t){a.$process(arguments,r,c,e,l,t,o)},s!==!0),a}return a.$prepare(r,function(r,l){if(r)return void o(r,l);var f=a["default"](),p=new i;return a.resourceName&&p.setResource(a.resourceName),a.resourcePrefix&&p.setPrefix(a.resourcePrefix),n(a,"compose."+e,u)?(o.success=!1,void async.call(a,u)(function(r){r&&!o.success&&(o.success=!0,p.push(r),a.onError&&a.onError(p,l,c,e),o(p))},p,l,t,function(r){if(!o.success){(2===arguments.length||r instanceof Error||r instanceof i)&&((r instanceof Error||r instanceof i)&&p!==r&&p.push(r),r=arguments[1]);var t=p.hasError();t&&a.onError&&a.onError(p,l,c,e),o.success=!0,o(t?p:null,void 0===r?l:r)}},s!==!0)):void u.call(a,p,f,l,t,function(r){a.$process(arguments,l,c,e,p,r,o)},s!==!0)}),a},t.prototype.$process=function(e,r,t,n,o,s,a){var u=this;(2===e.length||s instanceof Error||s instanceof i)&&((s instanceof Error||s instanceof i)&&o!==s&&o.push(s),s=e[1]);var c=o.hasError();return c&&u.onError&&u.onError(o,r,t,n),a(c?o:null,void 0===s?r:s,r),u},t.prototype.workflow=function(e,r,t,o,s){var a=this;typeof e!==m&&(o=t,t=r,r=e,e="default"),typeof o===g?(s=o,o=t,t=void 0):void 0===o&&(o=t,t=void 0),typeof o!==p&&(o=function(){});var u=a.workflows?a.workflows[e]:void 0;if(!u)return o((new i).add("","Workflow not found.")),a;var c="workflow";if(s===!0){var l=new i;return a.resourceName&&l.setResource(a.resourceName),a.resourcePrefix&&l.setPrefix(a.resourcePrefix),u.call(a,l,r,t,function(t){a.$process(arguments,r,c,e,l,t,o)},s!==!0),a}return a.$prepare(r,function(r,l){if(r)return void o(r,l);var f=new i;return a.resourceName&&f.setResource(a.resourceName),a.resourcePrefix&&f.setPrefix(a.resourcePrefix),n(a,"workflow."+e,u)?(o.success=!1,void async.call(a,u)(function(r){r&&!o.success&&(o.success=!0,f.push(r),a.onError&&a.onError(f,l,c,e),o(f))},f,l,t,function(r){if(!o.success){(2===arguments.length||r instanceof Error||r instanceof i)&&((r instanceof Error||r instanceof i)&&f!==r&&f.push(r),r=arguments[1]);var t=f.hasError();t&&a.onError&&a.onError(f,l,c,e),o.success=!0,o(t?f:null,void 0===r?l:r)}},s!==!0)):void u.call(a,f,l,t,function(r){a.$process(arguments,l,c,e,f,r,o)},s!==!0)}),a},t.prototype.operation=function(e,r,t,o,s){var a=this,u=typeof t,c=typeof o;c===f?u===p?(o=t,t=r,r=void 0):u===f&&(t=r,r=void 0):u===f?(t=r,r=void 0):c===g&&(s=o,o=t,t=void 0),typeof t===p&&(o=t,t=void 0),typeof o!==p&&(o=function(){});var l=a.operations?a.operations[e]:void 0;if(!l)return o((new i).add("","Operation not found.")),a;var d=new i,m="operation";return a.resourceName&&d.setResource(a.resourceName),a.resourcePrefix&&d.setPrefix(a.resourcePrefix),n(a,"operation."+e,l)?(o.success=!1,async.call(a,l)(function(t){t&&!o.success&&(o.success=!0,d.push(t),a.onError&&a.onError(d,r,m,e),o(d))},d,r,t,function(t){if(!o.success){(2===arguments.length||t instanceof Error||t instanceof i)&&((t instanceof Error||t instanceof i)&&d!==t&&d.push(t),t=arguments[1]);var n=d.hasError();n&&a.onError&&a.onError(d,r,m,e),o.success=!0,o(n?d:null,t)}},s!==!0),a):(l.call(a,d,r,t,function(t){a.$process(arguments,r,m,e,d,t,o)},s!==!0),a)},t.prototype.clean=function(e,r){if(null===e||void 0===e)return e;var t;t=r?e:framework_utils.copy(e);var n=this;delete t.$$result,delete t.$$async,delete t.$clone,delete t.$async,delete t.$callback,delete t.$transform,delete t.$workflow,delete t.$operation,delete t.$destroy,delete t.$save,delete t.$remove,delete t.$clean,delete t.$prepare,delete t.$default,delete t.$schema,delete t.$validate,delete t.$compose,delete t.$rule,delete t.$constant;for(var o in t){var i=t[o];if(null!==i&&typeof i===d)if(i instanceof Array)for(var s=0,a=i.length;a>s;s++){var u=i[s];null!==u&&typeof u===d&&(i[s]=n.clean(u,!0))}else t[o]=n.clean(i,!0)}return t},l.schema=function(e,t,n,o,i){if(void 0===t)return void 0===w[e]&&(w[e]=new r(e)),w[e];void 0===w[y]&&(w[y]=new r(y)),typeof n!==p&&(n=void 0),typeof o!==p&&(o=void 0),i instanceof Array||(i=void 0);var s=w[y].add(e,t,i,o);return n&&s.setDefault(n),t},l.load=function(e,t,n){e||(e=y),void 0===w[e]&&(w[e]=new r(e));var o;if(t&&(o=w[e].get(t),!o))throw new Error("Schema "+e+"."+t+" not found.");return n?o.make(n):t?o:w[e]},l.eachschema=function(e,r){void 0===r&&(r=e,e=void 0);for(var t=e?[e]:Object.keys(w),n=0,o=t.length;o>n;n++){var i=w[t[n]];if(i)for(var s=Object.keys(i.collection),a=0,u=s.length;u>a;a++)r(i.name,i.collection[s[a]].name,i.collection[s[a]])}},l.getschema=function(e,r){r||(r=e,e=y);var t=w[e];if(void 0!==t){var n=t.get(r);return n?n:void 0}},l.newschema=function(e,t,n){e||(e=y),void 0===w[e]&&(w[e]=new r(e));var o;return t&&(o=w[e].get(t),o||(o=w[e].create(t))),n?o.make(n):t?o:w[e]},l.remove=function(e){delete w[e]},l.isJoin=function(e,r){return r?"["===r[0]?!0:void 0===e?!1:void 0!==e[r]:!1},l.validation=function(e,r,t){if(void 0===w[y])return[];var n=w[y].get(e);if(void 0===n)return[];if(t instanceof Array&&typeof r===p){var o=t;t=r,r=o}if(typeof t===p)return n.onValidate=t,void 0===r?n.properties=Object.keys(n.schema):n.properties=r,!0;if(void 0===t){var i=n.properties;return void 0===i?Object.keys(n.schema):i||[]}return n.onValidate=t,t},l.validate=function(e,r,t,n){var o=w[y];return void 0===o?null:(o=o.get(e),void 0===o?null:o.validate(r,t,n))},l.create=function(e){return l.defaults(e)},l.defaults=function(e){if(void 0===w[y])return null;var r=w[y].get(e);return void 0===r?null:r["default"]()},l.prepare=function(e,r){if(void 0===w[y])return null;var t=w[y].get(e);return void 0===t?null:t.prepare(r);
},i.prototype={get errors(){var e=this;return e.isPrepared||e.prepare(),e._transform()},get error(){var e=this;return e.isPrepared||e.prepare(),e._transform()}},i.prototype.resource=function(e,r){var t=this;return t.isResourceCustom=!0,t.resourceName=e||"default",t.resourcePrefix=r||"",t._resource()},i.prototype.setContentType=function(e){return this.contentType=e,this},i.prototype.setResource=function(e){var r=this;return r.isResourceCustom=!0,r.resourceName=e||"default",r._resource()},i.prototype.setPrefix=function(e){var r=this;return r.isResourceCustom=!0,r.resourcePrefix=e||"",r._resource()},i.prototype._resource=function(){var e=this;return e.onResource=function(e){var r=this;return typeof framework!==f?framework.resource(r.resourceName,r.resourcePrefix+e):""},e},i.prototype.add=function(e,r,t,n){var o=this;if(o.isPrepared=!1,e instanceof i){if(e.hasError()){for(var s=0,a=e.items.length;a>s;s++)o.items.push(e.items[s]);o.count=o.items.length}return o}if(e instanceof Array){for(var s=0,a=e.length;a>s;s++)o.add(e[s],void 0,t,n);return o}if(r instanceof Array){for(var s=0,a=r.length;a>s;s++)o.add(e,r[s],t,n);return o}return typeof e===d&&(t=r,r=e,e=""),void 0!==e&&null!==e||void 0!==r&&null!==r?(void 0===r&&(r="@"),void 0===r||null===r?o:(r instanceof Error&&(r=r.toString()),o.items.push({name:e,error:typeof r===m?r:(r||"").toString()||"@",path:t,index:n}),o.count=o.items.length,o)):o},i.prototype.push=function(e,r,t,n){return this.add(e,r,t,n)},i.prototype.remove=function(e){var r=this;return r.items=r.items.remove(function(r){return r.name===e}),r.count=r.items.length,r},i.prototype.hasError=function(e){var r=this;return e?null!==r.items.find(function(r){return r.name===e}):r.items.length>0},i.prototype.read=function(e){var r=this;r.isPrepared||r.prepare();var t=r.items.find(function(r){return r.name===e});return null!==t?t.error:null},i.prototype.clear=function(){var e=this;return e.items=[],e.count=0,e},i.prototype.replace=function(e,r){var t=this;return t.isPrepared=!1,t.replacer[e]=r,t},i.prototype.json=function(e,r){var t;return t=this.prepare().items,e?JSON.stringify(t,r,"	"):JSON.stringify(t,r)},i.prototype.JSON=function(e,r){return this.json(e,r)},i.prototype._prepare=function(){var e=this;if(null===e.onResource)return e;for(var r=e.items,t=r.length,n=0;t>n;n++){var o=r[n];"@"===o.error[0]&&(1===o.error.length?o.error=e.onResource(o.name):o.error=e.onResource(o.error.substring(1)),(void 0===o.error||0===o.error.length)&&(o.error=v.replace("@",o.name)))}return e},i.prototype._transform=function(e){var r=this,t=e||r.transformName;if(!t)return r.items;var n=b.error[t];return void 0===n?r.items:n.call(r)},i.prototype.output=function(){var e=this;if(!e.transformName)return e.json();var r=b.error[e.transformName];return r?(e.prepare(),r.call(e)):e.json()},i.prototype.toString=function(){var e=this;e.isPrepared||e.prepare();for(var r=e.items,t=r.length,n=[],o=0;t>o;o++)n.push(r[o].error||r[o].name);return n.join("\n")},i.prototype.setTransform=function(e){var r=this;return r.transformName=e,r},i.prototype.transform=function(e){var r=this;return r.prepare()._transform(e)},i.prototype._prepareReplace=function(){var e=this,r=e.items,t=r.length,n=Object.keys(e.replacer),o=n.length;if(0===t||0===o)return e;for(var i=0;t>i;i++)for(var s=r[i],a=0;o>a;a++){var u=n[a];s.error=s.error.replace(u,e.replacer[u])}return e},i.prototype.prepare=function(){var e=this;return e.isPrepared?e:(e._prepare()._prepareReplace(),e.isPrepared=!0,e)},i.addTransform=function(e,r,t){b.error[e]=r,t&&i.setDefaultTransform(e)},i.removeTransform=function(e){delete b.error[e]},i.setDefaultTransform=function(e){void 0===e?delete b.error_default:b.error_default=e},u.addTransform=function(e,r,t){b.pagination[e]=r,t&&u.setDefaultTransform(e)},u.setDefaultTransform=function(e){void 0===e?delete b.pagination_default:b.pagination_default=e},u.removeTransform=function(e){delete b.pagination[e]},u.prototype.refresh=function(e,r,t){var n=this;return n.page=Math.max(1,+r)-1,n.page<0&&(n.page=0),n.items=Math.max(0,+e),n.max=Math.max(1,+t),n.skip=n.page*n.max,n.count=Math.ceil(n.items/n.max),n.take=Math.min(n.max,n.items-n.skip),n.lastPage=n.count,n.firstPage=1,n.prevPage=n.page?n.page:1,n.nextPage=n.page+2<n.count-1?n.page+2:n.count,n.isPrev=n.page>0,n.isNext=n.page<n.count-1,n.isFirst=0===n.page,n.isLast=n.page===n.count-1,n.visible=n.count>1,n.page++,n},u.prototype.setTransform=function(e){var r=this;return r._transform=e,r},u.prototype.transform=function(e){var r=this,t=e||r.transformName;if(!t)throw new Error("A transformation of Pagination not found.");var n=b.pagination[t];if(void 0===n)return r.render();for(var o=[],i=1;i<arguments.length;i++)o.push(arguments[i]);return n.apply(r,o)},u.prototype.prev=function(e){var r=this,t=0;return e=e||r.format,t=r.isPrev?r.page-1:r.count,{url:e.format(t,r.items,r.count),page:t,selected:!1,enabled:r.isPrev}},u.prototype.next=function(e){var r=this,t=0;return e=e||r.format,t=r.isNext?r.page+1:1,{url:e.format(t,r.items,r.count),page:t,selected:!1,enabled:r.isNext}},u.prototype.last=function(e){var r=this,t=r.count;return e=e||r.format,{url:e.format(t,r.items,r.count),page:t,selected:!1,enabled:r.count>0}},u.prototype.first=function(e){var r=this,t=1;return e=e||r.format,{url:e.format(t,r.items,r.count),page:t,selected:!1,enabled:r.count>0}},u.prototype.prepare=function(e,r){var t=this;if(t.transformName)return b.pagination[t.transformName].apply(t,arguments);var n=[];if(r=r||t.format,typeof e===m){var o=r;r=e,e=o}if(void 0===e||null===e){for(var i=1;i<t.count+1;i++)n.push({url:r.format(i,t.items,t.count),page:i,selected:i===t.page,enabled:!0});return n}var s=Math.floor(e/2),a=t.count,u=t.page-s,c=t.page+s,l=0;0>=u&&(l=Math.abs(u),u=1,c+=l),c>=a&&(c=a,u=a-e),0>u&&(u=1);for(var i=u;c+1>i;i++)n.push({url:r.format(i,t.items,t.count),page:i,selected:i===t.page,enabled:!0});return n},u.prototype.render=function(e,r){return this.prepare(e,r)},s.prototype.add=function(e,r){var t=this;if(typeof e!==d)return t.builder[e]=r,t;for(var n=Object.keys(e),o=0,i=n.length;i>o;o++)t.builder[n[o]]=e[n[o]];return t},s.prototype.remove=function(e){var r=this;return delete r.builder[e],r},s.prototype.read=function(e){return this.builder[e]||null},s.prototype.clear=function(){var e=this;return e.builder={},e},s.prototype.toString=function(e,r){if(typeof e===g){var t=r;r=e,e=t}var n=this,o=[];return Object.keys(n.builder).forEach(function(e){var t=n.builder[e];t=void 0===t||null===t?"":t.toString(),r&&""===t||o.push(e+"="+encodeURIComponent(t))}),typeof e===m?"?"!==e[e.length-1]&&(e+="?"):e="",e+o.join("&")},s.prototype.hasValue=function(e){if(void 0===e)return!1;var r=this;"string"==typeof e&&(e=[e]);for(var t=0;t<e.length;t++){var n=r.builder[e[t]];if(void 0===n||null===n)return!1}return!0},s.prototype.toOne=function(e,r){var t=this,n=[];return e.forEach(function(e){n.push(t.builder[e]||"")}),n.join(r||"&")},c.transform=function(e,r){var t=2;void 0===r&&(r=e,e=b.transformbuilder_default,t=1);var n=b.transformbuilder[e];if(!n)return F.error('Transformation "'+e+'" not found.',"TransformBuilder.transform()"),r;var o=arguments.length-t;if(0>=o)return n.call(r,r);var i=new Array(o+1),s=1;i[0]=r;for(var a=t;a<arguments.length;a++)i[s++]=arguments[a];return n.apply(r,i)},c.addTransform=function(e,r,t){b.transformbuilder[e]=r,t&&c.setDefaultTransform(e)},c.setDefaultTransform=function(e){void 0===e?delete b.transformbuilder_default:b.transformbuilder_default=e},l.SchemaBuilder=r,l.ErrorBuilder=i,l.Pagination=u,l.UrlBuilder=s,l.TransformBuilder=c,global.ErrorBuilder=i,global.TransformBuilder=c,e}({exports:{}}),function(module){function expression(query,params){var name=params.join(","),fn=expressionCache[query+"-"+name];fn||(fn=eval("(function("+name+"){"+(-1===query.indexOf("return")?"return ":"")+query+"})"),expressionCache[query+name]=fn);for(var values=[],i=2;i<arguments.length;i++)values.push(arguments[i]);return function(){for(var e=[],r=0;r<arguments.length;r++)e.push(arguments[r]);for(var r=0;r<values.length;r++)e.push(values[r]);return fn.apply(this,e)}}function getWebSocketFrameMessageBytes(e,r){for(var t=0===e?0:2,n=void 0!==r.readUInt8,o=r.length,i=new Buffer(o+t),s=0;o>s;s++)n?i[s+t]=r[s]:i[s+t]=r.charCodeAt(s);return 0===e?i:(i[0]=e>>8,i[1]=e,i)}function getWebSocketFrameLengthBytes(e){var r=null;return 125>=e?(r=new Buffer(1),r[0]=e,r):65535>=e?(r=new Buffer(3),r[0]=126,r[1]=e>>8&255,r[2]=255&e,r):(r=new Buffer(9),r[0]=127,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=e>>24&255,r[6]=e>>16&255,r[7]=e>>8&255,r[8]=255&e,r)}function string_hash(e){var r,t,n=0;if(0===e.length)return n;var o=e.length;for(r=0;o>r;r++)t=e.charCodeAt(r),n=(n<<5)-n+t,n|=0;return n}function AsyncTask(e,r,t,n,o){this.isRunning=0,this.owner=e,this.name=r,this.fn=t,this.cb=n,this.waiting=o,this.interval=null,this.isCanceled=!1}function Async(e){this._max=0,this._count=0,this._isRunning=!1,this._isEnd=!1,this.owner=e,this.onComplete=[],this.tasksPending={},this.tasksWaiting={},this.tasksAll=[],this.tasksTimeout={},this.isCanceled=!1,events.EventEmitter.call(this)}function FileList(){this.pending=[],this.pendingDirectory=[],this.directory=[],this.file=[],this.onComplete=null,this.onFilter=null}function converBytesToInt64(e,r,t){return t?e[r]|e[r+1]<<8|e[r+2]<<16|e[r+3]<<24|e[r+4]<<32|e[r+5]<<40|e[r+6]<<48|e[r+7]<<56:e[r+7]<<32|e[r+6]<<40|e[r+5]<<48|e[r+4]<<56|e[r+3]|e[r+2]<<8|e[r+1]<<16|e[r]<<24}function queue_next(e){var r=exports.queuecache[e];if(r&&(r.running--,r.running<0&&(r.running=0),0!==r.pending.length)){var t=r.pending.shift();if(!t)return void(r.running=0);r.running++,function(e){setImmediate(function(){t(function(){queue_next(e)})})}(e)}}var exports=module.exports;global.framework_utils=module.exports;var Dns=require("dns"),parser=require("url"),qs=require("querystring"),http=require("http"),https=require("https"),path=require("path"),fs=require("fs"),events=require("events"),crypto=require("crypto"),expressionCache={},regexpMail=new RegExp("^[a-zA-Z0-9-_.+]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,6}$"),regexpUrl=new RegExp("^(http[s]?:\\/\\/(www\\.)?|ftp:\\/\\/(www\\.)?|www\\.){1}([0-9A-Za-z-\\.@:%_+~#=]+)+((\\.[a-zA-Z]{2,3})+)(/(.)*)?(\\?(.)*)?"),regexpTRIM=/^[\s]+|[\s]+$/g,regexpDATE=/(\d{1,2}\.\d{1,2}\.\d{4})|(\d{4}\-\d{1,2}\-\d{1,2})|(\d{1,2}\:\d{1,2}(\:\d{1,2})?)/g,regexpSTATIC=/\.\w{2,8}($|\?)+/,regexpDATEFORMAT=/yyyy|yy|MM|M|dd|d|HH|H|hh|h|mm|m|ss|s|a|ww|w/g,regexpSTRINGFORMAT=/\{\d+\}/g,regexpPATH=/\\/g,DIACRITICS={225:"a",228:"a",269:"c",271:"d",233:"e",283:"e",357:"t",382:"z",250:"u",367:"u",252:"u",369:"u",237:"i",239:"i",244:"o",243:"o",246:"o",353:"s",318:"l",314:"l",253:"y",255:"y",263:"c",345:"r",341:"r",328:"n",337:"o"},SOUNDEX={a:"",e:"",i:"",o:"",u:"",b:1,f:1,p:1,v:1,c:2,g:2,j:2,k:2,q:2,s:2,x:2,z:2,d:3,t:3,l:4,m:5,n:5,r:6},ENCODING="utf8",UNDEFINED="undefined",STRING="string",FUNCTION="function",NUMBER="number",OBJECT="object",BOOLEAN="boolean",NEWLINE="\r\n",VERSION=typeof framework!==UNDEFINED?" v"+framework.version_header:"",isWindows="win"===require("os").platform().substring(0,3).toLowerCase(),dnscache={},contentTypes={aac:"audio/aac",ai:"application/postscript",appcache:"text/cache-manifest",avi:"video/avi",bin:"application/octet-stream",bmp:"image/bmp",coffee:"text/coffeescript",css:"text/css",csv:"text/csv",doc:"application/msword",docx:"application/msword",dtd:"application/xml-dtd",eps:"application/postscript",exe:"application/octet-stream",geojson:"application/json",gif:"image/gif",gzip:"application/x-gzip",htm:"text/html",html:"text/html",ico:"image/x-icon",ics:"text/calendar",ifb:"text/calendar",jpe:"image/jpeg",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json",less:"text/css",m4a:"audio/mp4a-latm",m4v:"video/x-m4v",manifest:"text/cache-manifest",md:"text/x-markdown",mid:"audio/midi",midi:"audio/midi",mov:"video/quicktime",mp3:"audio/mpeg",mp4:"video/mp4",mpe:"video/mpeg",mpeg:"video/mpeg",mpg:"video/mpeg",mpga:"audio/mpeg",mtl:"text/plain",mv4:"video/mv4",obj:"text/plain",ogg:"application/ogg","package":"text/plain",pdf:"application/pdf",png:"image/png",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.ms-powerpoint",ps:"application/postscript",rar:"application/x-rar-compressed",rtf:"text/rtf",sass:"text/css",scss:"text/css",sh:"application/x-sh",stl:"application/sla",svg:"image/svg+xml",swf:"application/x-shockwave-flash",tar:"application/x-tar",tif:"image/tiff",tiff:"image/tiff",txt:"text/plain",wav:"audio/x-wav",webp:"image/webp",woff:"application/font-woff",woff2:"application/font-woff2",xht:"application/xhtml+xml",xhtml:"application/xhtml+xml",xls:"application/vnd.ms-excel",xlsx:"application/vnd.ms-excel",xml:"application/xml",xpm:"image/x-xpixmap",xsl:"application/xml",xslt:"application/xslt+xml",zip:"application/zip"};typeof setImmediate===UNDEFINED&&(global.setImmediate=function(e){process.nextTick(e)});var hasOwnProperty=Object.prototype.hasOwnProperty;return global.expression=expression,exports.isEmpty=function(e){if(null===e)return!0;if(e.length)return!1;if(0===e.length)return!0;for(var r in e)if(hasOwnProperty.call(e,r))return!1;return!0},exports.isEqual=function(e,r,t){for(var n=t?t:Object.keys(e),o=0,i=n.length;i>o;o++){var s=n[o],a=e[s],u=r[s],c=typeof a,l=typeof u;if(c!==l)return!1;if(a!==u){if(a instanceof Date&&u instanceof Date){if(a.getTime()===u.getTime())continue;return!1}if(a instanceof Array&&u instanceof Array){if(JSON.stringify(a)===JSON.stringify(u))continue;return!1}if(c!==OBJECT||l!==OBJECT||!exports.isEqual(a,u))return!1}}return!0},exports.wait=function(e,r,t,n){if(e()===!0)return r(null,!0);var o=null,i=setInterval(function(){return e()===!0?(clearInterval(i),clearTimeout(o),void(r&&r(null,!0))):void 0},n||500);o=setTimeout(function(){clearInterval(i),r&&r(new Error("Timeout."),!1)},t||5e3)},exports.$$wait=function(e,r,t){return function(n){exports.wait(e,n,r,t)}},exports.resolve=function(e,r){var t=parser.parse(e);return r?dnscache[t.host]?(t.host=dnscache[t.host],void r(null,t)):void Dns.resolve4(t.hostname,function(e,n){return e?void setImmediate(function(){Dns.resolve4(t.hostname,function(e,n){return e?r(e,t):(dnscache[t.host]=n[0],t.host=n[0],void r(null,t))})}):(dnscache[t.host]=n[0],t.host=n[0],void r(null,t))}):dnscache[t.host]},exports.$$resolve=function(e){return function(r){return exports.resolve(e,r)}},exports.clearDNS=function(){dnscache={}},exports.keywords=function(e,r,t,n,o,i){void 0===r&&(r=!0),i=i||2,n=n||200,o=o||20;var s=[],a="soundex"===t;if(e instanceof Array){for(var u=0,c=e.length;c>u;u++)if(e[u]){var l=(r?e[u].removeDiacritics().toLowerCase().replace(/y/g,"i"):e[u].toLowerCase()).split(" ");if(l&&l.length)for(var f=0,p=l.length;p>f;f++)s.push(l[f])}}else s=(r?e.removeDiacritics().toLowerCase().replace(/y/g,"i"):e.toLowerCase()).split(" ");s||(s=[]);for(var d={},m=0,u=0,c=s.length;c>u;u++){var h=s[u].trim();if(!(h.length<i)){if(m>=n)break;if(r&&(h=h.replace(/\W|_/g,"")),t)if(a)h=h.soundex();else{var g=h.length/100*80;g>i+1&&(h=h.substring(0,g))}h.length<i||h.length>o||(d[h]?d[h]++:d[h]=1,m++)}}var v=Object.keys(d);return v.sort(function(e,r){var t=d[e],n=d[r];return t>n?-1:n>t?1:0}),v},exports.request=function(e,r,t,n,o,i,s,a){typeof t===FUNCTION&&(a=s,s=i,i=o,o=n,n=t,t=""),typeof o===NUMBER&&(o=null,a=o),typeof i===NUMBER&&(i=null,a=i),typeof s===NUMBER&&(s=null,a=s);var u="",c=0,l=0,f=new events.EventEmitter,p=!1;if(i=i?exports.extend({},i):{},typeof s!==STRING&&(s=ENCODING),null===t&&(t=""),r instanceof Array){c=r.length;for(var d=0;c>d;d++)switch(r[d].toLowerCase()){case"xhr":i["X-Requested-With"]="XMLHttpRequest";break;case"json":i["Content-Type"]="application/json",""===u&&(u="POST"),l=1;break;case"xml":i["Content-Type"]="text/xml",""===u&&(u="POST"),l=2;break;case"get":case"options":case"head":u=r[d].toUpperCase();break;case"upload":i["Content-Type"]="multipart/form-data";break;case"post":case"put":case"delete":u=r[d].toUpperCase(),i["Content-Type"]||(i["Content-Type"]="application/x-www-form-urlencoded");break;case"dnscache":p=!0}}u||(u="GET");var m="POST"===u||"PUT"===u||"DELETE"===u;typeof t!==STRING?t=1===l?JSON.stringify(t):qs.stringify(t):"?"===t[0]&&(t=t.substring(1)),m||(t.length&&-1===e.indexOf("?")&&(e+="?"+t),t="");var h=parser.parse(e),g=0;if(h.method=u,i["X-Powered-By"]="total.js"+VERSION,o){var v="";for(var y in o)v+=(v?"; ":"")+y+"="+encodeURIComponent(o[y]);v&&(i.Cookie=v)}var w;t.length&&(w=new Buffer(t,ENCODING),i["Content-Length"]=w.length),h.agent=!1,h.headers=i;var b=function(e){return e._buffer="",e._bufferlength=0,301===e.statusCode?(exports.request(e.headers.location,r,t,n,o,i,s,a),void(e=null)):(e.on("data",function(e){var r=this;r._buffer+=e.toString(s),r._bufferlength+=e.length,f.emit("data",e,g?r._bufferlength/g*100:0)}),e.on("end",function(){var e=this;f.emit("end",e._buffer,e.statusCode,e.headers,h.host),n&&n(null,e._buffer,e.statusCode,e.headers,h.host),n=null}),void e.resume())},E="https:"===h.protocol?https:http,k=function(){try{var e=m?E.request(h,b):E.get(h,b);n&&(e.on("error",function(e){n&&n(e,"",0,void 0,void 0,h.host),n=null}),e.setTimeout(a||1e4,function(){n&&n(new Error(exports.httpStatus(408)),"",0,void 0,h.host),n=null})),e.on("response",function(e){g=+e.headers["content-length"]||0,f.emit("begin",g)}),m&&w?e.end(w):e.end()}catch(r){n&&n(r,"",0)}};return p?exports.resolve(e,function(e,r){h.host=r.host,k()}):k(),f},exports.$$request=function(e,r,t,n,o,i,s){return function(a){exports.request(e,r,t,a,n,o,i,s)}},exports.btoa=function(e){return e instanceof Buffer?e.toString("base64"):new Buffer(e.toString(),"binary").toString("base64")},exports.atob=function(e){return new Buffer(e,"base64").toString("binary")},exports.download=function(e,r,t,n,o,i,s,a){typeof t===FUNCTION&&(a=s,s=i,i=o,o=n,n=t,t=""),typeof o===NUMBER&&(o=null,a=o),typeof i===NUMBER&&(i=null,a=i),typeof s===NUMBER&&(s=null,a=s);var u="GET",c=0,l=0,f=new events.EventEmitter,p=!1;if(i=i?exports.extend({},i):{},typeof s!==STRING&&(s=ENCODING),null===t&&(t=""),r instanceof Array){c=r.length;for(var d=0;c>d;d++)switch(r[d].toLowerCase()){case"xhr":i["X-Requested-With"]="XMLHttpRequest";break;case"json":i["Content-Type"]="application/json",l=1;break;case"xml":i["Content-Type"]="text/xml",l=2;break;case"get":case"delete":case"options":u=r[d].toUpperCase();break;case"upload":i["Content-Type"]="multipart/form-data";break;case"post":case"put":u=r[d].toUpperCase(),i["Content-Type"]||(i["Content-Type"]="application/x-www-form-urlencoded");break;case"dnscache":p=!0}}var m="POST"===u||"PUT"===u;typeof t!==STRING?t=1===l?JSON.stringify(t):qs.stringify(t):"?"===t[0]&&(t=t.substring(1)),m||(t.length&&-1===e.indexOf("?")&&(e+="?"+t),t="");var h=parser.parse(e),g=0;if(h.method=u,i["X-Powered-By"]="total.js"+VERSION,o){var v="";for(var y in o)v+=(v?"; ":"")+y+"="+encodeURIComponent(o[y]);v&&(i.Cookie=v)}var w;t.length&&(w=new Buffer(t,ENCODING),i["Content-Length"]=w.length),h.agent=!1,h.headers=i;var b=function(e){e._bufferlength=0,e.on("data",function(e){var r=this;r._bufferlength+=e.length,f.emit("data",e,g?r._bufferlength/g*100:0)}),e.on("end",function(){var e=this;f.emit("end",e.statusCode,e.headers)}),n(null,e),e.resume()},E="https:"===h.protocol?https:http,k=function(){try{var e=m?E.request(h,b):E.request(h,b);n&&(e.on("error",function(e){n(e,null,0,{})}),e.setTimeout(a||1e4,function(){n(new Error(exports.httpStatus(408)),null,0,null)})),e.on("response",function(e){g=+e.headers["content-length"]||0,f.emit("begin",g)}),m&&w?e.end(w):e.end()}catch(r){n&&n(r,null,0,{})}};return p?exports.resolve(e,function(e,r){h.host=r.host,k()}):k(),f},exports.$$download=function(e,r,t,n,o,i,s){return function(a){exports.download(e,r,t,a,n,o,i,s)}},exports.send=function(e,r,t,n,o,i){if(typeof n===OBJECT){var s=o;n=o,o=s}typeof r===STRING&&(r=fs.createReadStream(r,{flags:"r"}));var a="----"+Math.random().toString(16).substring(2),u={};o&&exports.extend(u,o),e=path.basename(e),u["Cache-Control"]="max-age=0",u["Content-Type"]="multipart/form-data; boundary="+a,u["X-Powered-By"]="total.js"+VERSION;var c=parser.parse(t),l={protocol:c.protocol,auth:c.auth,method:i||"POST",hostname:c.hostname,port:c.port,path:c.path,agent:!1,headers:u},f=function(e){n&&(e.body="",e.on("data",function(e){this.body+=e.toString(ENCODING)}),e.on("end",function(){var e=this;n&&n(null,e.body,e.statusCode,e.headers)}))},p="https:"===l.protocol?https:http,d=p.request(l,f);n&&d.on("error",function(e){n&&n(e,null,0,null),n=null});var m=NEWLINE+NEWLINE+"--"+a+NEWLINE+'Content-Disposition: form-data; name="File"; filename="'+e+'"'+NEWLINE+"Content-Type: "+exports.getContentType(exports.getExtension(e))+NEWLINE+NEWLINE;return d.write(m),typeof r.length===NUMBER?void d.end(r.toString("utf8")+NEWLINE+NEWLINE+"--"+a+"--"):(r.on("end",function(){d.end(NEWLINE+NEWLINE+"--"+a+"--")}),void r.pipe(d,{end:!1}))},exports.$$send=function(e,r,t,n,o){return function(i){exports.send(e,r,t,i,n,o)}},exports.trim=function(e){if(void 0===e||null===e)return e;var r=typeof e;if(r===STRING)return e.trim();if(e instanceof Array){for(var t=0,n=e.length;n>t;t++){var o=e[t];r=typeof o,r!==OBJECT?r===STRING&&(e[t]=o.trim()):exports.trim(o)}return e}return r!==OBJECT?e:(Object.keys(e).forEach(function(r){var t=e[r],n=typeof t;return n===OBJECT?void exports.trim(t):void(n===STRING&&(e[r]=t.trim()))}),e)},exports.noop=global.noop=global.NOOP=function(){},exports.httpStatus=function(e,r){return void 0===r&&(r=!0),(r?e+": ":"")+http.STATUS_CODES[e]},exports.extend=function(e,r,t){if(null===e||null===r)return e;if(typeof e!==OBJECT||typeof r!==OBJECT)return e;void 0===t&&(t=!0);for(var n=Object.keys(r),o=n.length;o--;){var i=n[o];(t||void 0===e[i])&&(e[i]=r[i])}return e},exports.copy=function(e,r){if(void 0===r)return exports.extend({},e,!0);if(null===r||null===e)return r;if(typeof r!==OBJECT||typeof e!==OBJECT)return r;for(var t=Object.keys(e),n=t.length;n--;){var o=t[n];void 0!==r[o]&&(r[o]=e[o])}return r},exports.reduce=function(e,r,t){if(!(r instanceof Array)&&typeof r===OBJECT)return exports.reduce(e,Object.keys(r),t);var n={};return Object.keys(e).forEach(function(o){t?-1===r.indexOf(o)&&(n[o]=e[o]):-1!==r.indexOf(o)&&(n[o]=e[o])}),n},exports.assign=function(e,r,t){if(null===e||void 0===e)return e;for(var n=r.split("."),o=e[n[0]],i=1;i<n.length-1;i++)o=o[n[i]];return o[n[n.length-1]]=typeof t===FUNCTION?t(o[n[n.length-1]]):t,e},exports.isRelative=function(e){return!("//"===e.substring(0,2)||-1!==e.indexOf("http://")||-1!==e.indexOf("https://"))},exports.streamer=function(e,r){var t="",n=e.length,o=0;return function(i){if(i){"string"!=typeof i&&(i=i.toString("utf8")),t+=i;var s=t.indexOf(e);if(-1!==s)for(;-1!==s;)if(r(t.substring(0,s+n),o++),t=t.substring(s+n),s=t.indexOf(e),-1===s)return}}},exports.encode=function(e){if(void 0===e)return"";var r=typeof e;return r!==STRING&&(e=e.toString()),e.encode()},exports.decode=function(e){if(void 0===e)return"";var r=typeof e;return r!==STRING&&(e=e.toString()),e.decode()},exports.isStaticFile=function(e){return regexpSTATIC.test(e)},exports.isNullOrEmpty=function(e){return typeof e!==STRING?!0:0===e.length},exports.parseInt=function(e,r){if(void 0===e||null===e)return r||0;var t=typeof e;return t===NUMBER?e:(t!==STRING?e.toString():e).parseInt()},exports.parseBool=exports.parseBoolean=function(e,r){if(void 0===e||null===e)return void 0===r?!1:r;var t=typeof e;if(t===BOOLEAN)return e;if(t===NUMBER)return e>0;var n=t!==STRING?e.toString():e;return n.parseBool(r)},exports.parseFloat=function(e,r){if(void 0===e||null===e)return r||0;var t=typeof e;if(t===NUMBER)return e;var n=t!==STRING?e.toString():e;return n.parseFloat(r)},exports.isArray=function(e){return e instanceof Array},exports.isRegExp=function(e){return e&&typeof e.test===FUNCTION?!0:!1},exports.isDate=function(e){return e&&typeof e.getTime===FUNCTION?!0:!1},exports.isError=function(e){return e&&e.stack?!0:!1},exports.isObject=function(e){try{return e&&Object.getPrototypeOf(e)===Object.prototype?!0:!1}catch(r){return!1}},exports.getContentType=function(e){return"."===e[0]&&(e=e.substring(1)),contentTypes[e.toLowerCase()]||"application/octet-stream"},exports.getExtension=function(e){var r=e.lastIndexOf(".");return-1===r?"":e.substring(r)},exports.getName=function(e){var r=e.length-1,t=e[r];("/"===t||"\\"===t)&&(e=e.substring(0,r));var n=e.lastIndexOf("/");return-1!==n?e.substring(n+1):(n=e.lastIndexOf("\\"),-1!==n?e.substring(n+1):e)},exports.setContentType=function(e,r){return"."===e[0]&&(e=e.substring(1)),contentTypes[e.toLowerCase()]=r,!0},exports.etag=function(e,r){for(var t=0,n=e.length,o=0;n>o;o++)t+=e.charCodeAt(o);return t.toString()+(r?":"+r:"")},exports.path=function(e,r){return e||(e=""),r=r||"/",e[e.length-1]===r?e:e+r},exports.join=function(){for(var e="",r=0;r<arguments.length-1;r++){var t=arguments[r];t&&("/"===t[0]&&(t=t.substring(1)),e+=exports.path(t))}var n=arguments[arguments.length-1];return"/"===n[0]&&(n=n.substring(1)),e+=n,("/"!==e[0]?"/":"")+e},exports.$normalize=function(e){return isWindows?e.replace(regexpPATH,"/"):e},exports.random=function(e,r){return e=e||1e5,r=r||0,Math.floor(Math.random()*(e-r+1))+r},exports.GUID=function(e){e=e||40;for(var r=function(){return Math.floor(65536*Math.random()).toString(16)},t="",n=0;e/4+1>n;n++)t+=r();return t.substring(0,e)},exports.validate=function(e,r,t,n,o,i,s,a){typeof n===FUNCTION&&void 0===o&&(o=n,n=null);var u=!1;void 0===s&&(u=!0,s={});var c,l=n,f=void 0===i?"":i+".",p=!1,d="",m=null;if(l instanceof builders.ErrorBuilder||(l=new builders.ErrorBuilder(o)),typeof r===STRING)if(c=void 0===s?builders.validation(r):void 0===s[r]?"":s[r].properties,0!==c.length)d=r,r=c,p=!0,m=void 0===s?builders.schema("default").collection:s,m||(m={});else{if(!u)return l;r=r.replace(/\s/g,"").split(",")}if((void 0===e||null===e)&&(e={}),typeof t!==FUNCTION)throw new Error("The validate function does not have any method to validate properties.\nYou must define the delegate: framework.onValidate ...");for(var h=0;h<r.length;h++){var g=r[h].toString(),v=e[g],y=typeof v;if(void 0!==v){if(y===FUNCTION&&(v=e[g]()),y!==OBJECT&&p&&builders.isJoin(s,g)&&(y=OBJECT),y===OBJECT&&!exports.isDate(v)&&p&&(c=s[d]))if(c=c.schema[g]||null,c===Date||c===String||c===Number||c===Boolean);else if(null!==c&&typeof c===STRING){var w="["===c[0];if(!w){exports.validate(v,c,t,l,o,f+g,s);continue}if(c=c.substring(1,c.length-1).trim(),!(v instanceof Array)){l.add(g,"@",f+g,a);continue}if(void 0===s[c]){var b=t(g,v,f+g,d,e);if(void 0===b)continue;if(y=typeof b,y===STRING){l.add(g,b,f+g,a);continue}if(y===BOOLEAN&&!b){l.add(g,"@",f+g,a);continue}b.isValid===!1&&l.add(g,b.error,f+g,a);continue}var E=t(g,v,f+g,d,e);if(void 0!==E){if(y=typeof E,y===STRING){l.add(g,E,f+g,a);continue}if(y===BOOLEAN&&!E){l.add(g,"@",f+g,a);continue}if(E.isValid===!1){l.add(g,E.error,f+g,a);continue}}for(var k=v.length,S=0;k>S;S++)exports.validate(v[S],c,t,l,o,f+g,s,S);continue}var _=t(g,v,f+g,d,e);void 0!==_&&(y=typeof _,y!==STRING?y!==BOOLEAN?_.isValid===!1&&l.add(g,_.error,f+g,a):_||l.add(g,"@",f+g,a):l.add(g,_,f+g,a))}else l.add(g,"@",f+g)}return l},exports.validate_builder=function(e,r,t,n,o,i,s){var a=n[t],u=a.onValidate||a.onValidation||framework.onValidate||framework.onValidation,c=void 0===o?"":o+".",l=a.properties;if((void 0===e||null===e)&&(e={}),typeof u!==FUNCTION)throw new Error("It's not defined onValidation delegate.");for(var f=0;f<l.length;f++){var p=l[f].toString();if(!s||-1!==s.indexOf(p)){var d=e[p],m=typeof d;if(void 0!==d){if(m===FUNCTION&&(d=e[p]()),m!==OBJECT&&builders.isJoin(n,p)&&(m=OBJECT),m===OBJECT&&!exports.isDate(d)&&(a=n[t]))if(a=a.schema[p]||null,a===Date||a===String||a===Number||a===Boolean);else if(null!==a&&typeof a===STRING){var h="["===a[0];if(!h){exports.validate_builder(d,r,t,n,c+p,i);continue}if(a=a.substring(1,a.length-1).trim(),!(d instanceof Array)){r.add(p,"@",c+p,i);continue}if(void 0===n[a]){var g=u(p,d,c+p,e,t);if(void 0===g)continue;if(m=typeof g,m===STRING){r.add(p,g,c+p,i);continue}if(m===BOOLEAN&&!g){r.add(p,"@",c+p,i);continue}g.isValid===!1&&r.add(p,g.error,c+p,i);continue}var v=u(p,d,c+p,e,t);if(void 0!==v){if(m=typeof v,m===STRING){r.add(p,v,c+p,i);continue}if(m===BOOLEAN&&!v){r.add(p,"@",c+p,i);continue}if(v.isValid===!1){r.add(p,v.error,c+p,i);continue}}for(var y=d.length,w=0;y>w;w++)exports.validate_builder(d[w],r,a,n,c+p,w);continue}var b=u(p,d,c+p,e,t);void 0!==b&&(m=typeof b,m!==STRING?m!==BOOLEAN?b.isValid===!1&&r.add(p,b.error,c+p,i):b||r.add(p,"@",c+p,i):r.add(p,b,c+p,i))}else r.add(p,"@",c+p)}}return r},exports.isValid=function(e,r){return{isValid:e,error:r||"@"}},exports.isEmail=function(e){return(e||"").toString().isEmail()},exports.isURL=function(e){return(e||"").toString().isURL()},exports.combine=function(){var e;if("~"===arguments[0][0]){arguments[0]=arguments[0].substring(1),e="";for(var r=0,t=arguments.length;t>r;r++){var n=arguments[r];n&&("/"===n[0]&&(n=n.substring(1)),e+=("/"!==e[e.length-1]?"/":"")+n)}return exports.$normalize(e)}e=framework.directory;for(var r=0,t=arguments.length;t>r;r++){var n=arguments[r];n&&("/"===n[0]&&(n=n.substring(1)),e+=("/"!==e[e.length-1]?"/":"")+n)}return exports.$normalize(e)},exports.removeDiacritics=function(e){for(var r="",t=0,n=e.length;n>t;t++){var o=e[t],i=o.charCodeAt(0),s=!1,a=DIACRITICS[i];void 0===a&&(i=o.toLowerCase().charCodeAt(0),a=DIACRITICS[i],s=!0),void 0!==a?(o=a,s&&(o=o.toUpperCase()),r+=o):r+=o}return r},exports.parseXML=function(e){for(var r=-1,t=0,n=0,o=[],i={},s=-1;;){if(r=e.indexOf("<",r+1),-1===r)break;if(t=e.indexOf(">",r+1),-1===t)break;var a=e.substring(r,t+1),u=a[1];if("?"!==u&&"/"!==u){n=a.indexOf(" ");var c=!0;-1===n&&(n=a.length-1,c=!1),s=r+a.length;var l="/"===a[a.length-2],f=a.substring(1,n);if(l||o.push(f),c){var p=a.match(/\w+\=\".*?\"/g);if(null!==p){for(var d={},m=p.length,h=0;m>h;h++){var g=p[h].indexOf('"');d[p[h].substring(0,g-1)]=p[h].substring(g+1,p[h].length-1).decode()}i[o.join(".")+(l?"."+f:"")+"[]"]=d}}}else{var v=o.pop();if(-1===s||v!==a.substring(2,a.length-1))continue;var y=(o.length?o.join(".")+".":"")+v,w=e.substring(s,r).decode();void 0===i[y]?i[y]=w:i[y]instanceof Array?i[y].push(w):i[y]=[i[y],w],s=-1}}return i},exports.parseJSON=function(e){try{return JSON.parse(e)}catch(r){return null}},exports.parseQuery=function(e){return framework.onParseQuery(e)},exports.getWebSocketFrame=function(e,r,t){var n=getWebSocketFrameMessageBytes(e,r),o=n.length,i=getWebSocketFrameLengthBytes(o),s=new Buffer(1+i.length+o);return s[0]=128|t,i.copy(s,1,0,i.length),n.copy(s,i.length+1,0,o),s},exports.distance=function(e,r,t,n){var o=6371,i=(t-e).toRad(),s=(n-r).toRad(),a=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e.toRad())*Math.cos(t.toRad())*Math.sin(s/2)*Math.sin(s/2),u=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return(o*u).floor(3)},exports.ls=function(e,r,t){var n=new FileList;n.onComplete=r,n.onFilter=t||null,n.walk(e)},Date.prototype.add=function(e,r){if(void 0===r){var t=e.split(" ");e=t[1],r=exports.parseInt(t[0])}var n=this,o=new Date(n.getTime());switch(e){case"s":case"ss":case"sec":case"second":case"seconds":return o.setSeconds(o.getSeconds()+r),o;case"m":case"mm":case"minute":case"min":case"minutes":return o.setMinutes(o.getMinutes()+r),o;case"h":case"hh":case"hour":case"hours":return o.setHours(o.getHours()+r),o;case"d":case"dd":case"day":case"days":return o.setDate(o.getDate()+r),o;case"w":case"ww":case"week":case"weeks":return o.setDate(o.getDate()+7*r),o;case"M":case"MM":case"month":case"months":return o.setMonth(o.getMonth()+r),o;case"y":case"yyyy":case"year":case"years":return o.setFullYear(o.getFullYear()+r),o}return o},Date.prototype.diff=function(e,r){if(1===arguments.length)r=e,e=Date.now();else{var t=typeof e;t===STRING?e=Date.parse(e):exports.isDate(e)&&(e=e.getTime())}var n=this.getTime()-e;switch(r){case"s":case"ss":case"second":case"seconds":return n=Math.ceil(n/1e3),0===n?n.toString().parseInt():n;case"m":case"mm":case"minute":case"minutes":return n=Math.ceil(n/1e3/60),0===n?n.toString().parseInt():n;case"h":case"hh":case"hour":case"hours":return n=Math.ceil(n/1e3/60/60),
0===n?n.toString().parseInt():n;case"d":case"dd":case"day":case"days":return n=Math.ceil(n/1e3/60/60/24),0===n?n.toString().parseInt():n;case"M":case"MM":case"month":case"months":return n=Math.ceil(n/1e3/60/60/672),0===n?n.toString().parseInt():n;case"y":case"yyyy":case"year":case"years":return n=Math.ceil(n/1e3/60/60/8064),0===n?n.toString().parseInt():n}return NaN},Date.prototype.extend=function(e){var r=new Date(this),t=e.match(regexpDATE);if(!t)return r;for(var n=0,o=t.length;o>n;n++){var i,s,a=t[n];-1===a.indexOf(":")?-1===a.indexOf("-")?-1===a.indexOf(".")||(i=a.split("."),s=+i[0],r.setDate(s),i[1]&&(s=+i[1],isNaN(s)||r.setMonth(s-1)),i[2]&&(s=+i[2],isNaN(s)||r.setFullYear(s))):(i=a.split("-"),s=+i[0],r.setFullYear(s),i[1]&&(s=+i[1],isNaN(s)||r.setMonth(s-1)),i[2]&&(s=+i[2],isNaN(s)||r.setDate(s))):(i=a.split(":"),s=+i[0],isNaN(s)||r.setHours(s),i[1]&&(s=+i[1],isNaN(s)||r.setMinutes(s)),i[2]&&(s=+i[2],isNaN(s)||r.setSeconds(s)))}return r},Date.prototype.compare=function(e){var r=this,t=r.getTime()-e.getTime();return 0===t?0:0>t?-1:1},Date.compare=function(e,r){return typeof e===STRING&&(e=e.parseDate()),typeof r===STRING&&(r=r.parseDate()),e.compare(r)},Date.prototype.format=function(e){var r=this,t=!1;if(e&&"!"===e[0]&&(t=!0,e=e.substring(1)),void 0===e||null===e||""===e)return r.getFullYear()+"-"+(r.getMonth()+1).toString().padLeft(2,"0")+"-"+r.getDate().toString().padLeft(2,"0")+"T"+r.getHours().toString().padLeft(2,"0")+":"+r.getMinutes().toString().padLeft(2,"0")+":"+r.getSeconds().toString().padLeft(2,"0")+"."+r.getMilliseconds().toString().padLeft(3,"0")+"Z";var n=r.getHours();return t&&n>=12&&(n-=12),e.replace(regexpDATEFORMAT,function(e){switch(e){case"yyyy":return r.getFullYear();case"yy":return r.getYear();case"MM":return(r.getMonth()+1).toString().padLeft(2,"0");case"M":return r.getMonth()+1;case"dd":return r.getDate().toString().padLeft(2,"0");case"d":return r.getDate();case"HH":case"hh":return n.toString().padLeft(2,"0");case"H":case"h":return r.getHours();case"mm":return r.getMinutes().toString().padLeft(2,"0");case"m":return r.getMinutes();case"ss":return r.getSeconds().toString().padLeft(2,"0");case"s":return r.getSeconds();case"w":case"ww":var t=new Date(+r);return t.setHours(0,0,0),t.setDate(t.getDate()+4-(t.getDay()||7)),t=Math.ceil(((t-new Date(t.getFullYear(),0,1))/864e5+1)/7),"ww"===e?t.toString().padLeft(2,"0"):t;case"a":var o="AM";return r.getHours()>=12&&(o="PM"),o}})},Date.prototype.toUTC=function(e){var r=this.getTime()+6e4*this.getTimezoneOffset();return e?r:new Date(r)},String.prototype.trim||(String.prototype.trim=function(){return this.replace(regexpTRIM,"")}),String.prototype.replaceAt||(String.prototype.replaceAt=function(e,r){var t=this;return t.substr(0,e)+r+t.substr(e+r.length)}),String.prototype.startsWith=function(e,r){var t,n=this,o=e.length;return r===!0?(t=n.substring(0,o),t.length===o&&t.toLowerCase()===e.toLowerCase()):(t=r?n.substr(r,o):n.substring(0,o),t.length===o&&t===e)},String.prototype.endsWith=function(e,r){var t,n=this,o=e.length;return r===!0?(t=n.substring(n.length-o),t.length===o&&t.toLowerCase()===e.toLowerCase()):(t=r>0?n.substr(n.length-r-o,o):n.substring(n.length-o),t.length===o&&t===e)},String.prototype.replacer=function(e,r){var t=this,n=t.indexOf(e);return-1===n?t:t.substring(0,n)+r+t.substring(n+e.length)},String.prototype.hash=function(e,r){var t=this;switch(r&&(t+=r),(e||"").toLowerCase()){case"md5":return t.md5();case"sha1":return t.sha1();case"sha256":return t.sha256();case"sha512":return t.sha512();default:return string_hash(t)}},String.prototype.count=function(e){var r=0,t=0;do r=this.indexOf(e,r+e.length),r>0&&t++;while(r>0);return t},String.prototype.parseXML=function(){return framework.onParseXML(this)},String.prototype.parseJSON=function(){return exports.parseJSON(this)},String.prototype.parseQuery=function(){return exports.parseQuery(this)},String.prototype.parseDate=function(){var e=this.trim(),r=e.charCodeAt(e.length-1);if(41===r)return new Date(e);if(90===r)return new Date(Date.parse(e));var t=-1===e.indexOf(" ")?e.split("T"):e.split(" "),n=t[0].indexOf(":"),o=t[0].length;if(-1!==n){var i=t[1];t[1]=t[0],t[0]=i}void 0===t[0]&&(t[0]="");for(var s=void 0===t[1]?!0:0===t[1].length,a=0;o>a;a++){var u=t[0].charCodeAt(a);if(!(u>47&&58>u)&&45!==u&&46!==u&&s)return new Date(e)}void 0===t[1]&&(t[1]="00:00:00");var c=-1===t[0].indexOf("-"),l=(t[0]||"").split(c?".":"-"),f=(t[1]||"").split(":"),p=[];if(l.length<4&&f.length<2)return new Date(e);n=(f[2]||"").indexOf("."),-1!==n?(f[3]=f[2].substring(n+1),f[2]=f[2].substring(0,n)):f[3]="0",p.push(+l[c?2:0]),p.push(+l[1]),p.push(+l[c?0:2]),p.push(+f[0]),p.push(+f[1]),p.push(+f[2]),p.push(+f[3]);for(var d=new Date,a=0,o=p.length;o>a;a++){isNaN(p[a])&&(p[a]=0);var m=p[a];if(0===m)switch(a){case 0:0>=m&&(p[a]=d.getFullYear());break;case 1:0>=m&&(p[a]=d.getMonth()+1);break;case 2:0>=m&&(p[a]=d.getDate())}}return new Date(p[0],p[1]-1,p[2],p[3],p[4],p[5])},String.prototype.parseDateExpiration=function(){for(var e=this,r=e.split(" "),t=new Date,n=r.length,o=0;n>o;o+=2){var i=r[o].parseInt();if(0!==i){var s=r[o+1]||"";""!==s&&(t=t.add(s,i))}}return t},String.prototype.contains=function(e,r){var t=this;if(typeof e===STRING)return-1!==t.indexOf(e,typeof r===NUMBER?r:0);for(var n=e.length,o=0;n>o;o++){var i=-1!==t.indexOf(e[o]);if(r){if(!i)return!1}else if(i)return!0}return r},String.prototype.configuration=function(e){return console.log("OBSOLETE: String.configuration() -> use String.parseConfig([default])"),this.parseConfig(e)},String.prototype.parseConfig=function(e){for(var r=this.split("\n"),t=r.length,n=exports.extend({},e),o=0;t>o;o++){var i=r[o];if(""!==i&&"#"!==i[0]&&"//"!==i.substring(0,2)){var s=i.indexOf(" :");(-1!==s||(s=i.indexOf("	:"),-1!==s))&&(n[i.substring(0,s).trim()]=i.substring(s+2).trim())}}return n},String.prototype.format=function(){var e=arguments;return this.replace(regexpSTRINGFORMAT,function(r){var t=e[+r.substring(1,r.length-1)];return(null===t||void 0===t)&&(t=""),t})},String.prototype.encode=function(){for(var e="",r=0,t=this.length;t>r;r++){var n=this[r];switch(n){case"<":e+="&lt;";break;case">":e+="&gt;";break;case'"':e+="&quot;";break;case"'":e+="&apos;";break;case"&":e+="&amp;";break;default:e+=n}}return e},String.prototype.decode=function(){return this.replace(/&gt;/g,">").replace(/\&lt;/g,"<").replace(/\&quot;/g,'"').replace(/&apos;/g,"'").replace(/&amp;/g,"&")},String.prototype.urlEncode=function(){return encodeURIComponent(this)},String.prototype.urlDecode=function(){return decodeURIComponent(this)},String.prototype.params=function(e){var r=this;if(void 0===e||null===e)return r;var t=/\{{2}[^}\n]*\}{2}/g;return r.replace(t,function(r){var t=!1,n=r.substring(2,r.length-2).trim(),o="",i=n.indexOf("|");-1!==i&&(o=n.substring(i+1,n.length).trim(),n=n.substring(0,i).trim()),"!"===n[0]?n=n.substring(1):t=!0;var s;if(-1!==n.indexOf(".")){var a=n.split(".");2===a.length?e[a[0]]&&(s=e[a[0]][a[1]]):3===a.length?e[a[0]]&&e[a[0]][a[1]]&&(s=e[a[0]][a[1]][a[2]]):4===a.length&&(e[a[0]]&&e[a[0]][a[1]]&&e[a[0]][a[1]][a[2]]?s=e[a[0]][a[1]][a[2]][a[3]]:5===a.length&&e[a[0]]&&e[a[0]][a[1]]&&e[a[0]][a[1]][a[2]]&&e[a[0]][a[1]][a[2]][a[3]]&&(s=e[a[0]][a[1]][a[2]][a[3]][a[4]]))}else s=0===n.length?e:e[n];if(typeof s===FUNCTION&&(s=s(i)),void 0===s)return r;if(o.length){var u=typeof s;if(u===STRING){var c=+o;isNaN(c)||(s=s.max(c+3,"..."))}else(u===NUMBER||exports.isDate(s))&&(o.isNumber()&&(o=+o),s=s.format(o))}return s=s.toString().dollar(),t?exports.encode(s):s})},String.prototype.max=function(e,r){var t=this;return typeof r!==STRING&&(r="..."),t.length>e?t.substring(0,e-r.length)+r:t},String.prototype.isJSON=function(){var e=this;if(e.length<=1)return!1;for(var r,t,n=e.length-1,o=0;;)if(r=e[o++]," "!==r&&"\n"!==r&&"\r"!==r&&"	"!==r)break;for(;;)if(t=e[n--]," "!==r&&"\n"!==r&&"\r"!==r&&"	"!==r)break;return'"'===r&&'"'===t||"["===r&&"]"===t||"{"===r&&"}"===t},String.prototype.isURL=function(){var e=this;return e.length<=7?!1:regexpUrl.test(e)},String.prototype.isEmail=function(){var e=this;return e.length<=4?!1:regexpMail.test(e)},String.prototype.parseInt=function(e){var r=this.trim(),t=+r;return isNaN(t)?e||0:t},String.prototype.parseBool=String.prototype.parseBoolean=function(){var e=this.toLowerCase();return"true"===e||"1"===e||"on"===e},String.prototype.parseFloat=function(e){var r=this.trim();-1!==r.indexOf(",")&&(r=r.replace(",","."));var t=+r;return isNaN(t)?e||0:t},String.prototype.toUnicode=function(){for(var e="",r=this,t=r.length,n=0;t>n;++n)e+=r.charCodeAt(n)>126||r.charCodeAt(n)<32?"\\u"+r.charCodeAt(n).hex(4):r[n];return e},String.prototype.fromUnicode=function(){var e=this.replace(/\\u([\d\w]{4})/gi,function(e,r){return String.fromCharCode(parseInt(r,16))});return unescape(e)},String.prototype.sha1=function(e){var r=crypto.createHash("sha1");return r.update(this+(e||""),ENCODING),r.digest("hex")},String.prototype.sha256=function(e){var r=crypto.createHash("sha256");return r.update(this+(e||""),ENCODING),r.digest("hex")},String.prototype.sha512=function(e){var r=crypto.createHash("sha512");return r.update(this+(e||""),ENCODING),r.digest("hex")},String.prototype.md5=function(e){var r=crypto.createHash("md5");return r.update(this+(e||""),ENCODING),r.digest("hex")},String.prototype.toSearch=function(){return this.replace(/[^a-zA-ZÃ¡-Å¾Ã-Å½\d\s:]/g,"").trim().replace(/\s{2,}/g," ").toLowerCase().removeDiacritics().replace(/y/g,"i")},String.prototype.toKeywords=String.prototype.keywords=function(e,r,t,n,o){return exports.keywords(this,e,r,t,n,o)},String.prototype.encrypt=function(e,r){var t="0"+this,n=t.length,o=e.length,i=r?exports.random(120)+40:65,s=n+i%o,a=[],u=0;a[0]=String.fromCharCode(i);for(var c=this.length+e.length,l=s-1;l>0;l--)u=t.charCodeAt(l%n),a[l]=String.fromCharCode(u^(e.charCodeAt(l%o)^i));var f=new Buffer(c+"="+a.join(""),ENCODING).toString("base64").replace(/\//g,"-").replace(/\+/g,"_");return u=f.indexOf("="),u>0?f.substring(0,u):f},String.prototype.decrypt=function(e){var r=this.replace(/\-/g,"/").replace(/\_/g,"+"),t=r.length%4;if(t>0)for(var n=0;t>n;n++)r+="=";r=new Buffer(r,"base64").toString(ENCODING);var o=r.indexOf("=");if(-1===o)return null;var i=+r.substring(0,o);if(isNaN(i))return null;r=r.substring(o+1);for(var s=r.length,a=r.charCodeAt(0),u=e.length,c=s-a%u,l=[],n=c-1;n>0;n--)o=r.charCodeAt(n)^(a^e.charCodeAt(n%u)),l[n]=String.fromCharCode(o);var f=l.join("");return i!==f.length+e.length?null:f},String.prototype.base64ToFile=function(e,r){var t=this,n=t.indexOf(",");return-1===n?n=0:n++,r?fs.writeFile(e,t.substring(n),"base64",r):fs.writeFile(e,t.substring(n),"base64",exports.noop),this},String.prototype.base64ToBuffer=function(){var e=this,r=e.indexOf(",");return-1===r?r=0:r++,new Buffer(e.substring(r),"base64")},String.prototype.base64ContentType=function(){var e=this,r=e.indexOf(";");return-1===r?"":e.substring(5,r)},String.prototype.removeDiacritics=function(){return exports.removeDiacritics(this)},String.prototype.indent=function(e,r){var t="";for(void 0===r&&(r=" ");e--;)t+=r;return t+this},String.prototype.isNumber=function(e){var r=this,t=r.length;if(0===t)return!1;e=e||!1;for(var n=0;t>n;n++){var o=r.charCodeAt(n);if(!e||44!==o&&46!==o){if(48>o||o>57)return!1}else e=!1}return!0},String.prototype.padLeft||(String.prototype.padLeft=function(e,r){var t=this,n=e-t.length;if(0>n)return t;for(void 0===r&&(r=" ");n--;)t=r+t;return t}),String.prototype.padRight||(String.prototype.padRight=function(e,r){var t=this,n=e-t.length;if(0>n)return t;for(void 0===r&&(r=" ");n--;)t+=r;return t}),String.prototype.insert=function(e,r){var t=this,n=t.substring(0,e),o=r.toString()+t.substring(e);return n+o},String.prototype.dollar=function(){for(var e=this,r=e.indexOf("$",0);-1!==r;)"$"===e[r+1]&&(e=e.insert(r,"$")),r=e.indexOf("$",r+2);return e.toString()},String.prototype.slug=String.prototype.toSlug=String.prototype.toLinker=String.prototype.linker=function(e){e=e||60;for(var r=this.trim().toLowerCase().removeDiacritics(),t="",n=r.length,o=0;n>o;o++){var i=r[o],s=r.charCodeAt(o);if(t.length>=e)break;if(s>31&&48>s){if("-"===t[t.length-1])continue;t+="-"}else s>47&&58>s?t+=i:s>94&&123>s&&(t+=i)}var a=t.length-1;return"-"===t[a]?t.substring(0,a):t},String.prototype.link=function(e){return console.log("String.prototype.link: OBSOLETE - Use String.prototype.linker()"),this.linker(e)},String.prototype.pluralize=function(e,r,t,n){var o=this;return o.parseInt().pluralize(e,r,t,n)},String.prototype.isBoolean=function(){var e=this.toLowerCase();return"true"===e||"false"===e?!0:!1},String.prototype.capitalize=function(){return this[0].toUpperCase()+this.substring(1)},String.prototype.isAlphaNumeric=function(){var e=/^[A-Za-z0-9]+$/;return this.match(e)?!0:!1},String.prototype.soundex=function(){for(var e=this.toLowerCase().split(""),r=e.shift(),t=r.toUpperCase(),n=0,o=e.length;o>n;n++){var i=SOUNDEX[e[n]];void 0!==i&&(n?i!==e[n-1]&&(t+=i):i!==SOUNDEX[r]&&(t+=i))}return(t+"000").substring(0,4)},Number.prototype.floor=function(e){return Math.floor(this*Math.pow(10,e))/Math.pow(10,e)},Number.prototype.padLeft=function(e,r){return this.toString().padLeft(e,r||"0")},Number.prototype.padRight=function(e,r){return this.toString().padRight(e,r||"0")},Number.prototype.format=function(e,r,t){var n=this;if(typeof e===STRING)return n.format2(e);var o=n.toString(),i="",s="",a="-"===o[0]?"-":"";a&&(o=o.substring(1));var u=o.indexOf(".");if(typeof e===STRING){var c=r;r=e,e=c}void 0===r&&(r=" "),-1!==u&&(i=o.substring(u+1),o=o.substring(0,u)),u=-1;for(var l=o.length-1;l>=0;l--)u++,u>0&&u%3===0&&(s=r+s),s=o[l]+s;return(e||i.length)&&(i=i.length>e?i.substring(0,e):i.padRight(e,"0")),i.length&&void 0===t&&(t="."===r?",":"."),a+s+(i.length?t+i:"")},Number.prototype.add=function(e,r){if(void 0===e||null===e)return this;if(typeof e===NUMBER)return this+e;var t=e.charCodeAt(0),n=!1;(48>t||t>57)&&(n=!0,e=e.substring(1));var o,i=e.length,s=!1;if("%"===e[i-1]){if(e=e.substring(0,i-1),s=!0,n){var a=e.parseFloat()/100+1;switch(t){case 42:o=this*(this*a);break;case 43:o=this*a;break;case 45:o=this/a;break;case 47:o=this/(this/a)}return void 0!==r?o.floor(r):o}return o=this/100*e.parseFloat(),void 0!==r?o.floor(r):o}switch(o=e.parseFloat(),t){case 42:o=this*o;break;case 43:o=this+o;break;case 45:o=this-o;break;case 47:o=this/o;break;case 47:o=this/o;break;default:o=this}return void 0!==r?o.floor(r):o},Number.prototype.format2=function(e){var r=0,t=this.toString(),n=0,o=0,i=0,s="",a=0;if(typeof e===STRING){var u=!1;a=e.length;for(var c=0;a>c;c++){var l=e[c];"#"===l&&(u?o++:n++),"."===l&&(u=!0)}var f=t,p="";if(r=t.indexOf("."),-1!==r&&(f=t.substring(0,r),p=t.substring(r+1)),f.length>n){i=f.length-n;for(var d="",c=0;i>c;c++)d+="#";e=d+e}f.length<n&&(f=f.padLeft(n," ")),p.length<o&&(p=p.padRight(o,"0")),p.length>o&&(p=p.substring(0,o)),u=!1,r=0;var m=!0;a=e.length;for(var c=0;a>c;c++){var l=e[c];if("#"===l){var h=u?p[r]:f[r];m&&(m=-1!==[","," "].indexOf(h)),m||(s+=h),r++}else{if(m)continue;"."===l&&(u=!0,r=0),s+=l}}return s}if(s="### ### ###",n=t.indexOf("."),i=e||0,0===i&&-1!==n&&(i=t.length-(n+1)),i>0){s+=".";for(var c=0;i>c;c++)s+="#"}return this.format(s)},Number.prototype.pluralize=function(e,r,t,n){var o=this,i="";i=0==o?e||"":1==o?r||"":o>1&&5>o?t||"":n;var s=i.indexOf("#");if(-1===s)return i;var a=i.lastIndexOf("#"),u=i.substring(s,a+1);return o.format(u)+i.replace(u,"")},Number.prototype.hex=function(e){for(var r=this.toString(16).toUpperCase();r.length<e;)r="0"+r;return r},Number.prototype.VAT=function(e,r,t){var n=this,o=typeof r;if(o===BOOLEAN){var i=t;t=r,r=i,o=typeof r}return o===UNDEFINED&&(r=2),void 0===t&&(t=!0),0===e||0===n?n:t?(n/(e/100+1)).floor(r):(n*(e/100+1)).floor(r)},Number.prototype.discount=function(e,r){var t=this;return void 0===r&&(r=2),(t-t/100*e).floor(r)},Number.prototype.parseDate=function(e){return new Date(this+(e||0))},typeof Number.prototype.toRad===UNDEFINED&&(Number.prototype.toRad=function(){return this*Math.PI/180}),Array.prototype.take=function(e){for(var r=[],t=this,n=t.length,o=0;n>o;o++)if(r.push(t[o]),r.length>=e)return r;return r},Array.prototype.extend=function(e,r){for(var t=typeof e===FUNCTION,n=0,o=this.length;o>n;n++)t?this[n]=e(this[n],n):this[n]=exports.extend(this[n],e,r);return this},Array.prototype.first=function(e){var r=this[0];return void 0===r?e:r},Array.prototype.toObject=function(e){for(var r=this,t={},n=0,o=r.length;o>n;n++){var i=r[n];e?t[i[e]]=i:t[i]=!0}return t},Array.prototype.compare=function(e,r,t){for(var n=this,o={},i={},s=n.length,a=r.length,u=Math.max(s,a),c={},l=0;u>l;l++){var f=n[l];f&&(o[f[e]]=l);var p=r[l];p&&(i[p[e]]=l)}for(var d=-1,l=0;u>l;l++){var m,h,f=n[l],p=r[l];if(f){if(m=f[e],c[m])continue;c[m]=!0,d=i[m],void 0===d?t(f,void 0,l,-1):t(f,r[d],l,d)}if(p){if(h=p[e],c[h])continue;c[h]=!0,d=o[h],void 0===d?t(void 0,p,-1,l):t(n[d],p,d,l)}}},Array.prototype.pair=function(e,r,t,n){if(e instanceof Array){var o=e;e=r,r=o}r||(r=new Array(0));for(var i=r.length,s=0;;){var a=this[s++];if(!a)break;for(var u=!1,c=0;i>c;c++)if(a[e]===r[c][e]){t(a,r[c]),u=!0;break}!u&&n&&(s--,this.splice(s,1))}return this},Array.prototype.last=function(e){var r=this[this.length-1];return void 0===r?e:r},Array.prototype.orderBy=function(e,r){if(typeof e===BOOLEAN){var t=r;r=e,e=t}void 0===r&&(r=!0);var n=this,o=0,i=(e||"").split("."),s=i.length;return n.sort(function(e,t){var n=null,a=null;switch(s){case 1:""===i[0]?(n=e,a=t):(n=e[i[0]],a=t[i[0]]);break;case 2:n=e[i[0]][i[1]],a=t[i[0]][i[1]];break;case 3:n=e[i[0]][i[1]][i[2]],a=t[i[0]][i[1]][i[2]];break;case 4:n=e[i[0]][i[1]][i[2]][i[3]],a=t[i[0]][i[1]][i[2]][i[3]];break;case 5:n=e[i[0]][i[1]][i[2]][i[3]][i[4]],a=t[i[0]][i[1]][i[2]][i[3]][i[4]];break;default:return 0}if(0===o){var u=typeof n;o=u===STRING?1:u===NUMBER?2:u===BOOLEAN?3:4}return 1===o?r?n.removeDiacritics().localeCompare(a.removeDiacritics()):a.removeDiacritics().localeCompare(n.removeDiacritics()):2===o?n>a?r?1:-1:a>n?r?-1:1:0:3===o?n===!0&&a===!1?r?1:-1:n===!1&&a===!0?r?-1:1:0:0}),n},Array.prototype.trim=function(){for(var e=this,r=[],t=0,n=e.length;n>t;t++)typeof e[t]===STRING&&(e[t]=e[t].trim()),e[t]&&r.push(e[t]);return r},Array.prototype.skip=function(e){for(var r=[],t=this,n=t.length,o=0;n>o;o++)o>=e&&r.push(t[o]);return r},Array.prototype.where=function(e,r){for(var t=this,n=[],o="function"==typeof e,i=void 0!==r,s=0,a=t.length;a>s;s++)o?e.call(t,t[s],s)&&n.push(t[s]):i?t[s][e]===r&&n.push(t[s]):t[s]===e&&n.push(t[s]);return n},Array.prototype.find=function(e,r){var t=this,n=t.findIndex(e,r);return-1===n?null:t[n]},Array.prototype.findIndex=function(e,r){for(var t=this,n=typeof e===FUNCTION,o=void 0!==r,i=0,s=t.length;s>i;i++)if(n){if(e.call(t,t[i],i))return i}else if(o){if(t[i][e]===r)return i}else if(t[i]===e)return i;return-1},Array.prototype.remove=function(e,r){for(var t=this,n=[],o="function"==typeof e,i=void 0!==r,s=0,a=t.length;a>s;s++)o?e.call(t,t[s],s)||n.push(t[s]):i?t[s][e]!==r&&n.push(t[s]):t[s]!==e&&n.push(t[s]);return n},Array.prototype.random=function(){var e=this;return e[exports.random(e.length-1)]},Array.prototype.wait=Array.prototype.waitFor=function(e,r,t){var n=this,o=typeof r;if(o===NUMBER||o===BOOLEAN){var i=t;t=r,r=i}void 0===t&&(t=0);var s=t===!0?n.shift():n[t];return void 0===s?(r&&r(),n):(e.call(n,s,function(){setImmediate(function(){typeof t===NUMBER&&t++,n.wait(e,r,t)})}),n)},Array.prototype.async=function(e){var r=this,t=r.shift();return void 0===t?(e&&e(),r):(t(function(){setImmediate(function(){r.async(e)})}),r)},Array.prototype._async_middleware=function(e,r,t){var n=this;if(e.success||e.headersSent)return e.$middleware=null,n.length=0,t&&t.subscribe.success(),r=null,n;var o=n.shift();if(!o)return r&&r(),n;e.$middleware=function(){n._async_middleware(e,r)};var i=o(function(t){return t?(e.$middleware=!1,e.throw500(t),r=null,void(n.length=0)):void setImmediate(e.$middleware)});return i!==!1?n:(e.$middleware=null,r=null,n.length=0,n)},Array.prototype.randomize=function(){var e=this,r=(10*Math.floor(1e8*Math.random())).toString(),t=0,n=0;return e.sort(function(e,o){var i=r[t++];return void 0===i&&(i=r[0],t=0),n>i?(n=i,-1):n===i?(n=i,0):(n=i,1)}),e},Array.prototype.limit=function(e,r,t,n){void 0===n&&(n=0);for(var o=[],i=this,s=n+e,a=n;s>a;a++){var u=i[a];{if(void 0===u)return 0===o.length?(t&&t(),i):(r(o,function(){t&&t()},n,n+e),i);o.push(u)}}return 0===o.length?(t&&t(),i):(r(o,function(){return s<i.length?void i.limit(e,r,t,s):void(t&&t())},n,n+e),i)},Array.prototype.unique=function(e){for(var r=this,t=[],n=0,o=0,i=r.length;i>o;o++){var s=r[o];if(e)if(0!==n){for(var a=!0,u=0;n>u;u++)if(t[u][e]===s[e]){a=!1;break}a&&(t.push(s),n++)}else t.push(s),n++;else-1===t.indexOf(s)&&t.push(s)}return t},AsyncTask.prototype.run=function(){var e=this;try{if(e.isCanceled)return e.complete(),e;e.isRunning=1,e.owner.tasksWaiting[e.name]=!0,e.owner.emit("begin",e.name);var r=e.owner.tasksTimeout[e.name];r>0&&(e.interval=setTimeout(function(){e.timeout()},r)),e.fn(function(){setImmediate(function(){e.complete()})})}catch(t){e.owner.emit("error",e.name,t),e.complete()}return e},AsyncTask.prototype.timeout=function(e){var r=this;return e>0?(clearTimeout(r.interval),setTimeout(function(){r.timeout()},e),r):0>=e?(clearTimeout(r.interval),setTimeout(function(){r.timeout()},e),r):(setImmediate(function(){r.cancel(!0)}),r)},AsyncTask.prototype.cancel=function(e){var r=this;return r.isCanceled=!0,e?r.owner.emit("timeout",r.name):r.owner.emit("cancel",r.name),r.fn=null,r.cb=null,r.complete(),r},AsyncTask.prototype.complete=function(){var e=this,r=e.owner;if(e.isRunning=2,delete r.tasksPending[e.name],delete r.tasksWaiting[e.name],!e.isCanceled)try{r.emit("end",e.name),e.cb&&e.cb()}catch(t){r.emit("error",t,e.name)}return setImmediate(function(){r.reload(),r.refresh()}),r},Async.prototype={get count(){return this._count},get percentage(){var e=this,r=100-Math.floor(100*e._count/e._max);return r?r:0}},Async.prototype.__proto__=Object.create(events.EventEmitter.prototype,{constructor:{value:Async,enumberable:!1}}),Async.prototype.reload=function(){var e=this;return e.tasksAll=Object.keys(e.tasksPending),e.emit("percentage",e.percentage),e},Async.prototype.cancel=function(e){var r=this;if(void 0===e){r.isCanceled=!0;for(var t=0;t<r._count;t++)r.cancel(r.tasksAll[t]);return!0}var n=r.tasksPending[e];return n?(delete r.tasksPending[e],delete r.tasksWaiting[e],n.cancel(),n=null,r.reload(),r.refresh(),!0):!1},Async.prototype.await=function(e,r,t){var n=this;return n.isCanceled?!1:(typeof e===FUNCTION&&(t=r,r=e,e=exports.GUID(6)),void 0!==n.tasksPending[e]?!1:(n.tasksPending[e]=new AsyncTask(n,e,r,t,null),n._max++,n.reload(),n.refresh(),!0))},Async.prototype.wait=function(e,r,t,n){var o=this;return o.isCanceled?!1:(typeof r===FUNCTION&&(n=t,t=r,r=null),void 0!==o.tasksPending[e]?!1:(o.tasksPending[e]=new AsyncTask(o,e,t,n,r),o._max++,o.reload(),o.refresh(),!0))},Async.prototype.complete=function(e){return this.run(e)},Async.prototype.run=function(e){var r=this;return r._isRunning=!0,e&&r.onComplete.push(e),r.refresh(),r},Async.prototype.isRunning=function(e){var r=this;if(!e)return r._isRunning;var t=r.tasksPending[e];return t?1===t.isRunning:!1},Async.prototype.isWaiting=function(e){var r=this,t=r.tasksPending[e];return t?0===t.isRunning:!1},Async.prototype.isPending=function(e){var r=this,t=r.tasksPending[e];return t?!0:!1},Async.prototype.timeout=function(e,r){var t=this;return 0>=r||void 0===r?(delete t.tasksTimeout[e],t):(t.tasksTimeout[e]=r,t)},Async.prototype.refresh=function(e){var r=this;if(!r._isRunning||r._isEnd)return r;r._count=r.tasksAll.length;for(var t=0;;){var e=r.tasksAll[t++];if(void 0===e)break;var n=r.tasksPending[e];if(void 0===n)break;r.isCanceled||n.isCanceled?(delete r.tasksPending[e],delete r.tasksWaiting[e],r.tasksAll.splice(t,1),r._count=r.tasksAll.length,t--):0===n.isRunning&&(n.waiting&&r.tasksPending[n.waiting]||n.run())}if(0===r._count){r._isRunning=!1,r._isEnd=!0,r.emit("complete"),r.emit("percentage",100),r._max=0;var o=r.onComplete,i=o.length;r.onComplete=[];for(var s=0;i>s;s++)try{o[s]()}catch(a){r.emit("error",a)}setImmediate(function(){r._isEnd=!1})}return r},FileList.prototype.reset=function(){var e=this;e.file=[],e.directory=[],e.pendingDirectory=[]},FileList.prototype.walk=function(e){var r=this;if(e instanceof Array){for(var t=e.length,n=0;t>n;n++)r.pendingDirectory.push(e[n]);return void r.next()}fs.readdir(e,function(t,n){if(t)return r.next();for(var o=n.length,i=0;o>i;i++)r.pending.push(path.join(e,n[i]));r.next()})},FileList.prototype.stat=function(e){var r=this;fs.stat(e,function(t,n){return t?r.next():n.isDirectory()&&(null===r.onFilter||r.onFilter(e,!0))?(r.directory.push(e),r.pendingDirectory.push(e),void r.next()):((null===r.onFilter||r.onFilter(e,!1))&&r.file.push(e),void r.next())})},FileList.prototype.next=function(){var e=this;if(e.pending.length){var r=e.pending.shift();return void e.stat(r)}if(e.pendingDirectory.length){var t=e.pendingDirectory.shift();return void e.walk(t)}e.onComplete(e.file,e.directory)},exports.Async=Async,exports.sync=function(e,r){return function(){var t,n,o=[].slice.call(arguments),i=!1,s=r||this;return o.push(function(){t=arguments,!i&&n&&(i=!0,n.apply(s,t))}),e.apply(s,o),function(e){n=e,!i&&t&&(i=!0,n.apply(s,t))}}},exports.sync2=function(e,r){!function(){var t,n,o=!1,i=r||this,s=[].slice.call(arguments);return s.push(function(){t=arguments,!o&&n&&(o=!0,n.apply(i,t))}),e.apply(i,s),function(e){n=e,!o&&t&&(o=!0,n.apply(i,t))}}()},exports.async=function(e,r){var t=this;return function(n){function o(e,r){var t;try{var i=null===e||void 0===e;switch(i){case!0:t=u.next(r);break;case!1:t=u["throw"](e)}}catch(a){if(!n)return;return typeof n===OBJECT&&n.isController?void(a instanceof ErrorBuilder?n.content(a):n.view500(a)):void setImmediate(function(){n(a)})}if(t.done)return void(n&&typeof n!==OBJECT&&n(null,t.value));if(typeof t.value!==FUNCTION)return void o.call(s,null,t.value);try{t.value.call(s,function(){o.apply(s,arguments)})}catch(a){setImmediate(function(){o.call(s,a)})}}var i,s=this;if(arguments.length)if(r)i=arguments[1];else{i=[];for(var a=1;a<arguments.length;a++)i.push(arguments[a])}else i=new Array(0);var u=e.apply(t,i);return o(null),u.value}},exports.getMessageLength=function(e,r){var t=127&e[1];return 126===t?e.length<4?-1:converBytesToInt64([e[3],e[2],0,0,0,0,0,0],0,r):127===t?e.Length<10?-1:converBytesToInt64([e[9],e[8],e[7],e[6],e[5],e[4],e[3],e[2]],0,r):t},exports.queuecache={},exports.queue=function(e,r,t){if(!t)return!1;if(!r)return t(NOOP),!0;void 0===exports.queuecache[e]&&(exports.queuecache[e]={limit:r,running:0,pending:[]});var n=exports.queuecache[e];return n.running>=n.limit?(n.pending.push(t),!1):(n.running++,function(e){setImmediate(function(){t(function(){queue_next(e)})})}(e),!0)},exports.minifyStyle=function(e){return require("./internal").compile_css(e)},exports.minifyScript=function(e){return require("./internal").compile_javascript(e)},exports.minifyHTML=function(e){return require("./internal").compile_html(e)},global.Async=global.async=exports.async,global.sync=global.SYNCHRONIZE=exports.sync,global.sync2=exports.sync2,module}({exports:{}}),function(e){function r(e,r){return e[r]<<8|e[r+1]}function t(e,r){return e[r]<<24|e[r+1]<<16|e[r+2]<<8|e[r+3]}function n(e,r,t,n){var o=typeof e;this.width=t,this.height=n,this.builder=[],this.filename="string"===o?e:null,this.currentStream="object"===o?e:null,this.isIM=void 0===r||null===r?"im"===F.config["default-image-converter"]:r,this.outputType="string"===o?u.extname(e).substring(1):"jpg"}var o=e.exports;global.framework_image=e.exports;var i=require("child_process"),s=i.exec,a=i.spawn,u=require("path"),c={192:!0,193:!0,194:!0,195:!0,197:!0,198:!0,199:!0,201:!0,202:!0,203:!0,205:!0,206:!0,207:!0};return o.measureGIF=function(e){return{width:e[6],height:e[8]}},o.measureJPG=function(e){var t=e.length,n=0,o=255==e[0]&&216==e[1];if(o){for(n+=2;t>n;){for(;255!=e[n];)n++;for(;255==e[n];)n++;{if(c[e[n]]){var i=r(e,n+6),s=r(e,n+4);return{width:i,height:s}}n+=r(e,++n)}}return null}},o.measurePNG=function(e){return{width:t(e,16),height:t(e,20)}},o.measureSVG=function(e){var r=e.toString("utf8").match(/(width=\"\d+\")+|(height=\"\d+\")+/g);if(r){for(var t=0,n=0,o=0,i=r.length;i>o;o++){var s=r[o];if(t>0&&n>0)break;0===t&&s.startsWith('width="')&&(t=+s.match(/\d+/g),isNaN(t)&&(t=0)),0===n&&s.startsWith('height="')&&(n=+s.match(/\d+/g),isNaN(n)&&(n=0))}return{width:t,height:n}}},n.prototype.clear=function(){var e=this;return e.builder=[],e},n.prototype.measure=function(e){var r=this,t=r.filename.lastIndexOf(".");if(!r.filename)return void e(new Error("Measure does not support stream."));if(-1===t)return void e(new Error("This type of file is not supported."));var n=r.filename.substring(t).toLowerCase(),i=require("fs").createReadStream(r.filename,{start:0,end:".jpg"===n?4e4:24});return i.on("data",function(r){switch(n){case".jpg":return void e(null,o.measureJPG(r));case".gif":return void e(null,o.measureGIF(r));case".png":return void e(null,o.measurePNG(r))}e(new Error("This type of file is not supported."))}),i.on("error",e),r},n.prototype.$$measure=function(){var e=this;return function(r){e.measure(r)}},n.prototype.save=function(e,r,t){var n=this;"function"==typeof e&&(r=e,e=null),e=e||n.filename||"";var o=n.cmd(n.filename?n.filename:"-",e);if(framework.isWindows&&(o=o.replace(/\//g,"\\")),!n.builder.length){if(!r)return;return void setImmediate(function(){r(null,!0)})}var i=s(o,function(e,t,o){FINISHED(t,function(){DESTROY(t)}),i.kill(),i=null,n.clear(),r&&(e?r(e,!1):r(null,!0))});return n.currentStream&&(n.currentStream instanceof Buffer?i.stdin.end(n.currentStream):n.currentStream.pipe(i.stdin)),FINISHED(i.stdin,function(){DESTROY(i.stdin)}),t&&t(i.stdin),n},n.prototype.$$save=function(e,r){var t=this;return function(n){t.save(e,n,r)}},n.prototype.pipe=function(e,r,t){var n=this;if("object"==typeof r&&(t=r,r=null),n.builder.length){(void 0===r||null===r)&&(r=n.outputType);var o=a(n.isIM?"convert":"gm",n.arg(n.filename?n.filename:"-",(r?r+":":"")+"-"));return o.stderr.on("data",e.emit.bind(e,"error")),o.stdout.on("data",e.emit.bind(e,"data")),o.stdout.on("end",e.emit.bind(e,"end")),o.on("error",e.emit.bind(e,"error")),o.stdout.pipe(e,t),n.currentStream&&(n.currentStream instanceof Buffer?o.stdin.end(n.currentStream):n.currentStream.pipe(o.stdin)),n}},n.prototype.stream=function(e,r){var t=this;if(t.builder.length){(void 0===e||null===e)&&(e=t.outputType);var n=a(t.isIM?"convert":"gm",t.arg(t.filename?t.filename:"-",(e?e+":":"")+"-"));return t.currentStream&&(t.currentStream instanceof Buffer?n.stdin.end(t.currentStream):t.currentStream.pipe(n.stdin)),r&&r(n.stdin),n.stdout}},n.prototype.cmd=function(e,r){var t=this,n="";t.builder.sort(function(e,r){return e.priority>r.priority?1:-1});for(var o=t.builder.length,i=0;o>i;i++)n+=(n?" ":"")+t.builder[i].cmd;return(t.isIM?"convert":"gm -convert")+' "'+e+'" '+n+' "'+r+'"'},n.prototype.arg=function(e,r){var t=this,n=[];t.isIM||n.push("-convert"),e&&n.push(e),t.builder.sort(function(e,r){return e.priority>r.priority?1:-1});for(var o=t.builder.length,i=0;o>i;i++){var s=t.builder[i],a=s.cmd.indexOf(" ");-1===a?n.push(s.cmd):(n.push(s.cmd.substring(0,a)),n.push(s.cmd.substring(a+1).replace(/\"/g,"")))}return r&&n.push(r),n},n.prototype.identify=function(e){var r=this;return s((r.isIM?"identify":"gm identify")+' "'+r.fileName+'"',function(r,t,n){if(r)return void e(r,null);var o=t.split(" "),i=o[2].split("x"),s={type:o[1],width:framework_utils.parseInt(i[0]),height:framework_utils.parseInt(i[1])};e(null,s)}),r},n.prototype.$$identify=function(){var e=this;return function(r){e.identify(r)}},n.prototype.push=function(e,r,t){var n=this;return n.builder.push({cmd:e+(r?' "'+r+'"':""),priority:t}),n},n.prototype.output=function(e){var r=this;return"."===e[0]&&(e=e.substring(1)),r.outputType=e,r},n.prototype.resize=function(e,r,t){t=t||"";var n=this,o="";return e&&r?o=e+"x"+r:e&&!r?o=e+"x":!e&&r&&(o="x"+r),n.push("-resize",o+t,1)},n.prototype.thumbnail=function(e,r,t){
t=t||"";var n=this,o="";return e&&r?o=e+"x"+r:e&&!r?o=e:!e&&r&&(o="x"+r),n.push("-thumbnail",o+t,1)},n.prototype.geometry=function(e,r,t){t=t||"";var n=this,o="";return e&&r?o=e+"x"+r:e&&!r?o=e:!e&&r&&(o="x"+r),n.push("-geometry",o+t,1)},n.prototype.filter=function(e){return this.push("-filter",e,1)},n.prototype.trim=function(){return this.push("-trim +repage",1)},n.prototype.extent=function(e,r){var t=this,n="";return e&&r?n=e+"x"+r:e&&!r?n=e:!e&&r&&(n="x"+r),t.push("-extent",n,4)},n.prototype.miniature=function(e,r,t,n){return this.filter(n||"Box").thumbnail(e,r).background(t?t:"white").align("center").extent(e,r)},n.prototype.resizeCenter=function(e,r,t){return this.resize(e,r,"^").background(t?t:"white").align("center").crop(e,r)},n.prototype.scale=function(e,r,t){t=t||"";var n=this,o="";return e&&r?o=e+"x"+r:e&&!r?o=e:!e&&r&&(o="x"+r),n.push("-scale",o+t,1)},n.prototype.crop=function(e,r,t,n){return this.push("-crop",e+"x"+r+"+"+(t||0)+"+"+(n||0),4)},n.prototype.quality=function(e){return this.push("-quality",e||80,5)},n.prototype.align=function(e){var r="";switch(e.toLowerCase().replace("-","")){case"left top":case"top left":r="NorthWest";break;case"left bottom":case"bottom left":r="SouthWest";break;case"right top":case"top right":r="NorthEast";break;case"right bottom":case"bottom right":r="SouthEast";break;case"left center":case"center left":case"left":r="West";break;case"right center":case"center right":case"right":r="East";break;case"bottom center":case"center bottom":case"bottom":r="South";break;case"top center":case"center top":case"top":r="North";break;case"center center":case"center":r="Center";break;default:r=e}return this.push("-gravity",r,3)},n.prototype.gravity=function(e){return this.align(e)},n.prototype.blur=function(e){return this.push("-blur",e,10)},n.prototype.normalize=function(){return this.push("-normalize",null,10)},n.prototype.rotate=function(e){return this.push("-rotate",e||0,8)},n.prototype.flip=function(){return this.push("-flip",null,10)},n.prototype.flop=function(){return this.push("-flop",null,10)},n.prototype.minify=function(){return this.push("+profile","*")},n.prototype.grayscale=function(){return this.push("-colorspace","Gray",10)},n.prototype.bitdepth=function(e){return this.push("-depth",e,10)},n.prototype.colors=function(e){return this.push("-colors",e,10)},n.prototype.background=function(e){return this.push("-background",e,2)},n.prototype.fill=function(e){return this.push("-fill",e,2)},n.prototype.sepia=function(e){return this.push("-modulate","115,0,100",4).push("-colorize","7,21,50",5)},n.prototype.command=function(e,r,t){return this.push(e,r,t||10)},o.Image=n,o.Picture=n,o.init=function(e,r,t,o){return new n(e,r,t,o)},o.load=function(e,r,t,o){return new n(e,r,t,o)},e}({exports:{}}),function(module){function Database(e,r,t){typeof r===BOOLEAN&&(t=r,r=null),this.isReady=!1,this.status_prev=STATUS_UNKNOWN,this.status=STATUS_UNKNOWN,this.changes=void 0===t?!0:t===!0,this.countRead=0,this.countWrite=0,this.pendingRead=[],this.pendingEach=[],this.pendingLock=[],this.pendingDrop=[],this.pendingWrite=[],this.pendingClear=[],this.isPending=!1,-1!==e.indexOf(EXTENSION)&&(e=e.replace(EXTENSION,"")),this.filename=e+EXTENSION,this.filenameTemp=e+EXTENSION_TMP,this.filenameChanges=e+EXTENSION_CHANGES,this.filenameStored=e+EXTENSION_STORED,this.filenameMeta=e+EXTENSION_META,this.name=path.basename(e),this.directory=path.dirname(e),this.views=new Views(this),this.meta={version:VERSION,views:{},stored:{},description:"",created:new Date,custom:null},this.binary=0===(r||"").length?null:new Binary(this,r),this.changelog=new Changelog(this,this.filenameChanges),this.file=new FileReader(this),this.stored=new Stored(this,this.filenameStored),this._metaLoad()}function Views(e){this.views={},this.db=e,this.directory=e.directory,this.emit=e.emit}function View(e,r,t){this.db=e,this.status=STATUS_UNKNOWN,this.countRead=0,this.pendingRead=[],this.pendingOperation=[],this.filename=t,this.name=r,this.emit=e.emit,this.file=new FileReader(e)}function Stored(e,r){this.filename=r,this.db=e,this.stored={},this.cache={},this.isReaded=!1}function Binary(e,r){this.db=e,this.directory=r,this.exists=!1}function Changelog(e,r){this.filename=r,this.db=e}function FileReader(e){this.db=e}function noop(){}function appendFile(e,r,t,n){if(0===r.length)return void t();var o="";r.slice(0,30).forEach(function(e){o+=JSON.stringify(e)+NEWLINE}),fs.appendFile(e,o,function(o){o&&n.emit("error",o),appendFile(e,r.slice(30),t,n)})}function filterPrepare(fnFilter){return 0===fnFilter.length?function(){return!0}:eval("(function(doc){"+(-1===fnFilter.indexOf("return ")?"return ":"")+fnFilter+"})")}function onBuffer(e,r,t){var n=e.indexOf(NEWLINE);if(-1===n)return void t(e);var o=t(e.substring(0,n));if(o)try{r(null,JSON.parse(o),o)}catch(i){r(i,null,o)}onBuffer(e.substring(n+1),r,t)}function updatePrepare(e,r,t,n){return typeof e===STRING&&(e=filterPrepare(e)),{filter:e,callback:r,count:0,type:n,changes:t}}function u16(e,r){return e[r]<<8|e[r+1]}function u32(e,r){return e[r]<<24|e[r+1]<<16|e[r+2]<<8|e[r+3]}function dimensionGIF(e){return{width:e[6],height:e[8]}}function dimensionJPG(e){var r=e.length,t=0,n=255==e[0]&&216==e[1];if(n)for(t+=2;r>t;){for(;255!=e[t];)t++;for(;255==e[t];)t++;{if(sof[e[t]]){var o=u16(e,t+6),i=u16(e,t+4);return{width:o,height:i}}t+=u16(e,++t)}}}function dimensionPNG(e){return{width:u32(e,16),height:u32(e,20)}}var exports=module.exports;global.framework_nosql=module.exports;var fs=require("fs"),path=require("path"),util=require("util"),events=require("events"),VERSION="v3.0.5",STATUS_UNKNOWN=0,STATUS_READING=1,STATUS_WRITING=2,STATUS_LOCKING=3,STATUS_PENDING=4,EXTENSION=".nosql",EXTENSION_VIEW=".nosql",EXTENSION_BINARY=".nosql-binary",EXTENSION_TMP=".nosql-tmp",EXTENSION_CHANGES=".changelog",EXTENSION_STORED=".nosql-stored",EXTENSION_META=".meta",MAX_WRITESTREAM=2,MAX_READSTREAM=4,MAX_BUFFER_SIZE=40960,BINARY_HEADER_LENGTH=2e3,NEWLINE="\n",STRING="string",FUNCTION="function",UNDEFINED="undefined",BOOLEAN="boolean";typeof setImmediate===UNDEFINED&&(global.setImmediate=function(e){process.nextTick(e)}),Database.prototype={get created(){var e=this.meta.created;return util.isDate(e)?e:null===e||void 0===e?null:new Date(Date.parse(e.toString()))}},Database.prototype.__proto__=Object.create(events.EventEmitter.prototype,{constructor:{value:Database,enumberable:!1}}),Database.prototype.insert=function(e,r,t){var n=this;typeof r===STRING&&(t=r,r=null),e instanceof Array||(e=[e]);var o=e.length;if(n.status===STATUS_LOCKING||n.status===STATUS_PENDING||n.countWrite>=MAX_WRITESTREAM){for(var i=0;o>i;i++)n.pendingWrite.push({json:e[i],changes:t});return r&&r(null,-1),n}for(var s=[],a=[],i=0;o>i;i++){var u=e[i];void 0!==u.json?(s.push(u.json),u.changes&&a.push(u.changes)):(s.push(u),t&&a.push(t))}return 0===s.length?void n.next():(n.emit("insert",!0,s.length),n.status=STATUS_WRITING,n.countWrite++,appendFile(n.filename,s,function(){if(n.countWrite--,n.emit("insert",!1,s.length),n.next(),n.changelog.insert(a),r){var t=s.length;setImmediate(function(){r(null,t)})}s=null,a=null,e=null;for(var o=Object.keys(n.meta.views),t=o.length,i=0;t>i;i++)n.views.refresh(o[i])},n),n)},Database.prototype.$$insert=function(e,r){var t=this;return function(n){t.insert(e,n,r)}},Database.prototype.read=function(e,r,t,n,o,i){var s=this,a=t||0,u=n||0;if(s.status===STATUS_LOCKING||s.status===STATUS_PENDING||s.countRead>=MAX_READSTREAM)return s.pendingRead.push(function(){s.read(e,r,t,n,o)}),s;void 0===r&&(r=e,e=function(e){return e}),typeof e===STRING&&(e=filterPrepare(e)),null===e&&(e=function(e){return e}),s.emit(i||"read",!0,0),s.countRead++,s.status=STATUS_READING;var c=[],l="",f=0,p=!0,d=function(e){return l+=e},m=function(r,t){if(p&&(l="",!r)){var n=e(t);n!==!1&&null!==n&&void 0!==n&&(f++,a>0&&a>=f||(o||c.push(n===!0?t:n),u>0&&c.length===u&&(p=!1)))}};return s.file.open(s.filename,MAX_BUFFER_SIZE,function(e){return onBuffer(e,m,d),p},function(){s.countRead--,s.next(),setImmediate(function(){s.emit(i||"read",!1,o?f:c.length),r(null,o?f:c)})}),s},Database.prototype.all=function(e,r,t,n){return this.read(e,r,t,n,!1,"all")},Database.prototype.$$all=function(e,r,t){var n=this;return function(o){return n.all(e,o,r,t)}},Database.prototype.one=function(e,r){var t=function(e,t){r(e,t?t[0]||null:null)};return this.read(e,t,0,1,!1,"one")},Database.prototype.$$one=function(e){var r=this;return function(t){return r.one(e,t)}},Database.prototype.top=function(e,r,t){return this.read(r,t,0,e,!1,"top")},Database.prototype.$$top=function(e,r){var t=this;return function(n){return t.top(e,r,n)}},Database.prototype.count=function(e,r){return this.read(e,r,0,0,!0,"count")},Database.prototype.$$count=function(e){var r=this;return function(t){return r.count(e,fnMap,t)}},Database.prototype.each=function(e,r){var t=this;if(t.status===STATUS_LOCKING||t.status===STATUS_PENDING||t.countRead>=MAX_READSTREAM)return e&&t.pendingEach.push({item:e,callback:r}),t;var n=[];e&&n.push({item:e,callback:r});for(var o=t.pendingEach.length,i=0;o>i;i++)n.push(t.pendingEach[i]);if(0===n.length)return t.next(),t;t.countRead++,t.status=STATUS_READING;var s="",a=0;t.pendingEach=[];var u=function(e){return s+=e},c=function(e,r){if(s="",e)return void t.emit("error",e,"each-buffer");for(var o=n.length,i=0;o>i;i++)try{n[i].item(r,a,"each-buffer")}catch(u){t.emit("error",u)}a++};return t.emit("each",!0,0),t.file.open(t.filename,MAX_BUFFER_SIZE,function(e){return onBuffer(e,c,u),!0},function(){t.countRead--,t.next(),setImmediate(function(){t.emit("each",!1,a);for(var e=n.length,r=0;e>r;r++){var o=n[r];o.callback&&o.callback()}})}),t},Database.prototype.$$each=function(e){var r=this;return function(t){return r.each(e,t)}},Database.prototype.sort=function(e,r,t,n,o){var i=this,s=[],a=0;typeof e===STRING&&(e=filterPrepare(e)),o=o||0,n=n||0;var u=function(){s.sort(r),(n>0||o>0)&&(s=s.slice(n,n+o)),t(null,s,a)},c=function(r){var t=e(r);t!==!1&&null!==t&&void 0!==t&&(a++,s.push(t===!0?r:t))};return i.each(c,u),i},Database.prototype.$$sort=function(e,r,t,n){var o=this;return function(i){o.sort(e,r,i,t,n)}},Database.prototype.clear=function(e,r){var t=this,n=typeof e;if(void 0===e&&(e=null),n===STRING&&(r=e,e=null),t.pendingClear.push(function(){r&&t.changelog.insert(r),e&&e()}),t.status!==STATUS_UNKNOWN)return t;t.status=STATUS_LOCKING;for(var o=[],i=t.pendingClear.length,s=0;i>s;s++){var a=t.pendingClear[s];null!==a&&o.push(a)}return t.emit("clear",!0,!1),t.pendingClear=[],fs.exists(t.filename,function(e){return e?void fs.unlink(t.filename,function(e){e&&t.emit("error",e,"clear"),t.next(),setImmediate(function(){t.emit("clear",!1,null===e);for(var r=o.length,n=0;r>n;n++){var i=o[n];i&&i()}})}):(t.next(),void setImmediate(function(){t.emit("clear",!1,!0);for(var e=o.length,r=0;e>r;r++){var n=o[r];n&&n()}}))}),t},Database.prototype.$$clear=function(e){var r=this;return function(t){r.clear(t,e)}},Database.prototype.drop=function(e){var r=this;if(void 0===e&&(e=null),r.pendingDrop.push(e),r.status!==STATUS_UNKNOWN)return r;r.status=STATUS_LOCKING;var t=[];return r.pendingDrop.forEach(function(e){null!==e&&t.push(e)}),r.emit("drop",!0,!1),r.pendingDrop=[],r._drop(),fs.exists(r.filename,function(e){return e?(fn.unlink(r.filenameMeta,noop),void fs.unlink(r.filename,function(e){e&&r.emit("error",e,"drop"),r.next(),setImmediate(function(){r.emit("drop",!1,null===e),t.forEach(function(r){r&&r(null,null===e)})})})):(r.next(),void setImmediate(function(){r.emit("drop",!1,!0),t.forEach(function(e){e&&e(null)})}))}),r},Database.prototype.$$drop=function(){var e=this;return function(r){e.drop(r)}},Database.prototype._drop=function(){var e=this;return fs.readdirSync(e.directory).forEach(function(r){var t=-1!==r.indexOf(e.name+"#")&&-1!==r.indexOf(EXTENSION_VIEW);if(t)return void fs.unlink(path.join(e.directory,r),noop);var n=e.name+EXTENSION_CHANGES===r;return n?void fs.unlink(path.join(e.directory,r),noop):void 0}),null===e.binary?e:(fs.readdirSync(e.binary.directory).forEach(function(r){-1!==r.indexOf(e.name+"#")&&-1!==r.indexOf(EXTENSION_BINARY)&&fs.unlink(path.join(e.binary.directory,r),noop)}),e)},Database.prototype.update=function(e,r,t,n){var o=this;if(typeof r===STRING&&(t=r,r=null),void 0!==e&&o.pendingLock.push(updatePrepare(e,r,t,n||"update")),o.status!==STATUS_UNKNOWN)return o;var i=[];if(o.pendingLock.forEach(function(e){i.push(e)}),0===i.length)return o.next(),o;o.status=STATUS_LOCKING;var s="",a=i.length,u=[],c=0,l=0,f=0,p=!1;o.emit("update/remove",!0,0,0),o.pendingLock=[];var d=function(){i.forEach(function(e){return"update"===e.type?void(e.count=l):void("remove"===e.type&&(e.count=c))}),fs.rename(o.filenameTemp,o.filename,function(e){e&&o.emit("error",e,"update/rename-file"),o.emit("update/remove",!1,l,c);var r=[];i.forEach(function(e){void 0!==e.changes&&r.push(e.changes),e.callback&&function(e,r){setImmediate(function(){e(null,r)})}(e.callback,e.count)}),r.length>0&&o.changelog.insert(r),o.next()})},m=!0,h=function(e,r){if(m&&(m=!1,fs.appendFile(o.filenameTemp,"")),u.length>25||r){if(0===u.length)return void(p&&0>=f&&d());f++,fs.appendFile(o.filenameTemp,u.join(NEWLINE)+NEWLINE,function(){f--,p&&0>=f&&d()}),u=[]}typeof e===STRING&&u.push(e)},g=function(e){return s+=e},v=function(e,r,t){s="";for(var n=null,u=0;a>u;u++){var f=i[u];if(n=f.filter(r)||null,null===n)break}if(null===n)return o.emit("remove",r),void c++;var p=JSON.stringify(n);p!==t&&(o.emit("update",n),l++),h(p)};return o.file.open(o.filename,MAX_BUFFER_SIZE,function(e){return onBuffer(e.toString(),v,g),!0},function(e){if(!e){o.emit("update/remove",!1,l,c);var r=[];return i.forEach(function(e){void 0!==e.changes&&r.push(e.changes),e.callback&&function(e,r){setImmediate(function(){e(null,r)})}(e.callback,e.count)}),r.length>0&&o.changelog.insert(r),void o.next()}p=!0,h(null,!0)}),o},Database.prototype.$$update=function(e,r,t){var n=this;return function(o){n.update(e,o,r,t)}},Database.prototype.prepare=function(e,r,t){var n=this;return void 0!==e&&n.pendingLock.push(updatePrepare(e,r,t,"update")),n},Database.prototype.$$prepare=function(e,r){var t=this;return function(n){t.prepare(e,n,r)}},Database.prototype.remove=function(e,r,t){var n=this;typeof e===STRING&&(e=filterPrepare(e));var o=function(r){return e(r)===!0?null:r};return n.update(o,r,t,"remove"),n},Database.prototype.$$remove=function(e,r){var t=this;return function(n){t.remove(e,n,r)}},Database.prototype.pause=function(){var e=this;return e.isPending===!0?e:(e.isPending=!0,e.status===STATUS_UNKNOWN&&(e.status=STATUS_PENDING,e.emit("pause/resume",!0)),e)},Database.prototype.resume=function(){var e=this;return e.isPending?(e.isPending=!1,e.emit("pause/resume",!1),e.next(),e):e},Database.prototype.next=function(){var e=this;if(e.isPending)return void(e.status!==STATUS_PENDING&&(e.status=STATUS_PENDING,e.emit("pause")));if(e.status_prev=e.status,e.status=STATUS_UNKNOWN,e.countRead>0)return void(e.status=STATUS_READING);if(e.countWrite>0)return void(e.status=STATUS_WRITING);if(e.pendingWrite.length>0)return e.insert(e.pendingWrite),void(e.pendingWrite=[]);if(e.pendingLock.length>0)return void e.update();if(e.pendingEach.length>0)return void e.each();if(!(e.pendingRead.length>0))return e.pendingDrop.length>0?void e.drop():e.pendingClear.length>0?void e.clear():void setImmediate(function(){e.emit("complete",e.status_prev)});var r=e.pendingRead.length;r>MAX_READSTREAM&&(r=MAX_READSTREAM);for(var t=0;r>t;t++)e.pendingRead.shift()()},Database.prototype.description=function(e){var r=this;return void 0===e?r.meta.description:(r.meta.description=(e||"").toString(),r._metaSave(),r)},Database.prototype.custom=function(e){var r=this;return void 0===e?r.meta.custom:(r.meta.custom=e,r._metaSave(),r)},Database.prototype._metaSave=function(){var e=this;return void 0===e.meta.created&&(e.meta.created=new Date),fs.writeFile(e.filenameMeta,JSON.stringify(e.meta),noop),e},Database.prototype._metaLoad=function(e){var r=this;return fs.readFile(r.filenameMeta,function(t,n){var o=r.isReady;if(r.isReady=!0,t)return o||(r.emit("ready"),r.emit("load")),void(e&&e(!1,r.meta));r.meta=JSON.parse(n.toString("utf8"));for(var i=Object.keys(r.meta.views),s=i.length,a=0;s>a;a++)r.meta.views[i[a]].isReady=!0;o||(r.emit("ready"),r.emit("load")),e&&e(!0,r.meta)}),r},Views.prototype.all=function(e,r,t,n,o){var i=this,s=i.views[e];void 0===s&&(s=i.getView(e),i.views[e]=s);var a=typeof t;return a===FUNCTION||a===STRING?(o=t,t=0,n=0):(a=typeof n,(a===FUNCTION||a===STRING)&&(o=n,n=0)),typeof o===STRING&&(o=filterPrepare(o)),typeof o!==FUNCTION&&(o=function(e){return e}),s.read(o,r,t,n),i.db},Views.prototype.$$all=function(e,r,t,n){var o=this;return function(i){o.all(e,i,r,t,n)}},Views.prototype.top=function(e,r,t,n){var o=this,i=o.views[e];return void 0===i&&(i=o.getView(e),o.views[e]=i),typeof n===STRING&&(n=filterPrepare(n)),typeof n!==FUNCTION&&(n=function(e){return e}),i.read(n,t,0,r,!0),o.db},Views.prototype.$$top=function(e,r,t){var n=this;return function(o){n.top(e,r,o,t)}},Views.prototype.one=function(e,r,t){var n=this,o=n.views[e];return void 0===o&&(o=n.getView(e),n.views[e]=o),void 0===t&&(t=r,r=null),typeof r===STRING&&(r=filterPrepare(r)),typeof r!==FUNCTION&&(r=function(e){return e}),o.read(r,t,0,1,!0),n.db},Views.prototype.$$one=function(e,r){var t=this;return function(n){t.one(e,r,n)}},Views.prototype.drop=function(e,r,t){var n=this,o=n.views[e];return typeof r===STRING&&(t=r,r=null),void 0===o&&(o=n.getView(e),n.views[e]=o),delete n.db.meta.views[e],n.db._metaSave(),n.db.emit("view/drop",!0,e),o.operation(function(i){fs.exists(o.filename,function(s){return n.db.emit("view/drop",!1,e),t&&n.db.changelog.insert(t),s?void fs.unlink(o.filename,function(e){e&&n.db.emit("error",e,"view/drop"),r&&r(e,!0),i&&i()}):(r&&r(null,!0),void(i&&i()))})}),n.db},Views.prototype.$$drop=function(e,r,t){var n=this;return function(r){n.drop(e,r,t)}},Views.prototype.refresh=function(name,fnCallback){var self=this,schema=self.db.meta.views[name];schema.isReady=!1;var fnSort=schema.sort||"",fnMap=schema.map;fnSort=0===fnSort.length?null:eval("("+fnSort+")"),fnMap=eval("("+fnMap+")");var selected=[],count=0;self.db.emit("view/refresh",!0,name,"");var onCallback=function(){fnSort&&selected.sort(fnSort);var e=self.views[name];void 0===e&&(e=self.getView(name),self.views[name]=e);var r=self.getFileName(name);e.operation(function(e){var t=function(){appendFile(r,selected,function(){self.db.emit("view/refresh",!1,name,count),schema.isReady=!0,fnCallback&&setImmediate(function(){fnCallback(null,count)}),e&&e()},self.db)};fs.exists(r,function(n){return n?void fs.unlink(r,function(r){return r?(self.db.emit("error",r,"view/refresh"),void(e&&e())):void t()}):void t()})})},onItem=function(e){var r=fnMap(e)||null;null!==r&&(count++,selected.push(r))};self.db.each(onItem,onCallback)},Views.prototype.$$refresh=function(e){var r=this;return function(t){r.refresh(e,t)}},Views.prototype.create=function(e,r,t,n,o){var i=this;return typeof n===STRING&&(o=n,n=null),typeof r===STRING&&(r=filterPrepare(r)),i.db.meta.views[e]={map:r.toString(),sort:(t||"").toString(),isReady:!1},i.db._metaSave(),i.db.emit("view/create",!0,e,0),o&&i.db.changelog.insert(o),i.refresh(e,n),i},Views.prototype.$$create=function(e,r,t,n){var o=this;return function(i){o.create(e,r,t,i,n)}},Views.prototype.getView=function(e){var r=this;return new View(r.db,e,r.getFileName(e))},Views.prototype.getFileName=function(e){var r=this;return path.join(r.directory,r.db.name+"#"+e+EXTENSION_VIEW)},View.prototype.read=function(e,r,t,n,o,i){var s=this,a=t||0,u=n||0;if(o=o||!1,s.status===STATUS_LOCKING||s.countRead>=MAX_READSTREAM)return s.pendingRead.push(function(){s.read(e,r,t,n,i)}),s;s.status=STATUS_READING,typeof e===STRING&&(e=filterPrepare(e)),null===e&&(e=function(e){return e}),s.db.emit("view",!0,s.name,0),s.countRead++;var c=[],l="",f=0,p=!0,d=function(e){return l+=e},m=function(r,t){if(p&&(l="",!r)){var n=e(t);n!==!1&&null!==n&&void 0!==n&&(f++,a>0&&a>=f||(i||c.push(n===!0?t:n),u>0&&c.length===u&&(p=!1)))}};return s.file.open(s.filename,MAX_BUFFER_SIZE,function(e){return o&&!p?(f=-1,!1):(onBuffer(e,m,d),p)},function(){s.countRead--,s.next(),setImmediate(function(){s.emit("view",!1,s.name,f),r(null,c,f)})}),s},View.prototype.operation=function(e){var r=this;if(void 0!==e&&r.pendingOperation.push(e),r.status!==STATUS_UNKNOWN)return r;r.status=STATUS_LOCKING;var t=r.pendingOperation.shift();return t(function(){r.next()}),r},View.prototype.next=function(){var e=this;if(e.status=STATUS_UNKNOWN,e.countRead>0)return void(e.status=STATUS_READING);if(e.pendingOperation.length>0)return void e.operation();if(e.pendingRead.length>0){var r=e.pendingRead.length;r>MAX_READSTREAM&&(r=MAX_READSTREAM);for(var t=0;r>t;t++)e.pendingRead.shift()()}else;},Stored.prototype.create=function(e,r,t,n){if(typeof t===STRING){var o=n;n=t,t=o}var i=this;return i.db.meta.stored[e]=r.toString(),i.db._metaSave(t),delete i.cache[e],n&&i.db.changelog.insert(n),i.db.emit("stored/create",e),i.db},Stored.prototype.$$create=function(e,r,t){var n=this;return function(o){n.create(e,r,o,t)}},Stored.prototype.remove=function(e,r,t){var n=this;if(typeof r===STRING){var o=t;t=r,r=o}return t&&n.db.changelog.insert(t),delete n.cache[e],delete n.db.meta.stored[e],n.db._metaSave(r),n.db},Stored.prototype.$$remove=function(e,r){var t=this;return function(n){t.remove(e,n,r)}},Stored.prototype.clear=function(e,r){var t=this;if(typeof e===STRING){var n=r;r=e,e=n}return r&&t.db.changelog.insert(r),t.cache={},t.db.meta.stored={},t.db._metaSave(e),t.db},Stored.prototype.$$clear=function(e){var r=this;return function(t){r.clear(t,e)}},Stored.prototype.execute=function(name,params,fnCallback,changes){var self=this,type=typeof params;if(type===FUNCTION&&(changes=fnCallback,fnCallback=params,params=null),typeof fnCallback===STRING){var tmp=changes;changes=fnCallback,fnCallback=tmp}changes&&self.db.changelog.insert(changes);var fn=self.db.meta.stored[name];if(void 0===fn)return void(fnCallback&&fnCallback());var cache=self.cache[name];return self.db.emit("stored",name),void 0===fn?void(fnCallback&&fnCallback()):(void 0===cache?(fn=eval("("+fn+")"),self.cache[name]=fn):fn=cache,void 0===fnCallback&&(fnCallback=function(){}),fn.call(self.db,self.db,fnCallback,params||null),self)},Stored.prototype.$$execute=function(e,r,t){var n=this;return function(o){n.execute(e,r,o,t)}},Binary.prototype.insert=function(e,r,t,n,o){if(typeof t===STRING&&(t=new Buffer(t,"base64")),t.resume)return this.insert_stream(null,e,r,t,callback,o);typeof n===STRING&&(o=n,n=null);var i=this,s=t.length,a={width:0,height:0};i.check(),-1!==e.indexOf(".gif")?a=dimensionGIF(t):-1!==e.indexOf(".png")?a=dimensionPNG(t):-1!==e.indexOf(".jpg")&&(a=dimensionJPG(t));var u=new Buffer(BINARY_HEADER_LENGTH);u.fill(" "),u.write(JSON.stringify({name:e,size:s,type:r,width:a.width,height:a.height}));var c=(new Date).getTime().toString()+Math.random().toString(36).substring(10),l=i.db.name+"#"+c,f=fs.createWriteStream(path.join(i.directory,l+EXTENSION_BINARY));return f.write(u,"binary"),f.end(t),f=null,o&&i.db.changelog.insert(o),n&&n(null,c,u),c},Binary.prototype.insert_stream=function(e,r,t,n,o,i){self.check();var s=new Buffer(BINARY_HEADER_LENGTH);s.fill(" "),s.write(JSON.stringify({name:r,size:size,type:t,width:0,height:0})),e||(e=(new Date).getTime().toString()+Math.random().toString(36).substring(10));var a=self.db.name+"#"+e,n=fs.createWriteStream(path.join(self.directory,a+EXTENSION_BINARY));return n.write(s,"binary"),n.pipe(n),n=null,i&&self.db.changelog.insert(i),o&&o(null,e,s),e},Binary.prototype.$$insert=function(e,r,t,n){var o=this;return function(t){o.insert(e,r,buf,t,n)}},Binary.prototype.update=function(e,r,t,n,o,i){if(typeof n===STRING&&(n=new Buffer(n,"base64")),n.resume)return this.insert_stream(e,r,t,n,callback,i);typeof o===STRING&&(i=o,o=null);var s=this,a=n.length,u={width:0,height:0},c=e;s.check(),-1===c.indexOf("#")&&(c=s.db.name+"#"+c),-1!==r.indexOf(".gif")?u=dimensionGIF(n):-1!==r.indexOf(".png")?u=dimensionPNG(n):-1!==r.indexOf(".jpg")&&(u=dimensionJPG(n));var l=new Buffer(BINARY_HEADER_LENGTH);l.fill(" "),l.write(JSON.stringify({name:r,size:a,type:t,width:u.width,height:u.height}));var f=fs.createWriteStream(path.join(s.directory,c+EXTENSION_BINARY));return f.write(l,"binary"),f.end(n),f=null,i&&s.db.changelog.insert(i),o&&o(null,e,l),e},Binary.prototype.$$update=function(e,r,t,n,o){var i=this;return function(n){i.update(e,r,t,update,n,o)}},Binary.prototype.read=function(e,r){var t=this;t.check(),-1===e.indexOf("#")&&(e=t.db.name+"#"+e);var n=path.join(t.directory,e+EXTENSION_BINARY),o=fs.createReadStream(n,{start:0,end:BINARY_HEADER_LENGTH-1,encoding:"binary"});return o.on("error",function(e){r(e,null,null)}),o.on("data",function(e){var t=new Buffer(e,"binary").toString("utf8").replace(/^[\s]+|[\s]+$/g,"");o=fs.createReadStream(n,{start:BINARY_HEADER_LENGTH}),r(null,o,JSON.parse(t))}),t.db},Binary.prototype.$$read=function(e){var r=this;return function(t){r.read(e,t)}},Binary.prototype.remove=function(e,r,t){var n=this,o=e;n.check(),-1===o.indexOf("#")&&(o=n.db.name+"#"+o);var i=path.join(n.directory,o+EXTENSION_BINARY);return typeof r===STRING&&(t=r,r=null),fs.exists(i,function(e){return t&&n.db.changelog.insert(t),e?void fs.unlink(i,function(e){r&&r(e,!0)}):void(r&&r(null,!1))}),n.db},Binary.prototype.$$remove=function(e,r){var t=this;return function(n){t.remove(e,n,r)}},Binary.prototype.check=function(){var e=this;return e.exists?e:(e.exists=!0,fs.existsSync(e.directory)?e:(fs.mkdirSync(e.directory),e))},Changelog.prototype.insert=function(e){var r=this;if(!r.db.changes)return r.db;if(void 0===e)return r.db;if(e instanceof Array||(e=[e||""]),0===e.length)return r.db;var t="",n=new Date,o=n.getFullYear(),i=(n.getMonth()+1).toString(),s=n.getDate().toString(),a=n.getHours().toString(),u=n.getMinutes().toString(),c=n.getSeconds().toString();1===i.length&&(i="0"+i),1===s.length&&(s="0"+s),1===u.length&&(u="0"+u),1===a.length&&(a="0"+a),1===c.length&&(c="0"+c);var l=o+"-"+i+"-"+s+" "+a+":"+u+":"+c;return e.forEach(function(e){t+=l+" | "+e+NEWLINE,r.db.emit("change",e)}),fs.appendFile(r.filename,t,function(e){}),r.db},Changelog.prototype.read=function(e){var r=this;return fs.exists(r.filename,function(t){return t?void fs.readFile(r.filename,function(r,t){if(r)return void e(r,[]);var n=t.toString("utf8").split("\n");""===n[n.length-1]&&n.pop(),e(null,n)}):void e(null,[])}),r.db},Changelog.prototype.$$read=function(){var e=this;return function(r){e.read(r)}},Changelog.prototype.clear=function(e){var r=this;return fs.exists(r.filename,function(t){return t?void fs.unlink(r.filename,function(r,t){return r?void(e&&e(r,!1)):void(e&&e(null,!0))}):void(e&&e(!1))}),r.db},Changelog.prototype.$$clear=function(){var e=this;return function(r){e.clear(r)}},FileReader.prototype.open=function(e,r,t,n){var o=this;fs.open(e,"r",function(e,i){if(e)return void n(!1);r=r||1024;var s=function a(e,s){return e?(fs.close(i),i=null,void n(!0)):void o.read(i,s+r,r,t,a)};o.read(i,0,r,t,s)})},FileReader.prototype.read=function(e,r,t,n,o){var i=new Buffer(t);fs.read(e,i,0,t,r,function(e,s){var a=s!==t,u=i.toString("utf8",0,s);if(a)return u=u.replace(/\s+$/g,""),u[u.length-1]!==NEWLINE&&(u+=NEWLINE),n(u),void o(!0);try{a=!n(u)}catch(e){a=!0}setImmediate(function(){o(a,r,t)})})};var sof={192:!0,193:!0,194:!0,195:!0,197:!0,198:!0,199:!0,201:!0,202:!0,203:!0,205:!0,206:!0,207:!0};return exports.database=Database,exports.load=exports.open=exports.nosql=exports.init=function(e,r,t){return new Database(e,r,t)},module}({exports:{}}),function(e){function r(){this.debug=!1,this.Message=n,this.Mail=n}function t(e,r){p.resolveMx(e,function(t,n){function o(e){if(e>=n.length)return void r(new Error(y.connection));var t=c.createConnection(25,n[e].exchange);t.on("error",function(r){o(++e)}),t.on("connect",function(){r(null,t)})}return t?void r(t,n):n&&0!==n.length?(n.sort(function(e,r){return e.priority<r.priority}),void o(0)):void r(new Error(y.resolve+e))})}function n(e,r){this.subject=e||"",this.body=r||"",this.files=new Array(0),this.addressTo=new Array(0),this.addressReply=new Array(0),this.addressCC=new Array(0),this.addressBCC=new Array(0),this.addressFrom={name:"",address:""},this.callback=null,this.closed=!1,this.tls=!1}function o(e){for(var r=0,t="",n=e.length;n>r;){var o=r+68;o>n&&(o=n),t+=e.substring(r,o)+h,r=o}return t}function i(e){return e.substring(e.indexOf("@")+1)}function s(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1).toUpperCase()}function a(){return s()+s()+"-"+s()+"-"+s()+"-"+s()+"-"+s()+s()+s()}function u(e){return e?"=?utf-8?B?"+new Buffer(e).toString("base64")+"?=":""}e.exports;global.framework_mail=e.exports;var c=require("net"),l=require("tls"),f=require("events"),p=require("dns"),d=require("fs"),m=require("path"),h="\r\n",g="boolean",v=/\besmtp\b/i,y={notvalid:"E-mail address is not valid",resolve:"Cannot resolve MX of ",connection:"Cannot connect to any SMTP server."};global.framework_utils||(global.framework_utils=require("./utils")),r.prototype.__proto__=Object.create(f.EventEmitter.prototype,{constructor:{value:r,enumberable:!1}}),r.prototype.create=function(e,r){return new n(e,r)},n.prototype.sender=function(e,r){return this.from(e,r)},n.prototype.from=function(e,r){if(">"===e[e.length-1]){var t=e.indexOf("<");r=e.substring(0,t-1),e=e.substring(t+1,e.length-1)}if(!e.isEmail())throw new Error(y.notvalid);var n=this;return n.addressFrom.name=r||"",n.addressFrom.address=e,n},n.prototype.to=function(e,r,t){if(typeof r===g&&(t=r,r=void 0),">"===e[e.length-1]){var n=e.indexOf("<");r=e.substring(0,n-1),e=e.substring(n+1,e.length-1)}if(!e.isEmail())throw new Error(y.notvalid);var o=this;return t&&(o.addressTo=new Array(0)),r?(o.addressTo.push({email:e,name:r}),o):(o.addressTo.push(e),o)},n.prototype.cc=function(e,r,t){if(typeof r===g&&(t=r,r=void 0),">"===e[e.length-1]){var n=e.indexOf("<");r=e.substring(0,n-1),e=e.substring(n+1,e.length-1)}if(!e.isEmail())throw new Error(y.notvalid);var o=this;return t&&(o.addressCC=new Array(0)),r?(o.addressCC.push({email:e,name:r}),o):(o.addressCC.push(e),o)},n.prototype.bcc=function(e,r){if(!e.isEmail())throw new Error(y.notvalid);var t=this;return r&&(t.addressBCC=new Array(0)),t.addressBCC.push(e),t},n.prototype.reply=function(e,r){if(!e.isEmail())throw new Error(y.notvalid);var t=this;return r&&(t.addressReply=new Array(0)),t.addressReply.push(e),t},n.prototype.attachment=function(e,r){var t=this;return void 0===r&&(r=m.basename(e)),t.files.push({name:r,filename:e,contentType:framework_utils.getContentType(m.extname(r))}),t},n.prototype.attachmentInline=function(e,r,t){var n=this;return void 0===r&&(r=m.basename(e)),n.files.push({name:r,filename:e,contentType:framework_utils.getContentType(m.extname(r)),disposition:"inline",contentId:t}),n},n.prototype.send=function(e,r,n){var o=this;if(e=e||null,"function"==typeof r){var s=n;n=r,r=s}if(o.isSent=!1,o.callback=n,r.secure&&!r.port&&(r.port=465),r=framework_utils.copy(r,{secure:!1,port:25,user:"",password:"",timeout:1e4,tls:null}),null===e||""===e)return e=i(o.addressFrom.address),t(e,function(e,t){return e?(w.emit("error",e,o),void(!o.isSent&&n&&n(e))):(t.on("error",function(e){w.emit("error",e,o),!o.isSent&&n&&n(e)}),void o._send(t,r))}),o;var a;if(r.secure){var u=framework_utils.copy(r);u.host=e,a=l.connect(u,function(){o._send(this,r)})}else a=c.createConnection(r.port,e);return a.$host=e,a.on("error",function(e){a.destroy(),o.closed=!0,!o.isSent&&o.callback&&o.callback(e),-1===e.stack.indexOf("ECONNRESET")&&w.emit("error",e,o)}),a.on("clientError",function(e){w.emit("error",e,o),!o.isSent&&o.callback&&o.callback(e)}),a.on("connect",function(){r.secure||o._send(a,r)}),o},n.prototype.switchToTLS=function(e,r){var t=this;t.tls=!0,e.removeAllListeners("data"),e.removeAllListeners("error"),e.removeAllListeners("clientError");var n=framework_utils.copy(r.tls,{socket:e,host:e.$host,ciphers:"SSLv3"}),o=l.connect(n,function(){t._send(this,r,!0);
});o.on("error",function(e){o.destroy(),t.closed=!0,!t.isSent&&t.callback&&t.callback(e),-1===e.stack.indexOf("ECONNRESET")&&w.emit("error",e,t)}),o.on("clientError",function(e){w.emit("error",e,t),!t.isSent&&t.callback&&t.callback(e)}),o.on("connect",function(){r.secure||t._send(o,r)})},n.prototype._send=function(e,r,t){var n=this,c="",l=[],f=[],p=i(n.addressFrom.address),d=new Date,m="--totaljs"+d.getTime(),g=!1,y=!1,b="",E=[],k=null,S=null,_=!1,T=function(r){n.closed||(w.debug&&console.log("SEND",r),e.write(r+h))},O=!r.tls||n.tls&&r.tls;if(O&&w.emit("send",n),e.setTimeout(r.timeout||5e3,function(){n.closed=!0;var r=new Error(framework_utils.httpStatus(408));w.emit("error",r,n),null!==e&&e.destroy(),e=null,!n.isSent&&n.callback&&n.callback(r)}),e.setEncoding("utf8"),O){l.push("MAIL FROM: <"+n.addressFrom.address+">"),f.push("Message-ID: <"+a()+"@WIN-"+s()+">"),f.push("MIME-Version: 1.0"),f.push("From: "+(n.addressFrom.name?u(n.addressFrom.name)+" <"+n.addressFrom.address+">":n.addressFrom.address));var N;if(n.headers)for(var x=Object.keys(n.headers),C=0,N=x.length;N>C;C++)f.push(x[C]+": "+n.headers[x[C]]);N=n.addressTo.length;var R,A,I="";if(N){for(var C=0;N>C;C++)A=n.addressTo[C],R=A instanceof Object?"<"+A.email+">":"<"+A+">",l.push("RCPT TO: "+R),I+=(I?", ":"")+(A instanceof Object?u(A.name)+" ":"")+R;f.push("To: "+I),I=""}if(N=n.addressCC.length){for(var C=0;N>C;C++)A=n.addressCC[C],R=A instanceof Object?"<"+A.email+">":"<"+A+">",l.push("RCPT TO: "+R),I+=(I?", ":"")+(A instanceof Object?u(A.name)+" ":"")+R;f.push("Cc: "+I),I=""}if(N=n.addressBCC.length)for(var C=0;N>C;C++)l.push("RCPT TO: <"+n.addressBCC[C]+">");if(l.push("DATA"),l.push("QUIT"),l.push(""),f.push("Date: "+d.toUTCString()),f.push("Subject: "+u(n.subject)),N=n.addressReply.length){for(var C=0;N>C;C++)I+=(""!==I?", ":"")+"<"+n.addressReply[C]+">";f.push("Reply-To: "+I),I=""}f.push("Content-Type: multipart/alternative; boundary="+m),f.push(""),f.push("--"+m),f.push("Content-Type: "+(-1!==n.body.indexOf("<")&&-1!==n.body.lastIndexOf(">")?"text/html":"text/plain")+"; charset=utf-8"),f.push("Content-Transfer-Encoding: base64"),f.push(""),f.push(o(new Buffer(n.body.replace(/\r\n/g,"\n").replace(/\n/g,h)).toString("base64"))),N=n.files.length}e.on("end",function(){n.closed=!0,e&&e.destroy()}),e.on("data",function(r){if(!n.closed)for(var t=r.toString().split(h),o=t.length,i=0;o>i;i++){var s=t[i];""!==s&&e&&e.emit("line",s)}}),e.on("line",function(t){t=t.toUpperCase(),w.debug&&console.log("<âââ",t);var o=+t.match(/\d+/)[0];if(250!==o||y||(-1!==t.indexOf("AUTH LOGIN PLAIN")||-1!==t.indexOf("AUTH PLAIN LOGIN")||r.user&&r.password)&&(b="plain",y=!0,-1===t.indexOf("XOAUTH")?(E.push("AUTH LOGIN"),E.push(new Buffer(r.user).toString("base64")),E.push(new Buffer(r.password).toString("base64"))):E.push("AUTH PLAIN "+new Buffer("\x00"+r.user+"\x00"+r.password).toString("base64"))),"-"!==t.substring(3,4))switch(!g&&y&&(g=!0,o=334),o){case 220:if(_)return void n.switchToTLS(e,r);c=_||r.user&&r.password||v.test(t)?"EHLO":"HELO",T(c+" "+p);break;case 221:case 250:case 251:case 235:T(l.shift()),0===l.length&&(n.isSent=!0,w.emit("success",n),n.callback&&n.callback(null),S=setTimeout(function(){null!==e&&e.destroy(),e=null},500));break;case 334:if(!n.tls&&!_&&r.tls)return _=!0,void T("STARTTLS");var i=E.shift();if(void 0===i){k=new Error("Forbidden."),w.emit("error",k,n),!n.isSent&&n.callback&&n.callback(k),null!==e&&e.destroy(),e=null;break}T(i);break;case 354:if(T(f.join(h)),n.files.length)return f=null,void n._writeAttachment(T,m,e);T("--"+m+"--"),T(""),T("."),f=null;break;default:if(400>o)break;k=new Error(t),null!==e&&e.destroy(),e=null,w.emit("error",k,n),!n.isSent&&n.callback&&n.callback(k)}}),t&&T("EHLO "+p)},n.prototype._writeAttachment=function(e,r,t){var n=this,o=n.files.shift();if(void 0===o)return e("--"+r+"--"),e(""),void e(".");var i=o.name,s=d.createReadStream(o.filename,{encoding:"base64"}),a=[],u="dat",c=o.filename.lastIndexOf(".");-1!==c&&(u=o.filename.substring(c+1).toLowerCase());var l="ics"===u;return a.push("--"+r),l||(o.contentId?(a.push('Content-Disposition: inline; filename="'+i+'"'),a.push("Content-ID: <"+o.contentId+">")):a.push('Content-Disposition: attachment; filename="'+i+'"')),a.push("Content-Type: "+framework_utils.getContentType(u)+";"+(l?' charset="utf-8"; method=REQUEST':"")),a.push("Content-Transfer-Encoding: base64"),a.push(h),e(a.join(h)),s.on("data",function(r){for(var t=r.length,n=0,o=0;t>n;)n+=68,n>t&&(n=t),e(r.slice(o,n).toString("base64")),o=n}),s.on("end",function(){e(h),n._writeAttachment(e,r,t)}),n};var w=new r;return e.exports=w,e}({exports:{}}),function(module){function parse_multipart_header(e){var r=new Array(2),t=' name="',n=t.length,o=e.indexOf(t),i="";return-1!==o&&(i=e.substring(o+n,e.indexOf('"',o+n))),i?r[0]=i:r[0]="undefined_"+Math.floor(1e5*Math.random()).toString(),t=' filename="',n=t.length,o=e.indexOf(t),i="",-1!==o&&(i=e.substring(o+n,e.indexOf('"',o+n))),-1!==o&&(i=e.substring(o+n,e.indexOf('"',o+n))),i?r[1]=i:r[1]=null,r}function HttpFile(){this.name,this.filename,this.type,this.path,this.length=0,this.width=0,this.height=0}function compile_autovendor(e){var r=/\n|\s{2,}/g,t=/\s?\{\s{1,}/g,n=/\s?\}\s{1,}/g,o=/\s?\:\s{1,}/g,i=/\s?\;\s{1,}/g,s=/\,\s{1,}/g,a="@#auto-vendor-prefix#@",u=e.startsWith(a);return u?e=e.replace(a,""):(a="/*auto*/",u=-1!==e.indexOf(a),u&&(e=e.replace(a,""))),u&&(e=autoprefixer(e)),e.replace(r,"").replace(t,"{").replace(n,"}").replace(o,":").replace(i,";").replace(s,function(e,r,t){for(var n=r;n>0;n--)if(("'"===t[n]||'"'===t[n])&&":"===t[n-1])return e;return","}).replace(/\s\}/g,"}").replace(/\s\{/g,"{").trim()}function autoprefixer(e){var r=["filter","appearance","column-count","column-gap","column-rule","display","transform","transform-style","transform-origin","transition","user-select","animation","perspective","animation-name","animation-duration","animation-timing-function","animation-delay","animation-iteration-count","animation-direction","animation-play-state","opacity","background","background-image","font-smoothing","text-size-adjust","backface-visibility","box-sizing","overflow-scrolling"];e=autoprefixer_keyframes(e);for(var t,n=[],o=0,i=0;i<r.length;i++)for(t=r[i],o=0;-1!==o;)if(o=e.indexOf(t,o+1),-1!==o){var s=e.indexOf(";",o),a=e.indexOf("}",o),u=Math.min(s,a);if(-1===u&&(u=Math.max(s,a)),-1!==u){var c="-"===e.substring(o-1,o);if(!c){var l=e.substring(o,u);u=l.indexOf(":"),-1!==u&&l.substring(0,u+1).replace(/\s/g,"")===t+":"&&n.push({name:t,property:l})}}}for(var f=[],p=n.length,i=0;p>i;i++){var d=n[i].name;t=n[i].property;var m=t,h=";",g=m+h;if("opacity"!==d)if("background"!==d&&"background-image"!==d)if("text-overflow"!==d)if("display"!==d)g+="-webkit-"+m+h,g+="-moz-"+m,-1===d.indexOf("animation")&&(g+=h+"-ms-"+m),g+=h+"-o-"+m,e=e.replacer(t,"@[["+f.length+"]]"),f.push(g);else{if(-1===t.indexOf("box"))continue;g=m+h,g+=m.replacer("box","-webkit-box")+h,g+=m.replacer("box","-moz-box"),e=e.replacer(t,"@[["+f.length+"]]"),f.push(g)}else g=m+h,g+=m.replacer("text-overflow","-ms-text-overflow"),e=e.replacer(t,"@[["+f.length+"]]"),f.push(g);else{if(-1===t.indexOf("linear-gradient"))continue;g=m.replacer("linear-","-webkit-linear-")+h,g+=m.replacer("linear-","-moz-linear-")+h,g+=m.replacer("linear-","-o-linear-")+h,g+=m.replacer("linear-","-ms-linear-")+h,g+=m,e=e.replacer(t,"@[["+f.length+"]]"),f.push(g)}else{var v=+m.replace("opacity","").replace(":","").replace(/\s/g,"");if(isNaN(v))continue;g+="filter:alpha(opacity="+Math.floor(100*v)+")",e=e.replacer(t,"@[["+f.length+"]]"),f.push(g)}}p=f.length;for(var i=0;p>i;i++)e=e.replacer("@[["+i+"]]",f[i]);return f=null,n=null,r=null,e}function autoprefixer_keyframes(e){for(var r=[],t=0;-1!==t;)if(t=e.indexOf("@keyframes",t+1),-1!==t){for(var n=0,o=-1,i=t+10;i<e.length;i++)if("{"===e[i]&&n++,"}"===e[i]){if(!(n>1)){o=i;break}n--}if(-1!==o){var s=e.substring(t,o+1);r.push({name:"keyframes",property:s})}}for(var a=[],u=r.length,c=0;u>c;c++){var l=r[c].name,f=r[c].property;if("keyframes"===l){var p=f.substring(1),d="\n",m="@"+p+d;m+="@-webkit-"+p+d,m+="@-moz-"+p+d,m+="@-o-"+p+d,e=e.replacer(f,"@[["+a.length+"]]"),a.push(m)}}u=a.length;for(var c=0;u>c;c++)e=e.replace("@[["+c+"]]",a[c]);return r=null,a=null,e}function JavaScript(e){function r(){for(u=13,t(3);u!==f;)switch(u){case 32:t(a(l)?1:2);break;case 13:switch(l){case 123:case 91:case 40:case 43:case 45:t(1);break;case 32:t(3);break;default:t(a(l)?1:2)}break;default:switch(l){case 32:if(a(u)){t(1);break}t(3);break;case 13:switch(u){case 125:case 93:case 41:case 43:case 45:case 34:case 92:t(1);break;default:t(a(u)?1:3)}break;default:t(1)}}}function t(e){if(1>=e&&s(u),2>=e&&(u=l,39===u||34===u))for(;s(u),u=i(),u!==l;){if(13>=u)return void(framework&&framework.error("Error: JSMIN unterminated string literal: "+u,"JavaScript compressor"));92===u&&(s(u),u=i())}if(3>=e&&(l=n(),47===l&&(40===u||44===u||61===u||91===u||33===u||58===u||38===u||124===u||63===u||123===u||125===u||59===u||13===u))){for(s(u),s(l);u=i(),47!==u;){if(92===u)s(u),u=i();else if(13>=u)return void(c=f);s(u)}l=n()}}function n(){var e=i();if(47!==e)return e;switch(o()){case 47:for(;;)if(e=i(),13>=e)return e;break;case 42:for(i();;)switch(i()){case 42:if(47===o())return i(),32;break;case f:return void(e=f)}break;default:return e}return e}function o(){return d=i()}function i(){var r=d;return d=f,r===f&&(r=e.charCodeAt(m++),isNaN(r)&&(r=f)),r>=32||13===r||r===f?r:10===r?13:32}function s(e){13===e||10===e?p.push(" "):p.push(String.fromCharCode(e))}function a(e){return e>=97&&122>=e||e>=48&&57>=e||e>=65&&90>=e||95===e||36===e||92===e||e>126}var u,l,f=-1,p=[],d=f,m=0;return r(),p.join("")}function MultipartParser(){this.boundary=null,this.boundaryChars=null,this.lookbehind=null,this.state=S.PARSER_UNINITIALIZED,this.index=null,this.flags=0}function view_parse_localization(e,r){var t=!1;if(e=e.replace(/@\{notranslate\}/gi,function(e){return t=!0,""}).trim(),t)return e;var n=view_find_localization(e,0),o="",i=0;if(null===n)return e;for(;null!==n;)null!==n&&(o+=e.substring(0===i?0:i+1,n.beg)+framework.translate(r,n.command)),i=n.end,n=view_find_localization(e,n.end);return o+=e.substring(i+1)}function view_parse(content,minify,filename){function escaper(e){var r=e.match(/[^\>]\n\s{1,}$/);return nocompressHTML?isFirst||(isFirst=!0,e=e.replace(/^\s+/,"")):e=compressHTML(e,minify),""===e?"$EMPTY":(!nocompressHTML&&r&&(e+=" "),null!==e.match(/\n|\r|\'|\\/)?DELIMITER_UNESCAPE+escape(e)+DELIMITER_UNESCAPE_END:DELIMITER+e+DELIMITER)}minify&&(content=removeComments(content));var nocompressHTML=!1,nocompressJS=!1,nocompressCSS=!1;content=content.replace(/@\{nocompress\s\w+}/gi,function(e){var r=e.lastIndexOf(" ");if(-1===r)return"";switch(e.substring(r,e.length-1).trim()){case"all":nocompressHTML=!0,nocompressJS=!0,nocompressCSS=!0;break;case"html":nocompressHTML=!0;break;case"js":case"script":case"javascript":nocompressJS=!0;break;case"css":case"style":nocompressCSS=!0}return""}).trim(),nocompressJS||(content=compressJS(content,0,filename)),nocompressCSS||(content=compressCSS(content,0,filename)),content=framework._version_prepare(content);var DELIMITER="'",DELIMITER_UNESCAPE="unescape('",DELIMITER_UNESCAPE_END="')",SPACE=" ",builder="var $EMPTY='';var $length=0;var $source=null;var $tmp=index;var $output=$EMPTY",command=view_find_command(content,0),compressed="",nocompress=!1,isFirst=!1,pharse="";null===command&&(builder+="+"+escaper(content));for(var old=null,newCommand="",tmp="",index=0,counter=0,functions=[],functionsName=[],isFN=!1,isSECTION=!1,isCOMPILATION=!1,builderTMP="",sectionName="",compileName="",isSitemap=!1,text;null!==command;){null!==old?(text=content.substring(old.end+1,command.beg),""!==text&&(view_parse_plus(builder)&&(builder+="+"),builder+=escaper(text))):(text=content.substring(0,command.beg),""!==text&&(view_parse_plus(builder)&&(builder+="+"),builder+=escaper(text)));var cmd=content.substring(command.beg+2,command.end),cmd8=cmd.substring(0,8),cmd7=cmd.substring(0,7);cmd=cmd.replace(/helpers\.[a-z0-9A-Z_$]+\(.*?\)+/g,function(e){var r=e.indexOf("(");return-1===r?e:e.substring(0,r)+".call(self, "+e.substring(r+1)}),pharse=cmd,"compile"===cmd7&&-1===cmd.lastIndexOf(")")?(builderTMP=builder+"+(framework.onCompileView.call(self,'"+(" "===cmd8[7]?cmd.substring(8):"")+"',",builder="",sectionName=cmd.substring(8),isCOMPILATION=!0,isFN=!0):"section "===cmd8&&-1===cmd.lastIndexOf(")")?(builderTMP=builder,builder="+(function(){var $output=$EMPTY",sectionName=cmd.substring(8),isSECTION=!0,isFN=!0):"helper "===cmd7?(builderTMP=builder,builder="function "+cmd.substring(7).trim()+"{var $output=$EMPTY",isFN=!0,functionsName.push(cmd.substring(7,cmd.indexOf("(",7)).trim())):"foreach "===cmd8?(counter++,-1!==cmd.indexOf("foreach var ")&&(cmd=cmd.replace(" var ",SPACE)),newCommand=(cmd.substring(8,cmd.indexOf(SPACE,8))||"").trim(),index=cmd.trim().indexOf(SPACE,newCommand.length+10),-1===index&&(index=cmd.indexOf("[",newCommand.length+10)),builder+="+(function(){var $source="+cmd.substring(index).trim()+";if (!($source instanceof Array) || !source.length)return $EMPTY;var $length=$source.length;var $output=$EMPTY;var index=0;for(var i=0;i<$length;i++){index = i;var "+newCommand+"=$source[i];$output+=$EMPTY"):"end"===cmd?isFN&&0>=counter?(counter=0,isCOMPILATION?(builder=builderTMP+"unescape($EMPTY"+builder+"),model) || $EMPTY)",builderTMP=""):isSECTION?(builder=builderTMP+builder+";repository['$section_"+sectionName+"']=$output;return $EMPTY})()",builderTMP=""):(builder+=";return $output;}",functions.push(builder),builder=builderTMP,builderTMP=""),isSECTION=!1,isCOMPILATION=!1,isFN=!1):(counter--,builder+="}return $output;})()",newCommand=""):"if "===cmd.substring(0,3)?builder+=";if ("+cmd.substring(3)+"){$output+=$EMPTY":"else if"===cmd7?builder+="} else if ("+cmd.substring(7)+") {$output+=$EMPTY":"else"===cmd?builder+="} else {$output+=$EMPTY":"endif"===cmd||"fi"===cmd?builder+="}$output+=$EMPTY":(tmp=view_prepare(command.command,newCommand,functionsName,function(){nocompress=!0}),tmp&&(view_parse_plus(builder)&&(builder+="+"),builder+=wrapTryCatch(tmp,command.command,command.line))),old=command,command=view_find_command(content,command.end),command&&command.command&&-1!==command.command.indexOf("sitemap(")&&(isSitemap=!0)}null!==old&&(text=content.substring(old.end+1),text&&(builder+="+"+escaper(text)));var fn="(function(self,repository,model,session,query,body,url,global,helpers,user,config,functions,index,output,date,cookie,files,mobile){var get=query;var post=body;var theme=this.themeName;var language=this.language;var cookie=function(name){return controller.req.cookie(name);};"+(isSitemap?"var sitemap=function(){return self.sitemap.apply(self,arguments);};":"")+(functions.length?functions.join("")+";":"")+"var controller=self;"+builder+";return $output;})";return eval(fn)}function wrapTryCatch(e,r,t){return framework.isDebug?"(function(){try{return "+e+"}catch(e){throw new Error(unescape('"+escape(r)+"') + ' - Line: "+t+" - ' + e.message.toString());}return $EMPTY})()":e}function view_parse_plus(e){var r=e[e.length-1];return"!"!==r&&"?"!==r&&"+"!==r&&"."!==r&&":"!==r?!0:!1}function view_prepare(e,r,t){var n=e.indexOf("."),o=e.indexOf("("),i=e.indexOf("["),s=[],a=0;-1!==n&&s.push(n),-1!==o&&s.push(o),-1!==i&&s.push(i);var u=Math.min.apply(this,s);-1===u&&(u=e.length);var c=e.substring(0,u);if(c===r)return"$STRING("+e+").encode()";if("!"===c[0]&&c.substring(1)===r)return"$STRING("+e.substring(1)+")";switch(c){case"foreach":case"end":return"";case"section":return a=e.indexOf("("),-1===a?"":"(repository['$section_"+e.substring(a+1,e.length-1).replace(/\'|\"/g,"")+"'] || '')";case"log":case"LOG":return"("+("log"===c?"framework.":"")+e+"?$EMPTY:$EMPTY)";case"logger":case"LOGGER":return"("+("logger"===c?"framework.":"")+e+"?$EMPTY:$EMPTY)";case"console":return"("+e+"?$EMPTY:$EMPTY)";case"cookie":return"$STRING("+e+").encode()";case"!cookie":return"$STRING("+e+")";case"isomorphic":return"$STRING("+e+").encode()";case"!isomorphic":return"$STRING("+e+")";case"model":case"repository":case"get":case"post":case"query":case"global":case"session":case"user":case"config":case"controller":return view_is_assign(e)?"self.$set("+e+")":"$STRING("+e+").encode()";case"body":return view_is_assign(e)?"self.$set("+e+")":-1===e.lastIndexOf(".")?"output":"$STRING("+e+").encode()";case"files":return e;case"mobile":return e;case"CONFIG":case"FUNCTION":case"MODEL":case"SCHEMA":case"MODULE":case"functions":return"$STRING("+e+").encode()";case"!controller":case"!repository":case"!get":case"!post":case"!body":case"!query":case"!global":case"!session":case"!user":case"!config":case"!functions":case"!model":case"!CONFIG":case"!SCHEMA":case"!FUNCTION":case"!MODEL":case"!MODULE":return"$STRING("+e.substring(1)+")";case"language":return e;case"resource":case"RESOURCE":return"$STRING(self."+e+").encode()";case"!resource":case"!RESOURCE":return"$STRING(self."+e.substring(1)+")";case"host":case"hostname":return-1===e.indexOf("(")?"self.host()":"self."+e;case"url":return-1!==e.indexOf("(")?"self.$"+e:"self."+e;case"title":case"description":case"keywords":return-1!==e.indexOf("(")?"self.$"+e:"(repository['$"+e+"'] || '').toString().encode()";case"!title":case"!description":case"!keywords":return"(repository['$"+e.substring(1)+"'] || '')";case"head":return-1!==e.indexOf("(")?"self.$"+e:"self."+e+"()";case"sitemap":case"place":return-1!==e.indexOf("(")?"self.$"+e:"(repository['$"+e+"'] || '')";case"meta":return-1!==e.indexOf("(")?"self.$"+e:"self.$meta()";case"js":case"script":case"css":case"favicon":case"import":return"self.$"+e+(-1===e.indexOf("(")?"()":"");case"index":return"("+e+")";case"routeJS":case"routeCSS":case"routeScript":case"routeStyle":case"routeImage":case"routeFont":case"routeDownload":case"routeVideo":case"routeStatic":return"self."+e;case"translate":case"TRANSLATE":return"self."+e.toLowerCase();case"json":case"image":case"layout":case"template":case"templateToggle":case"view":case"viewToggle":case"helper":case"download":case"selected":case"currentContent":case"currentCSS":case"currentDownload":case"currentImage":case"currentJS":case"currentTemplate":case"currentVideo":case"currentView":case"disabled":case"checked":case"etag":case"header":case"modified":case"options":case"readonly":case"canonical":case"dns":case"next":case"prefetch":case"prerender":case"prev":return"self.$"+e;case"now":return"(new Date()"+e.substring(3)+")";case"radio":case"text":case"checkbox":case"hidden":case"textarea":case"password":return"self.$"+exports.appendModel(e);default:return framework.helpers[c]?"helpers."+view_insert_call(e):"$STRING("+(-1===t.indexOf(c)?"!"===e[0]?e.substring(1)+")":e+").encode()":e+")")}return e}function view_insert_call(e){var r=e.indexOf("(");if(-1===r)return e;for(var t=e.length,n=0,o=r+1;t>o;o++){var i=e[o];if("("===i||")"===i)if("("!==i){if(!(n>0)){var s=e.substring(r+1);return e.substring(0,r)+".call(self"+(s.length>1?","+s:")")}n--}else n++}return e}function view_is_assign(e){for(var r=e.length,t=0,n=0;r>n;n++){var o=e[n];if("["!==o)if("]"!==o){var i=e[n+1]||"";if("+"===o&&("+"===i||"="===i)&&0===t)return!0;if("-"===o&&("-"===i||"="===i)&&0===t)return!0;if("*"===o&&("*"===i||"="===i)&&0===t)return!0;if("="===o&&0===t)return!0}else t--;else t++}return!1}function view_find_command(e,r){if(r=e.indexOf("@{",r),-1===r)return null;for(var t=e.length,n=0,o=r+2;t>o;o++){var i=e[o];if("{"!==i){if("}"===i){if(!(n>0))return{beg:r,end:o,line:view_line_counter(e.substr(0,r)),command:e.substring(r+2,o).trim()};n--}}else n++}return null}function view_line_counter(e){var r=e.match(/\n/g);return r?r.length:0}function view_find_localization(e,r){if(r=e.indexOf("@(",r),-1===r)return null;for(var t=e.length,n=0,o=r+2;t>o;o++){var i=e[o];if("("!==i){if(")"===i){if(!(n>0))return{beg:r,end:o,command:e.substring(r+2,o).trim()};n--}}else n++}return null}function removeCondition(e,r){if(r){if("+"===e[0])return e.substring(1,e.length)}else if("+"===e[e.length-1])return e.substring(0,e.length-1);return e}function removeComments(e){for(var r="<!--",t="-->",n=e.indexOf(r),o=0;-1!==n&&(o=e.indexOf(t,n+4),-1!==o);){var i=e.substring(n,o+3);-1===i.indexOf("[if")&&-1===i.indexOf("[endif")?(e=e.replacer(i,""),n=e.indexOf(r,o+3)):n=e.indexOf(r,o+3)}return e}function compressJS(e,r,t){if(!framework.config["allow-compile-script"])return e;var n='<script type="text/javascript">',o="</script>",i=e.indexOf(n,r||0);if(-1===i&&(n="<script>",i=e.indexOf(n,r||0),-1===i))return e;var s=e.indexOf(o,i+n.length);if(-1===s)return e;var a=e.substring(i,s+o.length).trim(),u=e.indexOf(a);if(-1===u)return e;var c=a.substring(n.length,a.length-o.length).trim(),l=exports.compile_javascript(c,t);return e=e.replacer(a,n+l.dollar().trim()+o.trim()),compressJS(e,i+l.length+9,t)}function compressCSS(e,r,t){var n='<style type="text/css">',o="</style>",i=e.indexOf(n,r||0);if(-1===i&&(n="<style>",i=e.indexOf(n,r||0),-1===i))return e;var s=e.indexOf(o,i+n.length);if(-1===s)return e;var a=e.substring(i,s+o.length),u=a.substring(n.length,a.length-o.length).trim(),c=exports.compile_css(u,t);return e=e.replacer(a,(n+c.trim()+o).trim()),compressCSS(e,i+c.length+8,t)}function variablesCSS(e){if(!e)return e;var r={};return e=e.replace(/\$[a-z0-9-_]+\:.*?;/gi,function(e){var t=e.indexOf(":");if(-1===t)return e;var n=e.substring(0,t).trim();return r[n]=e.substring(t+1,e.length-1).trim(),""}),e=e.replace(/\$[a-z0-9-_]+/gi,function(e,t){var n=(e.length+t,r[e]);return n?n:e}).trim()}function nested(e,r,t){if(!e)return e;for(var n,o,i=0,s="",a=!1,u=0,c=!1,l="",f=!1,p="",d=!1,m="";;){var h=e[i++];if(!h)break;if("/"!==h||"*"!==e[i]){if(d)m+=h,"*"===h&&"/"===e[i]&&(d=!1,i++,"auto*"===m&&(s+="/*auto*/"));else if("\n"!==h&&"\r"!==h)if("$"===h&&t&&t(),"@"===h&&(o=i,f=!0),!f||p||";"!==h&&"{"!==h||(p=h,";"!==h))if(l+=h,"{"!==h){if("}"===h){if(u>0){u--,c=!0;continue}if(!c){s+=l,l="",a=!1,f=!1,p="";continue}if(f){-1!==l.indexOf("@keyframes")?s+=l:(o=l.indexOf("{"),s+=l.substring(0,o+1)+process_nested(l.substring(o),r).trim()+"}"),a=!1,f=!1,p="",l="";continue}for(var g=n-1,v="";;){var y=e[g--];if("{"!==y){if("}"===y||"\n"===y||"\r"===y||void 0===y||p&&p===y)break;v=y+v}}a=!1,f=!1,p="",l="",s+=process_nested(e.substring(n-1,i),(r||"")+v.trim())}}else{if(a){u++;continue}a=!0,u=0,n=i,c=!1}else s+=e.substring(o-1,i),f=!1,l=""}else d=!0,i++,m=""}return s+l}function process_nested(e,r){return e=e.trim(),e=make_nested(e.substring(1,e.length-1),r),nested(e,r)}function make_nested(e,r){for(var t,n=0,o="",i="",s=0,a=!1,u=!1;;){var c=e[n++];if(!c)break;if("\n"!==c&&"\r"!==c)if((" "!==c||" "!==o[o.length-1])&&(o+=c),"{"!==c){if("}"===c){if(s>0){s--,u=!0;continue}if(!u){i+=r+" "+o.trim(),o="",a=!1;continue}i+=o}}else{if(a){s++;continue}a=!0,s=0,t=n,u=!1}}return i}function compressHTML(e,r){if(null===e||""===e||!r)return e;e=removeComments(e);for(var t=["script","textarea","pre","code"],n="["+(new Date).getTime()+"]#",o={},i=0,s=t.length,a=0;s>a;a++)for(var u=t[a],c="<"+u,l="</"+u,f=e.indexOf(c),p=0,d=l.length;-1!==f&&(p=e.indexOf(l,f+3),-1!==p);){var m=n+i++,h=e.substring(f,p+d);if(0===a){if(p=h.indexOf(">"),d=h.indexOf('type="text/template"'),p>d&&-1!==d){f=e.indexOf(c,f+c.length);continue}if(d=h.indexOf('type="text/html"'),p>d&&-1!==d){f=e.indexOf(c,f+c.length);continue}if(d=h.indexOf('type="text/ng-template"'),p>d&&-1!==d){f=e.indexOf(c,f+c.length);continue}}o[m]=h,e=e.replacer(h,m),f=e.indexOf(c,f+c.length)}for(;;){if(!e.match(REG_6))break;e=e.replace(REG_6,function(e){return e.replace(/\s+/g," ")})}e=e.replace(/>\n\s+/g,">").replace(/(\w|\W)\n\s+</g,function(e){return e.trim().replace(/\s/g,"")}).replace(REG_5,"><").replace(REG_4,function(e){var r=e[e.length-1];return"<"===r?r:" "+r}).replace(REG_1,"").replace(REG_2,"");for(var m in o)e=e.replacer(m,o[m]);return e}function viewengine_read(e,r){var t=framework.config,n="."===e[0],o=n?e.substring(1):framework.path.views(e);if(fs.existsSync(o))return view_parse(view_parse_localization(viewengine_modify(fs.readFileSync(o).toString("utf8"),o),r),t["allow-compile-html"],o);if(n)return null;var i=e.lastIndexOf("/");return-1===i?null:(o=framework.path.views(e.substring(i+1)),fs.existsSync(o)?view_parse(view_parse_localization(viewengine_modify(fs.readFileSync(o).toString("utf8"),o),r),t["allow-compile-html"],o):null)}function viewengine_modify(e,r){if(!framework.modificators)return e;for(var t=0,n=framework.modificators.length;n>t;t++){var o=framework.modificators[t]("view",r,e);o&&(e=o)}return e}function viewengine_load(e,r,t){if(void 0===framework.temporary.other[e]&&(framework.temporary.other[e]=-1!==e.indexOf("@{")||-1!==e.indexOf("<")),framework.temporary.other[e])return viewengine_dynamic(e,t);var n=framework.routes.views[e];n?r="."+n.filename:r+=".html";var o="view#"+r;t&&(o+=t);var i=framework.temporary.views[o]||null;return null!==i?i:(i=viewengine_read(r,t),framework.isDebug||(framework.temporary.views[o]=i),i)}function viewengine_dynamic(e,r){var t=e.hash(),n=framework.temporary.views[t]||null;return null!==n?n:(n=view_parse(view_parse_localization(viewengine_modify(e,""),r),framework.config["allow-compile-html"]),framework.isDebug||(framework.temporary.views[t]=n),n)}function cleanURL(e,r){for(var t,n=e.substring(0,r),o=!1,i=r,s=e.length;s>i;i++){var a=e[i];("/"!==a||"/"!==t||o)&&(t=a,n+=a)}return n}function destroyStream(e){return e instanceof ReadStream?(e.destroy(),typeof e.close!==FUNCTION?e:(e.on("open",function(){typeof this.fd===NUMBER&&this.close()}),e)):e instanceof Stream?(typeof e.destroy===FUNCTION&&e.destroy(),e):e}function first(e,r){function t(){n(),r.apply(null,arguments)}function n(){for(var e,r=0,t=i.length;t>r;r++)e=i[r],e.ee.removeListener(e.event,e.fn)}function o(e){r=e}for(var i=[],s=0,a=e.length;a>s;s++)for(var u=e[s],c=u[0],l=1,f=u.length;f>l;l++){var p=u[l],d=listener(p,t);c.on(p,d),i.push({ee:c,event:p,fn:d})}return o.cancel=n,o}function listener(e,r){return function(t){for(var n=new Array(arguments.length),o=this,i="error"===e?t:null,s=0;s<n.length;s++)n[s]=arguments[s];r(i,o,e,n)}}function onFinished(e,r){return isFinished(e)!==!1?(setImmediate(r,null,e),e):(attachListener(e,r),e)}function attachFinishedListener(e,r){function t(e){o.cancel(),i.cancel(),s=!0,r(e)}function n(r){e.removeListener("socket",n),s||o!==i||(i=first([[r,"error","close"]],t))}var o,i,s=!1;return o=i=first([[e,"end","finish"]],t),e.socket?void n(e.socket):(e.on("socket",n),void(void 0===e.socket&&patchAssignSocket(e,n)))}function attachListener(e,r){var t=e.__onFinished;t&&t.queue||(t=e.__onFinished=createListener(e),attachFinishedListener(e,t)),t.queue.push(r)}function createListener(e){function r(t){if(e.__onFinished===r&&(e.__onFinished=null),r.queue){var n=r.queue;r.queue=null;for(var o=0,i=n.length;i>o;o++)n[o](t,e)}}return r.queue=[],r}function patchAssignSocket(e,r){var t=e.assignSocket;typeof t===FUNCTION&&(e.assignSocket=function(e){t.call(this,e),r(e)})}function isFinished(e){var r=e.socket;return typeof e.finished===BOOLEAN?Boolean(e.finished||r&&!r.writable):typeof e.complete===BOOLEAN?Boolean(e.upgrade||!r||!r.readable||e.complete&&!e.readable):void 0}var exports=module.exports;global.framework_internal=module.exports;var crypto=require("crypto"),fs=require("fs"),ReadStream=require("fs").ReadStream,Stream=require("stream"),ENCODING="utf8",UNDEFINED="undefined",FUNCTION="function",OBJECT="object",BOOLEAN="boolean",NUMBER="number",REG_1=/[\n\r\t]+/g,REG_2=/\s{2,}/g,REG_3=/\/{1,}/g,REG_4=/\n\s{2,}./g,REG_5=/>\n\s{1,}</g,REG_6=/[\<\w\"\u0080-\u07ff\u0400-\u04FF]+\s{2,}[\w\u0080-\u07ff\u0400-\u04FF\>]+/,REG_BLOCK_BEG=/\@\{block.*?\}/gi,REG_BLOCK_END=/\@\{end\}/gi,HTTPVERBS={GET:!0,POST:!0,OPTIONS:!0,PUT:!0,DELETE:!0,PATCH:!0,upload:!0,HEAD:!0,TRACE:!0,PROPFIND:!0};global.$STRING=function(e){return null===e||void 0===e?"":e.toString()},exports.parseMULTIPART=function(e,r,t,n,o){for(var i,s=new MultipartParser,a=r.split(";")[1],u=0,c=null,l=t.length,f=Date.now(),p=0,d=null,m="",h=0,g=e.ip.length;g>h;h++)"."!==e.ip[h]&&":"!==e.ip[h]&&(m+=e.ip[h]);a=a.substring(a.indexOf("=",2)+1),e.buffer_exceeded=!1,e.buffer_has=!0,s.initWithBoundary(a),s.onPartBegin=function(){i=new HttpFile,i.$data=new Buffer(""),i.$step=0,i.$is=!1,i.length=0},s.onHeaderValue=function(r,t,o){if(!e.buffer_exceeded){var s=r.slice(t,o).toString(ENCODING);if(1===i.$step){var a=s.indexOf(";");return-1===a?i.type=s.trim():i.type=s.substring(0,a).trim(),void(i.$step=2)}if(0===i.$step){if(s=parse_multipart_header(s),i.$step=1,i.$is=null!==s[1],i.name=s[0],!i.$is)return void destroyStream(c);i.filename=s[1],i.path=framework_utils.combine(n,m+"-"+f+"-"+framework_utils.random(1e5)+".upload"),c=fs.createWriteStream(i.path,{flags:"w"}),c.once("close",function(){p--}),c.once("error",function(){p--}),p++}}},s.onPartData=function(r,t,n){if(!e.buffer_exceeded){var o=r.slice(t,n),s=o.length;if(u+=s,u>=l)return e.buffer_exceeded=!0,void(null===d?d=[i.path]:d.push(i.path));if(!i.$is)return void(i.$data=Buffer.concat([i.$data,o]));if(i.length)return c.write(o),void(i.length+=s);var a=null;if(!e.behaviour("disable-measuring"))switch(i.type){case"image/jpeg":a=framework_image.measureJPG(r.slice(t));break;case"image/gif":a=framework_image.measureGIF(o);break;case"image/png":a=framework_image.measurePNG(o);break;case"image/svg+xml":a=framework_image.measureSVG(o)}a?(i.width=a.width,i.height=a.height):(i.width=0,i.height=0),framework.emit("upload-begin",e,i),c.write(o),i.length+=s}},s.onPartEnd=function(){if(null!==c&&(c.end(),c=null),!e.buffer_exceeded){if(i.$is)return delete i.$data,delete i.$is,delete i.$step,e.files.push(i),void framework.emit("upload-end",e,i);i.$data=i.$data.toString(ENCODING);var r=e.body[i.name];if(void 0===r)return void(e.body[i.name]=i.$data);if(r instanceof Array)return void e.body[i.name].push(i.$data);r=[r],r.push(i.$data),e.body[i.name]=r}},s.onEnd=function(){var e=function(){return p>0?void setImmediate(e):(null!==d&&framework.unlink(d),void o.doEnd())};e()},e.on("data",function(e){s.write(e)}),e.on("end",function(){s.end()})},exports.routeSplit=function(e,r){var t;if(!r&&(t=framework.temporary.other[e]))return t;if(!e||"/"===e)return t=new Array(1),t[0]="/",t;var n=!1,o="",i=0;t=[];for(var s=0,a=e.length;a>s;s++){var u=e[s];if("/"!==u)o+=r?u:u.toLowerCase(),n="/"===u;else{if(n)continue;o&&(t.push(o),i++,o="")}}return o?t.push(o):0===i&&t.push("/"),t},exports.routeSplitCreate=function(e,r){r||(e=e.toLowerCase()),"/"===e[0]&&(e=e.substring(1)),"/"===e[e.length-1]&&(e=e.substring(0,e.length-1));for(var t=0,n=0,o=[],i=0,s=e.length;s>i;i++)switch(e[i]){case"/":if(0!==t)break;o.push(e.substring(n+(o.length?1:0),i)),n=i;break;case"{":t++;break;case"}":t--}return 0===t&&o.push(e.substring(n+(o.length?1:0),e.length)),1===o.length&&""===o[0]&&(o[0]="/"),o},exports.routeCompare=function(e,r,t,n){var o=e.length,i=r.length;if(i!==o&&!n)return!1;if(n&&1===i&&"/"===r[0])return!0;for(var s=1===o&&"/"===e[0],a=0;o>a;a++){var u=r[a];if(!t&&n&&void 0===u)return!0;if((t||s||"{"!==u[0])&&e[a]!==u)return t?!1:n?a>=i:!1}return!0},exports.routeCompareSubdomain=function(e,r){return null!==r&&null!==e&&r.length?r.indexOf(e)>-1:!0},exports.routeCompareFlags=function(e,r,t){for(var n=!1,o=e,i=r,s=e.length,a=r.length,u=s>a?o:i,c=s>a?i:o,l=Math.max(s,a),f="authorize",p="unauthorize",d=0;l>d;d++){var m=u[d],h=m[0];if("!"!==h&&"#"!==h&&"$"!==h&&"@"!==h&&"+"!==h&&(!t||m!==f&&m!==p)){var g=c.indexOf(m),v=m.toUpperCase();if(-1===g&&!HTTPVERBS[v])return m===f||m===p?-1:0;n=n||-1!==g&&HTTPVERBS[v]}}return n?1:0},exports.routeCompareFlags2=function(e,r,t){if(!r.isWEBSOCKET){if(r.isXHR&&!e.xhr)return 0;if(r.isMOBILE&&!e.mobile)return 0;var n=e.method;if(r.method){if(r.method!==n)return 0}else if(-1===r.flags.indexOf(n.toLowerCase()))return 0;if(r.isREFERER&&-1===e.flags.indexOf("referer"))return 0;if(!r.isMULTIPLE&&r.isJSON&&-1===e.flags.indexOf("json"))return 0}for(var o=!1,i=0,s=e.flags.length;s>i;i++){var a=e.flags[i];switch(a){case"json":continue;case"xml":if(r.isRAW||r.isXML)continue;return 0;case"proxy":
if(!r.isPROXY)return 0;continue;case"debug":if(!r.isDEBUG&&r.isRELEASE)return 0;continue;case"release":if(!r.isRELEASE&&r.isDEBUG)return 0;continue;case"referer":continue;case"upload":if(!r.isUPLOAD)return 0;continue;case"https":if(!r.isHTTPS&&r.isHTTP)return 0;continue;case"http":if(!r.isHTTP&&r.isHTTPS)return 0;continue;case"xhr":case"+xhr":if(!r.isBOTH&&!r.isXHR)return 0;continue}if(t&&r.isMEMBER){var u=a.substring(0,3);if(!r.isGET&&"aut"!==u&&"una"!==u&&-1===r.flags.indexOf(a))return 0}else{var c="@"===a[0];if(!c||!o){var l=r.flags.indexOf(a);if(-1===l)return r.isMEMBER?0:-1;c&&(o=!0)}}}return 1},exports.routeParam=function(e,r){if(!r||!e)return new Array(0);var t=r.param.length,n=new Array(t);if(0===t)return n;for(var o=0;t>o;o++){var i=e[r.param[o]];n[o]="/"===i?"":i}return n},HttpFile.prototype={get contentType(){return console.log("OBSOLETE: The HttpFile.contentType is deprecated. Use: HttpFile.type"),this.type}},HttpFile.prototype.copy=function(e,r){var t=this;if(!r)return void fs.createReadStream(t.path).pipe(fs.createWriteStream(e));var n=fs.createReadStream(t.path),o=fs.createWriteStream(e);return n.on("close",r),n.pipe(o),t},HttpFile.prototype.$$copy=function(e){var r=this;return function(t){return r.copy(e,t)}},HttpFile.prototype.readSync=function(){return fs.readFileSync(this.path)},HttpFile.prototype.read=function(e){var r=this;return fs.readFile(r.path,e),r},HttpFile.prototype.$$read=function(){var e=this;return function(r){e.read(r)}},HttpFile.prototype.md5=function(e){var r=this,t=crypto.createHash("md5"),n=fs.createReadStream(r.path);return n.on("data",function(e){t.update(e)}),n.on("error",function(r){e(r,null)}),onFinished(n,function(){destroyStream(n),e(null,t.digest("hex"))}),r},HttpFile.prototype.$$md5=function(){var e=this;return function(r){e.md5(r)}},HttpFile.prototype.stream=function(e){var r=this;return fs.createReadStream(r.path,e)},HttpFile.prototype.pipe=function(e,r){var t=this;return fs.createReadStream(t.path,r).pipe(e,r)},HttpFile.prototype.isImage=function(){var e=this;return-1!==e.type.indexOf("image/")},HttpFile.prototype.isVideo=function(){var e=this;return-1!==e.type.indexOf("video/")},HttpFile.prototype.isAudio=function(){var e=this;return-1!==e.type.indexOf("audio/")},HttpFile.prototype.image=function(e){var r=e;return void 0===r&&(r="im"===framework.config["default-image-converter"]),framework_image.init(this.path,r,this.width,this.height)},exports.compile_css=function(e,r){if(global.framework){if(framework.modificators)for(var t=0,n=framework.modificators.length;n>t;t++){var o=framework.modificators[t]("style",r,e);o&&(e=o)}if(null!==framework.onCompileStyle)return framework.onCompileStyle(r,e);if(null!==framework.onCompileCSS)return console.log("OBSOLETE: framework.onCompileCSS() is deprecated, use framework.onCompileStyle()"),framework.onCompileCSS(r,e)}try{var i=!1;return e=nested(e,"",function(){i=!0}),e=compile_autovendor(e),i&&(e=variablesCSS(e)),e}catch(s){return framework.error(new Error("CSS compiler exception: "+s.message)),""}},exports.compile_javascript=function(e,r){var t=typeof global.framework===OBJECT;try{if(t){if(framework.modificators)for(var n=0,o=framework.modificators.length;o>n;n++){var i=framework.modificators[n]("script",r,e);i&&(e=i)}if(null!==framework.onCompileScript)return framework.onCompileScript(r,e).trim();if(null!==framework.onCompileJS)return console.log("OBSOLETE: framework.onCompileJS() is deprecated, use framework.onCompileScript()"),framework.onCompileJS(r,e).trim()}return JavaScript(e).trim()}catch(s){return t&&framework.error(s,"JavaScript compressor"),e}},exports.compile_html=function(e,r){return compressCSS(compressJS(compressHTML(e,!0),0,r),0,r)};var Buffer=require("buffer").Buffer,s=0,S={PARSER_UNINITIALIZED:s++,START:s++,START_BOUNDARY:s++,HEADER_FIELD_START:s++,HEADER_FIELD:s++,HEADER_VALUE_START:s++,HEADER_VALUE:s++,HEADER_VALUE_ALMOST_DONE:s++,HEADERS_ALMOST_DONE:s++,PART_DATA_START:s++,PART_DATA:s++,PART_END:s++,END:s++},f=1,F={PART_BOUNDARY:f,LAST_BOUNDARY:f*=2},LF=10,CR=13,SPACE=32,HYPHEN=45,COLON=58,A=97,Z=122,lower=function(e){return 32|e};for(s in S)exports[s]=S[s];return exports.MultipartParser=MultipartParser,MultipartParser.stateToString=function(e){for(var r in S){var t=S[r];if(t===e)return r}},MultipartParser.prototype.initWithBoundary=function(e){var r=this;r.boundary=new Buffer(e.length+4),framework.versionNode>0?(r.boundary.write("\r\n--",0,"ascii"),r.boundary.write(e,4,"ascii")):(r.boundary.write("\r\n--","ascii",0),r.boundary.write(e,"ascii",4)),r.lookbehind=new Buffer(r.boundary.length+8),r.state=S.START,r.boundaryChars={};for(var t=0;t<r.boundary.length;t++)r.boundaryChars[r.boundary[t]]=!0},MultipartParser.prototype.write=function(e){var r,t,n=this,o=0,i=e.length,s=n.index,a=n.index,u=n.state,c=n.flags,l=n.lookbehind,f=n.boundary,p=n.boundaryChars,d=n.boundary.length,m=d-1,h=e.length,g=function(e){n[e+"Mark"]=o},v=function(e){delete n[e+"Mark"]},y=function(e,r,t,o){if(void 0===t||t!==o){var i="on"+e.substr(0,1).toUpperCase()+e.substr(1);i in n&&n[i](r,t,o)}},w=function(r,t){var i=r+"Mark";i in n&&(t?(y(r,e,n[i],o),delete n[i]):(y(r,e,n[i],e.length),n[i]=0))};for(o=0;i>o;o++)switch(r=e[o],u){case S.PARSER_UNINITIALIZED:return o;case S.START:a=0,u=S.START_BOUNDARY;case S.START_BOUNDARY:if(a==f.length-2){if(r==HYPHEN)c|=F.LAST_BOUNDARY;else if(r!=CR)return o;a++;break}if(a-1==f.length-2){if(c&F.LAST_BOUNDARY&&r==HYPHEN)y("end"),u=S.END,c=0;else{if(c&F.LAST_BOUNDARY||r!=LF)return o;a=0,y("partBegin"),u=S.HEADER_FIELD_START}break}r!=f[a+2]&&(a=-2),r==f[a+2]&&a++;break;case S.HEADER_FIELD_START:u=S.HEADER_FIELD,g("headerField"),a=0;case S.HEADER_FIELD:if(r==CR){v("headerField"),u=S.HEADERS_ALMOST_DONE;break}if(a++,r==HYPHEN)break;if(r==COLON){if(1==a)return o;w("headerField",!0),u=S.HEADER_VALUE_START;break}if(t=lower(r),A>t||t>Z)return o;break;case S.HEADER_VALUE_START:if(r==SPACE)break;g("headerValue"),u=S.HEADER_VALUE;case S.HEADER_VALUE:r==CR&&(w("headerValue",!0),y("headerEnd"),u=S.HEADER_VALUE_ALMOST_DONE);break;case S.HEADER_VALUE_ALMOST_DONE:if(r!=LF)return o;u=S.HEADER_FIELD_START;break;case S.HEADERS_ALMOST_DONE:if(r!=LF)return o;y("headersEnd"),u=S.PART_DATA_START;break;case S.PART_DATA_START:u=S.PART_DATA,g("partData");case S.PART_DATA:if(s=a,0===a){for(o+=m;h>o&&!(e[o]in p);)o+=d;o-=m,r=e[o]}if(a<f.length)f[a]==r?(0===a&&w("partData",!0),a++):a=0;else if(a==f.length)a++,r==CR?c|=F.PART_BOUNDARY:r==HYPHEN?c|=F.LAST_BOUNDARY:a=0;else if(a-1==f.length)if(c&F.PART_BOUNDARY){if(a=0,r==LF){c&=~F.PART_BOUNDARY,y("partEnd"),y("partBegin"),u=S.HEADER_FIELD_START;break}}else c&F.LAST_BOUNDARY&&r==HYPHEN?(y("partEnd"),y("end"),u=S.END,c=0):a=0;a>0?l[a-1]=r:s>0&&(y("partData",l,0,s),s=0,g("partData"),o--);break;case S.END:break;default:return o}return w("headerField"),w("headerValue"),w("partData"),n.index=a,n.state=u,n.flags=c,i},MultipartParser.prototype.end=function(){var e=this,r=function(e,r){var t="on"+r.substr(0,1).toUpperCase()+r.substr(1);t in e&&e[t]()};if(e.state==S.HEADER_FIELD_START&&0===e.index||e.state==S.PART_DATA&&e.index==e.boundary.length)r(e,"partEnd"),r(e,"end");else if(e.state!=S.END)return r(e,"partEnd"),r(e,"end"),new Error("MultipartParser.end(): stream ended unexpectedly: "+e.explain())},MultipartParser.prototype.explain=function(){return"state = "+MultipartParser.stateToString(this.state)},exports.viewEngine=viewengine_load,exports.appendModel=function(e){var r=e.indexOf("(");if(-1===r)return e;var t=e.substring(r+1);return e.substring(0,r)+"(model"+(")"===t[0]?t:","+t)},exports.parseURI=function(e,r){var t,n,o=r.host.lastIndexOf(":"),i=r.url.indexOf("?",1),s=null;-1===o?(o=null,t=r.host):(t=r.host.substring(0,o),o=r.host.substring(o+1)),-1===i?(i=null,n=r.url):(n=r.url.substring(0,i),i=r.url.substring(i),s=i.substring(1));var a=n.indexOf("//");return-1!==a&&(n=cleanURL(n,a),r.url=n,i&&(r.url+=i)),{auth:null,hash:null,host:r.host,hostname:t,href:e+"://"+r.host+r.url,path:r.url,pathname:n,port:o,protocol:e+":",query:s,search:i,slashes:!0}},exports.encodeUnicodeURL=function(e){for(var r=e,t=0,n=e.length;n>t;t++){var o=e.charCodeAt(t);o>127&&(r=r.replace(e[t],encodeURIComponent(e[t])))}return r},exports.parseBlock=function(e,r){if(-1===r.search(REG_BLOCK_BEG))return r;var t="\n",n=r.split(t),o=!1,i=!1,s="";e=(e||"").replace(/\s/g,"").split(",");for(var a=0,u=n.length;u>a;a++){var c=n[a];if(c)if(-1===c.search(REG_BLOCK_END))if(o){if(i)continue;s+=c+t}else{var l=c.search(REG_BLOCK_BEG);if(l)if(-1!==l){o=!0,i=!0;for(var f=c.substring(l+8,c.indexOf("}",l)).replace(/\|\|/g,",").replace(/\s/g,"").split(","),p=0,d=f.length;d>p;p++)if(-1!==e.indexOf(f[p])){i=!1;break}}else s+=c+t}else o=!1,i=!1}return s.trim()},exports.parseLocalization=view_parse_localization,exports.findLocalization=view_find_localization,exports.destroyStream=destroyStream,exports.onFinished=onFinished,module}({exports:{}});var qs=require("querystring"),os=require("os"),fs=require("fs"),zlib=require("zlib"),path=require("path"),crypto=require("crypto"),parser=require("url"),events=require("events"),http=require("http"),child=require("child_process"),util=require("util"),ENCODING="utf8",UNDEFINED="undefined",STRING="string",TYPE_FUNCTION="function",NUMBER="number",OBJECT="object",BOOLEAN="boolean",EXTENSION_JS=".js",RESPONSE_HEADER_CACHECONTROL="Cache-Control",RESPONSE_HEADER_CONTENTTYPE="Content-Type",RESPONSE_HEADER_CONTENTLENGTH="Content-Length",CONTENTTYPE_TEXTPLAIN="text/plain",CONTENTTYPE_TEXTHTML="text/html",POWEREDBY="...",REQUEST_COMPRESS_CONTENTTYPE={"text/plain":!0,"text/javascript":!0,"text/css":!0,"application/x-javascript":!0,"application/json":!0,"text/xml":!0,"image/svg+xml":!0,"text/x-markdown":!0,"text/html":!0},TEMPORARY_KEY_REGEX=/\//g,REG_MOBILE=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|Tablet/i,REG_VERSIONS=/(href|src)="[a-zA-Z0-9\/\:\-\.]+\.(jpg|js|css|png|gif|svg|html|ico|json|less|sass|scss|swf|txt|webp|woff|woff2|xls|xlsx|xml|xsl|xslt|zip|rar|csv|doc|docx|eps|gzip|jpe|jpeg|manifest|mov|mp3|mp4|ogg|package|pdf)"/gi,REG_MULTIPART=/\/form\-data$/i,REQUEST_PROXY_FLAGS=["post","json"],RANGE={start:0,end:0},HEADERS={};HEADERS.responseCode={},HEADERS.responseCode[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTPLAIN,HEADERS.responseRedirect={},HEADERS.responseRedirect[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTHTML+"; charset=utf-8",HEADERS.responseRedirect[RESPONSE_HEADER_CONTENTLENGTH]="0",HEADERS.sse={},HEADERS.sse[RESPONSE_HEADER_CACHECONTROL]="no-cache, no-store, must-revalidate",HEADERS.sse.Pragma="no-cache",HEADERS.sse.Expires="0",HEADERS.sse[RESPONSE_HEADER_CONTENTTYPE]="text/event-stream",HEADERS.proxy={},HEADERS.proxy["X-Proxy"]="total.js",HEADERS["responseFile.etag"]={},HEADERS["responseFile.etag"]["Last-Modified"]="Mon, 01 Jan 2001 08:00:00 GMT",HEADERS["responseFile.etag"]["Access-Control-Allow-Origin"]="*",HEADERS["responseFile.etag"][RESPONSE_HEADER_CACHECONTROL]="public, max-age=11111111",HEADERS["responseFile.release.compress"]={},HEADERS["responseFile.release.compress"][RESPONSE_HEADER_CACHECONTROL]="public, max-age=11111111",HEADERS["responseFile.release.compress"].Vary="Accept-Encoding",HEADERS["responseFile.release.compress"]["Access-Control-Allow-Origin"]="*",HEADERS["responseFile.release.compress"]["Last-Modified"]="Mon, 01 Jan 2001 08:00:00 GMT",HEADERS["responseFile.release.compress"]["Content-Encoding"]="gzip",HEADERS["responseFile.release.compress.range"]={},HEADERS["responseFile.release.compress.range"]["Accept-Ranges"]="bytes",HEADERS["responseFile.release.compress.range"][RESPONSE_HEADER_CACHECONTROL]="public, max-age=11111111",HEADERS["responseFile.release.compress.range"].Vary="Accept-Encoding",HEADERS["responseFile.release.compress.range"]["Access-Control-Allow-Origin"]="*",HEADERS["responseFile.release.compress.range"]["Last-Modified"]="Mon, 01 Jan 2001 08:00:00 GMT",HEADERS["responseFile.release.compress.range"]["Content-Encoding"]="gzip",HEADERS["responseFile.release.compress.range"][RESPONSE_HEADER_CONTENTLENGTH]="0",HEADERS["responseFile.release.compress.range"]["Content-Range"]="",HEADERS["responseFile.release"]={},HEADERS["responseFile.release"][RESPONSE_HEADER_CACHECONTROL]="public, max-age=11111111",HEADERS["responseFile.release"].Vary="Accept-Encoding",HEADERS["responseFile.release"]["Access-Control-Allow-Origin"]="*",HEADERS["responseFile.release"]["Last-Modified"]="Mon, 01 Jan 2001 08:00:00 GMT",HEADERS["responseFile.release.range"]={},HEADERS["responseFile.release.range"]["Accept-Ranges"]="bytes",HEADERS["responseFile.release.range"][RESPONSE_HEADER_CACHECONTROL]="public, max-age=11111111",HEADERS["responseFile.release.range"].Vary="Accept-Encoding",HEADERS["responseFile.release.range"]["Access-Control-Allow-Origin"]="*",HEADERS["responseFile.release.range"]["Last-Modified"]="Mon, 01 Jan 2001 08:00:00 GMT",HEADERS["responseFile.release.range"][RESPONSE_HEADER_CONTENTLENGTH]="0",HEADERS["responseFile.release.range"]["Content-Range"]="",HEADERS["responseFile.debug.compress"]={},HEADERS["responseFile.debug.compress"][RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate",HEADERS["responseFile.debug.compress"].Vary="Accept-Encoding",HEADERS["responseFile.debug.compress"]["Access-Control-Allow-Origin"]="*",HEADERS["responseFile.debug.compress"].Pragma="no-cache",HEADERS["responseFile.debug.compress"].Expires="0",HEADERS["responseFile.debug.compress"]["Content-Encoding"]="gzip",HEADERS["responseFile.debug.compress.range"]={},HEADERS["responseFile.debug.compress.range"]["Accept-Ranges"]="bytes",HEADERS["responseFile.debug.compress.range"][RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate",HEADERS["responseFile.debug.compress.range"].Vary="Accept-Encoding",HEADERS["responseFile.debug.compress.range"]["Access-Control-Allow-Origin"]="*",HEADERS["responseFile.debug.compress.range"]["Content-Encoding"]="gzip",HEADERS["responseFile.debug.compress.range"].Pragma="no-cache",HEADERS["responseFile.debug.compress.range"].Expires="0",HEADERS["responseFile.debug.compress.range"][RESPONSE_HEADER_CONTENTLENGTH]="0",HEADERS["responseFile.debug.compress.range"]["Content-Range"]="",HEADERS["responseFile.debug"]={},HEADERS["responseFile.debug"][RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate",HEADERS["responseFile.debug"].Vary="Accept-Encoding",HEADERS["responseFile.debug"].Pragma="no-cache",HEADERS["responseFile.debug"].Expires="0",HEADERS["responseFile.debug"]["Access-Control-Allow-Origin"]="*",HEADERS["responseFile.debug.range"]={},HEADERS["responseFile.debug.range"]["Accept-Ranges"]="bytes",HEADERS["responseFile.debug.range"][RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate",HEADERS["responseFile.debug.range"].Vary="Accept-Encoding",HEADERS["responseFile.debug.range"]["Access-Control-Allow-Origin"]="*",HEADERS["responseFile.debug.range"].Pragma="no-cache",HEADERS["responseFile.debug.range"].Expires="0",HEADERS["responseFile.debug.range"][RESPONSE_HEADER_CONTENTLENGTH]="0",HEADERS["responseFile.debug.range"]["Content-Range"]="",HEADERS["responseContent.mobile.compress"]={},HEADERS["responseContent.mobile.compress"].Vary="Accept-Encoding, User-Agent",HEADERS["responseContent.mobile.compress"]["Content-Encoding"]="gzip",HEADERS["responseContent.mobile"]={},HEADERS["responseContent.mobile"].Vary="Accept-Encoding, User-Agent",HEADERS["responseContent.compress"]={},HEADERS["responseContent.compress"][RESPONSE_HEADER_CACHECONTROL]="private",HEADERS["responseContent.compress"].Vary="Accept-Encoding",HEADERS["responseContent.compress"]["Content-Encoding"]="gzip",HEADERS.responseContent={},HEADERS.responseContent.Vary="Accept-Encoding",HEADERS["responseStream.release.compress"]={},HEADERS["responseStream.release.compress"][RESPONSE_HEADER_CACHECONTROL]="public, max-age=11111111",HEADERS["responseStream.release.compress"]["Access-Control-Allow-Origin"]="*",HEADERS["responseStream.release.compress"]["Content-Encoding"]="gzip",HEADERS["responseStream.release"]={},HEADERS["responseStream.release"][RESPONSE_HEADER_CACHECONTROL]="public, max-age=11111111",HEADERS["responseStream.release"]["Access-Control-Allow-Origin"]="*",HEADERS["responseStream.debug.compress"]={},HEADERS["responseStream.debug.compress"][RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate",HEADERS["responseStream.debug.compress"].Pragma="no-cache",HEADERS["responseStream.debug.compress"].Expires="0",HEADERS["responseStream.debug.compress"]["Access-Control-Allow-Origin"]="*",HEADERS["responseStream.debug.compress"]["Content-Encoding"]="gzip",HEADERS["responseStream.debug"]={},HEADERS["responseStream.debug"][RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate",HEADERS["responseStream.debug"].Pragma="no-cache",HEADERS["responseStream.debug"].Expires="0",HEADERS["responseStream.debug"]["Access-Control-Allow-Origin"]="*",HEADERS["responseBinary.compress"]={},HEADERS["responseBinary.compress"][RESPONSE_HEADER_CACHECONTROL]="public",HEADERS["responseBinary.compress"]["Content-Encoding"]="gzip",HEADERS.responseBinary={},HEADERS.responseBinary[RESPONSE_HEADER_CACHECONTROL]="public";var _controller="",_test;global.framework_internal||(global.framework_internal=require("./internal")),global.framework_builders||(global.framework_builders=require("./builders")),global.framework_utils||(global.framework_utils=require("./utils")),global.framework_mail||(global.framework_mail=require("./mail")),global.framework_image||(global.framework_image=global.Image=require("./image")),global.framework_nosql||(global.framework_nosql=require("./nosql")),global.Builders=global.builders=framework_builders;var utils=global.Utils=global.utils=global.U=framework_utils;global.Mail=global.MAIL=framework_mail,global.include=global.INCLUDE=global.source=global.SOURCE=function(e,r){return framework.source(e,r)},global.MODULE=function(e){return framework.module(e)},global.DB=global.DATABASE=function(){return typeof framework.database===OBJECT?framework.database:framework.database.apply(framework,arguments)},global.CONFIG=function(e){return framework.config[e]},global.INSTALL=function(e,r,t,n,o){return framework.install(e,r,t,n,o)},global.UNINSTALL=function(e,r,t){return framework.uninstall(e,r,t)},global.RESOURCE=function(e,r){return framework.resource(e,r)},global.TRANSLATE=function(e,r){return framework.translate(e,r)},global.TRANSLATOR=function(e,r){return framework.translator(e,r)},global.LOG=function(){return framework.log.apply(framework,arguments)},global.LOGGER=function(){return framework.logger.apply(framework,arguments)},global.MODEL=function(e){return framework.model(e)},global.SCHEMA=function(e,r,t){return Builders.load(e,r,t)},global.GETSCHEMA=function(e,r){return Builders.getschema(e,r)},global.MAKE=global.TRANSFORM=function(e,r){if(typeof e===TYPE_FUNCTION){var t=r;r=e,e=t}var n;return typeof r===TYPE_FUNCTION?(n={},r.call(n,n)):n=r,e?TransformBuilder.transform.apply(n,arguments):n},global.NEWTRANSFORM=function(e,r,t){return TransformBuilder.addTransform.apply(this,arguments)},global.NEWSCHEMA=function(e,r){return r||(r=e,e="default"),Builders.newschema(e,r)},global.EACHSCHEMA=function(e,r){return Builders.eachschema(e,r)},global.FUNCTION=function(e){return framework.functions[e]},global.ROUTING=function(e){return framework.routing(e)},global.SCHEDULE=function(e,r,t){return framework.schedule(e,r,t)},global.FINISHED=function(e,r){framework_internal.onFinished(e,r)},global.DESTROY=function(e){framework_internal.destroyStream(e)},global.CLEANUP=function(e,r){var t=function(){FINISHED(e,function(){r&&r(),DESTROY(e)})};if(e.readable){if(e.path)return void e.on("end",t)}else if(e.path)return void e.on("finish",t);t=null,FINISHED(e,function(){r&&r(),DESTROY(e)})},global.SUCCESS=function(e,r){var t;e instanceof Error?(t=e,e=!1):e instanceof Builders.ErrorBuilder?e.hasError()?(t=e.output(),e=!1):e=!0:(null===e||void 0===e)&&(e=!0);var n={success:e};return t&&(n.error=t),void 0===r?n:(n.value=r,n)},global.TRY=function(e,r){try{return e(),!0}catch(t){return r?r(r):F.error(r),!1}},global.OBSOLETE=function(e,r){console.log(':: OBSOLETE / IMPORTANT ---> "'+e+'"',r),framework.stats.other.obsolete++},void 0===global.setImmediate&&(global.setImmediate=function(e){process.nextTick(e)}),global.DEBUG=!1,global.TEST=!1,global.RELEASE=!1,global.is_client=!1,global.is_server=!0;var directory=framework_utils.$normalize(require.main?path.dirname(require.main.filename):process.cwd());Framework.prototype={get async(){var e=this;return typeof e._async===UNDEFINED&&(e._async=new utils.Async(e)),e._async}},Framework.prototype.__proto__=new events.EventEmitter,Framework.prototype.behaviour=function(e,r){var t=this;t.behaviours||(t.behaviours={}),typeof r===STRING&&(r=[r]),t.behaviours[e]||(t.behaviours[e]={});for(var n=0;n<r.length;n++)t.behaviours[e][r[n]]=!0;return t},Framework.prototype.refresh=function(e){var r=this;return r.emit("clear","refresh"),r.resources={},r.databases={},r._configure(),r._configure_versions(),r._configure_sitemap(),r.temporary.path={},r.temporary.range={},r.temporary.views={},r.temporary.other={},r.emit("reconfigure"),r},Framework.prototype.controller=function(e){return this.controllers[e]||null},Framework.prototype.useConfig=function(e){return this._configure(e,!0)},Framework.prototype._routesSort=function(){var e=this;e.routes.web.sort(function(e,r){return e.priority>r.priority?-1:e.priority<r.priority?1:0}),e.routes.websockets.sort(function(e,r){return e.priority>r.priority?-1:e.priority<r.priority?1:0});for(var r={},t=e.routes.web.length,n=0;t>n;n++){var o=e.routes.web[n],i=e.temporary.internal[o.controller];if(i&&(o.controller=i),o.isMOBILE&&!(o.isUPLOAD||o.isXHR||o.isJSON||o.isSYSTEM||o.isXML)&&-1!==o.flags.indexOf("get")){var s=o.url.join("/");r[s]=!0}}for(var n=0;t>n;n++){var o=e.routes.web[n];if(!(o.isMOBILE||o.isUPLOAD||o.isXHR||o.isJSON||o.isSYSTEM||o.isXML)&&-1!==o.flags.indexOf("get")){var s=o.url.join("/");o.isMOBILE_VARY=r[s]===!0}}return e},Framework.prototype.database=function(e){var r=this,t=r.databases[e];return void 0!==t?t:(r.path.verify("databases"),t=framework_nosql.load(r.path.databases(e),r.path.databases(e+"-binary"),!0),r.databases[e]=t,t)},Framework.prototype.stop=function(e){var r=this;for(var t in framework.workers){var n=framework.workers[t];n&&n.kill&&n.kill(e||"SIGTERM")}return framework.emit("exit"),r.isWorker||typeof process.send!==TYPE_FUNCTION||process.send("stop"),r.cache.stop(),r.server&&r.server.close(),process.exit(e||"SIGTERM"),r},Framework.prototype.redirect=function(e,r,t,n){var o=this,i=e.startsWith("http://")||e.startsWith("https");if(i===!1){"/"!==e[0]&&(e="/"+e);var s;return t instanceof Array?(s=t,t=n===!0):n instanceof Array?(s=n,t=t===!0):t=t===!0,n=t,framework.route(e,function(){return r.startsWith("http://")||r.startsWith("https://")?void this.redirect(r,n):("/"!==r[0]&&(r="/"+r),void this.redirect(r,n))},s),o}return"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),"/"===r[r.length-1]&&(r=r.substring(0,r.length-1)),o.routes.redirects[e]={url:r,path:t,permanent:n},o._request_check_redirect=!0,o},Framework.prototype.schedule=function(e,r,t){void 0===t&&(t=r,r=!1);var n=this,o=typeof e;o===STRING?e=e.parseDate():o===NUMBER&&(e=new Date(e));var i=e.getTime();framework_utils.GUID(5)+framework_utils.random(1e4);return r&&(r=r.replace("each","1")),n.schedules.push({expire:i,fn:t,repeat:r}),n},Framework.prototype.resize=function(e,r,t,n,o,i){var s=this,a=null,u=e.lastIndexOf(".");a=-1!==u?[e.substring(u)]:i||[".jpg",".png",".gif"];for(var c=a.length,l=0;c>l;l++)a[l]=("."!==a[l][0]?".":"")+a[l].toLowerCase();u=e.lastIndexOf("/"),-1!==u&&(e=e.substring(0,u)),"/"!==e[0]&&(e="/"+e),"/"!==e[e.length-1]&&(e+="/"),o=o||e,n||(n={});for(var f={},l=0,c=a.length;c>l;l++)f[a[l]]=!0;return s.routes.resize[e]={width:r,height:t,extension:f,path:o||e,grayscale:n.grayscale,blur:n.blur,rotate:n.rotate,flip:n.flip,flop:n.flop,sepia:n.sepia,quality:n.quality,cache:n.cache===!1?!1:!0},s},Framework.prototype.restful=function(e,r,t,n,o,i){function s(e){for(var r=0,t=e.length;t>r;r++)if("*"===e[r][0])return e.splice(r,1),e;return e}var a,u=this;t&&(a=[],r&&a.push.apply(a,s(r)),u.route(e,a,t));var c=framework_utils.path(e)+"{id}";return n&&(a=[],r&&a.push.apply(a,s(r)),u.route(c,a,n)),o&&(a=["post"],r&&a.push.apply(a,r),u.route(e,a,o),a=["put"],r&&a.push.apply(a,r),u.route(c,a,o)),i&&(a=["delete"],r&&a.push.apply(a,s(r)),u.route(c,a,i)),u},Framework.prototype.route=function(e,r,t,n,o,i,s){for(var a,u,c,l=!0,f=0;f<arguments.length;f++)if(typeof arguments[f]===TYPE_FUNCTION){l=!1;break}var p=typeof e===TYPE_FUNCTION?e:null;if(p&&(e="/"),l||"string"!=typeof r||void 0===t||(a=e,e=r,r=t,t=n,n=o,o=i,i=s,s=void 0),"#"===e[0])if(e=e.substring(1),"400"!==e&&"401"!==e&&"403"!==e&&"404"!==e&&"408"!==e&&"431"!==e&&"500"!==e&&"501"!==e){var d=g.sitemap(e,!0);if(!d)throw new Error('Sitemap item "'+e+'" not found.');a=e,e=d.url}else e="#"+e;""===e&&(e="/"),"["!==e[0]&&"/"!==e[0]&&(e="/"+e),e.endsWith("/")&&(e=e.substring(0,e.length-1)),e=framework_internal.encodeUnicodeURL(e),utils.isArray(n)&&(u=o,o=n,n=u);var m=typeof r,h=0;a||(a=e),(m===OBJECT||r instanceof Array)&&(u=r,r=t,t=u),m===STRING?(c=r,r=function(e){"~"===c[0]&&(this.themeName=""),this.view(c)}):typeof r!==TYPE_FUNCTION&&(c=e,c.endsWith("/")&&(c=c.substring(0,c.length-1)),h=c.lastIndexOf("/"),-1!==h&&(c=c.substring(h+1)),(""===c||"/"===c)&&(c="index"),r=function(){"~"===c[0]&&this.theme(""),this.view(c)}),utils.isArray(t)||"object"!=typeof t?t instanceof Array&&n&&typeof n===OBJECT?(s=n,n=void 0):t instanceof Array&&typeof n===NUMBER&&typeof o===OBJECT&&!(o instanceof Array)&&(s=o,o=void 0):(n=t.max||t.length||t.maximum||t.maximumSize||t.size,o=t.middleware||t.partials||t.partial,i=t.timeout,s=t.options,t.name&&(a=t.name),t.id&&(a=t.id),t=t.flags||t.flag);var g=this,v=0,y=null,w=-1!==e.indexOf("*");h=e.indexOf("]"),v=e.count("/"),w&&(e=e.replace("*","").replace("//","/"),v-=100),h>0&&(y=e.substring(1,h).trim().toLowerCase().split(","),e=e.substring(h+1),v+=2);var b,E=!1,k=!1,S="",_="GeneratorFunction"===r.constructor.name||0===r.toString().indexOf("function*"),T=!1,O=!1,N=!1;if(t){u=[];for(var x=0,f=0;f<t.length;f++){var C=typeof t[f];if(C!==NUMBER)if(C!==OBJECT){var R=t[f][0];if("%"!==R)if("#"!==R)if("*"!==R){x++;var A=t[f].toString().toLowerCase();switch(A){case"json":O=!0;continue;case"xss":x--;continue;case"delay":x--,N=!0;continue;case"sync":case"yield":case"synchronize":_=!0,x--;continue;case"noxhr":case"-xhr":k=!0;continue;case"raw":E=!0,u.push(A);break;case"mobile":T=!0,g._request_check_mobile=!0;break;case"authorize":case"authorized":v+=2,u.push("authorize");break;case"unauthorize":case"unauthorized":v+=2,u.push("unauthorize");break;case"logged":v+=2,u.push("authorize");break;case"unlogged":u.push("unauthorize");break;case"referer":case"referrer":u.push("referer");break;case"delete":case"get":case"head":case"options":case"patch":case"post":case"propfind":case"put":case"trace":u.push(A),S+=(S?",":"")+A;break;default:u.push(A)}}else b=t[f].substring(1).split("/"),1===b.length&&(b[1]=b[0],b[0]="default"),h=b[1].indexOf("#"),-1!==h&&(b[2]=b[1].substring(h+1),b[1]=b[1].substring(0,h));else null===(o||null)&&(o=[]),o.push(t[f].substring(1));else g.behaviour(""===e?"/":e,t[f].substring(1))}else s=t[f];else i=t[f]}t=u,v+=2*x}else t=["get"],S="get";var I=!1;-1===t.indexOf("logged")&&-1===t.indexOf("authorize")&&-1===t.indexOf("unauthorize")&&-1===t.indexOf("unlogged")&&(I=!0);var D=framework_internal.routeSplitCreate(e.trim()),F=[],P=null,$=null;-1!==e.indexOf("{")&&(D.forEach(function(e,r){if("{"===e.substring(0,1)){F.push(r);var t=e.substring(1,e.length-1);if("/"===t[0]){var n=t.lastIndexOf("/");-1!==n&&(P||(P={},$=[]),P[r]=new RegExp(t.substring(1,n),t.substring(n+1)),$.push(r))}}}),v-=F.length),-1!==e.indexOf("#")&&(v-=100),-1!==t.indexOf("proxy")&&(O=!0,v++),(O||-1!==t.indexOf("xml")||E)&&-1===t.indexOf("delete")&&-1===t.indexOf("post")&&-1===t.indexOf("put")&&-1===t.indexOf("patch")&&(t.push("post"),S+=(S?",":"")+"post",v++),-1!==t.indexOf("upload")&&-1===t.indexOf("post")&&-1===t.indexOf("put")&&(t.push("post"),S+=(S?",":"")+"post"),-1===t.indexOf("get")&&-1===t.indexOf("options")&&-1===t.indexOf("post")&&-1===t.indexOf("delete")&&-1===t.indexOf("put")&&-1===t.indexOf("upload")&&-1===t.indexOf("head")&&-1===t.indexOf("trace")&&-1===t.indexOf("patch")&&-1===t.indexOf("propfind")&&(t.push("get"),S+=(S?",":"")+"get"),-1!==t.indexOf("referer")&&(g._request_check_referer=!0),g._request_check_POST||-1===t.indexOf("delete")&&-1===t.indexOf("post")&&-1===t.indexOf("put")&&-1===t.indexOf("upload")&&-1===t.indexOf("json")&&-1===t.indexOf("patch")&&-1===t.indexOf("options")||(g._request_check_POST=!0),o&&o instanceof Array&&o.length||(o=null);var H=!1;return-1!==S.indexOf(",")&&(H=!0),S=-1!==S.indexOf(",")||""===S?void 0:S.toUpperCase(),"#"===a[1]&&(a=a.substring(1)),g.routes.web.push({name:a,priority:v,schema:b,subdomain:y,controller:_controller?_controller:"unknown",url:D,param:F,flags:t||[],method:S,execute:r,length:1024*(n||g.config["default-request-length"]),middleware:o,timeout:void 0===i?N?0:g.config["default-request-timeout"]:i,isGET:-1!==t.indexOf("get"),isMULTIPLE:H,isJSON:O,isXML:-1!==t.indexOf("xml"),isRAW:E,isMOBILE:T,isMOBILE_VARY:T,isGENERATOR:_,isMEMBER:I,isASTERIX:w,isREFERER:-1!==t.indexOf("referer"),isHTTPS:-1!==t.indexOf("https"),isHTTP:-1!==t.indexOf("http"),isDEBUG:-1!==t.indexOf("debug"),isRELEASE:-1!==t.indexOf("release"),isPROXY:-1!==t.indexOf("proxy"),isBOTH:k?!1:!0,isXHR:-1!==t.indexOf("xhr"),isUPLOAD:-1!==t.indexOf("upload"),isSYSTEM:e.startsWith("/#"),isCACHE:!(e.startsWith("/#")||p||F.length||w),isPARAM:F.length>0,isDELAY:N,CUSTOM:p,options:s,regexp:P,regexpIndexer:$}),g.emit("route-add","web",g.routes.web[g.routes.web.length-1]),_controller||g._routesSort(),g},Framework.prototype.routing=function(e){for(var r=this,t=0,n=r.routes.web.length;n>t;t++){var o=r.routes.web[t];if(o.name===e){var i=Utils.path(o.url.join("/"));return"/"!==i[0]&&(i="/"+i),{controller:o.controller,url:i,id:o.id,flags:o.flags,middleware:o.middleware,execute:o.execute,timeout:o.timeout,options:o.options,length:o.length}}}},Framework.prototype.merge=function(e){for(var r=[],t=this,n=1,o=arguments.length;o>n;n++){var i=arguments[n];i instanceof Array||(i=[i]);for(var s=0,a=i.length;a>s;s++){var u=i[s],c=u[0];"@"===c?u="~"+framework.path["package"](u.substring(1)):"="===c&&(u="~"+framework.path.themes(u.substring(1))),r.push(u)}}e=t._version(e),"/"!==e[0]&&(e="/"+e);var l=t.path.temp("merge-"+createTemporaryKey(e));return t.routes.merge[e]={filename:l,files:r},t},Framework.prototype.mapping=function(e,r){return this.map.apply(this,arguments)},Framework.prototype.send=function(e,r){return process.send(e,r),this},Framework.prototype.map=function(e,r,t){"/"!==e[0]&&(e="/"+e);var n=!1,o=this;if(r=framework_utils.$normalize(r),e=o._version(e),"#"===r[0])return o.routes.mapping[e]=r,o;var i,s=r.indexOf("#");if(-1!==s){var a=r.split("#");r=a[0],i=a[1]}var u=r[0];"@"===u?(r=framework.isWindows?framework_utils.combine(framework.config["directory-temp"],r.substring(1)):o.path["package"](r.substring(1)),n=!0):"="===u&&(r=framework.isWindows?framework_utils.combine(framework.config["directory-themes"],r.substring(1)):o.path.themes(r.substring(1)),n=!0);var c=framework_utils.getExtension(r).length>0;if(!n&&!r.startsWith(directory)){var a="~"===r[0]?o.path.root(r.substring(1)):o.path["public"](r);fs.existsSync(a)&&(r=a)}if(c)return o.routes.mapping[e]=r,i&&(o.routes.blocks[e]=i),o;e=framework_utils.path(e),r=framework_utils.path(r);var l=r,f="",p=!1;if("/"===l[0]&&(p=!0),"~"===l[0]&&(f+="~",l=l.substring(1)),"."===l[0]&&(f+=".",l=l.substring(1)),p||"/"!==l[0]||(f+="/",l=l.substring(1)),t instanceof Array)for(var d=0,m=t.length;m>d;d++)t[d]=("."!==t[d][0]?".":"")+t[d].toLowerCase();return setTimeout(function(){framework_utils.ls(framework.isWindows?r.replace(/\//g,"\\"):r,function(n){for(var s=0,a=n.length;a>s;s++){
framework.isWindows&&(n[s]=n[s].replace(r,"").replace(/\\/g,"/"));var u=n[s].replace(l,"");if(t)if("function"==typeof t){if(!t(u))continue}else if(-1===t.indexOf(framework_utils.getExtension(u).toLowerCase()))continue;"/"===u[0]&&(u=u.substring(1));var c=e+u;o.routes.mapping[c]=f+n[s],i&&(o.routes.blocks[c]=i)}})},n?500:1),this},Framework.prototype.middleware=function(e,r){var t=this;return t.install("middleware",e,r),t},Framework.prototype.use=function(e){var r=this;if(arguments.length)for(var t=0;t<arguments.length;t++)r.routes.request.push(arguments[t]);else if(e instanceof Array)for(var t=0;t<e.length;t++)r.routes.request.push(e[t]);else r.routes.request.push(e);return r._length_request_middleware=r.routes.request.length,r},Framework.prototype.websocket=function(e,r,t,n,o,i,s,a){var u,c=typeof e===TYPE_FUNCTION?e:null;if(c&&(e="/"),"#"===e[0]){e=e.substring(1);var l=f.sitemap(e,!0);if(!l)throw new Error('Sitemap item "'+e+'" not found.');name=e,e=l.url}""===e&&(e="/"),e=framework_internal.encodeUnicodeURL(e),utils.isArray(i)&&(u=s,s=i,i=u),typeof funcExecute===OBJECT&&(u=t,funcExecute=t,t=u),t instanceof Array||typeof t!==OBJECT||(n=t.protocols||t.protocol,o=t.allow||t.origin,i=t.max||t.length||t.maximum||t.maximumSize,s=t.middleware,a=t.options,t=t.flags),void 0===s&&(s=null);var f=this,p=0,d=e.indexOf("]"),m=null,h=-1!==e.indexOf("*");p=e.count("/"),d>0&&(m=e.substring(1,d).trim().toLowerCase().split(","),e=e.substring(d+1),p+=2),h&&(e=e.replace("*","").replace("//","/"),p=-10-p);var g=framework_internal.routeSplitCreate(e.trim()),v=[],y=null,w=null;-1!==e.indexOf("{")&&(g.forEach(function(e,r){if("{"===e.substring(0,1)){v.push(r);var t=e.substring(1,e.length-1);if("/"===t[0]){var n=t.lastIndexOf("/");-1!==n&&(y||(y={},w=[]),y[r]=new RegExp(t.substring(1,n),t.substring(n+1)),w.push(r))}}}),p-=v.length),typeof o===STRING&&(o=o[o]),typeof n===STRING&&(n=n[n]),typeof t===STRING&&(t=t[t]),u=[];var b=!1,E=!1,k=0;void 0===t&&(t=[]);for(var S=0;S<t.length;S++)typeof t[S]!==OBJECT?"#"!==t[S][0]?(t[S]=t[S].toString().toLowerCase(),k++,"json"===t[S]&&(b=!0),"binary"===t[S]&&(E=!0),"raw"===t[S]&&(E=!1,b=!1),"json"!==t[S]&&"binary"!==t[S]&&"raw"!==t[S]&&u.push(t[S])):(null===(s||null)&&(s=[]),s.push(t[S].substring(1))):a=t[S];t=u,-1===t.indexOf("get")&&t.unshift("get"),p+=2*k;var _=!1;return t&&-1!==t.indexOf("authorize")||(_=!0),s&&s instanceof Array&&s.length||(s=null),f.routes.websockets.push({controller:_controller?_controller:"unknown",url:g,param:v,subdomain:m,priority:p,flags:t||[],onInitialize:r,protocols:n||[],allow:o||[],length:1024*(i||f.config["default-websocket-request-length"]),isWEBSOCKET:!0,isMEMBER:_,isJSON:b,isBINARY:E,isASTERIX:h,isHTTPS:t.indexOf("https"),isHTTP:t.indexOf("http"),isDEBUG:t.indexOf("debug"),isRELEASE:t.indexOf("release"),CUSTOM:c,middleware:s,options:a,isPARAM:v.length>0,regexp:y,regexpIndexer:w}),f.emit("route-add","websocket",f.routes.websockets[f.routes.websockets.length-1]),_controller||f._routesSort(),f},Framework.prototype.file=function(e,r,t,n,o){var i,s=this;if(utils.isArray(r)){i=t;var a=n;n=r,r=i,t=a}else utils.isArray(t)&&(i=t,t=n,n=i);if(void 0===n&&(n=null),n)for(var u=0,c=n.length;c>u;u++)n[u]=n[u].replace("#","");return n&&n instanceof Array&&n.length||(n=null),s.routes.files.push({controller:_controller?_controller:"unknown",name:e,onValidate:r,execute:t||r,middleware:n,options:o}),s.emit("route-add","file",s.routes.files[s.routes.files.length-1]),s._length_files++,s},Framework.prototype.localize=function(e,r,t,n,o){var i=this;r=r.replace("*","");var s=r.lastIndexOf("."),a="html|htm|md|txt";-1!==s&&(a=r.substring(s+1),r=r.substring(0,s)),t===!0?(t=null,o=!0):n===!0&&(n=null,o=!0);var u=function(e,t,n){if(n)return e.url.substring(0,r.length)===r&&-1!==a.indexOf(e.extension);var s="locate_"+(e.$language?e.$language:"default")+"_"+e.url,u=framework.temporary.other[s];if(u)return void framework.responseContent(e,t,200,u,framework_utils.getContentType(e.extension),!0);var c=e.uri.pathname,l=i.onMapping(c,framework.path["public"]($decodeURIComponent(c)));fs.readFile(l,function(r,n){return r?t.throw404():(n=framework.translator(e.$language,n.toString(ENCODING)),framework.isDebug||(framework.temporary.other[s]=n),!o||"html"!==e.extension&&"htm"!==e.extension||(n=framework_internal.compile_html(n,l)),void framework.responseContent(e,t,200,n,framework_utils.getContentType(e.extension),!0))})};return i.file(e,u,t,n),i},Framework.prototype.error=function(e,r,t){if(!arguments.length)return function(e){e&&framework.error(e,r,t)};if(!e)return this;var n=this;return null!==n.errors&&(n.errors.push({error:e.stack,name:r,url:t?parser.format(t):null,date:new Date}),n.errors.length>50&&n.errors.shift()),n.onError(e,r,t),n},Framework.prototype.problem=function(e,r,t,n){var o=this;return null!==o.problems&&(o.problems.push({message:e,name:r,url:t?parser.format(t):null,ip:n}),o.problems.length>50&&o.problems.shift()),o.emit("problem",e,r,t,n),o},Framework.prototype.change=function(e,r,t,n){var o=this;return null!==o.changes&&(o.changes.push({message:e,name:r,url:t?parser.format(t):null,ip:n}),o.changes.length>50&&o.changes.shift()),o.emit("change",e,r,t,n),o},Framework.prototype.module=function(e){return this.modules[e]||null},Framework.prototype.modify=function(e){var r=this;return r.modificators||(r.modificators=[]),r.modificators.push(e),r},Framework.prototype.$load=function(e,r){function t(e,r,n,o,s){fs.existsSync(i)&&(o||(o=EXTENSION_JS),fs.readdirSync(e).forEach(function(a){var u=fs.statSync(path.join(e,a)).isDirectory();if(u&&s)return void n.push({name:a});if(u){if(".package"===o&&a.endsWith(o)){var c=a.substring(0,a.length-o.length);return void n.push({name:"/"===c[0]?c.substring(1):c,filename:path.join(i,a),is:!0})}return r++,void t(path.join(e,a),r,n,o)}var l=framework_utils.getExtension(a).toLowerCase();if(l===o){var c=(r>0?e.replace(i,"")+"/":"")+a.substring(0,a.length-l.length);n.push({name:"/"===c[0]?c.substring(1):c,filename:path.join(i,c)+o})}}))}var n=this,o=[],i="";if(r||(r=directory),e&&-1===e.indexOf("modules")||(i=path.join(r,n.config["directory-modules"]),o=[],t(i,0,o,".js"),o.forEach(function(e){n.install("module",e.name,e.filename,void 0,void 0,void 0,!0)})),e&&-1===e.indexOf("isomorphic")||(i=path.join(r,n.config["directory-isomorphic"]),o=[],t(i,0,o,".js"),o.forEach(function(e){n.install("isomorphic",e.name,e.filename,void 0,void 0,void 0,!0)})),!e||-1!==e.indexOf("packages")){i=path.join(r,n.config["directory-packages"]),o=[],t(i,0,o,".package");var s=i;o.forEach(function(e){return e.is?void framework_utils.ls(e.filename,function(r,t){var o=framework.path.temp(e.name);fs.existsSync(o)||fs.mkdirSync(o);for(var i=0,a=t.length;a>i;i++){var u=framework.path.temp(t[i].replace(s,"").replace(".package","")+"/");fs.existsSync(u)||fs.mkdirSync(u)}r.wait(function(r,t){var n=fs.createReadStream(r);n.pipe(fs.createWriteStream(path.join(o,r.replace(e.filename,"").replace(".package","")))),n.on("end",t)},function(){setTimeout(function(){n.install("package2",e.name,e.filename,void 0,void 0,void 0,!0)},50)})}):void n.install("package",e.name,e.filename,void 0,void 0,void 0,!0)})}return e&&-1===e.indexOf("models")||(i=path.join(r,n.config["directory-models"]),o=[],t(i,0,o),o.forEach(function(e){n.install("model",e.name,e.filename,void 0,void 0,void 0,!0)})),e&&-1===e.indexOf("themes")||(o=[],i=path.join(r,n.config["directory-themes"]),t(i,0,o,void 0,!0),o.forEach(function(e){var r=e.name,t=path.join(i,r),o=path.join(t,"index.js");n.themes[e.name]=framework_utils.path(t),n._length_themes++,fs.existsSync(o)&&n.install("theme",e.name,o,void 0,void 0,void 0,!0)})),e&&-1===e.indexOf("definitions")||(i=path.join(r,n.config["directory-definitions"]),o=[],t(i,0,o),o.forEach(function(e){n.install("definition",e.name,e.filename,void 0,void 0,void 0,!0)})),e&&-1===e.indexOf("controllers")||(o=[],i=path.join(r,n.config["directory-controllers"]),t(i,0,o),o.forEach(function(e){n.install("controller",e.name,e.filename,void 0,void 0,void 0,!0)})),n._routesSort(),e&&-1===e.indexOf("dependencies")||n._configure_dependencies(),setTimeout(function(){n.onValidation&&OBSOLETE("framework.onValidation()",'The function was renamed to "framework.onValidate()'),n.onAuthorization&&OBSOLETE("framework.onAuthorization()",'The function was renamed to "framework.onAuthorize()')},2e3),n},Framework.prototype.install=function(type,name,declaration,options,callback,internal,useRequired,skipEmit){var self=this,obj=null;"config"!==type&&"version"!==type&&typeof name===STRING&&(name.startsWith("http://")||name.startsWith("https://")?typeof declaration===OBJECT&&(callback=options,options=declaration,declaration=name,name=""):"@"===name[0]&&(declaration=framework.path["package"](name.substring(1)),name=path.basename(name).replace(/\.js$/i,""),void 0===useRequired&&(useRequired=!0)));var t=typeof declaration,key="",tmp=null;if(t===OBJECT&&(t=typeof options,t===TYPE_FUNCTION&&(callback=options),options=declaration,declaration=void 0),void 0===declaration&&(declaration=name,name=""),typeof declaration===STRING&&(declaration.startsWith("http://")||declaration.startsWith("https://")))return"package"===type?(utils.download(declaration,["get"],function(e,r){if(e)return self.error(e,"framework.install('{0}', '{1}')".format(type,declaration),null),void(callback&&callback(e));var t=path.basename(declaration,".package"),n=framework.path.temp(t+".package"),o=fs.createWriteStream(n);r.pipe(o),o.on("finish",function(){self.install(type,t,n,options,void 0,void 0,!0)})}),self):(utils.request(declaration,["get"],function(e,r,t){return 200===t||e||(e=new Error(r)),e?(self.error(e,"framework.install('{0}', '{1}')".format(type,declaration),null),void(callback&&callback(e))):void self.install(type,name,r,options,callback,declaration)}),self);if("middleware"===type)return self.routes.middleware[name]=typeof declaration===TYPE_FUNCTION?declaration:eval(declaration),self._length_middleware=Object.keys(self.routes.middleware).length,callback&&callback(null),key=type+"."+name,self.dependencies[key]?self.dependencies[key].updated=new Date:(self.dependencies[key]={name:name,type:type,installed:new Date,updated:null,count:0},internal&&(self.dependencies[key].url=internal)),self.dependencies[key].count++,setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),self;if("config"===type||"configuration"===type||"settings"===type)return self._configure(declaration instanceof Array?declaration:declaration.toString().split("\n"),!0),setTimeout(function(){delete self.temporary["mail-settings"],self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(null),self;if("version"===type||"versions"===type)return self._configure_versions(declaration.toString().split("\n")),setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(null),self;if("sitemap"===type)return self._configure_sitemap(declaration.toString().split("\n")),setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(null),self;if("package"===type){var backup=new Backup,id=path.basename(declaration,".package"),dir=path.join(framework.path.root(),framework.config["directory-temp"],id);return self.routes.packages[id]=dir,backup.restore(declaration,dir,function(){var e=path.join(dir,"index.js");self.install("module",id,e,options,function(e){setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(e)},internal,useRequired,!0)}),self}if("theme"===type)return obj=require(declaration),typeof obj.install===TYPE_FUNCTION&&(framework.config["allow-compatibility"]||0===obj.install.toString().indexOf("function (framework")?(OBSOLETE(key,"exports.install = function(framework <--- REMOVE THE ARGUMENT framework"),obj.install(self,options,name)):obj.install(options,name)),skipEmit||setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(null),function(e,r){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration),declaration),self;if("package2"===type){var id=path.basename(declaration,".package"),dir=path.join(framework.path.root(),framework.config["directory-temp"],id),filename=path.join(dir,"index.js");return self.install("module",id,filename,options,function(e){setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(e)},internal,useRequired,!0),self}var plus=null===self.id?"":"instance-"+self.id+"-";if("view"===type){var item=self.routes.views[name];return key=type+"."+name,void 0===item&&(item={},item.filename=self.path.temporary("installed-"+plus+"view-"+utils.GUID(10)+".tmp"),item.url=internal,item.count=0,self.routes.views[name]=item),item.count++,fs.writeFileSync(item.filename,declaration),setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(null),self}if("definition"===type||"eval"===type){_controller="";try{useRequired?(delete require.cache[require.resolve(declaration)],obj=require(declaration),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration))):obj=typeof declaration===TYPE_FUNCTION?eval("("+declaration.toString()+")()"):eval(declaration)}catch(ex){return self.error(ex,"framework.install('"+type+"')",null),callback&&callback(ex),self}return callback&&callback(null),setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),self}if("isomorphic"===type){var content="";try{if(!name&&typeof internal===STRING){var tmp=internal.match(/[a-z0-9]+\.js$/i);tmp&&(name=tmp.toString().replace(/\.js/i,""))}useRequired?(delete require.cache[require.resolve(declaration)],obj=require(declaration),content=fs.readFileSync(declaration).toString(ENCODING),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration))):(obj=typeof declaration===TYPE_FUNCTION?eval("("+declaration.toString()+")()"):eval(declaration),content=declaration.toString())}catch(ex){return self.error(ex,"framework.install('"+type+"')",null),callback&&callback(ex),self}return typeof obj.id===STRING?name=obj.id:typeof obj.name===STRING&&(name=obj.name),obj.url&&framework.map(obj.url,"#"+name),framework.isomorphic[name]=obj,framework.isomorphic[name].$$output=framework_internal.compile_javascript(content,"#"+name),callback&&callback(null),setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),self}if("model"===type||"source"===type){_controller="";try{if(useRequired)obj=require(declaration),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration));else{if(typeof declaration!==STRING&&(declaration=declaration.toString()),!name&&typeof internal===STRING){var tmp=internal.match(/[a-z0-9]+\.js$/i);tmp&&(name=tmp.toString().replace(/\.js/i,""))}var filename=self.path.temporary("installed-"+plus+type+"-"+utils.GUID(10)+".js");fs.writeFileSync(filename,declaration),obj=require(filename),function(e,r){setTimeout(function(){fs.unlinkSync(r),delete require.cache[e]},1e3)}(require.resolve(filename),filename)}}catch(ex){return self.error(ex,"framework.install('"+type+"', '"+name+"')",null),callback&&callback(ex),self}return typeof obj.id===STRING?name=obj.id:typeof obj.name===STRING&&(name=obj.name),name||(name=1e4*Math.random()>>0),key=type+"."+name,tmp=self.dependencies[key],self.uninstall(type,name),tmp?(self.dependencies[key]=tmp,self.dependencies[key].updated=new Date):(self.dependencies[key]={name:name,type:type,installed:new Date,updated:null,count:0},internal&&(self.dependencies[key].url=internal)),self.dependencies[key].count++,obj.reinstall?self.dependencies[key].reinstall=obj.reinstall.toString().parseDateExpiration():delete self.dependencies[key],"model"===type?self.models[name]=obj:self.sources[name]=obj,typeof obj.install===TYPE_FUNCTION&&(framework.config["allow-compatibility"]||0===obj.install.toString().indexOf("function (framework")?(OBSOLETE(key,"exports.install = function(framework <--- REMOVE THE ARGUMENT framework"),obj.install(self,options,name)):obj.install(options,name)),skipEmit||setTimeout(function(){self.emit(type+"#"+name),self.emit("install",type,name)},500),callback&&callback(null),self}if("module"===type||"controller"===type){var _ID=_controller="TMP"+Utils.random(1e4);try{if(useRequired)obj=require(declaration),function(e){setTimeout(function(){delete require.cache[e]},1e3)}(require.resolve(declaration));else{if(typeof declaration!==STRING&&(declaration=declaration.toString()),!name&&typeof internal===STRING){var tmp=internal.match(/[a-z0-9]+\.js$/i);tmp&&(name=tmp.toString().replace(/\.js/i,""))}filename=self.path.temporary("installed-"+plus+type+"-"+utils.GUID(10)+".js"),fs.writeFileSync(filename,declaration),obj=require(filename),function(e,r){setTimeout(function(){fs.unlinkSync(r),delete require.cache[e]},1e3)}(require.resolve(filename),filename)}}catch(ex){return self.error(ex,"framework.install('"+type+"', '"+(name?"":internal)+"')",null),callback&&callback(ex),self}if(typeof obj.id===STRING?name=obj.id:typeof obj.name===STRING&&(name=obj.name),name||(name=1e4*Math.random()>>0),obj.booting&&setTimeout(function(){framework._configure("@"+name+"/config"),framework.config.debug?framework._configure("@"+name+"/config-debug"):framework._configure("@"+name+"/config-release"),framework.isTest&&framework._configure("@"+name+"/config-test"),framework._configure_versions("@"+name+"/versions"),framework._configure_dependencies("@"+name+"/dependencies"),framework._configure_sitemap("@"+name+"/sitemap"),framework.$load(void 0,framework.path.temp(name+"/"))},100),key=type+"."+name,tmp=self.dependencies[key],self.uninstall(type,name),tmp?(self.dependencies[key]=tmp,self.dependencies[key].updated=new Date):(self.dependencies[key]={name:name,type:type,installed:new Date,updated:null,count:0,_id:_ID},internal&&(self.dependencies[key].url=internal)),self.dependencies[key].dependencies=obj.dependencies,self.dependencies[key].count++,self.dependencies[key].processed=!1,obj.reinstall?self.dependencies[key].reinstall=obj.reinstall.toString().parseDateExpiration():delete self.dependencies[key].reinstall,_controller=_ID,obj.dependencies instanceof Array)for(var i=0,length=obj.dependencies.length;length>i;i++)if(!self.dependencies[type+"."+obj.dependencies[i]])return self.temporary.dependencies[key]={obj:obj,options:options,callback:callback,skipEmit:skipEmit},self;return self.install_make(key,name,obj,options,callback,skipEmit),"module"===type?self.modules[name]=obj:self.controllers[name]=obj,self.install_prepare(),self}return self},Framework.prototype.install_prepare=function(e){var r=this,t=Object.keys(r.temporary.dependencies);if(t.length){for(var n=0,o=t.length;o>n;n++){var i=t[n],s=r.temporary.dependencies[i],a=r.dependencies[i],u=!1;if(!a.processed){for(var c=0,l=a.dependencies.length;l>c;c++){var f=r.dependencies["module."+a.dependencies[c]];if(!f||!f.processed){u=!0;break}}u||(delete r.temporary.dependencies[i],"module"===a.type?r.modules[a.name]=s.obj:r.controllers[a.name]=s.obj,r.install_make(i,a.name,s.obj,s.options,s.callback,s.skipEmit))}}return t=Object.keys(r.temporary.dependencies),clearTimeout(r.temporary.other.dependencies),r.temporary.other.dependencies=setTimeout(function(){var e=Object.keys(framework.temporary.dependencies);if(e.length)throw new Error("Dependency exception (module): missing dependencies for: "+e.join(", ").trim());delete r.temporary.other.dependencies},1500),t.length?e?r:(r.install_prepare(!0),r):r}},Framework.prototype.install_make=function(e,r,t,n,o,i){var s=this,a=s.dependencies[e],u=a._id,c=a.type;s.temporary.internal[a._id]=r,_controller=u,typeof t.install===TYPE_FUNCTION&&(framework.config["allow-compatibility"]||0===t.install.toString().indexOf("function (framework")?(OBSOLETE(e,"exports.install = function(framework <--- REMOVE THE ARGUMENT framework"),t.install(s,n,r)):t.install(n,r)),a.processed=!0;for(var l=("module"===c?"#":"")+r,f=s.routes.web.length,p=0;f>p;p++)s.routes.web[p].controller===u&&(s.routes.web[p].controller=l);f=s.routes.websockets.length;for(var p=0;f>p;p++)s.routes.websockets[p].controller===u&&(s.routes.websockets[p].controller=l);f=s.routes.files.length;for(var p=0;f>p;p++)s.routes.files[p].controller===u&&(s.routes.files[p].controller=l);return s._routesSort(),_controller="",i||setTimeout(function(){s.emit(c+"#"+r),s.emit("install",c,r)},500),o&&o(null),s},Framework.prototype.uninstall=function(e,r,t,n){var o=this,i=null;if("schema"===e)return Builders.remove(r),o.emit("uninstall",e,r),o;if("mapping"===e)return delete o.routes.mapping[r],o.emit("uninstall",e,r),o;if("isomorphic"===e){var i=o.isomorphic[r];return i.url&&delete o.routes.mapping[o._version(i.url)],delete o.isomorphic[r],o.emit("uninstall",e,r),o}if("middleware"===e)return o.routes.middleware[r]?(delete o.routes.middleware[r],delete o.dependencies[e+"."+r],o._length_middleware=Object.keys(o.routes.middleware).length,o.emit("uninstall",e,r),o):o;if("package"===e)return delete o.routes.packages[r],o.uninstall("module",r,t,!0),o;if("view"===e||"precompile"===e)return(i=o.routes.views[r])?(delete o.routes.views[r],delete o.dependencies[e+"."+r],fsFileExists(i.filename,function(e){e&&fs.unlink(i.filename)}),o.emit("uninstall",e,r),o):o;if("model"===e||"source"===e)return(i="model"===e?o.models[r]:o.sources[r])?(i.id&&delete require.cache[require.resolve(i.id)],typeof i.uninstall===TYPE_FUNCTION&&(framework.config["allow-compatibility"]?i.uninstall(o,t,r):i.uninstall(t,r)),"model"===e?delete o.models[r]:delete o.sources[r],delete o.dependencies[e+"."+r],o._routesSort(),o.emit("uninstall",e,r),o):o;if("module"===e||"controller"===e){var s="module"===e;if(i=s?o.modules[r]:o.controllers[r],!i)return o;i.id&&delete require.cache[require.resolve(i.id)];var a=(s?"#":"")+r;return o.routes.web=o.routes.web.remove("controller",a),o.routes.files=o.routes.files.remove("controller",a),o.routes.websockets=o.routes.websockets.remove("controller",a),i&&(i.uninstall&&(framework.config["allow-compatibility"]?i.uninstall(o,t,r):i.uninstall(t,r)),s?delete o.modules[r]:delete o.controllers[r]),o._routesSort(),delete o.dependencies[e+"."+r],n||o.emit("uninstall",e,r),o}return o},Framework.prototype.eval=function(e){return this.install("eval",e)},Framework.prototype.onError=function(e,r,t){return console.log("======= "+(new Date).format("yyyy-MM-dd HH:mm:ss")+": "+(r?r+" ---> ":"")+e.toString()+(t?" ("+parser.format(t)+")":""),e.stack),this},Framework.prototype.onAuthorization=null,Framework.prototype.onAuthorize=null,Framework.prototype.onLocate=null,Framework.prototype.onTheme=null,Framework.prototype.onVersion=null,Framework.prototype.onMapping=function(e,r){if("/"!==e[0]&&(e="/"+e),this._length_themes){var t=e.indexOf("/",1);if(-1!==t){var n=e.substring(1,t);if(this.themes[n])return this.themes[n]+"public"+e.substring(t)}}return this.routes.mapping[e]?this.routes.mapping[e]:r},Framework.prototype.snapshot=function(e,r,t){var n=this;if(!e.match(/^http:|https:/gi)){"/"!==e[0]&&(e="/"+e);var o="auto"===n.ip?"0.0.0.0":n.ip;e="http://"+o+":"+n.port+e}return framework_utils.download(e,["get"],function(e,n){var o=fs.createWriteStream(r);n.pipe(o),FINISHED(o,function(){DESTROY(o),t&&setImmediate(t)})}),n},Framework.prototype.onValidation=null,Framework.prototype.onValidate=null,Framework.prototype.onParseXML=function(e){return framework_utils.parseXML(e)},Framework.prototype.onParseJSON=function(e){return JSON.parse(e)},Framework.prototype.onParseQuery=function(e){return e?qs.parse(e):{}},Framework.prototype.onSchema=function(e,r,t,n,o){var i=GETSCHEMA(r,t);return i?void i.make(e.body,function(e,r){e?n(e):n(null,r)},o):void n(new Error("Schema not found."))},Framework.prototype.onMail=function(e,r,t,n,o){var i;typeof n===STRING&&(i=o,o=n,n=i);var s=Mail.create(r,t);if(e instanceof Array)for(var a=e.length,u=0;a>u;u++)s.to(e[u]);else s.to(e);var c=this;s.from(c.config["mail.address.from"]||"",c.config.name),i=c.config["mail.address.reply"],o?s.reply(o):i&&i.isEmail()&&s.reply(c.config["mail.address.reply"]),i=c.config["mail.address.copy"],i&&i.isEmail()&&s.bcc(i);var l=c.temporary["mail-settings"];if(void 0===l){var f=c.config["mail.smtp.options"];f&&f.isJSON()&&(l=JSON.parse(f)),void 0===l&&(l={}),c.temporary["mail-settings"]=l}return setTimeout(function(){s.send(c.config["mail.smtp"],l,n)},2),s},Framework.prototype.onMeta=function(){for(var e=this,r="",t=arguments.length,n=0;t>n;n++){var o=utils.encode(arguments[n]);if(null!==o&&o.length)switch(n){case 0:r+="<title>"+(o+("/"===e.url||e.config["allow-custom-titles"]?"":" - "+e.config.name))+"</title>";break;case 1:r+='<meta name="description" content="'+o+'" />';break;case 2:r+='<meta name="keywords" content="'+o+'" />';break;case 3:var i=o.substring(0,6),s="http:/"===i||"https:"===i||"//"===o.substring(0,2)?o:e.hostname(e.routeImage(o));r+='<meta property="og:image" content="'+s+'" /><meta name="twitter:image" content="'+s+'" />'}}return r},Framework.prototype.log=function(){for(var e=this,r=new Date,t=r.getFullYear()+"-"+(r.getMonth()+1).toString().padLeft(2,"0")+"-"+r.getDate().toString().padLeft(2,"0"),n=r.getHours().toString().padLeft(2,"0")+":"+r.getMinutes().toString().padLeft(2,"0")+":"+r.getSeconds().toString().padLeft(2,"0"),o="",i=arguments.length,s=0;i>s;s++){var a=arguments[s];void 0===a?a="undefined":null===a?a="null":typeof a===OBJECT&&(a=util.inspect(a)),o+=(o?" ":"")+a}return e.path.verify("logs"),fs.appendFile(utils.combine(e.config["directory-logs"],t+".log"),n+" | "+o+"\n"),e},Framework.prototype.logger=function(){for(var e=this,r=new Date,t=r.getFullYear()+"-"+(r.getMonth()+1).toString().padLeft(2,"0")+"-"+r.getDate().toString().padLeft(2,"0")+" "+r.getHours().toString().padLeft(2,"0")+":"+r.getMinutes().toString().padLeft(2,"0")+":"+r.getSeconds().toString().padLeft(2,"0"),n="",o=arguments.length,i=1;o>i;i++){var s=arguments[i];void 0===s?s="undefined":null===s?s="null":typeof s===OBJECT&&(s=util.inspect(s)),n+=(n?" ":"")+s}return e.path.verify("logs"),fs.appendFile(utils.combine(e.config["directory-logs"],arguments[0]+".log"),t+" | "+n+"\n"),e},Framework.prototype.logmail=function(e,r,t,n){typeof t===FUNCTION?(n=t,t=r,r=null):void 0===t&&(t=r,r=null),r||(r=framework.config.name+" v"+framework.config.version);var t="<!DOCTYPE html><html><head><title>"+r+'</title><meta charset="utf-8" /></head><body><pre>'+(typeof t===OBJECT?JSON.stringify(t).escape():t)+"</pre></body></html>";return framework.onMail(e,r,t,n)},Framework.prototype.usage=function(e){var r=this,t=process.memoryUsage(),n=Object.keys(r.cache.items),o=Object.keys(r.resources),i=Object.keys(r.controllers),s=Object.keys(r.connections),a=Object.keys(r.workers),u=Object.keys(r.modules),c=Object.keys(r.isomorphic),l=Object.keys(r.models),f=Object.keys(r.helpers),p=Object.keys(r.temporary.path),d=Object.keys(r.temporary.range),m=Object.keys(r.routes.redirects),h={};h.framework={pid:process.pid,node:process.version,version:"v"+r.version_header,platform:process.platform,processor:process.arch,uptime:Math.floor(process.uptime()/60),memoryTotal:(t.heapTotal/1024/1024).floor(2),memoryUsage:(t.heapUsed/1024/1024).floor(2),mode:r.config.debug?"debug":"release",port:r.port,ip:r.ip,directory:process.cwd()};for(var g=Object.keys(framework_utils.queuecache),v=0,y=0,w=g.length;w>y;y++)v+=framework_utils.queuecache[g[y]].pending.length;return h.counter={resource:o.length,controller:i.length,module:u.length,isomorphic:c.length,cache:n.length,worker:a.length,connection:s.length,schedule:r.schedules.length,helpers:f.length,error:r.errors.length,problem:r.problems.length,queue:v,files:p.length,streaming:d.length,modificator:r.modificators?r.modificators.length:0},h.routing={webpage:r.routes.web.length,sitemap:r.routes.sitemap?Object.keys(r.routes.sitemap).length:0,websocket:r.routes.websockets.length,file:r.routes.files.length,middleware:Object.keys(r.routes.middleware).length,redirect:m.length},h.stats=r.stats,h.redirects=m,r.restrictions.isRestrictions&&(h.restrictions={allowed:[],blocked:[],allowedHeaders:r.restrictions.allowedCustomKeys,blockedHeaders:r.restrictions.blockedCustomKeys}),e?(h.controllers=[],i.forEach(function(e){var t=r.controllers[e];h.controllers.push({name:e,usage:void 0===t.usage?null:t.usage()})}),h.connections=[],s.forEach(function(e){h.connections.push({name:e,online:r.connections[e].online})}),h.modules=[],u.forEach(function(e){var t=r.modules[e];h.modules.push({name:e,usage:void 0===t.usage?null:t.usage()})}),h.models=[],l.forEach(function(e){var t=r.models[e];h.models.push({name:e,usage:void 0===t.usage?null:t.usage()})}),h.helpers=f,h.cache=n,h.resources=o,h.errors=r.errors,h.problems=r.problems,h.changes=r.changes,h.files=p,h.streaming=d,h.other=Object.keys(r.temporary.other),h):h},Framework.prototype.onCompileView=function(e,r,t){return r},Framework.prototype.onCompileStyle=null,Framework.prototype.onCompileCSS=null,Framework.prototype.onCompileScript=null,Framework.prototype.onCompileJS=null,Framework.prototype.compileContent=function(e,r,t){var n=this;if(t&&(-1!==t.indexOf(".min.")||-1!==t.indexOf("-min.")))return r;switch(e){case"js":return n.config["allow-compile-script"]?framework_internal.compile_javascript(r,t):r;case"css":r=n.config["allow-compile-style"]?framework_internal.compile_css(r,t):r;var o=r.match(/url\(.*?\)/g);return null===o?r:(o.forEach(function(e){var t=e.substring(4,e.length-1);r=r.replace(e,"url("+n._version(t)+")")}),r)}return r},Framework.prototype.compileFile=function(e,r,t,n,o){var i=this;return fsFileRead(t,function(s,a){if(s)return i.error(s,t,e),i.temporary.path[r]=null,void o();var u=i.path.temp((null===i.id?"":"instance-"+i.id+"-")+createTemporaryKey(e.pathname));i.path.verify("temp"),fs.writeFileSync(u,i.compileContent(n,framework_internal.parseBlock(i.routes.blocks[e.pathname],a.toString(ENCODING)),t),ENCODING),i.temporary.path[r]=u+";"+fs.statSync(u).size,o()}),i},Framework.prototype.compileMerge=function(e,r,t,n){var o=this,i=o.routes.merge[e.pathname],s=i.filename;if(!o.config.debug&&fs.existsSync(s))return o.temporary.path[r]=s+";"+fs.statSync(s).size,n(),o;var a=fs.createWriteStream(s);a.on("finish",function(){o.temporary.path[r]=s+";"+fs.statSync(s).size,n()});var u=0;return i.files.wait(function(r,n){var s;if("#"!==r[0]){var c=r.split("#");s=c[1],s&&(r=c[0])}if(r.startsWith("http://")||r.startsWith("https://"))return void Utils.request(r,["get"],function(e,i){var c=o.compileContent(t,framework_internal.parseBlock(s,i),r);"js"===t?";"!==c[c.length-1]&&(c+=";"):"html"===t&&c[c.length-1]!==NEWLINE&&(c+=NEWLINE),framework.isDebug&&merge_debug_writer(a,r,t,u++,s),framework.versionNode>=400?a.write(c):a.write(c,ENCODING),n()});if("#"===r[0])return framework.isDebug&&merge_debug_writer(a,r,"js",u++,s),framework.versionNode>=400?a.write(prepare_isomorphic(r.substring(1))):a.write(prepare_isomorphic(r.substring(1)),ENCODING),void n();if("~"!==r[0]){var l=o.path["public"](r);o.isVirtualDirectory&&!fs.existsSync(l)&&(l=o.path.virtual(r)),r=l}else r=r.substring(1);fsFileRead(r,function(c,l){if(c)return o.error(c,i.filename,e),void n();var f=o.compileContent(t,framework_internal.parseBlock(s,l.toString(ENCODING)),r);"js"===t?";"!==f[f.length-1]&&(f+=";"):"html"===t&&f[f.length-1]!==NEWLINE&&(f+=NEWLINE),framework.isDebug&&merge_debug_writer(a,r,t,u++,s),framework.versionNode>=400?a.write(f):a.write(f,ENCODING),n()})},function(){a.end()}),o},Framework.prototype.compileValidation=function(e,r,t,n,o){var i=this;if(i.routes.merge[e.pathname])return void i.compileMerge(e,r,n,o);if(!fs.existsSync(t)){if(!i.isVirtualDirectory)return i.temporary.path[r]=null,o(),i;var s=t.replace(i.config["directory-public"],i.config["directory-public-virtual"]),a=!0;if(s!==t&&(t=s,a=!fs.existsSync(t)),a)return i.temporary.path[r]=null,o(),i}return"js"!==n&&"css"!==n||-1!==t.lastIndexOf(".min.")||-1!==t.lastIndexOf("-min.")?(i.temporary.path[r]=t+";"+fs.statSync(t).size,
o(),i):(i.compileFile(e,r,t,n,o),i)},Framework.prototype.responseStatic=function(e,r,t){var n=this;if(r.success||r.headersSent)return t&&t(),n;var o=e.extension;if(!n.config["static-accepts"]["."+o])return n.response404(e,r),t&&t(),n;var i,s=e.uri.pathname,a=s.lastIndexOf("/"),u=n.routes.resize[s.substring(0,a+1)]||null,c=!1;if(null!==u?(s=s.substring(a+1),a=s.lastIndexOf("."),c=u.extension["*"]||u.extension[s.substring(a).toLowerCase()],c?(s=u.path+$decodeURIComponent(s),i=n.onMapping(s,"~"===s[0]?s.substring(1):"."===s[0]?s:framework.path["public"](s))):i=n.onMapping(s,framework.path["public"]($decodeURIComponent(s)))):i=n.onMapping(s,framework.path["public"]($decodeURIComponent(s))),!c){if("#"!==i[0])return n.responseFile(e,r,i,void 0,void 0,t),n;var l=i.substring(1),f=framework.isomorphic[l];if(!f)return void n.response404(e,r);var p=framework_utils.etag(i,(f.version||"")+"-"+(n.config["etag-version"]||""));if(RELEASE&&framework.notModified(e,r,p))return;var d={};return RELEASE&&(d.Etag=p,d.Expires=(new Date).add("y",1),d[RESPONSE_HEADER_CACHECONTROL]="public, max-age=11111111"),framework.responseContent(e,r,200,prepare_isomorphic(l),"text/javascript",!0,d),n}var m=u.cache?n.responseImage:n.responseImageWithoutCache;return m.call(n,e,r,i,function(e){(u.width||u.height)&&(u.width&&u.height?e.resizeCenter(u.width,u.height):e.resize(u.width,u.height)),u.grayscale&&e.grayscale(),u.blur&&e.blur("number"==typeof u.blur?u.blur:1),u.rotate&&typeof u.rotate==NUMBER&&e.rotate(u.rotate),u.flop&&e.flop(),u.flip&&e.flip(),u.sepia&&e.sepia("number"==typeof u.sepia?u.sepia:100),u.quality?e.quality(u.quality):e.quality(n.config["default-image-quality"]),e.minify()},void 0,t),n},Framework.prototype.restore=function(e,r,t,n){var o=new Backup;o.restore(e,r,t,n)},Framework.prototype.backup=function(e,r,t,n){var o=r.length,i=120;return framework_utils.ls(r,function(r,s){s.wait(function(r,t){var s=r.substring(o).replace(/\\/g,"/")+"/";return n&&!n(s)?t():void fs.appendFile(e,s.padRight(i)+":#\n",t)},function(){r.wait(function(r,t){var s=r.substring(o).replace(/\\/g,"/");return n&&!n(s)?t():void fs.readFile(r,function(r,n){zlib.gzip(n,function(r,n){return r?(framework.error(r,"framework.backup()",e),t()):void fs.appendFile(e,s.padRight(i)+":"+n.toString("base64")+"\n",t)})})},t)})}),this},Framework.prototype.exists=function(e,r,t,n){typeof t===TYPE_FUNCTION&&(n=t,t=10);var o=this,i=createTemporaryKey(e),s=o.path.temp(i),a=!1;if(RELEASE){var u=framework_utils.etag(e.url,o.config["etag-version"]);e.headers["if-none-match"]===u&&(a=!0)}return o.isProcessed(i)||a?(o.responseFile(e,r,s),o):(framework_utils.queue("framework.exists",t,function(t){fsFileExists(s,function(o){return o?void framework.responseFile(e,r,s,void 0,void 0,t):void n(t,s)})}),o)},Framework.prototype.isProcessed=function(e){var r=this;if(e.url){var t=e.url,n=t.indexOf("?");-1!==n&&(t=t.substring(0,n)),e=framework.path["public"]($decodeURIComponent(t))}return void 0!==r.temporary.path[e]?!0:!1},Framework.prototype.isProcessing=function(e){var r,t=this;if(e.url){r=e.url;var n=r.indexOf("?");-1!==n&&(r=r.substring(0,n)),e=utils.combine(t.config["directory-public"],$decodeURIComponent(r))}return r=t.temporary.processing[e],void 0!==t.temporary.processing[e]?!0:!1},Framework.prototype.noCache=function(e,r){return e.noCache(),r&&r.noCache(),this},Framework.prototype.responseFile=function(e,r,t,n,o,i,s){var a=this;if(r.success||r.headersSent)return i&&i(),a;"@"===t[0]&&(t=framework.path["package"](t.substring(1))),e.clear(!0),s||(s=createTemporaryKey(e));var u=a.temporary.path[s];if(null===u)return a.config.debug&&delete a.temporary.path[s],a.response404(e,r),i&&i(),a;var c,l=framework_utils.etag(e.url,a.config["etag-version"]),f=e.extension;if(f||(s&&(f=framework_utils.getExtension(s)),!f&&u&&(f=framework_utils.getExtension(u)),!f&&t&&(f=framework_utils.getExtension(t))),!a.config.debug&&e.headers["if-none-match"]===l)return c=HEADERS["responseFile.etag"],!r.getHeader("ETag")&&l?c.ETag=l:c.ETag&&delete c.ETag,r.getHeader("Expires")?c.Expires&&delete c.Expires:c.Expires=(new Date).add("y",1),c[RESPONSE_HEADER_CONTENTTYPE]=framework_utils.getContentType(f),r.success=!0,r.writeHead(304,c),r.end(),a.stats.response.notModified++,a._request_stats(!1,e.isStaticFile),i&&i(),e.isStaticFile||a.emit("request-end",e,r),a;if(void 0===u)return a.isProcessing(s)?e.processing>a.config["default-request-timeout"]?void a.response408(e,r):(e.processing+=500,setTimeout(function(){framework.responseFile(e,r,t,n,o,i,s)},500),a):(a.temporary.processing[s]=!0,a.compileValidation(e.uri,s,t,f,function(){delete a.temporary.processing[s],framework.responseFile(e,r,t,n,o,i,s)}),a);var p=u.lastIndexOf(";"),d=null;-1===p?p=u.length:d=u.substring(p+1),u=u.substring(0,p);var m=framework_utils.getContentType(f),h=e.headers["accept-encoding"]||"";!h&&isGZIP(e)&&(h="gzip");var g=a.config["allow-gzip"]&&REQUEST_COMPRESS_CONTENTTYPE[m]&&-1!==h.indexOf("gzip"),v=e.headers.range||"",y=RELEASE&&"text/cache-manifest"!==m;if(c=y?g?v?HEADERS["responseFile.release.compress.range"]:HEADERS["responseFile.release.compress"]:v?HEADERS["responseFile.release.range"]:HEADERS["responseFile.release"]:g?v?HEADERS["responseFile.debug.compress.range"]:HEADERS["responseFile.debug.compress"]:v?HEADERS["responseFile.debug.range"]:HEADERS["responseFile.debug"],e.$mobile?c.Vary="Accept-Encoding, User-Agent":c.Vary="Accept-Encoding",c[RESPONSE_HEADER_CONTENTTYPE]=m,y&&!r.getHeader("Expires")){var w=new Date;w.setFullYear(w.getFullYear()+1),c.Expires=w}else c.Expires&&delete c.Expires;return o&&(c=framework_utils.extend({},c,!0),framework_utils.extend(c,o,!0)),n?c["Content-Disposition"]='attachment; filename="'+encodeURIComponent(n)+'"':c["Content-Disposition"]&&delete c["Content-Disposition"],y&&l&&!r.getHeader("ETag")?c.Etag=l:c.Etag&&delete c.Etag,r.success=!0,v?(a.responseRange(u,v,c,e,r,i),a):(a.config.debug&&a.isProcessed(s)&&delete a.temporary.path[s],null===d||"0"===d||g?c[RESPONSE_HEADER_CONTENTLENGTH]&&delete c[RESPONSE_HEADER_CONTENTLENGTH]:c[RESPONSE_HEADER_CONTENTLENGTH]=d,a.stats.response.file++,a._request_stats(!1,e.isStaticFile),"HEAD"===e.method?(r.writeHead(200,c),r.end(),i&&i(),e.isStaticFile||a.emit("request-end",e,r),a):g?(r.writeHead(200,c),fsStreamRead(u,function(t,n){framework_internal.onFinished(r,function(e){framework_internal.destroyStream(t),n()}),t.pipe(zlib.createGzip()).pipe(r),i&&i(),e.isStaticFile||a.emit("request-end",e,r)}),a):(r.writeHead(200,c),fsStreamRead(u,function(t,n){t.pipe(r),framework_internal.onFinished(r,function(e){framework_internal.destroyStream(t),n()}),i&&i(),e.isStaticFile||a.emit("request-end",e,r)}),a))},Framework.prototype.responsePipe=function(e,r,t,n,o,i){var s=this;if(r.success||r.headersSent)return s;var a=parser.parse(t),u={};u[RESPONSE_HEADER_CACHECONTROL]="private",n&&utils.extend(u,n,!0),u["X-Powered-By"]=POWEREDBY;var c={protocol:a.protocol,auth:a.auth,method:"GET",hostname:a.hostname,port:a.port,path:a.path,agent:!1,headers:u},l="https:"===c.protocol?require("https"):http,f=-1!==(e.headers["accept-encoding"]||"").lastIndexOf("gzip"),p=l.get(c,function(t){if(!r.success&&!r.headersSent){var n=t.headers["content-type"],o=-1!==(t.headers["content-encoding"]||"").lastIndexOf("gzip"),i=!o&&f&&(-1!==n.indexOf("text/")||-1!==n.lastIndexOf("javascript")||-1!==n.lastIndexOf("json")),s=t.headers["content-disposition"]||"";return s&&r.setHeader("Content-Disposition",s),r.setHeader(RESPONSE_HEADER_CONTENTTYPE,n),r.setHeader("Vary","Accept-Encoding"+(e.$mobile?", User-Agent":"")),r.on("error",function(){t.close()}),i?(r.setHeader("Content-Encoding","gzip"),void t.pipe(zlib.createGzip()).pipe(r)):void(!f&&o?t.pipe(zlib.createGunzip()).pipe(r):t.pipe(r))}});return o&&p.setTimeout(o,function(){s.response408(e,r),i&&i()}),p.on("close",function(){r.success||r.headersSent||(e.clear(!0),r.success=!0,s.stats.response.pipe++,s._request_stats(!1,e.isStaticFile),r.success=!0,e.isStaticFile||s.emit("request-end",e,r),i&&i())}),s},Framework.prototype.responseCustom=function(e,r){var t=this;if(!r.success&&!r.headersSent)return e.clear(!0),r.success=!0,t.stats.response.custom++,t._request_stats(!1,e.isStaticFile),e.isStaticFile||t.emit("request-end",e,r),t},Framework.prototype.responseImage=function(e,r,t,n,o,i){var s=this,a=createTemporaryKey(e),u=s.temporary.path[a];if(null===u)return s.response404(e,r),i&&i(),s;var c=null;if(typeof t===OBJECT?c=t:"@"===t[0]&&(t=framework.path["package"](t.substring(1))),void 0!==u)return s.responseFile(e,r,"",void 0,o,i,a),s;var l="im"===s.config["default-image-converter"];if(s.isProcessing(a))return e.processing>s.config["default-request-timeout"]?(s.response408(e,r),void(i&&i())):(e.processing+=500,void setTimeout(function(){s.responseImage(e,r,t,n,o,i)},500));var f=null===s.id?"":"instance-"+s.id+"-";return u=s.path.temp(f+a),s.temporary.processing[a]=!0,null!==c?(fsFileExists(u,function(t){if(t)return delete s.temporary.processing[a],s.temporary.path[a]=u,s.responseFile(e,r,u,void 0,o,i,a),void(s.isDebug&&delete s.temporary.path[a]);s.path.verify("temp");var f=framework_image.load(c,l);n(f);var p=framework_utils.getExtension(u);p.substring(1)!==f.outputType&&(u=u.substring(0,u.lastIndexOf(p))+"."+f.outputType),f.save(u,function(t){return delete s.temporary.processing[a],t?(s.temporary.path[a]=null,s.response500(e,r,t),i&&i(),void(s.isDebug&&delete s.temporary.path[a])):(s.temporary.path[a]=u+";"+fs.statSync(u).size,void s.responseFile(e,r,u,void 0,o,i,a))})}),s):(fsFileExists(t,function(c){if(!c)return delete s.temporary.processing[a],s.temporary.path[a]=null,s.response404(e,r),i&&i(),void(s.isDebug&&delete s.temporary.path[a]);s.path.verify("temp");var f=framework_image.load(t,l);n(f);var p=framework_utils.getExtension(u);p.substring(1)!==f.outputType&&(u=u.substring(0,u.lastIndexOf(p))+"."+f.outputType),f.save(u,function(t){return delete s.temporary.processing[a],t?(s.temporary.path[a]=null,s.response500(e,r,t),i&&i(),void(s.isDebug&&delete s.temporary.path[a])):(s.temporary.path[a]=u+";"+fs.statSync(u).size,void s.responseFile(e,r,u,void 0,o,i,a))})}),s)},Framework.prototype.responseImagePrepare=function(e,r,t,n,o,i){var s=this,a=createTemporaryKey(e),u=s.temporary.path[a];return null===u?(s.response404(e,r),i&&i(),s):void 0!==u?(s.responseFile(e,r,"",void 0,o,i,a),s):s.isProcessing(a)?e.processing>s.config["default-request-timeout"]?(s.response408(e,r),void(i&&i())):(e.processing+=500,void setTimeout(function(){s.responseImage(e,r,filename,n,o,i)},500)):(t.call(s,function(t){return t?void s.responseImage(e,r,t,n,o,i):(s.response404(e,r),void(i&&i()))}),s)},Framework.prototype.responseImageWithoutCache=function(e,r,t,n,o,i){var s=this,a=null;typeof t===OBJECT?a=t:"@"===t[0]&&(t=framework.path["package"](t.substring(1)));var u="im"===s.config["default-image-converter"];if(null!==a){var c=framework_image.load(a,u);return n(c),s.responseStream(e,r,utils.getContentType(c.outputType),c.stream(),null,o,i),s}return fsFileExists(t,function(a){if(!a)return s.response404(e,r),void(i&&i());s.path.verify("temp");var c=framework_image.load(t,u);n(c),s.responseStream(e,r,utils.getContentType(c.outputType),c.stream(),null,o,i)}),s},Framework.prototype.responseStream=function(e,r,t,n,o,i,s,a){var u=this;if(r.success||r.headersSent)return s&&s(),u;e.clear(!0),-1===t.lastIndexOf("/")&&(t=utils.getContentType(t));var c=e.headers["accept-encoding"]||"";!c&&isGZIP(e)&&(c="gzip");var l,f=a===!1&&u.config["allow-gzip"]&&REQUEST_COMPRESS_CONTENTTYPE[t]&&-1!==c.indexOf("gzip");if(l=RELEASE?f?HEADERS["responseStream.release.compress"]:HEADERS["responseStream.release"]:f?HEADERS["responseStream.debug.compress"]:HEADERS["responseStream.debug"],l.Vary="Accept-Encoding"+(e.$mobile?", User-Agent":""),RELEASE){var p=new Date;p.setFullYear(p.getFullYear()+1),l.Expires=p,l["Last-Modified"]="Mon, 01 Jan 2001 08:00:00 GMT"}return i&&(l=framework_utils.extend({},l,!0),utils.extend(l,i,!0)),o?l["Content-Disposition"]="attachment; filename="+encodeURIComponent(o):l["Content-Disposition"]&&delete l["Content-Disposition"],l[RESPONSE_HEADER_CONTENTTYPE]=t,u.stats.response.stream++,u._request_stats(!1,e.isStaticFile),"HEAD"===e.method?(r.writeHead(200,l),r.end(),s&&s(),e.isStaticFile||u.emit("request-end",e,r),u):f?(r.writeHead(200,l),r.on("error",function(){n.close()}),n.pipe(zlib.createGzip()).pipe(r),framework_internal.onFinished(r,function(){framework_internal.destroyStream(n)}),s&&s(),e.isStaticFile||u.emit("request-end",e,r),u):(r.writeHead(200,l),framework_internal.onFinished(r,function(e){framework_internal.destroyStream(n)}),n.pipe(r),s&&s(),e.isStaticFile||u.emit("request-end",e,r),u)},Framework.prototype.responseRange=function(e,r,t,n,o,i){var s=this,a=r.replace(/bytes=/,"").split("-"),u=+a[0]||0,c=+a[1]||0,l=s.temporary.range[e]||0;0===l&&(l=fs.statSync(e).size,s.temporary.range[e]=l),0===c&&(c=l-1),u>c&&(u=0,c=l-1);var f=c-u+1;return t[RESPONSE_HEADER_CONTENTLENGTH]=f,t["Content-Range"]="bytes "+u+"-"+c+"/"+l,"HEAD"===n.method?(o.writeHead(206,t),o.end(),s.stats.response.streaming++,s._request_stats(!1,n.isStaticFile),i&&i(),n.isStaticFile||s.emit("request-end",n,o),s):(o.writeHead(206,t),RANGE.start=u,RANGE.end=c,fsStreamRead(e,RANGE,function(e,r){framework_internal.onFinished(o,function(){framework_internal.destroyStream(e),r()}),e.pipe(o),s.stats.response.streaming++,s._request_stats(!1,n.isStaticFile),i&&i(),n.isStaticFile||s.emit("request-end",n,o)}),s)},Framework.prototype.responseBinary=function(e,r,t,n,o,i,s,a){var u=this;if(r.success||r.headersSent)return a&&a(),u;o||(o="binary"),e.clear(!0),-1===t.lastIndexOf("/")&&(t=framework_utils.getContentType(t));var c=e.headers["accept-encoding"]||"";!c&&isGZIP(e)&&(c="gzip");var l=u.config["allow-gzip"]&&REQUEST_COMPRESS_CONTENTTYPE[t]&&-1!==c.indexOf("gzip"),f=l?HEADERS["responseBinary.compress"]:HEADERS.responseBinary;return f.Vary="Accept-Encoding"+(e.$mobile?", User-Agent":""),s&&(f=framework_utils.extend({},f,!0),framework_utils.extend(f,s,!0)),i?f["Content-Disposition"]="attachment; filename="+encodeURIComponent(i):f["Content-Disposition"]&&delete f["Content-Disposition"],f[RESPONSE_HEADER_CONTENTTYPE]=t,u.stats.response.binary++,u._request_stats(!1,e.isStaticFile),"HEAD"===e.method?(r.writeHead(200,f),r.end(),a&&a(),e.isStaticFile||u.emit("request-end",e,r),u):l?(r.writeHead(200,f),zlib.gzip("binary"===o?n:n.toString(o),function(e,t){r.end(t)}),a&&a(),e.isStaticFile||u.emit("request-end",e,r),u):(r.writeHead(200,f),r.end("binary"===o?n:n.toString(o)),a&&a(),e.isStaticFile||u.emit("request-end",e,r),u)},Framework.prototype.setModified=function(e,r,t){var n=this,o=typeof t===STRING;return o?(r.setHeader("Etag",t+":"+n.config["etag-version"]),n):(t=t||new Date,r.setHeader("Last-Modified",t.toUTCString()),n)},Framework.prototype.notModified=function(e,r,t,n){var o=this,i=typeof t;if(i===BOOLEAN){var s=t;t=n,n=s,i=typeof t}var a=i===STRING,u=e.headers[a?"if-none-match":"if-modified-since"];if(a){if(void 0===u)return!1;var c=t+":"+o.config["etag-version"];if(u!==c)return!1}else{if(void 0===u)return!1;var l=void 0===t?(new Date).toUTCString():t.toUTCString();if(n){if(new Date(Date.parse(u))===new Date(l))return!1}else if(new Date(Date.parse(u))<new Date(l))return!1}return r.success=!0,r.writeHead(304),r.end(),o.stats.response.notModified++,o._request_stats(!1,e.isStaticFile),e.isStaticFile||o.emit("request-end",e,r),!0},Framework.prototype.responseCode=function(e,r,t,n){var o=this;if(n&&o.problem(n,"response"+t+"()",e.uri,e.ip),r.success||r.headersSent)return o;o._request_stats(!1,e.isStaticFile),e.clear(!0),r.success=!0,r.writeHead(t,HEADERS.responseCode),"HEAD"===e.method?r.end():r.end(framework_utils.httpStatus(t)),e.isStaticFile||o.emit("request-end",e,r);var i="error"+t;return o.emit(i,e,r,n),o.stats.response[i]++,o},Framework.prototype.response400=function(e,r,t){return this.responseCode(e,r,400,t)},Framework.prototype.response401=function(e,r,t){return this.responseCode(e,r,401,t)},Framework.prototype.response403=function(e,r,t){return this.responseCode(e,r,403,t)},Framework.prototype.response404=function(e,r,t){return this.responseCode(e,r,404,t)},Framework.prototype.response408=function(e,r,t){return this.responseCode(e,r,408,t)},Framework.prototype.response431=function(e,r,t){return this.responseCode(e,r,431,t)},Framework.prototype.response500=function(e,r,t){var n=this;return t&&n.error(t,null,e.uri),r.success||r.headersSent?n:(n._request_stats(!1,e.isStaticFile),e.clear(!0),r.success=!0,r.writeHead(500,HEADERS.responseCode),"HEAD"===e.method?r.end():r.end(framework_utils.httpStatus(500)+prepare_error(t)),e.isStaticFile||n.emit("request-end",e,r),n.stats.response.error500++,n)},Framework.prototype.response501=function(e,r,t){return this.responseCode(e,r,501,t)},Framework.prototype.response503=function(e,r){var t=this,n="",o={};o[RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate",o[RESPONSE_HEADER_CONTENTTYPE]=CONTENTTYPE_TEXTHTML,r.writeHead(503,o);for(var i in t.wait)n+=(n?", ":"")+"<u>"+i+"</u>";return r.end('<html><head><meta charset="utf-8" /></head><body style="font:normal normal 11px Arial;color:gray;line-height:16px;padding:10px;background-color:white"><div style="font-size:14px;color:#505050">Please wait (<span id="time">10</span>) for <b>'+(t.config.name+" v"+t.config.version)+"</b> application.</div>The application is waiting for: "+n+'.<script>var i=10;setInterval(function(){i--;if(i<0)return;document.getElementById("time").innerHTML=(i===0?"refreshing":i);if(i===0)window.location.reload();},1000);</script></body></html>',ENCODING),t},Framework.prototype.responseContent=function(e,r,t,n,o,i,s){var a=this;if(r.success||r.headersSent)return a;e.clear(!0),r.success=!0,n||(n="");var u=e.headers["accept-encoding"]||"";!u&&isGZIP(e)&&(u="gzip");var c,l=i?-1!==u.indexOf("gzip"):!1;return c=e.$mobile?l?HEADERS["responseContent.mobile.compress"]:HEADERS["responseContent.mobile"]:l?HEADERS["responseContent.compress"]:HEADERS.responseContent,s&&(c=framework_utils.extend({},c,!0),framework_utils.extend(c,s,!0)),"application/json"===o?c[RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate":c[RESPONSE_HEADER_CACHECONTROL]="private",/text|application/.test(o)&&(o+="; charset=utf-8"),c[RESPONSE_HEADER_CONTENTTYPE]=o,"HEAD"===e.method?(r.writeHead(t,c),r.end(),a._request_stats(!1,e.isStaticFile),e.isStaticFile||a.emit("request-end",e,r),a):l?(r.writeHead(t,c),zlib.gzip(new Buffer(n),function(e,t){r.end(t,ENCODING)}),a._request_stats(!1,e.isStaticFile),e.isStaticFile||a.emit("request-end",e,r),a):(r.writeHead(t,c),r.end(n,ENCODING),a._request_stats(!1,e.isStaticFile),e.isStaticFile||a.emit("request-end",e,r),a)},Framework.prototype.responseRedirect=function(e,r,t,n){var o=this;if(!r.success&&!r.headersSent){o._request_stats(!1,e.isStaticFile),e.clear(!0),r.success=!0;var i=HEADERS.responseRedirect;return i.Location=t,r.writeHead(n?301:302,i),r.end(),e.isStaticFile||o.emit("request-end",e,r),o}},Framework.prototype.load=function(e,r,t){var n=this;return t&&"."===t[0]&&t.length<3?n.directory=directory=framework_utils.$normalize(require("path").normalize(directory+"/..")):t&&(n.directory=directory=framework_utils.$normalize(t)),n.isWorker=!0,n.config.debug=e,n.isDebug=e,global.DEBUG=e,global.RELEASE=!e,global.isomorphic=n.isomorphic,n._configure(),r&&-1===r.indexOf("versions")||n._configure_versions(),r&&-1===r.indexOf("sitemap")||n._configure_sitemap(),n.cache.init(),n.emit("init"),n.isLoaded=!0,setTimeout(function(){try{n.emit("load",n),n.emit("ready",n)}catch(e){n.error(e,'framework.on("load/ready")')}n.removeAllListeners("load"),n.removeAllListeners("ready"),delete framework.tests,delete framework.test,delete framework.testing,delete framework.assert},500),n.$load(r,directory),n},Framework.prototype.initialize=function(e,r,t){var n=this;if(null!==n.server)return n;t||(t={});var o=t.port,i=t.ip;return t.config&&framework_utils.copy(t.copy,n.config),n.isHTTPS=typeof e.STATUS_CODES===UNDEFINED,isNaN(o)&&typeof o!==STRING&&(o=null),n.config.debug=r,n.isDebug=r,global.DEBUG=r,global.RELEASE=!r,global.isomorphic=n.isomorphic,n._configure(),n._configure_versions(),n._configure_sitemap(),n.isTest&&n._configure("config-test",!1),n.cache.init(),n.emit("init"),n.clear(function(){if(n.$load(void 0,directory),t.https?n.server=e.createServer(t.https,n.listener):n.server=e.createServer(n.listener),n.config["allow-performance"]&&n.server.on("connection",function(e){e.setNoDelay(!0),e.setKeepAlive(!0,10)}),n.config["allow-websocket"]&&n.server.on("upgrade",framework._upgrade),!o)if("auto"===n.config["default-port"]){var r=+(process.env.PORT||"");isNaN(r)||(o=r)}else o=n.config["default-port"];if(n.port=o||8e3,null!==i?(n.ip=i||n.config["default-ip"]||"127.0.0.1",("null"===n.ip||n.ip===UNDEFINED||"auto"===n.ip)&&(n.ip=void 0)):n.ip=void 0,typeof t.sleep===NUMBER?setTimeout(function(){n.server.listen(n.port,n.ip)},t.sleep):n.server.listen(n.port,n.ip),(void 0===n.ip||null===n.ip)&&(n.ip="auto"),n.isLoaded=!0,process.connected||n.console(),setTimeout(function(){try{n.emit("load",n),n.emit("ready",n)}catch(e){n.error(e,'framework.on("load/ready")')}n.removeAllListeners("load"),n.removeAllListeners("ready")},500),n.isTest){var s=t.sleep||t.delay||1e3;return global.TEST=!0,global.assert=require("assert"),setTimeout(function(){n.test(!0,t.tests||t.test)},s),n}setTimeout(function(){framework.isTest||(delete framework.tests,delete framework.test,delete framework.testing,delete framework.assert)},5e3)},!0),n},Framework.prototype.http=function(e,r){return void 0===r&&(r={}),r.port||(r.port=+process.argv[2]),this.mode(require("http"),e,r)},Framework.prototype.https=function(e,r){return void 0===r&&(r={}),this.mode(require("https"),e,r)},Framework.prototype.mode=function(e,r,t){var n=this,o=!1,i=!1;if(typeof e===STRING){switch(e){case"debug":case"development":i=!0}return n.config.debug=i,n.isDebug=i,global.DEBUG=i,global.RELEASE=!i,n}switch(n.isWorker=!1,r.toLowerCase().replace(/\.|\s/g,"-")){case"release":case"production":break;case"debug":case"develop":case"development":i=!0;break;case"test":case"testing":case"test-debug":case"testing-debug":o=!0,i=!0,n.isTest=!0;break;case"test-release":case"testing-release":case"test-production":case"testing-production":o=!0,i=!1}return n.initialize(e,i,t)},Framework.prototype.console=function(){console.log("===================================================="),console.log("PID          : "+process.pid),"iojs"===process.argv[0]?console.log("io.js        : "+process.version):console.log("node.js      : "+process.version),console.log("total.js     : v"+framework.version_header),console.log("===================================================="),console.log("Name         : "+framework.config.name),console.log("Version      : "+framework.config.version),console.log("Author       : "+framework.config.author),console.log("Date         : "+(new Date).format("yyyy-MM-dd HH:mm:ss")),console.log("Mode         : "+(framework.config.debug?"debug":"release")),console.log("====================================================\n"),console.log("{2}://{0}:{1}/".format(framework.ip,framework.port,framework.isHTTPS?"https":"http")),console.log("")},Framework.prototype.reconnect=function(){var e=this;return void 0!==e.config["default-port"]&&(e.port=e.config["default-port"]),void 0!==e.config["default-ip"]&&(e.ip=e.config["default-ip"]),e.server.close(function(){e.server.listen(e.port,e.ip)}),e},Framework.prototype._service=function(e){var r=this;if(r.config.debug&&(r.resources={}),e%framework.config["default-interval-clear-cache"]===0&&(r.emit("clear","temporary",r.temporary),r.temporary.path={},r.temporary.range={},r.temporary.views={},r.temporary.other={}),e%framework.config["default-interval-precompile-views"]===0)for(var t in r.routes.views){var n=r.routes.views[t];r.install("view",t,n.url,null)}e%framework.config["default-interval-clear-dnscache"]===0&&framework_utils.clearDNS();var o=framework.config["default-interval-websocket-ping"];if(o>0&&e%o===0)for(var n in framework.connections){var i=framework.connections[n];i&&(i.check(),i.ping())}e%framework.config["default-interval-clear-resources"]===0&&(r.emit("clear","resources"),r.resources={},typeof gc!==UNDEFINED&&setTimeout(gc,1e3)),r.emit("service",e);var s=r.schedules.length;if(!s)return r;for(var a=(new Date).getTime(),u=0;;){var c=r.schedules[u++];if(!c)break;c.expire>a||(u--,c.repeat?c.expire=(new Date).add(c.repeat):r.schedules.splice(u,1),c.fn.call(r))}return r},Framework.prototype.listener=function(e,r){var t=framework;if(!e.host)return t.stats.response.destroy++,r.writeHead(403),void r.end();if(r.setHeader("X-Powered-By",POWEREDBY),t._length_wait)return t.response503(e,r);var n=e.headers,o=e.connection.encrypted||"https"===n["x-forwarded-protocol"]?"https":"http";if(r.req=e,e.res=r,e.uri=framework_internal.parseURI(o,e),t.stats.request.request++,t.emit("request",e,r),t._request_check_redirect){var i=t.routes.redirects[o+"://"+e.host];if(i)return t.stats.response.forward++,t.responseRedirect(e,r,i.url+(i.path?e.url:""),i.permanent),t}if(t.restrictions.isRestrictions){if(t.restrictions.isAllowedIP)for(var s=0,a=t.restrictions.allowedIP.length;a>s;s++){var u=t.restrictions.allowedIP[s];if(-1===e.ip.indexOf(u))return t.stats.response.restriction++,r.writeHead(403),r.end(),t}if(t.restrictions.isBlockedIP)for(var s=0,a=t.restrictions.blockedIP.length;a>s;s++){var u=t.restrictions.blockedIP[s];if(-1!==e.ip.indexOf(u))return t.stats.response.restriction++,r.writeHead(403),r.end(),t}if(t.restrictions.isAllowedCustom&&!t.restrictions._allowedCustom(n))return t.stats.response.restriction++,r.writeHead(403),r.end(),t;if(t.restrictions.isBlockedCustom&&t.restrictions._blockedCustom(n))return t.stats.response.restriction++,r.writeHead(403),r.end(),t}if(!e.host)return t.stats.response.destroy++,r.writeHead(403),r.end(),t;e.path=framework_internal.routeSplit(e.uri.pathname),e.body={},e.files=new Array(0),e.processing=0,e.session=null,e.user=null,e.isAuthorized=!0,e.xhr="XMLHttpRequest"===n["x-requested-with"],r.success=!1,t.isDebug&&r.setHeader("Mode","debug"),e.isStaticFile=framework.config["allow-handle-static-files"]?framework_utils.isStaticFile(e.uri.pathname):!1;var c=!0;if(e.isStaticFile)switch(e.extension=framework_utils.getExtension(e.uri.pathname).substring(1),e.extension){case"html":case"htm":case"txt":case"md":c=!0;break;default:c=!1}if(c&&t.onLocate&&(e.$language=t.onLocate(e,r,e.isStaticFile)),t._request_stats(!0,!0),0===t._length_request_middleware)return t._request_continue(e,r,n,o);if(e.behaviour("disable-middleware"))return t._request_continue(e,r,n,o);for(var l=new Array(t._length_request_middleware),f=0,s=0;s<t._length_request_middleware;s++){var p=t.routes.middleware[t.routes.request[s]];p?!function(e){l[f++]=function(t){e.call(framework,r.req,r,t)}}(p):t.error("Middleware not found: "+t.routes.request[s],null,e.uri)}l._async_middleware(r,function(){t._request_continue(r.req,r,r.req.headers,o)})},Framework.prototype._request_continue=function(e,r,t,n){var o=this;if(null===e||null===r||r.headersSent||r.success)return o;if(e.isStaticFile)return o.stats.request.file++,0===o._length_files?(o.responseStatic(e,r),o):(new Subscribe(o,e,r,3).file(),o);e.isProxy="total.js"===t["x-proxy"],e.buffer_exceeded=!1,e.buffer_data=new Buffer(""),e.buffer_has=!1,e.$flags=e.method;var i=t.accept;o.stats.request.web++;var s=[e.method.toLowerCase()],a=e.headers["content-type"]||"";e.mobile?(e.$flags+="_m_",o.stats.request.mobile++):o.stats.request.desktop++,e.$flags+=n,e.$type=0,s.push(n);var u=e.method,c=u[0];if("P"===c||"D"===c){var l=a.lastIndexOf(";"),f=a;switch(-1!==l&&(f=f.substring(0,l)),f.substring(f.length-4)){case"json":e.$flags+="json",s.push("json"),e.$type=1,a="";break;case"/xml":e.$flags+="xml",s.push("xml"),e.$type=2,a="";break;case"oded":e.$type=3,a="";break;case"data":e.$flags+="upload",s.push("upload");break;default:""===a?(e.$type=3,a=""):(a="",s.push("raw"))}}if(e.isProxy&&(e.$flags+="proxy",s.push("proxy")),"text/event-stream"===i&&(e.$flags+="sse",s.push("sse")),o.config.debug&&(e.$flags+="debug",s.push("debug")),e.xhr&&(o.stats.request.xhr++,e.$flags+="xhr",s.push("xhr")),o._request_check_referer){var p=t.referer||"";p&&-1!==p.indexOf(t.host)&&(e.$flags+="referer",s.push("referer"))}switch(e.flags=s,o.emit("request-begin",e,r),c){case"G":return o.stats.request.get++,new Subscribe(o,e,r,0).end(),o;case"O":return o.stats.request.options++,new Subscribe(o,e,r,0).end(),o;case"H":return o.stats.request.head++,new Subscribe(o,e,r,0).end(),o;case"D":return o.stats.request["delete"]++,new Subscribe(o,e,r,1).urlencoded(),o;case"P":if(o._request_check_POST)return a?(o.stats.request.upload++,new Subscribe(o,e,r,2).multipart(a)):("PUT"===u?o.stats.request.put++:o.stats.request.post++,new Subscribe(o,e,r,1).urlencoded()),o}return o.emit("request-end",e,r),o._request_stats(!1,!1),o.stats.request.blocked++,r.writeHead(403),r.end(),o},Framework.prototype._upgrade=function(e,r,t){if("websocket"===(e.headers.upgrade||"").toLowerCase()){r.setTimeout(0);var n=framework,o=e.headers,i=e.connection.encrypted||"https"===o["x-forwarded-protocol"]?"https":"http";if(e.uri=framework_internal.parseURI(i,e),n.emit("websocket",e,r,t),n.stats.request.websocket++,n.restrictions.isRestrictions){if(n.restrictions.isAllowedIP&&-1===n.restrictions.allowedIP.indexOf(e.ip))return n.stats.response.restriction++,res.writeHead(403),res.end(),n;if(n.restrictions.isBlockedIP&&-1!==n.restrictions.blockedIP.indexOf(e.ip))return n.stats.response.restriction++,res.writeHead(403),res.end(),n;if(n.restrictions.isAllowedCustom&&!n.restrictions._allowedCustom(o))return n.stats.response.restriction++,res.writeHead(403),res.end(),n;if(n.restrictions.isBlockedCustom&&n.restrictions._blockedCustom(o))return n.stats.response.restriction++,res.writeHead(403),res.end(),n}e.session=null,e.user=null,e.flags=[e.isSecure?"https":"http","get"];var s=framework_utils.path(e.uri.pathname),a=new WebSocketClient(e,r,t);if(e.path=framework_internal.routeSplit(e.uri.pathname),e.websocket=a,n.onLocate&&(e.$language=n.onLocate(e,r)),0===n._length_request_middleware)return n._upgrade_prepare(e,s,o);if(e.behaviour("disable-middleware"))return n._upgrade_prepare(e,s,o);for(var u=new Array(n._length_request_middleware),c=0,l=0;l<n._length_request_middleware;l++){var f=n.routes.middleware[n.routes.request[l]];f?!function(r){u[c++]=function(t){r.call(framework,e,e.websocket,t)}}(f):n.error("Middleware not found: "+route.middleware[l],null,e.uri)}u._async_middleware(a,function(){n._upgrade_prepare(e,s,e.headers)})}},Framework.prototype._upgrade_prepare=function(e,r,t){var n=this,o=n.onAuthorize||n.onAuthorization;if(!o){var i=n.lookup_websocket(e,e.websocket.uri.pathname,!0);return i?void n._upgrade_continue(i,e,r):(e.websocket.close(),void e.connection.destroy())}o.call(n,e,e.websocket,e.flags,function(t,o){o&&(e.user=o),e.flags.push(t?"authorize":"unauthorize");var i=n.lookup_websocket(e,e.websocket.uri.pathname,!1);return null===i?(e.websocket.close(),void e.connection.destroy()):void n._upgrade_continue(i,e,r)})},Framework.prototype._upgrade_continue=function(e,r,t){var n=this,o=r.websocket;if(!o.prepare(e.flags,e.protocols,e.allow,e.length,n.version_header))return o.close(),r.connection.destroy(),n;var i=t+(e.flags.length?"#"+e.flags.join("-"):"");e.isBINARY?o.type=1:e.isJSON&&(o.type=3);var s=function(){if(void 0===n.connections[i]){var s=new WebSocket(n,t,e.controller,i);s.route=e,s.options=e.options,n.connections[i]=s,e.onInitialize.apply(s,framework_internal.routeParam(e.param.length?framework_internal.routeSplit(r.uri.pathname,!0):r.path,e))}o.upgrade(n.connections[i])};if(e.middleware instanceof Array&&e.middleware.length){for(var a=new Array(e.middleware.length),u=0,c=0,l=e.middleware.length;l>c;c++){var f=framework.routes.middleware[e.middleware[c]];f&&!function(t){a[u++]=function(n){t.call(framework,r,o,n,e.options)}}(f)}return a._async_middleware(o,s),n;
}return s(),n},Framework.prototype._request_stats=function(e,r){var t=this;return e?t.stats.request.pending++:t.stats.request.pending--,t.stats.request.pending<0&&(t.stats.request.pending=0),t},Framework.prototype.model=function(e){var r=this,t=r.models[e];if(t||null===t)return t;if(void 0!==r.models[e])return r.models[e];var n=path.join(directory,r.config["directory-models"],e+EXTENSION_JS);return fs.existsSync(n)&&r.install("model",e,n,void 0,void 0,void 0,!0),r.models[e]||null},Framework.prototype.source=function(e,r,t){var n=this,o=n.sources[e];if(o||null===o)return o;if(void 0!==n.sources[e])return n.sources[e];var i=path.join(directory,n.config["directory-source"],e+EXTENSION_JS);return fs.existsSync(i)&&n.install("source",e,i,r,t,void 0,!0),n.sources[e]||null},Framework.prototype.include=function(e,r,t){return this.source(e,r,t)},Framework.prototype._log=function(e,r,t,n){var o=this;if(!o.isDebug)return!1;for(var i=arguments.length,s=["---->"],a=0;i>a;a++)s.push(arguments[a]);setTimeout(function(){console.log.apply(console,s)},1e3)},Framework.prototype.mail=function(e,r,t,n,o,i){if(typeof o===STRING){var s=i;i=o,o=s}var a=new Controller("",null,null,null,"");a.layoutName="",this.onTheme&&(a.themeName=this.onTheme(a));var u;return i&&(-1!==i.indexOf("@")?(u=i,i=void 0,OBSOLETE("F.mail","F.mail(..., ..., [replyTo] --> the argument was replaced for [language])")):a.language=i),typeof repository===OBJECT&&null!==repository&&(a.repository=repository),a.mail(e,r,t,n,o,u)},Framework.prototype.view=function(e,r,t,n,o){var i=new Controller("",null,null,null,"");if(typeof t===OBJECT){var s=n;n=t,t=s}i.layoutName=t||"",i.language=o,this.onTheme&&(i.themeName=this.onTheme(i)),typeof n===OBJECT&&null!==n&&(i.repository=n);var a=i.view(e,r,!0);return i=null,a},Framework.prototype.assert=function(e,r,t,n,o,i,s){var a=this;if(typeof r===TYPE_FUNCTION)return a.tests.push({name:_test+": "+e,priority:framework.testsPriority,index:a.tests.length,run:r}),a;var u="GET",c=0,l=0;if(s=s?framework_utils.extend({},s):{},t instanceof Array){c=t.length;for(var f=0;c>f;f++)switch(t[f].toLowerCase()){case"xhr":s["X-Requested-With"]="XMLHttpRequest";break;case"referer":case"referrer":s.Referer=r;break;case"json":s["Content-Type"]="application/json",l=1;break;case"xml":s["Content-Type"]="text/xml",l=2;break;case"get":case"options":u=t[f].toUpperCase();break;case"upload":s["Content-Type"]="multipart/form-data";break;case"post":case"put":case"delete":u=t[f].toUpperCase(),s["Content-Type"]||(s["Content-Type"]="application/x-www-form-urlencoded");break;case"raw":s["Content-Type"]="application/octet-stream"}}if(s["X-Assertion-Testing"]="1",s["X-Powered-By"]=POWEREDBY,i){var p=[],d=Object.keys(i);c=d.length;for(var f=0;c>f;f++)p.push(d[f]+"="+encodeURIComponent(i[d[f]]));p.length&&(s.Cookie=p.join("; "))}var m={name:_test+": "+e,priority:framework.testsPriority,index:a.tests.length,url:r,callback:n,method:u,data:o,headers:s};return a.tests.push(m),a},Framework.prototype.testing=function(e,r){void 0===e&&(e=!0);var t=this;if(0===t.tests.length){if(0===t.testsFiles.length)return r&&r(framework.isTestError===!0),e&&t.stop(framework.isTestError?1:0),t;var n=t.testsFiles.shift();try{n.fn.call(t,t),t.testing(e,r)}catch(o){console.log(new Error(o.stack,n.name,o.lineNumber)),framework.isTestError=!0,framework.testsNO++,t.testing(e,r)}return t}var i=function(e,r,t){var n=Math.floor(new Date-r)+" ms";return t?(framework.isTestError=!0,void console.error("Failed [x] ".padRight(20,".")+" "+e+" <"+(-1!==t.name.toLowerCase().indexOf("assert")?t.toString():t.stack)+"> ["+n+"]")):void console.info("Passed ".padRight(20,".")+" "+e+" ["+n+"]")},s=t.tests.shift(),a=s.name,u=new Date;if(s.run){try{framework.testContinue=function(n){i(a,u,n),n?framework.testsNO++:framework.testsOK++,t.testing(e,r)},s.run.call(t,function(){t.testContinue()},a)}catch(o){i(a,u,o),framework.isTestError=!0,framework.testsNO++,t.testing(e,r)}return t}var c=function(n){n._buffer="",n.on("data",function(e){this._buffer+=e.toString(ENCODING)}),n.on("end",function(){var o=n.headers.cookie||"",c={};if(0!==o.length)for(var l=o.split(";"),f=l.length,p=0;f>p;p++){var d=l[p].trim().split("=");c[d.shift()]=unescape(d.join("="))}try{s.callback(null,n._buffer,n.statusCode,n.headers,c,a),i(a,u),framework.testsOK++,t.testing(e,r)}catch(m){throw framework.testsNO++,i(a,u,m),t.testing(e,r),m}}),n.resume()},l=parser.parse((s.url.indexOf("http://")>0||s.url.indexOf("https://")>0?"":"http://"+t.ip+":"+t.port)+s.url);typeof s.data===TYPE_FUNCTION&&(s.data=s.data()),typeof s.data!==STRING&&(s.data=-1!==(s.headers[RESPONSE_HEADER_CONTENTTYPE]||"").indexOf("json")?JSON.stringify(s.data):qs.stringify(s.data));var f;s.data&&s.data.length&&(f=new Buffer(s.data,ENCODING),s.headers[RESPONSE_HEADER_CONTENTLENGTH]=f.length),l.method=s.method,l.headers=s.headers;var p="https:"===l.protocol?https:http,d="POST"===s.method||"PUT"===s.method?p.request(l,c):p.get(l,c);return d.on("error",function(n){i(a,u,n),t.testsNO++,t.testing(e,r)}),s.data?d.end(f):d.end(),t},Framework.prototype.test=function(e,r,t){var n=this;void 0===e&&(e=!0),typeof r===TYPE_FUNCTION?(t=r,r=[]):r=r||[];var o=0;n.isTest=!0;var i=n.config["directory-tests"];if(!fs.existsSync(framework_utils.combine(i)))return t&&t(),e&&setTimeout(function(){framework.stop(0)},500),n;n._configure("config-test",!0);var s=function(e,r,t){var n=Math.floor(new Date-r)+" ms";return t?(framework.isTestError=!0,void console.error("Failed [x] ".padRight(20,".")+" "+e+" <"+(-1!==t.name.toLowerCase().indexOf("assert")?t.toString():t.stack)+"> ["+n+"]")):void console.info("Passed ".padRight(20,".")+" "+e+" ["+n+"]")},a=function(){0!==framework.testsResults.length&&(console.log(""),console.log("===================== RESULTS ======================"),console.log(""),framework.testsResults.forEach(function(e){e()}))};return framework.testsFiles=[],framework.testsResults||(framework.testsResults=[]),framework.testsOK||(framework.testsOK=0),framework.testsNO||(framework.testsNO=0),framework_utils.ls(framework_utils.combine(i),function(u){return u.forEach(function(e){var t=path.relative(framework_utils.combine(i),e),a=e,u=framework_utils.getExtension(a).toLowerCase();if(u===EXTENSION_JS&&(!r.length||-1!==r.indexOf(t.substring(0,t.length-3)))){var c=require(a),l=new Date;try{var f=void 0!==c.run,p=void 0!==c.isInstall,d=void 0!==c.init,m=void 0!==c.load;if(_test=t,c.disabled===!0)return;void 0===c.order?framework.testsPriority=void 0===c.priority?n.testsFiles.length:c.priority:framework.testsPriority=c.priority;var h=null;if(f?h=c.run:p?h=c.install:d?h=c.init:m&&(h=c.loadname),null===h)return;n.testsFiles.push({name:t,index:n.testsFiles.length,fn:h,priority:framework.testsPriority}),c.usage&&!function(e){framework.testsResults.push(function(){e.usage(t)})}(c),o++}catch(g){s("Failed",l,g)}}}),_test="",0===o?(a(),t&&t(),e?(setTimeout(function(){framework.stop(1)},500),n):n):(n.testsFiles.sort(function(e,r){return e.priority>r.priority?1:e.priority<r.priority?-1:e.index>r.index?1:e.index<r.index?-1:0}),void setTimeout(function(){console.log("===================== TESTING ======================"),console.log(""),n.testing(e,function(){console.log(""),console.log("Passed ...",framework.testsOK),console.log("Failed ...",framework.testsNO),console.log(""),a(),n.isTest=!1,console.log(""),t&&t()})},100))}),n},Framework.prototype.clear=function(e,r){var t=this,n=t.path.temp();return r&&t.config["disable-clear-temporary-directory"]?(e&&e(),t):fs.existsSync(n)?(framework_utils.ls(n,function(o,i){if(r){for(var s=[],a=0,u=o.length;u>a;a++){var c=o[a].substring(n.length);-1===c.indexOf("/")&&s.push(o[a])}o=s,i=[]}t.unlink(o,function(){t.rmdir(i,e)})}),r||(t.temporary.path={},t.temporary.range={}),this):(e&&e(),t)},Framework.prototype.unlink=function(e,r){var t=this;if(typeof e===STRING&&(e=[e]),!e.length)return void(r&&r());var n=e.shift();return n?(fs.unlink(n,function(n){t.unlink(e,r)}),t):void(r&&r())},Framework.prototype.rmdir=function(e,r){var t=this;if(typeof e===STRING&&(e=[e]),!e.length)return void(r&&r());var n=e.shift();return n?(fs.rmdir(n,function(){t.rmdir(e,r)}),t):void(r&&r())},Framework.prototype.encrypt=function(e,r,t){var n=this;if(void 0===e)return"";var o=typeof e;if(typeof r===BOOLEAN){var i=t;t=r,r=i}return o===TYPE_FUNCTION&&(e=e()),o===NUMBER&&(e=e.toString()),o===OBJECT&&(e=JSON.stringify(e)),e.encrypt(n.config.secret+"="+r,t)},Framework.prototype.decrypt=function(e,r,t){if(typeof r===BOOLEAN){var n=t;t=r,r=n}typeof t!==BOOLEAN&&(t=!0);var o=this,i=(e||"").decrypt(o.config.secret+"="+r);if(null===i)return null;if(t){if(i.isJSON())try{return JSON.parse(i)}catch(s){}return null}return i},Framework.prototype.hash=function(e,r,t){var n=crypto.createHash(e),o="";return typeof t===STRING?o=t:t!==!1&&(o=this.config.secret||""),n.update(r.toString()+o,ENCODING),n.digest("hex")},Framework.prototype.resource=function(e,r){r||(r=e,e=null),e||(e="default");var t=this,n=t.resources[e];if(void 0!==n)return n[r]||"";var o=framework_utils.combine(t.config["directory-resources"],e+".resource");if(!fs.existsSync(o))return"";var i=fs.readFileSync(o).toString(ENCODING).parseConfig();return t.resources[e]=i,i[r]||""},Framework.prototype.translate=function(e,r){if(r||(r=e,e=void 0),"#"===r[0]&&" "!==r[1])return this.resource(e,r.substring(1));var t=this.resource(e,"T"+r.hash());return t?t:r},Framework.prototype.translator=function(e,r){return framework_internal.parseLocalization(r,e)},Framework.prototype._configure_sitemap=function(e,r){if(!e||typeof e===STRING){var t=prepare_filename(e||"sitemap");e=fs.existsSync(t)?fs.readFileSync(t).toString(ENCODING).split("\n"):null}var n=this;if(!e||!e.length)return n;r&&(n.routes.sitemap={}),n.routes.sitemap||(n.routes.sitemap={});for(var o=0,i=e.length;i>o;o++){var s=e[o];if(""!==s&&"#"!==s[0]&&"// "!==s.substring(0,3)){var a=s.indexOf(" :");if(-1!==a||(a=s.indexOf("	:"),-1!==a)){var u=s.substring(0,a).trim(),c=s.substring(a+2).trim(),l=c.split("-->");n.routes.sitemap[u]={name:l[0].trim(),url:l[1].trim(),parent:l[2]?l[2].trim():null}}}}return n},Framework.prototype.sitemap=function(e,r,t){var n=this;if(!n.routes.sitemap)return new Array(0);if(typeof r===STRING){t=r,r=t}var o=REPOSITORY_SITEMAP+e+"$"+(r?"1":"0")+"$"+(t||"");if(n.temporary.other[o])return n.temporary.other[o];var i,s=e;if(r===!0){i=n.routes.sitemap[e];var a={sitemap:s,id:"",name:"",url:"",last:!0,selected:!0,index:0};if(!i)return a;var u=i.name;return u.startsWith("@(")&&(u=n.translate(t,map.name.substring(2,map.name.length-1).trim())),a.sitemap=s,a.id=e,a.name=u,a.url=i.url,n.temporary.other[o]=a,a}for(var c=[],l=0;;){if(i=n.routes.sitemap[e],!i)break;var u=i.name;if(u.startsWith("@(")&&(u=n.translate(t,i.name.substring(2,i.name.length-1))),c.push({sitemap:s,id:e,name:u,url:i.url,last:0===l,first:i.parent?!1:!0,selected:0===l,index:l}),l++,e=i.parent,!e)break}return c.reverse(),n.temporary.other[o]=c,c},Framework.prototype._configure_dependencies=function(e){if(!e||typeof e===STRING){var r=prepare_filename(e||"dependencies");e=fs.existsSync(r)?fs.readFileSync(r).toString(ENCODING).split("\n"):null}var t=this;if(!e)return t;for(var n=0,o=e.length;o>n;n++){var i=e[n];if(""!==i&&"#"!==i[0]&&"// "!==i.substring(0,3)){var s=i.indexOf(" :");if(-1!==s||(s=i.indexOf("	:"),-1!==s)){var a=i.substring(0,s).trim(),u=i.substring(s+2).trim(),c={};if(s=u.indexOf("-->"),-1!==s){var l=u.substring(s+3).trim();l.isJSON()&&(c=JSON.parse(l)),u=u.substring(0,s).trim()}switch(a){case"package":case"packages":case"pkg":t.install("package",u,c);break;case"module":case"modules":t.install("module",u,c);break;case"model":case"models":t.install("model",u,c);break;case"source":case"sources":t.install("source",u,c);break;case"controller":case"controllers":t.install("controller",u,c);break;case"view":case"views":t.install("view",u,c);break;case"version":case"versions":t.install("version",u,c);break;case"config":case"configuration":t.install("config",u,c);break;case"isomorphic":case"isomorphics":t.install("isomorphic",u,c);break;case"definition":case"definitions":t.install("definition",u,c);break;case"middleware":case"middlewares":t.install("middleware",u,c)}}}}return t},Framework.prototype._configure_versions=function(e,r){var t=this;if(void 0===e||typeof e===STRING){var n=prepare_filename(e||"versions");e=fs.existsSync(n)?fs.readFileSync(n).toString(ENCODING).split("\n"):null}if(!e)return r&&(t.versions=null),t;r||(t.versions={}),t.versions||(t.versions={});for(var o=0,i=e.length;i>o;o++){var s=e[o];if(""!==s&&"#"!==s[0]&&"// "!==s.substring(0,3)){"/"!==s[0]&&(s="/"+s);var a=s.indexOf(" :"),u=!1;if(-1===a&&(a=s.indexOf("	:"),-1===a)){if(a=s.indexOf("-->"),-1===a)continue;u=!0}var c=u?3:2,l=s.substring(0,a).trim(),n=s.substring(a+c).trim();t.versions[l]=n,u&&t.map(n,t.path["public"](l))}}return t},Framework.prototype._configure=function(e,r){var t=this,n=typeof e;if(n===STRING){var o=prepare_filename(e);if(!fs.existsSync(o))return t;e=fs.readFileSync(o).toString(ENCODING).split("\n")}if(!e){var i=framework_utils.combine("/","config"),s=framework_utils.combine("/","config-"+(t.config.debug?"debug":"release"));e=[];var a=t.path.configs();if(fs.existsSync(a))for(var u=fs.readdirSync(a),c=0,l=u.length;l>c;c++){var f=u[c].match(/\-(debug|release|test)$/i);if(f){if(f=f[0].toString().toLowerCase(),"-debug"===f&&!t.isDebug)continue;if("-release"===f&&t.isDebug)continue;if("-test"===f&&!t.isTest)continue}e=e.concat(fs.readFileSync(a+u[c]).toString(ENCODING).split("\n"))}fs.existsSync(i)&&fs.lstatSync(i).isFile()&&(e=e.concat(fs.readFileSync(i).toString(ENCODING).split("\n"))),fs.existsSync(s)&&fs.lstatSync(s).isFile()&&(e=e.concat(fs.readFileSync(s).toString(ENCODING).split("\n")))}var p=function(){process.title="total: "+t.config.name.removeDiacritics().toLowerCase().replace(/\s/g,"-").substring(0,8),t.isVirtualDirectory=fs.existsSync(framework_utils.combine(t.config["directory-public-virtual"]))};if(!e instanceof Array||!e.length)return p(),t;void 0===r&&(r=!0);for(var u,d={},m=null,l=e.length,c=0;l>c;c++){var h=e[c];if(""!==h&&"#"!==h[0]&&"/"!==h[0]&&"/"!==h[1]){var g=h.indexOf(":");if(-1!==g){var v=h.substring(0,g).trim();if("debug"!==v&&"resources"!==v){var y=h.substring(g+1).trim();switch(v){case"default-request-length":case"default-websocket-request-length":case"default-request-timeout":case"default-interval-clear-cache":case"default-interval-clear-resources":case"default-interval-precompile-views":case"default-interval-websocket-ping":case"default-maximum-file-descriptors":case"default-interval-clear-dnscache":d[v]=framework_utils.parseInt(y);break;case"static-accepts-custom":m=y.replace(/\s/g,"").split(",");break;case"static-accepts":d[v]={},u=y.replace(/\s/g,"").split(",");for(var w=0;w<u.length;w++)d[v][u[w]]=!0;break;case"allow-compile-js":OBSOLETE("config",'Instead of "allow-compile-js" use "allow-compile-script"'),d["allow-compile-script"]="true"===y.toLowerCase()||"1"===y||"on"===y;break;case"allow-compile-css":OBSOLETE("config",'Instead of "allow-compile-css" use "allow-compile-style"'),d["allow-compile-style"]="true"===y.toLowerCase()||"1"===y||"on"===y;break;case"allow-gzip":case"allow-websocket":case"allow-performance":case"allow-compile-html":case"allow-compile-style":case"allow-compile-script":case"disable-strict-server-certificate-validation":case"disable-clear-temporary-directory":d[v]="true"===y.toLowerCase()||"1"===y||"on"===y;break;case"allow-compress-html":d["allow-compile-html"]="true"===y.toLowerCase()||"1"===y||"on"===y;break;case"version":d[v]=y;break;case"static-url-css":OBSOLETE("config",'Instead of "static-url-css" use "static-url-style"'),d["static-url-style"]=y;break;case"static-url-js":OBSOLETE("config",'Instead of "static-url-js" use "static-url-script"'),d["static-url-script"]=y;break;default:d[v]=y.isNumber()?framework_utils.parseInt(y):y.isNumber(!0)?framework_utils.parseFloat(y):y.isBoolean()?"true"===y.toLowerCase():y}}}}}return framework_utils.extend(t.config,d,r),""===t.config["etag-version"]&&(t.config["etag-version"]=t.config.version.replace(/\.|\s/g,"")),t.config["default-timezone"]&&(process.env.TZ=t.config["default-timezone"]),null!==m&&m.length&&m.forEach(function(e){t.config["static-accepts"][e]=!0}),t.config["disable-strict-server-certificate-validation"]===!0&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),t.config["allow-performance"]&&(http.globalAgent.maxSockets=9999),POWEREDBY="total.js v"+t.version_header,p(),t.emit("configure",t.config),t},Framework.prototype.routeJS=function(e){return OBSOLETE("framework.routeJS()",'Instead of "framework.routeJS()" use "framework.routeScript()"'),this.routeScript(e)},Framework.prototype.routeScript=function(e,r){var t=this;return-1===e.lastIndexOf(EXTENSION_JS)&&(e+=EXTENSION_JS),t._routeStatic(e,t.config["static-url-script"],r)},Framework.prototype.routeCSS=function(e){return OBSOLETE("framework.routeCSS()",'Instead of "framework.routeCSS()" use "framework.routeStyle()"'),this.routeStyle(e)},Framework.prototype.routeStyle=function(e,r){var t=this;return-1===e.lastIndexOf(".css")&&(e+=".css"),t._routeStatic(e,t.config["static-url-style"],r)},Framework.prototype.routeImage=function(e,r){var t=this;return t._routeStatic(e,t.config["static-url-image"],r)},Framework.prototype.routeVideo=function(e,r){var t=this;return t._routeStatic(e,t.config["static-url-video"],r)},Framework.prototype.routeFont=function(e,r){var t=this;return t._routeStatic(e,t.config["static-url-font"],r)},Framework.prototype.routeDownload=function(e,r){var t=this;return t._routeStatic(e,t.config["static-url-download"],r)},Framework.prototype.routeStatic=function(e,r){var t=this;return t._routeStatic(e,t.config["static-url"],r)},Framework.prototype._routeStatic=function(e,r,t){var n=e+r+"$"+t,o=framework.temporary.other[n];if(RELEASE&&o)return o;"~"===e[0]&&(e=e.substring("~"===e[1]?2:1),t="");var i=framework_utils.join(t,r,this._version(e));return framework.temporary.other[n]=this._version(i)},Framework.prototype._version=function(e){var r=this;return null!==r.versions&&(e=r.versions[e]||e),null!==r.onVersion&&(e=r.onVersion(e)||e),e},Framework.prototype._version_prepare=function(e){var r=this,t=e.match(REG_VERSIONS);if(!t)return e;for(var n=0,o=t.length;o>n;n++){var i=t[n].toString(),s=5;"h"===i[0]&&(s=6);var a=i.substring(s,i.length-1);e=e.replace(t[n],i.substring(0,s)+r._version(a)+'"')}return e},Framework.prototype.lookup=function(e,r,t,n){var o=this,i="#"===r[0],s=null===e.subdomain?null:e.subdomain.join(".");i&&(e.path=[r]),e.$isAuthorized=!0;var a;if(!i&&(a="#"+r+"$"+e.$flags+(s?"$"+s:""),framework.temporary.other[a]))return framework.temporary.other[a];for(var u=o.routes.web.length,c=0;u>c;c++){var l=o.routes.web[c];if(l.CUSTOM){if(!l.CUSTOM(r,e,t))continue}else{if(!framework_internal.routeCompareSubdomain(s,l.subdomain))continue;if(l.isASTERIX){if(!framework_internal.routeCompare(e.path,l.url,i,!0))continue}else if(!framework_internal.routeCompare(e.path,l.url,i))continue}{if(!i){if(l.isPARAM&&l.regexp){for(var f=!1,p=0,d=l.regexpIndexer.length;d>p;p++){var m=e.path[l.regexpIndexer[p]];if(void 0===m){f=!0;break}if(!l.regexp[l.regexpIndexer[p]].test(m)){f=!0;break}}if(f)continue}if(null!==l.flags&&l.flags.length){var h=framework_internal.routeCompareFlags2(e,l,n?!0:l.isMEMBER);if(-1===h&&(e.$isAuthorized=!1),1>h)continue}return a&&l.isCACHE&&e.$isAuthorized&&(framework.temporary.other[a]=l),l}if(l.isSYSTEM)return l}}return null},Framework.prototype.lookup_websocket=function(e,r,t){var n=this,o=null===e.subdomain?null:e.subdomain.join("."),i=n.routes.websockets.length;e.$isAuthorized=!0;for(var s=0;i>s;s++){var a=n.routes.websockets[s];if(a.CUSTOM){if(!a.CUSTOM(r,e))continue}else{if(!framework_internal.routeCompareSubdomain(o,a.subdomain))continue;if(a.isASTERIX){if(!framework_internal.routeCompare(e.path,a.url,!1,!0))continue}else if(!framework_internal.routeCompare(e.path,a.url,!1))continue}if(a.isPARAM&&a.regexp){for(var u=!1,c=0,l=a.regexpIndexer.length;l>c;c++){var f=e.path[a.regexpIndexer[c]];if(void 0===f){u=!0;break}if(!a.regexp[a.regexpIndexer[c]].test(f)){u=!0;break}}if(u)continue}if(null!==a.flags&&a.flags.length){var p=framework_internal.routeCompareFlags2(e,a,t?!0:a.isMEMBER);if(-1===p&&(e.$isAuthorized=!1),1>p)continue}return a}return null},Framework.prototype.accept=function(e,r){var t=this;return"."!==e[0]&&(e="."+e),t.config["static-accepts"][e]=!0,r&&framework_utils.setContentType(e,r),t},Framework.prototype.worker=function(e,r,t,n){var o=this,i=null,s=typeof r;if(s===NUMBER&&void 0===t&&(t=r,r=null,s=UNDEFINED),s===STRING&&(i=o.workers[r]||null),r instanceof Array&&(n=r,r=null,t=void 0),t instanceof Array&&(n=t,t=void 0),null!==i)return i;var a=framework_utils.combine(o.config["directory-workers"],e)+EXTENSION_JS;return n||(n=new Array(0)),i=child.fork(a,n,{cwd:directory}),r||(r=e+"_"+(new Date).getTime()),i.__id=r,o.workers[r]=i,i.on("exit",function(){var e=this;e.__timeout&&clearTimeout(e.__timeout),delete framework.workers[e.__id]}),typeof t!==NUMBER?i:(i.__timeout=setTimeout(function(){i.kill(),i=null},t),i)},Framework.prototype.wait=function(e,r){var t=this;return t.wait||(t.wait={}),void 0!==r?(r?t.wait[e]=!0:delete t.wait[e],t._length_wait=Object.keys(t.wait).length,r):(t.wait[e]?delete t.wait[e]:(t.wait[e]=!0,r=!0),t._length_wait=Object.keys(t.wait).length,r===!0)},FrameworkRestrictions.prototype.allow=function(e,r){var t=this;return void 0===r?(t.allowedIP.push(e),t.refresh(),framework):(void 0===t.allowedCustom[e]?t.allowedCustom[e]=[r]:t.allowedCustom[e].push(r),t.refresh(),framework)},FrameworkRestrictions.prototype.disallow=function(e,r){var t=this;return void 0===r?(t.blockedIP.push(e),t.refresh(),framework):(void 0===t.blockedCustom[e]?t.blockedCustom[e]=[r]:t.blockedCustom[e].push(r),t.refresh(),framework)},FrameworkRestrictions.prototype.refresh=function(){var e=this;return e.isAllowedIP=e.allowedIP.length>0,e.isBlockedIP=e.blockedIP.length>0,e.isAllowedCustom=!framework_utils.isEmpty(e.allowedCustom),e.isBlockedCustom=!framework_utils.isEmpty(e.blockedCustom),e.allowedCustomKeys=Object.keys(e.allowedCustom),e.blockedCustomKeys=Object.keys(e.blockedCustom),e.isRestrictions=e.isAllowedIP||e.isBlockedIP||e.isAllowedCustom||e.isBlockedCustom,framework},FrameworkRestrictions.prototype.clearIP=function(){var e=this;return e.allowedIP=[],e.blockedIP=[],e.refresh(),framework},FrameworkRestrictions.prototype.clearHeaders=function(){var e=this;return e.allowedCustom={},e.blockedCustom={},e.allowedCustomKeys=[],e.blockedCustomKeys=[],e.refresh(),framework},FrameworkRestrictions.prototype._allowedCustom=function(e){for(var r=this,t=r.allowedCustomKeys.length,n=0;t>n;n++){var o=r.allowedCustomKeys[n],i=e[o];if(void 0===i)return!1;for(var s=r.allowedCustom[o],a=s.length,u=0;a>u;u++)if(-1!==i.search(s[u]))return!1}return!0},FrameworkRestrictions.prototype._blockedCustom=function(e){for(var r=this,t=r.blockedCustomKeys.length,n=0;t>n;n++){var o=r.blockedCustomKeys[n],i=e[o];if(void 0===i)return!1;for(var s=r.blockedCustom[o],a=s.length,u=0;a>u;u++)if(-1!==i.search(s[u]))return!0}return!1},FrameworkFileSystem.prototype.deleteStyle=function(e){var r=this;-1===e.lastIndexOf(".css")&&(e+=".css");var t=framework_utils.combine(framework.config["directory-public"],framework.config["static-url-style"],e);return r.deleteFile(t)},FrameworkFileSystem.prototype.deleteScript=function(e){var r=this;-1===e.lastIndexOf(EXTENSION_JS)&&(e+=EXTENSION_JS);var t=framework_utils.combine(framework.config["directory-public"],framework.config["static-url-script"],e);return r.deleteFile(t)},FrameworkFileSystem.prototype.deleteView=function(e){var r=this;-1===e.lastIndexOf(".html")&&(e+=".html");var t=framework_utils.combine(framework.config["directory-views"],e);return r.deleteFile(t)},FrameworkFileSystem.prototype.deleteDatabase=function(e){var r=this,t=framework_utils.combine(framework.config["directory-databases"],e);return r.deleteFile(t)},FrameworkFileSystem.prototype.deleteWorker=function(e){var r=this;-1===e.lastIndexOf(EXTENSION_JS)&&(e+=EXTENSION_JS);var t=framework_utils.combine(framework.config["directory-workers"],e);return r.deleteFile(t)},FrameworkFileSystem.prototype.deleteResource=function(e){var r=this;-1===e.lastIndexOf(".resource")&&(e+=".resource");var t=framework_utils.combine(framework.config["directory-resources"],e);return r.deleteFile(t)},FrameworkFileSystem.prototype.deleteTemporary=function(e){var r=this,t=framework_utils.combine(framework.config["directory-temp"],e);return r.deleteFile(t)},FrameworkFileSystem.prototype.deleteFile=function(e){return fsFileExists(e,function(r){r&&fs.unlink(e)}),!0},FrameworkFileSystem.prototype.createStyle=function(e,r,t,n){var o=this;if(!r)return!1;-1===e.lastIndexOf(".css")&&(e+=".css");var i=framework_utils.combine(framework.config["directory-public"],framework.config["static-url-style"],e);return o.createFile(i,r,n,t)},FrameworkFileSystem.prototype.createScript=function(e,r,t,n){var o=this;if(!r)return!1;-1===e.lastIndexOf(EXTENSION_JS)&&(e+=EXTENSION_JS);var i=framework_utils.combine(framework.config["directory-public"],framework.config["static-url-script"],e);return o.createFile(i,r,n,t)},FrameworkFileSystem.prototype.createDatabase=function(e,r,t,n){var o=this;if(!r)return!1;var i=framework_utils.combine(framework.config["directory-databases"],e);return o.createFile(i,r,n,t)},FrameworkFileSystem.prototype.createView=function(e,r,t,n){var o=this;if(!r)return!1;-1===e.lastIndexOf(".html")&&(e+=".html"),framework.path.verify("views");var i=framework_utils.combine(framework.config["directory-views"],e);return o.createFile(i,r,n,t)},FrameworkFileSystem.prototype.createWorker=function(e,r,t,n){var o=this;if(!r)return!1;-1===e.lastIndexOf(EXTENSION_JS)&&(e+=EXTENSION_JS),framework.path.verify("workers");var i=framework_utils.combine(framework.config["directory-workers"],e);return o.createFile(i,r,n,t)},FrameworkFileSystem.prototype.createResource=function(e,r,t,n){var o=this;if(!r)return!1;-1===e.lastIndexOf(".resource")&&(e+=".resource");var i=r;typeof r===OBJECT&&(i="",Object.keys(r).forEach(function(e){i+=e.padRight(20," ")+": "+r[e]+"\n"})),framework.path.verify("resources");var s=framework_utils.combine(framework.config["directory-resources"],e);return o.createFile(s,i,n,t)},FrameworkFileSystem.prototype.createTemporary=function(e,r,t){var n=this;if("string"==typeof r)return void framework_utils.download(r,["get"],function(r,o){return r?t?t(r):void F.error(r):void n.createTemporary(e,o,t)});framework.path.verify("temp");var o=framework_utils.combine(framework.config["directory-temp"],e),i=fs.createWriteStream(o);return t?(i.on("error",function(e){t(e,o)}),i.on("finish",function(){t(null,o)}),r.pipe(i),n):(r.pipe(i),n)},FrameworkFileSystem.prototype.createFile=function(e,r,t,n,o){var i=this;if("http://"===r.substring(0,7)||"https://"===r.substring(0,8))return framework_utils.request(r,["get"],function(r,s){r||i.createFile(e,s,t,n),typeof o===TYPE_FUNCTION&&o(r,e)}),!0;if(!r)return!1;var s=fs.existsSync(e);if(s&&t){var a=fs.readFileSync(e).toString(ENCODING);return-1===a.indexOf(r)?(fs.appendFileSync(e,"\n"+r),!0):!1}return s&&!n?!1:(fs.writeFileSync(e,r,ENCODING),typeof o===TYPE_FUNCTION&&o(null,e),!0)},FrameworkPath.prototype.verify=function(e){var r="$directory-"+e;if(framework.temporary.path[r])return framework;var t=framework_utils.combine(framework.config["directory-"+e]);return fs.existsSync(t)||fs.mkdirSync(t),framework.temporary.path[r]=!0,framework},FrameworkPath.prototype["public"]=function(e){return framework_utils.combine(framework.config["directory-public"],e||"")},FrameworkPath.prototype["private"]=function(e){return framework_utils.combine(framework.config["directory-private"],e||"")},FrameworkPath.prototype.isomorphic=function(e){return framework_utils.combine(framework.config["directory-isomorphic"],e||"")},FrameworkPath.prototype.configs=function(e){return framework_utils.combine(framework.config["directory-configs"],e||"")},FrameworkPath.prototype.virtual=function(e){return framework_utils.combine(framework.config["directory-public-virtual"],e||"")},FrameworkPath.prototype.logs=function(e){return this.verify("logs"),framework_utils.combine(framework.config["directory-logs"],e||"")},FrameworkPath.prototype.models=function(e){return framework_utils.combine(framework.config["directory-models"],e||"")},FrameworkPath.prototype.temp=function(e){return this.verify("temp"),framework_utils.combine(framework.config["directory-temp"],e||"")},FrameworkPath.prototype.temporary=function(e){return this.temp(e)},FrameworkPath.prototype.views=function(e){return framework_utils.combine(framework.config["directory-views"],e||"")},FrameworkPath.prototype.workers=function(e){return framework_utils.combine(framework.config["directory-workers"],e||"")},FrameworkPath.prototype.databases=function(e){return this.verify("databases"),framework_utils.combine(framework.config["directory-databases"],e||"")},FrameworkPath.prototype.modules=function(e){return framework_utils.combine(framework.config["directory-modules"],e||"")},FrameworkPath.prototype.controllers=function(e){return framework_utils.combine(framework.config["directory-controllers"],e||"")},FrameworkPath.prototype.definitions=function(e){return framework_utils.combine(framework.config["directory-definitions"],e||"")},FrameworkPath.prototype.tests=function(e){return framework_utils.combine(framework.config["directory-tests"],e||"")},FrameworkPath.prototype.resources=function(e){return framework_utils.combine(framework.config["directory-resources"],e||"")},FrameworkPath.prototype.services=function(e){return framework_utils.combine(framework.config["directory-services"],e||"")},FrameworkPath.prototype.packages=function(e){return framework_utils.combine(framework.config["directory-packages"],e||"")},FrameworkPath.prototype.themes=function(e){return framework_utils.combine(framework.config["directory-themes"],e||"")},FrameworkPath.prototype.root=function(e){var r=path.join(directory,e||"");return framework.isWindows?r.replace(/\\/g,"/"):r},FrameworkPath.prototype["package"]=function(e,r){var t=path.join(directory,framework.config["directory-temp"],e,r||"");return framework.isWindows?t.replace(/\\/g,"/"):t},FrameworkCache.prototype.init=function(e){var r=this;return r.interval=setInterval(function(){framework.cache.recycle()},e||6e4),r},FrameworkCache.prototype.stop=function(){var e=this;return clearInterval(e.interval),e},FrameworkCache.prototype.clear=function(){var e=this;return e.items={},e},FrameworkCache.prototype.recycle=function(){var e=this,r=e.items,t=new Date;e.count++;for(var n in r){var o=r[n];o.expire<t&&(framework.emit("cache-expire",n,o.value),delete r[n])}return framework._service(e.count),e},FrameworkCache.prototype.add=function(e,r,t,n){var o=this,i=typeof t;switch(i){case STRING:t=t.parseDateExpiration();break;case UNDEFINED:t=(new Date).add("m",5)}return o.items[e]={value:r,expire:t},framework.emit("cache-set",e,r,t,n),r},FrameworkCache.prototype.set=function(e,r,t,n){return this.add(e,r,t,n)},FrameworkCache.prototype.read=function(e,r){return this.get(e)},FrameworkCache.prototype.get=function(e,r){var t=this,n=t.items[e]||null;return null===n?typeof r===UNDEFINED?null:r:n.expire<new Date?typeof r===UNDEFINED?null:r:n.value},FrameworkCache.prototype.setExpire=function(e,r){var t=this,n=t.items[e];return void 0===n?t:(typeof r===STRING&&(r=r.parseDateExpiration()),n.expire=r,t)},FrameworkCache.prototype.remove=function(e){var r=this,t=r.items[e]||null;return delete r.items[e],t},FrameworkCache.prototype.removeAll=function(e){var r=this,t=0,n=framework_utils.isRegExp(e);for(var o in r.items){if(n){if(!e.test(o))continue}else if(-1===o.indexOf(e))continue;r.remove(o),t++}return t},FrameworkCache.prototype.fn=function(e,r,t){var n=this,o=n.read(e);return null!==o?(t&&t(o),n):(r(function(r,o){n.add(e,r,o),t&&t(r)}),n)};var REPOSITORY_HEAD="$head",REPOSITORY_META="$meta",REPOSITORY_META_TITLE="$title",REPOSITORY_META_DESCRIPTION="$description",REPOSITORY_META_KEYWORDS="$keywords",REPOSITORY_META_IMAGE="$image",REPOSITORY_PLACE="$place",REPOSITORY_SITEMAP="$sitemap",ATTR_END='"';
Subscribe.prototype.success=function(){var e=this;return e.timeout&&clearTimeout(e.timeout),e.timeout=null,e.isCanceled=!0,e},Subscribe.prototype.file=function(){var e=this;return e.req.on("end",function(){e.doEndfile(this)}),e.req.resume(),e},Subscribe.prototype.multipart=function(e){var r=this,t=r.req;return r.route=framework.lookup(t,t.uri.pathname,t.flags,!0),r.header=e,null===r.route?(framework._request_stats(!1,!1),framework.stats.request.blocked++,r.res.writeHead(403),r.res.end(),r):(framework.path.verify("temp"),framework_internal.parseMULTIPART(t,e,r.route,framework.config["directory-temp"],r),r)},Subscribe.prototype.urlencoded=function(){var e=this;return e.route=framework.lookup(e.req,e.req.uri.pathname,e.req.flags,!0),null===e.route?(e.req.clear(!0),framework.stats.request.blocked++,framework._request_stats(!1,!1),e.res.writeHead(403),e.res.end(),e):(e.req.buffer_has=!0,e.req.buffer_exceeded=!1,e.req.on("data",function(r){e.doParsepost(r)}),e.end(),e)},Subscribe.prototype.end=function(){var e=this;e.req.on("end",function(){e.doEnd()}),e.req.resume()},Subscribe.prototype.execute=function(e,r){var t=this,n=t.route,o=t.req,i=t.res;if(r||!n){switch(e){case 400:framework.stats.response.error400++;break;case 401:framework.stats.response.error401++;break;case 403:framework.stats.response.error403++;break;case 404:framework.stats.response.error404++;break;case 408:framework.stats.response.error408++;break;case 431:framework.stats.response.error431++;break;case 500:framework.stats.response.error500++;break;case 501:framework.stats.response.error501++}500!==e&&framework.emit("error"+e,o,i,t.exception)}if(null===n){if(e||(e=404),400===e&&t.exception instanceof Builders.ErrorBuilder){o.$language&&t.exception.resource(o.$language,framework.config["default-errorbuilder-resource-prefix"]);var s=t.exception.output();return framework.responseContent(o,i,200,s,t.exception.contentType,framework.config["allow-gzip"]),t}return framework.responseContent(o,i,e,framework_utils.httpStatus(e)+prepare_error(t.exception),CONTENTTYPE_TEXTPLAIN,framework.config["allow-gzip"]),t}var a=n.controller;n.isMOBILE_VARY&&(o.$mobile=!0),void 0===n.currentViewDirectory&&(n.currentViewDirectory="#"!==a[0]&&"default"!==a&&""!==a?"/"+a+"/":"");var u=new Controller(a,o,i,t,n.currentViewDirectory);if(u.isTransfer=t.isTransfer,u.exception=t.exception,t.controller=u,!t.isCanceled&&n.timeout>0&&(t.timeout=setTimeout(function(){t.doCancel()},n.timeout)),n.isDELAY&&t.res.writeContinue(),0===framework._length_middleware||null===n.middleware)return t.doExecute();for(var c=n.middleware.length,l=new Array(c),f=0,p=0;c>p;p++){var d=framework.routes.middleware[n.middleware[p]];d?!function(e){l[f++]=function(r){e.call(framework,o,i,r,n.options,u)}}(d):framework.error("Middleware not found: "+n.middleware[p],u.name,o.uri)}return l._async_middleware(i,function(){t.doExecute()}),t},Subscribe.prototype.prepare=function(e,r){var t=this,n=t.req,o=t.res,i=framework.onAuthorize||framework.onAuthorization;if(i){var s=e.length;return i(n,o,e,function(r,o){s!==e.length&&(n.$flags+=e.slice(s).join("")),typeof r!==BOOLEAN&&(o=r,r=!o),n.isAuthorized=r,t.doAuthorization(r,o)}),t}return null===t.route&&(t.route=framework.lookup(n,n.buffer_exceeded?"#431":r||n.uri.pathname,n.flags)),null===t.route&&(t.route=framework.lookup(n,"#404")),t.execute(n.buffer_exceeded?431:404),t},Subscribe.prototype.doExecute=function(){var e=this,r=e.route.controller,t=e.controller,n=e.req;try{return framework.onTheme&&(t.themeName=framework.onTheme(t)),t.isCanceled?e:(framework.emit("controller",t,r,e.route.options),t.isCanceled?e:(e.route.isCACHE&&!framework.temporary.other[n.uri.pathname]&&(framework.temporary.other[n.uri.pathname]=n.path),e.route.isGENERATOR?async.call(t,e.route.execute,!0)(t,framework_internal.routeParam(e.route.param.length?framework_internal.routeSplit(n.uri.pathname,!0):n.path,e.route)):e.route.execute.apply(t,framework_internal.routeParam(e.route.param.length?framework_internal.routeSplit(n.uri.pathname,!0):n.path,e.route)),e))}catch(o){t=null,framework.error(o,r,n.uri),e.exception=o,e.route=framework.lookup(n,"#500"),e.execute(500,!0)}return e},Subscribe.prototype.doAuthorization=function(e,r){var t=this,n=t.req,o=e?"authorize":"unauthorize";if(n.flags.push(o),n.$flags+=o,r&&(n.user=r),t.route&&!t.route.isMEMBER&&e)return void t.execute(n.buffer_exceeded?431:401,!0);var i=framework.lookup(n,n.buffer_exceeded?"#431":n.uri.pathname,n.flags),s=n.$isAuthorized?404:401;return null===i&&(i=framework.lookup(n,"#"+s)),t.route=i,t.execute(n.buffer_exceeded?431:s),t},Subscribe.prototype.doEnd=function(){var e=this,r=e.req,t=e.res,n=e.route;if(r.buffer_exceeded)return n=framework.lookup(r,"#431"),null===n?(framework.response431(r,t),e):(e.route=n,e.execute(431,!0),e);r.buffer_data=r.buffer_data.toString(ENCODING);if(!r.buffer_data)return n&&n.schema?(framework.onSchema(r,n.schema[0],n.schema[1],function(t,n){return t?(e.route400(t),e):(r.body=n,void e.prepare(r.flags,r.uri.pathname))},n.schema[2]),e):(r.buffer_data=null,e.prepare(r.flags,r.uri.pathname),e);if(n.isXML){if(2!==r.$type)return e.route400(new Error("The request validation (The content-type is not text/xml).")),e;try{r.body=framework.onParseXML(r.buffer_data.trim()),r.buffer_data=null,e.prepare(r.flags,r.uri.pathname)}catch(o){F.error(o,null,r.uri),e.route500(o)}return e}if(e.route.isRAW)return r.body=r.buffer_data,e.prepare(r.flags,r.uri.pathname),e;if(0===r.$type)return e.route400(new Error("The request validation (The content-type is not x-www-form-urlencoded).")),e;if(1===r.$type)try{r.body=framework.onParseJSON(r.buffer_data)}catch(i){return e.route400(new Error("Not valid JSON data.")),e}else r.body=framework.onParseQuery(r.buffer_data);return n.schema?(framework.onSchema(r,n.schema[0],n.schema[1],function(t,n){return t?(e.route400(t),e):(r.body=n,void e.prepare(r.flags,r.uri.pathname))},n.schema[2]),e):(e.prepare(r.flags,r.uri.pathname),e)},Subscribe.prototype.route400=function(e){var r=this;return r.route=framework.lookup(r.req,"#400"),r.exception=e,r.execute(400,!0),r},Subscribe.prototype.route500=function(e){var r=this;return r.route=framework.lookup(r.req,"#500"),r.exception=e,r.execute(500,!0),r},Subscribe.prototype.doEndfile=function(){var e=this,r=e.req,t=e.res;if(!framework._length_files)return void framework.responseStatic(e.req,e.res);for(var n=0;n<framework._length_files;n++){var o=framework.routes.files[n];try{if(o.onValidate.call(framework,r,t,!0))return null===o.middleware?o.execute.call(framework,r,t,!1):e.doEndfile_middleware(o),e}catch(i){return framework.error(i,o.controller+" :: "+o.name,r.uri),framework.responseContent(r,t,500,"500 - internal server error",CONTENTTYPE_TEXTPLAIN,framework.config["allow-gzip"]),e}}return framework.responseStatic(e.req,e.res),e},Subscribe.prototype.doEndfile_middleware=function(e){for(var r=e.middleware.length,t=new Array(r),n=this,o=n.req,i=n.res,s=0,a=0;r>a;a++){var u=framework.routes.middleware[e.middleware[a]];u&&!function(r){t[s++]=function(t){r.call(framework,o,i,t,e.options)}}(u)}return t._async_middleware(i,function(){try{e.execute.call(framework,o,i,!1)}catch(r){return framework.error(r,e.controller+" :: "+e.name,o.uri),framework.responseContent(o,i,500,"500 - internal server error",CONTENTTYPE_TEXTPLAIN,framework.config["allow-gzip"]),n}}),n},Subscribe.prototype.doParsepost=function(e){var r=this,t=r.req;return t.buffer_exceeded?r:(t.buffer_exceeded||(t.buffer_data=Buffer.concat([t.buffer_data,e])),t.buffer_data.length/1024<r.route.length?r:(t.buffer_exceeded=!0,t.buffer_data=new Buffer(""),r))},Subscribe.prototype.doCancel=function(){var e=this;framework.stats.response.timeout++,clearTimeout(e.timeout),e.timeout=null,null!==e.controller&&(e.controller.isTimeout=!0,e.controller.isCanceled=!0,e.route=framework.lookup(e.req,"#408"),e.execute(408,!0))},Controller.prototype={get sseID(){return this.req.headers["last-event-id"]||null},get route(){return this.subscribe.route},get options(){return this.subscribe.route.options},get flags(){return this.subscribe.route.flags},get path(){return framework.path},get fs(){return framework.fs},get get(){return this.req.query},get query(){return this.req.query},get post(){return this.req.body},get body(){return this.req.body},get files(){return this.req.files},get subdomain(){return this.req.subdomain},get ip(){return this.req.ip},get xhr(){return this.req.xhr},get url(){return framework_utils.path(this.req.uri.pathname)},get uri(){return this.req.uri},get cache(){return framework.cache},get config(){return framework.config},get controllers(){return framework.controllers},get isProxy(){return this.req.isProxy},get isDebug(){return framework.config.debug},get isTest(){return"1"===this.req.headers["x-assertion-testing"]},get isSecure(){return this.req.isSecure},get session(){return this.req.session},set session(e){this.req.session=e},get user(){return this.req.user},set user(e){this.req.user=e},get global(){return framework.global},set global(e){framework.global=e},get async(){var e=this;return typeof e._async===UNDEFINED&&(e._async=new framework_utils.Async(e)),e._async},get viewname(){var e=this.req.path[this.req.path.length-1];return(""===e||void 0===e||"/"===e)&&(e="index"),e}},Controller.prototype.cookie=function(e,r,t,n){var o=this;return void 0===r?o.req.cookie(e):(o.res.cookie(e,r,t,n),o)},Controller.prototype.validation=function(e,r,t,n){return this.validate(e,r,t,n)},Controller.prototype.clear=function(){var e=this;return e.req.clear(),e},Controller.prototype.translate=function(e){return framework.translate(this.language,e)},Controller.prototype.middleware=function(e,r,t){if(typeof e===STRING&&(e=[e]),typeof r===TYPE_FUNCTION){var n=t;t=r,r=n}(void 0===r||null===r)&&(r={});for(var o=this,i=e.length,s=new Array(i),a=0,u=0;i>u;u++){var c=framework.routes.middleware[e[u]];c&&!function(e,r){s[a++]=function(t){e.call(framework,o.req,o.res,t,r)}}(c,void 0===r[e[u]]?r:r[e[u]])}return s._async_middleware(o.res,t,controller),o},Controller.prototype.pipe=function(e,r,t){var n=this;if(typeof r===TYPE_FUNCTION){var o=t;t=r,r=o}return n.res.success||n.res.headersSent||!n.isConnected?n:(framework.responsePipe(n.req,n.res,e,r,null,function(){n.subscribe.success(),t&&t()}),n)},Controller.prototype.encrypt=function(){return framework.encrypt.apply(framework,arguments)},Controller.prototype.decrypt=function(){return framework.decrypt.apply(framework,arguments)},Controller.prototype.hash=function(){return framework.hash.apply(framework,arguments)},Controller.prototype.date=function(e,r,t){void 0===t&&(t=r,r=new Date);var n=typeof r===STRING?r.parseDate():r,o=typeof t===STRING?t.parseDate():t,i=n.compare(o);switch(e){case">":return 1===i;case">=":case"=>":return 1===i||0===i;case"<":return-1===i;case"<=":case"=<":return-1===i||0===i;case"=":return 0===i}return!0},Controller.prototype.validate=function(e,r,t,n){var o=this,i=function(e){return o.resource(n||"default",(t||"")+e)};if(typeof r===STRING)return builders.validate(r,e,t);var s=new builders.ErrorBuilder(i);return framework_utils.validate.call(o,e,r,framework.onValidate||framework.onValidation,s)},Controller.prototype.header=function(e,r){var t=this;return t.res.setHeader(e,r),t},Controller.prototype.host=function(e){var r=this;return r.req.hostname(e)},Controller.prototype.hostname=function(e){var r=this;return r.req.hostname(e)},Controller.prototype.cors=function(e,r,t,n){var o=this,i=o.req.headers.origin,s="OPTIONS"===o.req.method.toUpperCase();if(void 0===i)return!0;void 0===e&&(e="*"),typeof r===BOOLEAN&&(n=r,r=null),typeof t===BOOLEAN&&(n=t,t=null),framework_utils.isArray(e)||(e=[e]);var a,u=!1,c=!1,l=o.req.headers;if(t){framework_utils.isArray(t)||(t=[t]);for(var f=0;f<t.length;f++)if(l[t[f].toLowerCase()]){u=!0;break}if(!u)return!1;u=!1}if(r){framework_utils.isArray(r)||(r=[r]);for(var p=l["access-control-request-method"]||o.req.method,f=0;f<r.length;f++)a=r[f].toUpperCase(),r[f]=a,-1!==p.indexOf(a)&&(u=!0);if(!u)return!1;u=!1}for(var f=0;f<e.length;f++)if(a=e[f],"*"===a||-1!==i.indexOf(a)){c="*"===a,u=!0;break}if(!u)return!1;var d,m;return o.res.setHeader("Access-Control-Allow-Origin",c?"*":i),n&&o.res.setHeader("Access-Control-Allow-Credentials","true"),m="Access-Control-Allow-Methods",r?o.res.setHeader(m,r.join(", ")):s&&(d=l["access-control-request-method"],d&&o.res.setHeader(m,d)),m="Access-Control-Allow-Headers",t?o.res.setHeader(m,t.join(", ")):s&&(d=l["access-control-request-headers"],d&&o.res.setHeader(m,d)),!0},Controller.prototype.error=function(e){var r=this,t=framework.error(typeof e===STRING?new Error(e):e,r.name,r.uri);return void 0===e?t:r.subscribe?(r.subscribe.exception=e,r.exception=e,r):r},Controller.prototype.problem=function(e){var r=this;return framework.problem(e,r.name,r.uri,r.ip),r},Controller.prototype.change=function(e){var r=this;return framework.change(e,r.name,r.uri,r.ip),r},Controller.prototype.transfer=function(e,r){var t=this,n=framework.routes.web.length,o=framework_internal.routeSplit(e.trim()),i="#"===e[0],s=null===r||void 0===r||0===r.length,a=null;t.req.$isAuthorized=!0;for(var u=0;n>u;u++){var c=framework.routes.web[u];if(c.isASTERIX){if(!framework_internal.routeCompare(o,c.url,i,!0))continue}else if(!framework_internal.routeCompare(o,c.url,i))continue;if(s){a=c;break}if(null!==c.flags&&c.flags.length){var l=framework_internal.routeCompareFlags(c.flags,r,!0);if(-1===l&&(t.req.$isAuthorized=!1),1>l)continue}a=c;break}return a?(t.cancel(),t.req.path=new Array(0),t.subscribe.isTransfer=!0,t.subscribe.success(),t.subscribe.route=a,t.subscribe.execute(404),!0):!1},Controller.prototype.cancel=function(){var e=this;return typeof e._async!==UNDEFINED&&e._async.cancel(),e.isCanceled=!0,e},Controller.prototype.log=function(){var e=this;return framework.log.apply(framework,arguments),e},Controller.prototype.logger=function(){var e=this;return framework.logger.apply(framework,arguments),e},Controller.prototype.meta=function(){var e=this;return e.repository[REPOSITORY_META_TITLE]=arguments[0]||"",e.repository[REPOSITORY_META_DESCRIPTION]=arguments[1]||"",e.repository[REPOSITORY_META_KEYWORDS]=arguments[2]||"",e.repository[REPOSITORY_META_IMAGE]=arguments[3]||"",e},Controller.prototype.$dns=function(e){for(var r="",t=this,n=arguments.length,o=0;n>o;o++)r+='<link rel="dns-prefetch" href="'+t._prepareHost(arguments[o]||"")+'" />';return t.head(r),""},Controller.prototype.$prefetch=function(){for(var e="",r=this,t=arguments.length,n=0;t>n;n++)e+='<link rel="prefetch" href="'+r._prepareHost(arguments[n]||"")+'" />';return r.head(e),""},Controller.prototype.$prerender=function(e){for(var r="",t=this,n=arguments.length,o=0;n>o;o++)r+='<link rel="prerender" href="'+t._prepareHost(arguments[o]||"")+'" />';return t.head(r),""},Controller.prototype.$next=function(e){var r=this;return r.head('<link rel="next" href="'+r._prepareHost(e||"")+'" />'),""},Controller.prototype.$prev=function(e){var r=this;return r.head('<link rel="prev" href="'+r._prepareHost(e||"")+'" />'),""},Controller.prototype.$canonical=function(e){var r=this;return r.head('<link rel="canonical" href="'+r._prepareHost(e||"")+'" />'),""},Controller.prototype.$meta=function(){var e=this;if(0!==arguments.length)return e.meta.apply(e,arguments),"";framework.emit("controller-render-meta",e);var r=e.repository;return framework.onMeta.call(e,r[REPOSITORY_META_TITLE],r[REPOSITORY_META_DESCRIPTION],r[REPOSITORY_META_KEYWORDS],r[REPOSITORY_META_IMAGE])},Controller.prototype.title=function(e){var r=this;return r.$title(e),r},Controller.prototype.description=function(e){var r=this;return r.$description(e),r},Controller.prototype.keywords=function(e){var r=this;return r.$keywords(e),r},Controller.prototype.$title=function(e){var r=this;return e?(r.repository[REPOSITORY_META_TITLE]=e,""):r.repository[REPOSITORY_META_TITLE]||""},Controller.prototype.$description=function(e){var r=this;return e?(r.repository[REPOSITORY_META_DESCRIPTION]=e,""):r.repository[REPOSITORY_META_DESCRIPTION]||""},Controller.prototype.$keywords=function(e){var r=this;return e?(r.repository[REPOSITORY_META_KEYWORDS]=e,""):r.repository[REPOSITORY_META_KEYWORDS]||""},Controller.prototype.sitemap=function(e,r,t){var n,o=this;return e instanceof Array?(o.repository[REPOSITORY_SITEMAP]=e,o):e?"#"===e[0]?(e=e.substring(1),n=framework.sitemap(e,!1,o.language),o.repository[REPOSITORY_SITEMAP]=n,o.repository[REPOSITORY_META_TITLE]||(n=n.last(),n&&(o.repository[REPOSITORY_META_TITLE]=n.name)),o):r?(OBSOLETE("sitemap","The newest version supports new sitemap mechanism."),void 0===o.repository.sitemap&&(o.repository.sitemap=[]),o.repository.sitemap.push({name:e,url:r,index:t||o.repository.sitemap.length}),void 0!==t&&o.sitemap.length>1&&o.repository.sitemap.sort(function(e,r){return e.index<r.index?-1:e.index>r.index?1:0}),o):o.repository[REPOSITORY_SITEMAP]:(n=o.repository[REPOSITORY_SITEMAP],n?n:o.repository.sitemap||[])},Controller.prototype.$sitemap=function(e,r,t){var n=this;return n.sitemap.apply(n,arguments),""},Controller.prototype.module=function(e){return framework.module(e)},Controller.prototype.layout=function(e){var r=this;return r.layoutName=e,r},Controller.prototype.theme=function(e){var r=this;return r.themeName=e,r},Controller.prototype.$layout=function(e){var r=this;return r.layoutName=e,""},Controller.prototype.model=function(e){return framework.model(e)},Controller.prototype.models=function(e){var r=this;return(r.controllers[e||r.name]||{}).models},Controller.prototype.mail=function(e,r,t,n,o,i){typeof n===TYPE_FUNCTION&&(o=n,n=null);var s=this,a=s.view(t,n,!0);return framework.onMail(e,r,a,o,i)},Controller.prototype.functions=function(e){var r=this;return(r.controllers[e||r.name]||{}).functions},Controller.prototype.notModified=function(e,r){var t=this;return framework.notModified(t.req,t.res,e,r)},Controller.prototype.setModified=function(e){var r=this;return framework.setModified(r.req,r.res,e),r},Controller.prototype.setExpires=function(e){var r=this;return void 0===e?r:(r.res.setHeader("Expires",e.toUTCString()),r)},Controller.prototype.$template=function(e,r,t,n){return this.$viewToggle(!0,e,r,t,n)},Controller.prototype.$templateToggle=function(e,r,t,n,o){return this.$viewToggle(e,r,t,n,o)},Controller.prototype.$view=function(e,r,t,n){return this.$viewToggle(!0,e,r,t,n)},Controller.prototype.$viewToggle=function(e,r,t,n,o){if(!e)return"";var i,s=this;if(n){i="$view."+r+"."+(o||"");var a=s.cache.read(i);if(a)return a}var u=s.layoutName;s.layoutName="";var c=s.view(r,t,null,!0);return s.layoutName=u,null===c?"":(n&&s.cache.add(i,c,n),c)},Controller.prototype.place=function(e){var r=this,t=REPOSITORY_PLACE+"_"+e,n=arguments.length;if(1===n)return r.repository[t]||"";for(var o="",i=1;n>i;i++){var s=arguments[i];s=null===s||void 0===typeof s?"":s.toString(),s.endsWith(".js")&&(s='<script src="'+s+'"></script>'),o+=s}return r.repository[t]=(r.repository[t]||"")+o,r},Controller.prototype.section=function(e,r,t){var n=this,o="$section_"+e;return void 0===r?n.repository[o]:t?(n.repository[o]=r,n):(n.repository[o]?n.repository[o]+=r:n.repository[o]=r,n)},Controller.prototype.$place=function(){var e=this;return 1===arguments.length?e.place.apply(e,arguments):(e.place.apply(e,arguments),"")},Controller.prototype.$url=function(e){var r=this;return e?r.req.hostname(r.url):r.url},Controller.prototype.$helper=function(e){var r=this;return r.helper.apply(r,arguments)},Controller.prototype.$checked=function(e,r,t){var n=this;return n.$isValue(e,r,t,'checked="checked"')},Controller.prototype.$disabled=function(e,r,t){var n=this;return n.$isValue(e,r,t,'disabled="disabled"')},Controller.prototype.$selected=function(e,r,t){var n=this;return n.$isValue(e,r,t,'selected="selected"')},Controller.prototype.$set=function(e){return""},Controller.prototype.$readonly=function(e,r,t){var n=this;return n.$isValue(e,r,t,'readonly="readonly"')},Controller.prototype.$header=function(e,r){return this.header(e,r),""},Controller.prototype.$text=function(e,r,t){return this.$input(e,"text",r,t)},Controller.prototype.$password=function(e,r,t){return this.$input(e,"password",r,t)},Controller.prototype.$hidden=function(e,r,t){return this.$input(e,"hidden",r,t)},Controller.prototype.$radio=function(e,r,t,n){return typeof n===STRING&&(n={label:n}),n.value=t,this.$input(e,"radio",r,n)},Controller.prototype.$checkbox=function(e,r,t){return typeof t===STRING&&(t={label:t}),this.$input(e,"checkbox",r,t)},Controller.prototype.$textarea=function(e,r,t){var n="<textarea";typeof t!==OBJECT&&(t={}),n+=' name="'+r+'" id="'+(t.id||r)+ATTR_END;for(var o in t)switch(o){case"name":case"id":break;case"required":case"disabled":case"readonly":case"value":n+=" "+o+'="'+o+ATTR_END;break;default:n+=" "+o+'="'+t[o].toString().encode()+ATTR_END}if(void 0===e)return n+"></textarea>";var i=e[r]||t.value||"";return n+">"+i.toString().encode()+"</textarea>"},Controller.prototype.$input=function(e,r,t,n){var o=["<input"];typeof n!==OBJECT&&(n={});var i=n.value||"";o+=' type="'+r+ATTR_END,o+="radio"===r?' name="'+t+ATTR_END:' name="'+t+'" id="'+(n.id||t)+ATTR_END,n.autocomplete&&(o+=n.autocomplete===!0||"on"===n.autocomplete?' autocomplete="on"':' autocomplete="off"');for(var s in n)switch(s){case"name":case"id":case"type":case"autocomplete":case"checked":case"value":case"label":break;case"required":case"disabled":case"readonly":case"autofocus":o+=" "+s+'="'+s+ATTR_END;break;default:o+=" "+s+'="'+n[s].toString().encode()+ATTR_END}var a="";return void 0!==e&&(a=e[t],"checkbox"===r&&(("1"===a||"true"===a||a===!0)&&(o+=' checked="checked"'),a=i||"1"),"radio"===r&&(i=(i||"").toString(),a.toString()===i&&(o+=' checked="checked"'),a=i||"")),o+=void 0!==a?' value="'+(a||"").toString().encode()+ATTR_END:' value="'+(n.value||"").toString().encode()+ATTR_END,o+=" />",n.label?"<label>"+o+" <span>"+n.label+"</span></label>":o},Controller.prototype._prepareHost=function(e){var r=e.substring(0,5);return"http:"!==r&&"https://"!==r&&("/"!==r[0]||"/"!==r[1])&&(e=this.host(e)),e},Controller.prototype.head=function(){var e=this,r=arguments.length;if(0===r)return framework.emit("controller-render-head",e),(e.config.author?'<meta name="author" content="'+e.config.author+'" />':"")+(e.repository[REPOSITORY_HEAD]||"");for(var t=e.repository[REPOSITORY_HEAD]||"",n="",o=0;r>o;o++){var i=arguments[o];if(-1===i.indexOf("<")){var s=i.substring(0,7),a="/"!==s[0]&&"/"!==s[1]&&"http://"!==s&&"https:/"!==s;i.endsWith(".css",!0)?n+='<link type="text/css" rel="stylesheet" href="'+(a?e.routeStyle(i):i)+'" />':-1!==i.endsWith(EXTENSION_JS,!0)&&(n+='<script type="text/javascript" src="'+(a?e.routeScript(i):i)+'"></script>')}else n+=i}return t+=n,e.repository[REPOSITORY_HEAD]=t,e},Controller.prototype.$head=function(){var e=this;return e.head.apply(e,arguments),""},Controller.prototype.$isValue=function(e,r,t,n){return e?(r=r||" ",t=t||"",r+n+t):""},Controller.prototype.$modified=function(e){var r,t=this,n=typeof e;if(n===NUMBER)r=new Date(e);else if(n===STRING){var o=e.split(" ");r=o[0].split("-");var i=(o[1]||"").split(":"),s=framework_utils.parseInt(r[0]||""),a=framework_utils.parseInt(r[1]||"")-1,u=framework_utils.parseInt(r[2]||"")-1;0>a&&(a=0),0>u&&(u=0);var c=framework_utils.parseInt(i[0]||""),l=framework_utils.parseInt(i[1]||""),f=framework_utils.parseInt(i[2]||"");r=new Date(s,a,u,c,l,f,0)}else framework_utils.isDate(e)&&(r=e);return void 0===r?"":(t.setModified(r),"")},Controller.prototype.$etag=function(e){return this.setModified(e),""},Controller.prototype.$options=function(e,r,t,n){var o=typeof e;if(null===e||void 0===e)return"";var i=!1,s=null;e instanceof Array||o!==OBJECT||(i=!0,s=e,e=Object.keys(e)),framework_utils.isArray(e)||(e=[e]),r=r||"";var a="";i||(void 0===n&&(n=n||t||"value"),void 0===t&&(t=t||"name"));var u=!1,c=0;c=e.length;for(var l=0;c>l;l++){var f=e[l],o=typeof f,p="",d="",m=!1;i?t===!0?(d=s[f],p=f,null===n&&(n="")):(d=f,p=s[f],null===p&&(p="")):o===OBJECT?(p=f[t]||"",d=f[n]||"",typeof p===TYPE_FUNCTION&&(p=p(l)),typeof d===TYPE_FUNCTION&&(d=d(l,p))):(p=f,d=f),u||(m=d==r,u=m),a+='<option value="'+d.toString().encode()+'"'+(m?' selected="selected"':"")+">"+p.toString().encode()+"</option>"}return a},Controller.prototype.$script=function(){var e=this;return e.$js.apply(e,arguments)},Controller.prototype.$js=function(){for(var e=this,r="",t=0;t<arguments.length;t++)r+=e.routeScript(arguments[t],!0);return r},Controller.prototype.$import=function(){for(var e=this,r="",t=0;t<arguments.length;t++){var n=arguments[t];"head"===n&&(r+=e.head()),"meta"===n&&(r+=e.$meta());var o=n.substring(n.lastIndexOf("."));switch(o){case".js":r+=e.routeScript(n,!0);break;case".css":r+=e.routeStyle(n,!0);break;case".ico":r+=e.$favicon(n);break;case".jpg":case".gif":case".png":case".jpeg":r+=e.routeImage(n,!0)}}return r},Controller.prototype.$css=function(){for(var e=this,r="",t=0;t<arguments.length;t++)r+=e.routeStyle(arguments[t],!0);return r},Controller.prototype.$image=function(e,r,t,n,o){var i="";typeof r===OBJECT&&(t=r.height,n=r.alt,o=r["class"],i=r.style,r=r.width);var s='<img src="'+this.routeImage(e)+ATTR_END;return r>0&&(s+=' width="'+r+ATTR_END),t>0&&(s+=' height="'+t+ATTR_END),n&&(s+=' alt="'+n.encode()+ATTR_END),o&&(s+=' class="'+o+ATTR_END),i&&(s+=' style="'+i+ATTR_END),s+' border="0" />'},Controller.prototype.$download=function(e,r,t,n){var o='<a href="'+framework.routeDownload(e)+ATTR_END;return t&&(o+=' download="'+t+ATTR_END),n&&(o+=' class="'+n+ATTR_END),o+">"+(r||e)+"</a>"},Controller.prototype.$json=function(e,r,t){if(typeof r===BOOLEAN){var n=r;r=t,t=n}var o=t?JSON.stringify(e,null,4):JSON.stringify(e);return r?'<script type="application/json" id="'+r+'">'+o+"</script>":o},Controller.prototype.$favicon=function(e){var r="image/x-icon";void 0===e&&(e="favicon.ico");var t="favicon#"+e;return framework.temporary.other[t]?framework.temporary.other[t]:(-1!==e.lastIndexOf(".png")?r="image/png":-1!==e.lastIndexOf(".gif")&&(r="image/gif"),e=framework.routeStatic("/"+e),framework.temporary.other[t]='<link rel="shortcut icon" href="'+e+'" type="'+r+'" />')},Controller.prototype._routeHelper=function(e,r,t){return e?"//"===e.substring(0,2)||"http:/"===e.substring(0,6)||"https:/"===e.substring(0,7)?t.call(framework,e+r,this.themeName):"~"===e[0]?t.call(framework,framework_utils.path(e.substring(1))+r,this.themeName):t.call(framework,framework_utils.path(e)+r,this.themeName):t.call(framework,r,this.themeName)},Controller.prototype.routeJS=function(e,r){return OBSOLETE("controller.routeJS()",'Instead of "controller.routeJS()" use "controller.routeScript()"'),this.routeScript(e,r)},Controller.prototype.routeScript=function(e,r){var t=this;void 0===e&&(e="default.js");var n=t._routeHelper(t._currentScript,e,framework.routeScript);return r?'<script type="text/javascript" src="'+n+'"></script>':n},Controller.prototype.routeCSS=function(e,r){return OBSOLETE("controller.routeCSS()",'Instead of "controller.routeCSS()" use "controller.routeStyle()"'),this.routeStyle(e,r)},Controller.prototype.routeStyle=function(e,r){var t=this;void 0===e&&(e="default.css");var n=t._routeHelper(t._currentStyle,e,framework.routeStyle);return r?'<link type="text/css" rel="stylesheet" href="'+n+'" />':n},Controller.prototype.routeImage=function(e){var r=this;return r._routeHelper(r._currentImage,e,framework.routeImage)},Controller.prototype.routeVideo=function(e){var r=this;return r._routeHelper(r._currentVideo,e,framework.routeVideo)},Controller.prototype.routeFont=function(e){return framework.routeFont(e)},Controller.prototype.routeDownload=function(e){var r=this;return r._routeHelper(r._currentDownload,e,framework.routeDownload)},Controller.prototype.routeStatic=function(e){return framework.routeStatic(e)},Controller.prototype.$currentJS=function(e){return this.$currentScript(e)},Controller.prototype.$currentScript=function(e){return this._currentScript=e?e:"",""},Controller.prototype.$currentView=function(e){var r=this;return void 0===e?(r._currentView="#"!==r.name[0]&&"default"!==r.name?"/"+r.name+"/":"",r):(r._currentView=e?framework_utils.path(e):"","")},Controller.prototype.currentView=function(e){var r=this;return r.$currentView(e),r._defaultView=r._currentView,r},Controller.prototype.$currentCSS=function(e){return this.$currentStyle(e)},Controller.prototype.$currentStyle=function(e){return this._currentStyle=e?e:"",""},Controller.prototype.$currentImage=function(e){return this._currentImage=e?e:"",""},Controller.prototype.$currentVideo=function(e){return this._currentVideo=e?e:"",""},Controller.prototype.$currentDownload=function(e){return this._currentDownload=e?e:"",""},Controller.prototype.currentImage=function(e){var r=this;return r.$currentImage(e),r._defaultImage=r._currentImage,r},Controller.prototype.currentDownload=function(e){var r=this;return r.$currentDownload(e),r._defaultDownload=r._currentDownload,r},Controller.prototype.currentCSS=function(e){return this.currentStyle(e)},Controller.prototype.currentStyle=function(e){var r=this;return r.$currentStyle(e),r._defaultStyle=r._currentStyle,r},Controller.prototype.currentJS=function(e){return this.currentScript(e)},Controller.prototype.currentScript=function(e){var r=this;return r.$currentScript(e),r._defaultScript=r._currentScript,r},Controller.prototype.currentVideo=function(e){var r=this;return r.$currentVideo(e),r._defaultVideo=r._currentVideo,r},Controller.prototype.resource=function(e,r){return framework.resource(e,r)},Controller.prototype.template=function(e,r){return this.view(e,r,!0)},Controller.prototype.helper=function(e){var r=this,t=framework.helpers[e]||null;if(null===t)return"";for(var n=arguments.length,o=[],i=1;n>i;i++)o.push(arguments[i]);return t.apply(r,o)},Controller.prototype.json=function(e,r,t,n){var o=this;if(o.res.success||o.res.headersSent||!o.isConnected)return o;if("HEAD"===o.req.method)return o.subscribe.success(),framework.responseContent(o.req,o.res,o.status,"","application/json",o.config["allow-gzip"],r),framework.stats.response.json++,o;typeof r===BOOLEAN&&(n=t,t=r);var i="application/json";return e instanceof builders.ErrorBuilder?(o.language&&!e.isResourceCustom&&e.resource(o.language),e.contentType&&(i=e.contentType),e=e.output()):e=t?JSON.stringify(e,n,4):JSON.stringify(e,n),o.subscribe.success(),framework.responseContent(o.req,o.res,o.status,e,i,o.config["allow-gzip"],r),framework.stats.response.json++,o.precache&&o.precache(e,"application/json",r),o},Controller.prototype.jsonp=function(e,r,t,n,o){var i=this;return i.res.success||i.res.headersSent||!i.isConnected?i:"HEAD"===i.req.method?(i.subscribe.success(),framework.responseContent(i.req,i.res,i.status,"","application/x-javascript",i.config["allow-gzip"],t),framework.stats.response.json++,i):(typeof t===BOOLEAN&&(o=n,n=t),e||(e="callback"),r instanceof builders.ErrorBuilder?(i.language&&!r.isResourceCustom&&r.resource(i.language),r=r.json(n)):r=n?JSON.stringify(r,o,4):JSON.stringify(r,o),i.subscribe.success(),framework.responseContent(i.req,i.res,i.status,e+"("+r+")","application/x-javascript",i.config["allow-gzip"],t),framework.stats.response.json++,i.precache&&i.precache(e+"("+r+")","application/x-javascript",t),i)},Controller.prototype.callback=function(e){var r=this;return function(t,n){return void 0!==n||framework_utils.isError(t)||t instanceof Builders.ErrorBuilder||(n=t,t=null),t?t instanceof Builders.ErrorBuilder&&!e?(r.language&&t.resource(r.language),r.content(t)):r.view500(t):typeof e===STRING?r.view(e,n):void r.json(n)}},Controller.prototype.custom=function(){var e=this;return e.subscribe.success(),e.res.success||e.res.headersSent||!e.isConnected?!1:(framework.responseCustom(e.req,e.res),!0)},Controller.prototype.noClear=function(e){var r=this;return r.req._manual=void 0===e?!0:e,r},Controller.prototype.content=function(e,r,t){var n=this;if(n.res.success||n.res.headersSent||!n.isConnected)return n;if(e instanceof ErrorBuilder){var o=e.output();r||(r=e.contentType||"application/json"),e=o}return n.subscribe.success(),framework.responseContent(n.req,n.res,n.status,e,r||CONTENTTYPE_TEXTPLAIN,n.config["allow-gzip"],t),
n},Controller.prototype.plain=function(e,r){var t=this;if(t.res.success||t.res.headersSent||!t.isConnected)return t;if("HEAD"===t.req.method)return t.subscribe.success(),framework.responseContent(t.req,t.res,t.status,"",CONTENTTYPE_TEXTPLAIN,t.config["allow-gzip"],r),framework.stats.response.plain++,t;var n=typeof e;return e=void 0===e?"":n===OBJECT?null===e?"":JSON.stringify(e,null,4):null===e?"":e.toString(),t.subscribe.success(),framework.responseContent(t.req,t.res,t.status,e,CONTENTTYPE_TEXTPLAIN,t.config["allow-gzip"],r),framework.stats.response.plain++,t.precache&&t.precache(e,CONTENTTYPE_TEXTPLAIN,r),t},Controller.prototype.empty=function(e){var r=this;if(r.res.success||r.res.headersSent||!r.isConnected)return r;var t=200;return typeof e===NUMBER&&(t=e,e=null),r.subscribe.success(),framework.responseContent(r.req,r.res,t,"",CONTENTTYPE_TEXTPLAIN,!1,e),framework.stats.response.empty++,r},Controller.prototype.destroy=function(e){var r=this;return e&&r.problem(e),r.res.success||r.res.headersSent||!r.isConnected?r:(r.subscribe.success(),r.req.connection.destroy(),framework.stats.response.destroy++,r)},Controller.prototype.file=function(e,r,t,n){var o=this;return o.res.success||o.res.headersSent||!o.isConnected?(n&&n(),o):(e="~"===e[0]?e.substring(1):framework.path["public"](e),o.subscribe.success(),framework.responseFile(o.req,o.res,e,r,t,n),o)},Controller.prototype.image=function(e,r,t,n){var o=this;return o.res.success||o.res.headersSent||!o.isConnected?(n&&n(),o):(typeof e===STRING&&(e="~"===e[0]?e.substring(1):framework.path["public"](e)),o.subscribe.success(),framework.responseImage(o.req,o.res,e,r,t,n),o)},Controller.prototype.stream=function(e,r,t,n,o,i){var s=this;return s.res.success||s.res.headersSent||!s.isConnected?(o&&o(),s):(s.subscribe.success(),framework.responseStream(s.req,s.res,e,r,t,n,o,i),s)},Controller.prototype.throw400=function(e){return this.view400(e)},Controller.prototype.view400=function(e){var r=this;return e&&!e.items&&r.problem(e),r.res.success||r.res.headersSent||!r.isConnected?r:(r.req.path=new Array(0),r.subscribe.success(),r.subscribe.route=framework.lookup(r.req,"#400"),r.subscribe.exception=e,r.subscribe.execute(400,!0),r)},Controller.prototype.throw401=function(e){return this.view401(e)},Controller.prototype.view401=function(e){var r=this;return e&&r.problem(e),r.res.success||r.res.headersSent||!r.isConnected?r:(r.req.path=new Array(0),r.subscribe.success(),r.subscribe.route=framework.lookup(r.req,"#401"),r.subscribe.exception=e,r.subscribe.execute(401,!0),r)},Controller.prototype.throw403=function(e){return this.view403(e)},Controller.prototype.view403=function(e){var r=this;return e&&r.problem(e),r.res.success||r.res.headersSent||!r.isConnected?r:(r.req.path=new Array(0),r.subscribe.success(),r.subscribe.route=framework.lookup(r.req,"#403"),r.subscribe.exception=e,r.subscribe.execute(403,!0),r)},Controller.prototype.throw404=function(e){return this.view404(e)},Controller.prototype.view404=function(e){var r=this;return e&&r.problem(e),r.res.success||r.res.headersSent||!r.isConnected?r:(r.req.path=new Array(0),r.subscribe.success(),r.subscribe.route=framework.lookup(r.req,"#404"),r.subscribe.exception=e,r.subscribe.execute(404,!0),r)},Controller.prototype.view500=function(e){var r=this;return framework.error(typeof e===STRING?new Error(e):e,r.name,r.req.uri),r.res.success||r.res.headersSent||!r.isConnected?r:(r.req.path=new Array(0),r.subscribe.exception=e,r.subscribe.success(),r.subscribe.route=framework.lookup(r.req,"#500"),r.subscribe.exception=e,r.subscribe.execute(500,!0),r)},Controller.prototype.throw500=function(e){return this.view500(e)},Controller.prototype.view501=function(e){var r=this;return e&&r.problem(e),r.res.success||r.res.headersSent||!r.isConnected?r:(r.req.path=new Array(0),r.subscribe.success(),r.subscribe.route=framework.lookup(r.req,"#501"),r.subscribe.exception=e,r.subscribe.execute(501,!0),r)},Controller.prototype.throw501=function(e){return this.view501(e)},Controller.prototype.redirect=function(e,r){var t=this;return t.res.success||t.res.headersSent||!t.isConnected?t:(t.subscribe.success(),t.req.clear(!0),t.res.success=!0,t.res.writeHead(r?301:302,{Location:e}),t.res.end(),framework._request_stats(!1,!1),framework.emit("request-end",t.req,t.res),framework.stats.response.redirect++,t)},Controller.prototype.binary=function(e,r,t,n,o){var i=this,s=i.res;if(i.res.success||i.res.headersSent||!i.isConnected)return i;if(typeof t===OBJECT){var a=t;t=n,n=o,o=a}return typeof n===OBJECT&&(o=n,n=o),i.subscribe.success(),framework.responseBinary(i.req,s,r,e,t,n,o),i},Controller.prototype.baa=function(e){var r=this;if(void 0===e)return r.req.authorization();var t={};return t["WWW-Authenticate"]='Basic realm="'+(e||"Administration")+'"',framework.responseContent(r.req,r.res,401,"401: NOT AUTHORIZED",CONTENTTYPE_TEXTPLAIN,!1,t),r.subscribe.success(),r.cancel(),null},Controller.prototype.sse=function(e,r,t,n){var o=this,i=o.res;if(!o.isConnected)return o;if(0===o.type&&i.success)throw new Error("Response was sent.");if(o.type>0&&1!==o.type)throw new Error("Response was used.");0===o.type&&(o.type=1,void 0===n&&(n=o.subscribe.route.timeout),o.subscribe.success(),o.req.on("close",o.close.bind(o)),i.success=!0,i.writeHead(o.status,HEADERS.sse)),e=typeof e===OBJECT?JSON.stringify(e):e.replace(/\n/g,"\\n").replace(/\r/g,"\\r");var s="\n",a="";return r&&(a="event: "+r+s),a+="data: "+e+s,t&&t.toString()&&(a+="id: "+t+s),n&&n>0&&(a+="retry: "+n+s),a+=s,i.write(a),framework.stats.response.sse++,o},Controller.prototype.close=function(e){var r=this;return void 0===e&&(e=!0),r.isConnected?0===r.type?(r.isConnected=!1,r.res.success||(r.res.success=!0,e&&r.res.end(),framework._request_stats(!1,!1),framework.emit("request-end",r.req,r.res)),r):(r.isConnected=!1,r.res.success=!0,e&&r.res.end(),framework._request_stats(!1,!1),framework.emit("request-end",r.req,r.res),r.type=0,r):r},Controller.prototype.proxy=function(e,r,t,n){var o,i=this;return typeof t===NUMBER&&(o=n,n=t,t=o),typeof r===TYPE_FUNCTION&&(o=t,t=r,r=o),framework_utils.request(e,REQUEST_PROXY_FLAGS,r,function(e,r,n,o){t&&(-1!==(o["content-type"]||"").indexOf("application/json")&&(r=framework.onParseJSON(r)),t.call(i,e,r,n,o))},null,HEADERS.proxy,ENCODING,n||1e4)},Controller.prototype.database=function(){return typeof framework.database===OBJECT?framework.database:framework.database.apply(framework,arguments)},Controller.prototype.view=function(e,r,t,n){var o=this;if(typeof e!==STRING?(n=t,t=r,r=e,e=o.viewname):void 0===n&&typeof t===BOOLEAN&&(n=t,t=null),!n&&o.res&&o.res.success)return o;var i="view#"+e,s=framework.temporary.other[i],a=o.isLayout;if(o.isLayout=!1,!s){var u=e[0],c="/"===u?1:"~"===u&&"~"===e[1]?4:"~"===u?2:"@"===u?3:0,l=!1;s=e,o.themeName&&3>c&&(s="."+framework.path.themes(o.themeName+"/views/"+(a||c>0?"":o._currentView.substring(1))+(c?e.substring(1):e)),l=!0),4===c&&(s=s.substring(1),e=e.substring(1),c=2),l||a||c||(s=o._currentView+e),l||2!==c&&3!==c||(s=e.substring(1)),3===c&&(s="."+framework.path["package"](s)),framework.temporary.other[i]=s}var f=framework_internal.viewEngine(e,s,o.language);if(!f){var p=new Error('View "'+s+'" not found.');return n?(framework.error(p,o.name,o.uri),o.outputPartial):a?(o.subscribe.success(),void framework.response500(o.req,o.res,p)):void o.view500(p)}var d="";o.$model=r,a&&(o._currentStyle=o._defaultStyle||"",o._currentScript=o._defaultScript||"",o._currentDownload=o._defaultDownload||"",o._currentVideo=o._defaultVideo||"",o._currentImage=o._defaultImage||"",o._currentView=o._defaultView||"");var m=framework.helpers;try{d=f.call(o,o,o.repository,r,o.session,o.query,o.body,o.url,framework.global,m,o.user,o.config,framework.functions,0,n?o.outputPartial:o.output,o.date,o.req.cookie,o.req.files,o.req.mobile)}catch(h){var p=new Error("View: "+e+" - "+h.toString());return n?(o.error(p),o.isPartial?o.outputPartial="":o.output="",a=!1,d):void o.view500(p)}if(a||!o.precache||200!==o.status||n||o.precache(d,CONTENTTYPE_TEXTHTML,t,!0),a||framework_utils.isNullOrEmpty(o.layoutName)){if(o.outputPartial="",o.output="",a=!1,n)return d;if(o.subscribe.success(),!o.isConnected)return;return framework.responseContent(o.req,o.res,o.status,d,CONTENTTYPE_TEXTHTML,o.config["allow-gzip"],t),framework.stats.response.view++,o}return n?o.outputPartial=d:o.output=d,o.isLayout=!0,d=o.view(o.layoutName,o.$model,t,n),n?(o.outputPartial="",o.isLayout=!1,d):o},Controller.prototype.memorize=function(e,r,t,n,o){var i=this;if(t===!0)return n(),i;var s=i.cache.read(e);if(null===s){var a="$memorize"+e;return framework.temporary.processing[a]?(setTimeout(function(){i.memorize(e,r,t,n,o)},500),i):(i.precache=function(t,n,o,s){var u={content:t,type:n,layout:i.layoutName};if(o&&(u.headers=o),s){u.repository=[];for(var c in i.repository){var t=i.repository[c];void 0!==t&&u.repository.push({key:c,value:t})}}i.cache.add(e,u,r),i.precache=null,delete framework.temporary.processing[a]},typeof t===TYPE_FUNCTION&&(n=t),framework.temporary.processing[a]=!0,n(),i)}if(typeof t===TYPE_FUNCTION){var u=n;n=t,o=u}if(o&&o(),i.layoutName=s.layout,s.type!==CONTENTTYPE_TEXTHTML)return i.subscribe.success(),void framework.responseContent(i.req,i.res,i.status,s.content,s.type,i.config["allow-gzip"],s.headers);switch(s.type){case CONTENTTYPE_TEXTPLAIN:return framework.stats.response.plain++,i;case"application/json":return framework.stats.response.json++,i;case CONTENTTYPE_TEXTHTML:framework.stats.response.view++}for(var c=s.repository.length,l=0;c>l;l++)i.repository[s.repository[l].key]=s.repository[l].value;return i.layoutName?(i.output=s.content,i.isLayout=!0,i.view(i.layoutName,null),i):(i.subscribe.success(),i.isConnected?(framework.responseContent(i.req,i.res,i.status,s.content,s.type,i.config["allow-gzip"],s.headers),i):i)};var NEWLINE="\r\n",SOCKET_RESPONSE="HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\nX-Powered-By: {0}\r\nSec-WebSocket-Accept: {1}\r\n\r\n",SOCKET_RESPONSE_ERROR="HTTP/1.1 403 Forbidden\r\nConnection: close\r\nX-WebSocket-Reject-Reason: 403 Forbidden\r\n\r\n",SOCKET_HASH="258EAFA5-E914-47DA-95CA-C5AB0DC85B11",SOCKET_ALLOW_VERSION=[13];WebSocket.prototype={get global(){return framework.global},get config(){return framework.config},get cache(){return framework.cache},get isDebug(){return framework.config.debug},get path(){return framework.path},get fs(){return framework.fs},get isSecure(){return this.req.isSecure},get async(){var e=this;return typeof e._async===UNDEFINED&&(e._async=new framework_utils.Async(e)),e._async}},WebSocket.prototype.__proto__=Object.create(events.EventEmitter.prototype,{constructor:{value:WebSocket,enumberable:!1}}),WebSocket.prototype.date=function(e,r,t){void 0===t&&(t=r,r=new Date);var n=typeof r===STRING?r.parseDate():r,o=typeof t===STRING?t.parseDate():t,i=n.compare(o);switch(e){case">":return 1===i;case">=":case"=>":return 1===i||0===i;case"<":return-1===i;case"<=":case"=<":return-1===i||0===i;case"=":return 0===i}return!0},WebSocket.prototype.send=function(e,r,t){var n=this,o=n._keys,i=o.length;if(0===i)return n;var s=typeof t===TYPE_FUNCTION?t:null,a=t instanceof Array;if(void 0===r||null===r||!r.length){for(var u=0;i>u;u++){var c=o[u];if(!a||-1===t.indexOf(c)){var l=n.connections[c];(null===s||s.call(n,c,l))&&(l.send(e),framework.stats.response.websocket++)}}return n.emit("send",e,null,[]),n}s=typeof r===TYPE_FUNCTION?r:null,a=r instanceof Array;for(var u=0;i>u;u++){var c=o[u];if(!a||-1!==r.indexOf(c)){var l=n.connections[c];(null===s||-1!==!s.call(n,c,l))&&(l.send(e),framework.stats.response.websocket++)}}return n.emit("send",e,r,t),n},WebSocket.prototype.ping=function(){var e=this,r=e._keys,t=r.length;if(0===t)return e;e.$ping=!0,framework.stats.other.websocketPing++;for(var n=0;t>n;n++)e.connections[r[n]].ping();return e},WebSocket.prototype.close=function(e,r,t){var n=this,o=n._keys;if(typeof e===STRING&&(t=r,r=e,e=null),null===o)return n;var i=o.length;if(0===i)return n;if(void 0===e||null===e||!e.length){for(var s=0;i>s;s++){var a=o[s];n.connections[a].close(r,t),n._remove(a)}return n._refresh(),n}for(var u=e instanceof Array,c=typeof e===TYPE_FUNCTION?e:null,s=0;i>s;s++){var a=o[s];if(!u||-1!==e.indexOf(a)){var l=n.connections[a];(null===c||c.call(n,a,l))&&(l.close(r,t),n._remove(a))}}return n._refresh(),n},WebSocket.prototype.error=function(e){var r=this,t=framework.error(typeof e===STRING?new Error(e):e,r.name,r.path);return void 0===e?t:r},WebSocket.prototype.problem=function(e){var r=this;return framework.problem(e,r.name,r.uri),r},WebSocket.prototype.change=function(e){var r=this;return framework.change(e,r.name,r.uri,r.ip),r},WebSocket.prototype.all=function(e){for(var r=this,t=r._keys.length,n=0;t>n;n++){var o=r._keys[n];if(e(r.connections[o],n))break}return r},WebSocket.prototype.find=function(e){for(var r=this,t=r._keys.length,n=typeof e===TYPE_FUNCTION,o=0;t>o;o++){var i=r.connections[r._keys[o]];if(n){if(e(i,i.id))return i}else if(i.id===e)return i}return null},WebSocket.prototype.destroy=function(e){var r=this;return e&&r.problem(e),null===r.connections&&null===r._keys?r:(r.close(),r.connections=null,r._keys=null,delete framework.connections[r.id],r.removeAllListeners(),r.emit("destroy"),r)},WebSocket.prototype.proxy=function(e,r,t){var n=this;if(typeof r===TYPE_FUNCTION){var o=t;t=r,r=o}return framework_utils.request(e,REQUEST_PROXY_FLAGS,r,function(e,r,o,i){t&&(-1!==(i["content-type"]||"").indexOf("application/json")&&(r=framework.onParseJSON(r)),t.call(n,e,r,o,i))},HEADERS.proxy)},WebSocket.prototype._refresh=function(){var e=this;return e._keys=Object.keys(e.connections),e.online=e._keys.length,e},WebSocket.prototype._remove=function(e){var r=this;return delete r.connections[e],r},WebSocket.prototype._add=function(e){var r=this;return r.connections[e._id]=e,r},WebSocket.prototype.module=function(e){return framework.module(e)},WebSocket.prototype.model=function(e){return framework.model(e)},WebSocket.prototype.helper=function(e){var r=this,t=framework.helpers[e]||null;if(null===t)return"";for(var n=arguments.length,o=[],i=1;n>i;i++)o.push(arguments[i]);return t.apply(r,o)},WebSocket.prototype.functions=function(e){return(framework.controllers[e]||{}).functions},WebSocket.prototype.database=function(){return typeof framework.database===OBJECT?framework.database:framework.database.apply(framework,arguments)},WebSocket.prototype.resource=function(e,r){return framework.resource(e,r)},WebSocket.prototype.log=function(){var e=this;return framework.log.apply(framework,arguments),e},WebSocket.prototype.check=function(){var e=this;return e.$ping?(e.all(function(e){e.$ping||(e.close(),framework.stats.other.websocketCleaner++)}),e):e},WebSocket.prototype.logger=function(){var e=this;return framework.logger.apply(framework,arguments),e},WebSocket.prototype.validation=function(e,r,t,n){return this.validate(e,r,t,n)},WebSocket.prototype.validate=function(e,r,t,n){var o=this,i=function(e){return o.resource(n||"default",(t||"")+e)},s=new builders.ErrorBuilder(i);return framework_utils.validate.call(o,e,r,framework.onValidate||framework.onValidation,s)},WebSocketClient.prototype={get protocol(){return(this.req.headers["sec-websocket-protocol"]||"").replace(/\s/g,"").split(",")},get ip(){return this.req.ip},get get(){return this.req.query},get query(){return this.req.query},get uri(){return this.req.uri},get config(){return this.container.config},get global(){return this.container.global},get session(){return this.req.session},set session(e){this.req.session=e},get user(){return this.req.user},set user(e){this.req.user=e}},WebSocketClient.prototype.__proto__=Object.create(events.EventEmitter.prototype,{constructor:{value:WebSocketClient,enumberable:!1}}),WebSocketClient.prototype.prepare=function(e,r,t,n,o){var i=this;e=e||[],r=r||[],t=t||[],i.length=n;var s=i.req.headers.origin||"";if(t.length){if(-1===t.indexOf("*"))for(var a=0;a<t.length;a++)if(-1===s.indexOf(t[a]))return!1}else if(-1===s.indexOf(i.req.headers.host))return!1;if(r.length)for(var a=0;a<r.length;a++)if(-1===i.protocol.indexOf(r[a]))return!1;return-1===SOCKET_ALLOW_VERSION.indexOf(framework_utils.parseInt(i.req.headers["sec-websocket-version"]))?!1:(i.socket.write(new Buffer(SOCKET_RESPONSE.format("total.js v"+o,i._request_accept_key(i.req)),"binary")),i._id=(i.ip||"").replace(/\./g,"")+framework_utils.GUID(20),i.id=i._id,!0)},WebSocketClient.prototype.upgrade=function(e){var r=this;return r.container=e,r.socket.on("data",r.handlers.ondata),r.socket.on("error",r.handlers.onerror),r.socket.on("close",r.handlers.onclose),r.socket.on("end",r.handlers.onclose),r.container._add(r),r.container._refresh(),framework.emit("websocket-begin",r.container,r),r.container.emit("open",r),r},WebSocketClient.prototype._ondata=function(e){var r=this;if(r){if(null!=e&&(r.buffer=Buffer.concat([r.buffer,e])),r.buffer.length>r.length)return r.errors++,void r.container.emit("error",new Error("Maximum request length exceeded."),r);switch(15&r.buffer[0]){case 1:1!==r.type&&r.parse();break;case 2:1===r.type&&r.parse();break;case 8:r.close();break;case 9:r.socket.write(framework_utils.getWebSocketFrame(0,"",10)),r.buffer=new Buffer(0),r.$ping=!0;break;case 10:r.$ping=!0,r.buffer=new Buffer(0)}}},WebSocketClient.prototype.parse=function(){var e=this,r=e.buffer[1];if((128&r)>>7!==1)return e;var t=framework_utils.getMessageLength(e.buffer,framework.isLE),n=127&e.buffer[1];if(n=126==n?4:127==n?10:2,n+t+4>e.buffer.length)return e;var o=new Buffer(4);if(e.buffer.copy(o,0,n,n+4),1!==e.type){for(var i="",s=0;t>s;s++)i+=String.fromCharCode(e.buffer[n+4+s]^o[s%4]);if(3===e.type)try{e.container.emit("message",e,framework.onParseJSON(e.container.config["default-websocket-encodedecode"]===!0?$decodeURIComponent(i):i))}catch(a){e.errors++,e.container.emit("error",new Error("JSON parser: "+a.toString()),e)}else e.container.emit("message",e,e.container.config["default-websocket-encodedecode"]===!0?$decodeURIComponent(i):i)}else{for(var u=new Buffer(t),s=0;t>s;s++)u.write(e.buffer[n+4+s]^o[s%4]);e.container.emit("message",e,u)}return e.buffer=e.buffer.slice(n+t+4,e.buffer.length),e.buffer.length>=2&&framework_utils.getMessageLength(e.buffer,framework.isLE)&&e.parse(),e},WebSocketClient.prototype._onerror=function(e){var r=this;r&&-1===e.stack.indexOf("ECONNRESET")&&-1===e.stack.indexOf("socket is closed")&&-1===e.stack.indexOf("EPIPE")&&r.container.emit("error",e,r)},WebSocketClient.prototype._onclose=function(){var e=this;e&&(e._isClosed||(e._isClosed=!0,e.container._remove(e._id),e.container._refresh(),e.container.emit("close",e),framework.emit("websocket-end",e.container,e)))},WebSocketClient.prototype.send=function(e){var r=this;if(!r||r.isClosed)return r;if(1!==r.type){var t=3===r.type?JSON.stringify(e):(e||"").toString();r.container.config["default-websocket-encodedecode"]===!0&&t&&(t=encodeURIComponent(t)),r.socket.write(framework_utils.getWebSocketFrame(0,t,1))}else null!==e&&r.socket.write(framework_utils.getWebSocketFrame(0,e,2));return r},WebSocketClient.prototype.ping=function(){var e=this;return!e||e.isClosed?e:(e.socket.write(framework_utils.getWebSocketFrame(0,"",9)),e.$ping=!1,e)},WebSocketClient.prototype.close=function(e,r){var t=this;return!t||t.isClosed?t:(t.isClosed=!0,t.socket.end(framework_utils.getWebSocketFrame(r||1e3,e||"",8)),t)},WebSocketClient.prototype._request_accept_key=function(e){var r=crypto.createHash("sha1");return r.update((e.headers["sec-websocket-key"]||"")+SOCKET_HASH),r.digest("base64")},Backup.prototype.restoreKey=function(e){var r=this,t=r.read;if(1===t.status)return void r.restoreValue(e);var n=-1,o=e;return 2===t.status?(o=t.key+o,n=o.indexOf(":")):n=o.indexOf(":"),-1===n?(t.key+=e,void(t.status=2)):(t.status=1,t.key=o.substring(0,n),void r.restoreValue(o.substring(n+1)))},Backup.prototype.restoreValue=function(e){var r=this,t=r.read;if(1!==t.status)return void r.restoreKey(e);var n=e.indexOf("\n");return-1===n?void(t.value+=e):(t.value+=e.substring(0,n),r.restoreFile(t.key.replace(/\s/g,""),t.value.replace(/\s/g,"")),t.status=0,t.value="",t.key="",void r.restoreKey(e.substring(n+1)))},Backup.prototype.restore=function(e,r,t,n){if(!fs.existsSync(e))return void(t&&t(new Error("Package not found."),r));var o=this;o.filter=n,o.cache={},o.createDirectory(r,!0);var i=fs.createReadStream(e);return o.path=r,i.on("data",function(e){o.restoreKey(e.toString("utf8"))}),t?(t.path=r,i.on("end",function(){o.callback(t),i=null}),void i.resume()):void i.resume()},Backup.prototype.callback=function(e){var r=this;return r.pending<=0?e(null,e.path):void setTimeout(function(){r.callback(e)},100)},Backup.prototype.restoreFile=function(e,r){var t=this;if("function"!=typeof t.filter||t.filter(e)){if("#"===r)return void t.createDirectory(e);var n=e,o=e.lastIndexOf("/");-1!==o&&(n=e.substring(0,o).trim(),n&&t.createDirectory(n));var i=new Buffer(r,"base64");t.pending++,zlib.gunzip(i,function(r,n){fs.writeFileSync(path.join(t.path,e),n),t.pending--,i=null})}},Backup.prototype.createDirectory=function(e,r){var t=this;if(!t.cache[e]){t.cache[e]=!0,"/"===e[0]&&(e=e.substring(1));var n=framework.isWindows;n?"\\"===e[e.length-1]&&(e=e.substring(0,e.length-1)):"/"===e[e.length-1]&&(e=e.substring(0,e.length-1));var o=n?e.replace(/\//g,"\\").split("\\"):e.split("/"),i="";n&&-1!==o[0].indexOf(":")&&o.shift();for(var s=o.length,a=0;s>a;a++){var u=o[a];i+=n?(i?"\\":"")+u:(i?"/":"")+u;var c=path.join(t.path,i);r&&(c=(n?"\\":"/")+c),fs.existsSync(c)||fs.mkdirSync(c)}}},http.ServerResponse.prototype.cookie=function(e,r,t,n){var o=this;if(!o.headersSent&&!o.success){var i=e+"=",s=[i+encodeURIComponent(r)],a=typeof t;t&&!framework_utils.isDate(t)&&a===OBJECT&&(n=t,t=n.expires||n.expire||null),a===STRING&&(t=t.parseDateExpiration()),n||(n={}),n.path=n.path||"/",t&&s.push("Expires="+t.toUTCString()),n.domain&&s.push("Domain="+n.domain),n.path&&s.push("Path="+n.path),n.secure&&s.push("Secure"),(n.httpOnly||n.httponly||n.HttpOnly)&&s.push("HttpOnly");var u=o.getHeader("set-cookie")||[],c=u.findIndex(function(e){return e.startsWith(i)});return-1!==c&&u.splice(c,1),u.push(s.join("; ")),o.setHeader("Set-Cookie",u),o}},http.ServerResponse.prototype.noCache=function(){var e=this;return e.removeHeader(RESPONSE_HEADER_CACHECONTROL),e.removeHeader("Etag"),e.removeHeader("Last-Modified"),e},http.ServerResponse.prototype.send=function(e,r,t){var n=this;if(n.headersSent)return n;n.controller&&n.controller.subscribe.success();var o=n,i=n.req,s=t,a="HEAD"===i.method;switch(void 0===r&&(r=e,e=200),typeof r){case STRING:s||(s="text/html");break;case NUMBER:s||(s="text/plain"),r=framework_utils.httpStatus(r);break;case BOOLEAN:case OBJECT:s||(s="application/json"),a||(r instanceof builders.ErrorBuilder&&(r=obj.output()),r=JSON.stringify(r))}var u=i.headers["accept-encoding"]||"",c={};c[RESPONSE_HEADER_CACHECONTROL]="private",c.Vary="Accept-Encoding"+(i.$mobile?", User-Agent":""),"application/json"===s&&(c[RESPONSE_HEADER_CACHECONTROL]="private, no-cache, no-store, must-revalidate"),/text|application/.test(s)&&(s+="; charset=utf-8"),c[RESPONSE_HEADER_CONTENTTYPE]=s,framework.responseCustom(i,o),!u&&isGZIP(i)&&(u="gzip");var l=-1!==u.indexOf("gzip");if(a)return l&&(c["Content-Encoding"]="gzip"),o.writeHead(200,c),o.end(),n;if(!l)return o.writeHead(e,c),o.end(r,ENCODING),n;var f=new Buffer(r);return zlib.gzip(f,function(t,n){return t?(o.writeHead(e,c),void o.end(r,ENCODING)):(c["Content-Encoding"]="gzip",o.writeHead(e,c),void o.end(n,ENCODING))}),n},http.ServerResponse.prototype.throw400=function(e){this.controller&&this.controller.subscribe.success(),framework.response400(this.req,this,e)},http.ServerResponse.prototype.throw401=function(e){this.controller&&this.controller.subscribe.success(),framework.response401(this.req,this,e)},http.ServerResponse.prototype.throw403=function(e){this.controller&&this.controller.subscribe.success(),framework.response403(this.req,this,e)},http.ServerResponse.prototype.throw404=function(e){this.controller&&this.controller.subscribe.success(),framework.response404(this.req,this,e)},http.ServerResponse.prototype.throw408=function(e){this.controller&&this.controller.subscribe.success(),framework.response408(this.req,this,e)},http.ServerResponse.prototype.throw431=function(e){this.controller&&this.controller.subscribe.success(),framework.response431(this.req,this,e)},http.ServerResponse.prototype.throw500=function(e){this.controller&&this.controller.subscribe.success(),framework.response500(this.req,this,e)},http.ServerResponse.prototype.throw501=function(e){this.controller&&this.controller.subscribe.success(),framework.response501(this.req,this,e)},http.ServerResponse.prototype["continue"]=function(e){var r=this;return r.headersSent?(e&&e(),r):(r.controller&&r.controller.subscribe.success(),framework.responseStatic(r.req,r,e),r)},http.ServerResponse.prototype.content=function(e,r,t,n,o){var i=this;return i.headersSent?i:(i.controller&&i.controller.subscribe.success(),framework.responseContent(i.req,i,e,r,t,n,o),i)},http.ServerResponse.prototype.redirect=function(e,r){var t=this;return t.headersSent?t:(t.controller&&t.controller.subscribe.success(),framework.responseRedirect(t.req,t,e,r),t)},http.ServerResponse.prototype.file=function(e,r,t,n){var o=this;return o.headersSent?(n&&n(),o):(o.controller&&o.controller.subscribe.success(),framework.responseFile(o.req,o,e,r,t,n),o)},http.ServerResponse.prototype.stream=function(e,r,t,n,o,i){var s=this;return s.headersSent?(o&&o(),s):(s.controller&&s.controller.subscribe.success(),framework.responseStream(s.req,s,e,r,t,n,o,i),s)},http.ServerResponse.prototype.image=function(e,r,t,n){var o=this;return o.headersSent?(n&&n(),o):(o.controller&&o.controller.subscribe.success(),framework.responseImage(o.req,o,e,r,t,n),o)},http.ServerResponse.prototype.json=function(e){var r=this;return r.send(200,e,"application/json")};var _tmp=http.IncomingMessage.prototype;http.IncomingMessage.prototype={get ip(){var e=this;if(e._ip)return e._ip;var r=e.headers["x-forwarded-for"];return void 0!==r?e._ip=r.split(",",1)[0]||e.connection.removiewddress:e._ip=e.connection.remoteAddress,e._ip},get query(){var e=this;return e._dataGET?e._dataGET:(e._dataGET=framework.onParseQuery(e.uri.query),e._dataGET)},get subdomain(){var e=this;if(e._subdomain)return e._subdomain;var r=e.uri.host.toLowerCase().replace(/^www\./i,"").split(".");return r.length>2?e._subdomain=r.slice(0,r.length-2):e._subdomain=null,e._subdomain},get host(){return this.headers.host},get isSecure(){return"https:"===this.uri.protocol||"wss:"===this.uri.protocol},get language(){return this.$language||(this.$language=(((this.headers["accept-language"]||"").split(";")[0]||"").split(",")[0]||"").toLowerCase()),this.$language},get mobile(){return void 0===this.$mobile&&(this.$mobile=REG_MOBILE.test(this.headers["user-agent"])),this.$mobile},set language(e){this.$language=e}},http.IncomingMessage.prototype.__proto__=_tmp,http.IncomingMessage.prototype.signature=function(e){var r=this;return framework.encrypt((r.headers["user-agent"]||"")+"#"+r.ip+"#"+r.url+"#"+(e||""),"request-signature",!1)},http.IncomingMessage.prototype.noCache=function(){var e=this;return delete e.headers["if-none-match"],delete e.headers["if-modified-since"],e},http.IncomingMessage.prototype.behaviour=function(e){if(!framework.behaviours)return!1;var r=this.url;this.isStaticFile||"/"===r[r.length-1]||(r+="/");var t=framework.behaviours["*"],n=!1;return void 0!==t&&(t=t[e],void 0!==t&&(n=t)),t=framework.behaviours[r],void 0===t?n:(t=t[e],void 0===t?n:t)},http.IncomingMessage.prototype.cookie=function(e){var r=this;if(void 0!==r.cookies)return $decodeURIComponent(r.cookies[e]||"");var t=r.headers.cookie;if(!t)return"";r.cookies={};for(var n=t.split(";"),o=n.length,i=0;o>i;i++){var s=n[i].trim().split("=");r.cookies[s.shift()]=s.join("=")}return $decodeURIComponent(r.cookies[e]||"")},http.IncomingMessage.prototype.authorization=function(){var e=this,r=e.headers.authorization||"",t={user:"",password:"",empty:!0};if(""===r)return t;var n=new Buffer(r.replace("Basic ","").trim(),"base64").toString(ENCODING).split(":");return t.user=n[0]||"",t.password=n[1]||"",t.empty=0===t.user.length||0===t.password.length,t},http.IncomingMessage.prototype.authorize=function(e){var r=framework.onAuthorize||framework.onAuthorization;if(!r)return e(null,null,!1),this;var t=this;return r(t,t.res,t.flags,function(r,n){typeof r!==BOOLEAN&&(n=r,r=!n),t.isAuthorized=r,e(null,n,r)}),this},http.IncomingMessage.prototype.clear=function(e){var r=this,t=r.files;if(!t)return r;if(e&&r._manual)return r;var n=t.length;if(0===n)return r;for(var o=[],i=0;n>i;i++)o.push(t[i].path);return framework.unlink(o),r.files=null,r},http.IncomingMessage.prototype.hostname=function(e){var r=this,t=r.uri;return e&&"/"!==e[0]&&(e="/"+e),t.protocol+"//"+t.hostname+(t.port&&80!==t.port?":"+t.port:"")+(e||"")};var framework=new Framework;global.framework=global.F=module.exports=framework,process.on("uncaughtException",function(e){return-1!==e.toString().indexOf("listen EADDRINUSE")?(typeof process.send===TYPE_FUNCTION&&process.send("eaddrinuse"),console.log("\nThe IP address and the PORT is already in use.\nYou must change the PORT's number or IP address.\n"),void process.exit("SIGTERM")):framework.isTest?void(framework.testContinue&&framework.testContinue(e)):void framework.error(e,"",null)}),process.on("SIGTERM",function(){framework.stop()}),process.on("SIGINT",function(){framework.stop()}),process.on("exit",function(){framework.stop()}),process.on("message",function(e,r){return typeof e!==STRING?void framework.emit("message",e,r):"debugging"===e?void framework_utils.wait(function(){return framework.isLoaded},function(){delete framework.isLoaded,framework.console(),framework.console=framework_utils.noop},1e4,500):"reconnect"===e?void framework.reconnect():"reconfigure"===e?(framework._configure(),framework._configure_versions(),framework._configure_sitemap(),void framework.emit(e)):"reset"===e?void framework.cache.clear():"stop"===e||"exit"===e?void framework.stop():void framework.emit("message",e,r)});